!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).nsfwjs=f()}}(function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs"),nsfw_classes_1=require("./nsfw_classes"),SuperGif=require("libgif"),BASE_PATH="https://s3.amazonaws.com/ir_public/nsfwjscdn/TFJS_nsfw_mobilenet/tfjs_quant_nsfw_mobilenet/",IMAGE_SIZE=224;exports.load=function(base,options){return void 0===base&&(base=BASE_PATH),void 0===options&&(options={size:IMAGE_SIZE}),__awaiter(this,void 0,void 0,function(){var nsfwnet;return __generator(this,function(_a){switch(_a.label){case 0:if(null==tf)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this model.");return[4,(nsfwnet=new NSFWJS(base,options)).load()];case 1:return _a.sent(),[2,nsfwnet]}})})};var NSFWJS=function(){function NSFWJS(modelPathBaseOrIOHandler,options){this.intermediateModels={},this.options=options,this.normalizationOffset=tf.scalar(255),this.pathOrIOHandler="string"==typeof modelPathBaseOrIOHandler?modelPathBaseOrIOHandler+"model.json":modelPathBaseOrIOHandler}return NSFWJS.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var _a,size,result,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:return _a=this,[4,tf.loadLayersModel(this.pathOrIOHandler)];case 1:return _a.model=_b.sent(),this.endpoints=this.model.layers.map(function(l){return l.name}),size=this.options.size,[4,(result=tf.tidy(function(){return _this.model.predict(tf.zeros([1,size,size,3]))})).data()];case 2:return _b.sent(),result.dispose(),[2]}})})},NSFWJS.prototype.infer=function(img,endpoint){var _this=this;if(null!=endpoint&&-1===this.endpoints.indexOf(endpoint))throw new Error("Unknown endpoint "+endpoint+". Available endpoints: "+this.endpoints+".");return tf.tidy(function(){img instanceof tf.Tensor||(img=tf.browser.fromPixels(img));var normalized=img.toFloat().div(_this.normalizationOffset),resized=normalized,size=_this.options.size;if(img.shape[0]!==size||img.shape[1]!==size){resized=tf.image.resizeBilinear(normalized,[size,size],!0)}var model,batched=resized.reshape([1,size,size,3]);if(null==endpoint)model=_this.model;else{if(null==_this.intermediateModels[endpoint]){var layer=_this.model.layers.find(function(l){return l.name===endpoint});_this.intermediateModels[endpoint]=tf.model({inputs:_this.model.inputs,outputs:layer.output})}model=_this.intermediateModels[endpoint]}return model.predict(batched)})},NSFWJS.prototype.classify=function(img,topk){return void 0===topk&&(topk=5),__awaiter(this,void 0,void 0,function(){var logits,classes;return __generator(this,function(_a){switch(_a.label){case 0:return[4,function(logits,topK){return __awaiter(this,void 0,void 0,function(){var values,valuesAndIndices,topkValues,topkIndices,topClassesAndProbs,i;return __generator(this,function(_a){switch(_a.label){case 0:return[4,logits.data()];case 1:for(values=_a.sent(),valuesAndIndices=[],i=0;i<values.length;i++)valuesAndIndices.push({value:values[i],index:i});for(valuesAndIndices.sort(function(a,b){return b.value-a.value}),topkValues=new Float32Array(topK),topkIndices=new Int32Array(topK),i=0;i<topK;i++)topkValues[i]=valuesAndIndices[i].value,topkIndices[i]=valuesAndIndices[i].index;for(topClassesAndProbs=[],i=0;i<topkIndices.length;i++)topClassesAndProbs.push({className:nsfw_classes_1.NSFW_CLASSES[topkIndices[i]],probability:topkValues[i]});return[2,topClassesAndProbs]}})})}(logits=this.infer(img),topk)];case 1:return classes=_a.sent(),logits.dispose(),[2,classes]}})})},NSFWJS.prototype.classifyGif=function(gif,config){return void 0===config&&(config={topk:5}),__awaiter(this,void 0,void 0,function(){var gifObj,_this=this;return __generator(this,function(_a){return gifObj=new SuperGif({gif:gif}),[2,new Promise(function(resolve){gifObj.load(function(){return __awaiter(_this,void 0,void 0,function(){var arrayOfClasses,gifLength,i,classes;return __generator(this,function(_a){switch(_a.label){case 0:arrayOfClasses=[],gifLength=gifObj.get_length(),i=1,_a.label=1;case 1:return i<=gifLength?(gifObj.move_to(i),[4,this.classify(gifObj.get_canvas(),config.topk)]):[3,4];case 2:classes=_a.sent(),config.onFrame&&config.onFrame({index:i,totalFrames:gifLength,predictions:classes}),arrayOfClasses.push(classes),_a.label=3;case 3:return i++,[3,1];case 4:return config.setGifControl&&config.setGifControl(gifObj),gifObj=null,resolve(arrayOfClasses),[2]}})})})})]})})},NSFWJS}();exports.NSFWJS=NSFWJS},{"./nsfw_classes":2,"@tensorflow/tfjs":330,libgif:336}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NSFW_CLASSES={0:"Drawing",1:"Hentai",2:"Neutral",3:"Porn",4:"Sexy"}},{}],3:[function(require,module,exports){"use strict";module.exports=require("./index")},{"./index":1}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(DataType){DataType[DataType.DT_INVALID=0]="DT_INVALID",DataType[DataType.DT_FLOAT=1]="DT_FLOAT",DataType[DataType.DT_DOUBLE=2]="DT_DOUBLE",DataType[DataType.DT_INT32=3]="DT_INT32",DataType[DataType.DT_UINT8=4]="DT_UINT8",DataType[DataType.DT_INT16=5]="DT_INT16",DataType[DataType.DT_INT8=6]="DT_INT8",DataType[DataType.DT_STRING=7]="DT_STRING",DataType[DataType.DT_COMPLEX64=8]="DT_COMPLEX64",DataType[DataType.DT_INT64=9]="DT_INT64",DataType[DataType.DT_BOOL=10]="DT_BOOL",DataType[DataType.DT_QINT8=11]="DT_QINT8",DataType[DataType.DT_QUINT8=12]="DT_QUINT8",DataType[DataType.DT_QINT32=13]="DT_QINT32",DataType[DataType.DT_BFLOAT16=14]="DT_BFLOAT16",DataType[DataType.DT_FLOAT_REF=101]="DT_FLOAT_REF",DataType[DataType.DT_DOUBLE_REF=102]="DT_DOUBLE_REF",DataType[DataType.DT_INT32_REF=103]="DT_INT32_REF",DataType[DataType.DT_UINT8_REF=104]="DT_UINT8_REF",DataType[DataType.DT_INT16_REF=105]="DT_INT16_REF",DataType[DataType.DT_INT8_REF=106]="DT_INT8_REF",DataType[DataType.DT_STRING_REF=107]="DT_STRING_REF",DataType[DataType.DT_COMPLEX64_REF=108]="DT_COMPLEX64_REF",DataType[DataType.DT_INT64_REF=109]="DT_INT64_REF",DataType[DataType.DT_BOOL_REF=110]="DT_BOOL_REF",DataType[DataType.DT_QINT8_REF=111]="DT_QINT8_REF",DataType[DataType.DT_QUINT8_REF=112]="DT_QUINT8_REF",DataType[DataType.DT_QINT32_REF=113]="DT_QINT32_REF",DataType[DataType.DT_BFLOAT16_REF=114]="DT_BFLOAT16_REF"}(exports.DataType||(exports.DataType={})),function(SaverDef){!function(CheckpointFormatVersion){CheckpointFormatVersion[CheckpointFormatVersion.LEGACY=0]="LEGACY",CheckpointFormatVersion[CheckpointFormatVersion.V1=1]="V1",CheckpointFormatVersion[CheckpointFormatVersion.V2=2]="V2"}(SaverDef.CheckpointFormatVersion||(SaverDef.CheckpointFormatVersion={}))}(exports.SaverDef||(exports.SaverDef={}))},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ExecutionContext=function(){function ExecutionContext(weightMap,tensorArrayMap){this.weightMap=weightMap,this.tensorArrayMap=tensorArrayMap,this.rootContext={id:0,frameName:"",iterationId:0},this.contexts=[this.rootContext],this.lastId=0,this.generateCurrentContextIds()}return ExecutionContext.prototype.newFrame=function(id,frameName){return{id:id,frameName:frameName,iterationId:0}},Object.defineProperty(ExecutionContext.prototype,"currentContext",{get:function(){return this.contexts},set:function(contexts){this.contexts!==contexts&&(this.contexts=contexts,this.generateCurrentContextIds())},enumerable:!0,configurable:!0}),Object.defineProperty(ExecutionContext.prototype,"currentContextId",{get:function(){return this._currentContextIds[0]},enumerable:!0,configurable:!0}),Object.defineProperty(ExecutionContext.prototype,"currentContextIds",{get:function(){return this._currentContextIds},enumerable:!0,configurable:!0}),ExecutionContext.prototype.generateCurrentContextIds=function(){for(var names=[],i=0;i<this.contexts.length-1;i++){var contexts=this.contexts.slice(0,this.contexts.length-i);names.push(this.contextIdforContexts(contexts))}names.push(""),this._currentContextIds=names},ExecutionContext.prototype.contextIdforContexts=function(contexts){return contexts?contexts.map(function(context){return 0===context.id&&0===context.iterationId?"":context.frameName+"-"+context.iterationId}).join("/"):""},ExecutionContext.prototype.enterFrame=function(frameId){this.contexts&&(this.lastId++,this.contexts=this.contexts.slice(),this.contexts.push(this.newFrame(this.lastId,frameId)),this._currentContextIds.unshift(this.contextIdforContexts(this.contexts)))},ExecutionContext.prototype.exitFrame=function(){if(!(this.contexts&&1<this.contexts.length))throw new Error("Cannot exit frame, the context is empty");this.contexts=this.contexts.slice(),this.contexts.splice(-1),this.currentContextIds.shift()},ExecutionContext.prototype.nextIteration=function(){if(!(this.contexts&&0<this.contexts.length))throw new Error("Cannot increase frame iteration, the context is empty");this.contexts=this.contexts.slice(),this.lastId++;var context=Object.assign({},this.contexts[this.contexts.length-1]);context.iterationId+=1,context.id=this.lastId,this.contexts.splice(-1,1,context),this._currentContextIds.splice(0,1,this.contextIdforContexts(this.contexts))},ExecutionContext.prototype.getWeight=function(name){return this.weightMap[name]},ExecutionContext.prototype.addTensorArray=function(tensorArray){this.tensorArrayMap[tensorArray.id]=tensorArray},ExecutionContext.prototype.getTensorArray=function(id){return this.tensorArrayMap[id]},ExecutionContext}();exports.ExecutionContext=ExecutionContext},{}],6:[function(require,module,exports){"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),utils_1=require("../operations/executors/utils"),operation_executor_1=require("../operations/operation_executor"),execution_context_1=require("./execution_context"),model_analysis_1=require("./model_analysis"),model_rewrite_1=require("./model_rewrite"),GraphExecutor=function(){function GraphExecutor(graph){this.graph=graph,this.compiledMap=new Map,this._weightMap={},this.SEPERATOR=",",this.placeholders=graph.placeholders,this._outputs=graph.outputs}return Object.defineProperty(GraphExecutor.prototype,"weightMap",{get:function(){return this._weightMap},set:function(weightMap){var weightIds=Object.keys(weightMap).map(function(key){return weightMap[key].map(function(tensor){return tensor.id})});this.weightIds=[].concat.apply([],weightIds),this._weightMap=weightMap},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"inputs",{get:function(){return this.placeholders.map(function(node){return{name:node.name,shape:node.attrParams.shape?node.attrParams.shape.value:void 0,dtype:node.attrParams.dtype?node.attrParams.dtype.value:void 0}})},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"outputs",{get:function(){return this._outputs.map(function(node){return{name:node.name,shape:node.attrParams.shape?node.attrParams.shape.value:void 0,dtype:node.attrParams.dtype?node.attrParams.dtype.value:void 0}})},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"inputNodes",{get:function(){return this.placeholders.map(function(node){return node.name})},enumerable:!0,configurable:!0}),Object.defineProperty(GraphExecutor.prototype,"outputNodes",{get:function(){return this.outputs.map(function(node){return node.name})},enumerable:!0,configurable:!0}),GraphExecutor.prototype.getCompilationKey=function(inputs,outputs){var sortedInputs=inputs.map(function(node){return node.name}).sort(),sortedOutputs=outputs.map(function(node){return node.name}).sort();return sortedInputs.join(this.SEPERATOR)+"--"+sortedOutputs.join(this.SEPERATOR)},GraphExecutor.prototype.compile=function(inputs,outputs){var executionInfo=model_analysis_1.getExecutionSubgraph(inputs,outputs,this.weightMap),missingInputs=executionInfo.missingInputs,dynamicNode=executionInfo.dynamicNode,syncInputs=executionInfo.syncInputs;if(null!=dynamicNode)throw new Error("This execution contains the node '"+dynamicNode.name+"', which has the dynamic op '"+dynamicNode.op+"'. Please use model.executeAsync() instead. Alternatively, to avoid the dynamic ops, specify the inputs ["+syncInputs+"]");if(0<missingInputs.length){var outNames=outputs.map(function(n){return n.name}),inNames=Object.keys(inputs);throw new Error("Cannot compute the outputs ["+outNames+"] from the provided inputs ["+inNames+"]. Missing the following inputs: ["+missingInputs+"]")}return model_analysis_1.getNodesInTopologicalOrder(this.graph,this.weightMap,executionInfo)},GraphExecutor.prototype.fusePrelu=function(){model_rewrite_1.rewritePrelu(this.graph,this.weightMap)},GraphExecutor.prototype.execute=function(inputs,outputs){var _this=this,names=Object.keys(inputs).sort();this.checkInputs(inputs),this.checkInputShapeAndType(inputs),this.checkOutputs(outputs);var inputNodes=names.map(function(name){return _this.graph.nodes[name]}),outputNodes=outputs.map(function(name){return _this.graph.nodes[utils_1.parseNodeName(name)[0]]}),compilationKey=this.getCompilationKey(inputNodes,outputNodes),orderedNodes=this.compiledMap.get(compilationKey);null==orderedNodes&&(orderedNodes=this.compile(inputs,outputNodes),this.compiledMap.set(compilationKey,orderedNodes));var tensorArrayMap={};return tfjs_core_1.tidy(function(){var context=new execution_context_1.ExecutionContext(_this._weightMap,tensorArrayMap),tensorsMap=__assign({},_this.weightMap);Object.keys(inputs).forEach(function(name){tensorsMap[name]=[inputs[name]]});for(var tensorsToKeep=_this.getFrozenTensorIds(tensorsMap),intermediateTensorConsumerCount={},i=0;i<orderedNodes.length;i++){var node=orderedNodes[i];if(!tensorsMap[node.name]){var tensors=operation_executor_1.executeOp(node,tensorsMap,context);if(tensors instanceof Promise)throw new Error("The execution of the op '"+node.op+"' returned a promise. Please use model.executeAsync() instead.");tensorsMap[node.name]=tensors,_this.checkTensorForDisposal(node.name,node,tensorsMap,context,tensorsToKeep,outputs,intermediateTensorConsumerCount)}}return outputs.map(function(name){return utils_1.getTensor(name,tensorsMap,context)})})},GraphExecutor.prototype.getFrozenTensorIds=function(tensorMap){var ids=[].concat.apply([],Object.keys(tensorMap).map(function(key){return tensorMap[key]}).map(function(tensors){return tensors.map(function(tensor){return tensor.id})}));return new Set(ids)},GraphExecutor.prototype.checkTensorForDisposal=function(nodeName,node,tensorMap,context,tensorsToKeep,outputNames,intermediateTensorConsumerCount){"control"!==node.category&&-1===outputNames.indexOf(nodeName)&&(tensorMap[nodeName].forEach(function(tensor){null!=tensor&&(intermediateTensorConsumerCount[tensor.id]=(intermediateTensorConsumerCount[tensor.id]||0)+node.children.length)}),node.inputs.forEach(function(input){if("control"!==input.category){var tensors=utils_1.getTensorsForCurrentContenxt(input.name,tensorMap,context);null!=tensors&&tensors.forEach(function(tensor){if(tensor&&!tensorsToKeep.has(tensor.id)){var count=intermediateTensorConsumerCount[tensor.id];1===count?(tensor.dispose(),delete intermediateTensorConsumerCount[tensor.id]):null!=count&&intermediateTensorConsumerCount[tensor.id]--}})}}))},GraphExecutor.prototype.executeAsync=function(inputs,outputs){return __awaiter(this,void 0,void 0,function(){var tensorArrayMap,context,tensorMap,results,outputIds,inputIds,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return this.checkInputs(inputs),this.checkInputShapeAndType(inputs),this.checkOutputs(outputs),tensorArrayMap={},context=new execution_context_1.ExecutionContext(this._weightMap,tensorArrayMap),[4,this.executeWithControlFlow(inputs,context,outputs)];case 1:return tensorMap=_a.sent(),results=outputs.map(function(name){return utils_1.getTensor(name,tensorMap,context)}),outputIds=new Set(results.map(function(t){return t.id})),inputIds=new Set(Object.keys(inputs).map(function(name){return inputs[name].id})),Object.keys(tensorMap).forEach(function(key){tensorMap[key].forEach(function(tensor){!tensor||tensor.isDisposed||outputIds.has(tensor.id)||inputIds.has(tensor.id)||-1!==_this.weightIds.indexOf(tensor.id)||tensor.dispose()})}),[2,results]}})})},GraphExecutor.prototype.executeWithControlFlow=function(inputs,context,outputNames){return __awaiter(this,void 0,void 0,function(){var names,inputNodes,outputNodes,_a,usedNodes,missingInputs,dynamicNode,syncInputs,stack,tensorsMap,intermediateTensorConsumerCount,tensorsToKeep,added,promises,missingOutputs,alternativeMsg,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:names=Object.keys(inputs),inputNodes=names.map(function(name){return _this.graph.nodes[name]}),outputNodes=outputNames.map(function(name){return _this.graph.nodes[utils_1.parseNodeName(name)[0]]}),_a=model_analysis_1.getExecutionSubgraph(inputs,outputNodes,this.weightMap),usedNodes=_a.usedNodes,missingInputs=_a.missingInputs,dynamicNode=_a.dynamicNode,syncInputs=_a.syncInputs,stack=inputNodes.concat(this.graph.weights).map(function(node){return{node:node,contexts:context.currentContext}}),tensorsMap=__assign({},this.weightMap),Object.keys(inputs).forEach(function(name){tensorsMap[name]=[inputs[name]]}),intermediateTensorConsumerCount={},tensorsToKeep=this.getFrozenTensorIds(tensorsMap),added={},_b.label=1;case 1:return 0<stack.length?(promises=this.processStack(inputNodes,stack,context,tensorsMap,added,tensorsToKeep,outputNames,intermediateTensorConsumerCount,usedNodes),[4,Promise.all(promises)]):[3,3];case 2:return _b.sent(),[3,1];case 3:if(null==dynamicNode&&console.warn("This model execution did not contain any nodes with control flow or dynamic output shapes. You can use model.execute() instead."),0<(missingOutputs=outputNodes.filter(function(node){return!model_analysis_1.isControlFlow(node)&&!utils_1.getTensor(node.name,tensorsMap,context)}).map(function(node){return node.name})).length)throw alternativeMsg="",null!=dynamicNode&&(alternativeMsg="Alternatively, to avoid the dynamic ops, use model.execute() and specify the inputs ["+syncInputs+"]"),new Error("Cannot compute the outputs ["+missingOutputs+"] from the provided inputs ["+names+"]. Consider providing the following inputs: ["+missingInputs+"]. "+alternativeMsg);return[2,tensorsMap]}})})},GraphExecutor.prototype.processStack=function(inputNodes,stack,context,tensorMap,added,tensorsToKeep,outputNames,intermediateTensorConsumerCount,usedNodes){for(var _this=this,promises=[],_loop_1=function(){var item=stack.pop();context.currentContext=item.contexts;var nodeName="";if("Enter"===item.node.op&&utils_1.getParamValue("isConstant",item.node,tensorMap,context)&&(nodeName=utils_1.getNodeNameAndIndex(item.node.name,context)[0]),-1===inputNodes.indexOf(item.node)){var tensors=operation_executor_1.executeOp(item.node,tensorMap,context);nodeName=nodeName||utils_1.getNodeNameAndIndex(item.node.name,context)[0];var currentContext_1=context.currentContext;tensors instanceof Promise?promises.push(tensors.then(function(t){return tensorMap[nodeName]=t,context.currentContext=currentContext_1,_this.checkTensorForDisposal(nodeName,item.node,tensorMap,context,tensorsToKeep,outputNames,intermediateTensorConsumerCount),_this.processChildNodes(item.node,stack,context,tensorMap,added,usedNodes),t})):(tensorMap[nodeName]=tensors,this_1.checkTensorForDisposal(nodeName,item.node,tensorMap,context,tensorsToKeep,outputNames,intermediateTensorConsumerCount),this_1.processChildNodes(item.node,stack,context,tensorMap,added,usedNodes))}else this_1.processChildNodes(item.node,stack,context,tensorMap,added,usedNodes)},this_1=this;0<stack.length;)_loop_1();return promises},GraphExecutor.prototype.processChildNodes=function(node,stack,context,tensorMap,added,usedNodes){node.children.forEach(function(childNode){var nodeName=utils_1.getNodeNameAndIndex(childNode.name,context)[0];!added[nodeName]&&usedNodes.has(childNode.name)&&("Merge"===childNode.op?childNode.inputNames.some(function(name){return!!utils_1.getTensor(name,tensorMap,context)})&&(added[nodeName]=!0,stack.push({contexts:context.currentContext,node:childNode})):childNode.inputNames.every(function(name){return!!utils_1.getTensor(name,tensorMap,context)})&&(added[nodeName]=!0,stack.push({contexts:context.currentContext,node:childNode})))})},GraphExecutor.prototype.dispose=function(){var _this=this;Object.keys(this.weightMap).forEach(function(key){return _this.weightMap[key].forEach(function(tensor){return tensor.dispose()})})},GraphExecutor.prototype.checkInputShapeAndType=function(inputs){var _this=this;Object.keys(inputs).forEach(function(name){var input=inputs[name],node=_this.graph.nodes[name];if(node.attrParams.shape&&node.attrParams.shape.value){var shape_1=node.attrParams.shape.value,match=shape_1.length===input.shape.length&&input.shape.every(function(dim,index){return-1===shape_1[index]||shape_1[index]===dim});tfjs_core_1.util.assert(match,function(){return"The shape of dict['"+node.name+"'] provided in model.execute(dict) must be ["+shape_1+"], but was ["+input.shape+"]"})}node.attrParams.dtype&&node.attrParams.dtype.value&&tfjs_core_1.util.assert(input.dtype===node.attrParams.dtype.value,function(){return"The dtype of dict['"+node.name+"'] provided in model.execute(dict) must be "+node.attrParams.dtype.value+", but was "+input.dtype})})},GraphExecutor.prototype.checkInputs=function(inputs){var _this=this,notInGraph=Object.keys(inputs).filter(function(name){return!_this.graph.nodes[name]});if(0<notInGraph.length)throw new Error("The dict provided in model.execute(dict) has keys: ["+notInGraph+"] that are not part of graph")},GraphExecutor.prototype.checkOutputs=function(outputs){var _this=this;outputs.forEach(function(name){var normalizedName=utils_1.parseNodeName(name)[0];if(!_this.graph.nodes[normalizedName])throw new Error("The output '"+name+"' is not found in the graph")})},GraphExecutor}();exports.GraphExecutor=GraphExecutor},{"../operations/executors/utils":30,"../operations/operation_executor":47,"./execution_context":5,"./model_analysis":8,"./model_rewrite":9,"@tensorflow/tfjs-core":148}],7:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),register_1=require("../operations/custom_op/register"),operation_mapper_1=require("../operations/operation_mapper"),graph_executor_1=require("./graph_executor");exports.TFHUB_SEARCH_PARAM="?tfjs-format=file",exports.DEFAULT_MODEL_NAME="model.json";var GraphModel=function(){function GraphModel(modelUrl,loadOptions){void 0===loadOptions&&(loadOptions={}),this.modelUrl=modelUrl,this.loadOptions=loadOptions,this.version="n/a",null==loadOptions&&(this.loadOptions={})}return Object.defineProperty(GraphModel.prototype,"modelVersion",{get:function(){return this.version},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"inputNodes",{get:function(){return this.executor.inputNodes},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"outputNodes",{get:function(){return this.executor.outputNodes},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"inputs",{get:function(){return this.executor.inputs},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"outputs",{get:function(){return this.executor.outputs},enumerable:!0,configurable:!0}),Object.defineProperty(GraphModel.prototype,"weights",{get:function(){return this.executor.weightMap},enumerable:!0,configurable:!0}),GraphModel.prototype.fusePrelu=function(){this.executor.fusePrelu(),null==register_1.getRegisteredOp("Prelu")&&register_1.registerOp("Prelu",function(node){var x=node.inputs[0],alpha=node.inputs[1];return tf.prelu(x,alpha)})},GraphModel.prototype.findIOHandler=function(){var path=this.modelUrl;if(null!=path.load)this.handler=path;else if(null!=this.loadOptions.requestInit)this.handler=tfjs_core_1.io.browserHTTPRequest(path,this.loadOptions);else{var handlers=tfjs_core_1.io.getLoadHandlers(path,this.loadOptions.onProgress);if(0===handlers.length)handlers.push(tfjs_core_1.io.browserHTTPRequest(path,this.loadOptions));else if(1<handlers.length)throw new Error("Found more than one ("+handlers.length+") load handlers for URL '"+[path]+"'");this.handler=handlers[0]}},GraphModel.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var artifacts,graph,weightMap;return __generator(this,function(_a){switch(_a.label){case 0:if(this.findIOHandler(),null==this.handler.load)throw new Error("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");return[4,this.handler.load()];case 1:return artifacts=_a.sent(),graph=artifacts.modelTopology,this.version=graph.versions.producer+"."+graph.versions.minConsumer,weightMap=tfjs_core_1.io.decodeWeights(artifacts.weightData,artifacts.weightSpecs),this.executor=new graph_executor_1.GraphExecutor(operation_mapper_1.OperationMapper.Instance.transformGraph(graph)),this.executor.weightMap=this.convertTensorMapToTensorsMap(weightMap),[2,!0]}})})},GraphModel.prototype.predict=function(inputs,config){return this.execute(inputs,this.outputNodes)},GraphModel.prototype.normalizeInputs=function(inputs){if(!(inputs instanceof tfjs_core_1.Tensor||Array.isArray(inputs)))return inputs;if((inputs=Array.isArray(inputs)?inputs:[inputs]).length!==this.inputNodes.length)throw new Error("Input tensor count mismatch,the graph model has "+this.inputNodes.length+" placeholders, while there are "+inputs.length+" input tensors.");return this.inputNodes.reduce(function(map,inputName,i){return map[inputName]=inputs[i],map},{})},GraphModel.prototype.normalizeOutputs=function(outputs){return outputs=outputs||this.outputNodes,Array.isArray(outputs)?outputs:[outputs]},GraphModel.prototype.execute=function(inputs,outputs){inputs=this.normalizeInputs(inputs),outputs=this.normalizeOutputs(outputs);var result=this.executor.execute(inputs,outputs);return 1<result.length?result:result[0]},GraphModel.prototype.executeAsync=function(inputs,outputs){return __awaiter(this,void 0,void 0,function(){var result;return __generator(this,function(_a){switch(_a.label){case 0:return inputs=this.normalizeInputs(inputs),outputs=this.normalizeOutputs(outputs),[4,this.executor.executeAsync(inputs,outputs)];case 1:return[2,1<(result=_a.sent()).length?result:result[0]]}})})},GraphModel.prototype.convertTensorMapToTensorsMap=function(map){return Object.keys(map).reduce(function(newMap,key){return newMap[key]=[map[key]],newMap},{})},GraphModel.prototype.dispose=function(){this.executor.dispose()},GraphModel}();exports.GraphModel=GraphModel,exports.loadGraphModel=function(modelUrl,options){return void 0===options&&(options={}),__awaiter(this,void 0,void 0,function(){var model;return __generator(this,function(_a){switch(_a.label){case 0:if(null==modelUrl)throw new Error("modelUrl in loadGraphModel() cannot be null. Please provide a url or an IOHandler that loads the model");return null==options&&(options={}),options.fromTFHub&&null==modelUrl.load&&(modelUrl.endsWith("/")||(modelUrl+="/"),modelUrl=""+modelUrl+exports.DEFAULT_MODEL_NAME+exports.TFHUB_SEARCH_PARAM),[4,(model=new GraphModel(modelUrl,options)).load()];case 1:return _a.sent(),[2,model]}})})}},{"../operations/custom_op/register":13,"../operations/operation_mapper":48,"./graph_executor":6,"@tensorflow/tfjs-core":148}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getExecutionSubgraph=function(inputs,outputs,weightMap){for(var usedNodes=new Set,missingInputs=[],dynamicNode=null,syncInputs=null,seen=new Set,frontier=outputs.slice();0<frontier.length;){var node=frontier.pop();(isControlFlow(node)||isDynamicShape(node))&&null==dynamicNode&&(syncInputs=(dynamicNode=node).children.map(function(child){return child.name}).filter(function(name){return usedNodes.has(name)})),usedNodes.add(node.name),null==weightMap[node.name]&&null==inputs[node.name]&&(0!==node.inputs.length?node.inputs.forEach(function(input){seen.has(input.name)||(seen.add(input.name),frontier.push(input))}):missingInputs.push(node.name))}return{inputs:inputs,outputs:outputs,usedNodes:usedNodes,missingInputs:missingInputs,dynamicNode:dynamicNode,syncInputs:syncInputs}},exports.getNodesInTopologicalOrder=function(graph,weightMap,executionInfo){var usedNodes=executionInfo.usedNodes,inputs=executionInfo.inputs,frontier=[];Object.keys(inputs).map(function(name){return graph.nodes[name]}).forEach(function(input){usedNodes.has(input.name)&&frontier.push(input)}),graph.weights.forEach(function(weight){usedNodes.has(weight.name)&&frontier.push(weight)});for(var seen=new Set,orderedNodes=[];0<frontier.length;){var node=frontier.pop();seen.add(node.name),weightMap[node.name]||orderedNodes.push(node),node.children.forEach(function(child){!seen.has(child.name)&&usedNodes.has(child.name)&&child.inputs.every(function(input){return seen.has(input.name)})&&frontier.push(child)})}return orderedNodes};var CONTROL_FLOW_OPS=["Switch","Merge","Enter","Exit","NextIteration"],DYNAMIC_SHAPE_OPS=["NonMaxSuppressionV2","NonMaxSuppressionV3","Where"];function isControlFlow(node){return 0<=CONTROL_FLOW_OPS.indexOf(node.op)}function isDynamicShape(node){return 0<=DYNAMIC_SHAPE_OPS.indexOf(node.op)}exports.isControlFlow=isControlFlow,exports.isDynamicShape=isDynamicShape},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core");exports.rewritePrelu=function(graph,weightMap){function _loop_1(key){var addNode=graph.nodes[key];if(null==addNode||"Add"!==addNode.op&&"AddV2"!==addNode.op||2!==addNode.inputNames.length)return"continue";var reluNode=addNode.inputs.find(function(input){return"Relu"===input.op});if(null==reluNode||1!==reluNode.inputNames.length)return"continue";var mulOp=addNode.inputs.find(function(input){return"Mul"===input.op});if(null==mulOp||2!==mulOp.inputNames.length)return"continue";var negAlphaTensorNode=mulOp.inputs.find(function(input){return"Const"===input.op}),reluNegInputNode=mulOp.inputs.find(function(input){return"Relu"===input.op});if(null==negAlphaTensorNode||null==reluNegInputNode||1!==reluNegInputNode.inputNames.length)return"continue";var negInputNode=reluNegInputNode.inputs[0];if(null==negInputNode||"Neg"!==negInputNode.op||1!==negInputNode.inputNames.length)return"continue";if(reluNode.inputNames[0]!==negInputNode.inputNames[0])return"continue";var inputNode=reluNode.inputs[0],outputNodes=addNode.children,alphaTensorName=negAlphaTensorNode.name+"_neg",negNode={name:alphaTensorName,inputNames:[],inputs:[],attrParams:{},category:"graph",children:[],op:"Const",inputParams:{},rawAttrs:{}};weightMap[alphaTensorName]=[tfjs_core_1.neg(weightMap[negAlphaTensorNode.name][0])],graph.weights.push(negNode);var preluNode={name:addNode.name+"_Prelu",inputNames:[inputNode.name,negNode.name],inputs:[inputNode,negNode],attrParams:{},category:"custom",children:outputNodes,op:"Prelu",inputParams:{x:{inputIndexStart:0,type:"tensor"},alpha:{inputIndexStart:1,type:"tensor"}}};negNode.children.push(preluNode);var mulIndex=negAlphaTensorNode.children.indexOf(mulOp);-1<mulIndex&&negAlphaTensorNode.children.splice(mulIndex,1);var reluIndex=inputNode.children.indexOf(reluNode);-1<reluIndex&&inputNode.children.splice(reluIndex,1);var negIndex=inputNode.children.indexOf(negInputNode);if(-1<negIndex&&inputNode.children.splice(negIndex,1),inputNode.children.push(preluNode),outputNodes.forEach(function(node){var addIndex=node.inputNames.indexOf(addNode.name);-1<addIndex&&(node.inputNames[addIndex]=preluNode.name,node.inputs[addIndex]=preluNode)}),0===outputNodes.length){var addIndex=graph.outputs.indexOf(addNode);-1<addIndex&&graph.outputs.splice(addIndex,1),graph.outputs.push(preluNode)}delete graph.nodes[addNode.name],delete graph.nodes[mulOp.name],delete graph.nodes[reluNode.name],delete graph.nodes[reluNegInputNode.name],delete graph.nodes[negInputNode.name],graph.nodes[preluNode.name]=preluNode,graph.nodes[negNode.name]=negNode}for(var key in graph.nodes)_loop_1(key)}},{"@tensorflow/tfjs-core":148}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),TensorArray=function(){function TensorArray(name,dtype,maxSize,elementShape,identicalElementShapes,dynamicSize,clearAfterRead){this.name=name,this.dtype=dtype,this.maxSize=maxSize,this.elementShape=elementShape,this.identicalElementShapes=identicalElementShapes,this.dynamicSize=dynamicSize,this.clearAfterRead=clearAfterRead,this.tensors=[],this.closed_=!1,this.id=TensorArray.nextId++}return Object.defineProperty(TensorArray.prototype,"closed",{get:function(){return this.closed_},enumerable:!0,configurable:!0}),TensorArray.prototype.clearAndClose=function(){this.tensors.forEach(function(tensor){return tensor.tensor.dispose()}),this.tensors=[],this.closed_=!0},TensorArray.prototype.size=function(){return this.tensors.length},TensorArray.prototype.read=function(index){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(index<0||index>=this.tensors.length)throw new Error("Tried to read from index "+index+", but array size is: "+this.tensors.length);var tensorWithState=this.tensors[index];if(tensorWithState.cleared)throw new Error("TensorArray "+this.name+": Could not read index "+index+" twice because it was cleared after a previous read (perhaps try setting clear_after_read = false?).");return this.clearAfterRead&&(tensorWithState.cleared=!0),tensorWithState.read=!0,tensorWithState.tensor},TensorArray.prototype.readMany=function(indices){var _this=this;return indices.map(function(index){return _this.read(index)})},TensorArray.prototype.write=function(index,tensor){if(this.closed_)throw new Error("TensorArray "+this.name+" has already been closed.");if(index<0||!this.dynamicSize&&index>=this.maxSize)throw new Error("Tried to write to index "+index+", but array is not resizeable and size is: "+this.maxSize);var t=this.tensors[index]||{};if(tensor.dtype!==this.dtype)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+index+",\n          because the value dtype is "+tensor.dtype+", but TensorArray dtype is "+this.dtype+".");if(0!==this.size()||null!=this.elementShape&&0!==this.elementShape.length||(this.elementShape=tensor.shape),this.assertShapesMatchAllowUndefinedSize(this.elementShape,tensor.shape,"TensorArray "+this.name+": Could not write to TensorArray index "+index+"."),t&&t.read)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+index+", because it has already been read.");if(t&&t.written)throw new Error("TensorArray "+this.name+": Could not write to TensorArray index "+index+", because it has already been written.");t.tensor=tensor,t.written=!0,this.tensors[index]=t},TensorArray.prototype.writeMany=function(indices,tensors){var _this=this;if(indices.length!==tensors.length)throw new Error("TensorArray "+this.name+": could not write multiple tensors,because the index size: "+indices.length+" is not the same as tensors size: "+tensors.length+".");indices.forEach(function(i,index){return _this.write(i,tensors[index])})},TensorArray.prototype.gather=function(indices,dtype){if(dtype&&dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but gather requested dtype "+dtype);if(!indices){indices=[];for(var i=0;i<this.size();i++)indices.push(i)}if(0===indices.length)return tfjs_core_1.tensor([],[0].concat(this.elementShape));var tensors=this.readMany(indices);return this.assertShapesMatchAllowUndefinedSize(this.elementShape,tensors[0].shape,"TensorArray shape mismatch: "),tfjs_core_1.stack(tensors,0)},TensorArray.prototype.concat=function(dtype){if(dtype&&dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but concat requested dtype "+dtype);if(0===this.size())return tfjs_core_1.tensor([],[0].concat(this.elementShape));for(var indices=[],i=0;i<this.size();i++)indices.push(i);var tensors=this.readMany(indices);return this.assertShapesMatchAllowUndefinedSize(this.elementShape,tensors[0].shape,"TensorArray shape mismatch: tensor array shape ("+this.elementShape+") vs first tensor shape ("+tensors[0].shape+")"),tfjs_core_1.concat(tensors,0)},TensorArray.prototype.scatter=function(indices,tensor){if(tensor.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+tensor.dtype);if(indices.length!==tensor.shape[0])throw new Error("Expected len(indices) == tensor.shape[0], but saw: "+indices.length+" vs. "+tensor.shape[0]);var maxIndex=Math.max.apply(Math,indices);if(!this.dynamicSize&&maxIndex>=this.maxSize)throw new Error("Max index must be < array size ("+maxIndex+"  vs. "+this.maxSize+")");this.writeMany(indices,tfjs_core_1.unstack(tensor,0))},TensorArray.prototype.split=function(length,tensor){var _this=this;if(tensor.dtype!==this.dtype)throw new Error("TensorArray dtype is "+this.dtype+" but tensor has dtype "+tensor.dtype);var totalLength=0,cumulativeLengths=length.map(function(len){return totalLength+=len});if(totalLength!==tensor.shape[0])throw new Error("Expected sum of lengths to be equal to\n          tensor.shape[0], but sum of lengths is\n        "+totalLength+", and tensor's shape is: "+tensor.shape);if(!this.dynamicSize&&length.length!==this.maxSize)throw new Error("TensorArray's size is not equal to the size of lengths ("+this.maxSize+" vs. "+length.length+"), and the TensorArray is not marked as dynamically resizeable");var elementPerRow=0===totalLength?0:tensor.size/totalLength,tensors=[];tfjs_core_1.tidy(function(){tensor=tensor.reshape([1,totalLength,elementPerRow]);for(var i=0;i<length.length;++i){var indices_1=[0,0===i?0:cumulativeLengths[i-1],0],sizes=[1,length[i],elementPerRow];tensors[i]=tfjs_core_1.slice(tensor,indices_1,sizes).reshape(_this.elementShape)}return tensors});for(var indices=[],i=0;i<length.length;i++)indices[i]=i;this.writeMany(indices,tensors)},TensorArray.prototype.assertShapesMatchAllowUndefinedSize=function(shapeA,shapeB,errorMessagePrefix){void 0===errorMessagePrefix&&(errorMessagePrefix=""),tfjs_core_1.util.assert(this.shapesEqualAllowUndefinedSize(shapeA,shapeB),function(){return errorMessagePrefix+" Shapes "+shapeA+" and "+shapeB+" must match"})},TensorArray.prototype.shapesEqualAllowUndefinedSize=function(n1,n2){if(n1.length!==n2.length)return!1;for(var i=0;i<n1.length;i++)if(-1!==n1[i]&&-1!==n2[i]&&n1[i]!==n2[i])return!1;return!0},TensorArray.nextId=0,TensorArray}();exports.TensorArray=TensorArray},{"@tensorflow/tfjs-core":148}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var graph_model_1=require("./executor/graph_model");exports.GraphModel=graph_model_1.GraphModel,exports.loadGraphModel=graph_model_1.loadGraphModel;var register_1=require("./operations/custom_op/register");exports.deregisterOp=register_1.deregisterOp,exports.registerOp=register_1.registerOp;var version_1=require("./version");exports.version_converter=version_1.version},{"./executor/graph_model":7,"./operations/custom_op/register":13,"./version":49}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../executors/utils"),operation_mapper_1=require("../operation_mapper"),NodeValueImpl=function(){function NodeValueImpl(node,tensorMap,context){var _this=this;this.node=node,this.tensorMap=tensorMap,this.context=context,this.inputs=[],this.attrs={},this.inputs=node.inputNames.map(function(name){return _this.getInput(name)}),null!=node.rawAttrs&&(this.attrs=Object.keys(node.rawAttrs).reduce(function(attrs,key){return attrs[key]=_this.getAttr(key),attrs},{}))}return NodeValueImpl.prototype.getInput=function(name){return utils_1.getTensor(name,this.tensorMap,this.context)},NodeValueImpl.prototype.getAttr=function(name,defaultValue){var value=this.node.rawAttrs[name];if(null!=value.tensor)return utils_1.getTensor(name,this.tensorMap,this.context);if(null!=value.i||null!=value.f)return operation_mapper_1.getNumberParam(this.node.rawAttrs,name,defaultValue);if(null!=value.s)return operation_mapper_1.getStringParam(this.node.rawAttrs,name,defaultValue);if(null!=value.b)return operation_mapper_1.getBoolParam(this.node.rawAttrs,name,defaultValue);if(null!=value.shape)return operation_mapper_1.getTensorShapeParam(this.node.rawAttrs,name,defaultValue);if(null!=value.type)return operation_mapper_1.getDtypeParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list){if(null!=value.list.i||null!=value.list.f)return operation_mapper_1.getNumericArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.s)return operation_mapper_1.getStringArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.shape)return operation_mapper_1.getTensorShapeArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.b)return operation_mapper_1.getBoolArrayParam(this.node.rawAttrs,name,defaultValue);if(null!=value.list.type)return operation_mapper_1.getDtypeArrayParam(this.node.rawAttrs,name,defaultValue)}return defaultValue},NodeValueImpl}();exports.NodeValueImpl=NodeValueImpl},{"../executors/utils":30,"../operation_mapper":48}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CUSTOM_OPS={};exports.registerOp=function(name,opFunc){var opMapper={tfOpName:name,category:"custom",inputs:[],attrs:[],customExecutor:opFunc};CUSTOM_OPS[name]=opMapper},exports.getRegisteredOp=function(name){return CUSTOM_OPS[name]},exports.deregisterOp=function(name){delete CUSTOM_OPS[name]}},{}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"BiasAdd":case"AddV2":case"Add":return[tfc.add(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"AddN":return[tfc.addN(utils_1.getParamValue("tensors",node,tensorMap,context))];case"FloorMod":case"Mod":return[tfc.mod(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Mul":return[tfc.mul(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"RealDiv":case"Div":return[tfc.div(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"FloorDiv":return[tfc.floorDiv(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Sub":return[tfc.sub(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Minimum":return[tfc.minimum(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Maximum":return[tfc.maximum(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Pow":return[tfc.pow(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"SquaredDifference":return[tfc.squaredDifference(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="arithmetic"},{"./utils":30,"@tensorflow/tfjs-core":148}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Abs":case"ComplexAbs":return[tfc.abs(utils_1.getParamValue("x",node,tensorMap,context))];case"Acos":return[tfc.acos(utils_1.getParamValue("x",node,tensorMap,context))];case"Acosh":return[tfc.acosh(utils_1.getParamValue("x",node,tensorMap,context))];case"Asin":return[tfc.asin(utils_1.getParamValue("x",node,tensorMap,context))];case"Asinh":return[tfc.asinh(utils_1.getParamValue("x",node,tensorMap,context))];case"Atan":return[tfc.atan(utils_1.getParamValue("x",node,tensorMap,context))];case"Atan2":return[tfc.atan2(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("y",node,tensorMap,context))];case"Atanh":return[tfc.atanh(utils_1.getParamValue("x",node,tensorMap,context))];case"Ceil":return[tfc.ceil(utils_1.getParamValue("x",node,tensorMap,context))];case"Complex":return[tfc.complex(utils_1.getParamValue("real",node,tensorMap,context),utils_1.getParamValue("imag",node,tensorMap,context))];case"Cos":return[tfc.cos(utils_1.getParamValue("x",node,tensorMap,context))];case"Cosh":return[tfc.cosh(utils_1.getParamValue("x",node,tensorMap,context))];case"Elu":return[tfc.elu(utils_1.getParamValue("x",node,tensorMap,context))];case"Erf":return[tfc.erf(utils_1.getParamValue("x",node,tensorMap,context))];case"Exp":return[tfc.exp(utils_1.getParamValue("x",node,tensorMap,context))];case"Expm1":return[tfc.expm1(utils_1.getParamValue("x",node,tensorMap,context))];case"Floor":return[tfc.floor(utils_1.getParamValue("x",node,tensorMap,context))];case"Log":return[tfc.log(utils_1.getParamValue("x",node,tensorMap,context))];case"Log1p":return[tfc.log1p(utils_1.getParamValue("x",node,tensorMap,context))];case"Imag":return[tfc.imag(utils_1.getParamValue("x",node,tensorMap,context))];case"Neg":return[tfc.neg(utils_1.getParamValue("x",node,tensorMap,context))];case"Reciprocal":return[tfc.reciprocal(utils_1.getParamValue("x",node,tensorMap,context))];case"Real":return[tfc.real(utils_1.getParamValue("x",node,tensorMap,context))];case"Relu":return[tfc.relu(utils_1.getParamValue("x",node,tensorMap,context))];case"Round":return[tfc.round(utils_1.getParamValue("x",node,tensorMap,context))];case"Selu":return[tfc.selu(utils_1.getParamValue("x",node,tensorMap,context))];case"Sigmoid":return[tfc.sigmoid(utils_1.getParamValue("x",node,tensorMap,context))];case"Sin":return[tfc.sin(utils_1.getParamValue("x",node,tensorMap,context))];case"Sign":return[tfc.sign(utils_1.getParamValue("x",node,tensorMap,context))];case"Sinh":return[tfc.sinh(utils_1.getParamValue("x",node,tensorMap,context))];case"Softplus":return[tfc.softplus(utils_1.getParamValue("x",node,tensorMap,context))];case"Sqrt":return[tfc.sqrt(utils_1.getParamValue("x",node,tensorMap,context))];case"Square":return[tfc.square(utils_1.getParamValue("x",node,tensorMap,context))];case"Tanh":return[tfc.tanh(utils_1.getParamValue("x",node,tensorMap,context))];case"Tan":return[tfc.tan(utils_1.getParamValue("x",node,tensorMap,context))];case"Relu6":case"ClipByValue":return[tfc.clipByValue(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("clipValueMin",node,tensorMap,context),utils_1.getParamValue("clipValueMax",node,tensorMap,context))];case"Rsqrt":return[tfc.rsqrt(utils_1.getTensor(node.inputNames[0],tensorMap,context))];case"Prod":return[tfc.prod(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("axes",node,tensorMap,context))];case"LeakyRelu":return[tfc.leakyRelu(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("alpha",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="basic_math"},{"./utils":30,"@tensorflow/tfjs-core":148}],16:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),tensor_array_1=require("../../executor/tensor_array"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){return __awaiter(this,void 0,void 0,function(){var pred,data_1,inputName,frameId,data,tensor,input,size,dtype,elementShape,dynamicSize,clearAfterRead,identicalElementShapes,name_1,tensorArray,id,index,writeTensor,readId,readIndex,gatherId,gatherIndices,gatherDtype,scatterId,scatterIndices,scatterTensor,concatId,concatTensorArray,concatDtype,splitId,splitTensor,lengths,sizeId,sizeTensorArray,closeId;return __generator(this,function(_b){switch(_b.label){case 0:switch(node.op){case"LoopCond":return[3,1];case"Switch":return[3,2];case"Merge":return[3,4];case"Enter":return[3,5];case"Exit":return[3,6];case"NextIteration":return[3,7];case"TensorArrayV3":return[3,8];case"TensorArrayWriteV3":return[3,9];case"TensorArrayReadV3":return[3,10];case"TensorArrayGatherV3":return[3,11];case"TensorArrayScatterV3":return[3,12];case"TensorArrayConcatV3":return[3,13];case"TensorArraySplitV3":return[3,14];case"TensorArraySizeV3":return[3,15];case"TensorArrayCloseV3":return[3,16]}return[3,17];case 1:return[2,[utils_1.getParamValue("pred",node,tensorMap,context).clone()]];case 2:return pred=utils_1.getParamValue("pred",node,tensorMap,context),data_1=utils_1.getParamValue("data",node,tensorMap,context),[4,pred.data()];case 3:return[2,_b.sent()[0]?[void 0,data_1.clone()]:[data_1.clone(),void 0]];case 4:return[2,(inputName=node.inputNames.find(function(name){return void 0!==utils_1.getTensor(name,tensorMap,context)}))?[utils_1.getTensor(inputName,tensorMap,context).clone()]:void 0];case 5:return frameId=utils_1.getParamValue("frameName",node,tensorMap,context),data=utils_1.getParamValue("tensor",node,tensorMap,context),context.enterFrame(frameId),[2,[data.clone()]];case 6:return tensor=utils_1.getParamValue("tensor",node,tensorMap,context),context.exitFrame(),[2,[tensor.clone()]];case 7:return input=utils_1.getParamValue("tensor",node,tensorMap,context),context.nextIteration(),[2,[input.clone()]];case 8:return size=utils_1.getParamValue("size",node,tensorMap,context),dtype=utils_1.getParamValue("dtype",node,tensorMap,context),elementShape=utils_1.getParamValue("elementShape",node,tensorMap,context),dynamicSize=utils_1.getParamValue("dynamicSize",node,tensorMap,context),clearAfterRead=utils_1.getParamValue("clearAfterRead",node,tensorMap,context),identicalElementShapes=utils_1.getParamValue("identicalElementShapes",node,tensorMap,context),name_1=utils_1.getParamValue("name",node,tensorMap,context),tensorArray=new tensor_array_1.TensorArray(name_1,dtype,size,elementShape,identicalElementShapes,dynamicSize,clearAfterRead),context.addTensorArray(tensorArray),[2,[tfjs_core_1.scalar(tensorArray.id),tfjs_core_1.scalar(1)]];case 9:return id=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),index=utils_1.getParamValue("index",node,tensorMap,context),writeTensor=utils_1.getParamValue("tensor",node,tensorMap,context),context.getTensorArray(id).write(index,writeTensor),[2,[tfjs_core_1.scalar(1)]];case 10:return readId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),readIndex=utils_1.getParamValue("index",node,tensorMap,context),[2,[context.getTensorArray(readId).read(readIndex)]];case 11:return gatherId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),gatherIndices=utils_1.getParamValue("indices",node,tensorMap,context),gatherDtype=utils_1.getParamValue("dtype",node,tensorMap,context),[2,[context.getTensorArray(gatherId).gather(gatherIndices,gatherDtype)]];case 12:return scatterId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),scatterIndices=utils_1.getParamValue("indices",node,tensorMap,context),scatterTensor=utils_1.getParamValue("tensor",node,tensorMap,context),context.getTensorArray(scatterId).scatter(scatterIndices,scatterTensor),[2,[tfjs_core_1.scalar(1)]];case 13:return concatId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),concatTensorArray=context.getTensorArray(concatId),concatDtype=utils_1.getParamValue("dtype",node,tensorMap,context),[2,[concatTensorArray.concat(concatDtype)]];case 14:return splitId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),splitTensor=utils_1.getParamValue("tensor",node,tensorMap,context),lengths=utils_1.getParamValue("lengths",node,tensorMap,context),context.getTensorArray(splitId).split(lengths,splitTensor),[2,[tfjs_core_1.scalar(1)]];case 15:return sizeId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),sizeTensorArray=context.getTensorArray(sizeId),[2,[tfjs_core_1.scalar(sizeTensorArray.size(),"int32")]];case 16:return closeId=utils_1.getParamValue("tensorArrayId",node,tensorMap,context),context.getTensorArray(closeId).clearAndClose(),[2,[]];case 17:throw TypeError("Node type "+node.op+" is not implemented")}})})},exports.CATEGORY="control"},{"../../executor/tensor_array":10,"./utils":30,"@tensorflow/tfjs-core":148}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Conv1D":var stride=utils_1.getParamValue("stride",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase(),dilation=utils_1.getParamValue("dilation",node,tensorMap,context);return[tfc.conv1d(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),stride,pad,dataFormat,dilation)];case"Conv2D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase();var dilations=utils_1.getParamValue("dilations",node,tensorMap,context);return[tfc.conv2d(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),[stride[1],stride[2]],pad,dataFormat,[dilations[1],dilations[2]])];case"Conv2DBackpropInput":case"Conv2dTranspose":var shape=utils_1.getParamValue("outputShape",node,tensorMap,context);stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context);return[tfc.conv2dTranspose(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),shape,[stride[1],stride[2]],pad)];case"DepthwiseConv2dNative":case"DepthwiseConv2d":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dilations=utils_1.getParamValue("dilations",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase();return[tfc.depthwiseConv2d(utils_1.getParamValue("input",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),[stride[1],stride[2]],pad,dataFormat,[dilations[1],dilations[2]])];case"Conv3D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase(),dilations=utils_1.getParamValue("dilations",node,tensorMap,context);return[tfc.conv3d(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("filter",node,tensorMap,context),[stride[1],stride[2],stride[3]],pad,dataFormat,[dilations[1],dilations[2],dilations[3]])];case"AvgPool":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context);var kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.avgPool(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2]],[stride[1],stride[2]],pad)];case"MaxPool":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.maxPool(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2]],[stride[1],stride[2]],pad)];case"AvgPool3D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.avgPool3d(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2],kernelSize[3]],[stride[1],stride[2],stride[3]],pad)];case"MaxPool3D":stride=utils_1.getParamValue("strides",node,tensorMap,context),pad=utils_1.getParamValue("pad",node,tensorMap,context),kernelSize=utils_1.getParamValue("kernelSize",node,tensorMap,context);return[tfc.maxPool3d(utils_1.getParamValue("x",node,tensorMap,context),[kernelSize[1],kernelSize[2],kernelSize[3]],[stride[1],stride[2],stride[3]],pad)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="convolution"},{"./utils":30,"@tensorflow/tfjs-core":148}],18:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Fill":var shape=utils_1.getParamValue("shape",node,tensorMap,context),dtype=utils_1.getParamValue("dtype",node,tensorMap,context),value=utils_1.getParamValue("value",node,tensorMap,context);return[tfc.fill(shape,value,dtype)];case"LinSpace":var start=utils_1.getParamValue("start",node,tensorMap,context),stop_1=utils_1.getParamValue("stop",node,tensorMap,context),num=utils_1.getParamValue("num",node,tensorMap,context);return[tfc.linspace(start,stop_1,num)];case"OneHot":var indices=utils_1.getParamValue("indices",node,tensorMap,context),depth=utils_1.getParamValue("depth",node,tensorMap,context),onValue=utils_1.getParamValue("onValue",node,tensorMap,context),offValue=utils_1.getParamValue("offValue",node,tensorMap,context);return[tfc.oneHot(indices,depth,onValue,offValue)];case"Ones":return[tfc.ones(utils_1.getParamValue("shape",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"OnesLike":return[tfc.onesLike(utils_1.getParamValue("x",node,tensorMap,context))];case"RandomUniform":return[tfc.randomUniform(utils_1.getParamValue("shape",node,tensorMap,context),utils_1.getParamValue("minval",node,tensorMap,context),utils_1.getParamValue("maxval",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"Range":start=utils_1.getParamValue("start",node,tensorMap,context);var stop_2=utils_1.getParamValue("stop",node,tensorMap,context),step=utils_1.getParamValue("step",node,tensorMap,context);return[tfc.range(start,stop_2,step,utils_1.getParamValue("dtype",node,tensorMap,context))];case"TruncatedNormal":shape=utils_1.getParamValue("shape",node,tensorMap,context);var mean=utils_1.getParamValue("mean",node,tensorMap,context),stdDev=utils_1.getParamValue("stdDev",node,tensorMap,context),seed=utils_1.getParamValue("seed",node,tensorMap,context);return[tfc.truncatedNormal(shape,mean,stdDev,utils_1.getParamValue("dtype",node,tensorMap,context),seed)];case"Zeros":return[tfc.zeros(utils_1.getParamValue("shape",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"ZerosLike":return[tfc.zerosLike(utils_1.getParamValue("x",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="creation"},{"./utils":30,"@tensorflow/tfjs-core":148}],19:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){return __awaiter(this,void 0,void 0,function(){var boxes,scores,maxOutputSize,iouThreshold,scoreThreshold;return __generator(this,function(_b){switch(_b.label){case 0:switch(node.op){case"NonMaxSuppressionV3":case"NonMaxSuppressionV2":return[3,1];case"Where":return[3,3];case"ListDiff":return[3,5]}return[3,7];case 1:return boxes=utils_1.getParamValue("boxes",node,tensorMap,context),scores=utils_1.getParamValue("scores",node,tensorMap,context),maxOutputSize=utils_1.getParamValue("maxOutputSize",node,tensorMap,context),iouThreshold=utils_1.getParamValue("iouThreshold",node,tensorMap,context),scoreThreshold=utils_1.getParamValue("scoreThreshold",node,tensorMap,context),[4,tfc.image.nonMaxSuppressionAsync(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold)];case 2:return[2,[_b.sent()]];case 3:return[4,tfc.whereAsync(utils_1.getParamValue("condition",node,tensorMap,context))];case 4:return[2,[_b.sent()]];case 5:return[4,tfc.setdiff1dAsync(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("y",node,tensorMap,context))];case 6:return[2,_b.sent()];case 7:throw TypeError("Node type "+node.op+" is not implemented")}})})},exports.CATEGORY="dynamic"},{"./utils":30,"@tensorflow/tfjs-core":148}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"TopKV2":var x=utils_1.getParamValue("x",node,tensorMap,context),k=utils_1.getParamValue("k",node,tensorMap,context),sorted=utils_1.getParamValue("sorted",node,tensorMap,context),result=tfc.topk(x,k,sorted);return[result.values,result.indices];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="evaluation"},{"./utils":30,"@tensorflow/tfjs-core":148}],21:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Const":return tensorMap[node.name];case"PlaceholderWithDefault":var def=utils_1.getParamValue("default",node,tensorMap,context);return[utils_1.getTensor(node.name,tensorMap,context)||def];case"Placeholder":return[utils_1.getTensor(node.name,tensorMap,context)];case"Identity":case"StopGradient":case"FakeQuantWithMinMaxVars":return[utils_1.getParamValue("x",node,tensorMap,context).clone()];case"IdentityN":return utils_1.getParamValue("x",node,tensorMap,context).map(function(t){return t.clone()});case"Snapshot":return[utils_1.getParamValue("x",node,tensorMap,context).clone()];case"Shape":return[tfc.tensor1d(utils_1.getParamValue("x",node,tensorMap,context).shape,"int32")];case"ShapeN":return utils_1.getParamValue("x",node,tensorMap,context).map(function(t){return tfc.tensor1d(t.shape)});case"Size":return[tfc.scalar(utils_1.getParamValue("x",node,tensorMap,context).size,"int32")];case"Rank":return[tfc.scalar(utils_1.getParamValue("x",node,tensorMap,context).rank,"int32")];case"NoOp":return[];case"Print":var input=utils_1.getParamValue("x",node,tensorMap,context),data=utils_1.getParamValue("data",node,tensorMap,context),message=utils_1.getParamValue("message",node,tensorMap,context),summarize=utils_1.getParamValue("summarize",node,tensorMap,context);console.warn("The graph has a tf.print() operation,usually used for debugging, which slows down performance."),console.log(message);for(var i=0;i<data.length;i++)console.log(Array.prototype.slice.call(data[i].dataSync()).slice(0,summarize));return[input];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="graph"},{"./utils":30,"@tensorflow/tfjs-core":148}],22:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"ResizeBilinear":var images=utils_1.getParamValue("images",node,tensorMap,context),size=utils_1.getParamValue("size",node,tensorMap,context),alignCorners=utils_1.getParamValue("alignCorners",node,tensorMap,context);return[tfc.image.resizeBilinear(images,[size[0],size[1]],alignCorners)];case"ResizeNearestNeighbor":images=utils_1.getParamValue("images",node,tensorMap,context),size=utils_1.getParamValue("size",node,tensorMap,context),alignCorners=utils_1.getParamValue("alignCorners",node,tensorMap,context);return[tfc.image.resizeNearestNeighbor(images,[size[0],size[1]],alignCorners)];case"CropAndResize":var image=utils_1.getParamValue("image",node,tensorMap,context),boxes=utils_1.getParamValue("boxes",node,tensorMap,context),boxInd=utils_1.getParamValue("boxInd",node,tensorMap,context),cropSize=utils_1.getParamValue("cropSize",node,tensorMap,context),method=utils_1.getParamValue("method",node,tensorMap,context),extrapolationValue=utils_1.getParamValue("extrapolationValue",node,tensorMap,context);return[tfc.image.cropAndResize(image,boxes,boxInd,cropSize,method,extrapolationValue)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="image"},{"./utils":30,"@tensorflow/tfjs-core":148}],23:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Equal":return[tfc.equal(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"NotEqual":return[tfc.notEqual(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Greater":return[tfc.greater(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"GreaterEqual":return[tfc.greaterEqual(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Less":return[tfc.less(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"LessEqual":return[tfc.lessEqual(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"LogicalAnd":return[tfc.logicalAnd(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"LogicalNot":return[tfc.logicalNot(utils_1.getParamValue("a",node,tensorMap,context))];case"LogicalOr":return[tfc.logicalOr(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];case"Select":return[tfc.where(utils_1.getParamValue("condition",node,tensorMap,context),utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="logical"},{"./utils":30,"@tensorflow/tfjs-core":148}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"BatchMatMul":case"BatchMatMulV2":case"MatMul":return[tfc.matMul(utils_1.getParamValue("a",node,tensorMap,context),utils_1.getParamValue("b",node,tensorMap,context),utils_1.getParamValue("transposeA",node,tensorMap,context),utils_1.getParamValue("transposeB",node,tensorMap,context))];case"Transpose":return[tfc.transpose(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("perm",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="matrices"},{"./utils":30,"@tensorflow/tfjs-core":148}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"FusedBatchNorm":case"FusedBatchNormV2":case"FusedBatchNormV3":return[tfc.batchNorm(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("mean",node,tensorMap,context),utils_1.getParamValue("variance",node,tensorMap,context),utils_1.getParamValue("offset",node,tensorMap,context),utils_1.getParamValue("scale",node,tensorMap,context),utils_1.getParamValue("epsilon",node,tensorMap,context))];case"LRN":return[tfc.localResponseNormalization(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("radius",node,tensorMap,context),utils_1.getParamValue("bias",node,tensorMap,context),utils_1.getParamValue("alpha",node,tensorMap,context),utils_1.getParamValue("beta",node,tensorMap,context))];case"Softmax":return[tfc.softmax(utils_1.getParamValue("x",node,tensorMap,context))];case"LogSoftmax":return[tfc.logSoftmax(utils_1.getParamValue("x",node,tensorMap,context))];case"SparseToDense":return[tfc.sparseToDense(utils_1.getParamValue("sparseIndices",node,tensorMap,context),utils_1.getParamValue("outputShape",node,tensorMap,context),utils_1.getParamValue("sparseValues",node,tensorMap,context),utils_1.getParamValue("defaultValue",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="normalization"},{"./utils":30,"@tensorflow/tfjs-core":148}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Max":var axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.max(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Mean":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.mean(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Min":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.min(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Sum":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.sum(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"All":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.all(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"Any":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.any(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];case"ArgMax":axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.argMax(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"ArgMin":axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.argMin(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"Prod":axis=utils_1.getParamValue("axis",node,tensorMap,context),keepDims=utils_1.getParamValue("keepDims",node,tensorMap,context);return[tfc.prod(utils_1.getParamValue("x",node,tensorMap,context),axis,keepDims)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="reduction"},{"./utils":30,"@tensorflow/tfjs-core":148}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"ConcatV2":case"Concat":var axis=utils_1.getParamValue("axis",node,tensorMap,context),inputs=utils_1.getParamValue("tensors",node,tensorMap,context);return[tfc.concat(inputs,axis)];case"GatherV2":case"Gather":axis=utils_1.getParamValue("axis",node,tensorMap,context);var input=utils_1.getParamValue("x",node,tensorMap,context),indices=utils_1.getParamValue("indices",node,tensorMap,context);return[tfc.gather(input,indices.asType("int32"),axis)];case"ReverseV2":case"Reverse":axis=utils_1.getParamValue("axis",node,tensorMap,context),input=utils_1.getParamValue("x",node,tensorMap,context);return[tfc.reverse(input,axis)];case"Slice":var begin=utils_1.getParamValue("begin",node,tensorMap,context),size=utils_1.getParamValue("size",node,tensorMap,context);return[tfc.slice(utils_1.getParamValue("x",node,tensorMap,context),begin,size)];case"StridedSlice":begin=utils_1.getParamValue("begin",node,tensorMap,context);var end=utils_1.getParamValue("end",node,tensorMap,context),strides=utils_1.getParamValue("strides",node,tensorMap,context),beginMask=utils_1.getParamValue("beginMask",node,tensorMap,context),endMask=utils_1.getParamValue("endMask",node,tensorMap,context),ellipsisMask=utils_1.getParamValue("ellipsisMask",node,tensorMap,context),newAxisMask=utils_1.getParamValue("newAxisMask",node,tensorMap,context),shrinkAxisMask=utils_1.getParamValue("shrinkAxisMask",node,tensorMap,context),tensor=utils_1.getParamValue("x",node,tensorMap,context);if(1===begin.length&&1<tensor.shape.length)for(var i=1;i<tensor.shape.length;i++)begin.push(0),end.push(tensor.shape[i]),strides.push(strides[0]);return[tfc.stridedSlice(tensor,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)];case"Pack":return tfc.tidy(function(){var axis=utils_1.getParamValue("axis",node,tensorMap,context),tensors=utils_1.getParamValue("tensors",node,tensorMap,context),shape=tensors[0].shape,squeezedShape=tensors[0].squeeze().shape,mapped=tensors.map(function(tensor){var sameShape=tfc.util.arraysEqual(tensor.shape,shape);if(!sameShape&&!tfc.util.arraysEqual(tensor.squeeze().shape,squeezedShape))throw new Error("the input tensors shape does not match");return sameShape?tensor:tensor.reshape(shape)});return[tfc.stack(mapped,axis)]});case"Unpack":return tfc.tidy(function(){var axis=utils_1.getParamValue("axis",node,tensorMap,context),tensor=utils_1.getParamValue("tensor",node,tensorMap,context);return tfc.unstack(tensor,axis)});case"Tile":var reps=utils_1.getParamValue("reps",node,tensorMap,context);return[tfc.tile(utils_1.getParamValue("x",node,tensorMap,context),reps)];case"Split":case"SplitV":axis=utils_1.getParamValue("axis",node,tensorMap,context);var numOrSizeSplits=utils_1.getParamValue("numOrSizeSplits",node,tensorMap,context);return tfc.split(utils_1.getParamValue("x",node,tensorMap,context),numOrSizeSplits,axis);case"ScatterNd":indices=utils_1.getParamValue("indices",node,tensorMap,context);var values=utils_1.getParamValue("values",node,tensorMap,context),shape=utils_1.getParamValue("shape",node,tensorMap,context);return[tfc.scatterND(indices,values,shape)];case"GatherNd":var x=utils_1.getParamValue("x",node,tensorMap,context);indices=utils_1.getParamValue("indices",node,tensorMap,context);return[tfc.gatherND(x,indices)];case"SparseToDense":indices=utils_1.getParamValue("sparseIndices",node,tensorMap,context),shape=utils_1.getParamValue("outputShape",node,tensorMap,context);var sparseValues=utils_1.getParamValue("sparseValues",node,tensorMap,context),defaultValue=utils_1.getParamValue("defaultValue",node,tensorMap,context);return[tfc.sparseToDense(indices,sparseValues,shape,sparseValues.dtype===defaultValue.dtype?defaultValue:defaultValue.asType(sparseValues.dtype))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="slice_join"},{"./utils":30,"@tensorflow/tfjs-core":148}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"FFT":return[tfc.fft(utils_1.getParamValue("x",node,tensorMap,context))];case"IFFT":return[tfc.ifft(utils_1.getParamValue("x",node,tensorMap,context))];case"RFFT":return[tfc.rfft(utils_1.getParamValue("x",node,tensorMap,context))];case"IRFFT":return[tfc.irfft(utils_1.getParamValue("x",node,tensorMap,context))];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="spectral"},{"./utils":30,"@tensorflow/tfjs-core":148}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),utils_1=require("./utils");exports.executeOp=function(node,tensorMap,context){switch(node.op){case"Cast":return[tfc.cast(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("dtype",node,tensorMap,context))];case"ExpandDims":var axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.expandDims(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"Squeeze":axis=utils_1.getParamValue("axis",node,tensorMap,context);return[tfc.squeeze(utils_1.getParamValue("x",node,tensorMap,context),axis)];case"Reshape":return[tfc.reshape(utils_1.getParamValue("x",node,tensorMap,context),utils_1.getParamValue("shape",node,tensorMap,context))];case"PadV2":case"Pad":return[tfc.pad(utils_1.getParamValue("x",node,tensorMap,context),utils_1.split(utils_1.getParamValue("padding",node,tensorMap,context),2),utils_1.getParamValue("constantValue",node,tensorMap,context))];case"SpaceToBatchND":var blockShape=utils_1.getParamValue("blockShape",node,tensorMap,context),paddings=utils_1.split(utils_1.getParamValue("paddings",node,tensorMap,context),2);return[tfc.spaceToBatchND(utils_1.getParamValue("x",node,tensorMap,context),blockShape,paddings)];case"BatchToSpaceND":blockShape=utils_1.getParamValue("blockShape",node,tensorMap,context);var crops=utils_1.split(utils_1.getParamValue("crops",node,tensorMap,context),2);return[tfc.batchToSpaceND(utils_1.getParamValue("x",node,tensorMap,context),blockShape,crops)];case"DepthToSpace":var blockSize=utils_1.getParamValue("blockSize",node,tensorMap,context),dataFormat=utils_1.getParamValue("dataFormat",node,tensorMap,context).toUpperCase();return[tfc.depthToSpace(utils_1.getParamValue("x",node,tensorMap,context),blockSize,dataFormat)];default:throw TypeError("Node type "+node.op+" is not implemented")}},exports.CATEGORY="transformation"},{"./utils":30,"@tensorflow/tfjs-core":148}],30:[function(require,module,exports){"use strict";function getTensor(name,tensorsMap,context){var _a=parseNodeName(name),nodeName=_a[0],index=_a[1],contextId=context.currentContextIds.find(function(contextId){return!!tensorsMap[getNodeNameWithContextId(nodeName,contextId)]});return void 0!==contextId?tensorsMap[getNodeNameWithContextId(nodeName,contextId)][index]:void 0}function getNodeNameWithContextId(name,contextId){return contextId?name+"-"+contextId:name}function parseNodeName(name){var index=name.lastIndexOf(":");return-1===index?[name,0]:[name.substring(0,index),Number(name.substring(index+1))]}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getParamValue=function(paramName,node,tensorMap,context){var inputParam=node.inputParams[paramName];if(inputParam&&void 0!==inputParam.inputIndexStart){var start=inputParam.inputIndexStart,end=0===inputParam.inputIndexEnd?void 0:void 0===inputParam.inputIndexEnd?start+1:inputParam.inputIndexEnd;if("tensor"===inputParam.type)return getTensor(node.inputNames[inputParam.inputIndexStart],tensorMap,context);if("tensors"===inputParam.type)return node.inputNames.slice(start,end).map(function(name){return getTensor(name,tensorMap,context)});var data=Array.prototype.slice.call(getTensor(node.inputNames.slice(start)[0],tensorMap,context).dataSync());return"number"===inputParam.type?data[0]:data}var attrParam=node.attrParams[paramName];return attrParam&&attrParam.value},exports.getTensor=getTensor,exports.getTensorsForCurrentContenxt=function(name,tensorsMap,context){return tensorsMap[getNodeNameWithContextId(name,context.currentContextId)]},exports.getNodeNameAndIndex=function(inputName,context){var _a=parseNodeName(inputName),nodeName=_a[0],index=_a[1];return[getNodeNameWithContextId(nodeName,context&&context.currentContextId),index]},exports.parseNodeName=parseNodeName,exports.split=function(arr,size){for(var res=[],i=0;i<arr.length;i+=size)res.push(arr.slice(i,i+size));return res}},{}],31:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Add",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddV2",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddN",category:"arithmetic",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"BiasAdd",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sub",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"RealDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Div",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mul",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Maximum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}]},{tfOpName:"Minimum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}]},{tfOpName:"Pow",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SquaredDifference",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorMod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Abs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan2",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ceil",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ClipByValue",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"clip_value_min",name:"clipValueMin",type:"number"},{tfName:"clip_value_max",name:"clipValueMax",type:"number"}]},{tfOpName:"Complex",category:"basic_math",inputs:[{start:0,name:"real",type:"tensor"},{start:1,name:"imag",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ComplexAbs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Elu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Exp",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Floor",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Imag",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Neg",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Real",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Relu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu6",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"clipValueMin",name:"clipValueMin",type:"number",defaultValue:0},{tfName:"clipValueMax",name:"clipValueMax",type:"number",defaultValue:6}]},{tfOpName:"Selu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sigmoid",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Rsqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Square",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sign",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Round",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Expm1",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log1p",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Reciprocal",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Softplus",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Erf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Prod",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axes",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LeakyRelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"alpha",name:"alpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"LoopCond",category:"control",inputs:[{start:0,name:"pred",type:"tensor"}]},{tfOpName:"Switch",category:"control",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"pred",type:"tensor"}]},{tfOpName:"Merge",category:"control",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"Enter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"frame_name",name:"frameName",type:"string"},{tfName:"is_constant",name:"isConstant",type:"bool"}]},{tfOpName:"Exit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NextIteration",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayV3",category:"control",inputs:[{start:0,name:"size",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"dynamic_size",name:"dynamicSize",type:"bool"},{tfName:"clear_after_read",name:"clearAfterRead",type:"bool"},{tfName:"identical_element_shapes",name:"identicalElementShapes",type:"bool"},{tfName:"tensor_array_name",name:"name",type:"string"}]},{tfOpName:"TensorArrayWriteV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayReadV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"index",type:"number"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayGatherV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"indices",type:"number[]"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"}]},{tfOpName:"TensorArrayScatterV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"indices",type:"number[]"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArrayConcatV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape_except0",name:"elementShapeExcept0",type:"shape",notSupported:!0}]},{tfOpName:"TensorArraySplitV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"tensor",type:"tensor"},{start:2,name:"lengths",type:"number[]"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArraySizeV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"},{start:1,name:"flowIn",type:"number"}]},{tfOpName:"TensorArrayCloseV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"number"}]}]},{}],34:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"AvgPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AvgPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Conv1D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"stride",name:"stride",type:"number"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NWC"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"dilation",name:"dilation",type:"number",defaultValue:1}]},{tfOpName:"Conv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"useCudnnOnGpu",name:"useCudnnOnGpu",type:"bool"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Conv2DBackpropInput",category:"convolution",inputs:[{start:2,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:0,name:"outputShape",type:"number[]"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"DepthwiseConv2d",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"DepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Conv3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]}]},{}],35:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Fill",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"},{start:1,name:"value",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"LinSpace",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"num",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"OneHot",category:"creation",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"depth",type:"number"},{start:2,name:"onValue",type:"number",defaultValue:1},{start:3,name:"offValue",type:"number",defaultValue:0}],attrs:[{tfName:"axis",name:"axis",type:"number",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ones",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"OnesLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"RandomUniform",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number",defaultValue:0},{tfName:"maxval",name:"maxval",type:"number",defaultValue:1},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Range",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"step",type:"number",defaultValue:0}],attrs:[{tfName:"Tidx",name:"dtype",type:"dtype"}]},{tfOpName:"TruncatedNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"means",name:"mean",type:"number",defaultValue:0},{tfName:"stddev",name:"stdDev",type:"number",defaultValue:1},{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Zeros",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"ZerosLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]}]},{}],36:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"NonMaxSuppressionV2",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV3",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}]},{tfOpName:"Where",category:"dynamic",inputs:[{start:0,name:"condition",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ListDiff",category:"dynamic",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],37:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"TopKV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"k",type:"number"}],attrs:[{tfName:"sorted",name:"sorted",type:"bool"}]}]},{}],38:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"PlaceholderWithDefault",category:"graph",inputs:[{start:0,name:"default",type:"tensor"}],attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Placeholder",category:"graph",attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Const",category:"graph"},{tfOpName:"Identity",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IdentityN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Snapshot",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Rank",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Size",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Shape",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"ShapeN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Print",category:"graph",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"data",type:"tensors"}],attrs:[{tfName:"message",name:"message",type:"string"},{tfName:"first_n",name:"firstN",type:"number",notSupported:!0},{tfName:"summarize",name:"summarize",type:"number",defaultValue:3}]},{tfOpName:"NoOp",category:"graph",inputs:[]},{tfOpName:"StopGradient",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"FakeQuantWithMinMaxVars",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"min",name:"min",type:"number"},{tfName:"max",name:"max",type:"number"}]}]},{}],39:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"ResizeBilinear",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ResizeNearestNeighbor",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"CropAndResize",category:"image",inputs:[{start:0,name:"image",type:"tensor"},{start:1,name:"boxes",type:"tensor"},{start:2,name:"boxInd",type:"tensor"},{start:3,name:"cropSize",type:"number[]"}],attrs:[{tfName:"method",name:"method",type:"string"},{tfName:"extrapolation_value",name:"extrapolationValue",type:"number"}]}]},{}],40:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Equal",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NotEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Greater",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"GreaterEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Less",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LessEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalAnd",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalNot",category:"logical",inputs:[{start:0,name:"a",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalOr",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Select",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],41:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"MatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMulV2",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Transpose",category:"matrices",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"perm",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}]},{}],42:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"FusedBatchNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV2",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV3",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"LRN",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"depth_radius",name:"radius",type:"number",defaultValue:5},{tfName:"bias",name:"bias",type:"number",defaultValue:1},{tfName:"alpha",name:"alpha",type:"number",defaultValue:1},{tfName:"beta",name:"beta",type:"number",defaultValue:.5}]},{tfOpName:"Softmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"LogSoftmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"SparseToDense",category:"normalization",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!0,notSupported:!0}]}]},{}],43:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Max",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Mean",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Min",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Sum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"All",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Any",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"ArgMax",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"ArgMin",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Prod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]}]},{}],44:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"ConcatV2",category:"slice_join",inputs:[{start:0,end:-1,name:"tensors",type:"tensors"},{start:-1,name:"axis",type:"number"}]},{tfOpName:"Concat",category:"slice_join",inputs:[{start:1,end:0,name:"tensors",type:"tensors"},{start:0,name:"axis",type:"number"}]},{tfOpName:"GatherV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Gather",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"validate_indices",name:"validateIndices",type:"bool",notSupported:!0}]},{tfOpName:"Reverse",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"dims",type:"bool",notSupported:!0}]},{tfOpName:"ReverseV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}]},{tfOpName:"Slice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"size",type:"number[]"}]},{tfOpName:"StridedSlice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"end",type:"number[]"},{start:3,name:"strides",type:"number[]"}],attrs:[{tfName:"begin_mask",name:"beginMask",type:"number",defaultValue:0},{tfName:"end_mask",name:"endMask",type:"number",defaultValue:0},{tfName:"new_axis_mask",name:"newAxisMask",type:"number",defaultValue:0},{tfName:"ellipsis_mask",name:"ellipsisMask",type:"number",defaultValue:0},{tfName:"shrink_axis_mask",name:"shrinkAxisMask",type:"number",defaultValue:0}]},{tfOpName:"Pack",category:"slice_join",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Unpack",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"num",name:"num",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Tile",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"reps",type:"number[]"}]},{tfOpName:"Split",category:"slice_join",inputs:[{start:0,name:"axis",type:"number",defaultValue:0},{start:1,name:"x",type:"tensor"}],attrs:[{tfName:"num_split",name:"numOrSizeSplits",type:"number",defaultValue:1}]},{tfOpName:"SplitV",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"numOrSizeSplits",type:"number[]"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"ScatterNd",category:"slice_join",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"shape",type:"number[]"}]},{tfOpName:"GatherNd",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}]},{tfOpName:"SparseToDense",category:"slice_join",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!1,notSupported:!0}]}]},{}],45:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"FFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"RFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]},{tfOpName:"IRFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]}]},{}],46:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.json=[{tfOpName:"Cast",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"SrcT",name:"sdtype",type:"dtype",notSupported:!0},{tfName:"DstT",name:"dtype",type:"dtype"}]},{tfOpName:"ExpandDims",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Pad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"constant_value",name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"PadV2",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"},{start:2,name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"Reshape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"Squeeze",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"axis",tfDeprecatedName:"squeeze_dims",name:"axis",type:"number[]"}]},{tfOpName:"SpaceToBatchND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"paddings",type:"number[]"}]},{tfOpName:"BatchToSpaceND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"crops",type:"number[]"}]},{tfOpName:"DepthToSpace",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"block_size",name:"blockSize",type:"number"},{tfName:"data_format",name:"dataFormat",type:"string"}]}]},{}],47:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var node_value_impl_1=require("./custom_op/node_value_impl"),register_1=require("./custom_op/register"),arithmetic=require("./executors/arithmetic_executor"),basicMath=require("./executors/basic_math_executor"),control=require("./executors/control_executor"),convolution=require("./executors/convolution_executor"),creation=require("./executors/creation_executor"),dynamic=require("./executors/dynamic_executor"),evaluation=require("./executors/evaluation_executor"),graph=require("./executors/graph_executor"),image=require("./executors/image_executor"),logical=require("./executors/logical_executor"),matrices=require("./executors/matrices_executor"),normalization=require("./executors/normalization_executor"),reduction=require("./executors/reduction_executor"),sliceJoin=require("./executors/slice_join_executor"),spectral=require("./executors/spectral_executor"),transformation=require("./executors/transformation_executor");exports.executeOp=function(node,tensorMap,context){var value=function(node,tensorMap,context){switch(node.category){case"arithmetic":return arithmetic.executeOp(node,tensorMap,context);case"basic_math":return basicMath.executeOp(node,tensorMap,context);case"control":return control.executeOp(node,tensorMap,context);case"convolution":return convolution.executeOp(node,tensorMap,context);case"creation":return creation.executeOp(node,tensorMap,context);case"dynamic":return dynamic.executeOp(node,tensorMap,context);case"evaluation":return evaluation.executeOp(node,tensorMap,context);case"image":return image.executeOp(node,tensorMap,context);case"graph":return graph.executeOp(node,tensorMap,context);case"logical":return logical.executeOp(node,tensorMap,context);case"matrices":return matrices.executeOp(node,tensorMap,context);case"normalization":return normalization.executeOp(node,tensorMap,context);case"reduction":return reduction.executeOp(node,tensorMap,context);case"slice_join":return sliceJoin.executeOp(node,tensorMap,context);case"spectral":return spectral.executeOp(node,tensorMap,context);case"transformation":return transformation.executeOp(node,tensorMap,context);case"custom":var opMapper=register_1.getRegisteredOp(node.op);if(opMapper&&opMapper.customExecutor)return opMapper.customExecutor(new node_value_impl_1.NodeValueImpl(node,tensorMap,context));throw TypeError("Custom op "+node.op+" is not registered.");default:throw TypeError("Unknown op '"+node.op+"'. File an issue at https://github.com/tensorflow/tfjs/issues so we can add it, or register a custom execution with tf.registerOp()")}}(node,tensorMap,context);return value instanceof Promise?value.then(function(data){return[].concat(data)}):[].concat(value)}},{"./custom_op/node_value_impl":12,"./custom_op/register":13,"./executors/arithmetic_executor":14,"./executors/basic_math_executor":15,"./executors/control_executor":16,"./executors/convolution_executor":17,"./executors/creation_executor":18,"./executors/dynamic_executor":19,"./executors/evaluation_executor":20,"./executors/graph_executor":21,"./executors/image_executor":22,"./executors/logical_executor":23,"./executors/matrices_executor":24,"./executors/normalization_executor":25,"./executors/reduction_executor":26,"./executors/slice_join_executor":27,"./executors/spectral_executor":28,"./executors/transformation_executor":29}],48:[function(require,module,exports){(function(Buffer){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),tensorflow=require("../data/compiled_api"),register_1=require("./custom_op/register"),utils_1=require("./executors/utils"),arithmetic=require("./op_list/arithmetic"),basicMath=require("./op_list/basic_math"),control=require("./op_list/control"),convolution=require("./op_list/convolution"),creation=require("./op_list/creation"),dynamic=require("./op_list/dynamic"),evaluation=require("./op_list/evaluation"),graph=require("./op_list/graph"),image=require("./op_list/image"),logical=require("./op_list/logical"),matrices=require("./op_list/matrices"),normalization=require("./op_list/normalization"),reduction=require("./op_list/reduction"),sliceJoin=require("./op_list/slice_join"),spectral=require("./op_list/spectral"),transformation=require("./op_list/transformation"),OperationMapper=function(){function OperationMapper(){var ops=[arithmetic,basicMath,control,convolution,creation,dynamic,evaluation,logical,image,graph,matrices,normalization,reduction,sliceJoin,spectral,transformation],mappersJson=[].concat.apply([],ops.map(function(op){return op.json}));this.opMappers=mappersJson.reduce(function(map,mapper){return map[mapper.tfOpName]=mapper,map},{})}return Object.defineProperty(OperationMapper,"Instance",{get:function(){return this._instance||(this._instance=new this)},enumerable:!0,configurable:!0}),OperationMapper.prototype.transformGraph=function(graph){var _this=this,tfNodes=graph.node,placeholders=[],weights=[],nodes=tfNodes.reduce(function(map,node){return map[node.name]=_this.mapNode(node),"Placeholder"===node.op&&placeholders.push(map[node.name]),"Const"===node.op&&weights.push(map[node.name]),map},{}),inputs=[],outputs=[],allNodes=Object.keys(nodes);return allNodes.forEach(function(key){var node=nodes[key];node.inputNames.forEach(function(name){var nodeName=utils_1.getNodeNameAndIndex(name)[0];node.inputs.push(nodes[nodeName]),nodes[nodeName].children.push(node)}),0===node.inputs.length&&inputs.push(node)}),allNodes.forEach(function(key){var node=nodes[key];0===node.children.length&&outputs.push(node)}),{nodes:nodes,inputs:inputs,outputs:outputs,weights:weights,placeholders:placeholders}},OperationMapper.prototype.mapNode=function(node){var mapper=register_1.getRegisteredOp(node.op)||this.opMappers[node.op]||{};null==node.attr&&(node.attr={});var newNode={name:node.name,op:node.op,category:mapper.category,inputNames:(node.input||[]).map(function(input){return input.startsWith("^")?input.substr(1):input}),inputs:[],children:[],inputParams:{},attrParams:{},rawAttrs:node.attr};return null!=mapper.inputs&&(newNode.inputParams=mapper.inputs.reduce(function(map,param){return map[param.name]={type:param.type,inputIndexStart:param.start,inputIndexEnd:param.end},map},{})),null!=mapper.attrs&&(newNode.attrParams=mapper.attrs.reduce(function(map,param){var type=param.type,value=void 0;switch(param.type){case"string":void 0===(value=getStringParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getStringParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"string[]":void 0===(value=getStringArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getStringArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"number":void 0===(value=getNumberParam(node.attr,param.tfName,param.defaultValue||0))&&param.tfDeprecatedName&&(value=getNumberParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"number[]":void 0===(value=getNumericArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getNumericArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"bool":void 0===(value=getBoolParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getBoolParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"bool[]":void 0===(value=getBoolArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getBoolArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"shape":void 0===(value=getTensorShapeParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getTensorShapeParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"shape[]":void 0===(value=getTensorShapeArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getTensorShapeArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"dtype":void 0===(value=getDtypeParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getDtypeParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"dtype[]":void 0===(value=getDtypeArrayParam(node.attr,param.tfName,param.defaultValue))&&param.tfDeprecatedName&&(value=getDtypeArrayParam(node.attr,param.tfDeprecatedName,param.defaultValue));break;case"tensor":case"tensors":break;default:throw new Error("Unsupported param type: "+param.type+" for op: "+node.op)}return map[param.name]={value:value,type:type},map},{})),newNode},OperationMapper}();function decodeBase64(text){var global=tfjs_core_1.ENV.global;if(void 0!==global.atob)return global.atob(text);if(void 0!==Buffer)return new Buffer(text,"base64").toString();throw new Error("Unable to decode base64 in this environment. Missing built-in atob() or Buffer()")}function parseStringParam(s,keepCase){var value=Array.isArray(s)?String.fromCharCode.apply(null,s):decodeBase64(s);return keepCase?value:value.toLowerCase()}function getStringParam(attrs,name,def,keepCase){void 0===keepCase&&(keepCase=!1);var param=attrs[name];return null!=param?parseStringParam(param.s,keepCase):def}function getBoolParam(attrs,name,def){var param=attrs[name];return param?param.b:def}function getNumberParam(attrs,name,def){var param=attrs[name]||{},value=null!=param.i?param.i:null!=param.f?param.f:def;return"number"==typeof value?value:parseInt(value,10)}function parseDtypeParam(value){switch("string"==typeof value&&(value=tensorflow.DataType[value]),value){case tensorflow.DataType.DT_FLOAT:return"float32";case tensorflow.DataType.DT_INT32:return"int32";case tensorflow.DataType.DT_BOOL:return"bool";case tensorflow.DataType.DT_DOUBLE:return"float32";case tensorflow.DataType.DT_STRING:return"string";default:return null}}function getDtypeParam(attrs,name,def){var param=attrs[name];return param&&param.type?parseDtypeParam(param.type):def}function getDtypeArrayParam(attrs,name,def){var param=attrs[name];return param&&param.list&&param.list.type?param.list.type.map(function(v){return parseDtypeParam(v)}):def}function parseTensorShapeParam(shape){if(!shape.unknownRank)return null!=shape.dim?shape.dim.map(function(dim){return"number"==typeof dim.size?dim.size:parseInt(dim.size,10)}):[]}function getTensorShapeParam(attrs,name,def){var param=attrs[name];return param&&param.shape?parseTensorShapeParam(param.shape):def}function getNumericArrayParam(attrs,name,def){var param=attrs[name];return param?((param.list.f&&param.list.f.length?param.list.f:param.list.i)||[]).map(function(v){return"number"==typeof v?v:parseInt(v,10)}):def}function getStringArrayParam(attrs,name,def,keepCase){void 0===keepCase&&(keepCase=!1);var param=attrs[name];return param&&param.list&&param.list.s?param.list.s.map(function(v){return parseStringParam(v,keepCase)}):def}function getTensorShapeArrayParam(attrs,name,def){var param=attrs[name];return param&&param.list&&param.list.shape?param.list.shape.map(function(v){return parseTensorShapeParam(v)}):def}function getBoolArrayParam(attrs,name,def){var param=attrs[name];return param&&param.list&&param.list.b?param.list.b:def}exports.OperationMapper=OperationMapper,exports.decodeBase64=decodeBase64,exports.parseStringParam=parseStringParam,exports.getStringParam=getStringParam,exports.getBoolParam=getBoolParam,exports.getNumberParam=getNumberParam,exports.parseDtypeParam=parseDtypeParam,exports.getDtypeParam=getDtypeParam,exports.getDtypeArrayParam=getDtypeArrayParam,exports.parseTensorShapeParam=parseTensorShapeParam,exports.getTensorShapeParam=getTensorShapeParam,exports.getNumericArrayParam=getNumericArrayParam,exports.getStringArrayParam=getStringArrayParam,exports.getTensorShapeArrayParam=getTensorShapeArrayParam,exports.getBoolArrayParam=getBoolArrayParam}).call(this,require("buffer").Buffer)},{"../data/compiled_api":4,"./custom_op/register":13,"./executors/utils":30,"./op_list/arithmetic":31,"./op_list/basic_math":32,"./op_list/control":33,"./op_list/convolution":34,"./op_list/creation":35,"./op_list/dynamic":36,"./op_list/evaluation":37,"./op_list/graph":38,"./op_list/image":39,"./op_list/logical":40,"./op_list/matrices":41,"./op_list/normalization":42,"./op_list/reduction":43,"./op_list/slice_join":44,"./op_list/spectral":45,"./op_list/transformation":46,"@tensorflow/tfjs-core":148,buffer:334}],49:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.version="1.2.8"},{}],50:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EPSILON_FLOAT32=1e-7,exports.EPSILON_FLOAT16=1e-4;var DataStorage=function(){function DataStorage(backend,dataMover){this.backend=backend,this.dataMover=dataMover,this.data=new WeakMap}return DataStorage.prototype.get=function(dataId){return this.data.has(dataId)||this.dataMover.moveData(this.backend,dataId),this.data.get(dataId)},DataStorage.prototype.set=function(dataId,value){this.data.set(dataId,value)},DataStorage.prototype.has=function(dataId){return this.data.has(dataId)},DataStorage.prototype.delete=function(dataId){return this.data.delete(dataId)},DataStorage}();exports.DataStorage=DataStorage;var KernelBackend=function(){function KernelBackend(){}return KernelBackend.prototype.time=function(f){throw new Error("Not yet implemented.")},KernelBackend.prototype.read=function(dataId){throw new Error("Not yet implemented.")},KernelBackend.prototype.readSync=function(dataId){throw new Error("Not yet implemented.")},KernelBackend.prototype.disposeData=function(dataId){throw new Error("Not yet implemented.")},KernelBackend.prototype.write=function(dataId,values){throw new Error("Not yet implemented.")},KernelBackend.prototype.fromPixels=function(pixels,numChannels){throw new Error("Not yet implemented.")},KernelBackend.prototype.register=function(dataId,shape,dtype){throw new Error("Not yet implemented.")},KernelBackend.prototype.memory=function(){throw new Error("Not yet implemented.")},KernelBackend.prototype.floatPrecision=function(){throw new Error("Not yet implemented")},KernelBackend.prototype.epsilon=function(){return 32===this.floatPrecision()?exports.EPSILON_FLOAT32:exports.EPSILON_FLOAT16},KernelBackend.prototype.batchMatMul=function(a,b,transposeA,transposeB){throw new Error("Not yet implemented")},KernelBackend.prototype.fusedBatchMatMul=function(_a){_a.a,_a.b,_a.transposeA,_a.transposeB,_a.bias,_a.activation,_a.preluActivationWeights;throw new Error("Not yet implemented")},KernelBackend.prototype.slice=function(x,begin,size){throw new Error("Not yet implemented")},KernelBackend.prototype.stridedSlice=function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){throw new Error("Not yet implemented")},KernelBackend.prototype.unstack=function(x,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.reverse=function(a,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.concat=function(tensors,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.neg=function(a){throw new Error("Not yet implemented")},KernelBackend.prototype.add=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.addN=function(tensors){throw new Error("Not yet implemented")},KernelBackend.prototype.subtract=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.multiply=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.realDivide=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.floorDiv=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.sum=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.prod=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){throw new Error("Not yet implemented")},KernelBackend.prototype.argMin=function(x,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.argMax=function(x,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.equal=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.notEqual=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.less=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.lessEqual=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.greater=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.greaterEqual=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.logicalNot=function(a){throw new Error("Not yet implemented")},KernelBackend.prototype.logicalAnd=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.logicalOr=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.where=function(condition){throw new Error("Not yet implemented")},KernelBackend.prototype.select=function(condition,a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.topk=function(x,k,sorted){throw new Error("Not yet implemented")},KernelBackend.prototype.min=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.minimum=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.mod=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.max=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.maximum=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.all=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.any=function(x,axes){throw new Error("Not yet implemented")},KernelBackend.prototype.squaredDifference=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.ceil=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.floor=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.round=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sign=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.isNaN=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.isInf=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.isFinite=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.pow=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.exp=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.expm1=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.log=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.log1p=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sqrt=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.rsqrt=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.square=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.reciprocal=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.relu=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.prelu=function(x,a){throw new Error("Not yet implemented")},KernelBackend.prototype.elu=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.eluDer=function(dy,y){throw new Error("Not yet implemented")},KernelBackend.prototype.selu=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.int=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.clip=function(x,min,max){throw new Error("Not yet implemented")},KernelBackend.prototype.abs=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.complexAbs=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sigmoid=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.softplus=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.sin=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.cos=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.tan=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.asin=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.acos=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.atan=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.atan2=function(a,b){throw new Error("Not yet implemented")},KernelBackend.prototype.sinh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.cosh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.tanh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.asinh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.acosh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.atanh=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.erf=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.step=function(x,alpha){throw new Error("Not yet implemented")},KernelBackend.prototype.fusedConv2d=function(x,filter,convInfo,bias,activation,preluActivationWeights){throw new Error("Not yet implemented")},KernelBackend.prototype.conv2d=function(x,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv2dDerInput=function(dy,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv2dDerFilter=function(x,dY,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.depthwiseConv2D=function(input,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.depthwiseConv2DDerFilter=function(x,dY,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv3d=function(x,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv3dDerInput=function(dy,filter,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.conv3dDerFilter=function(x,dY,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPool=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPoolBackprop=function(dy,x,y,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPool=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPoolBackprop=function(dy,x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPool3d=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.avgPool3dBackprop=function(dy,x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPool3d=function(x,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){throw new Error("Not yet implemented")},KernelBackend.prototype.reshape=function(x,shape){throw new Error("Not yet implemented")},KernelBackend.prototype.cast=function(x,dtype){throw new Error("Not yet implemented")},KernelBackend.prototype.tile=function(x,reps){throw new Error("Not yet implemented")},KernelBackend.prototype.pad=function(x,paddings,constantValue){throw new Error("Not yet implemented")},KernelBackend.prototype.transpose=function(x,perm){throw new Error("Not yet implemented")},KernelBackend.prototype.gather=function(x,indices,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.gatherND=function(x,indices){throw new Error("Not yet implemented")},KernelBackend.prototype.scatterND=function(indices,updates,shape){throw new Error("Not yet implemented")},KernelBackend.prototype.batchToSpaceND=function(x,blockShape,crops){throw new Error("Not yet implemented")},KernelBackend.prototype.spaceToBatchND=function(x,blockShape,paddings){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeNearestNeighbor=function(x,newHEight,newWidth,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){throw new Error("Not yet implemented")},KernelBackend.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){throw new Error("Not yet implemented")},KernelBackend.prototype.localResponseNormalization4D=function(x,radius,bias,alpha,beta){throw new Error("Not yet implemented")},KernelBackend.prototype.LRNGrad=function(dy,inputImage,outputImage,radius,bias,alpha,beta){throw new Error("Not yet implemented")},KernelBackend.prototype.multinomial=function(logits,normalized,numSamples,seed){throw new Error("Not yet implemented")},KernelBackend.prototype.oneHot=function(indices,depth,onValue,offValue){throw new Error("Not yet implemented")},KernelBackend.prototype.cumsum=function(x,axis,exclusive,reverse){throw new Error("Not yet implemented")},KernelBackend.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){throw new Error("Not yet implemented")},KernelBackend.prototype.fft=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.ifft=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.complex=function(real,imag){throw new Error("Not yet implemented")},KernelBackend.prototype.real=function(input){throw new Error("Not yet implemented")},KernelBackend.prototype.imag=function(input){throw new Error("Not yet implemented")},KernelBackend.prototype.cropAndResize=function(image,boxes,boxIndex,cropSize,method,extrapolationValue){throw new Error("Not yet implemented")},KernelBackend.prototype.depthToSpace=function(x,blockSize,dataFormat){throw new Error("Not yet implemented")},KernelBackend.prototype.split=function(value,sizeSplits,axis){throw new Error("Not yet implemented")},KernelBackend.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){throw new Error("Not yet implemented")},KernelBackend.prototype.diag=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.fill=function(shape,value,dtype){throw new Error("Not yet implemented.")},KernelBackend.prototype.onesLike=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.zerosLike=function(x){throw new Error("Not yet implemented")},KernelBackend.prototype.linspace=function(start,stop,num){throw new Error("Not yet implemented")},KernelBackend.prototype.dispose=function(){throw new Error("Not yet implemented")},KernelBackend}();exports.KernelBackend=KernelBackend},{}],51:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),tensor_1=require("../tensor"),util_1=require("../util");__export(require("../ops/axis_util")),__export(require("../ops/broadcast_util")),__export(require("../ops/concat_util")),__export(require("../ops/conv_util"));var types_1=require("../types");exports.upcastType=types_1.upcastType,exports.castTensor=function(x,dtype,backend){if("complex64"===dtype){if("complex64"===x.dtype)return x.clone();var zerosTensor=tensor_ops_1.zeros(x.shape),floatX=x.toFloat(),result=backend.complex(floatX,zerosTensor);return zerosTensor.dispose(),floatX.dispose(),result}if(!util_1.hasEncodingLoss(x.dtype,dtype))return tensor_1.Tensor.make(x.shape,{dataId:x.dataId},dtype);if("complex64"===x.dtype){var real=backend.real(x);result=real.cast(dtype);return real.dispose(),result}if("int32"===dtype)return backend.int(x);if("bool"!==dtype)throw new Error("Error in Cast: failed to cast "+x.dtype+" to "+dtype);var zero=tensor_ops_1.scalar(0,x.dtype);return result=backend.notEqual(x,zero),zero.dispose(),result},exports.reshapeTensor=function(x,shape){return tensor_1.Tensor.make(shape,{dataId:x.dataId},x.dtype)},exports.linspaceImpl=function(start,stop,num){var step=(stop-start)/(num-1),values=util_1.makeZerosTypedArray(num,"float32");values[0]=start;for(var i=1;i<values.length;i++)values[i]=values[i-1]+step;return tensor_ops_1.tensor1d(values,"float32")}},{"../ops/axis_util":165,"../ops/broadcast_util":169,"../ops/concat_util":174,"../ops/conv_util":177,"../ops/tensor_ops":216,"../tensor":234,"../types":240,"../util":241}],52:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeRealAndImagArrays=function(real,imag){if(real.length!==imag.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+real.length+", imag: "+imag.length+".");for(var result=new Float32Array(2*real.length),i=0;i<result.length;i+=2)result[i]=real[i/2],result[i+1]=imag[i/2];return result},exports.splitRealAndImagArrays=function(complex){for(var real=new Float32Array(complex.length/2),imag=new Float32Array(complex.length/2),i=0;i<complex.length;i+=2)real[i/2]=complex[i],imag[i/2]=complex[i+1];return{real:real,imag:imag}},exports.complexWithEvenIndex=function(complex){for(var len=Math.ceil(complex.length/4),real=new Float32Array(len),imag=new Float32Array(len),i=0;i<complex.length;i+=4)real[Math.floor(i/4)]=complex[i],imag[Math.floor(i/4)]=complex[i+1];return{real:real,imag:imag}},exports.complexWithOddIndex=function(complex){for(var len=Math.floor(complex.length/4),real=new Float32Array(len),imag=new Float32Array(len),i=2;i<complex.length;i+=4)real[Math.floor(i/4)]=complex[i],imag[Math.floor(i/4)]=complex[i+1];return{real:real,imag:imag}},exports.getComplexWithIndex=function(complex,index){return{real:complex[2*index],imag:complex[2*index+1]}},exports.assignToTypedArray=function(data,real,imag,index){data[2*index]=real,data[2*index+1]=imag},exports.exponents=function(n,inverse){for(var real=new Float32Array(n/2),imag=new Float32Array(n/2),i=0;i<Math.ceil(n/2);i++){var x=(inverse?2:-2)*Math.PI*(i/n);real[i]=Math.cos(x),imag[i]=Math.sin(x)}return{real:real,imag:imag}},exports.exponent=function(k,n,inverse){var x=(inverse?2:-2)*Math.PI*(k/n);return{real:Math.cos(x),imag:Math.sin(x)}}},{}],53:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),engine_1=require("../../engine"),environment_1=require("../../environment"),log_1=require("../../log"),array_ops_util=require("../../ops/array_ops_util"),axis_util=require("../../ops/axis_util"),broadcast_util=require("../../ops/broadcast_util"),complex_ops_1=require("../../ops/complex_ops"),concat_util=require("../../ops/concat_util"),erf_util=require("../../ops/erf_util"),gather_nd_util=require("../../ops/gather_nd_util"),ops=require("../../ops/ops"),ops_1=require("../../ops/ops"),scatter_nd_util=require("../../ops/scatter_nd_util"),selu_util=require("../../ops/selu_util"),slice_util_1=require("../../ops/slice_util"),tensor_1=require("../../tensor"),types_1=require("../../types"),util=require("../../util"),util_1=require("../../util"),backend_1=require("../backend"),backend_util=require("../backend_util"),complex_util=require("../complex_util"),non_max_suppression_impl_1=require("../non_max_suppression_impl"),split_shared_1=require("../split_shared"),tile_impl_1=require("../tile_impl"),topk_impl_1=require("../topk_impl"),where_impl_1=require("../where_impl");function mapActivation(backend,x,activation,preluActivationWeights){if("linear"===activation)return backend.linear(x);if("relu"===activation)return backend.relu(x);if("prelu"===activation)return backend.prelu(x,preluActivationWeights);throw new Error("Activation "+activation+" has not been implemented for the CPU backend.")}var MathBackendCPU=function(){function MathBackendCPU(){if(this.blockSize=48,this.firstUse=!0,environment_1.ENV.get("IS_BROWSER")){var canvas="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(300,150):"undefined"!=typeof document?document.createElement("canvas"):null;null!==canvas&&(this.fromPixels2DContext=canvas.getContext("2d"))}this.data=new backend_1.DataStorage(this,engine_1.ENGINE)}return MathBackendCPU.prototype.register=function(dataId,shape,dtype){if(this.firstUse&&(this.firstUse=!1,environment_1.ENV.get("IS_NODE")&&log_1.warn("\n============================\nHi there . Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================\n")),this.data.has(dataId))throw new Error("Data buffer is already registered");this.data.set(dataId,{dtype:dtype})},MathBackendCPU.prototype.write=function(dataId,values){if(null==values)throw new Error("MathBackendCPU.write(): values can not be null");this.data.get(dataId).values=values},MathBackendCPU.prototype.fromPixels=function(pixels,numChannels){if(null==pixels)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var vals,values,isPixelData=pixels.data instanceof Uint8Array,isImageData="undefined"!=typeof ImageData&&pixels instanceof ImageData,isVideo="undefined"!=typeof HTMLVideoElement&&pixels instanceof HTMLVideoElement,isImage="undefined"!=typeof HTMLImageElement&&pixels instanceof HTMLImageElement;if(environment_1.ENV.get("IS_NODE")&&null==pixels.getContext)throw new Error("When running in node, pixels must be an HTMLCanvasElement like the one returned by the `canvas` npm package");if(null!=pixels.getContext)vals=pixels.getContext("2d").getImageData(0,0,pixels.width,pixels.height).data;else if(isImageData||isPixelData)vals=pixels.data;else{if(!isImage&&!isVideo)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData or {data: Uint32Array, width: number, height: number}, but was "+pixels.constructor.name);if(null==this.fromPixels2DContext)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.fromPixels2DContext.canvas.width=pixels.width,this.fromPixels2DContext.canvas.height=pixels.height,this.fromPixels2DContext.drawImage(pixels,0,0,pixels.width,pixels.height),vals=this.fromPixels2DContext.getImageData(0,0,pixels.width,pixels.height).data}if(4===numChannels)values=new Int32Array(vals);else{var numPixels=pixels.width*pixels.height;values=new Int32Array(numPixels*numChannels);for(var i=0;i<numPixels;i++)for(var channel=0;channel<numChannels;++channel)values[i*numChannels+channel]=vals[4*i+channel]}var outShape=[pixels.height,pixels.width,numChannels];return ops_1.tensor3d(values,outShape,"int32")},MathBackendCPU.prototype.read=function(dataId){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.readSync(dataId)]})})},MathBackendCPU.prototype.readSync=function(dataId){var _a=this.data.get(dataId),dtype=_a.dtype,complexTensors=_a.complexTensors;if("complex64"!==dtype)return this.data.get(dataId).values;var realValues=this.readSync(complexTensors.real.dataId),imagValues=this.readSync(complexTensors.imag.dataId);return complex_util.mergeRealAndImagArrays(realValues,imagValues)},MathBackendCPU.prototype.bufferSync=function(t){var data=this.readSync(t.dataId),decodedData=data;if("string"===t.dtype)try{decodedData=data.map(function(d){return util.decodeString(d)})}catch(_a){throw new Error("Failed to decode encoded string bytes into utf-8")}return ops_1.buffer(t.shape,t.dtype,decodedData)},MathBackendCPU.prototype.disposeData=function(dataId){if(this.data.has(dataId)){var complexTensors=this.data.get(dataId).complexTensors;null!=complexTensors&&(complexTensors.real.dispose(),complexTensors.imag.dispose()),this.data.delete(dataId)}},MathBackendCPU.prototype.time=function(f){return __awaiter(this,void 0,void 0,function(){var start;return __generator(this,function(_a){return start=util_1.now(),f(),[2,{kernelMs:util_1.now()-start}]})})},MathBackendCPU.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},MathBackendCPU.prototype.complex=function(real,imag){var result=tensor_1.Tensor.make(real.shape,{},"complex64");return this.data.get(result.dataId).complexTensors={real:engine_1.ENGINE.keep(real.clone()),imag:engine_1.ENGINE.keep(imag.clone())},result},MathBackendCPU.prototype.real=function(input){return this.data.get(input.dataId).complexTensors.real.clone()},MathBackendCPU.prototype.imag=function(input){return this.data.get(input.dataId).complexTensors.imag.clone()},MathBackendCPU.prototype.assertNotComplex=function(tensor,opName){Array.isArray(tensor)||(tensor=[tensor]),tensor.forEach(function(t){null!=t&&util.assert("complex64"!==t.dtype,function(){return opName+" does not support complex64 tensors."})})},MathBackendCPU.prototype.slice=function(x,begin,size){if(this.assertNotComplex(x,"slice"),slice_util_1.isSliceContinous(x.shape,begin,size)){var flatOffset=slice_util_1.computeFlatOffset(begin,x.strides),length_1=util.sizeFromShape(size),vals=this.readSync(x.dataId);return ops_1.tensor(vals.subarray(flatOffset,flatOffset+length_1),size,x.dtype)}for(var buffer=ops.buffer(size,x.dtype),xBuf=this.bufferSync(x),i=0;i<buffer.size;++i){var xLoc=buffer.indexToLoc(i).map(function(idx,j){return idx+begin[j]});buffer.values[i]=xBuf.get.apply(xBuf,xLoc)}return buffer.toTensor()},MathBackendCPU.prototype.stridedSlice=function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){this.assertNotComplex(x,"stridedSlice");var _a=slice_util_1.getStridedSlicedInfo(x.shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask),beginIndex=_a[0],size=_a[1],shrinkAxis=_a[2],shape=size.filter(function(v,index){return-1===shrinkAxis.indexOf(index)});if(shape.some(function(axis){return 0===axis}))return ops.tensor([],shape);for(var buffer=ops.buffer(size,x.dtype),xBuf=this.bufferSync(x),i=0;i<buffer.size;i++){for(var loc=buffer.indexToLoc(i),newLoc=new Array(loc.length),j=0;j<newLoc.length;j++)newLoc[j]=loc[j]*strides[j]+beginIndex[j];buffer.set.apply(buffer,[xBuf.get.apply(xBuf,newLoc)].concat(loc))}return buffer.toTensor().reshape(shape)},MathBackendCPU.prototype.diag=function(x){for(var xVals=this.readSync(x.dataId),buffer=ops.buffer([x.size,x.size],x.dtype),vals=buffer.values,i=0;i<xVals.length;i++)vals[i*x.size+i]=xVals[i];return buffer.toTensor()},MathBackendCPU.prototype.unstack=function(x,axis){for(var num=x.shape[axis],outShape=new Array(x.rank-1),outIndex=0,i=0;i<x.rank;i++)i!==axis&&(outShape[outIndex++]=x.shape[i]);var begin=new Array(x.rank).fill(0),size=x.shape.slice();size[axis]=1;var res=new Array(num);for(i=0;i<res.length;i++)res[begin[axis]=i]=this.slice(x,begin,size).reshape(outShape);return res},MathBackendCPU.prototype.reverse=function(x,axis){this.assertNotComplex(x,"reverse");for(var buffer=ops.buffer(x.shape,x.dtype),xBuf=this.bufferSync(x),_loop_1=function(i){var outLoc=buffer.indexToLoc(i),inLoc=outLoc.slice();axis.forEach(function(ax){return inLoc[ax]=x.shape[ax]-1-inLoc[ax]}),buffer.set.apply(buffer,[xBuf.get.apply(xBuf,inLoc)].concat(outLoc))},i=0;i<buffer.size;i++)_loop_1(i);return buffer.toTensor()},MathBackendCPU.prototype.concat=function(tensors,axis){var _this=this;if("complex64"===tensors[0].dtype){var reals=tensors.map(function(t){return complex_ops_1.real(t)}),imags=tensors.map(function(t){return complex_ops_1.imag(t)});return complex_ops_1.complex(this.concat(reals,axis),this.concat(imags,axis))}var tensors2D=tensors.map(function(t){var innerSize=util.sizeFromShape(t.shape.slice(axis));return t.as2D(-1,innerSize)}),outShape=concat_util.computeOutShape(tensors2D.map(function(t){return t.shape}),1),values=ops.buffer(outShape,tensors[0].dtype).values;if(1===tensors2D[0].shape[0]){var offset_1=0;tensors2D.forEach(function(t){values.set(_this.readSync(t.dataId),offset_1),offset_1+=t.size})}else{var colOffset_1=0;tensors2D.forEach(function(t){for(var tVals=_this.readSync(t.dataId),tIdx=0,row=0;row<t.shape[0];++row)for(var resIdx=row*outShape[1]+colOffset_1,col=0;col<t.shape[1];++col)values[resIdx+col]=tVals[tIdx++];colOffset_1+=t.shape[1]})}var finalOutShape=concat_util.computeOutShape(tensors.map(function(t){return t.shape}),axis);return ops_1.tensor(values,finalOutShape,tensors[0].dtype)},MathBackendCPU.prototype.neg=function(x){return this.assertNotComplex(x,"neg"),this.multiply(ops.scalar(-1),x)},MathBackendCPU.prototype.add=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(aReal,aImag,bReal,bImag){return{real:aReal+bReal,imag:aImag+bImag}}):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),function(aValue,bValue){return aValue+bValue})},MathBackendCPU.prototype.addN=function(tensors){var _this=this;this.assertNotComplex(tensors,"addN");for(var vals=tensors.map(function(t){return _this.readSync(t.dataId)}),result=ops.buffer(tensors[0].shape,tensors[0].dtype),resultVals=result.values,i=0;i<tensors.length;i++)for(var currVals=vals[i],j=0;j<resultVals.length;j++)resultVals[j]+=currVals[j];return result.toTensor()},MathBackendCPU.prototype.subtract=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(aReal,aImag,bReal,bImag){return{real:aReal-bReal,imag:aImag-bImag}}):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),function(aValue,bValue){return aValue-bValue})},MathBackendCPU.prototype.pow=function(a,b){return this.assertNotComplex([a,b],"pow"),this.broadcastedBinaryOp(a,b,a.dtype,function(aValue,bValue){return Math.pow(aValue,bValue)})},MathBackendCPU.prototype.batchMatMul=function(a,b,transposeA,transposeB){this.assertNotComplex([a,b],"matMul");for(var sharedDim=transposeA?a.shape[1]:a.shape[2],leftDim=transposeA?a.shape[2]:a.shape[1],rightDim=transposeB?b.shape[1]:b.shape[2],batchDim=a.shape[0],aValues=this.readSync(a.dataId),bValues=this.readSync(b.dataId),_a=transposeA?[a.strides[0],1,a.strides[1]]:[a.strides[0],a.strides[1],1],aBatch=_a[0],aOuterStep=_a[1],aInnerStep=_a[2],_b=transposeB?[1,b.strides[1],b.strides[0]]:[b.strides[1],1,b.strides[0]],bInnerStep=_b[0],bOuterStep=_b[1],bBatch=_b[2],size=leftDim*rightDim,result=ops_1.buffer([batchDim,leftDim,rightDim],a.dtype),resVals=result.values,blockSize=this.blockSize,b_1=0;b_1<batchDim;b_1++)for(var i0=0;i0<leftDim;i0+=blockSize)for(var j0=0;j0<rightDim;j0+=blockSize)for(var k0=0;k0<sharedDim;k0+=blockSize)for(var iBlock=Math.min(i0+blockSize,leftDim),jBlock=Math.min(j0+blockSize,rightDim),kBlock=Math.min(k0+blockSize,sharedDim),i=i0;i<iBlock;i++)for(var j=j0;j<jBlock;j++){for(var sum=0,k=k0;k<kBlock;k++)sum+=aValues[b_1*aBatch+i*aOuterStep+k*aInnerStep]*bValues[k*bInnerStep+j*bOuterStep+b_1*bBatch];resVals[b_1*size+(i*rightDim+j)]+=sum}return result.toTensor()},MathBackendCPU.prototype.fusedBatchMatMul=function(_a){var a=_a.a,b=_a.b,transposeA=_a.transposeA,transposeB=_a.transposeB,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,result=this.batchMatMul(a,b,transposeA,transposeB);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.multiply=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(aReal,aImag,bReal,bImag){return{real:aReal*bReal-aImag*bImag,imag:aReal*bImag+aImag*bReal}}):this.broadcastedBinaryOp(a,b,types_1.upcastType(a.dtype,b.dtype),function(aValue,bValue){return aValue*bValue})},MathBackendCPU.prototype.realDivide=function(a,b){this.assertNotComplex([a,b],"realDivide");return this.broadcastedBinaryOp(a,b,"float32",function(a,b){return a/b})},MathBackendCPU.prototype.floorDiv=function(a,b){this.assertNotComplex([a,b],"floorDiv");return this.broadcastedBinaryOp(a,b,"int32",function(a,b){return Math.floor(a/b)})},MathBackendCPU.prototype.sum=function(x,axes){this.assertNotComplex(x,"sum"),axis_util.assertAxesAreInnerMostDims("sum",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(outShape,resultDtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,sum=0,j=0;j<reduceSize;++j)sum+=aVals[offset+j];vals[i]=sum}return result},MathBackendCPU.prototype.prod=function(x,axes){this.assertNotComplex(x,"sum");for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(outShape,resultDtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,prod=1,j=0;j<reduceSize;++j)prod*=aVals[offset+j];vals[i]=prod}return result},MathBackendCPU.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){this.assertNotComplex(x,"unsortedSegmentSum");for(var res=[],numIters=x.rank-segmentIds.rank,i=0;i<numIters;++i)segmentIds=segmentIds.expandDims(i+1);for(i=0;i<numSegments;++i){var segmentId=ops.scalar(i,"int32"),sum=ops.equal(segmentId,segmentIds).asType("float32").mul(x).sum(0);res.push(sum)}return ops.stack(res)},MathBackendCPU.prototype.argMin=function(x,axis){this.assertNotComplex(x,"argMin");var axes=[axis];axis_util.assertAxesAreInnerMostDims("argMin",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,"int32"),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,min=aVals[offset],minIndex=0,j=0;j<reduceSize;++j){var value=aVals[offset+j];value<min&&(min=value,minIndex=j)}vals[i]=minIndex}return result},MathBackendCPU.prototype.argMax=function(x,axis){this.assertNotComplex(x,"argMax");var axes=[axis];axis_util.assertAxesAreInnerMostDims("argMax",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,"int32"),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,max=aVals[offset],maxIndex=0,j=0;j<reduceSize;++j){var value=aVals[offset+j];max<value&&(max=value,maxIndex=j)}vals[i]=maxIndex}return result},MathBackendCPU.prototype.cumsum=function(x,axis,exclusive,reverse){if(this.assertNotComplex(x,"cumsum"),axis!==x.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(x.rank-1)+" but got axis="+axis);for(var resultDtype=types_1.upcastType(x.dtype,"int32"),result=ops.zeros(x.shape,resultDtype),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),finalDim=x.shape[x.rank-1],indexAdjuster=reverse?function(i,j){return i+finalDim-j-1}:function(i,j){return i+j},i=0;i<aVals.length;i+=finalDim)for(var j=0;j<finalDim;j++){var idx=indexAdjuster(i,j);if(0===j)vals[idx]=exclusive?0:aVals[idx];else{var prevIdx=indexAdjuster(i,j-1);vals[idx]=exclusive?aVals[prevIdx]+vals[prevIdx]:aVals[idx]+vals[prevIdx]}}return result},MathBackendCPU.prototype.equal=function(a,b){return this.assertNotComplex([a,b],"equal"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal===bVal?1:0})},MathBackendCPU.prototype.notEqual=function(a,b){return this.assertNotComplex([a,b],"notEqual"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal!==bVal?1:0})},MathBackendCPU.prototype.less=function(a,b){return this.assertNotComplex([a,b],"less"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal<bVal?1:0})},MathBackendCPU.prototype.lessEqual=function(a,b){return this.assertNotComplex([a,b],"lessEqual"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal<=bVal?1:0})},MathBackendCPU.prototype.greater=function(a,b){return this.assertNotComplex([a,b],"greater"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return bVal<aVal?1:0})},MathBackendCPU.prototype.greaterEqual=function(a,b){return this.assertNotComplex([a,b],"greaterEqual"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return bVal<=aVal?1:0})},MathBackendCPU.prototype.logicalNot=function(x){this.assertNotComplex(x,"logicalNot");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)newValues[i]=values[i]?0:1;return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.logicalAnd=function(a,b){return this.assertNotComplex([a,b],"logicalAnd"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal&&bVal})},MathBackendCPU.prototype.logicalOr=function(a,b){return this.assertNotComplex([a,b],"logicalOr"),this.broadcastedBinaryOp(a,b,"bool",function(aVal,bVal){return aVal||bVal})},MathBackendCPU.prototype.select=function(condition,a,b){this.assertNotComplex([condition,a,b],"select");for(var values=this.readSync(condition.dataId),aValues=this.readSync(a.dataId),bValues=this.readSync(b.dataId),result=ops.zeros(a.shape,types_1.upcastType(a.dtype,b.dtype)),newValues=this.readSync(result.dataId),index=0,offset=0===condition.rank||1<condition.rank||1===a.rank?1:a.shape[1],i=0;i<values.length;i++)for(var j=0;j<offset;j++)1===values[i]?newValues[index++]=aValues[i]:newValues[index++]=bValues[i];return result},MathBackendCPU.prototype.where=function(condition){this.assertNotComplex([condition],"where");var condVals=this.readSync(condition.dataId);return where_impl_1.whereImpl(condition.shape,condVals)},MathBackendCPU.prototype.topk=function(x,k,sorted){this.assertNotComplex(x,"topk");var xVals=this.readSync(x.dataId);return topk_impl_1.topkImpl(xVals,x.shape,x.dtype,k,sorted)},MathBackendCPU.prototype.min=function(x,axes){this.assertNotComplex(x,"min"),axis_util.assertAxesAreInnerMostDims("min",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,min=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];value<min&&(min=value)}vals[i]=min}return result},MathBackendCPU.prototype.minimum=function(a,b){return this.assertNotComplex([a,b],"minimum"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){return Math.min(aVal,bVal)})},MathBackendCPU.prototype.mod=function(a,b){return this.assertNotComplex([a,b],"mod"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){var rem=aVal%bVal;return aVal<0&&bVal<0||0<=aVal&&0<=bVal?rem:(rem+bVal)%bVal})},MathBackendCPU.prototype.max=function(x,axes){this.assertNotComplex(x,"max"),axis_util.assertAxesAreInnerMostDims("max",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,max=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];max<value&&(max=value)}vals[i]=max}return result},MathBackendCPU.prototype.maximum=function(a,b){return this.assertNotComplex([a,b],"maximum"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){return Math.max(aVal,bVal)})},MathBackendCPU.prototype.all=function(x,axes){this.assertNotComplex(x,"all"),axis_util.assertAxesAreInnerMostDims("all",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,all=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];all=all&&value}vals[i]=all}return result},MathBackendCPU.prototype.any=function(x,axes){this.assertNotComplex(x,"any"),axis_util.assertAxesAreInnerMostDims("any",axes,x.rank);for(var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],result=ops.zeros(outShape,x.dtype),reduceSize=util.sizeFromShape(reduceShape),vals=this.readSync(result.dataId),aVals=this.readSync(x.dataId),i=0;i<vals.length;++i){for(var offset=i*reduceSize,anyVal=aVals[offset],j=0;j<reduceSize;++j){var value=aVals[offset+j];anyVal=anyVal||value}vals[i]=anyVal}return result},MathBackendCPU.prototype.squaredDifference=function(a,b){return this.assertNotComplex([a,b],"squaredDifference"),this.broadcastedBinaryOp(a,b,a.dtype,function(aVal,bVal){var diff=aVal-bVal;return diff*diff})},MathBackendCPU.prototype.ceil=function(x){this.assertNotComplex(x,"ceil");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.ceil(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.floor=function(x){this.assertNotComplex(x,"floor");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.floor(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.sign=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)values[i]<0?newValues[i]=-1:0<values[i]?newValues[i]=1:newValues[i]=0;return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.isNaN=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Number.isNaN(values[i])&&(newValues[i]=1);return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.isInf=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Math.abs(values[i])===1/0&&(newValues[i]=1);return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.isFinite=function(x){this.assertNotComplex(x,"x");for(var values=this.readSync(x.dataId),newValues=new Uint8Array(values.length),i=0;i<values.length;++i)Number.isFinite(values[i])&&(newValues[i]=1);return tensor_1.Tensor.make(x.shape,{values:newValues},"bool")},MathBackendCPU.prototype.round=function(x){this.assertNotComplex(x,"round");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var base=Math.floor(values[i]);values[i]-base<.5?newValues[i]=Math.floor(values[i]):.5<values[i]-base?newValues[i]=Math.ceil(values[i]):newValues[i]=base%2==0?base:base+1}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.exp=function(x){this.assertNotComplex(x,"exp");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.exp(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.expm1=function(x){this.assertNotComplex(x,"expm1");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=Math.expm1(values[i]);return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.log=function(x){this.assertNotComplex(x,"log");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.log1p=function(x){this.assertNotComplex(x,"log1p");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.log1p(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.sqrt=function(x){this.assertNotComplex(x,"sqrt");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=Math.sqrt(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.rsqrt=function(x){this.assertNotComplex(x,"rsqrt");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=1/Math.sqrt(value)}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.square=function(x){this.assertNotComplex(x,"square");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i){var value=values[i];newValues[i]=value*value}return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.reciprocal=function(x){this.assertNotComplex(x,"reciprocal");for(var values=this.readSync(x.dataId),newValues=new Float32Array(values.length),i=0;i<values.length;++i)newValues[i]=1/values[i];return tensor_1.Tensor.make(x.shape,{values:newValues})},MathBackendCPU.prototype.linear=function(x){return x},MathBackendCPU.prototype.relu=function(x){this.assertNotComplex(x,"relu");for(var res=ops.zeros(x.shape,x.dtype),resVals=this.readSync(res.dataId),inVals=this.readSync(x.dataId),i=0;i<inVals.length;++i)resVals[i]=Math.max(0,inVals[i]);return res},MathBackendCPU.prototype.prelu=function(x,a){return this.assertNotComplex([x,a],"prelu"),this.broadcastedBinaryOp(x,a,x.dtype,function(xValue,aValue){return xValue<0?aValue*xValue:xValue})},MathBackendCPU.prototype.elu=function(x){this.assertNotComplex(x,"elu");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=0<=v?v:Math.exp(v)-1}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.eluDer=function(dy,y){this.assertNotComplex([dy,y],"eluDer");for(var resultValues=new Float32Array(y.size),values=this.readSync(y.dataId),dyValues=this.readSync(dy.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=1<=v?dyValues[i]:dyValues[i]*(v+1)}return tensor_1.Tensor.make(y.shape,{values:resultValues})},MathBackendCPU.prototype.selu=function(x){this.assertNotComplex(x,"selu");for(var scaleAlpha=selu_util.SELU_SCALEALPHA,scale=selu_util.SELU_SCALE,resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=0<=v?scale*v:scaleAlpha*(Math.exp(v)-1)}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.clip=function(x,min,max){this.assertNotComplex(x,"clip");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var v=values[i];resultValues[i]=max<v?max:v<min?min:v}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.abs=function(x){for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.abs(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.complexAbs=function(x){for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<x.size;++i){var real_1=values[2*i],imag_1=values[2*i+1];resultValues[i]=Math.hypot(real_1,imag_1)}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.int=function(x){this.assertNotComplex(x,"int");for(var resultValues=new Int32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=values[i];return tensor_1.Tensor.make(x.shape,{values:resultValues},"int32")},MathBackendCPU.prototype.sigmoid=function(x){this.assertNotComplex(x,"sigmoid");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=1/(1+Math.exp(-values[i]));return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.softplus=function(x){this.assertNotComplex(x,"softplus");for(var threshold=Math.log(1.1920928955078125e-7)+2,resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var tooLarge=values[i]>-threshold,tooSmall=values[i]<threshold,expX=Math.exp(values[i]),result=void 0;result=tooSmall?expX:tooLarge?values[i]:Math.log(1+expX),resultValues[i]=result}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.sin=function(x){this.assertNotComplex(x,"sin");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.sin(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.cos=function(x){this.assertNotComplex(x,"cos");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.cos(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.tan=function(x){this.assertNotComplex(x,"tan");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.tan(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.asin=function(x){this.assertNotComplex(x,"asin");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.asin(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.acos=function(x){this.assertNotComplex(x,"acos");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.acos(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.atan=function(x){this.assertNotComplex(x,"atan");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.atan(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.atan2=function(a,b){return this.assertNotComplex([a,b],"atan2"),this.broadcastedBinaryOp(a,b,a.dtype,function(aValue,bValue){return Math.atan2(aValue,bValue)})},MathBackendCPU.prototype.sinh=function(x){this.assertNotComplex(x,"sinh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.sinh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.cosh=function(x){this.assertNotComplex(x,"cosh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.cosh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.tanh=function(x){this.assertNotComplex(x,"tanh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=util.tanh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.asinh=function(x){this.assertNotComplex(x,"asinh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.asinh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.acosh=function(x){this.assertNotComplex(x,"acosh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.acosh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.atanh=function(x){this.assertNotComplex(x,"atanh");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i)resultValues[i]=Math.atanh(values[i]);return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.erf=function(x){this.assertNotComplex(x,"erf");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),p=erf_util.ERF_P,a1=erf_util.ERF_A1,a2=erf_util.ERF_A2,a3=erf_util.ERF_A3,a4=erf_util.ERF_A4,a5=erf_util.ERF_A5,i=0;i<values.length;++i){var v=values[i],t=1/(1+p*v);resultValues[i]=1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-v*v)}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.step=function(x,alpha){void 0===alpha&&(alpha=0),this.assertNotComplex(x,"step");for(var resultValues=new Float32Array(x.size),values=this.readSync(x.dataId),i=0;i<values.length;++i){var value=values[i];isNaN(value)?resultValues[i]=NaN:resultValues[i]=0<value?1:alpha}return tensor_1.Tensor.make(x.shape,{values:resultValues})},MathBackendCPU.prototype.fusedConv2d=function(x,filter,convInfo,bias,activation,preluActivationWeights){var result=this.conv2d(x,filter,convInfo);return bias&&(result=this.add(result,bias)),activation&&(result=mapActivation(this,result,activation,preluActivationWeights)),result},MathBackendCPU.prototype.conv2d=function(x,filter,convInfo){this.assertNotComplex([x,filter],"conv2d");for(var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,isChannelsLast="channelsLast"===convInfo.dataFormat,y=ops.buffer(convInfo.outShape,x.dtype),xBatchStride=x.strides[0],xRowStride=isChannelsLast?x.strides[1]:x.strides[2],xColStride=isChannelsLast?x.strides[2]:1,xChannelStride=isChannelsLast?1:x.strides[1],yBatchStride=y.strides[0],yRowStride=isChannelsLast?y.strides[1]:y.strides[2],yColStride=isChannelsLast?y.strides[2]:1,yChannelStride=isChannelsLast?1:y.strides[1],xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*xBatchStride,yOffset1=b*yBatchStride,yR=0;yR<convInfo.outHeight;++yR)for(var yOffset2=yOffset1+yR*yRowStride,xRCorner=yR*convInfo.strideHeight-padTop,wR=0;wR<filterHeight;wR++){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset1=wR*filter.strides[0],xOffset2=xOffset1+xR*xRowStride,yC=0;yC<convInfo.outWidth;++yC)for(var yOffset3=yOffset2+yC*yColStride,xCCorner=yC*convInfo.strideWidth-padLeft,wC=0;wC<filterWidth;wC++){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var xOffset3=xOffset2+xC*xColStride,wOffset3=wOffset1+wC*filter.strides[1],d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset3+d1*xChannelStride],d2=0;d2<convInfo.outChannels;++d2)yVals[yOffset3+d2*yChannelStride]+=xVal*wVals[wOffset3+d2];wOffset3+=convInfo.outChannels}}}return y.toTensor()},MathBackendCPU.prototype.conv3d=function(x,filter,convInfo){for(var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padFront=convInfo.padInfo.front,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,y=ops.buffer(convInfo.outShape,x.dtype),xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*x.strides[0],yOffset1=b*y.strides[0],yF=0;yF<convInfo.outDepth;++yF)for(var yOffset2=yOffset1+yF*y.strides[1],xFCorner=yF*convInfo.strideDepth-padFront,wF=0;wF<filterDepth;wF++){var xF=xFCorner+wF*dilationDepth;if(!(xF<0||xF>=convInfo.inDepth))for(var wOffset1=wF*filter.strides[0],xOffset2=xOffset1+xF*x.strides[1],yR=0;yR<convInfo.outHeight;++yR)for(var yOffset3=yOffset2+yR*y.strides[2],xRCorner=yR*convInfo.strideHeight-padTop,wR=0;wR<filterHeight;wR++){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset2=wOffset1+wR*filter.strides[1],xOffset3=xOffset2+xR*x.strides[2],yC=0;yC<convInfo.outWidth;++yC)for(var yOffset4=yOffset3+yC*convInfo.outChannels,xCCorner=yC*convInfo.strideWidth-padLeft,wC=0;wC<filterWidth;wC++){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var wOffset3=wOffset2+wC*filter.strides[2],xOffset4=xOffset3+xC*convInfo.inChannels,wOffset4=wOffset3,d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset4+d1],d2=0;d2<convInfo.outChannels;++d2)yVals[yOffset4+d2]+=xVal*wVals[wOffset4+d2];wOffset4+=convInfo.outChannels}}}}return y.toTensor()},MathBackendCPU.prototype.conv2dDerInput=function(dy,filter,convInfo){this.assertNotComplex([dy,filter],"conv2dDerInput");for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,dyValues=this.readSync(dy.dataId),fltValues=this.readSync(filter.dataId),_a=filter.strides,fltS0=_a[0],fltS1=_a[1],fltS2=_a[2],batchSize=convInfo.batchSize,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dataFormat=convInfo.dataFormat,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,isChannelsLast="channelsLast"===dataFormat,xBatchStride=dx.strides[0],xRowStride=isChannelsLast?dx.strides[1]:dx.strides[2],xColStride=isChannelsLast?dx.strides[2]:1,xChannelStride=isChannelsLast?1:dx.strides[1],yBatchStride=dy.strides[0],yRowStride=isChannelsLast?dy.strides[1]:dy.strides[2],yColStride=isChannelsLast?dy.strides[2]:1,yChannelStride=isChannelsLast?1:dy.strides[1],b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=yBatchStride*b+yRowStride*yR+yColStride*yC,fltOffset=fltS0*(filterHeight-1-wR)+fltS1*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS2*d1,d2=0;d2<outChannels;++d2){dotProd+=dyValues[dyOffset+yChannelStride*d2]*fltValues[fltOffset+d2]}dxValues[xBatchStride*b+xRowStride*xR+xColStride*xC+xChannelStride*d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.conv3dDerInput=function(dy,filter,convInfo){for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,_a=dx.strides,dxS0=_a[0],dxS1=_a[1],dxS2=_a[2],dxS3=_a[3],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],dyS3=_b[3],fltValues=this.readSync(filter.dataId),_c=filter.strides,fltS0=_c[0],fltS1=_c[1],fltS2=_c[2],fltS3=_c[3],batchSize=convInfo.batchSize,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inDepth=convInfo.inDepth,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outDepth=convInfo.outDepth,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,frontPad=filterDepth-1-convInfo.padInfo.front,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xF=0;xF<inDepth;++xF)for(var xFCorner=xF-frontPad,xFMin=Math.max(0,Math.ceil(xFCorner/strideDepth)),yFMax=Math.min(outDepth,(filterDepth+xFCorner)/strideDepth),xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yF=xFMin;yF<yFMax;++yF)for(var wF=yF*strideDepth-xFCorner,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=dyS0*b+dyS1*yF+dyS2*yR+dyS3*yC,fltOffset=fltS0*(filterDepth-1-wF)+fltS1*(filterHeight-1-wR)+fltS2*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS3*d1,d2=0;d2<outChannels;++d2){dotProd+=dyValues[dyOffset+d2]*fltValues[fltOffset+d2]}dxValues[dxS0*b+dxS1*xF+dxS2*xR+dxS3*xC+d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.conv2dDerFilter=function(x,dy,convInfo){this.assertNotComplex([x,dy],"conv2dDerFilter");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,isChannelsLast="channelsLast"===convInfo.dataFormat,dW=ops.buffer(convInfo.filterShape,"float32"),leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,xBuf=this.bufferSync(x),dyBuf=this.bufferSync(dy),wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),d1=0;d1<convInfo.inChannels;++d1)for(var d2=0;d2<convInfo.outChannels;++d2){for(var dotProd=0,b=0;b<convInfo.batchSize;++b)for(var yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=isChannelsLast?xBuf.get(b,xR,xC,d1)*dyBuf.get(b,yR,yC,d2):xBuf.get(b,d1,xR,xC)*dyBuf.get(b,d2,yR,yC)}dW.set(dotProd,wR,wC,d1,d2)}return dW.toTensor()},MathBackendCPU.prototype.conv3dDerFilter=function(x,dy,convInfo){for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dw=ops.buffer(convInfo.filterShape,"float32"),dwValues=dw.values,_a=dw.strides,dwS0=_a[0],dwS1=_a[1],dwS2=_a[2],dwS3=_a[3],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],dyS3=_b[3],xValues=this.readSync(x.dataId),_c=x.strides,xS0=_c[0],xS1=_c[1],xS2=_c[2],xS3=_c[3],frontPad=convInfo.padInfo.front,leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,wF=0;wF<filterDepth;++wF)for(var yFMin=Math.max(0,Math.ceil((frontPad-wF)/strideDepth)),yFMax=Math.min(convInfo.outDepth,(convInfo.inDepth+frontPad-wF)/strideDepth),wOffset1=wF*dwS0,wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wOffset2=wR*dwS1+wOffset1,wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),wOffset3=wC*dwS2+wOffset2,d1=0;d1<convInfo.inChannels;++d1)for(var wOffset4=d1*dwS3+wOffset3,d2=0;d2<convInfo.outChannels;++d2){for(var dotProd=0,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*xS0,yOffset1=b*dyS0,yF=yFMin;yF<yFMax;++yF)for(var xOffset2=(wF+yF*strideDepth-frontPad)*xS1+xOffset1,yOffset2=yF*dyS1+yOffset1,yR=yRMin;yR<yRMax;++yR)for(var xOffset3=(wR+yR*strideHeight-topPad)*xS2+xOffset2,yOffset3=yR*dyS2+yOffset2,yC=yCMin;yC<yCMax;++yC){var yOffset4=yC*dyS3+yOffset3;dotProd+=xValues[(wC+yC*strideWidth-leftPad)*xS3+xOffset3+d1]*dyValues[yOffset4+d2]}dwValues[wOffset4+d2]=dotProd}return dw.toTensor()},MathBackendCPU.prototype.depthwiseConv2D=function(x,filter,convInfo){this.assertNotComplex([x,filter],"depthwiseConv2D");for(var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,padLeft=convInfo.padInfo.left,padTop=convInfo.padInfo.top,chMul=convInfo.outChannels/convInfo.inChannels,y=ops.buffer(convInfo.outShape,x.dtype),xVals=this.readSync(x.dataId),wVals=this.readSync(filter.dataId),yVals=y.values,b=0;b<convInfo.batchSize;++b)for(var xOffset1=b*x.strides[0],yOffset1=b*y.strides[0],yR=0;yR<convInfo.outHeight;++yR)for(var yOffset2=yOffset1+yR*y.strides[1],xRCorner=yR*convInfo.strideHeight-padLeft,wR=0;wR<filterHeight;++wR){var xR=xRCorner+wR*dilationHeight;if(!(xR<0||xR>=convInfo.inHeight))for(var wOffset1=wR*filter.strides[0],xOffset2=xOffset1+xR*x.strides[1],yC=0;yC<convInfo.outWidth;++yC)for(var yOffset3=yOffset2+yC*y.strides[2],xCCorner=yC*convInfo.strideWidth-padTop,wC=0;wC<filterWidth;++wC){var xC=xCCorner+wC*dilationWidth;if(!(xC<0||xC>=convInfo.inWidth))for(var wOffset2=wOffset1+wC*filter.strides[1],xOffset3=xOffset2+xC*convInfo.inChannels,yOffset4=yOffset3,wOffset3=wOffset2,d1=0;d1<convInfo.inChannels;++d1){for(var xVal=xVals[xOffset3+d1],q=0;q<chMul;++q)yVals[yOffset4+q]+=xVal*wVals[wOffset3+q];yOffset4+=chMul,wOffset3+=chMul}}}return y.toTensor()},MathBackendCPU.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){this.assertNotComplex([dy,filter],"depthwiseConv2DDerInput");for(var dx=ops.buffer(convInfo.inShape,"float32"),dxValues=dx.values,_a=dx.strides,dxS0=_a[0],dxS1=_a[1],dxS2=_a[2],dyValues=this.readSync(dy.dataId),_b=dy.strides,dyS0=_b[0],dyS1=_b[1],dyS2=_b[2],fltValues=this.readSync(filter.dataId),_c=filter.strides,fltS0=_c[0],fltS1=_c[1],fltS2=_c[2],batchSize=convInfo.batchSize,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,inHeight=convInfo.inHeight,inWidth=convInfo.inWidth,outChannels=convInfo.outChannels,outHeight=convInfo.outHeight,outWidth=convInfo.outWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,topPad=filterHeight-1-convInfo.padInfo.top,leftPad=filterWidth-1-convInfo.padInfo.left,chMul=outChannels/inChannels,b=0;b<batchSize;++b)for(var d1=0;d1<inChannels;++d1)for(var xR=0;xR<inHeight;++xR)for(var xRCorner=xR-topPad,xRMin=Math.max(0,Math.ceil(xRCorner/strideHeight)),yRMax=Math.min(outHeight,(filterHeight+xRCorner)/strideHeight),xC=0;xC<inWidth;++xC){for(var xCCorner=xC-leftPad,xCMin=Math.max(0,Math.ceil(xCCorner/strideWidth)),yCMax=Math.min(outWidth,(filterWidth+xCCorner)/strideWidth),dotProd=0,yR=xRMin;yR<yRMax;++yR)for(var wR=yR*strideHeight-xRCorner,yC=xCMin;yC<yCMax;++yC)for(var dyOffset=dyS0*b+dyS1*yR+dyS2*yC,fltOffset=fltS0*(filterHeight-1-wR)+fltS1*(filterWidth-1-(yC*strideWidth-xCCorner))+fltS2*d1,dm=0;dm<chMul;++dm){dotProd+=dyValues[dyOffset+(d1*chMul+dm)]*fltValues[fltOffset+dm]}dxValues[dxS0*b+dxS1*xR+dxS2*xC+d1]=dotProd}return dx.toTensor()},MathBackendCPU.prototype.depthwiseConv2DDerFilter=function(x,dy,convInfo){this.assertNotComplex([x,dy],"depthwiseConv2DDerFilter");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dW=ops.buffer(convInfo.filterShape,"float32"),leftPad=convInfo.padInfo.left,topPad=convInfo.padInfo.top,chMul=convInfo.outChannels/convInfo.inChannels,xBuf=this.bufferSync(x),dyBuf=this.bufferSync(dy),wR=0;wR<filterHeight;++wR)for(var yRMin=Math.max(0,Math.ceil((topPad-wR)/strideHeight)),yRMax=Math.min(convInfo.outHeight,(convInfo.inHeight+topPad-wR)/strideHeight),wC=0;wC<filterWidth;++wC)for(var yCMin=Math.max(0,Math.ceil((leftPad-wC)/strideWidth)),yCMax=Math.min(convInfo.outWidth,(convInfo.inWidth+leftPad-wC)/strideWidth),d2=0;d2<convInfo.outChannels;++d2){for(var d1=Math.trunc(d2/chMul),dm=d2%chMul,dotProd=0,b=0;b<convInfo.batchSize;++b)for(var yR=yRMin;yR<yRMax;++yR)for(var xR=wR+yR*strideHeight-topPad,yC=yCMin;yC<yCMax;++yC){var xC=wC+yC*strideWidth-leftPad;dotProd+=xBuf.get(b,xR,xC,d1)*dyBuf.get(b,yR,yC,d2)}dW.set(dotProd,wR,wC,d1,dm)}return dW.toTensor()},MathBackendCPU.prototype.tile=function(x,reps){return this.assertNotComplex(x,"tile"),tile_impl_1.tile(this.bufferSync(x),reps)},MathBackendCPU.prototype.pad=function(x,paddings,constantValue){this.assertNotComplex(x,"pad");var outShape=paddings.map(function(p,i){return p[0]+x.shape[i]+p[1]}),start=paddings.map(function(p){return p[0]}),xBuffer=this.bufferSync(x),buffer=ops.buffer(outShape,x.dtype);0!==constantValue&&buffer.values.fill(constantValue);for(var i=0;i<x.size;i++){var coords=xBuffer.indexToLoc(i),outCoords=coords.map(function(c,i){return c+start[i]});buffer.set.apply(buffer,[xBuffer.get.apply(xBuffer,coords)].concat(outCoords))}return buffer.toTensor()},MathBackendCPU.prototype.transpose=function(x,perm){this.assertNotComplex(x,"transpose");for(var newShape=new Array(x.rank),i=0;i<newShape.length;i++)newShape[i]=x.shape[perm[i]];var values=this.readSync(x.dataId),result=ops_1.buffer(newShape,x.dtype),xBuf=this.bufferSync(x);for(i=0;i<x.size;++i){for(var loc=xBuf.indexToLoc(i),newLoc=new Array(loc.length),i_1=0;i_1<newLoc.length;i_1++)newLoc[i_1]=loc[perm[i_1]];var newIndex=result.locToIndex(newLoc);result.values[newIndex]=values[i]}return result.toTensor()},MathBackendCPU.prototype.gather=function(x,indices,axis){this.assertNotComplex([x,indices],"gather");var newShape=x.shape.slice(),indicesValues=this.readSync(indices.dataId);newShape[axis]=indicesValues.length;for(var result=ops_1.buffer(newShape,x.dtype),xBuf=this.bufferSync(x),i=0;i<result.size;++i){var newLoc=result.indexToLoc(i),originalLoc=newLoc.slice();originalLoc[axis]=indicesValues[newLoc[axis]];var originalIndex=xBuf.locToIndex(originalLoc);result.values[i]=xBuf.values[originalIndex]}return result.toTensor()},MathBackendCPU.prototype.batchToSpaceND=function(x,blockShape,crops){this.assertNotComplex([x],"batchToSpaceND");var prod=blockShape.reduce(function(a,b){return a*b}),reshaped=array_ops_util.getReshaped(x.shape,blockShape,prod),permuted=array_ops_util.getPermuted(reshaped.length,blockShape.length),reshapedPermuted=array_ops_util.getReshapedPermuted(x.shape,blockShape,prod),sliceBeginCoords=array_ops_util.getSliceBeginCoords(crops,blockShape.length),sliceSize=array_ops_util.getSliceSize(reshapedPermuted,crops,blockShape.length);return x.reshape(reshaped).transpose(permuted).reshape(reshapedPermuted).slice(sliceBeginCoords,sliceSize)},MathBackendCPU.prototype.spaceToBatchND=function(x,blockShape,paddings){this.assertNotComplex([x],"spaceToBatchND");var prod=blockShape.reduce(function(a,b){return a*b}),completePaddings=[[0,0]];completePaddings.push.apply(completePaddings,paddings);for(var i=1+blockShape.length;i<x.shape.length;++i)completePaddings.push([0,0]);var paddedX=x.pad(completePaddings),reshapedPaddedShape=array_ops_util.getReshaped(paddedX.shape,blockShape,prod,!1),permutedReshapedPaddedPermutation=array_ops_util.getPermuted(reshapedPaddedShape.length,blockShape.length,!1),flattenShape=array_ops_util.getReshapedPermuted(paddedX.shape,blockShape,prod,!1);return paddedX.reshape(reshapedPaddedShape).transpose(permutedReshapedPaddedPermutation).reshape(flattenShape)},MathBackendCPU.prototype.pool=function(x,convInfo,poolType){this.assertNotComplex(x,"pool");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,initialValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,xValues=this.readSync(x.dataId),output=ops.buffer(convInfo.outShape,x.dtype),outputVals=output.values,outputBatchStrides=convInfo.outShape[1]*convInfo.outShape[2]*convInfo.outShape[3],outputRowStrides=convInfo.outShape[2]*convInfo.outShape[3],outputColStrides=convInfo.outShape[3],b=0;b<convInfo.batchSize;++b)for(var outputBatchOffset=b*outputBatchStrides,inputBatchOffset=b*x.strides[0],d=0;d<convInfo.inChannels;++d)for(var yR=0;yR<convInfo.outHeight;++yR)for(var xRCorner=yR*strideHeight-padTop,xRMin=Math.max(0,xRCorner),xRMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRCorner),outputRowOffset=outputBatchOffset+yR*outputRowStrides,yC=0;yC<convInfo.outWidth;++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=Math.max(0,xCCorner),xCMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xCCorner),minMaxValue=initialValue,avgValue=0,count=0,xR=xRMin;xR<xRMax;xR+=dilationHeight){for(var xROffset=inputBatchOffset+xR*x.strides[1],xC=xCMin;xC<xCMax;xC+=dilationWidth){var pixel=xValues[xROffset+xC*x.strides[2]+d];"max"===poolType&&minMaxValue<pixel?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel,count++)}if(isNaN(minMaxValue))break}outputVals[outputRowOffset+yC*outputColStrides+d]="avg"===poolType?avgValue/count:minMaxValue}return output.toTensor()},MathBackendCPU.prototype.maxPool=function(x,convInfo){return this.pool(x,convInfo,"max")},MathBackendCPU.prototype.maxPoolPositions=function(x,convInfo){for(var maxPositions=ops.buffer(convInfo.outShape,"int32"),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,xBuf=this.bufferSync(x),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var yR=0;yR<convInfo.outHeight;++yR){for(var xRCorner=yR*strideHeight-padTop,xRMin=xRCorner;xRMin<0;)xRMin+=dilationHeight;for(var xRMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRCorner),yC=0;yC<convInfo.outWidth;++yC){for(var xCCorner=yC*strideWidth-padLeft,xCMin=xCCorner;xCMin<0;)xCMin+=dilationWidth;for(var xCMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xCCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xR=xRMin;xR<xRMax;xR+=dilationHeight)for(var wR=xR-xRCorner,xC=xCMin;xC<xCMax;xC+=dilationWidth){var wC=xC-xCCorner,pixel=xBuf.get(b,xR,xC,d);maxValue<pixel&&(maxValue=pixel,maxPosition=wR*effectiveFilterWidth+wC)}maxPositions.set(maxPosition,b,yR,yC,d)}}return maxPositions.toTensor()},MathBackendCPU.prototype.maxPoolBackprop=function(dy,x,y,convInfo){this.assertNotComplex([x,y],"maxPoolBackprop");for(var maxPositions=this.maxPoolPositions(x,convInfo),strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),maxPosBuf=this.bufferSync(maxPositions),dyBuf=this.bufferSync(dy),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var dxR=0;dxR<convInfo.inHeight;++dxR)for(var dxC=0;dxC<convInfo.inWidth;++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<effectiveFilterHeight;wR+=dilationHeight){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=convInfo.outHeight||Math.floor(dyR)!==dyR))for(var wC=0;wC<effectiveFilterWidth;wC+=dilationWidth){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=convInfo.outWidth||Math.floor(dyC)!==dyC)){var mask=effectiveFilterHeight*effectiveFilterWidth-1-maxPosBuf.get(b,dyR,dyC,d)===wR*effectiveFilterWidth+wC?1:0;if(0!=mask)dotProd+=dyBuf.get(b,dyR,dyC,d)*mask}}}dx.set(dotProd,b,dxR,dxC,d)}return dx.toTensor()},MathBackendCPU.prototype.avgPoolBackprop=function(dy,x,convInfo){this.assertNotComplex([dy,x],"avgPoolBackprop");for(var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),avgMultiplier=1/(filterHeight*filterWidth),dyBuf=this.bufferSync(dy),b=0;b<convInfo.batchSize;++b)for(var d=0;d<convInfo.inChannels;++d)for(var dxR=0;dxR<convInfo.inHeight;++dxR)for(var dxC=0;dxC<convInfo.inWidth;++dxC){for(var dyRCorner=dxR-padTop,dyCCorner=dxC-padLeft,dotProd=0,wR=0;wR<effectiveFilterHeight;wR+=dilationHeight){var dyR=(dyRCorner+wR)/strideHeight;if(!(dyR<0||dyR>=convInfo.outHeight||Math.floor(dyR)!==dyR))for(var wC=0;wC<effectiveFilterWidth;wC+=dilationWidth){var dyC=(dyCCorner+wC)/strideWidth;if(!(dyC<0||dyC>=convInfo.outWidth||Math.floor(dyC)!==dyC))dotProd+=dyBuf.get(b,dyR,dyC,d)}}dx.set(dotProd*avgMultiplier,b,dxR,dxC,d)}return dx.toTensor()},MathBackendCPU.prototype.pool3d=function(x,convInfo,poolType){this.assertNotComplex(x,"pool3d");for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,initialValue="max"===poolType?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,xValues=this.readSync(x.dataId),output=ops.buffer(convInfo.outShape,x.dtype),outputVals=output.values,outputBatchStrides=convInfo.outShape[1]*convInfo.outShape[2]*convInfo.outShape[3]*convInfo.outShape[4],outputDepthStrides=convInfo.outShape[2]*convInfo.outShape[3]*convInfo.outShape[4],outputRowStrides=convInfo.outShape[3]*convInfo.outShape[4],outputColStrides=convInfo.outShape[4],batch=0;batch<convInfo.batchSize;++batch)for(var outputBatchOffset=batch*outputBatchStrides,inputBatchOffset=batch*x.strides[0],channel=0;channel<convInfo.inChannels;++channel)for(var yDepth=0;yDepth<convInfo.outDepth;++yDepth){for(var xDepthCorner=yDepth*strideDepth-padFront,xDepthMin=xDepthCorner;xDepthMin<0;)xDepthMin+=dilationDepth;for(var xDepthMax=Math.min(convInfo.inDepth,effectiveFilterDepth+xDepthCorner),outputDepthOffset=outputBatchOffset+yDepth*outputDepthStrides,yRow=0;yRow<convInfo.outHeight;++yRow){for(var xRowCorner=yRow*strideHeight-padTop,xRowMin=xRowCorner;xRowMin<0;)xRowMin+=dilationHeight;for(var xRowMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRowCorner),outputRowOffset=outputDepthOffset+yRow*outputRowStrides,yCol=0;yCol<convInfo.outWidth;++yCol){for(var xColCorner=yCol*strideWidth-padLeft,xColMin=xColCorner;xColMin<0;)xColMin+=dilationWidth;for(var xColMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xColCorner),outputColOffset=outputRowOffset+yCol*outputColStrides,minMaxValue=initialValue,avgValue=0,count=0,xDepth=xDepthMin;xDepth<xDepthMax;xDepth+=dilationDepth){for(var xDepthOffset=inputBatchOffset+xDepth*x.strides[1],xRow=xRowMin;xRow<xRowMax;xRow+=dilationHeight){for(var xRowOffset=xDepthOffset+xRow*x.strides[2],xCol=xColMin;xCol<xColMax;xCol+=dilationWidth){var pixel=xValues[xRowOffset+xCol*x.strides[3]+channel];if("max"===poolType&&minMaxValue<pixel?minMaxValue=pixel:"avg"===poolType&&(avgValue+=pixel,count++),isNaN(minMaxValue))break}if(isNaN(minMaxValue))break}if(isNaN(minMaxValue))break}outputVals[outputColOffset+channel]="avg"===poolType?avgValue/count:minMaxValue}}}return output.toTensor()},MathBackendCPU.prototype.avgPool3d=function(x,convInfo){return this.assertNotComplex(x,"avgPool3d"),this.pool3d(x,convInfo,"avg").toFloat()},MathBackendCPU.prototype.avgPool3dBackprop=function(dy,x,convInfo){this.assertNotComplex([dy,x],"avgPool3dBackprop");for(var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),avgMultiplier=1/(filterDepth*filterHeight*filterWidth),dyBuf=this.bufferSync(dy),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var dxDepth=0;dxDepth<convInfo.inDepth;++dxDepth)for(var dxRow=0;dxRow<convInfo.inHeight;++dxRow)for(var dxCol=0;dxCol<convInfo.inWidth;++dxCol){for(var dyDepthCorner=dxDepth-padFront,dyRowCorner=dxRow-padTop,dyColCorner=dxCol-padLeft,dotProd=0,wDepth=0;wDepth<effectiveFilterDepth;wDepth+=dilationDepth){var dyDepth=(dyDepthCorner+wDepth)/strideDepth;if(!(dyDepth<0||dyDepth>=convInfo.outDepth||Math.floor(dyDepth)!==dyDepth))for(var wRow=0;wRow<effectiveFilterHeight;wRow+=dilationHeight){var dyRow=(dyRowCorner+wRow)/strideHeight;if(!(dyRow<0||dyRow>=convInfo.outHeight||Math.floor(dyRow)!==dyRow))for(var wCol=0;wCol<effectiveFilterWidth;wCol+=dilationWidth){var dyCol=(dyColCorner+wCol)/strideWidth;if(!(dyCol<0||dyCol>=convInfo.outWidth||Math.floor(dyCol)!==dyCol))dotProd+=dyBuf.get(batch,dyDepth,dyRow,dyCol,channel)}}}dx.set(dotProd*avgMultiplier,batch,dxDepth,dxRow,dxCol,channel)}return dx.toTensor()},MathBackendCPU.prototype.maxPool3d=function(x,convInfo){return this.assertNotComplex(x,"maxPool3d"),this.pool3d(x,convInfo,"max").toFloat()},MathBackendCPU.prototype.maxPool3dPositions=function(x,convInfo){for(var maxPositions=ops.buffer(convInfo.outShape,"int32"),strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,xBuf=this.bufferSync(x),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var yDepth=0;yDepth<convInfo.outDepth;++yDepth){for(var xDepthCorner=yDepth*strideDepth-padFront,xDepthMin=xDepthCorner;xDepthMin<0;)xDepthMin+=dilationDepth;for(var xDepthMax=Math.min(convInfo.inDepth,effectiveFilterDepth+xDepthCorner),yRow=0;yRow<convInfo.outHeight;++yRow){for(var xRowCorner=yRow*strideHeight-padTop,xRowMin=xRowCorner;xRowMin<0;)xRowMin+=dilationHeight;for(var xRowMax=Math.min(convInfo.inHeight,effectiveFilterHeight+xRowCorner),yCol=0;yCol<convInfo.outWidth;++yCol){for(var xColCorner=yCol*strideWidth-padLeft,xColMin=xColCorner;xColMin<0;)xColMin+=dilationWidth;for(var xColMax=Math.min(convInfo.inWidth,effectiveFilterWidth+xColCorner),maxValue=Number.NEGATIVE_INFINITY,maxPosition=-1,xDepth=xDepthMin;xDepth<xDepthMax;xDepth+=dilationDepth)for(var wDepth=xDepth-xDepthCorner,xRow=xRowMin;xRow<xRowMax;xRow+=dilationHeight)for(var wRow=xRow-xRowCorner,xCol=xColMin;xCol<xColMax;xCol+=dilationWidth){var wCol=xCol-xColCorner,pixel=xBuf.get(batch,xDepth,xRow,xCol,channel);maxValue<=pixel&&(maxValue=pixel,maxPosition=wDepth*effectiveFilterHeight*effectiveFilterWidth+wRow*effectiveFilterHeight+wCol)}maxPositions.set(maxPosition,batch,yDepth,yRow,yCol,channel)}}}return maxPositions.toTensor()},MathBackendCPU.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){this.assertNotComplex([x,y],"maxPool3dBackprop");for(var maxPositions=this.maxPool3dPositions(x,convInfo),strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,dx=ops.buffer(x.shape,"float32"),maxPosBuf=this.bufferSync(maxPositions),dyBuf=this.bufferSync(dy),batch=0;batch<convInfo.batchSize;++batch)for(var channel=0;channel<convInfo.inChannels;++channel)for(var dxDepth=0;dxDepth<convInfo.inDepth;++dxDepth)for(var dxRow=0;dxRow<convInfo.inHeight;++dxRow)for(var dxCol=0;dxCol<convInfo.inWidth;++dxCol){for(var dyDepthCorner=dxDepth-padFront,dyRowCorner=dxRow-padTop,dyColCorner=dxCol-padLeft,dotProd=0,wDepth=0;wDepth<effectiveFilterDepth;wDepth+=dilationDepth){var dyDepth=(dyDepthCorner+wDepth)/strideDepth;if(!(dyDepth<0||dyDepth>=convInfo.outDepth||Math.floor(dyDepth)!==dyDepth))for(var wRow=0;wRow<effectiveFilterHeight;wRow+=dilationHeight){var dyRow=(dyRowCorner+wRow)/strideHeight;if(!(dyRow<0||dyRow>=convInfo.outHeight||Math.floor(dyRow)!==dyRow))for(var wCol=0;wCol<effectiveFilterWidth;wCol+=dilationWidth){var dyCol=(dyColCorner+wCol)/strideWidth;if(!(dyCol<0||dyCol>=convInfo.outWidth||Math.floor(dyCol)!==dyCol)){var mask=effectiveFilterDepth*effectiveFilterHeight*effectiveFilterWidth-1-maxPosBuf.get(batch,dyDepth,dyRow,dyCol,channel)===wDepth*effectiveFilterHeight*effectiveFilterWidth+wRow*effectiveFilterWidth+wCol?1:0;if(0!=mask)dotProd+=dyBuf.get(batch,dyDepth,dyRow,dyCol,channel)*mask}}}}dx.set(dotProd,batch,dxDepth,dxRow,dxCol,channel)}return dx.toTensor()},MathBackendCPU.prototype.cast=function(x,dtype){return backend_util.castTensor(x,dtype,this)},MathBackendCPU.prototype.reshape=function(x,shape){return backend_util.reshapeTensor(x,shape)},MathBackendCPU.prototype.avgPool=function(x,convInfo){return this.assertNotComplex(x,"avgPool"),this.pool(x,convInfo,"avg").toFloat()},MathBackendCPU.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){this.assertNotComplex(x,"resizeBilinear");for(var _a=x.shape,batch=_a[0],oldHeight=_a[1],oldWidth=_a[2],numChannels=_a[3],xValues=this.readSync(x.dataId),result=new Float32Array(util.sizeFromShape([batch,newHeight,newWidth,numChannels])),effectiveInputSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutputSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth],outputIdx=0,effectiveRowSizeRatio=effectiveInputSize[0]/effectiveOutputSize[0],effectiveColSizeRatio=effectiveInputSize[1]/effectiveOutputSize[1],b=0;b<batch;b++)for(var r=0;r<newHeight;r++)for(var sourceFracRow=effectiveRowSizeRatio*r,sourceRowFloor=Math.floor(sourceFracRow),rowFrac=sourceFracRow-sourceRowFloor,sourceRowCeil=Math.min(oldHeight-1,Math.ceil(sourceFracRow)),topRowOffset=b*x.strides[0]+sourceRowFloor*x.strides[1],botRowOffset=b*x.strides[0]+sourceRowCeil*x.strides[1],c=0;c<newWidth;c++)for(var sourceFracCol=effectiveColSizeRatio*c,sourceColFloor=Math.floor(sourceFracCol),colFrac=sourceFracCol-sourceColFloor,sourceColCeil=Math.min(oldWidth-1,Math.ceil(sourceFracCol)),topLeftOffest=topRowOffset+sourceColFloor*x.strides[2],botLeftOffset=botRowOffset+sourceColFloor*x.strides[2],topRightOffset=topRowOffset+ +sourceColCeil*x.strides[2],botRightOffest=botRowOffset+sourceColCeil*x.strides[2],d=0;d<numChannels;d++){var topLeft=xValues[topLeftOffest+d],bottomLeft=xValues[botLeftOffset+d],top_1=topLeft+(xValues[topRightOffset+d]-topLeft)*colFrac,newValue=top_1+(bottomLeft+(xValues[botRightOffest+d]-bottomLeft)*colFrac-top_1)*rowFrac;result[outputIdx++]=newValue}return ops.tensor(result,[batch,newHeight,newWidth,numChannels])},MathBackendCPU.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){this.assertNotComplex([dy,x],"resizeBilinearBackprop");for(var _a=x.shape,batch=_a[0],xHeight=_a[1],xWidth=_a[2],depth=_a[3],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],output=new Float32Array(batch*xHeight*xWidth*depth),effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],dyValues=this.readSync(dy.dataId),offset=0,b=0;b<batch;b++)for(var bOffset=b*x.strides[0],r=0;r<yHeight;r++)for(var dxR=r*heightScale,topDxRIndex=Math.floor(dxR),bottomDxRIndex=Math.min(Math.ceil(dxR),xHeight-1),topDxROffset=bOffset+topDxRIndex*x.strides[1],bottomDxROffset=bOffset+bottomDxRIndex*x.strides[1],dxRLerp=dxR-topDxRIndex,inverseDxRLerp=1-dxRLerp,c=0;c<yWidth;c++)for(var dxC=c*widthScale,leftDxCIndex=Math.floor(dxC),rightDxCIndex=Math.min(Math.ceil(dxC),xWidth-1),dxCLerp=dxC-leftDxCIndex,inverseDxCLerp=1-dxCLerp,topLeftRCOffset=topDxROffset+leftDxCIndex*x.strides[2],topRightRCOffset=topDxROffset+rightDxCIndex*x.strides[2],bottomLeftRCOffset=bottomDxROffset+leftDxCIndex*x.strides[2],bottomRightRCOffset=bottomDxROffset+rightDxCIndex*x.strides[2],inverseDxRLerpTimesInverseDxCLerp=inverseDxRLerp*inverseDxCLerp,inverseDxRLerpTimesDxCLerp=inverseDxRLerp*dxCLerp,dxRLerpTimesInverseDxCLerp=dxRLerp*inverseDxCLerp,dxRLerpTimesDxCLerp=dxRLerp*dxCLerp,d=0;d<depth;d++){var dyVal=dyValues[offset++];output[topLeftRCOffset+d]+=dyVal*inverseDxRLerpTimesInverseDxCLerp,output[topRightRCOffset+d]+=dyVal*inverseDxRLerpTimesDxCLerp,output[bottomLeftRCOffset+d]+=dyVal*dxRLerpTimesInverseDxCLerp,output[bottomRightRCOffset+d]+=dyVal*dxRLerpTimesDxCLerp}return ops.tensor4d(output,[batch,xWidth,xHeight,depth],x.dtype)},MathBackendCPU.prototype.resizeNearestNeighbor=function(x,newHeight,newWidth,alignCorners){this.assertNotComplex(x,"resizeNearestNeighbor");for(var _a=x.shape,batch=_a[0],oldHeight=_a[1],oldWidth=_a[2],numChannels=_a[3],xValues=this.readSync(x.dataId),output=new Float32Array(batch*newHeight*newWidth*numChannels),effectiveInputSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutputSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth],effectiveRowSizeRatio=effectiveInputSize[0]/effectiveOutputSize[0],effectiveColSizeRatio=effectiveInputSize[1]/effectiveOutputSize[1],outputOffset=0,b=0;b<batch;b++)for(var batchOffset=b*x.strides[0],r=0;r<newHeight;r++)for(var sourceFracRow=effectiveRowSizeRatio*r,rowOffset=batchOffset+Math.min(oldHeight-1,alignCorners?Math.round(sourceFracRow):Math.floor(sourceFracRow))*x.strides[1],c=0;c<newWidth;c++)for(var sourceFracCol=effectiveColSizeRatio*c,colOffset=rowOffset+Math.min(oldWidth-1,alignCorners?Math.round(sourceFracCol):Math.floor(sourceFracCol))*x.strides[2],d=0;d<numChannels;d++){var newVal=xValues[colOffset+d];output[outputOffset++]=newVal}return ops.tensor(output,[batch,newHeight,newWidth,numChannels],x.dtype)},MathBackendCPU.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){this.assertNotComplex([dy,x],"resizeNearestNeighborBackprop");for(var _a=x.shape,batch=_a[0],xHeight=_a[1],xWidth=_a[2],depth=_a[3],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],output=new Float32Array(batch*xHeight*xWidth*depth),dyValues=this.readSync(dy.dataId),effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2,b=0;b<batch;b++)for(var batchOffset=b*x.strides[0],r=0;r<xHeight;r++)for(var rowOffset=batchOffset+r*x.strides[1],startRLerp=Math.floor(r*invHeightScale),startDyR=Math.floor(startRLerp-winHeight/2),c=0;c<xWidth;c++)for(var colOffset=rowOffset+c*x.strides[2],startCLerp=Math.floor(c*invWidthScale),startDyC=Math.floor(startCLerp-winWidth/2),d=0;d<depth;d++){for(var accum=0,dyRIndex=0;dyRIndex<winHeight;dyRIndex++){var dyR=dyRIndex+startDyR;if(!(dyR<0||yHeight<=dyR)){var dyROffset=batchOffset+dyR*dy.strides[1],sourceFracRow=dyR*heightScale;if(r===Math.min(xHeight-1,alignCorners?Math.round(sourceFracRow):Math.floor(sourceFracRow)))for(var dyCIndex=0;dyCIndex<winWidth;dyCIndex++){var dyC=dyCIndex+startDyC;if(!(dyC<0||yWidth<=dyC)){var dyCOffset=dyROffset+dyC*dy.strides[2],sourceFracCol=dyC*widthScale;c===Math.min(xWidth-1,alignCorners?Math.round(sourceFracCol):Math.floor(sourceFracCol))&&(accum+=dyValues[dyCOffset+d])}}}}output[colOffset+d]=accum}return ops.tensor4d(output,x.shape,x.dtype)},MathBackendCPU.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){this.assertNotComplex([x,mean,variance,scale,offset],"batchNorm");for(var xVals=this.readSync(x.dataId),mVals=this.readSync(mean.dataId),varVals=this.readSync(variance.dataId),sVals=scale?this.readSync(scale.dataId):new Float32Array([1]),offVals=offset?this.readSync(offset.dataId):new Float32Array([0]),outVals=new Float32Array(xVals.length),offValsLength=offVals.length,sValsLength=sVals.length,varValsLength=varVals.length,mValsLength=mVals.length,offi=0,mi=0,si=0,vi=0,i=0;i<xVals.length;++i)outVals[i]=offVals[offi++]+(xVals[i]-mVals[mi++])*sVals[si++]/Math.sqrt(varVals[vi++]+varianceEpsilon),offValsLength<=offi&&(offi=0),mValsLength<=mi&&(mi=0),sValsLength<=si&&(si=0),varValsLength<=vi&&(vi=0);return ops_1.tensor4d(outVals,x.shape)},MathBackendCPU.prototype.localResponseNormalization4D=function(x,depthRadius,bias,alpha,beta){this.assertNotComplex(x,"localResponseNormalization4D");var channels=x.shape[3],maxD=channels-1,xValues=this.readSync(x.dataId),size=x.size,result=new Float32Array(size);function sumAcrossChannels(offset){for(var currentChannel=offset%channels,beginSumOffset=offset-currentChannel+Math.max(0,currentChannel-depthRadius),endSumOffset=offset-currentChannel+Math.min(currentChannel+depthRadius,maxD),sum=0;beginSumOffset<=endSumOffset;beginSumOffset++){var z=xValues[beginSumOffset];sum+=z*z}return sum}for(var offset=0;offset<size;offset++){var sum=sumAcrossChannels(offset),val=xValues[offset]*Math.pow(bias+alpha*sum,-beta);result[offset]=val}return ops.tensor4d(result,x.shape)},MathBackendCPU.prototype.LRNGrad=function(dy,inputImage,outputImage,depthRadius,bias,alpha,beta){this.assertNotComplex(dy,"LRNGrad");for(var channels=dy.shape[3],dyValues=this.readSync(dy.dataId),inputImageValues=this.readSync(inputImage.dataId),outputImageValues=this.readSync(outputImage.dataId),result=new Float32Array(dy.size),size=dy.size,offset=0;offset<size;offset++){for(var currentChannel=offset%channels,depthBegin=offset-currentChannel+Math.max(0,currentChannel-depthRadius),depthEnd=offset-currentChannel+Math.min(channels,currentChannel+depthRadius+1),norm=0,k=depthBegin;k<depthEnd;k++)norm+=Math.pow(inputImageValues[k],2);norm=alpha*norm+bias;for(k=depthBegin;k<depthEnd;k++){var dyi=-2*alpha*beta*inputImageValues[k]*outputImageValues[offset]/norm;offset===k&&(dyi+=Math.pow(norm,-beta)),dyi*=dyValues[offset],result[k]+=dyi}}return ops.tensor4d(result,dy.shape)},MathBackendCPU.prototype.multinomial=function(logits,normalized,numSamples,seed){this.assertNotComplex(logits,"multinomial");for(var probabilities=normalized?logits:ops.softmax(logits),batchSize=probabilities.shape[0],numEvents=probabilities.shape[1],res=ops.zeros([batchSize,numSamples],"int32"),resVals=this.readSync(res.dataId),probVals=this.readSync(probabilities.dataId),b=0;b<batchSize;++b){var offset=b*numEvents,cdf=new Float32Array(numEvents-1);cdf[0]=probVals[offset];for(var event_1=1;event_1<cdf.length;++event_1)cdf[event_1]=cdf[event_1-1]+probVals[offset+event_1];for(var random=seedrandom.alea(seed.toString()),outOffset=b*numSamples,sampleId=0;sampleId<numSamples;++sampleId){var r=random();resVals[outOffset+sampleId]=cdf.length;for(var event_2=0;event_2<cdf.length;event_2++)if(r<cdf[event_2]){resVals[outOffset+sampleId]=event_2;break}}}return res},MathBackendCPU.prototype.oneHot=function(indices,depth,onValue,offValue){this.assertNotComplex(indices,"oneHot");var res=new Float32Array(indices.size*depth);res.fill(offValue);for(var indicesVal=this.readSync(indices.dataId),event_3=0;event_3<indices.size;++event_3)0<=indicesVal[event_3]&&indicesVal[event_3]<depth&&(res[event_3*depth+indicesVal[event_3]]=onValue);return ops.tensor2d(res,[indices.size,depth],"int32")},MathBackendCPU.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){this.assertNotComplex(boxes,"nonMaxSuppression");var boxesVals=this.readSync(boxes.dataId),scoresVals=this.readSync(scores.dataId);return non_max_suppression_impl_1.nonMaxSuppressionImpl(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold)},MathBackendCPU.prototype.fft=function(x){return this.fftBatch(x,!1)},MathBackendCPU.prototype.ifft=function(x){return this.fftBatch(x,!0)},MathBackendCPU.prototype.fftBatch=function(x,inverse){for(var batch=x.shape[0],innerDim=x.shape[1],realResult=ops.buffer(x.shape,"float32"),imagResult=ops.buffer(x.shape,"float32"),real=ops.real(x).as2D(batch,innerDim),imag=ops.imag(x).as2D(batch,innerDim),b=0;b<batch;b++)for(var r=real.slice([b,0],[1,innerDim]),i=imag.slice([b,0],[1,innerDim]),input=ops.complex(r,i),res=this.readSync(this.fftImpl(input,inverse).dataId),d=0;d<innerDim;d++){var c=complex_util.getComplexWithIndex(res,d);realResult.values[b*innerDim+d]=c.real,imagResult.values[b*innerDim+d]=c.imag}return ops.complex(realResult.toTensor(),imagResult.toTensor()).as2D(batch,innerDim)},MathBackendCPU.prototype.fftImpl=function(x,inverse){var x1D=x.as1D(),n=x1D.size;if(this.isExponentOf2(n)){var result=this.fftRadix2(x1D,n,inverse).as2D(x.shape[0],x.shape[1]);return inverse&&(result=ops.complex(ops.real(result).div(ops_1.scalar(n)),ops.imag(result).div(ops_1.scalar(n)))),result}var data=this.readSync(x.dataId),rawOutput=this.fourierTransformByMatmul(data,n,inverse),output=complex_util.splitRealAndImagArrays(rawOutput);return ops.complex(output.real,output.imag).as2D(x.shape[0],x.shape[1])},MathBackendCPU.prototype.isExponentOf2=function(size){return 0==(size&size-1)},MathBackendCPU.prototype.fftRadix2=function(input,size,inverse){if(1===size)return input;var data=this.readSync(input.dataId),half=size/2,evenComplex=complex_util.complexWithEvenIndex(data),evenTensor=ops.complex(evenComplex.real,evenComplex.imag).as1D(),oddComplex=complex_util.complexWithOddIndex(data),oddTensor=ops.complex(oddComplex.real,oddComplex.imag).as1D();evenTensor=this.fftRadix2(evenTensor,half,inverse),oddTensor=this.fftRadix2(oddTensor,half,inverse);var e=complex_util.exponents(size,inverse),exponent=ops.complex(e.real,e.imag).mul(oddTensor),addPart=evenTensor.add(exponent),subPart=evenTensor.sub(exponent),realTensor=ops.real(addPart).concat(ops.real(subPart)),imagTensor=ops.imag(addPart).concat(ops.imag(subPart));return ops.complex(realTensor,imagTensor).as1D()},MathBackendCPU.prototype.fourierTransformByMatmul=function(data,size,inverse){for(var ret=new Float32Array(2*size),r=0;r<size;r++){for(var real_2=0,imag_2=0,c=0;c<size;c++){var e=complex_util.exponent(r*c,size,inverse),term=complex_util.getComplexWithIndex(data,c);real_2+=term.real*e.real-term.imag*e.imag,imag_2+=term.real*e.imag+term.imag*e.real}inverse&&(real_2/=size,imag_2/=size),complex_util.assignToTypedArray(ret,real_2,imag_2,r)}return ret},MathBackendCPU.prototype.depthToSpace=function(x,blockSize,dataFormat){util.assert("NHWC"===dataFormat,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+dataFormat}),util.assert(1<blockSize,function(){return"blockSize should be > 1 for depthToSpace, but was: "+blockSize});for(var batchSize=x.shape[0],inputHeight=x.shape[1],inputWidth=x.shape[2],inputDepth=x.shape[3],outputHeight=inputHeight*blockSize,outputWidth=inputWidth*blockSize,outputDepth=inputDepth/(blockSize*blockSize),xValues=this.readSync(x.dataId),result=new Float32Array(batchSize*outputHeight*outputWidth*outputDepth),outputIdx=0,b=0;b<batchSize;++b)for(var h=0;h<outputHeight;++h)for(var inH=Math.floor(h/blockSize),offsetH=h%blockSize,w=0;w<outputWidth;++w)for(var inW=Math.floor(w/blockSize),offsetD=(offsetH*blockSize+w%blockSize)*outputDepth,d=0;d<outputDepth;++d){var inputIdx=d+offsetD+inputDepth*(inW+inputWidth*(inH+inputHeight*b));result[outputIdx++]=xValues[inputIdx]}return ops.tensor4d(result,[batchSize,outputHeight,outputWidth,outputDepth])},MathBackendCPU.prototype.broadcastedBinaryOp=function(a,b,dtype,op){var newShape=broadcast_util.assertAndGetBroadcastShape(a.shape,b.shape),result=ops.buffer(newShape,dtype),aVals=this.readSync(a.dataId),bVals=this.readSync(b.dataId),aBroadcastDims=broadcast_util.getBroadcastDims(a.shape,newShape),bBroadcastDims=broadcast_util.getBroadcastDims(b.shape,newShape),resVals=result.values;if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<resVals.length;++i)resVals[i]=op(aVals[i%aVals.length],bVals[i%bVals.length]);else{var aBuf=this.bufferSync(a),bBuf=this.bufferSync(b),_loop_2=function(i){var loc=result.indexToLoc(i),aLoc=loc.slice(-a.rank);aBroadcastDims.forEach(function(d){return aLoc[d]=0});var aIndex=aBuf.locToIndex(aLoc),bLoc=loc.slice(-b.rank);bBroadcastDims.forEach(function(d){return bLoc[d]=0});var bIndex=bBuf.locToIndex(bLoc);resVals[i]=op(aVals[aIndex],bVals[bIndex])};for(i=0;i<resVals.length;++i)_loop_2(i)}return result.toTensor()},MathBackendCPU.prototype.broadcastedBinaryComplexOp=function(a,b,op){var newShape=broadcast_util.assertAndGetBroadcastShape(a.shape,b.shape),realResult=ops.buffer(newShape,"float32"),imagResult=ops.buffer(newShape,"float32"),aVals=this.readSync(a.dataId),bVals=this.readSync(b.dataId),aBroadcastDims=broadcast_util.getBroadcastDims(a.shape,newShape),bBroadcastDims=broadcast_util.getBroadcastDims(b.shape,newShape),realVals=realResult.values,imagVals=imagResult.values;if(aBroadcastDims.length+bBroadcastDims.length===0)for(var i=0;i<realVals.length;i++){var aIdx=i%aVals.length,bIdx=i%bVals.length,result=op(aVals[2*aIdx],aVals[2*aIdx+1],bVals[2*bIdx],bVals[2*bIdx+1]);realVals[i]=result.real,imagVals[i]=result.imag}else{var aRealBuf=this.bufferSync(this.data.get(a.dataId).complexTensors.real),bRealBuf=this.bufferSync(this.data.get(b.dataId).complexTensors.real),_loop_3=function(i){var loc=realResult.indexToLoc(i),aLoc=loc.slice(-a.rank);aBroadcastDims.forEach(function(d){return aLoc[d]=0});var aIndex=aRealBuf.locToIndex(aLoc),bLoc=loc.slice(-b.rank);bBroadcastDims.forEach(function(d){return bLoc[d]=0});var bIndex=bRealBuf.locToIndex(bLoc),opResult=op(aVals[2*aIndex],aVals[2*aIndex+1],bVals[2*bIndex],bVals[2*bIndex+1]);realVals[i]=opResult.real,imagVals[i]=opResult.imag};for(i=0;i<realVals.length;i++)_loop_3(i)}return this.complex(realResult.toTensor(),imagResult.toTensor())},MathBackendCPU.prototype.split=function(x,sizeSplits,axis){return split_shared_1.split(x,sizeSplits,axis)},MathBackendCPU.prototype.dispose=function(){},MathBackendCPU.prototype.floatPrecision=function(){return 32},MathBackendCPU.prototype.epsilon=function(){return backend_1.EPSILON_FLOAT32},MathBackendCPU.prototype.cropAndResize=function(images,boxes,boxIndex,cropSize,method,extrapolationValue){for(var _a=images.shape,batch=_a[0],imageHeight=_a[1],imageWidth=_a[2],numChannels=_a[3],numBoxes=boxes.shape[0],cropHeight=cropSize[0],cropWidth=cropSize[1],output=ops.buffer([numBoxes,cropHeight,cropWidth,numChannels],images.dtype),boxVals=this.readSync(boxes.dataId),boxIndVals=this.readSync(boxIndex.dataId),imageVals=this.readSync(images.dataId),inStride=images.strides,outStride=output.strides,b=0;b<numBoxes;b++){var startInd=4*b,y1=boxVals[startInd],x1=boxVals[1+startInd],y2=boxVals[2+startInd],x2=boxVals[3+startInd],bInd=boxIndVals[b];if(!(batch<=bInd))for(var heightScale=1<cropHeight?(y2-y1)*(imageHeight-1)/(cropHeight-1):0,widthScale=1<cropWidth?(x2-x1)*(imageWidth-1)/(cropWidth-1):0,y=0;y<cropHeight;y++){var yInd=1<cropHeight?y1*(imageHeight-1)+y*heightScale:.5*(y1+y2)*(imageHeight-1);if(yInd<0||imageHeight-1<yInd)for(var x=0;x<cropWidth;x++)for(var c=0;c<numChannels;c++){var ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else if("bilinear"===method){var topInd=Math.floor(yInd),bottomInd=Math.ceil(yInd),yLerp=yInd-topInd;for(x=0;x<cropWidth;x++){if((xInd=1<cropWidth?x1*(imageWidth-1)+x*widthScale:.5*(x1+x2)*(imageWidth-1))<0||imageWidth-1<xInd)for(c=0;c<numChannels;c++){ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else{var leftInd=Math.floor(xInd),rightInd=Math.ceil(xInd),xLerp=xInd-leftInd;for(c=0;c<numChannels;c++){var topLeft=imageVals[ind=c+leftInd*inStride[2]+topInd*inStride[1]+bInd*inStride[0]],topRight=imageVals[ind=c+rightInd*inStride[2]+topInd*inStride[1]+bInd*inStride[0]],bottomLeft=imageVals[ind=c+leftInd*inStride[2]+bottomInd*inStride[1]+bInd*inStride[0]],top_2=topLeft+(topRight-topLeft)*xLerp,bottom=bottomLeft+(imageVals[ind=c+rightInd*inStride[2]+bottomInd*inStride[1]+bInd*inStride[0]]-bottomLeft)*xLerp;ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0],output.values[ind]=top_2+(bottom-top_2)*yLerp}}}}else for(x=0;x<cropWidth;++x){var xInd;if((xInd=1<cropWidth?x1*(imageWidth-1)+x*widthScale:.5*(x1+x2)*(imageWidth-1))<0||imageWidth-1<xInd)for(c=0;c<numChannels;c++){ind=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[ind]=extrapolationValue}else{var closestX=Math.round(xInd),closestY=Math.round(yInd);for(c=0;c<numChannels;c++){var inInd=c+closestX*inStride[2]+closestY*inStride[1]+bInd*inStride[0],outInd=c+x*outStride[2]+y*outStride[1]+b*outStride[0];output.values[outInd]=imageVals[inInd]}}}}}return output.toTensor()},MathBackendCPU.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){var _a=scatter_nd_util.calculateShapes(sparseValues,sparseIndices,outputShape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize;return this.scatter(sparseIndices,sparseValues,outputShape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,!1)},MathBackendCPU.prototype.gatherND=function(x,indices){var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],_a=gather_nd_util.prepareAndValidate(x,indices),resultShape=_a[0],numSlices=_a[1],sliceSize=_a[2],strides=_a[3];if(0===numSlices)return ops_1.tensor([],resultShape,x.dtype);for(var buffer=new tensor_1.TensorBuffer([numSlices,sliceSize],x.dtype),indicesData=this.readSync(indices.dataId),xData=this.readSync(x.dataId),i=0;i<numSlices;i++){for(var index=[],flattenIndex=0,j=0;j<sliceRank;j++){var dim=indicesData[i*sliceRank+j];flattenIndex+=dim*strides[j],index.push(dim)}if(flattenIndex<0||flattenIndex>=x.size/sliceSize)throw new Error("Invalid indices: "+index+" does not index into "+x.shape);for(var k=0;k<sliceSize;k++)buffer.values[i*sliceSize+k]=xData[flattenIndex*sliceSize+k]}return buffer.toTensor().reshape(resultShape)},MathBackendCPU.prototype.scatterND=function(indices,updates,shape){var _a=scatter_nd_util.calculateShapes(updates,indices,shape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize,defaultValue=ops_1.scalar(0);return this.scatter(indices,updates,shape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,!0)},MathBackendCPU.prototype.fill=function(shape,value,dtype){dtype=dtype||util_1.inferDtype(value);var values=util_1.getArrayFromDType(dtype,util_1.sizeFromShape(shape));return values.fill(value),tensor_1.Tensor.make(shape,{values:values},dtype)},MathBackendCPU.prototype.onesLike=function(x){if("string"===x.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(x.shape,1,x.dtype)},MathBackendCPU.prototype.zerosLike=function(x){var values=util_1.getArrayFromDType(x.dtype,util_1.sizeFromShape(x.shape));return tensor_1.Tensor.make(x.shape,{values:values},x.dtype)},MathBackendCPU.prototype.linspace=function(start,stop,num){return backend_util.linspaceImpl(start,stop,num)},MathBackendCPU.prototype.scatter=function(indices,updates,shape,outputSize,sliceSize,numUpdates,sliceRank,strides,defaultValue,sumDupeIndices){var flattenShape=[outputSize/sliceSize,sliceSize],indicesData=this.readSync(indices.dataId),updatesData=this.readSync(updates.dataId);if(0===outputSize)return ops_1.tensor([],shape,updates.dtype);var buffer=new tensor_1.TensorBuffer(flattenShape,updates.dtype);buffer.values.fill(this.readSync(defaultValue.dataId)[0]);for(var i=0;i<numUpdates;i++){for(var index=[],flattenIndex=0,j=0;j<sliceRank;j++){var dim=indicesData[i*sliceRank+j];index.push(dim),flattenIndex+=dim*strides[j]}if(flattenIndex<0||outputSize/sliceSize<=flattenIndex)throw new Error("Invalid indices: "+index+" does not index into "+shape);for(var k=0;k<sliceSize;k++)sumDupeIndices?buffer.values[flattenIndex*sliceSize+k]+=updatesData[i*sliceSize+k]:buffer.values[flattenIndex*sliceSize+k]=0===updates.rank?updatesData[0]:updatesData[i*sliceSize+k]}return buffer.toTensor().reshape(shape)},MathBackendCPU}();exports.MathBackendCPU=MathBackendCPU,engine_1.ENGINE.registerBackend("cpu",function(){return new MathBackendCPU},1)},{"../../engine":143,"../../environment":144,"../../log":161,"../../ops/array_ops_util":164,"../../ops/axis_util":165,"../../ops/broadcast_util":169,"../../ops/complex_ops":172,"../../ops/concat_util":174,"../../ops/erf_util":181,"../../ops/gather_nd_util":184,"../../ops/ops":196,"../../ops/scatter_nd_util":204,"../../ops/selu_util":207,"../../ops/slice_util":210,"../../tensor":234,"../../types":240,"../../util":241,"../backend":50,"../backend_util":51,"../complex_util":52,"../non_max_suppression_impl":54,"../split_shared":56,"../tile_impl":57,"../topk_impl":58,"../where_impl":140,seedrandom:244}],54:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops");function intersectionOverUnion(boxes,i,j){var iCoord=boxes.subarray(4*i,4*i+4),jCoord=boxes.subarray(4*j,4*j+4),yminI=Math.min(iCoord[0],iCoord[2]),xminI=Math.min(iCoord[1],iCoord[3]),ymaxI=Math.max(iCoord[0],iCoord[2]),xmaxI=Math.max(iCoord[1],iCoord[3]),yminJ=Math.min(jCoord[0],jCoord[2]),xminJ=Math.min(jCoord[1],jCoord[3]),ymaxJ=Math.max(jCoord[0],jCoord[2]),xmaxJ=Math.max(jCoord[1],jCoord[3]),areaI=(ymaxI-yminI)*(xmaxI-xminI),areaJ=(ymaxJ-yminJ)*(xmaxJ-xminJ);if(areaI<=0||areaJ<=0)return 0;var intersectionYmin=Math.max(yminI,yminJ),intersectionXmin=Math.max(xminI,xminJ),intersectionYmax=Math.min(ymaxI,ymaxJ),intersectionXmax=Math.min(xmaxI,xmaxJ),intersectionArea=Math.max(intersectionYmax-intersectionYmin,0)*Math.max(intersectionXmax-intersectionXmin,0);return intersectionArea/(areaI+areaJ-intersectionArea)}exports.nonMaxSuppressionImpl=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){for(var candidates=Array.from(scores).map(function(score,boxIndex){return{score:score,boxIndex:boxIndex}}).filter(function(c){return c.score>scoreThreshold}).sort(function(c1,c2){return c2.score-c1.score}),selected=[],i=0;i<candidates.length;i++){var _a=candidates[i],score=_a.score,boxIndex=_a.boxIndex;if(score<scoreThreshold)break;for(var ignoreCandidate=!1,j=selected.length-1;0<=j;--j){if(iouThreshold<=intersectionOverUnion(boxes,boxIndex,selected[j])){ignoreCandidate=!0;break}}if(!ignoreCandidate&&(selected.push(boxIndex),selected.length>=maxOutputSize))break}return tensor_ops_1.tensor1d(selected,"int32")}},{"../ops/tensor_ops":216}],55:[function(require,module,exports){"use strict";function getVecChannels(name,rank){return["x","y","z","w","u","v"].slice(0,rank).map(function(d){return name+"."+d})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVecChannels=getVecChannels,exports.getChannels=function(name,rank){return 1===rank?[name]:getVecChannels(name,rank)},exports.getSourceCoords=function(rank,dims){if(1===rank)return"rc";for(var coords="",i=0;i<rank;i++)coords+=dims[i],i<rank-1&&(coords+=",");return coords}},{}],56:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.split=function(x,sizeSplits,axis){var begin=new Array(x.rank).fill(0),size=x.shape.slice();return sizeSplits.map(function(s){size[axis]=s;var slice=x.slice(begin,size);return begin[axis]+=s,slice})}},{}],57:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var array_ops_1=require("../ops/array_ops");exports.tile=function(xBuf,reps){for(var newShape=new Array(xBuf.rank),i=0;i<newShape.length;i++)newShape[i]=xBuf.shape[i]*reps[i];var result=array_ops_1.buffer(newShape,xBuf.dtype);for(i=0;i<result.values.length;++i){for(var newLoc=result.indexToLoc(i),originalLoc=new Array(xBuf.rank),i_1=0;i_1<originalLoc.length;i_1++)originalLoc[i_1]=newLoc[i_1]%xBuf.shape[i_1];var originalIndex=xBuf.locToIndex(originalLoc);result.values[i]=xBuf.values[originalIndex]}return result.toTensor()}},{"../ops/array_ops":163}],58:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util");exports.topkImpl=function(x,xShape,xDtype,k,sorted){for(var lastDim=xShape[xShape.length-1],_a=[x.length/lastDim,lastDim],batch=_a[0],size=_a[1],allTopKVals=util_1.getTypedArrayFromDType(xDtype,batch*k),allTopKIndices=util_1.getTypedArrayFromDType("int32",batch*k),b=0;b<batch;b++){for(var offset=b*size,vals=x.subarray(offset,offset+size),valAndInd=[],i=0;i<vals.length;i++)valAndInd.push({value:vals[i],index:i});valAndInd.sort(function(a,b){return b.value-a.value});var outOffset=b*k,topKVals=allTopKVals.subarray(outOffset,outOffset+k),topKIndices=allTopKIndices.subarray(outOffset,outOffset+k);for(i=0;i<k;i++)topKVals[i]=valAndInd[i].value,topKIndices[i]=valAndInd[i].index}var outputShape=xShape.slice();return outputShape[outputShape.length-1]=k,[tensor_ops_1.tensor(allTopKVals,outputShape,xDtype),tensor_ops_1.tensor(allTopKIndices,outputShape,"int32")]}},{"../ops/tensor_ops":216,"../util":241}],59:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function AddNProgram(outputShape,shapes){this.outputShape=[],this.outputShape=outputShape,this.variableNames=shapes.map(function(_,i){return"T"+i});var snippets=[];this.variableNames.forEach(function(variable){snippets.push("float v"+variable+" = get"+variable+"AtOutCoords();")});var operation=this.variableNames.map(function(variable){return"v"+variable}).join(" + ");this.userCode="\n      void main() {\n        "+snippets.join("\n        ")+"\n\n        float result = "+operation+";\n        setOutput(result);\n      }\n    "}exports.AddNProgram=AddNProgram},{}],60:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function AddNPackedProgram(outputShape,shapes){this.outputShape=[],this.usesPackedTextures=!0,this.outputShape=outputShape,this.variableNames=shapes.map(function(_,i){return"T"+i});var snippets=[];this.variableNames.forEach(function(variable){snippets.push("vec4 v"+variable+" = get"+variable+"AtOutCoords();")});var operation=this.variableNames.map(function(variable){return"v"+variable}).join(" + ");this.userCode="\n      void main() {\n        "+snippets.join("\n        ")+"\n\n        vec4 result = "+operation+";\n        setOutput(result);\n      }\n    "}exports.AddNPackedProgram=AddNPackedProgram},{}],61:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ArgMinMaxProgram(reduceInfo,op,firstPass){this.variableNames=["A"];var windowSize=reduceInfo.windowSize,batchSize=reduceInfo.batchSize,inSize=reduceInfo.inSize,outSize=Math.ceil(inSize/windowSize);firstPass||this.variableNames.push("bestIndicesA"),this.outputShape=[batchSize,outSize];var compOp="max"===op?">":"<",indexSnippet=firstPass?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));";this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+windowSize+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+windowSize+"; i++) {\n          int inIdx = "+indexSnippet+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+compOp+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "}exports.ArgMinMaxProgram=ArgMinMaxProgram},{}],62:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ArgMinMaxPackedProgram(shape,windowSize,op,firstPass){this.variableNames=["A"],this.usesPackedTextures=!0,util_1.assert(2<shape.length,function(){return"Packed arg"+(op.charAt(0).toUpperCase()+op.slice(1))+" supports only inputs with rank above 2."});var inSize=shape[shape.length-1],outSize=Math.ceil(inSize/windowSize);this.outputShape=shape.slice(0,-1),1<outSize&&this.outputShape.push(outSize),firstPass||this.variableNames.push("bestIndicesA");var sourceLocSetup,sourceRank,outShape=this.outputShape,rank=outShape.length,dtype=shader_compiler_1.getCoordsDataType(rank),coords=packing_util_1.getChannels("coords",rank);if(1===outSize){sourceRank=rank+1;var sourceLocDType=shader_compiler_1.getCoordsDataType(sourceRank);sourceLocSetup="\n        "+sourceLocDType+" sourceLocR = "+sourceLocDType+"("+coords.join()+", 0);\n        ++"+coords[rank-1]+";\n        "+sourceLocDType+" sourceLocG = "+sourceLocDType+"("+coords.join()+", 0);\n        ++"+coords[rank-2]+";\n        "+sourceLocDType+" sourceLocA = "+sourceLocDType+"("+coords.join()+", 0);\n        --"+coords[rank-1]+";\n        "+sourceLocDType+" sourceLocB = "+sourceLocDType+"("+coords.join()+", 0);\n        --"+coords[rank-2]+";"}else sourceLocSetup="\n        "+dtype+" sourceLocR = coords;\n        ++"+coords[(sourceRank=rank)-1]+";\n        "+dtype+" sourceLocG = coords;\n        ++"+coords[rank-2]+";\n        "+dtype+" sourceLocA = coords;\n        --"+coords[rank-1]+";\n        "+dtype+" sourceLocB = coords;\n        --"+coords[rank-2]+";";var channels=["x","y","z","w","u","v"].slice(0,sourceRank),inChannel="."+channels[sourceRank-1],intChannels=channels.map(function(x){return"int "+x}),srcRCoords=packing_util_1.getChannels("sourceLocR",sourceRank-1).concat("inIdx.r"),srcGCoords=packing_util_1.getChannels("sourceLocG",sourceRank-1).concat("inIdx.g"),srcBCoords=packing_util_1.getChannels("sourceLocB",sourceRank-1).concat("inIdx.b"),srcACoords=packing_util_1.getChannels("sourceLocA",sourceRank-1).concat("inIdx.a"),compOp="max"===op?"greaterThan":"lessThan",fetchCandidateIdx=firstPass?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+srcRCoords.join()+"),\n                             getBestIndicesAChannel("+srcGCoords.join()+"),\n                             getBestIndicesAChannel("+srcBCoords.join()+"),\n                             getBestIndicesAChannel("+srcACoords.join()+")));",fetchValue="vec4(\n            getAChannel("+srcRCoords.join()+"),\n            hasNextCol ? getAChannel("+srcGCoords.join()+") : 0.,\n            hasNextRow ? getAChannel("+srcBCoords.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+srcACoords.join()+") : 0.)",getBestIndicesAChannelSnippet=firstPass?"":"\n      float getBestIndicesAChannel("+intChannels.join()+") {\n        return getChannel(getBestIndicesA("+channels.join()+"),\n                                          vec2("+channels.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+intChannels.join()+") {\n        return getChannel(getA("+channels.join()+"),\n                               vec2("+channels.slice(-2).join()+"));\n      }\n      "+getBestIndicesAChannelSnippet+"\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        bool hasNextCol = "+coords[rank-1]+" < "+(outShape[rank-1]-1)+";\n        bool hasNextRow = "+coords[rank-2]+" < "+(outShape[rank-2]-1)+";\n        "+sourceLocSetup+"\n        ivec4 srcIdx = ivec4(sourceLocR"+inChannel+", sourceLocG"+inChannel+",\n          sourceLocB"+inChannel+", sourceLocA"+inChannel+") * "+windowSize+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+fetchValue+";\n\n        for (int i = 0; i < "+windowSize+"; i++) {\n          inIdx = srcIdx;\n          "+fetchCandidateIdx+"\n          vec4 candidate = "+fetchValue+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+compOp+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "}var util_1=require("../../util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.ArgMinMaxPackedProgram=ArgMinMaxPackedProgram},{"../../util":241,"../packing_util":55,"./shader_compiler":126}],63:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function AvgPool2DBackpropProgram(convInfo){this.variableNames=["dy"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,avgMultiplier=1/(filterHeight*filterWidth);this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float avgMultiplier = float("+avgMultiplier+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+effectiveFilterWidth+";\n            wC+= "+dilationWidth+") {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.AvgPool2DBackpropProgram=AvgPool2DBackpropProgram;function AvgPool3DBackpropProgram(convInfo){this.variableNames=["dy"],this.outputShape=convInfo.inShape;var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,avgMultiplier=1/(filterDepth*filterHeight*filterWidth);this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n      const float avgMultiplier = float("+avgMultiplier+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n            wD += "+dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+convInfo.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.AvgPool3DBackpropProgram=AvgPool3DBackpropProgram},{}],64:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0}),require("./flags_webgl");var device_util=require("../../device_util"),engine_1=require("../../engine"),environment_1=require("../../environment"),globals_1=require("../../globals"),log_1=require("../../log"),array_ops_1=require("../../ops/array_ops"),array_ops_util=require("../../ops/array_ops_util"),axis_util=require("../../ops/axis_util"),complex_ops_1=require("../../ops/complex_ops"),concat_util_1=require("../../ops/concat_util"),gather_nd_util=require("../../ops/gather_nd_util"),reduce_util=require("../../ops/reduce_util"),scatter_nd_util=require("../../ops/scatter_nd_util"),segment_util=require("../../ops/segment_util"),slice_util_1=require("../../ops/slice_util"),softmax_1=require("../../ops/softmax"),tensor_ops_1=require("../../ops/tensor_ops"),tensor_1=require("../../tensor"),types_1=require("../../types"),util=require("../../util"),util_1=require("../../util"),backend_1=require("../backend"),backend_util=require("../backend_util"),complex_util_1=require("../complex_util"),non_max_suppression_impl_1=require("../non_max_suppression_impl"),split_shared_1=require("../split_shared"),tile_impl_1=require("../tile_impl"),topk_impl_1=require("../topk_impl"),where_impl_1=require("../where_impl"),addn_gpu_1=require("./addn_gpu"),addn_packed_gpu_1=require("./addn_packed_gpu"),argminmax_gpu_1=require("./argminmax_gpu"),argminmax_packed_gpu_1=require("./argminmax_packed_gpu"),avg_pool_backprop_gpu_1=require("./avg_pool_backprop_gpu"),batchnorm_gpu_1=require("./batchnorm_gpu"),batchnorm_packed_gpu_1=require("./batchnorm_packed_gpu"),binaryop_complex_gpu=require("./binaryop_complex_gpu"),binaryop_complex_gpu_1=require("./binaryop_complex_gpu"),binaryop_gpu=require("./binaryop_gpu"),binaryop_gpu_1=require("./binaryop_gpu"),binaryop_packed_gpu=require("./binaryop_packed_gpu"),binaryop_packed_gpu_1=require("./binaryop_packed_gpu"),canvas_util_1=require("./canvas_util"),clip_gpu_1=require("./clip_gpu"),clip_packed_gpu_1=require("./clip_packed_gpu"),complex_abs_gpu_1=require("./complex_abs_gpu"),concat_gpu_1=require("./concat_gpu"),concat_packed_gpu_1=require("./concat_packed_gpu"),conv_backprop_gpu_1=require("./conv_backprop_gpu"),conv_backprop_gpu_depthwise_1=require("./conv_backprop_gpu_depthwise"),conv_gpu_1=require("./conv_gpu"),conv_gpu_depthwise_1=require("./conv_gpu_depthwise"),conv_packed_gpu_depthwise_1=require("./conv_packed_gpu_depthwise"),crop_and_resize_gpu_1=require("./crop_and_resize_gpu"),cumsum_gpu_1=require("./cumsum_gpu"),decode_matrix_gpu_1=require("./decode_matrix_gpu"),decode_matrix_packed_gpu_1=require("./decode_matrix_packed_gpu"),depth_to_space_gpu_1=require("./depth_to_space_gpu"),diag_gpu_1=require("./diag_gpu"),encode_float_gpu_1=require("./encode_float_gpu"),encode_float_packed_gpu_1=require("./encode_float_packed_gpu"),encode_matrix_gpu_1=require("./encode_matrix_gpu"),encode_matrix_packed_gpu_1=require("./encode_matrix_packed_gpu"),fft_gpu=require("./fft_gpu"),fft_gpu_1=require("./fft_gpu"),fill_gpu_1=require("./fill_gpu"),from_pixels_gpu_1=require("./from_pixels_gpu"),from_pixels_packed_gpu_1=require("./from_pixels_packed_gpu"),gather_gpu_1=require("./gather_gpu"),gather_nd_gpu_1=require("./gather_nd_gpu"),gpgpu_context_1=require("./gpgpu_context"),gpgpu_math=require("./gpgpu_math"),im2col_packed_gpu_1=require("./im2col_packed_gpu"),lrn_gpu_1=require("./lrn_gpu"),lrn_grad_gpu_1=require("./lrn_grad_gpu"),lrn_packed_gpu_1=require("./lrn_packed_gpu"),max_pool_backprop_gpu_1=require("./max_pool_backprop_gpu"),mulmat_packed_gpu_1=require("./mulmat_packed_gpu"),multinomial_gpu_1=require("./multinomial_gpu"),onehot_gpu_1=require("./onehot_gpu"),pack_gpu_1=require("./pack_gpu"),pad_gpu_1=require("./pad_gpu"),pad_packed_gpu_1=require("./pad_packed_gpu"),pool_gpu_1=require("./pool_gpu"),reduce_gpu_1=require("./reduce_gpu"),reshape_packed_gpu_1=require("./reshape_packed_gpu"),resize_bilinear_backprop_gpu_1=require("./resize_bilinear_backprop_gpu"),resize_bilinear_gpu_1=require("./resize_bilinear_gpu"),resize_bilinear_packed_gpu_1=require("./resize_bilinear_packed_gpu"),resize_nearest_neighbor_backprop_gpu_1=require("./resize_nearest_neighbor_backprop_gpu"),resize_nearest_neighbor_gpu_1=require("./resize_nearest_neighbor_gpu"),reverse_gpu_1=require("./reverse_gpu"),reverse_packed_gpu_1=require("./reverse_packed_gpu"),scatter_gpu_1=require("./scatter_gpu"),segment_gpu_1=require("./segment_gpu"),select_gpu_1=require("./select_gpu"),slice_gpu_1=require("./slice_gpu"),slice_packed_gpu_1=require("./slice_packed_gpu"),strided_slice_gpu_1=require("./strided_slice_gpu"),tex_util=require("./tex_util"),tex_util_1=require("./tex_util"),texture_manager_1=require("./texture_manager"),tile_gpu_1=require("./tile_gpu"),transpose_gpu_1=require("./transpose_gpu"),transpose_packed_gpu_1=require("./transpose_packed_gpu"),unary_op=require("./unaryop_gpu"),unaryop_gpu_1=require("./unaryop_gpu"),unary_packed_op=require("./unaryop_packed_gpu"),unaryop_packed_gpu_1=require("./unaryop_packed_gpu"),unpack_gpu_1=require("./unpack_gpu"),webgl_util=require("./webgl_util"),binaryCaches={};function mapActivationToShaderProgram(activation,packed){if(void 0===packed&&(packed=!1),"linear"===activation)return packed?unary_packed_op.LINEAR:unary_op.LINEAR;if("relu"===activation)return packed?unary_packed_op.RELU:unary_op.RELU;if("prelu"===activation)return packed?binaryop_packed_gpu.PRELU:binaryop_gpu.PRELU;throw new Error("Activation "+activation+" has not been implemented for the WebGL backend.")}var BEFORE_PAGING_CONSTANT=600;exports.MATMUL_SHARED_DIM_THRESHOLD=1e3;var MathBackendWebGL=function(){function MathBackendWebGL(gpgpu){if(this.gpgpu=gpgpu,this.pendingRead=new WeakMap,this.pendingDisposal=new WeakSet,this.dataRefCount=new WeakMap,this.numBytesInGPU=0,this.uploadWaitMs=0,this.downloadWaitMs=0,this.warnedAboutMemory=!1,this.disposed=!1,!environment_1.ENV.getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==gpgpu){var gl=canvas_util_1.getWebGLContext(environment_1.ENV.getNumber("WEBGL_VERSION"));this.binaryCache=function(webGLVersion){return webGLVersion in binaryCaches||(binaryCaches[webGLVersion]={}),binaryCaches[webGLVersion]}(environment_1.ENV.getNumber("WEBGL_VERSION")),this.gpgpu=new gpgpu_context_1.GPGPUContext(gl),this.canvas=gl.canvas,this.gpgpuCreatedLocally=!0}else this.binaryCache={},this.gpgpuCreatedLocally=!1,this.canvas=gpgpu.gl.canvas;this.textureManager=new texture_manager_1.TextureManager(this.gpgpu),this.numMBBeforeWarning=null==environment_1.ENV.global.screen?1024:environment_1.ENV.global.screen.height*environment_1.ENV.global.screen.width*window.devicePixelRatio*BEFORE_PAGING_CONSTANT/1024/1024,this.texData=new backend_1.DataStorage(this,engine_1.ENGINE)}return MathBackendWebGL.prototype.register=function(dataId,shape,dtype){if(this.texData.has(dataId))throw new Error("Data buffer is already registered");this.texData.set(dataId,{shape:shape,dtype:dtype})},MathBackendWebGL.prototype.fromPixels=function(pixels,numChannels){if(null==pixels)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var texShape=[pixels.height,pixels.width],outShape=[pixels.height,pixels.width,numChannels],isCanvas="undefined"!=typeof OffscreenCanvas&&pixels instanceof OffscreenCanvas||"undefined"!=typeof HTMLCanvasElement&&pixels instanceof HTMLCanvasElement,isPixelData=pixels.data instanceof Uint8Array,isImageData="undefined"!=typeof ImageData&&pixels instanceof ImageData,isVideo="undefined"!=typeof HTMLVideoElement&&pixels instanceof HTMLVideoElement,isImage="undefined"!=typeof HTMLImageElement&&pixels instanceof HTMLImageElement;if(!(isCanvas||isPixelData||isImageData||isVideo||isImage))throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+pixels.constructor.name);if(isImage||isVideo){if(null==this.fromPixels2DContext){if("complete"!==document.readyState)throw new Error("The DOM is not ready yet. Please call tf.browser.fromPixels() once the DOM is ready. One way to do that is to add an event listener for `DOMContentLoaded` on the document object");this.fromPixels2DContext=canvas_util_1.createCanvas(environment_1.ENV.getNumber("WEBGL_VERSION")).getContext("2d")}this.fromPixels2DContext.canvas.width=pixels.width,this.fromPixels2DContext.canvas.height=pixels.height,this.fromPixels2DContext.drawImage(pixels,0,0,pixels.width,pixels.height),pixels=this.fromPixels2DContext.canvas}var program,res,tempPixelHandle=this.makeTensorHandle(texShape,"int32");if(this.texData.get(tempPixelHandle.dataId).usage=tex_util_1.TextureUsage.PIXELS,this.gpgpu.uploadPixelDataToTexture(this.getTexture(tempPixelHandle.dataId),pixels),environment_1.ENV.getBool("WEBGL_PACK")){program=new from_pixels_packed_gpu_1.FromPixelsPackedProgram(outShape);var packedOutput=this.makePackedTensor(program.outputShape,tempPixelHandle.dtype);res=this.compileAndRun(program,[tempPixelHandle],packedOutput)}else program=new from_pixels_gpu_1.FromPixelsProgram(outShape),res=this.compileAndRun(program,[tempPixelHandle]);return this.disposeData(tempPixelHandle.dataId),res},MathBackendWebGL.prototype.makeTensorHandle=function(shape,dtype){var dataId={};return this.register(dataId,shape,dtype),{dataId:dataId,shape:shape,dtype:dtype}},MathBackendWebGL.prototype.write=function(dataId,values){if(null==values)throw new Error("MathBackendWebGL.write(): values can not be null");if(environment_1.ENV.getBool("DEBUG"))for(var i=0;i<values.length;i++){var num=values[i];if(!webgl_util.canBeRepresented(num))throw Error("The value "+num+" cannot be represented on this device.")}var texData=this.texData.get(dataId);if("complex64"===texData.dtype)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.releaseGPUData(dataId),texData.usage=tex_util_1.TextureUsage.UPLOAD,texData.values=values},MathBackendWebGL.prototype.readSync=function(dataId){var texData=this.texData.get(dataId),values=texData.values,dtype=texData.dtype,complexTensors=texData.complexTensors,slice=texData.slice,shape=texData.shape;if(null!=slice){var program=new unaryop_gpu_1.UnaryOpProgram(shape,unary_op.CLONE),res=this.compileAndRun(program,[{dataId:dataId,shape:shape,dtype:dtype}]),data=this.readSync(res.dataId);return res.dispose(),data}if(null!=values)return this.convertAndCacheOnCPU(dataId);if("string"===dtype)return values;var start,result,shouldTimeProgram=null!=this.activeTimers;if(shouldTimeProgram&&(start=util.now()),"complex64"===dtype){var realValues=complexTensors.real.dataSync(),imagValues=complexTensors.imag.dataSync();result=complex_util_1.mergeRealAndImagArrays(realValues,imagValues)}else result=this.getValuesFromTexture(dataId);return shouldTimeProgram&&(this.downloadWaitMs+=util.now()-start),this.convertAndCacheOnCPU(dataId,result)},MathBackendWebGL.prototype.read=function(dataId){return __awaiter(this,void 0,void 0,function(){var _a,subscribers_1,texData,values,shape,slice,dtype,complexTensors,program,res,data,buffer,tmpTarget,tmpData,vals,_b,realValues,imagValues,size,dTypeVals,subscribers;return __generator(this,function(_c){switch(_c.label){case 0:if(this.pendingRead.has(dataId))return subscribers_1=this.pendingRead.get(dataId),[2,new Promise(function(resolve){return subscribers_1.push(resolve)})];if(texData=this.texData.get(dataId),values=texData.values,shape=texData.shape,slice=texData.slice,dtype=texData.dtype,complexTensors=texData.complexTensors,null!=slice)return program=new unaryop_gpu_1.UnaryOpProgram(shape,unary_op.CLONE),res=this.compileAndRun(program,[{dataId:dataId,shape:shape,dtype:dtype}]),data=this.read(res.dataId),res.dispose(),[2,data];if(null!=values)return[2,this.convertAndCacheOnCPU(dataId)];if(!environment_1.ENV.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===environment_1.ENV.getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return buffer=null,"complex64"!==dtype&&environment_1.ENV.get("WEBGL_BUFFER_SUPPORTED")&&(tmpTarget=this.decode(dataId),dataId=tmpTarget.dataId,tmpData=this.texData.get(tmpTarget.dataId),buffer=(_a=this.gpgpu).createBufferFromTexture.apply(_a,[tmpData.texture].concat(tex_util.getDenseTexShape(shape)))),this.pendingRead.set(dataId,[]),"complex64"===dtype?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:_c.sent(),_c.label=2;case 2:return"complex64"!==dtype?[3,4]:[4,Promise.all([complexTensors.real.data(),complexTensors.imag.data()])];case 3:return _b=_c.sent(),realValues=_b[0],imagValues=_b[1],vals=complex_util_1.mergeRealAndImagArrays(realValues,imagValues),[3,5];case 4:null==buffer?vals=this.getValuesFromTexture(dataId):(size=util.sizeFromShape(shape),vals=this.gpgpu.downloadFloat32MatrixFromBuffer(buffer,size),this.disposeData(dataId)),_c.label=5;case 5:return dTypeVals=this.convertAndCacheOnCPU(dataId,vals),subscribers=this.pendingRead.get(dataId),this.pendingRead.delete(dataId),subscribers.forEach(function(resolve){return resolve(dTypeVals)}),this.pendingDisposal.has(dataId)&&(this.pendingDisposal.delete(dataId),this.disposeData(dataId)),[2,dTypeVals]}})})},MathBackendWebGL.prototype.getValuesFromTexture=function(dataId){var _a,_this=this,_b=this.texData.get(dataId),shape=_b.shape,dtype=_b.dtype,isPacked=_b.isPacked,size=util.sizeFromShape(shape);if(environment_1.ENV.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var tmpTarget_1=this.decode(dataId),tmpData_1=this.texData.get(tmpTarget_1.dataId),vals_1=(_a=this.gpgpu).downloadMatrixFromPackedTexture.apply(_a,[tmpData_1.texture].concat(tex_util.getDenseTexShape(shape))).subarray(0,size);return this.disposeData(tmpTarget_1.dataId),vals_1}var shouldUsePackedProgram=environment_1.ENV.getBool("WEBGL_PACK")&&!0===isPacked,outputShape=shouldUsePackedProgram?webgl_util.getShapeAs3D(shape):shape,tmpTarget=this.makeTensorHandle(outputShape,"float32");tmpTarget.size=util_1.sizeFromShape(shape),this.texData.get(tmpTarget.dataId).usage=tex_util_1.TextureUsage.DOWNLOAD;var output=globals_1.tidy(function(){var program=shouldUsePackedProgram?new encode_float_packed_gpu_1.EncodeFloatPackedProgram(outputShape):new encode_float_gpu_1.EncodeFloatProgram(outputShape);return _this.compileAndRun(program,[{shape:outputShape,dtype:dtype,dataId:dataId}],tmpTarget,null)}),tmpData=this.texData.get(output.dataId),vals=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(tmpData.texture,tmpData.texShape[0],tmpData.texShape[1]).subarray(0,size);return this.disposeData(tmpTarget.dataId),vals},MathBackendWebGL.prototype.time=function(f){return __awaiter(this,void 0,void 0,function(){var oldActiveTimers,newActiveTimers,outerMostTime,flattenedActiveTimerQueries,flattenedActiveTimerNames,kernelMs,res;return __generator(this,function(_a){switch(_a.label){case 0:return oldActiveTimers=this.activeTimers,outerMostTime=!(newActiveTimers=[]),null==this.programTimersStack?(this.programTimersStack=newActiveTimers,outerMostTime=!0):this.activeTimers.push(newActiveTimers),this.activeTimers=newActiveTimers,f(),flattenedActiveTimerQueries=util.flatten(this.activeTimers.map(function(d){return d.query})).filter(function(d){return null!=d}),flattenedActiveTimerNames=util.flatten(this.activeTimers.map(function(d){return d.name})).filter(function(d){return null!=d}),this.activeTimers=oldActiveTimers,outerMostTime&&(this.programTimersStack=null),[4,Promise.all(flattenedActiveTimerQueries)];case 1:return kernelMs=_a.sent(),res={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:util.sum(kernelMs),getExtraProfileInfo:function(){return kernelMs.map(function(d,i){return{name:flattenedActiveTimerNames[i],ms:d}}).map(function(d){return d.name+": "+d.ms}).join(", ")},wallMs:null},this.uploadWaitMs=0,this.downloadWaitMs=0,[2,res]}})})},MathBackendWebGL.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},MathBackendWebGL.prototype.startTimer=function(){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.beginQuery():{startMs:util.now(),endMs:null}},MathBackendWebGL.prototype.endTimer=function(query){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.endQuery():query.endMs=util.now(),query},MathBackendWebGL.prototype.getQueryTime=function(query){return __awaiter(this,void 0,void 0,function(){var timerQuery;return __generator(this,function(_a){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?[2,this.gpgpu.waitForQueryAndGetTime(query)]:[2,(timerQuery=query).endMs-timerQuery.startMs]})})},MathBackendWebGL.prototype.disposeData=function(dataId){if(!this.pendingDisposal.has(dataId))if(this.pendingRead.has(dataId))this.pendingDisposal.add(dataId);else if(this.texData.has(dataId)){this.releaseGPUData(dataId);var complexTensors=this.texData.get(dataId).complexTensors;null!=complexTensors&&(complexTensors.real.dispose(),complexTensors.imag.dispose()),this.texData.delete(dataId)}},MathBackendWebGL.prototype.releaseGPUData=function(dataId){var _a=this.texData.get(dataId),texture=_a.texture,dtype=_a.dtype,texShape=_a.texShape,usage=_a.usage,isPacked=_a.isPacked,slice=_a.slice,key=slice&&slice.origDataId||dataId,refCount=this.dataRefCount.get(key);1<refCount?this.dataRefCount.set(key,refCount-1):(this.dataRefCount.delete(key),null!=texture&&(this.numBytesInGPU-=this.computeBytes(texShape,dtype),this.textureManager.releaseTexture(texture,texShape,usage,isPacked)));var texData=this.texData.get(dataId);texData.texture=null,texData.texShape=null,texData.isPacked=!1,texData.slice=null},MathBackendWebGL.prototype.getTexture=function(dataId){return this.uploadToGPU(dataId),this.texData.get(dataId).texture},MathBackendWebGL.prototype.getCPUBackend=function(){return environment_1.ENV.getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=engine_1.ENGINE.findBackend("cpu")),this.cpuBackend):null},MathBackendWebGL.prototype.shouldExecuteOnCPU=function(inputs,sizeThreshold){var _this=this;return void 0===sizeThreshold&&(sizeThreshold=128),null!=this.getCPUBackend()&&inputs.every(function(input){return null==_this.texData.get(input.dataId).texture&&input.size<sizeThreshold})},MathBackendWebGL.prototype.getGPGPUContext=function(){return this.gpgpu},MathBackendWebGL.prototype.complex=function(real,imag){var result=this.makeOutputArray(real.shape,"complex64");return this.texData.get(result.dataId).complexTensors={real:engine_1.ENGINE.keep(real.clone()),imag:engine_1.ENGINE.keep(imag.clone())},result},MathBackendWebGL.prototype.real=function(input){return this.texData.get(input.dataId).complexTensors.real.clone()},MathBackendWebGL.prototype.imag=function(input){return this.texData.get(input.dataId).complexTensors.imag.clone()},MathBackendWebGL.prototype.slice=function(x,begin,size){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.slice(x,begin,size);if(0===util.sizeFromShape(size))return tensor_ops_1.tensor([],size,x.dtype);var isPacked=this.texData.get(x.dataId).isPacked,isContinous=slice_util_1.isSliceContinous(x.shape,begin,size);if(!isPacked&&isContinous)return this.uploadToGPU(x.dataId),this.shallowSlice(x,begin,size);var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new slice_packed_gpu_1.SlicePackedProgram(size):new slice_gpu_1.SliceProgram(size),customSetup=program.getCustomSetupFunc(begin);return this.compileAndRun(program,[x],null,customSetup)},MathBackendWebGL.prototype.shallowSlice=function(x,begin,size){var xTexData=this.texData.get(x.dataId),t=tensor_1.Tensor.make(size,{},x.dtype,this),newTexData=this.texData.get(t.dataId);Object.assign(newTexData,xTexData),newTexData.shape=size,newTexData.dtype=x.dtype;var flatOffset=slice_util_1.computeFlatOffset(begin,x.strides);xTexData.slice&&(flatOffset+=xTexData.slice.flatOffset),newTexData.slice={flatOffset:flatOffset,origDataId:xTexData.slice&&xTexData.slice.origDataId||x.dataId};var refCount=this.dataRefCount.get(newTexData.slice.origDataId)||1;return this.dataRefCount.set(newTexData.slice.origDataId,refCount+1),t},MathBackendWebGL.prototype.stridedSlice=function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.stridedSlice(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask);var _a=slice_util_1.getStridedSlicedInfo(x.shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask),beginIndex=_a[0],size=_a[1],shrinkAxis=_a[2],shape=size.filter(function(v,index){return-1===shrinkAxis.indexOf(index)});if(shape.some(function(axis){return 0===axis}))return tensor_ops_1.tensor([],shape);var program=new strided_slice_gpu_1.StridedSliceProgram(beginIndex,strides,size,shrinkAxis);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.reverse=function(x,axis){var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new reverse_packed_gpu_1.ReversePackedProgram(x.shape,axis):new reverse_gpu_1.ReverseProgram(x.shape,axis);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.concat=function(tensors,axis){if("complex64"===tensors[0].dtype){var reals=tensors.map(function(t){return complex_ops_1.real(t)}),imags=tensors.map(function(t){return complex_ops_1.imag(t)});return complex_ops_1.complex(this.concat(reals,axis),this.concat(imags,axis))}if(this.shouldExecuteOnCPU(tensors))return this.cpuBackend.concat(tensors,axis);if(1===tensors.length)return tensors[0];if(tensors.length>environment_1.ENV.getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var midIndex=Math.floor(tensors.length/2),leftSide=this.concat(tensors.slice(0,midIndex),axis),rightSide=this.concat(tensors.slice(midIndex),axis);return this.concat([leftSide,rightSide],axis)}if(environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&1<tensors[0].rank){var program_1=new concat_packed_gpu_1.ConcatPackedProgram(tensors.map(function(t){return t.shape}),axis);return this.compileAndRun(program_1,tensors)}var outShape=concat_util_1.computeOutShape(tensors.map(function(t){return t.shape}),axis),tensors2D=tensors.map(function(t){return t.as2D(-1,util_1.sizeFromShape(t.shape.slice(axis)))}),program=new concat_gpu_1.ConcatProgram(tensors2D.map(function(t){return t.shape}));return this.compileAndRun(program,tensors2D).reshape(outShape)},MathBackendWebGL.prototype.neg=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.NEG);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.batchMatMul=function(a,b,transposeA,transposeB){var outerShapeA=transposeA?a.shape[2]:a.shape[1],outerShapeB=transposeB?b.shape[1]:b.shape[2],sharedDim=transposeA?a.shape[1]:a.shape[2],batch=a.shape[0];if((1===outerShapeA||1===outerShapeB)&&sharedDim>exports.MATMUL_SHARED_DIM_THRESHOLD){transposeA&&(a=a.transpose([0,2,1])),transposeB&&(b=b.transpose([0,2,1]));var a3D=1===outerShapeB?a:a.as3D(batch,sharedDim,1),axis=1===outerShapeB?2:1,b3D=1===outerShapeB?b.as3D(batch,1,sharedDim):b;return this.multiply(a3D,b3D).sum(axis,!0)}var dtype=types_1.upcastType(a.dtype,b.dtype),program=new mulmat_packed_gpu_1.MatMulPackedProgram(a.shape,[batch,outerShapeA,outerShapeB],transposeA,transposeB),output=this.makePackedTensor(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.fusedBatchMatMul=function(_a){var a=_a.a,b=_a.b,transposeA=_a.transposeA,transposeB=_a.transposeB,bias=_a.bias,activation=_a.activation,preluActivationWeights=_a.preluActivationWeights,outerShapeA=transposeA?a.shape[2]:a.shape[1],outerShapeB=transposeB?b.shape[1]:b.shape[2],batch=a.shape[0],dtype=types_1.upcastType(a.dtype,b.dtype),hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!0):null,program=new mulmat_packed_gpu_1.MatMulPackedProgram(a.shape,[batch,outerShapeA,outerShapeB],transposeA,transposeB,hasBias,fusedActivation,hasPreluActivationWeights),output=this.makePackedTensor(program.outputShape,dtype),inputs=[a,b];return bias&&inputs.push(bias),preluActivationWeights&&inputs.push(preluActivationWeights),this.compileAndRun(program,inputs,output)},MathBackendWebGL.prototype.multiply=function(a,b){if("complex64"===a.dtype){var aData=this.texData.get(a.dataId),bData=this.texData.get(b.dataId),realProgram=new binaryop_complex_gpu_1.BinaryOpComplexProgram(binaryop_complex_gpu.COMPLEX_MULTIPLY.REAL,a.shape,b.shape),imagProgram=new binaryop_complex_gpu_1.BinaryOpComplexProgram(binaryop_complex_gpu.COMPLEX_MULTIPLY.IMAG,a.shape,b.shape),inputs=[this.makeComplexComponentTensorHandle(a,aData.complexTensors.real),this.makeComplexComponentTensorHandle(a,aData.complexTensors.imag),this.makeComplexComponentTensorHandle(b,bData.complexTensors.real),this.makeComplexComponentTensorHandle(b,bData.complexTensors.imag)],real_1=this.compileAndRun(realProgram,inputs),imag_1=this.compileAndRun(imagProgram,inputs),complex_1=this.complex(real_1,imag_1);return real_1.dispose(),imag_1.dispose(),complex_1}if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.multiply(a,b);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.MUL,a.dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MUL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,a.dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.batchNormalization=function(x,mean,variance,varianceEpsilon,scale,offset){var inputs=[x,mean,variance],offsetShape=null;null!=offset&&(offsetShape=offset.shape,inputs.push(offset));var scaleShape=null;if(null!=scale&&(scaleShape=scale.shape,inputs.push(scale)),environment_1.ENV.getBool("WEBGL_PACK_NORMALIZATION")){var batchNormPackedProgram=new batchnorm_packed_gpu_1.BatchNormPackedProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(batchNormPackedProgram,inputs)}var batchNormProgram=new batchnorm_gpu_1.BatchNormProgram(x.shape,mean.shape,variance.shape,offsetShape,scaleShape,varianceEpsilon);return this.compileAndRun(batchNormProgram,inputs)},MathBackendWebGL.prototype.localResponseNormalization4D=function(x,radius,bias,alpha,beta){var program=environment_1.ENV.getBool("WEBGL_PACK_NORMALIZATION")?new lrn_packed_gpu_1.LRNPackedProgram(x.shape,radius,bias,alpha,beta):new lrn_gpu_1.LRNProgram(x.shape,radius,bias,alpha,beta);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.LRNGrad=function(dy,inputImage,outputImage,depthRadius,bias,alpha,beta){var program=new lrn_grad_gpu_1.LRNGradProgram(inputImage.shape,depthRadius,bias,alpha,beta);return this.compileAndRun(program,[inputImage,outputImage,dy])},MathBackendWebGL.prototype.tile=function(x,reps){if("string"===x.dtype){var decodedData=this.readSync(x.dataId).map(function(d){return util.decodeString(d)}),buf=array_ops_1.buffer(x.shape,x.dtype,decodedData);return tile_impl_1.tile(buf,reps)}var program=new tile_gpu_1.TileProgram(x.shape,reps);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.pad=function(x,paddings,constantValue){var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new pad_packed_gpu_1.PadPackedProgram(x.shape,paddings,constantValue):new pad_gpu_1.PadProgram(x.shape,paddings,constantValue);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.transpose=function(x,perm){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.transpose(x,perm);var program=environment_1.ENV.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new transpose_packed_gpu_1.TransposePackedProgram(x.shape,perm):new transpose_gpu_1.TransposeProgram(x.shape,perm);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.gather=function(x,indices,axis){if(this.shouldExecuteOnCPU([x,indices]))return this.cpuBackend.gather(x,indices,axis);var program=new gather_gpu_1.GatherProgram(x.shape,indices.size,axis);return this.compileAndRun(program,[x,indices])},MathBackendWebGL.prototype.batchToSpaceND=function(x,blockShape,crops){util.assert(x.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var prod=blockShape.reduce(function(a,b){return a*b}),reshaped=array_ops_util.getReshaped(x.shape,blockShape,prod),permuted=array_ops_util.getPermuted(reshaped.length,blockShape.length),reshapedPermuted=array_ops_util.getReshapedPermuted(x.shape,blockShape,prod),sliceBeginCoords=array_ops_util.getSliceBeginCoords(crops,blockShape.length),sliceSize=array_ops_util.getSliceSize(reshapedPermuted,crops,blockShape.length);return x.reshape(reshaped).transpose(permuted).reshape(reshapedPermuted).slice(sliceBeginCoords,sliceSize)},MathBackendWebGL.prototype.spaceToBatchND=function(x,blockShape,paddings){util.assert(x.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var prod=blockShape.reduce(function(a,b){return a*b}),completePaddings=[[0,0]];completePaddings.push.apply(completePaddings,paddings);for(var i=1+blockShape.length;i<x.shape.length;++i)completePaddings.push([0,0]);var paddedX=x.pad(completePaddings),reshapedPaddedShape=array_ops_util.getReshaped(paddedX.shape,blockShape,prod,!1),permutedReshapedPaddedPermutation=array_ops_util.getPermuted(reshapedPaddedShape.length,blockShape.length,!1),flattenShape=array_ops_util.getReshapedPermuted(paddedX.shape,blockShape,prod,!1);return paddedX.reshape(reshapedPaddedShape).transpose(permutedReshapedPaddedPermutation).reshape(flattenShape)},MathBackendWebGL.prototype.reduce=function(x,reduceType,dtype){var batchSize=x.shape[0],inSize=x.shape[1],reduceInfo={windowSize:reduce_util.computeOptimalWindowSize(inSize),inSize:inSize,batchSize:batchSize},program=new reduce_gpu_1.ReduceProgram(reduceInfo,reduceType),_a=program.outputShape,rows=_a[0],cols=_a[1],output=this.makeOutputArray([rows,cols],dtype);return this.compileAndRun(program,[x],output),1===output.shape[1]?output:this.reduce(output,reduceType,dtype)},MathBackendWebGL.prototype.argReduce=function(x,reduceType,bestIndicesA){void 0===bestIndicesA&&(bestIndicesA=null);var batchSize=x.shape[0],inSize=x.shape[1];null!=bestIndicesA&&(batchSize=bestIndicesA.shape[0],inSize=bestIndicesA.shape[1]);var reduceInfo={windowSize:reduce_util.computeOptimalWindowSize(inSize),inSize:inSize,batchSize:batchSize},program=new argminmax_gpu_1.ArgMinMaxProgram(reduceInfo,reduceType,null==bestIndicesA),_a=program.outputShape,rows=_a[0],cols=_a[1],output=this.makeOutputArray([rows,cols],"int32"),inputs=[x];return null!=bestIndicesA&&inputs.push(bestIndicesA),this.compileAndRun(program,inputs,output),1===output.shape[1]?output:this.argReduce(x,reduceType,output)},MathBackendWebGL.prototype.argReducePacked=function(x,reduceType,bestIndicesA){void 0===bestIndicesA&&(bestIndicesA=null);var inShape=null!=bestIndicesA?bestIndicesA.shape:x.shape,inSize=inShape[inShape.length-1],windowSize=reduce_util.computeOptimalWindowSize(inSize),program=new argminmax_packed_gpu_1.ArgMinMaxPackedProgram(inShape,windowSize,reduceType,null==bestIndicesA),output=this.makePackedTensor(program.outputShape,"int32"),inputs=null==bestIndicesA?[x]:[x,bestIndicesA];return this.compileAndRun(program,inputs,output),output.rank===x.rank?this.argReducePacked(x,reduceType,output):output},MathBackendWebGL.prototype.sum=function(x,axes){axis_util.assertAxesAreInnerMostDims("sum",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype);return this.reduce(a2D,"sum",outputDType).reshape(outShape)},MathBackendWebGL.prototype.prod=function(x,axes){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.prod(x,axes);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype);return this.reduce(a2D,"prod",outputDType).reshape(outShape)},MathBackendWebGL.prototype.unsortedSegmentSum=function(x,segmentIds,numSegments){var axis=0,permutation=axis_util.getAxesPermutation([axis],x.rank),permutedX=x;null!=permutation&&(permutedX=x.transpose(permutation),axis=axis_util.getInnerMostAxes(1,x.rank)[0]);var outShape=segment_util.computeOutShape(permutedX.shape,axis,numSegments),inSize=util.sizeFromShape([permutedX.shape[axis]]),a2D=permutedX.as2D(-1,inSize),outputDType=types_1.sumOutType(x.dtype),result=this.segOpCompute(a2D,"unsortedSegmentSum",segmentIds,outputDType,numSegments).reshape(outShape);return null!=permutation&&(result=result.transpose(axis_util.getUndoAxesPermutation(permutation))),result},MathBackendWebGL.prototype.segOpCompute=function(x,segOpType,segmentIds,dtype,numSegments){var batchSize=x.shape[0],inSize=x.shape[1],windowSize=segment_util.segOpComputeOptimalWindowSize(inSize,numSegments),segOpInfo={windowSize:windowSize,inSize:inSize,batchSize:batchSize,numSegments:numSegments},program=new segment_gpu_1.SegmentOpProgram(segOpInfo,segOpType),_a=program.outputShape,rows=_a[0],cols=_a[1],output=this.makeOutputArray([rows,cols],dtype);return this.compileAndRun(program,[x,segmentIds],output),output.shape[1]===numSegments?output:(segmentIds=tensor_ops_1.range(0,numSegments).tile([inSize/windowSize]),this.segOpCompute(output,segOpType,segmentIds,dtype,numSegments))},MathBackendWebGL.prototype.argMinMaxReduce=function(x,axis,reduceType){var axes=[axis];if(axis_util.assertAxesAreInnerMostDims("arg"+reduceType.charAt(0).toUpperCase()+reduceType.slice(1),axes,x.rank),!environment_1.ENV.getBool("WEBGL_PACK_REDUCE")||x.rank<=2){var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.argReduce(a2D,reduceType).reshape(outShape)}return this.argReducePacked(x,reduceType)},MathBackendWebGL.prototype.argMin=function(x,axis){return this.argMinMaxReduce(x,axis,"min")},MathBackendWebGL.prototype.argMax=function(x,axis){return this.argMinMaxReduce(x,axis,"max")},MathBackendWebGL.prototype.cumsum=function(x,axis,exclusive,reverse){if(axis!==x.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(x.rank-1)+" but got axis="+axis);var program=new cumsum_gpu_1.CumSumProgram(x.shape,exclusive,reverse);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.equal=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.notEqual=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.NOT_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.NOT_EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.less=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.less(a,b);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LESS,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.lessEqual=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LESS_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS_EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.greater=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.greater(a,b);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.GREATER,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.greaterEqual=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.GREATER_EQUAL,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER_EQUAL,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.logicalNot=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOGICAL_NOT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.logicalAnd=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LOGICAL_AND,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_AND,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.logicalOr=function(a,b){if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.LOGICAL_OR,"bool");var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_OR,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.select=function(condition,a,b){var program=new select_gpu_1.SelectProgram(condition.rank,a.shape,a.rank),output=this.makeOutputArray(program.outputShape,types_1.upcastType(a.dtype,b.dtype));return this.compileAndRun(program,[condition,a,b],output)},MathBackendWebGL.prototype.where=function(condition){log_1.warn("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var condVals=condition.dataSync();return where_impl_1.whereImpl(condition.shape,condVals)},MathBackendWebGL.prototype.topk=function(x,k,sorted){var xVals=x.dataSync();return topk_impl_1.topkImpl(xVals,x.shape,x.dtype,k,sorted)},MathBackendWebGL.prototype.min=function(x,axes){axis_util.assertAxesAreInnerMostDims("min",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"min",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.minimum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.minimum(a,b);var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MIN,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MIN,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.mod=function(a,b){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MOD,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MOD,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.max=function(x,axes){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.max(x,axes);axis_util.assertAxesAreInnerMostDims("max",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"max",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.maximum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.maximum(a,b);var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.MAX,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MAX,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.all=function(x,axes){axis_util.assertAxesAreInnerMostDims("all",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"all",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.any=function(x,axes){axis_util.assertAxesAreInnerMostDims("any",axes,x.rank);var _a=axis_util.computeOutAndReduceShapes(x.shape,axes),outShape=_a[0],reduceShape=_a[1],inSize=util.sizeFromShape(reduceShape),a2D=x.as2D(-1,inSize);return this.reduce(a2D,"any",a2D.dtype).reshape(outShape)},MathBackendWebGL.prototype.squaredDifference=function(a,b){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_gpu.SQUARED_DIFFERENCE,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SQUARED_DIFFERENCE,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.realDivide=function(a,b){var op=binaryop_gpu.DIV;if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")){return this.packedBinaryOp(a,b,binaryop_packed_gpu.DIV,"float32",!0)}var program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.floorDiv=function(a,b){var op=binaryop_gpu.INT_DIV;if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_packed_gpu.INT_DIV,"int32");var program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,"int32");return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.add=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,binaryop_gpu.ADD);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.add(a,b);var dtype=types_1.upcastType(a.dtype,b.dtype);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.ADD,dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ADD,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.packedBinaryOp=function(a,b,op,dtype,checkOutOfBounds){void 0===checkOutOfBounds&&(checkOutOfBounds=!1);var program=new binaryop_packed_gpu_1.BinaryOpPackedProgram(op,a.shape,b.shape,checkOutOfBounds),output=this.makePackedTensor(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.complexSeparableBinaryOp=function(a,b,op){var _this=this,aData=this.texData.get(a.dataId),bData=this.texData.get(b.dataId),_a=[[aData.complexTensors.real,bData.complexTensors.real],[aData.complexTensors.imag,bData.complexTensors.imag]].map(function(complexParts){var aPart=complexParts[0],bPart=complexParts[1],aHandle=_this.makeComplexComponentTensorHandle(a,aPart),bHandle=_this.makeComplexComponentTensorHandle(b,bPart),program=new binaryop_gpu_1.BinaryOpProgram(op,a.shape,b.shape),output=_this.makeOutputArray(program.outputShape,types_1.upcastType(aPart.dtype,bPart.dtype));return _this.compileAndRun(program,[aHandle,bHandle],output)}),real=_a[0],imag=_a[1],complex=this.complex(real,imag);return real.dispose(),imag.dispose(),complex},MathBackendWebGL.prototype.makeComplexComponentTensorHandle=function(complexTensor,complexPart){return{dataId:complexPart.dataId,dtype:complexPart.dtype,shape:complexTensor.shape}},MathBackendWebGL.prototype.addN=function(tensors){if(1===tensors.length)return tensors[0];if(tensors.length>environment_1.ENV.get("WEBGL_MAX_TEXTURES_IN_SHADER")){var midIndex=Math.floor(tensors.length/2),leftSide=this.addN(tensors.slice(0,midIndex)),rightSide=this.addN(tensors.slice(midIndex));return this.addN([leftSide,rightSide])}var dtype=tensors.map(function(t){return t.dtype}).reduce(function(d1,d2){return types_1.upcastType(d1,d2)}),shapes=tensors.map(function(t){return t.shape}),usePackedOp=environment_1.ENV.getBool("WEBGL_PACK"),program=usePackedOp?new addn_packed_gpu_1.AddNPackedProgram(tensors[0].shape,shapes):new addn_gpu_1.AddNProgram(tensors[0].shape,shapes),output=usePackedOp?this.makePackedTensor(program.outputShape,dtype):this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,tensors,output)},MathBackendWebGL.prototype.subtract=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,binaryop_gpu.SUB);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.subtract(a,b);var dtype=types_1.upcastType(a.dtype,b.dtype);if(environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,binaryop_gpu.SUB,a.dtype);var program=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SUB,a.shape,b.shape),output=this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.pow=function(a,b){var usePackedOp=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS"),program=usePackedOp?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.POW,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.POW,a.shape,b.shape),dtype=types_1.upcastType(a.dtype,b.dtype),output=usePackedOp?this.makePackedTensor(program.outputShape,dtype):this.makeOutputArray(program.outputShape,dtype);return this.compileAndRun(program,[a,b],output)},MathBackendWebGL.prototype.ceil=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.CEIL);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.floor=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.FLOOR);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sign=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIGN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.isNaN=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_NAN),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.isInf=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_INF),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.isFinite=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.IS_FINITE),output=this.makeOutputArray(program.outputShape,"bool");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.round=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ROUND);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.exp=function(x){var program;return program=environment_1.ENV.getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_op.EXP):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.EXP),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.expm1=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.EXPM1);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.log=function(x){var program;return program=environment_1.ENV.getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_packed_op.LOG):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOG),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.log1p=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.LOG1P);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sqrt=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SQRT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.rsqrt=function(x){if(this.shouldExecuteOnCPU([x]))return this.cpuBackend.rsqrt(x);var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RSQRT);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.square=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SQUARE);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.reciprocal=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RECIPROCAL);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.relu=function(x){var program;return program=environment_1.ENV.getBool("WEBGL_PACK")?new unaryop_packed_gpu_1.UnaryOpPackedProgram(x.shape,unary_packed_op.RELU):new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.RELU),this.compileAndRun(program,[x])},MathBackendWebGL.prototype.prelu=function(x,alpha){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.PRELU,x.shape,alpha.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU,x.shape,alpha.shape);return this.compileAndRun(program,[x,alpha])},MathBackendWebGL.prototype.elu=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ELU);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.eluDer=function(dy,y){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.ELU_DER,dy.shape,y.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ELU_DER,dy.shape,y.shape);return this.compileAndRun(program,[dy,y])},MathBackendWebGL.prototype.selu=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SELU);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.int=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TO_INT),output=this.makeOutputArray(program.outputShape,"int32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.clip=function(x,min,max){var program,customSetup=(program=environment_1.ENV.getBool("WEBGL_PACK_CLIP")?new clip_packed_gpu_1.ClipPackedProgram(x.shape):new clip_gpu_1.ClipProgram(x.shape)).getCustomSetupFunc(min,max);return this.compileAndRun(program,[x],null,customSetup)},MathBackendWebGL.prototype.abs=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ABS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.complexAbs=function(x){var xData=this.texData.get(x.dataId),program=new complex_abs_gpu_1.ComplexAbsProgram(x.shape),inputs=[this.makeComplexComponentTensorHandle(x,xData.complexTensors.real),this.makeComplexComponentTensorHandle(x,xData.complexTensors.imag)];return this.compileAndRun(program,inputs)},MathBackendWebGL.prototype.sigmoid=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIGMOID);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.softplus=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SOFTPLUS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.sin=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SIN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.cos=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.COS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.tan=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TAN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.asin=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ASIN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.acos=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ACOS);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atan=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ATAN);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atan2=function(a,b){var program=environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new binaryop_packed_gpu_1.BinaryOpPackedProgram(binaryop_packed_gpu.ATAN2,a.shape,b.shape):new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ATAN2,a.shape,b.shape);return this.compileAndRun(program,[a,b])},MathBackendWebGL.prototype.sinh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.SINH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.cosh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.COSH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.tanh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.TANH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.asinh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ASINH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.acosh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ACOSH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.atanh=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ATANH);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.erf=function(x){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.ERF);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.step=function(x,alpha){var program=new unaryop_gpu_1.UnaryOpProgram(x.shape,unary_op.STEP(alpha));return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.conv2dByMatMul=function(x,filter,convInfo,bias,activation,preluActivationWeights){var xShape=x.shape,xTexData=this.texData.get(x.dataId),sharedMatMulDim=convInfo.inChannels,outerShapeX=xShape[0]*xShape[1]*xShape[2],outerShapeFilter=convInfo.outChannels,isChannelsLast="channelsLast"===convInfo.dataFormat,batchMatMulWillBeUnpacked=(1==outerShapeX||1===outerShapeFilter)&&sharedMatMulDim>exports.MATMUL_SHARED_DIM_THRESHOLD,reshapeWillBeExpensive=xShape[2]%2!=0&&!!xTexData.isPacked;if(batchMatMulWillBeUnpacked||!environment_1.ENV.getBool("WEBGL_LAZILY_UNPACK")||!environment_1.ENV.getBool("WEBGL_PACK_BINARY_OPERATIONS")||!reshapeWillBeExpensive){var targetShape_1=isChannelsLast?xShape[0]*xShape[1]*xShape[2]:xShape[0]*xShape[2]*xShape[3],xReshaped_1=this.reshape(x,[1,targetShape_1,convInfo.inChannels]),filterReshaped_1=this.reshape(filter,[1,convInfo.inChannels,convInfo.outChannels]);return this.reshape(this.fusedBatchMatMul({a:xReshaped_1,b:filterReshaped_1,transposeA:!1,transposeB:!1,bias:bias,activation:activation,preluActivationWeights:preluActivationWeights}),convInfo.outShape)}var targetShape=isChannelsLast?xShape[0]*xShape[1]*(xShape[2]+1):xShape[0]*xShape[2]*(xShape[3]+1),xReshaped=tensor_1.Tensor.make([1,targetShape,convInfo.inChannels],{dataId:x.dataId},x.dtype,this),originalXTexDataShape=xTexData.shape;xTexData.shape=xTexData.shape.slice(),xTexData.shape[xTexData.shape.length-2]++,util.assert(webgl_util.isReshapeFree(xTexData.shape,xReshaped.shape),function(){return"packed reshape "+xTexData.shape+" to "+xReshaped.shape+" isn't free"});var filterReshaped=this.reshape(filter,[1,convInfo.inChannels,convInfo.outChannels]),pointwiseConv=this.fusedBatchMatMul({a:xReshaped,b:filterReshaped,transposeA:!1,transposeB:!1,bias:bias,activation:activation,preluActivationWeights:preluActivationWeights}),pointwiseConvTexData=this.texData.get(pointwiseConv.dataId);return util.assert(pointwiseConvTexData.isPacked,function(){return"batchMatMul result is expected to be packed"}),xTexData.shape=originalXTexDataShape,pointwiseConvTexData.shape=convInfo.outShape,tensor_1.Tensor.make(convInfo.outShape,{dataId:pointwiseConv.dataId},pointwiseConv.dtype,this)},MathBackendWebGL.prototype.conv2dWithIm2Row=function(x,filter,convInfo,bias,activation,preluActivationWeights){var filterWidth=convInfo.filterWidth,filterHeight=convInfo.filterHeight,inChannels=convInfo.inChannels,outWidth=convInfo.outWidth,outHeight=convInfo.outHeight,isChannelsLast="channelsLast"===convInfo.dataFormat,sharedDim=filterWidth*filterHeight*inChannels,numCols=outHeight*outWidth,x2ColShape=[sharedDim,numCols],xSqueezed=x.squeeze([0]),w2Row=filter.reshape([1,sharedDim,-1]),im2ColProgram=new im2col_packed_gpu_1.Im2ColPackedProgram(x2ColShape,xSqueezed.shape,convInfo),im2Col=this.compileAndRun(im2ColProgram,[xSqueezed]).reshape([1,x2ColShape[0],x2ColShape[1]]),hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!0):null,matmulProgram=new mulmat_packed_gpu_1.MatMulPackedProgram(im2Col.shape,[1,numCols,convInfo.outChannels],!0,!1,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[im2Col,w2Row];bias&&inputs.push(bias),hasPreluActivationWeights&&inputs.push(preluActivationWeights);var product=this.compileAndRun(matmulProgram,inputs);return isChannelsLast?product.reshape([1,outHeight,outWidth,convInfo.outChannels]):product.reshape([1,convInfo.outChannels,outHeight,outWidth])},MathBackendWebGL.prototype.fusedConv2d=function(x,filter,convInfo,bias,activation,preluActivationWeights){if(1===convInfo.filterHeight&&1===convInfo.filterWidth&&1===convInfo.dilationHeight&&1===convInfo.dilationWidth&&1===convInfo.strideHeight&&1===convInfo.strideWidth&&("SAME"===convInfo.padInfo.type||"VALID"===convInfo.padInfo.type))return this.conv2dByMatMul(x,filter,convInfo,bias,activation,preluActivationWeights);if(environment_1.ENV.getBool("WEBGL_CONV_IM2COL")&&1===x.shape[0])return this.conv2dWithIm2Row(x,filter,convInfo,bias,activation,preluActivationWeights);var hasBias=null!=bias,hasPreluActivationWeights=null!=preluActivationWeights,fusedActivation=activation?mapActivationToShaderProgram(activation,!1):null,program=new conv_gpu_1.Conv2DProgram(convInfo,hasBias,fusedActivation,hasPreluActivationWeights),inputs=[x,filter];return bias&&inputs.push(bias),preluActivationWeights&&inputs.push(preluActivationWeights),this.compileAndRun(program,inputs)},MathBackendWebGL.prototype.conv2d=function(x,filter,convInfo){if(1===convInfo.filterHeight&&1===convInfo.filterWidth&&1===convInfo.dilationHeight&&1===convInfo.dilationWidth&&1===convInfo.strideHeight&&1===convInfo.strideWidth&&("SAME"===convInfo.padInfo.type||"VALID"===convInfo.padInfo.type))return this.conv2dByMatMul(x,filter,convInfo);if(environment_1.ENV.getBool("WEBGL_CONV_IM2COL")&&1===x.shape[0])return this.conv2dWithIm2Row(x,filter,convInfo);var program=new conv_gpu_1.Conv2DProgram(convInfo);return this.compileAndRun(program,[x,filter])},MathBackendWebGL.prototype.conv2dDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.conv2dDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_1.Conv2DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.depthwiseConv2D=function(x,filter,convInfo){var program;return environment_1.ENV.getBool("WEBGL_PACK_DEPTHWISECONV")&&convInfo.strideWidth<=2&&convInfo.outChannels/convInfo.inChannels==1?(program=new conv_packed_gpu_depthwise_1.DepthwiseConvPacked2DProgram(convInfo),this.compileAndRun(program,[x,filter],this.makePackedTensor(convInfo.outShape,x.dtype))):(program=new conv_gpu_depthwise_1.DepthwiseConv2DProgram(convInfo),this.compileAndRun(program,[x,filter]))},MathBackendWebGL.prototype.depthwiseConv2DDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_depthwise_1.DepthwiseConv2DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.depthwiseConv2DDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_depthwise_1.DepthwiseConv2DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.conv3d=function(x,filter,convInfo){var program=new conv_gpu_1.Conv3DProgram(convInfo);return this.compileAndRun(program,[x,filter])},MathBackendWebGL.prototype.conv3dDerInput=function(dy,filter,convInfo){var program=new conv_backprop_gpu_1.Conv3DDerInputProgram(convInfo);return this.compileAndRun(program,[dy,filter])},MathBackendWebGL.prototype.conv3dDerFilter=function(x,dy,convInfo){var program=new conv_backprop_gpu_1.Conv3DDerFilterProgram(convInfo);return this.compileAndRun(program,[x,dy])},MathBackendWebGL.prototype.maxPool=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"max",!1),output=this.makeOutputArray(program.outputShape,x.dtype);return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.avgPool=function(x,convInfo){var program=new pool_gpu_1.Pool2DProgram(convInfo,"avg",!1),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.maxPoolBackprop=function(dy,x,y,convInfo){var maxPoolPositionsProgram=new pool_gpu_1.Pool2DProgram(convInfo,"max",!0),maxPoolPositions=this.compileAndRun(maxPoolPositionsProgram,[x]),maxPoolBackPropProgram=new max_pool_backprop_gpu_1.MaxPool2DBackpropProgram(convInfo),output=this.makeOutputArray(maxPoolBackPropProgram.outputShape,x.dtype),result=this.compileAndRun(maxPoolBackPropProgram,[dy,maxPoolPositions],output);return maxPoolPositions.dispose(),result},MathBackendWebGL.prototype.avgPoolBackprop=function(dy,x,convInfo){var avgPoolBackpropProgram=new avg_pool_backprop_gpu_1.AvgPool2DBackpropProgram(convInfo),output=this.makeOutputArray(avgPoolBackpropProgram.outputShape,x.dtype);return this.compileAndRun(avgPoolBackpropProgram,[dy],output)},MathBackendWebGL.prototype.cast=function(x,dtype){return backend_util.castTensor(x,dtype,this)},MathBackendWebGL.prototype.unstack=function(x,axis){for(var num=x.shape[axis],outShape=new Array(x.rank-1),outIndex=0,i=0;i<x.rank;i++)i!==axis&&(outShape[outIndex++]=x.shape[i]);var begin=new Array(x.rank).fill(0),size=x.shape.slice();size[axis]=1;var res=new Array(num);for(i=0;i<res.length;i++)res[begin[axis]=i]=this.slice(x,begin,size).reshape(outShape);return res},MathBackendWebGL.prototype.avgPool3d=function(x,convInfo){var program=new pool_gpu_1.Pool3DProgram(convInfo,"avg",!1),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.avgPool3dBackprop=function(dy,x,convInfo){var avgPool3dBackpropProgram=new avg_pool_backprop_gpu_1.AvgPool3DBackpropProgram(convInfo),output=this.makeOutputArray(avgPool3dBackpropProgram.outputShape,x.dtype);return this.compileAndRun(avgPool3dBackpropProgram,[dy],output)},MathBackendWebGL.prototype.maxPool3d=function(x,convInfo){var program=new pool_gpu_1.Pool3DProgram(convInfo,"max",!1),output=this.makeOutputArray(program.outputShape,"float32");return this.compileAndRun(program,[x],output)},MathBackendWebGL.prototype.maxPool3dBackprop=function(dy,x,y,convInfo){var maxPool3dPositionsProgram=new pool_gpu_1.Pool3DProgram(convInfo,"max",!0),maxPool3dPositions=this.compileAndRun(maxPool3dPositionsProgram,[x]),maxPool3dBackPropProgram=new max_pool_backprop_gpu_1.MaxPool3DBackpropProgram(convInfo),output=this.makeOutputArray(maxPool3dBackPropProgram.outputShape,x.dtype),result=this.compileAndRun(maxPool3dBackPropProgram,[dy,maxPool3dPositions],output);return maxPool3dPositions.dispose(),result},MathBackendWebGL.prototype.reshape=function(x,shape){var texData=this.texData.get(x.dataId);return!texData.isPacked||webgl_util.isReshapeFree(x.shape,shape)||null!==texData.texture&&webgl_util.isReshapeFree(texData.shape,shape)?backend_util.reshapeTensor(x,shape):this.packedReshape(x,shape)},MathBackendWebGL.prototype.resizeBilinear=function(x,newHeight,newWidth,alignCorners){var program=environment_1.ENV.getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new resize_bilinear_packed_gpu_1.ResizeBilinearPackedProgram(x.shape,newHeight,newWidth,alignCorners):new resize_bilinear_gpu_1.ResizeBilinearProgram(x.shape,newHeight,newWidth,alignCorners);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.resizeBilinearBackprop=function(dy,x,alignCorners){var program=new resize_bilinear_backprop_gpu_1.ResizeBilinearBackpropProgram(dy,x,alignCorners);return this.compileAndRun(program,[dy])},MathBackendWebGL.prototype.resizeNearestNeighbor=function(x,newHeight,newWidth,alignCorners){var program=new resize_nearest_neighbor_gpu_1.ResizeNearestNeighborProgram(x.shape,newHeight,newWidth,alignCorners);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.resizeNearestNeighborBackprop=function(dy,x,alignCorners){var program=new resize_nearest_neighbor_backprop_gpu_1.ResizeNearestNeigborBackpropProgram(dy,x,alignCorners);return this.compileAndRun(program,[dy])},MathBackendWebGL.prototype.multinomial=function(logits,normalized,numSamples,seed){var probs=normalized?logits:softmax_1.softmax(logits),batchSize=probs.shape[0],numOutcomes=probs.shape[1],program=new multinomial_gpu_1.MultinomialProgram(batchSize,numOutcomes,numSamples),output=this.makeOutputArray(program.outputShape,"int32"),customSetup=program.getCustomSetupFunc(seed);return this.compileAndRun(program,[probs],output,customSetup)},MathBackendWebGL.prototype.oneHot=function(indices,depth,onValue,offValue){var program=new onehot_gpu_1.OneHotProgram(indices.size,depth,onValue,offValue);return this.compileAndRun(program,[indices])},MathBackendWebGL.prototype.diag=function(x){var program=new diag_gpu_1.DiagProgram(x.size);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.nonMaxSuppression=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){log_1.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var boxesVals=boxes.dataSync(),scoresVals=scores.dataSync();return non_max_suppression_impl_1.nonMaxSuppressionImpl(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold)},MathBackendWebGL.prototype.cropAndResize=function(image,boxes,boxIndex,cropSize,method,extrapolationValue){var program=new crop_and_resize_gpu_1.CropAndResizeProgram(image.shape,boxes.shape,cropSize,method,extrapolationValue);return this.compileAndRun(program,[image,boxes,boxIndex])},MathBackendWebGL.prototype.depthToSpace=function(x,blockSize,dataFormat){util.assert(1<blockSize,function(){return"blockSize should be > 1 for depthToSpace, but was: "+blockSize});var batchSize=x.shape[0],inputHeight="NHWC"===dataFormat?x.shape[1]:x.shape[2],inputWidth="NHWC"===dataFormat?x.shape[2]:x.shape[3],inputDepth="NHWC"===dataFormat?x.shape[3]:x.shape[1],outputHeight=inputHeight*blockSize,outputWidth=inputWidth*blockSize,outputDepth=inputDepth/(blockSize*blockSize),outputShape="NHWC"===dataFormat?[batchSize,outputHeight,outputWidth,outputDepth]:[batchSize,outputDepth,outputHeight,outputWidth],program=new depth_to_space_gpu_1.DepthToSpaceProgram(outputShape,blockSize,dataFormat);return this.compileAndRun(program,[x])},MathBackendWebGL.prototype.split=function(x,sizeSplits,axis){return split_shared_1.split(x,sizeSplits,axis)},MathBackendWebGL.prototype.scatterND=function(indices,updates,shape){var _a=scatter_nd_util.calculateShapes(updates,indices,shape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,sliceSize=_a.sliceSize,strides=_a.strides,outputSize=_a.outputSize,flattenShape=[outputSize/sliceSize,sliceSize],flattenIndices=indices.reshape([numUpdates,sliceRank]),flattenX=updates.reshape([numUpdates,sliceSize]);if(0===outputSize)return backend_util.reshapeTensor(tensor_ops_1.tensor([]),shape);var defaultValue=tensor_ops_1.scalar(0),program=new scatter_gpu_1.ScatterProgram(numUpdates,sliceRank,flattenIndices.rank,flattenX.rank,strides,flattenShape);return this.compileAndRun(program,[flattenX,flattenIndices,defaultValue]).reshape(shape)},MathBackendWebGL.prototype.sparseToDense=function(sparseIndices,sparseValues,outputShape,defaultValue){var _a=scatter_nd_util.calculateShapes(sparseValues,sparseIndices,outputShape),sliceRank=_a.sliceRank,numUpdates=_a.numUpdates,strides=_a.strides,outputSize=_a.outputSize,program=new scatter_gpu_1.ScatterProgram(numUpdates,sliceRank,sparseIndices.rank,sparseValues.rank,strides,[outputSize,1],!1);return this.compileAndRun(program,[sparseValues,sparseIndices,defaultValue]).reshape(outputShape)},MathBackendWebGL.prototype.fft=function(x){return this.fftImpl(x,!1)},MathBackendWebGL.prototype.ifft=function(x){return this.fftImpl(x,!0)},MathBackendWebGL.prototype.fftImpl=function(x,inverse){var xData=this.texData.get(x.dataId),realProgram=new fft_gpu_1.FFTProgram(fft_gpu.COMPLEX_FFT.REAL,x.shape,inverse),imagProgram=new fft_gpu_1.FFTProgram(fft_gpu.COMPLEX_FFT.IMAG,x.shape,inverse),inputs=[this.makeComplexComponentTensorHandle(x,xData.complexTensors.real),this.makeComplexComponentTensorHandle(x,xData.complexTensors.imag)],real=this.compileAndRun(realProgram,inputs),imag=this.compileAndRun(imagProgram,inputs),complex=this.complex(real,imag).as2D(x.shape[0],x.shape[1]);return real.dispose(),imag.dispose(),complex},MathBackendWebGL.prototype.gatherND=function(x,indices){var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],_a=gather_nd_util.prepareAndValidate(x,indices),resultShape=_a[0],numSlices=_a[1],sliceSize=_a[2],strides=_a[3],flattenIndices=indices.reshape([numSlices,sliceRank]),flattenX=x.reshape([x.size/sliceSize,sliceSize]),program=new gather_nd_gpu_1.GatherNDProgram(sliceRank,strides,[numSlices,sliceSize]);return this.compileAndRun(program,[flattenX,flattenIndices]).reshape(resultShape)},MathBackendWebGL.prototype.fill=function(shape,value,dtype){if("string"===(dtype=dtype||util_1.inferDtype(value))){var values=util_1.getArrayFromDType(dtype,util_1.sizeFromShape(shape));return values.fill(value),tensor_1.Tensor.make(shape,{values:values},dtype)}var program=new fill_gpu_1.FillProgram(shape,value),customSetup=program.getCustomSetupFunc(value),output=this.makeOutputArray(shape,dtype);return this.compileAndRun(program,[],output,customSetup)},MathBackendWebGL.prototype.onesLike=function(x){if("string"===x.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(x.shape,1,x.dtype)},MathBackendWebGL.prototype.zerosLike=function(x){return this.fill(x.shape,"string"===x.dtype?"":0,x.dtype)},MathBackendWebGL.prototype.linspace=function(start,stop,num){return backend_util.linspaceImpl(start,stop,num)},MathBackendWebGL.prototype.makeOutputArray=function(shape,dtype){return tensor_1.Tensor.make(shape,{},dtype,this)},MathBackendWebGL.prototype.makePackedTensor=function(shape,dtype){var packedTensor=tensor_1.Tensor.make(shape,{},dtype,this);return this.texData.get(packedTensor.dataId).isPacked=!0,packedTensor},MathBackendWebGL.prototype.unpackTensor=function(input){var program=new unpack_gpu_1.UnpackProgram(input.shape);return this.compileAndRun(program,[input],tensor_1.Tensor.make(program.outputShape,{},input.dtype,this))},MathBackendWebGL.prototype.packTensor=function(input){var program=new pack_gpu_1.PackProgram(input.shape);return this.compileAndRun(program,[input],this.makePackedTensor(input.shape,input.dtype),null,!0)},MathBackendWebGL.prototype.packedReshape=function(input,afterShape){var inputAs3D=input.reshape([webgl_util.getBatchDim(input.shape)].concat(webgl_util.getRowsCols(input.shape))),afterShapeAs3D=[webgl_util.getBatchDim(afterShape)].concat(webgl_util.getRowsCols(afterShape)),program=new reshape_packed_gpu_1.ReshapePackedProgram(afterShapeAs3D,inputAs3D.shape);return this.compileAndRun(program,[inputAs3D]).reshape(afterShape)},MathBackendWebGL.prototype.decode=function(dataId){var program,texData=this.texData.get(dataId),isPacked=texData.isPacked,shape=texData.shape,dtype=texData.dtype,shapeAs3D=webgl_util.getShapeAs3D(shape),denseTexShape=tex_util.getDenseTexShape(shape),tmpTarget=this.makeTensorHandle(shape,"float32");return this.texData.get(tmpTarget.dataId).isPacked=!0,this.texData.get(tmpTarget.dataId).dtype=dtype,this.texData.get(tmpTarget.dataId).texShape=denseTexShape.map(function(d){return 2*d}),program=isPacked?new decode_matrix_packed_gpu_1.DecodeMatrixPackedProgram(shapeAs3D,denseTexShape):new decode_matrix_gpu_1.DecodeMatrixProgram(shapeAs3D,denseTexShape),this.compileAndRun(program,[{shape:shapeAs3D,dtype:dtype,dataId:dataId}],tmpTarget,null,!0),tmpTarget},MathBackendWebGL.prototype.compileAndRun=function(program,inputs,output,customSetup,preventEagerUnpackingOfOutput){var _this=this;if(void 0===preventEagerUnpackingOfOutput&&(preventEagerUnpackingOfOutput=!1),null==output&&(output=program.usesPackedTextures?this.makePackedTensor(program.outputShape,inputs[0].dtype):this.makeOutputArray(program.outputShape,inputs[0].dtype)),0===output.size)return this.texData.get(output.dataId).values=util_1.getTypedArrayFromDType(output.dtype,0),output;var inputsData=inputs.map(function(input){if("complex64"===input.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var texData=_this.texData.get(input.dataId);if(null==texData.texture){if(!program.usesPackedTextures&&util.sizeFromShape(input.shape)<=environment_1.ENV.getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:input.shape,texData:null,isUniform:!0,uniformValues:texData.values};program.usesPackedTextures&&(texData.isPacked=!0,texData.shape=input.shape)}else if(!!texData.isPacked!=!!program.usesPackedTextures)input=texData.isPacked?_this.unpackTensor(input):_this.packTensor(input),texData=_this.texData.get(input.dataId);else if(texData.isPacked&&!webgl_util.isReshapeFree(texData.shape,input.shape)){var savedInput=input,targetShape=input.shape;input.shape=texData.shape,input=_this.packedReshape(input,targetShape),texData=_this.texData.get(input.dataId),savedInput.shape=targetShape}return _this.uploadToGPU(input.dataId),{shape:input.shape,texData:texData,isUniform:!1}});this.uploadToGPU(output.dataId);var query,outputData={shape:output.shape,texData:this.texData.get(output.dataId),isUniform:!1},key=gpgpu_math.makeShaderKey(program,inputsData,outputData),binary=this.getAndSaveBinary(key,function(){return gpgpu_math.compileProgram(_this.gpgpu,program,inputsData,outputData)}),shouldTimeProgram=null!=this.activeTimers;return shouldTimeProgram&&(query=this.startTimer()),gpgpu_math.runProgram(this.gpgpu,binary,inputsData,outputData,customSetup),shouldTimeProgram&&(query=this.endTimer(query),this.activeTimers.push({name:program.constructor.name,query:this.getQueryTime(query)})),!environment_1.ENV.getBool("WEBGL_LAZILY_UNPACK")&&this.texData.get(output.dataId).isPacked&&!1===preventEagerUnpackingOfOutput?this.unpackTensor(output):output},MathBackendWebGL.prototype.getAndSaveBinary=function(key,getBinary){return key in this.binaryCache||(this.binaryCache[key]=getBinary()),this.binaryCache[key]},MathBackendWebGL.prototype.getTextureManager=function(){return this.textureManager},MathBackendWebGL.prototype.dispose=function(){this.disposed||(this.textureManager.dispose(),null!=this.canvas&&null!=this.canvas.remove?this.canvas.remove():this.canvas=null,null!=this.fromPixels2DContext&&this.fromPixels2DContext.canvas.remove&&this.fromPixels2DContext.canvas.remove(),this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},MathBackendWebGL.prototype.floatPrecision=function(){var _this=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=globals_1.tidy(function(){var debugFlag=environment_1.ENV.getBool("DEBUG");environment_1.ENV.set("DEBUG",!1);var underflowCheckValue=_this.abs(tensor_ops_1.scalar(1e-8)).dataSync()[0];return environment_1.ENV.set("DEBUG",debugFlag),0<underflowCheckValue?32:16})),this.floatPrecisionValue},MathBackendWebGL.prototype.epsilon=function(){return 32===this.floatPrecision()?backend_1.EPSILON_FLOAT32:backend_1.EPSILON_FLOAT16},MathBackendWebGL.prototype.uploadToGPU=function(dataId){var _a,texData=this.texData.get(dataId),shape=texData.shape,dtype=texData.dtype,values=texData.values,texture=texData.texture,usage=texData.usage,isPacked=texData.isPacked;if(null==texture){var start,shouldTimeProgram=null!=this.activeTimers;shouldTimeProgram&&(start=util.now());var texShape=texData.texShape;if(null==texShape&&(texShape=webgl_util.getTextureShapeFromLogicalShape(shape,isPacked),texData.texShape=texShape),null!=values){var shapeAs3D=webgl_util.getShapeAs3D(shape),program=void 0,width=texShape[1],height=texShape[0],isByteArray=values instanceof Uint8Array;program=isPacked?(width=(_a=tex_util.getPackedMatrixTextureShapeWidthHeight(texShape[0],texShape[1]))[0],height=_a[1],new encode_matrix_packed_gpu_1.EncodeMatrixPackedProgram(shapeAs3D,[height,width],isByteArray)):new encode_matrix_gpu_1.EncodeMatrixProgram(shapeAs3D,[height,width],isByteArray);var tempDenseInputHandle=this.makeTensorHandle([height,width],dtype);this.texData.get(tempDenseInputHandle.dataId).usage=isByteArray?tex_util_1.TextureUsage.PIXELS:tex_util_1.TextureUsage.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(tempDenseInputHandle.dataId),width,height,values);var encodedOutputTarget=this.makeTensorHandle(program.outputShape,tempDenseInputHandle.dtype);encodedOutputTarget.size=util_1.sizeFromShape(program.outputShape),this.texData.get(encodedOutputTarget.dataId).isPacked=isPacked,this.compileAndRun(program,[tempDenseInputHandle],encodedOutputTarget);var outputTexData=this.texData.get(encodedOutputTarget.dataId);texData.texture=outputTexData.texture,texData.texShape=outputTexData.texShape,texData.isPacked=outputTexData.isPacked,texData.usage=outputTexData.usage,this.disposeData(tempDenseInputHandle.dataId),this.texData.delete(encodedOutputTarget.dataId),texData.values=null,shouldTimeProgram&&(this.uploadWaitMs+=util.now()-start)}else{var newTexture=this.acquireTexture(texShape,usage,dtype,isPacked);texData.texture=newTexture}}},MathBackendWebGL.prototype.convertAndCacheOnCPU=function(dataId,float32Values){var texData=this.texData.get(dataId),dtype=texData.dtype;return this.releaseGPUData(dataId),null!=float32Values&&(texData.values=function(a,dtype){{if("float32"===dtype||"complex64"===dtype)return a;if("int32"!==dtype&&"bool"!==dtype)throw new Error("Unknown dtype "+dtype);for(var result="int32"===dtype?new Int32Array(a.length):new Uint8Array(a.length),i=0;i<result.length;++i)result[i]=Math.round(a[i]);return result}}(float32Values,dtype)),texData.values},MathBackendWebGL.prototype.acquireTexture=function(texShape,texType,dtype,isPacked){if(this.numBytesInGPU+=this.computeBytes(texShape,dtype),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var mb=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+mb+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(texShape,texType,isPacked)},MathBackendWebGL.prototype.computeBytes=function(shape,dtype){return shape[0]*shape[1]*util.bytesPerElement(dtype)},MathBackendWebGL}();exports.MathBackendWebGL=MathBackendWebGL,device_util.isBrowser()&&engine_1.ENGINE.registerBackend("webgl",function(){return new MathBackendWebGL},2)},{"../../device_util":142,"../../engine":143,"../../environment":144,"../../globals":146,"../../log":161,"../../ops/array_ops":163,"../../ops/array_ops_util":164,"../../ops/axis_util":165,"../../ops/complex_ops":172,"../../ops/concat_util":174,"../../ops/gather_nd_util":184,"../../ops/reduce_util":199,"../../ops/scatter_nd_util":204,"../../ops/segment_util":206,"../../ops/slice_util":210,"../../ops/softmax":211,"../../ops/tensor_ops":216,"../../tensor":234,"../../types":240,"../../util":241,"../backend":50,"../backend_util":51,"../complex_util":52,"../non_max_suppression_impl":54,"../split_shared":56,"../tile_impl":57,"../topk_impl":58,"../where_impl":140,"./addn_gpu":59,"./addn_packed_gpu":60,"./argminmax_gpu":61,"./argminmax_packed_gpu":62,"./avg_pool_backprop_gpu":63,"./batchnorm_gpu":65,"./batchnorm_packed_gpu":66,"./binaryop_complex_gpu":67,"./binaryop_gpu":68,"./binaryop_packed_gpu":69,"./canvas_util":70,"./clip_gpu":71,"./clip_packed_gpu":72,"./complex_abs_gpu":73,"./concat_gpu":74,"./concat_packed_gpu":75,"./conv_backprop_gpu":76,"./conv_backprop_gpu_depthwise":77,"./conv_gpu":78,"./conv_gpu_depthwise":79,"./conv_packed_gpu_depthwise":80,"./crop_and_resize_gpu":81,"./cumsum_gpu":82,"./decode_matrix_gpu":83,"./decode_matrix_packed_gpu":84,"./depth_to_space_gpu":85,"./diag_gpu":86,"./encode_float_gpu":87,"./encode_float_packed_gpu":88,"./encode_matrix_gpu":89,"./encode_matrix_packed_gpu":90,"./fft_gpu":91,"./fill_gpu":92,"./flags_webgl":93,"./from_pixels_gpu":94,"./from_pixels_packed_gpu":95,"./gather_gpu":96,"./gather_nd_gpu":97,"./gpgpu_context":99,"./gpgpu_math":100,"./im2col_packed_gpu":102,"./lrn_gpu":103,"./lrn_grad_gpu":104,"./lrn_packed_gpu":105,"./max_pool_backprop_gpu":106,"./mulmat_packed_gpu":107,"./multinomial_gpu":108,"./onehot_gpu":109,"./pack_gpu":110,"./pad_gpu":111,"./pad_packed_gpu":112,"./pool_gpu":113,"./reduce_gpu":114,"./reshape_packed_gpu":115,"./resize_bilinear_backprop_gpu":116,"./resize_bilinear_gpu":117,"./resize_bilinear_packed_gpu":118,"./resize_nearest_neighbor_backprop_gpu":119,"./resize_nearest_neighbor_gpu":120,"./reverse_gpu":121,"./reverse_packed_gpu":122,"./scatter_gpu":123,"./segment_gpu":124,"./select_gpu":125,"./slice_gpu":128,"./slice_packed_gpu":129,"./strided_slice_gpu":130,"./tex_util":131,"./texture_manager":132,"./tile_gpu":133,"./transpose_gpu":134,"./transpose_packed_gpu":135,"./unaryop_gpu":136,"./unaryop_packed_gpu":137,"./unpack_gpu":138,"./webgl_util":139}],65:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function BatchNormProgram(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.outputShape=[],this.variableNames=["x","mean","variance"],broadcast_util.assertAndGetBroadcastShape(xShape,meanShape),broadcast_util.assertAndGetBroadcastShape(xShape,varianceShape);var offsetSnippet="0.0";null!=offsetShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="1.0";null!=scaleShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.outputShape=xShape,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+offsetSnippet+";\n        float scale = "+scaleSnippet+";\n        float inv = scale * inversesqrt(variance + float("+varianceEpsilon+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "}var broadcast_util=require("../../ops/broadcast_util");exports.BatchNormProgram=BatchNormProgram},{"../../ops/broadcast_util":169}],66:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function BatchNormPackedProgram(xShape,meanShape,varianceShape,offsetShape,scaleShape,varianceEpsilon){this.usesPackedTextures=!0,this.variableNames=["x","mean","variance"],broadcast_util.assertAndGetBroadcastShape(xShape,meanShape),broadcast_util.assertAndGetBroadcastShape(xShape,varianceShape);var offsetSnippet="vec4(0.0)";null!=offsetShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,offsetShape),this.variableNames.push("offset"),offsetSnippet="getOffsetAtOutCoords()");var scaleSnippet="vec4(1.0)";null!=scaleShape&&(broadcast_util.assertAndGetBroadcastShape(xShape,scaleShape),this.variableNames.push("scale"),scaleSnippet="getScaleAtOutCoords()"),this.outputShape=xShape,this.userCode="\n      void main() {\n        vec4 offset = "+offsetSnippet+";\n        vec4 scale = "+scaleSnippet+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+varianceEpsilon+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "}var broadcast_util=require("../../ops/broadcast_util");exports.BatchNormPackedProgram=BatchNormPackedProgram},{"../../ops/broadcast_util":169}],67:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util");exports.COMPLEX_MULTIPLY={REAL:"return areal * breal - aimag * bimag;",IMAG:"return areal * bimag + aimag * breal;"};function BinaryOpComplexProgram(op,aShape,bShape){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+op+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "}exports.BinaryOpComplexProgram=BinaryOpComplexProgram},{"../../ops/broadcast_util":169}],68:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),CHECK_NAN_SNIPPET="\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n";exports.ADD="return a + b;",exports.SUB="return a - b;",exports.MUL="return a * b;",exports.DIV="\nif (b == 0.0) {\n  return NAN;\n}\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",exports.INT_DIV="\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",exports.POW="\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",exports.SQUARED_DIFFERENCE="return (a - b) * (a - b);",exports.EQUAL="return float(a == b);",exports.NOT_EQUAL="return float(a != b);",exports.LESS="return float(a < b);",exports.LESS_EQUAL="return float(a <= b);",exports.GREATER="return float(a > b);",exports.GREATER_EQUAL="return float(a >= b);",exports.LOGICAL_AND="return float(a >= 1.0 && b >= 1.0);",exports.LOGICAL_OR="return float(a >= 1.0 || b >= 1.0);",exports.MAX=CHECK_NAN_SNIPPET+"\n  return max(a, b);\n",exports.MIN=CHECK_NAN_SNIPPET+"\n  return min(a, b);\n",exports.MOD="if (b == 0.0) return NAN;\n  return mod(a, b);",exports.ATAN2=CHECK_NAN_SNIPPET+"\n  return atan(a, b);\n",exports.ELU_DER="return (b >= 1.0) ? a : a * (b + 1.0);",exports.PRELU="return (a < 0.) ? b * a : a;";function BinaryOpProgram(op,aShape,bShape){this.variableNames=["A","B"],this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+op+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "}exports.BinaryOpProgram=BinaryOpProgram},{"../../ops/broadcast_util":169}],69:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util=require("../../ops/broadcast_util"),util_1=require("../../util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),CHECK_NAN_SNIPPET="\n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n";exports.DIV="\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(b.x == 0.0) {\n    result.x = NAN;\n  } else if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(b.y == 0.0) {\n    result.y = NAN;\n  } else if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(b.z == 0.0) {\n    result.z = NAN;\n  } else if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(b.w == 0.0) {\n    result.w = NAN;\n  } else if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n",exports.INT_DIV="\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n",exports.POW="\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.PRELU="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",exports.ELU_DER="\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",exports.ATAN2="\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.EQUAL="\n  return vec4(equal(a, b));\n",exports.NOT_EQUAL="\n  return vec4(notEqual(a, b));\n",exports.LESS="\n  return vec4(lessThan(a, b));\n",exports.LESS_EQUAL="\n  return vec4(lessThanEqual(a, b));\n",exports.GREATER="\n  return vec4(greaterThan(a, b));\n",exports.GREATER_EQUAL="\n  return vec4(greaterThanEqual(a, b));\n",exports.LOGICAL_AND="\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n",exports.LOGICAL_OR="\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n",exports.MAX="\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.MIN="\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n",exports.MOD="\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  "+CHECK_NAN_SNIPPET+"\n  return result;\n";function BinaryOpPackedProgram(op,aShape,bShape,checkOutOfBounds){void 0===checkOutOfBounds&&(checkOutOfBounds=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.usesPackedTextures=!0,this.outputShape=broadcast_util.assertAndGetBroadcastShape(aShape,bShape);var rank=this.outputShape.length,checkOutOfBoundsString="";if(checkOutOfBounds)if(0===rank||1===util_1.sizeFromShape(this.outputShape))checkOutOfBoundsString="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(checkOutOfBoundsString="\n          "+shader_compiler_1.getCoordsDataType(rank)+" coords = getOutputCoords();\n        ",1===rank)checkOutOfBoundsString+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var channels=packing_util_1.getChannels("coords",rank);checkOutOfBoundsString+="\n            bool nextRowOutOfBounds =\n              ("+channels[rank-2]+" + 1) >= "+this.outputShape[rank-2]+";\n            bool nextColOutOfBounds =\n              ("+channels[rank-1]+" + 1) >= "+this.outputShape[rank-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+op+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+checkOutOfBoundsString+"\n\n        setOutput(result);\n      }\n    "}exports.BinaryOpPackedProgram=BinaryOpPackedProgram},{"../../ops/broadcast_util":169,"../../util":241,"../packing_util":55,"./shader_compiler":126}],70:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var contexts={},WEBGL_ATTRIBUTES={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function createCanvas(webGLVersion){if("undefined"!=typeof OffscreenCanvas&&2===webGLVersion)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}exports.setWebGLContext=function(webGLVersion,gl){contexts[webGLVersion]=gl},exports.getWebGLContext=function getWebGLContext(webGLVersion){webGLVersion in contexts||(contexts[webGLVersion]=function(webGLVersion){if(1!==webGLVersion&&2!==webGLVersion)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var canvas=createCanvas(webGLVersion);return canvas.addEventListener("webglcontextlost",function(ev){ev.preventDefault(),delete contexts[webGLVersion]},!1),1!==webGLVersion?canvas.getContext("webgl2",WEBGL_ATTRIBUTES):canvas.getContext("webgl",WEBGL_ATTRIBUTES)||canvas.getContext("experimental-webgl",WEBGL_ATTRIBUTES)}(webGLVersion));var gl=contexts[webGLVersion];return gl.isContextLost()?(delete contexts[webGLVersion],getWebGLContext(webGLVersion)):(gl.disable(gl.DEPTH_TEST),gl.disable(gl.STENCIL_TEST),gl.disable(gl.BLEND),gl.disable(gl.DITHER),gl.disable(gl.POLYGON_OFFSET_FILL),gl.disable(gl.SAMPLE_COVERAGE),gl.enable(gl.SCISSOR_TEST),gl.enable(gl.CULL_FACE),gl.cullFace(gl.BACK),contexts[webGLVersion])},exports.createCanvas=createCanvas},{}],71:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClipProgram=function(){function ClipProgram(aShape){this.variableNames=["A"],this.outputShape=aShape,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return ClipProgram.prototype.getCustomSetupFunc=function(min,max){var _this=this;return function(gpgpu,webGLProgram){null==_this.minLoc&&(_this.minLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"minVal"),_this.maxLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"maxVal")),gpgpu.gl.uniform1f(_this.minLoc,min),gpgpu.gl.uniform1f(_this.maxLoc,max)}},ClipProgram}();exports.ClipProgram=ClipProgram},{}],72:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ClipPackedProgram=function(){function ClipPackedProgram(aShape){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=aShape,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return ClipPackedProgram.prototype.getCustomSetupFunc=function(min,max){var _this=this;return function(gpgpu,webGLProgram){null==_this.minLoc&&(_this.minLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"minVal"),_this.maxLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"maxVal")),gpgpu.gl.uniform1f(_this.minLoc,min),gpgpu.gl.uniform1f(_this.maxLoc,max)}},ClipPackedProgram}();exports.ClipPackedProgram=ClipPackedProgram},{}],73:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ComplexAbsProgram(shape){this.variableNames=["real","imag"],this.outputShape=shape,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "}exports.ComplexAbsProgram=ComplexAbsProgram},{}],74:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ConcatProgram(shapes){this.outputShape=[],this.outputShape=concat_util.computeOutShape(shapes,1),this.variableNames=shapes.map(function(_,i){return"T"+i});var offsets=new Array(shapes.length-1);offsets[0]=shapes[0][1];for(var i=1;i<offsets.length;i++)offsets[i]=offsets[i-1]+shapes[i][1];var snippets=["if (yC < "+offsets[0]+") setOutput(getT0(yR, yC));"];for(i=1;i<offsets.length;i++){var shift=offsets[i-1];snippets.push("else if (yC < "+offsets[i]+") setOutput(getT"+i+"(yR, yC-"+shift+"));")}var lastIndex=offsets.length,lastShift=offsets[offsets.length-1];snippets.push("else setOutput(getT"+lastIndex+"(yR, yC-"+lastShift+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+snippets.join("\n        ")+"\n      }\n    "}var concat_util=require("../../ops/concat_util");exports.ConcatProgram=ConcatProgram},{"../../ops/concat_util":174}],75:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ConcatPackedProgram(shapes,axis){this.usesPackedTextures=!0,this.outputShape=[],this.outputShape=concat_util.computeOutShape(shapes,axis);var shape=this.outputShape,rank=shape.length,dtype=shader_compiler_1.getCoordsDataType(rank),coords=packing_util_1.getChannels("coords",rank),channels=["x","y","z","w","u","v"].slice(0,rank);this.variableNames=shapes.map(function(_,i){return"T"+i});var offsets=new Array(shapes.length-1);offsets[0]=shapes[0][axis];for(var i=1;i<offsets.length;i++)offsets[i]=offsets[i-1]+shapes[i][axis];var channel=channels[axis],lastChannels="vec2("+channels.slice(-2).join()+")",allChannels=channels.join(),getValueSnippet="if ("+channel+" < "+offsets[0]+")\n          return getChannel(getT0("+allChannels+"), "+lastChannels+");";for(i=1;i<offsets.length;i++){var shift_1=offsets[i-1];getValueSnippet+="\n        else if ("+channel+" < "+offsets[i]+") {\n          "+channel+" -= "+shift_1+";\n          return getChannel(getT"+i+"("+allChannels+"), "+lastChannels+");\n        }"}var lastIndex=offsets.length;getValueSnippet+="\n        else {\n          "+channel+" -= "+offsets[offsets.length-1]+";\n          return getChannel(getT"+lastIndex+"("+allChannels+"), "+lastChannels+");\n        }",this.userCode="\n      float getValue("+channels.map(function(x){return"int "+x})+") {\n        "+getValueSnippet+"\n      }\n\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+coords+"), 0., 0., 0.);\n        if (++"+coords[rank-1]+" < "+shape[rank-1]+") {\n          result.g = getValue("+coords+");\n        }\n        if (++"+coords[rank-2]+" < "+shape[rank-2]+") {\n          result.a = getValue("+coords+");\n        }\n        if ("+coords[rank-2]+" < "+shape[rank-2]+" &&\n            --"+coords[rank-1]+" < "+shape[rank-1]+") {\n          result.b = getValue("+coords+");\n        }\n        setOutput(result);\n      }\n    "}var concat_util=require("../../ops/concat_util"),packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.ConcatPackedProgram=ConcatPackedProgram},{"../../ops/concat_util":174,"../packing_util":55,"./shader_compiler":126}],76:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Conv2DDerFilterProgram(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,isChannelsLast="channelsLast"===convInfo.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n            int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n              int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              if ("+isChannelsLast+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv2DDerFilterProgram=Conv2DDerFilterProgram;function Conv2DDerInputProgram(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,isChannelsLast="channelsLast"===convInfo.dataFormat,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left,rowDim=isChannelsLast?1:2,colDim=isChannelsLast?2:3,channelDim=isChannelsLast?3:1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+channelDim+"];\n\n        ivec2 dyCorner = ivec2(coords["+rowDim+"], coords["+colDim+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+convInfo.outChannels+"; d2++) {\n\n              if ("+isChannelsLast+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv2DDerInputProgram=Conv2DDerInputProgram;function Conv3DDerFilterProgram(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yF = 0; yF < "+convInfo.outDepth+"; yF++) {\n            int xF = wF + yF * "+strideDepth+" - "+padFront+";\n\n            if (xF < 0 || xF >= "+convInfo.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n              int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n              if (xR < 0 || xR >= "+convInfo.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n                int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n                if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv3DDerFilterProgram=Conv3DDerFilterProgram;function Conv3DDerInputProgram(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padFront=filterDepth-1-convInfo.padInfo.front,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+filterDepth+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+strideDepth+".0;\n\n          if (dyF < 0.0 || dyF >= "+convInfo.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+filterDepth+" - 1 - wF;\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+filterHeight+" - 1 - wR;\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+filterWidth+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+convInfo.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv3DDerInputProgram=Conv3DDerInputProgram},{}],77:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DepthwiseConv2DDerFilterProgram(convInfo){this.variableNames=["x","dy"],this.outputShape=convInfo.filterShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+channelMul+" + dm;\n\n        float dotProd = 0.0;\n\n        // TODO: Vec4 over the batch size\n        for (int b = 0; b < "+convInfo.batchSize+"; b++) {\n          for (int yR = 0; yR < "+convInfo.outHeight+"; yR++) {\n            int xR = wR + yR * "+strideHeight+" - "+padTop+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+convInfo.outWidth+"; yC++) {\n              int xC = wC + yC * "+strideWidth+" - "+padLeft+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.DepthwiseConv2DDerFilterProgram=DepthwiseConv2DDerFilterProgram;function DepthwiseConv2DDerInputProgram(convInfo){this.variableNames=["dy","W"],this.outputShape=convInfo.inShape;var filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,padTop=filterHeight-1-convInfo.padInfo.top,padLeft=filterWidth-1-convInfo.padInfo.left,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+filterHeight+" - 1 - wR;\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+filterWidth+" - 1 - wC;\n\n            // TODO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+channelMul+"; dm++) {\n              int d2 = d1 * "+channelMul+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.DepthwiseConv2DDerInputProgram=DepthwiseConv2DDerInputProgram},{}],78:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Conv2DProgram(convInfo,addBias,activation,hasPreluActivationWeights){void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivationWeights&&(hasPreluActivationWeights=!1),this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inputDepthNearestVec4=4*Math.floor(convInfo.inChannels/4),inputDepthVec4Remainder=convInfo.inChannels%4,isChannelsLast="channelsLast"===convInfo.dataFormat,rowDim=isChannelsLast?1:2,colDim=isChannelsLast?2:3,channelDim=isChannelsLast?3:1,activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivationWeights?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"\n          float activation(float x) {\n            "+activation+"\n          }\n        ",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivationWeights&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+channelDim+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+rowDim+"], coords["+colDim+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR * "+dilationHeight+";\n\n          if (xR < 0 || xR >= "+convInfo.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            if (xC < 0 || xC >= "+convInfo.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1==inputDepthVec4Remainder)+") {\n\n              if ("+isChannelsLast+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+inputDepthNearestVec4+") *\n                    getW(wR, wC, "+inputDepthNearestVec4+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+inputDepthNearestVec4+", xR, xC) *\n                    getW(wR, wC, "+inputDepthNearestVec4+", d2);\n              }\n\n            } else if ("+(2==inputDepthVec4Remainder)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+inputDepthNearestVec4+", xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3==inputDepthVec4Remainder)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+inputDepthNearestVec4+", d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                getW(wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n              );\n\n              if ("+isChannelsLast+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 1),\n                  getX(batch, xR, xC, "+inputDepthNearestVec4+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+inputDepthNearestVec4+", xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 1, xR, xC),\n                  getX(batch, "+inputDepthNearestVec4+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+addBiasSnippet+"\n        "+applyActivationSnippet+"\n        setOutput(result);\n      }\n    "}exports.Conv2DProgram=Conv2DProgram;function Conv3DProgram(convInfo){this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterDepth=convInfo.filterDepth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,inputDepthNearestVec4=4*Math.floor(convInfo.inChannels/4),inputDepthVec4Remainder=convInfo.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+filterDepth+"; wF++) {\n          int xF = xFCorner + wF * "+dilationDepth+";\n\n          if (xF < 0 || xF >= "+convInfo.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+filterHeight+"; wR++) {\n            int xR = xRCorner + wR * "+dilationHeight+";\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidth+"; wC++) {\n              int xC = xCCorner + wC * "+dilationWidth+";\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+inputDepthNearestVec4+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1==inputDepthVec4Remainder)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+") *\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2);\n              } else if ("+(2==inputDepthVec4Remainder)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3==inputDepthVec4Remainder)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+"),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 1),\n                  getX(batch, xF, xR, xC, "+inputDepthNearestVec4+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+", d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 1, d2),\n                  getW(wF, wR, wC, "+inputDepthNearestVec4+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.Conv3DProgram=Conv3DProgram},{}],79:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DepthwiseConv2DProgram(convInfo){this.variableNames=["x","W"],this.outputShape=convInfo.outShape;var xNumRows=convInfo.inHeight,xNumCols=convInfo.inWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,channelMul=convInfo.outChannels/convInfo.inChannels;this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+channelMul+";\n        int q = d2 - d1 * "+channelMul+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TODO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+filterHeight+"; wR++) {\n          int xR = xRCorner + wR * "+dilationHeight+";\n\n          if (xR < 0 || xR >= "+xNumRows+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidth+"; wC++) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            if (xC < 0 || xC >= "+xNumCols+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.DepthwiseConv2DProgram=DepthwiseConv2DProgram},{}],80:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DepthwiseConvPacked2DProgram(convInfo){this.variableNames=["x","W"],this.usesPackedTextures=!0,this.outputShape=convInfo.outShape;for(var xNumRows=convInfo.inHeight,xNumCols=convInfo.inWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,filterHeight=convInfo.filterHeight,filterWidth=convInfo.filterWidth,texelsAcross=filterWidth,mainLoop="int xR; int xC; int xCOffset;",r=0;r<filterHeight;r++)for(var c=0;c<filterWidth;c++)mainLoop+="\n          vec4 xTexelR"+r+"C"+2*c+" = vec4(0.);\n          vec4 wR"+r+"C"+c+" = vec4(0.);\n          vec4 xR"+r+"C"+c+" = vec4(0.);";for(r=0;r<filterHeight;r++)for(var texelC=0;texelC<texelsAcross;texelC++){if(mainLoop+="\n          xR = xRCorner + "+r*dilationHeight+";\n          xC = xCCorner + "+(c=2*texelC)*dilationWidth+";\n        ",1===strideWidth){if(c<filterWidth&&(mainLoop+=padLeft%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+xNumRows+" && xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+xNumRows+" && xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n                  xR"+r+"C"+c+" = vec4(previous.zw, xTexelR"+r+"C"+c+".xy);\n                } else {\n                  xR"+r+"C"+c+" = vec4(0, 0, xTexelR"+r+"C"+c+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+xNumRows+" && xC >= 0 && xC < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = xTexelR"+r+"C"+c+";\n              ",c+1<filterWidth)){var nextTexelOffset=padLeft%2==0?util.nearestLargerEven(dilationWidth):dilationWidth;dilationWidth%2==0&&padLeft%2==1||dilationWidth%2!=0&&padLeft%2!=1?(mainLoop+="\n                  xCOffset = xC + "+padLeft%2+" + "+nextTexelOffset+";\n\n                  if(xR >= 0 && xR < "+xNumRows+" &&\n                    xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",1<dilationWidth&&(mainLoop+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+xNumRows+" &&\n                      xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                      xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+r+"C"+c+" = vec4(0.);\n                    }\n                  "),mainLoop+="\n                  xR"+r+"C"+(c+1)+" = vec4(\n                    xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".xy);\n                "):mainLoop+="\n                  xCOffset = xC + "+nextTexelOffset+";\n\n                  if(xR >= 0 && xR < "+xNumRows+" &&\n                    xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+r+"C"+(c+1)+" = xTexelR"+r+"C"+(c+2)+";\n                "}}else c<filterWidth&&(mainLoop+="\n              if(xR >= 0 && xR < "+xNumRows+") {\n            ",padLeft%2==1?(mainLoop+="\n                xCOffset = xC + 1 - "+strideWidth+";\n                if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+xNumCols+") {\n                  xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+r+"C"+(c+2)+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = vec4(\n                  xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".zw);\n              ",c+1<filterWidth&&(mainLoop+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+strideWidth+";\n                  if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+r+"C"+(c+1)+" = vec4(xTexelR"+r+"C"+(c+2)+".xy, final.xy);\n                ")):(mainLoop+="\n                if(xC >= 0 && xC < "+xNumCols+") {\n                  xTexelR"+r+"C"+c+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+r+"C"+c+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+strideWidth+";\n                if(xCOffset >= 0 && xCOffset < "+xNumCols+") {\n                  xTexelR"+r+"C"+(c+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+r+"C"+(c+2)+" = vec4(0.);\n                }\n\n                xR"+r+"C"+c+" = vec4(\n                  xTexelR"+r+"C"+c+".xy, xTexelR"+r+"C"+(c+2)+".xy);\n              ",c+1<filterWidth&&(mainLoop+="\n                  xR"+r+"C"+(c+1)+" = vec4(\n                    xTexelR"+r+"C"+c+".zw, xTexelR"+r+"C"+(c+2)+".zw);\n                ")),mainLoop+="}");c<filterWidth&&(mainLoop+="\n            vec4 wTexelR"+r+"C"+c+" = getW("+r+", "+c+", d1, q);\n            wR"+r+"C"+c+" = vec4(wTexelR"+r+"C"+c+".xz, wTexelR"+r+"C"+c+".xz);\n          ",c+1<filterWidth&&(mainLoop+="\n              vec4 wTexelR"+r+"C"+(c+1)+" = getW("+r+", "+(c+1)+", d1, q);\n              wR"+r+"C"+(c+1)+" =\n                vec4(wTexelR"+r+"C"+(c+1)+".xz, wTexelR"+r+"C"+(c+1)+".xz);"))}for(r=0;r<filterHeight;r++)for(c=0;c<filterWidth;c++)mainLoop+="result += xR"+r+"C"+c+" * wR"+r+"C"+c+";";this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 result = vec4(0.);\n\n        "+mainLoop+"\n\n        setOutput(result);\n      }\n    "}var util=require("../../util");exports.DepthwiseConvPacked2DProgram=DepthwiseConvPacked2DProgram},{"../../util":241}],81:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function CropAndResizeProgram(imageShape,boxShape,cropSize,method,extrapolationValue){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var batch=imageShape[0],imageHeight=imageShape[1],imageWidth=imageShape[2],depth=imageShape[3],numBoxes=boxShape[0],cropHeight=cropSize[0],cropWidth=cropSize[1];this.outputShape=[numBoxes,cropHeight,cropWidth,depth];var methodId="bilinear"===method?1:0,_a=[imageHeight-1+".0",imageWidth-1+".0"],inputHeightFloat=_a[0],inputWidthFloat=_a[1],_b=1<cropHeight?[""+(imageHeight-1)/(cropHeight-1),"(y2-y1) * height_ratio","y1*"+inputHeightFloat+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+inputHeightFloat],heightRatio=_b[0],heightScale=_b[1],inY=_b[2],_c=1<cropWidth?[""+(imageWidth-1)/(cropWidth-1),"(x2-x1) * width_ratio","x1*"+inputWidthFloat+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+inputWidthFloat],widthRatio=_c[0],widthScale=_c[1],inX=_c[2];this.userCode="\n      const float height_ratio = float("+heightRatio+");\n      const float width_ratio = float("+widthRatio+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+batch+") {\n          return;\n        }\n\n        float height_scale = "+heightScale+";\n        float width_scale = "+widthScale+";\n\n        float in_y = "+inY+";\n        if( in_y < 0.0 || in_y > "+inputHeightFloat+" ) {\n          setOutput(float("+extrapolationValue+"));\n          return;\n        }\n        float in_x = "+inX+";\n        if( in_x < 0.0 || in_x > "+inputWidthFloat+" ) {\n          setOutput(float("+extrapolationValue+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+methodId+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "}exports.CropAndResizeProgram=CropAndResizeProgram},{}],82:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function CumSumProgram(shape,exclusive,reverse){this.variableNames=["x"];var rank=(this.outputShape=shape).length,finalDim=shape[shape.length-1],comparator=reverse?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(reverse?"return "+finalDim+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+shader_compiler_1.getCoordsDataType(rank)+" coords = getOutputCoords();\n        int end = "+getFinalCoord(rank,"coords")+";\n        float val = 0.0;\n        for (int i = "+finalDim+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+comparator+" end) {\n            continue;\n          }\n          if (idx == end && "+exclusive+") {\n            continue;\n          }\n          "+getFinalCoord(rank,"coords")+" = idx;\n          val += getX("+function(rank,name){if(1===rank)return""+name;if(2===rank)return name+".x, "+name+".y";if(3===rank)return name+".x, "+name+".y, "+name+".z";if(4===rank)return name+".x, "+name+".y, "+name+".z, "+name+".w";throw Error("Cumulative sum for rank "+rank+" is not yet supported")}(rank,"coords")+");\n        }\n        setOutput(val);\n      }\n    "}var shader_compiler_1=require("./shader_compiler");function getFinalCoord(rank,name){if(1===rank)return""+name;if(2===rank)return name+".y";if(3===rank)return name+".z";if(4===rank)return name+".w";throw Error("Cumulative sum for rank "+rank+" is not yet supported")}exports.CumSumProgram=CumSumProgram},{"./shader_compiler":126}],83:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DecodeMatrixProgram(outputShape,texShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],outputShape)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = 4 * (resTexRC.x * "+texShape[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.DecodeMatrixProgram=DecodeMatrixProgram},{"./glsl_version":98,"./shader_compiler_util":127}],84:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DecodeMatrixPackedProgram(outputShape,texShape){this.variableNames=["A"],this.usesPackedTextures=!0;var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],outputShape)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = 4 * (resTexRC.x * "+texShape[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.DecodeMatrixPackedProgram=DecodeMatrixPackedProgram},{"./glsl_version":98,"./shader_compiler_util":127}],85:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var DepthToSpaceProgram=function(){function DepthToSpaceProgram(outputShape,blockSize,dataFormat){this.variableNames=["x"],this.outputShape=[],this.outputShape=outputShape,this.blockSize=blockSize,this.dataFormat=dataFormat,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+blockSize+";\n      int offset_h = imod(h, "+blockSize+");\n      int in_w = w / "+blockSize+";\n      int offset_w = imod(w, "+blockSize+");\n      int offset_d = (offset_h * "+blockSize+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return DepthToSpaceProgram.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},DepthToSpaceProgram.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},DepthToSpaceProgram.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},DepthToSpaceProgram.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},DepthToSpaceProgram.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},DepthToSpaceProgram}();exports.DepthToSpaceProgram=DepthToSpaceProgram},{}],86:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DiagProgram(size){this.variableNames=["X"],this.outputShape=[size,size],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "}exports.DiagProgram=DiagProgram},{}],87:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeFloatProgram(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      "+shader_compiler_util_1.ENCODE_FLOAT_SNIPPET+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+glsl.output+" = encode_float(x);\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_compiler_util_1=require("./shader_compiler_util");exports.EncodeFloatProgram=EncodeFloatProgram},{"./glsl_version":98,"./shader_compiler_util":127}],88:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeFloatPackedProgram(outputShape){this.variableNames=["A"],this.usesPackedTextures=!0;var glsl=glsl_version_1.getGlslDifferences();this.outputShape=outputShape,this.userCode="\n      "+shader_compiler_util_1.ENCODE_FLOAT_SNIPPET+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+glsl.output+" = encode_float(x);\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_compiler_util_1=require("./shader_compiler_util");exports.EncodeFloatPackedProgram=EncodeFloatPackedProgram},{"./glsl_version":98,"./shader_compiler_util":127}],89:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeMatrixProgram(outputShape,texShape,inputIsUnsignedByte){void 0===inputIsUnsignedByte&&(inputIsUnsignedByte=!1),this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=texShape[0],width=texShape[1];this.outputShape=outputShape;var output="result";inputIsUnsignedByte&&(output="floor(result * 255. + 0.5)"),this.userCode="\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+width+";\n        int c = imod(flatIndex, "+width+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+width+".0, "+height+".0);\n        vec4 values = "+glsl.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+glsl.output+" = vec4("+output+", 0., 0., 0.);\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.EncodeMatrixProgram=EncodeMatrixProgram},{"./glsl_version":98,"./shader_compiler_util":127}],90:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function EncodeMatrixPackedProgram(outputShape,texShape,inputIsUnsignedByte){void 0===inputIsUnsignedByte&&(inputIsUnsignedByte=!1),this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=texShape[0],width=texShape[1];this.outputShape=outputShape;var mainLoop="",output="result";inputIsUnsignedByte&&(output="floor(result * 255. + 0.5)");for(var row=0;row<=1;row++)for(var col=0;col<=1;col++){var channel=2*row+col;mainLoop+="\n          localCoords = coords;\n          if(localCoords[2] + "+col+" < "+outputShape[2]+") {\n            localCoords[2] += "+col+";\n            if(localCoords[1] + "+row+" < "+outputShape[1]+") {\n              localCoords[1] += "+row+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n    \n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+width+";\n              c = imod(flatIndex, "+width+");\n              uv = (vec2(c, r) + halfCR) / vec2("+width+".0, "+height+".0);\n              values = "+glsl.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+channel+"] = values[0];\n              } else if(offset == 1) {\n                result["+channel+"] = values[1];\n              } else if(offset == 2) {\n                result["+channel+"] = values[2];\n              } else {\n                result["+channel+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n        \n        "+mainLoop+"\n\n        "+glsl.output+" = "+output+";\n      }\n    "}var glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");exports.EncodeMatrixPackedProgram=EncodeMatrixPackedProgram},{"./glsl_version":98,"./shader_compiler_util":127}],91:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.COMPLEX_FFT={REAL:"return real * expR - imag * expI;",IMAG:"return real * expI + imag * expR;"};function FFTProgram(op,inputShape,inverse){this.variableNames=["real","imag"];var innerDim=inputShape[1];this.outputShape=inputShape;var exponentMultiplierSnippet=inverse?"2.0 * "+Math.PI:"-2.0 * "+Math.PI,resultDenominator=inverse?innerDim+".0":"1.0";this.userCode="\n      const float exponentMultiplier = "+exponentMultiplierSnippet+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+op+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+innerDim+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+innerDim+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+resultDenominator+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "}exports.FFTProgram=FFTProgram},{}],92:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FillProgram=function(){function FillProgram(shape,value){this.outputShape=[],this.variableNames=["x"],this.outputShape=shape,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return FillProgram.prototype.getCustomSetupFunc=function(value){var _this=this;return function(gpgpu,webGLProgram){null==_this.valueLoc&&(_this.valueLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"value")),gpgpu.gl.uniform1f(_this.valueLoc,value)}},FillProgram}();exports.FillProgram=FillProgram},{}],93:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var device_util=require("../../device_util"),environment_1=require("../../environment"),webgl_util=require("./webgl_util");environment_1.ENV.registerFlag("HAS_WEBGL",function(){return 0<environment_1.ENV.getNumber("WEBGL_VERSION")}),environment_1.ENV.registerFlag("WEBGL_VERSION",function(){return webgl_util.isWebGLVersionEnabled(2)?2:webgl_util.isWebGLVersionEnabled(1)?1:0}),environment_1.ENV.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===environment_1.ENV.get("WEBGL_VERSION")}),environment_1.ENV.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),environment_1.ENV.registerFlag("WEBGL_PACK",function(){return environment_1.ENV.getBool("HAS_WEBGL")}),environment_1.ENV.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_CLIP",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),environment_1.ENV.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_PACK_REDUCE",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_LAZILY_UNPACK",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_CONV_IM2COL",function(){return environment_1.ENV.getBool("WEBGL_PACK")}),environment_1.ENV.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return webgl_util.getWebGLMaxTextureSize(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return webgl_util.getMaxTexturesInShader(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var webGLVersion=environment_1.ENV.getNumber("WEBGL_VERSION");return 0===webGLVersion?0:webgl_util.getWebGLDisjointQueryTimerVersion(webGLVersion)}),environment_1.ENV.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return 0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")&&!device_util.isMobile()}),environment_1.ENV.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return webgl_util.isRenderToFloatTextureEnabled(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return webgl_util.isDownloadFloatTextureEnabled(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return webgl_util.isWebGLFenceEnabled(environment_1.ENV.getNumber("WEBGL_VERSION"))}),environment_1.ENV.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0})},{"../../device_util":142,"../../environment":144,"./webgl_util":139}],94:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function FromPixelsProgram(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=outputShape[0],width=outputShape[1];this.outputShape=outputShape,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+width+".0, "+height+".0);\n\n        vec4 values = "+glsl.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "}var glsl_version_1=require("./glsl_version");exports.FromPixelsProgram=FromPixelsProgram},{"./glsl_version":98}],95:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function FromPixelsPackedProgram(outputShape){this.variableNames=["A"];var glsl=glsl_version_1.getGlslDifferences(),height=outputShape[0],width=outputShape[1];this.outputShape=outputShape,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+width+".0, "+height+".0);\n            vec4 values = "+glsl.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version");exports.FromPixelsPackedProgram=FromPixelsPackedProgram},{"./glsl_version":98}],96:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function GatherProgram(aShape,indicesLength,axis){this.variableNames=["A","indices"];var outputShape=aShape.slice();outputShape[axis]=indicesLength,this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),sourceCoords=function(aShape,axis){var rank=aShape.length;if(4<rank)throw Error("Gather for rank "+rank+" is not yet supported");if(1===rank)return"int(getIndices(resRC))";for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w"],sourceCoords=[],i=0;i<aShape.length;i++)i===axis?sourceCoords.push("int(getIndices("+currentCoords[i]+"))"):sourceCoords.push(""+currentCoords[i]);return sourceCoords.join()}(aShape,axis);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        setOutput(getA("+sourceCoords+"));\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.GatherProgram=GatherProgram},{"./shader_compiler":126}],97:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function GatherNDProgram(sliceDim,strides,shape){this.sliceDim=sliceDim,this.strides=strides,this.variableNames=["x","indices"],this.outputShape=shape;var stridesType=shader_compiler_1.getCoordsDataType(strides.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),strideString=1<this.sliceDim?"strides[j]":"strides";this.userCode="\n        "+stridesType+" strides = "+stridesType+"("+this.strides+");\n         void main() {\n          "+dtype+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+strideString+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.GatherNDProgram=GatherNDProgram},{"./shader_compiler":126}],98:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment");exports.getGlslDifferences=function(){var version,attribute,varyingVs,varyingFs,texture2D,output,defineOutput,defineSpecialNaN,defineSpecialInf,defineRound;return defineRound=2===environment_1.ENV.getNumber("WEBGL_VERSION")?(version="#version 300 es",varyingVs="out",varyingFs=attribute="in",texture2D="texture",output="outputColor",defineOutput="out vec4 outputColor;",defineSpecialNaN="\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 0. || val == 0.) ? false : true;\n      }\n    ",defineSpecialInf="","\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(attribute="attribute",varyingFs=varyingVs="varying",texture2D="texture2D",output="gl_FragColor",defineOutput=version="",defineSpecialNaN="\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n    ",defineSpecialInf="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ","\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:version,attribute:attribute,varyingVs:varyingVs,varyingFs:varyingFs,texture2D:texture2D,output:output,defineOutput:defineOutput,defineSpecialNaN:defineSpecialNaN,defineSpecialInf:defineSpecialInf,defineRound:defineRound}}},{"../../environment":144}],99:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),canvas_util_1=require("./canvas_util"),gpgpu_util=require("./gpgpu_util"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util"),GPGPUContext=function(){function GPGPUContext(gl){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var glVersion=environment_1.ENV.getNumber("WEBGL_VERSION");if(null!=gl?(this.gl=gl,canvas_util_1.setWebGLContext(glVersion,gl)):this.gl=canvas_util_1.getWebGLContext(glVersion),1===environment_1.ENV.getNumber("WEBGL_VERSION"))this.textureFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"OES_texture_float"),this.colorBufferFloatExtension=this.gl.getExtension("WEBGL_color_buffer_float"),environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||(this.textureHalfFloatExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,"OES_texture_half_float"),this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float"));else{if(webgl_util.hasExtension(this.gl,"EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension("EXT_color_buffer_float");else{if(!webgl_util.hasExtension(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}}this.vertexBuffer=gpgpu_util.createVertexBuffer(this.gl,this.debug),this.indexBuffer=gpgpu_util.createIndexBuffer(this.gl,this.debug),this.framebuffer=webgl_util.createFramebuffer(this.gl,this.debug),this.textureConfig=tex_util.getTextureConfig(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(GPGPUContext.prototype,"debug",{get:function(){return environment_1.ENV.getBool("DEBUG")},enumerable:!0,configurable:!0}),GPGPUContext.prototype.dispose=function(){var _this=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var gl=this.gl;webgl_util.callAndCheck(gl,this.debug,function(){return gl.finish()}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.deleteFramebuffer(_this.framebuffer)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,null)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.deleteBuffer(_this.indexBuffer)}),this.disposed=!0}},GPGPUContext.prototype.createFloat32MatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat32MatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createFloat16MatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat16MatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createUnsignedBytesMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createUnsignedBytesMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.uploadPixelDataToTexture=function(texture,pixels){this.throwIfDisposed(),gpgpu_util.uploadPixelDataToTexture(this.gl,this.debug,texture,pixels)},GPGPUContext.prototype.uploadDenseMatrixToTexture=function(texture,width,height,data){this.throwIfDisposed(),gpgpu_util.uploadDenseMatrixToTexture(this.gl,this.debug,texture,width,height,data,this.textureConfig)},GPGPUContext.prototype.createFloat16PackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createFloat16PackedMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.createPackedMatrixTexture=function(rows,columns){return this.throwIfDisposed(),gpgpu_util.createPackedMatrixTexture(this.gl,this.debug,rows,columns,this.textureConfig)},GPGPUContext.prototype.deleteMatrixTexture=function(texture){var _this=this;this.throwIfDisposed(),this.outputTexture===texture&&(webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.debug,this.framebuffer),this.outputTexture=null),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.deleteTexture(texture)})},GPGPUContext.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(texture,rows,columns){var _this=this;return this.downloadMatrixDriver(texture,function(){return gpgpu_util.downloadByteEncodedFloatMatrixFromOutputTexture(_this.gl,_this.debug,rows,columns,_this.textureConfig)})},GPGPUContext.prototype.downloadPackedMatrixFromBuffer=function(buffer,batch,rows,columns,physicalRows,physicalCols){return gpgpu_util.downloadPackedMatrixFromBuffer(this.gl,buffer,batch,rows,columns,physicalRows,physicalCols,this.textureConfig)},GPGPUContext.prototype.downloadFloat32MatrixFromBuffer=function(buffer,size){return gpgpu_util.downloadFloat32MatrixFromBuffer(this.gl,buffer,size)},GPGPUContext.prototype.createBufferFromTexture=function(texture,rows,columns){this.bindTextureToFrameBuffer(texture);var result=gpgpu_util.createBufferFromOutputTexture(this.gl,this.debug,rows,columns,this.textureConfig);return this.unbindTextureToFrameBuffer(),result},GPGPUContext.prototype.createAndWaitForFence=function(){var fenceContext=this.createFence(this.gl);return this.pollFence(fenceContext)},GPGPUContext.prototype.createFence=function(gl){var query,isFencePassed,_this=this;if(environment_1.ENV.getBool("WEBGL_FENCE_API_ENABLED")){var gl2_1=gl,sync_1=gl2_1.fenceSync(gl2_1.SYNC_GPU_COMMANDS_COMPLETE,0);gl.flush(),isFencePassed=function(){var status=gl2_1.clientWaitSync(sync_1,0,0);return status===gl2_1.ALREADY_SIGNALED||status===gl2_1.CONDITION_SATISFIED},query=sync_1}else isFencePassed=0<environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(query=this.beginQuery(),this.endQuery(),function(){return _this.isQueryAvailable(query,environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):function(){return!0};return{query:query,isFencePassed:isFencePassed}},GPGPUContext.prototype.downloadMatrixFromPackedTexture=function(texture,physicalRows,physicalCols){var _this=this;return this.downloadMatrixDriver(texture,function(){return gpgpu_util.downloadMatrixFromPackedOutputTexture(_this.gl,_this.debug,physicalRows,physicalCols)})},GPGPUContext.prototype.createProgram=function(fragmentShaderSource){this.throwIfDisposed();var gl=this.gl,fragmentShader=webgl_util.createFragmentShader(gl,this.debug,fragmentShaderSource),vertexShader=gpgpu_util.createVertexShader(gl,this.debug),program=webgl_util.createProgram(gl,this.debug);return webgl_util.callAndCheck(gl,this.debug,function(){return gl.attachShader(program,vertexShader)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.attachShader(program,fragmentShader)}),webgl_util.linkProgram(gl,this.debug,program),this.debug&&webgl_util.validateProgram(gl,this.debug,program),this.vertexAttrsAreBound||(this.setProgram(program),this.vertexAttrsAreBound=gpgpu_util.bindVertexProgramAttributeStreams(gl,this.debug,this.program,this.vertexBuffer)),program},GPGPUContext.prototype.deleteProgram=function(program){var _this=this;this.throwIfDisposed(),program===this.program&&(this.program=null),null!=program&&webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.deleteProgram(program)})},GPGPUContext.prototype.setProgram=function(program){var _this=this;this.throwIfDisposed(),this.program=program,null!=this.program&&this.debug&&webgl_util.validateProgram(this.gl,this.debug,this.program),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.useProgram(program)})},GPGPUContext.prototype.getUniformLocation=function(program,uniformName,shouldThrow){return void 0===shouldThrow&&(shouldThrow=!0),this.throwIfDisposed(),shouldThrow?webgl_util.getProgramUniformLocationOrThrow(this.gl,this.debug,program,uniformName):webgl_util.getProgramUniformLocation(this.gl,program,uniformName)},GPGPUContext.prototype.getAttributeLocation=function(program,attribute){var _this=this;return this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.getAttribLocation(program,attribute)})},GPGPUContext.prototype.getUniformLocationNoThrow=function(program,uniformName){return this.throwIfDisposed(),this.gl.getUniformLocation(program,uniformName)},GPGPUContext.prototype.setInputMatrixTexture=function(inputMatrixTexture,uniformLocation,textureUnit){this.throwIfDisposed(),this.throwIfNoProgram(),webgl_util.bindTextureToProgramUniformSampler(this.gl,this.debug,this.program,inputMatrixTexture,uniformLocation,textureUnit)},GPGPUContext.prototype.setOutputMatrixTexture=function(outputMatrixTexture,rows,columns){this.setOutputMatrixTextureDriver(outputMatrixTexture,columns,rows)},GPGPUContext.prototype.setOutputPackedMatrixTexture=function(outputPackedMatrixTexture,rows,columns){this.throwIfDisposed();var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns),width=_a[0],height=_a[1];this.setOutputMatrixTextureDriver(outputPackedMatrixTexture,width,height)},GPGPUContext.prototype.setOutputMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){this.setOutputMatrixWriteRegionDriver(startColumn,startRow,numColumns,numRows)},GPGPUContext.prototype.setOutputPackedMatrixWriteRegion=function(startRow,numRows,startColumn,numColumns){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},GPGPUContext.prototype.debugValidate=function(){null!=this.program&&webgl_util.validateProgram(this.gl,this.debug,this.program),webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var gl=this.gl;this.debug&&this.debugValidate(),webgl_util.callAndCheck(gl,this.debug,function(){return gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)})},GPGPUContext.prototype.blockUntilAllProgramsCompleted=function(){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.finish()})},GPGPUContext.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=webgl_util.getExtensionOrThrow(this.gl,this.debug,2===environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},GPGPUContext.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},GPGPUContext.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},GPGPUContext.prototype.beginQuery=function(){if(2===environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var gl2=this.gl,ext_1=this.getQueryTimerExtensionWebGL2(),query_1=gl2.createQuery();return gl2.beginQuery(ext_1.TIME_ELAPSED_EXT,query_1),query_1}var ext=this.getQueryTimerExtensionWebGL1(),query=ext.createQueryEXT();return ext.beginQueryEXT(ext.TIME_ELAPSED_EXT,query),query},GPGPUContext.prototype.endQuery=function(){if(2!==environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var ext=this.getQueryTimerExtensionWebGL1();ext.endQueryEXT(ext.TIME_ELAPSED_EXT)}else{var gl2=this.gl,ext_2=this.getQueryTimerExtensionWebGL2();gl2.endQuery(ext_2.TIME_ELAPSED_EXT)}},GPGPUContext.prototype.waitForQueryAndGetTime=function(query){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){switch(_a.label){case 0:return[4,util.repeatedTry(function(){return _this.disposed||_this.isQueryAvailable(query,environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return _a.sent(),[2,this.getQueryTime(query,environment_1.ENV.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},GPGPUContext.prototype.getQueryTime=function(query,queryTimerVersion){if(0===queryTimerVersion)return null;if(2===queryTimerVersion){var gl2=this.gl;return gl2.getQueryParameter(query,gl2.QUERY_RESULT)/1e6}var ext=this.getQueryTimerExtensionWebGL1();return ext.getQueryObjectEXT(query,ext.QUERY_RESULT_EXT)/1e6},GPGPUContext.prototype.isQueryAvailable=function(query,queryTimerVersion){if(0===queryTimerVersion)return!0;if(2===queryTimerVersion){var gl2=this.gl,ext=this.getQueryTimerExtensionWebGL2(),available=gl2.getQueryParameter(query,gl2.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(ext.GPU_DISJOINT_EXT)),available&&!this.disjoint}available=(ext=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(query,ext.QUERY_RESULT_AVAILABLE_EXT);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(ext.GPU_DISJOINT_EXT)),available&&!this.disjoint},GPGPUContext.prototype.pollFence=function(fenceContext){var _this=this;return new Promise(function(resolve){_this.addItemToPoll(function(){return fenceContext.isFencePassed()},function(){return resolve()})})},GPGPUContext.prototype.pollItems=function(){for(var index=linearSearchLastTrue(this.itemsToPoll.map(function(x){return x.isDoneFn})),i=0;i<=index;++i){(0,this.itemsToPoll[i].resolveFn)()}this.itemsToPoll=this.itemsToPoll.slice(index+1)},GPGPUContext.prototype.addItemToPoll=function(isDoneFn,resolveFn){var _this=this;this.itemsToPoll.push({isDoneFn:isDoneFn,resolveFn:resolveFn}),1<this.itemsToPoll.length||util.repeatedTry(function(){return _this.pollItems(),0===_this.itemsToPoll.length})},GPGPUContext.prototype.bindTextureToFrameBuffer=function(texture){this.throwIfDisposed(),webgl_util.bindColorTextureToFramebuffer(this.gl,this.debug,texture,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(this.gl)},GPGPUContext.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(webgl_util.bindColorTextureToFramebuffer(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(this.gl)):webgl_util.unbindColorTextureFromFramebuffer(this.gl,this.debug,this.framebuffer)},GPGPUContext.prototype.downloadMatrixDriver=function(texture,downloadAndDecode){this.bindTextureToFrameBuffer(texture);var result=downloadAndDecode();return this.unbindTextureToFrameBuffer(),result},GPGPUContext.prototype.setOutputMatrixTextureDriver=function(outputMatrixTextureMaybePacked,width,height){this.throwIfDisposed();var gl=this.gl;webgl_util.bindColorTextureToFramebuffer(gl,this.debug,outputMatrixTextureMaybePacked,this.framebuffer),this.debug&&webgl_util.validateFramebuffer(gl),this.outputTexture=outputMatrixTextureMaybePacked,webgl_util.callAndCheck(gl,this.debug,function(){return gl.viewport(0,0,width,height)}),webgl_util.callAndCheck(gl,this.debug,function(){return gl.scissor(0,0,width,height)})},GPGPUContext.prototype.setOutputMatrixWriteRegionDriver=function(x,y,width,height){var _this=this;this.throwIfDisposed(),webgl_util.callAndCheck(this.gl,this.debug,function(){return _this.gl.scissor(x,y,width,height)})},GPGPUContext.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},GPGPUContext.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},GPGPUContext}();function linearSearchLastTrue(arr){for(var i=0;i<arr.length;++i){if(!arr[i]())break}return i-1}exports.GPGPUContext=GPGPUContext,exports.linearSearchLastTrue=linearSearchLastTrue},{"../../environment":144,"../../util":241,"./canvas_util":70,"./gpgpu_util":101,"./tex_util":131,"./webgl_util":139}],100:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),shader_compiler=require("./shader_compiler");function validateBinaryAndProgram(shapeInfos,inputs){if(shapeInfos.length!==inputs.length)throw Error("Binary was compiled with "+shapeInfos.length+" inputs, but was executed with "+inputs.length+" inputs");shapeInfos.forEach(function(s,i){var shapeA=s.logicalShape,input=inputs[i],shapeB=input.shape;if(!util.arraysEqual(shapeA,shapeB))throw Error("Binary was compiled with different shapes than the current args. Shapes "+shapeA+" and "+shapeB+" must match");if(!s.isUniform||!input.isUniform){var texShapeA=s.texShape,texShapeB=input.isUniform?null:input.texData.texShape;if(!util.arraysEqual(texShapeA,texShapeB))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+texShapeA+" and "+texShapeB+" must match")}})}exports.compileProgram=function(gpgpu,program,inputs,output){var userCode=program.userCode,inputInfos=inputs.map(function(input,i){var shapeInfo={logicalShape:input.shape,texShape:input.isUniform?null:input.texData.texShape,isUniform:input.isUniform,isPacked:!input.isUniform&&input.texData.isPacked,flatOffset:null};return null!=input.texData&&null!=input.texData.slice&&0<input.texData.slice.flatOffset&&(shapeInfo.flatOffset=input.texData.slice.flatOffset),{name:program.variableNames[i],shapeInfo:shapeInfo}}),inShapeInfos=inputInfos.map(function(x){return x.shapeInfo}),outShapeInfo={logicalShape:output.shape,texShape:output.texData.texShape,isUniform:!1,isPacked:output.texData.isPacked,flatOffset:null},source=shader_compiler.makeShader(inputInfos,outShapeInfo,userCode,program.usesPackedTextures),webGLProgram=gpgpu.createProgram(source),infLoc=null,nanLoc=gpgpu.getUniformLocation(webGLProgram,"NAN",!1);1===environment_1.ENV.getNumber("WEBGL_VERSION")&&(infLoc=gpgpu.getUniformLocation(webGLProgram,"INFINITY",!1));for(var uniformLocations={},i=0;i<program.variableNames.length;i++){var varName=program.variableNames[i];uniformLocations[varName]=gpgpu.getUniformLocation(webGLProgram,varName,!1),uniformLocations["offset"+varName]=gpgpu.getUniformLocation(webGLProgram,"offset"+varName,!1)}return{program:program,source:source,webGLProgram:webGLProgram,uniformLocations:uniformLocations,inShapeInfos:inShapeInfos,outShapeInfo:outShapeInfo,infLoc:infLoc,nanLoc:nanLoc}},exports.runProgram=function(gpgpu,binary,inputs,output,customSetup){validateBinaryAndProgram(binary.inShapeInfos,inputs),validateBinaryAndProgram([binary.outShapeInfo],[output]);var outTex=output.texData.texture,outTexShape=output.texData.texShape;output.texData.isPacked?gpgpu.setOutputPackedMatrixTexture(outTex,outTexShape[0],outTexShape[1]):gpgpu.setOutputMatrixTexture(outTex,outTexShape[0],outTexShape[1]),gpgpu.setProgram(binary.webGLProgram),1===environment_1.ENV.getNumber("WEBGL_VERSION")&&null!==binary.infLoc&&gpgpu.gl.uniform1f(binary.infLoc,1/0),null!==binary.nanLoc&&gpgpu.gl.uniform1f(binary.nanLoc,NaN),inputs.forEach(function(input,i){var varName=binary.program.variableNames[i],varLoc=binary.uniformLocations[varName],varOffsetLoc=binary.uniformLocations["offset"+varName];if(null!=varLoc)if(input.isUniform)if(util.sizeFromShape(input.shape)<2)gpgpu.gl.uniform1f(varLoc,input.uniformValues[0]);else{var vals=input.uniformValues;vals instanceof Float32Array||(vals=new Float32Array(vals)),gpgpu.gl.uniform1fv(varLoc,vals)}else null!=input.texData.slice&&null!=varOffsetLoc&&gpgpu.gl.uniform1i(varOffsetLoc,input.texData.slice.flatOffset),gpgpu.setInputMatrixTexture(input.texData.texture,varLoc,i)}),null!=customSetup&&customSetup(gpgpu,binary.webGLProgram),gpgpu.executeProgram()},exports.makeShaderKey=function(program,inputs,output){var keyInputs="";inputs.concat(output).forEach(function(x){var hasOffset=null!=x.texData&&null!=x.texData.slice&&0<x.texData.slice.flatOffset,texShape=x.isUniform?"uniform":x.texData.texShape;keyInputs+=x.shape+"_"+texShape+"_"+hasOffset});var keyUserCode=program.userCode,key=program.constructor.name;return key+="_"+keyInputs+"_"+keyUserCode}},{"../../environment":144,"../../util":241,"./shader_compiler":126}],101:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var glsl_version_1=require("./glsl_version"),tex_util=require("./tex_util"),webgl_util=require("./webgl_util");function createAndConfigureTexture(gl,debug,width,height,internalFormat,textureFormat,textureType){webgl_util.validateTextureSize(width,height);var texture=webgl_util.createTexture(gl,debug),tex2d=gl.TEXTURE_2D;return webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(tex2d,texture)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_MIN_FILTER,gl.NEAREST)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texParameteri(tex2d,gl.TEXTURE_MAG_FILTER,gl.NEAREST)}),webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(tex2d,0,internalFormat,width,height,0,textureFormat,textureType,null)}),webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)}),texture}exports.createVertexShader=function(gl,debug){var glsl=glsl_version_1.getGlslDifferences(),vertexShaderSource=glsl.version+"\n    precision highp float;\n    "+glsl.attribute+" vec3 clipSpacePos;\n    "+glsl.attribute+" vec2 uv;\n    "+glsl.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }";return webgl_util.createVertexShader(gl,debug,vertexShaderSource)},exports.createVertexBuffer=function(gl,debug){var vertexArray=new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]);return webgl_util.createStaticVertexBuffer(gl,debug,vertexArray)},exports.createIndexBuffer=function(gl,debug){var triangleVertexIndices=new Uint16Array([0,1,2,2,1,3]);return webgl_util.createStaticIndexBuffer(gl,debug,triangleVertexIndices)},exports.createFloat32MatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatFloat,textureConfig.textureFormatFloat,gl.FLOAT)},exports.createFloat16MatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatHalfFloat,textureConfig.textureFormatFloat,textureConfig.textureTypeHalfFloat)},exports.createUnsignedBytesMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE)},exports.createPackedMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatPackedFloat,gl.RGBA,gl.FLOAT)},exports.createFloat16PackedMatrixTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getPackedMatrixTextureShapeWidthHeight(rows,columns);return createAndConfigureTexture(gl,debug,_a[0],_a[1],textureConfig.internalFormatPackedHalfFloat,gl.RGBA,textureConfig.textureTypeHalfFloat)},exports.bindVertexProgramAttributeStreams=function(gl,debug,program,vertexBuffer){return webgl_util.callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer)}),webgl_util.bindVertexBufferToProgramAttribute(gl,debug,program,"clipSpacePos",vertexBuffer,3,20,0)&&webgl_util.bindVertexBufferToProgramAttribute(gl,debug,program,"uv",vertexBuffer,2,20,12)},exports.uploadDenseMatrixToTexture=function(gl,debug,texture,width,height,data,textureConfig){var dataForUpload,texelDataType,internalFormat;webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}),internalFormat=data instanceof Uint8Array?(dataForUpload=new Uint8Array(width*height*4),texelDataType=gl.UNSIGNED_BYTE,gl.RGBA):(dataForUpload=new Float32Array(width*height*4),texelDataType=gl.FLOAT,textureConfig.internalFormatPackedFloat),dataForUpload.set(data),webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,width,height,0,gl.RGBA,texelDataType,dataForUpload)}),webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.uploadPixelDataToTexture=function(gl,debug,texture,pixels){webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)}),pixels.data instanceof Uint8Array?webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,pixels.width,pixels.height,0,gl.RGBA,gl.UNSIGNED_BYTE,pixels.data)}):webgl_util.callAndCheck(gl,debug,function(){return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,pixels)}),webgl_util.callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.createBufferFromOutputTexture=function(gl2,debug,rows,columns,textureConfig){var buffer=gl2.createBuffer();webgl_util.callAndCheck(gl2,debug,function(){return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer)});var bufferSizeBytes=16*rows*columns;return webgl_util.callAndCheck(gl2,debug,function(){return gl2.bufferData(gl2.PIXEL_PACK_BUFFER,bufferSizeBytes,gl2.STREAM_READ)}),webgl_util.callAndCheck(gl2,debug,function(){return gl2.readPixels(0,0,columns,rows,gl2.RGBA,gl2.FLOAT,0)}),webgl_util.callAndCheck(gl2,debug,function(){return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null)}),buffer},exports.downloadFloat32MatrixFromBuffer=function(gl,buffer,size){var gl2=gl,downloadTarget=new Float32Array(size);return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer),gl2.getBufferSubData(gl2.PIXEL_PACK_BUFFER,0,downloadTarget),gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null),downloadTarget},exports.downloadByteEncodedFloatMatrixFromOutputTexture=function(gl,debug,rows,columns,textureConfig){var _a=tex_util.getUnpackedMatrixTextureShapeWidthHeight(rows,columns),w=_a[0],h=_a[1],downloadTarget=new Uint8Array(tex_util.getUnpackedArraySizeFromMatrixSize(rows*columns,4));return webgl_util.callAndCheck(gl,debug,function(){return gl.readPixels(0,0,w,h,textureConfig.downloadTextureFormat,gl.UNSIGNED_BYTE,downloadTarget)}),new Float32Array(downloadTarget.buffer)},exports.downloadPackedMatrixFromBuffer=function(gl,buffer,batch,rows,cols,physicalRows,physicalCols,textureConfig){var gl2=gl,downloadTarget=new Float32Array(tex_util.getPackedRGBAArraySizeFromMatrixShape(physicalRows,physicalCols));return gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,buffer),gl2.getBufferSubData(gl2.PIXEL_PACK_BUFFER,0,downloadTarget),gl2.bindBuffer(gl2.PIXEL_PACK_BUFFER,null),downloadTarget},exports.downloadMatrixFromPackedOutputTexture=function(gl,debug,physicalRows,physicalCols){var packedRGBA=new Float32Array(physicalRows*physicalCols*4);return webgl_util.callAndCheck(gl,debug,function(){return gl.readPixels(0,0,physicalCols,physicalRows,gl.RGBA,gl.FLOAT,packedRGBA)}),packedRGBA}},{"./glsl_version":98,"./tex_util":131,"./webgl_util":139}],102:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Im2ColPackedProgram(outputShape,inputShape,convInfo){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=outputShape;for(var filterWidth=convInfo.filterWidth,inChannels=convInfo.inChannels,strideWidth=convInfo.strideWidth,strideHeight=convInfo.strideHeight,padInfo=convInfo.padInfo,outWidth=convInfo.outWidth,dilationWidth=convInfo.dilationWidth,dilationHeight=convInfo.dilationHeight,dataFormat=convInfo.dataFormat,left=padInfo.left,top=padInfo.top,itemsPerBlockRow=inChannels*filterWidth,glsl=glsl_version_1.getGlslDifferences(),isChannelsLast="channelsLast"===dataFormat,rowDim=isChannelsLast?0:1,colDim=isChannelsLast?1:2,unrolled="",row=0;row<=1;row++)for(var col=0;col<=1;col++)unrolled+="\n          blockIndex = rc.y + "+col+";\n          pos = rc.x + "+row+";\n\n          if(blockIndex < "+outputShape[1]+" && pos < "+outputShape[0]+") {\n            offsetY = int(blockIndex / ("+outWidth+")) * "+strideHeight+" - "+top+";\n            d0 = offsetY + "+dilationHeight+" * (pos / "+itemsPerBlockRow+");\n\n            if(d0 < "+inputShape[rowDim]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+outWidth+".) * "+strideWidth+". - "+left+".);\n              d1 = offsetX + "+dilationWidth+" * (int(mod(float(pos), "+itemsPerBlockRow+".) / "+inChannels+".));\n\n              if(d1 < "+inputShape[colDim]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+inChannels+".));\n\n                if ("+isChannelsLast+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*row+col)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*row+col)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+unrolled+"\n\n        "+glsl.output+" = result;\n      }\n    "}var glsl_version_1=require("./glsl_version");exports.Im2ColPackedProgram=Im2ColPackedProgram},{"./glsl_version":98}],103:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function LRNProgram(xShape,radius,bias,alpha,beta){this.variableNames=["x"],this.outputShape=[];var powOperator,rad=radius,maxD=xShape[3]-1;this.outputShape=xShape;var basis="float("+bias+") + float("+alpha+") * sum";powOperator=.5===beta?"inversesqrt("+basis+")":1===beta?"1.0/("+basis+")":"exp(log("+basis+") * float(-"+beta+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+rad+"; j <= "+rad+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+maxD+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+powOperator+";\n        setOutput(val);\n      }\n    "}exports.LRNProgram=LRNProgram},{}],104:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function LRNGradProgram(inputShape,depthRadius,bias,alpha,beta){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=inputShape,this.depth=inputShape[3],this.depthRadius=depthRadius,this.bias=bias,this.alpha=alpha,this.beta=beta,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+depthRadius+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+depthRadius+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+alpha+") * norm + float("+bias+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+alpha+")\n                * float("+beta+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+beta+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "}exports.LRNGradProgram=LRNGradProgram},{}],105:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function LRNPackedProgram(xShape,radius,bias,alpha,beta){this.variableNames=["x"],this.outputShape=[],this.usesPackedTextures=!0;var powOperator,rad=radius,maxD=xShape[3]-1;this.outputShape=xShape;var basis="float("+bias+") + float("+alpha+") * sum";powOperator=.5===beta?"inversesqrt("+basis+")":1===beta?"1.0/("+basis+")":"exp(log("+basis+") * float(-"+beta+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+rad+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+rad+"; j <= "+rad+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+maxD+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+powOperator+";\n        setOutput(result);\n      }\n    "}exports.LRNPackedProgram=LRNPackedProgram},{}],106:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function MaxPool2DBackpropProgram(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,lastIndex=effectiveFilterHeight*effectiveFilterWidth-1;this.userCode="\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n          wR += "+dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+effectiveFilterWidth+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+lastIndex+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+effectiveFilterWidth+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.MaxPool2DBackpropProgram=MaxPool2DBackpropProgram;function MaxPool3DBackpropProgram(convInfo){this.variableNames=["dy","maxPos"],this.outputShape=convInfo.inShape;var strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=effectiveFilterDepth-1-convInfo.padInfo.front,padTop=effectiveFilterHeight-1-convInfo.padInfo.top,padLeft=effectiveFilterWidth-1-convInfo.padInfo.left,lastIndex=effectiveFilterDepth*effectiveFilterHeight*effectiveFilterWidth-1;this.userCode="\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n           wD += "+dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+convInfo.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+convInfo.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+convInfo.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+lastIndex+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+effectiveFilterHeight+" * "+effectiveFilterWidth+" +\n                  wR * "+effectiveFilterWidth+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}exports.MaxPool3DBackpropProgram=MaxPool3DBackpropProgram},{}],107:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function MatMulPackedProgram(aShape,outputShape,transposeA,transposeB,addBias,activation,hasPreluActivation){void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1),void 0===addBias&&(addBias=!1),void 0===activation&&(activation=null),void 0===hasPreluActivation&&(hasPreluActivation=!1),this.variableNames=["matrixA","matrixB"],this.usesPackedTextures=!0,this.outputShape=outputShape;var sharedDim=transposeA?aShape[1]:aShape[2],sharedDimensionPacked=Math.ceil(sharedDim/2),aSample=transposeA?"i * 2, rc.y":"rc.y, i * 2",bSample=transposeB?"rc.z, i * 2":"i * 2, rc.z",aSwizzle=transposeA?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],bSwizzle=transposeB?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],activationSnippet="",applyActivationSnippet="";activation&&(activationSnippet=hasPreluActivation?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+activation+"\n        }":"vec4 activation(vec4 x) {\n          "+activation+"\n        }",applyActivationSnippet="result = activation(result);");var addBiasSnippet=addBias?"result += getBiasAtOutCoords();":"";addBias&&this.variableNames.push("bias"),hasPreluActivation&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+activationSnippet+"\n\n      const float sharedDimension = "+sharedDimensionPacked+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+sharedDimensionPacked+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+aSample+");\n          vec4 b = getMatrixB(rc.x, "+bSample+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+aSwizzle[0]+" * "+bSwizzle[0]+");\n          result += ("+aSwizzle[1]+" * "+bSwizzle[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+addBiasSnippet+"\n\n        "+applyActivationSnippet+"\n\n        setOutput(result);\n      }\n    "}exports.MatMulPackedProgram=MatMulPackedProgram},{}],108:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MultinomialProgram=function(){function MultinomialProgram(batchSize,numOutcomes,numSamples){this.variableNames=["probs"],this.outputShape=[batchSize,numSamples],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(numOutcomes-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(numOutcomes-1)+"));\n      }\n    "}return MultinomialProgram.prototype.getCustomSetupFunc=function(seed){var _this=this;return function(gpgpu,webGLProgram){null==_this.seedLoc&&(_this.seedLoc=gpgpu.getUniformLocation(webGLProgram,"seed")),gpgpu.gl.uniform1f(_this.seedLoc,seed)}},MultinomialProgram}();exports.MultinomialProgram=MultinomialProgram},{}],109:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function OneHotProgram(numIndices,depth,onValue,offValue){this.variableNames=["indices"],this.outputShape=[numIndices,depth],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+offValue+"), float("+onValue+"),\n                      float(index == coords.y)));\n      }\n    "}exports.OneHotProgram=OneHotProgram},{}],110:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function PackProgram(outputShape){this.variableNames=["A"];var rank=(this.outputShape=outputShape).length;if(0===rank)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var channels=packing_util_1.getChannels("rc",rank),dtype=shader_compiler_1.getCoordsDataType(rank),outOfBoundsCondition=function(rank,shape,dims){if(1===rank)return"rc > "+shape[0];for(var cond="",i=rank-2;i<rank;i++)cond+=dims[i]+" >= "+shape[i],i<rank-1&&(cond+="||");return cond}(rank,outputShape,channels),setup=function(rank,cols,rows,dims){if(1===rank)return"";var innerDims=dims.slice(-2);return"\n    int r = "+innerDims[0]+";\n    int c = "+innerDims[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+cols+";\n    bool rEdge = rp1 >= "+rows+";\n  "}(rank,outputShape[outputShape.length-1],outputShape[outputShape.length-2],channels),output=function(shape,dims){var rank=shape.length,sourceCoords=function(rank,dims){for(var coords=[],row=0;row<=1;row++)for(var col=0;col<=1;col++){for(var coord=(0===row?"r":"rp1")+", "+(0===col?"c":"cp1"),d=2;d<rank;d++)coord=dims[dims.length-1-d]+","+coord;coords.push(coord)}return coords}(rank,dims);return 1!==rank?"getA("+sourceCoords[0]+"),\n          cEdge ? 0. : getA("+sourceCoords[1]+"),\n          rEdge ? 0. : getA("+sourceCoords[2]+"),\n          rEdge || cEdge ? 0. : getA("+sourceCoords[3]+")":"getA(rc),\n            rc + 1 >= "+shape[0]+" ? 0. : getA(rc + 1),\n            0, 0"}(outputShape,channels);this.userCode="\n        void main() {\n          "+dtype+" rc = getOutputCoords();\n\n          if("+outOfBoundsCondition+") {\n            setOutput(vec4(0));\n          } else {\n            "+setup+"\n\n            setOutput(vec4("+output+"));\n          }\n        }\n      "}}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.PackProgram=PackProgram},{"../packing_util":55,"./shader_compiler":126}],111:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function PadProgram(xShape,paddings,constantValue){this.variableNames=["x"],this.outputShape=paddings.map(function(p,i){return p[0]+xShape[i]+p[1]});var rank=xShape.length,type=shader_compiler_1.getCoordsDataType(rank),start=paddings.map(function(p){return p[0]}).join(","),end=paddings.map(function(p,i){return p[0]+xShape[i]}).join(","),unpackedCoords=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,rank);this.userCode=1!==rank?"\n      "+type+" start = "+type+"("+start+");\n      "+type+" end = "+type+"("+end+");\n\n      void main() {\n        "+type+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+constantValue+"));\n        } else {\n          "+type+" coords = outC - start;\n          setOutput(getX("+unpackedCoords+"));\n        }\n      }\n    ":"\n        int start = "+start+";\n        int end = "+end+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+constantValue+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.PadProgram=PadProgram},{"./shader_compiler":126}],112:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function PadPackedProgram(xShape,paddings,constantValue){this.variableNames=["x"],this.usesPackedTextures=!0,this.outputShape=paddings.map(function(p,i){return p[0]+xShape[i]+p[1]});for(var rank=xShape.length,dtype=shader_compiler_1.getCoordsDataType(rank),start=paddings.map(function(p){return p[0]}).join(","),end=paddings.map(function(p,i){return p[0]+xShape[i]}).join(","),coords=packing_util_1.getChannels("rc",rank),source=packing_util_1.getChannels("source",rank),cLimit=coords[rank-1]+" < "+this.outputShape[rank-1],innerDims=1===rank?"source":"vec2("+source.slice(-2).join()+")",componentSetup=[dtype+" rc = outputLoc;",coords[rank-1]+" += 1;\n       if("+cLimit+") {\n      ",1===rank?"":"}\n       rc = outputLoc;\n       "+coords[rank-2]+" += 1;\n       if("+coords[rank-2]+" < "+this.outputShape[rank-2]+") {",1===rank?"":"  "+coords[rank-1]+" += 1;\n         if("+cLimit+") {"],paddingArea=1===rank?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",mainLoop="",i=0,j=1===rank?2:4;i<j;i++)mainLoop+="\n        "+componentSetup[i]+"\n        if ("+paddingArea+") {\n          result["+i+"] = float("+constantValue+");\n        } else {\n          "+dtype+" source = rc - start;\n          result["+i+"] = getChannel(getX("+source.join()+"), "+innerDims+");\n        }\n      ";mainLoop+=1===rank?"} ":"}}",this.userCode="\n      const "+dtype+" start = "+dtype+"("+start+");\n      const "+dtype+" end = "+dtype+"("+end+");\n\n      void main() {\n        "+dtype+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+mainLoop+"\n        setOutput(result);\n      }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.PadPackedProgram=PadPackedProgram},{"../packing_util":55,"./shader_compiler":126}],113:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function Pool2DProgram(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterWidth=convInfo.filterWidth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="-1.0 / 1e-20"),computePositions)this.userCode="\n        const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n        const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n              wR += "+dilationHeight+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+effectiveFilterWidth+";\n                wC += "+dilationWidth+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+effectiveFilterWidth+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / count");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+strideHeight+", "+strideWidth+");\n      const ivec2 pads = ivec2("+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+convInfo.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+convInfo.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n            int xC = xCCorner + wC * "+dilationWidth+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              getValue(batch, xR, xC + 2 * "+dilationWidth+", d),\n              getValue(batch, xR, xC + 3 * "+dilationWidth+", d)\n            );\n\n            "+updateSnippet+"\n          }\n\n          int xC = xCCorner + "+filterWidthNearestVec4+";\n          if ("+(1==filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(2==filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          } else if ("+(3==filterWidthVec4Remainder)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+dilationWidth+", d),\n              getValue(batch, xR, xC + 2 * "+dilationWidth+", d),\n              initializationValue\n            );\n\n            "+updateSnippet+"\n          }\n        }\n        setOutput("+returnValue+");\n      }\n    "}}exports.Pool2DProgram=Pool2DProgram;function Pool3DProgram(convInfo,poolType,computePositions){if(this.variableNames=["x"],"avg"===poolType&&computePositions)throw new Error("Cannot compute positions for average pool.");var filterWidth=convInfo.filterWidth,strideDepth=convInfo.strideDepth,strideHeight=convInfo.strideHeight,strideWidth=convInfo.strideWidth,dilationDepth=convInfo.dilationDepth,dilationHeight=convInfo.dilationHeight,dilationWidth=convInfo.dilationWidth,effectiveFilterDepth=convInfo.effectiveFilterDepth,effectiveFilterHeight=convInfo.effectiveFilterHeight,effectiveFilterWidth=convInfo.effectiveFilterWidth,padFront=convInfo.padInfo.front,padTop=convInfo.padInfo.top,padLeft=convInfo.padInfo.left;this.outputShape=convInfo.outShape;var isAvgPool="avg"===poolType,initializationValue="0.0";if(isAvgPool||(initializationValue="-1.0 / 1e-20"),computePositions)this.userCode="\n        const ivec3 strides =\n            ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n        const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+effectiveFilterDepth+";\n              wD += "+dilationDepth+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+convInfo.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+effectiveFilterHeight+";\n                wR += "+dilationHeight+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+convInfo.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+effectiveFilterWidth+";\n                  wC += "+dilationWidth+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+convInfo.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+effectiveFilterHeight+" * "+effectiveFilterWidth+" +\n                      wR * "+effectiveFilterWidth+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var returnValue=poolType+"("+poolType+"("+poolType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===poolType&&(returnValue="avgValue / count");var filterWidthNearestVec4=4*Math.floor(filterWidth/4),filterWidthVec4Remainder=filterWidth%4,updateSnippet="\n      if ("+isAvgPool+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+strideDepth+", "+strideHeight+", "+strideWidth+");\n      const ivec3 pads = ivec3("+padFront+", "+padTop+", "+padLeft+");\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+convInfo.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+effectiveFilterDepth+";\n            wD += "+dilationDepth+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+convInfo.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+effectiveFilterHeight+";\n            wR += "+dilationHeight+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+convInfo.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+filterWidthNearestVec4+"; wC += 4) {\n              int xC = xCCorner + wC * "+dilationWidth+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+dilationWidth+", ch)\n              );\n\n              "+updateSnippet+"\n            }\n\n            int xC = xCCorner + "+filterWidthNearestVec4+";\n            if ("+(1==filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            } else if ("+(2==filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            } else if ("+(3==filterWidthVec4Remainder)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+dilationWidth+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+dilationWidth+", ch),\n                initializationValue\n              );\n\n              "+updateSnippet+"\n            }\n          }\n          setOutput("+returnValue+");\n        }\n      }\n    "}}exports.Pool3DProgram=Pool3DProgram},{}],114:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReduceProgram(reduceInfo,reduceType){this.variableNames=["x"];var windowSize=reduceInfo.windowSize,batchSize=reduceInfo.batchSize,inSize=reduceInfo.inSize,outSize=Math.ceil(inSize/windowSize);this.outputShape=[batchSize,outSize];var initializationValue="0.0",compareOp="";"prod"===reduceType?initializationValue="1.0":"min"===reduceType?(initializationValue="1.0 / 1e-20",compareOp="min"):"max"===reduceType&&(initializationValue="-1.0 / 1e-20",compareOp="max");var returnValue=reduceType+"("+reduceType+"("+reduceType+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===reduceType?returnValue="sumValue":"prod"===reduceType?returnValue="prodValue":"all"===reduceType?returnValue="allValue":"any"===reduceType&&(returnValue="anyValue");var windowSizeNearestVec4=4*Math.floor(windowSize/4),windowSizeVec4Remainder=windowSize%4,updateSnippet="\n      if ("+("sum"===reduceType)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===reduceType)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+compareOp+"(values, minMaxValue);\n      }\n    ",vecType="vec4";"all"===reduceType?(initializationValue="1.0",updateSnippet="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",vecType="bvec4"):"any"===reduceType&&(initializationValue="0.0",updateSnippet="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",vecType="bvec4");var checkOutOfBounds="";0<inSize%windowSize&&(checkOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+initializationValue+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+checkOutOfBounds+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+windowSize+";\n\n        vec4 minMaxValue = vec4("+initializationValue+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+windowSizeNearestVec4+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+updateSnippet+"\n        }\n\n        int inIdx = inOffset + "+windowSizeNearestVec4+";\n        if ("+(1==windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        } else if ("+(2==windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        } else if ("+(3==windowSizeVec4Remainder)+") {\n          "+vecType+" values = "+vecType+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+updateSnippet+"\n        }\n        setOutput("+returnValue+");\n      }\n    "}exports.ReduceProgram=ReduceProgram},{}],115:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReshapePackedProgram(outputShape,inputShape){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=outputShape;for(var mainLoop="",i=0;i<4;i++){var thisRC="thisRC = rc;";i%2==1&&(thisRC+="thisRC.z += 1;"),1<i&&(thisRC+="thisRC.y += 1;"),mainLoop+="\n        "+thisRC+"\n        "+(0<i?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+i+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(0<i?"}":"")+"\n      "}this.userCode="\n      "+function(shape){return"\n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],shape)+"\n      return ivec3(r, c, d);\n    }\n  "}(inputShape)+"\n      "+shader_util.getFlatIndexFrom3D(outputShape)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+outputShape[1]+";\n        int cols = "+outputShape[2]+";\n\n        "+mainLoop+"\n\n        setOutput(result);\n      }\n    "}var shader_util=require("./shader_compiler_util");exports.ReshapePackedProgram=ReshapePackedProgram},{"./shader_compiler_util":127}],116:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeBilinearBackpropProgram(dy,x,alignCorners){this.variableNames=["dy"],this.outputShape=[],this.outputShape=x.shape;var _a=x.shape,xHeight=_a[1],xWidth=_a[2],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+heightScale+");\n        const float widthScale = float("+widthScale+");\n\n        const float invHeightScale = float("+invHeightScale+");\n        const float invWidthScale = float("+invWidthScale+");\n\n        const int winHeight = int("+winHeight+");\n        const int winWidth = int("+winWidth+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+yHeight+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+yWidth+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(xHeight-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(xWidth-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}exports.ResizeBilinearBackpropProgram=ResizeBilinearBackpropProgram},{}],117:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeBilinearProgram(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec2 inputShapeRC = vec2("+oldHeight+".0, "+oldWidth+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "}exports.ResizeBilinearProgram=ResizeBilinearProgram},{}],118:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeBilinearPackedProgram(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec3 inputShapeRC = vec3("+oldHeight+".0, "+oldWidth+".0,\n                                     "+oldWidth+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n        \n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(depth-1)+"; \n        bool hasNextRow = coords.z < "+(newWidth-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "}exports.ResizeBilinearPackedProgram=ResizeBilinearPackedProgram},{}],119:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeNearestNeigborBackpropProgram(dy,x,alignCorners){this.variableNames=["dy"],this.outputShape=[],this.outputShape=x.shape;var _a=x.shape,xHeight=_a[1],xWidth=_a[2],_b=dy.shape,yHeight=_b[1],yWidth=_b[2],effectiveXSize=[alignCorners&&1<yHeight?xHeight-1:xHeight,alignCorners&&1<yWidth?xWidth-1:xWidth],effectiveYSize=[alignCorners&&1<yHeight?yHeight-1:yHeight,alignCorners&&1<yWidth?yWidth-1:yWidth],heightScale=effectiveXSize[0]/effectiveYSize[0],widthScale=effectiveXSize[1]/effectiveYSize[1],invHeightScale=1/heightScale,invWidthScale=1/widthScale,winHeight=2*Math.ceil(invHeightScale)+2,winWidth=2*Math.ceil(invWidthScale)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+heightScale+");\n        const float widthScale = float("+widthScale+");\n\n        const float invHeightScale = float("+invHeightScale+");\n        const float invWidthScale = float("+invWidthScale+");\n\n        const int winHeight = int("+winHeight+");\n        const int winWidth = int("+winWidth+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+yHeight+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+yWidth+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+effectiveXSize[0]+") *\n                (float(dyR) / float("+effectiveYSize[0]+"));\n\n            float sourceFracCol =\n                float("+effectiveXSize[1]+") *\n                  (float(dyC) / float("+effectiveYSize[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+xHeight+") - 1),\n                "+alignCorners+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+xWidth+") - 1),\n                "+alignCorners+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}exports.ResizeNearestNeigborBackpropProgram=ResizeNearestNeigborBackpropProgram},{}],120:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ResizeNearestNeighborProgram(inputShape,newHeight,newWidth,alignCorners){this.variableNames=["A"],this.outputShape=[];var batch=inputShape[0],oldHeight=inputShape[1],oldWidth=inputShape[2],depth=inputShape[3];this.outputShape=[batch,newHeight,newWidth,depth];var effectiveInSize=[alignCorners&&1<newHeight?oldHeight-1:oldHeight,alignCorners&&1<newWidth?oldWidth-1:oldWidth],effectiveOutSize=[alignCorners&&1<newHeight?newHeight-1:newHeight,alignCorners&&1<newWidth?newWidth-1:newWidth],roundBase=alignCorners?"0.5":"0.0";this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+effectiveInSize[0]/effectiveOutSize[0]+",\n          "+effectiveInSize[1]/effectiveOutSize[1]+");\n      const vec2 inputShapeRC = vec2("+oldHeight+".0, "+oldWidth+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+roundBase+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "}exports.ResizeNearestNeighborProgram=ResizeNearestNeighborProgram},{}],121:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReverseProgram(xShape,axis){this.variableNames=["x"];var rank=xShape.length;if(4<rank)throw new Error("WebGL backend: Reverse of rank-"+rank+" tensor is not yet supported");if(this.outputShape=xShape,1!==rank){var inCoords=xShape.map(function(_,i){return function(i){return-1!==axis.indexOf(i)&&1!==xShape[i]?xShape[i]+" - coords["+i+"] - 1":"coords["+i+"]"}(i)}).join(","),type=shader_compiler_1.getCoordsDataType(rank);this.userCode="\n      void main() {\n        "+type+" coords = getOutputCoords();\n        setOutput(getX("+inCoords+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+xShape[0]+" - coord - 1));\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.ReverseProgram=ReverseProgram},{"./shader_compiler":126}],122:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ReversePackedProgram(xShape,axis){this.variableNames=["x"],this.usesPackedTextures=!0;var rank=xShape.length;if(4<rank)throw new Error("WebGL backend: Reverse of rank-"+rank+" tensor is not yet supported");this.outputShape=xShape;var channels=packing_util_1.getChannels("rc",rank),nextColumn=channels[rank-1]+" + 1 < "+this.outputShape[rank-1],nextRow=channels[rank-2]+" + 1 < "+this.outputShape[rank-2],type=shader_compiler_1.getCoordsDataType(rank);function getChannel(channels){var inCoordsArray=xShape.map(function(_,i){return function(i,channels1){return-1!==axis.indexOf(i)&&1!==xShape[i]?xShape[i]+" - "+channels1[i]+" - 1":""+channels1[i]}(i,channels)});return"getChannel(getX("+inCoordsArray.join(",")+"), vec2("+inCoordsArray.slice(-2).join(",")+"))"}this.userCode=1===rank?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+xShape[0]+" - rc - 1),\n            "+xShape[0]+" - rc - 1);\n          if("+nextColumn+"){\n              result.g = getChannel(getX("+xShape[0]+" - (rc  + 1) - 1),\n                "+xShape[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+type+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+function(channels){return getChannel(channels)}(channels.slice())+";\n          if("+nextColumn+"){\n            result.g = "+function(channels){return channels[rank-1]="("+channels[rank-1]+" + 1)",getChannel(channels)}(channels.slice())+";\n          }\n          if("+nextRow+") {\n            result.b = "+function(channels){return channels[rank-2]="("+channels[rank-2]+" + 1)",getChannel(channels)}(channels.slice())+";\n            if("+nextColumn+") {\n              result.a = "+function(channels){return channels[rank-1]="("+channels[rank-1]+" + 1)",channels[rank-2]="("+channels[rank-2]+" + 1)",getChannel(channels)}(channels.slice())+";\n            }\n          }\n          setOutput(result);\n        }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.ReversePackedProgram=ReversePackedProgram},{"../packing_util":55,"./shader_compiler":126}],123:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function ScatterProgram(updateSize,sliceDim,indicesRank,updatesRank,strides,shape,summingDupeIndex){void 0===summingDupeIndex&&(summingDupeIndex=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=shape;var stridesType=shader_compiler_1.getCoordsDataType(strides.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),indicesString="";1===indicesRank?indicesString="i":2===indicesRank&&(indicesString="i, j");var indicesSnippet="getIndices("+indicesString+")",updatesString="";1===updatesRank?updatesString="i":2===updatesRank&&(updatesString="i, coords[1]");var updatesSnippet="getUpdates("+updatesString+")",strideString=1<sliceDim?"strides[j]":"strides";this.userCode="\n        "+stridesType+" strides = "+stridesType+"("+strides+");\n\n        void main() {\n          "+dtype+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+updateSize+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+sliceDim+"; j++) {\n              int index = round("+indicesSnippet+");\n              flattenedIndex += index * "+strideString+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+updatesSnippet+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "}var shader_compiler_1=require("./shader_compiler");exports.ScatterProgram=ScatterProgram},{"./shader_compiler":126}],124:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function SegmentOpProgram(segOpInfo,segOpType){this.variableNames=["x","segmentIds"];var windowSize=segOpInfo.windowSize,batchSize=segOpInfo.batchSize,inSize=segOpInfo.inSize,numSegments=segOpInfo.numSegments,outSize=numSegments*Math.ceil(inSize/windowSize);this.outputShape=[batchSize,outSize];var windowSizeNearestVec4=4*Math.floor(windowSize/4),windowSizeVec4Remainder=windowSize%4,updateSnippet="\n        sumValue += dot(values, segFilter);\n    ",checkValueOutOfBounds="";0<inSize%windowSize&&(checkValueOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return initializationValue;\n        }\n      ");var checkSegmentIdOutOfBounds="";0<inSize%windowSize&&(checkSegmentIdOutOfBounds="\n        if (inIdx < 0 || inIdx >= "+inSize+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+checkValueOutOfBounds+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+checkSegmentIdOutOfBounds+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+numSegments+")) * float("+windowSize+"));\n        int currentSeg = int(mod(float(outIdx), float("+numSegments+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+windowSizeNearestVec4+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+updateSnippet+"\n        }\n\n        int inIdx = inOffset + "+windowSizeNearestVec4+";\n        if ("+(1==windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+updateSnippet+"\n        } else if ("+(2==windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+updateSnippet+"\n        } else if ("+(3==windowSizeVec4Remainder)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+updateSnippet+"\n        }\n        setOutput(sumValue);\n      }\n    "}exports.SegmentOpProgram=SegmentOpProgram},{}],125:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function SelectProgram(cRank,shape,rank){var cCoords,abCoords;if(this.variableNames=["c","a","b"],this.outputShape=shape,4<rank)throw Error("Where for rank "+rank+" is not yet supported");if(1===rank)cCoords=abCoords="resRC";else{for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w"],cCoordVars=[],abCoordVars=[],i=0;i<shape.length;i++)abCoordVars.push(""+currentCoords[i]),i<cRank&&cCoordVars.push(""+currentCoords[i]);cCoords=cCoordVars.join(),abCoords=abCoordVars.join()}var dtype=shader_compiler_1.getCoordsDataType(rank);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        float cVal = getC("+cCoords+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+abCoords+"));\n        } else {\n          setOutput(getB("+abCoords+"));\n        }\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.SelectProgram=SelectProgram},{"./shader_compiler":126}],126:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var broadcast_util_1=require("../../ops/broadcast_util"),util=require("../../util"),glsl_version_1=require("./glsl_version"),shader_util=require("./shader_compiler_util");function getSamplerFromInInfo(inInfo){var shape=inInfo.shapeInfo.logicalShape;switch(shape.length){case 0:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1);if(inputInfo.shapeInfo.isUniform)return"float "+funcName+"() {return "+texName+";}";var _a=inputInfo.shapeInfo.texShape,texNumR=_a[0],texNumC=_a[1];if(1===texNumR&&1===texNumC)return"\n      float "+funcName+"() {\n        return sampleTexture("+texName+", halfCR);\n      }\n    ";var _b=inputInfo.shapeInfo.texShape,tNumR=_b[0],tNumC=_b[1],offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"() {\n      vec2 uv = uvFromFlat("+tNumR+", "+tNumC+", "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 1:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1);if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int index) {\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texShape=inputInfo.shapeInfo.texShape,tNumR=texShape[0],tNumC=texShape[1];if(1===tNumC&&1===tNumR)return"\n      float "+funcName+"(int index) {\n        return sampleTexture("+texName+", halfCR);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return 1!==tNumC?1!==tNumR?"\n    float "+funcName+"(int index) {\n      vec2 uv = uvFromFlat("+tNumR+", "+tNumC+", index + "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  ":"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2((float(index + "+offset+") + 0.5) / "+tNumC+".0, 0.5);\n        return sampleTexture("+texName+", uv);\n      }\n    ":"\n      float "+funcName+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+offset+") + 0.5) / "+tNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    "}(inInfo);case 2:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape;if(null!=texShape&&util.arraysEqual(shape,texShape)){var texNumR_1=texShape[0],texNumC_1=texShape[1];return"\n    float "+funcName+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+texNumC_1+".0, "+texNumR_1+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  "}var _a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims,squeezedShape=newShape;if(squeezedShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,squeezedShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col) {\n        return "+funcName+"("+getSqueezedParams(["row","col"],keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+shape[1]+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texNumR=texShape[0],texNumC=texShape[1],offset=getFlatOffsetUniformName(texName);return 1!==texNumC?1!==texNumR?"\n  float "+funcName+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+shape[1]+" + col + "+offset+";\n    vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n    return sampleTexture("+texName+", uv);\n  }\n":"\n    float "+funcName+"(int row, int col) {\n      float index = dot(vec3(row, col, "+offset+"), vec3("+shape[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+texNumC+".0, 0.5);\n      return sampleTexture("+texName+", uv);\n    }\n  ":"\n    float "+funcName+"(int row, int col) {\n      float index = dot(vec3(row, col, "+offset+"), vec3("+shape[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+texNumR+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 3:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride0=shape[1]*shape[2],stride1=shape[2],_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims,squeezedShape=newShape;if(squeezedShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,squeezedShape);return"\n        "+getSamplerFromInInfo(newInputInfo)+"\n        float "+funcName+"(int row, int col, int depth) {\n          return "+funcName+"("+getSqueezedParams(["row","col","depth"],keptDims)+");\n        }\n      "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+stride0+", "+stride1+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1],flatOffset=inputInfo.shapeInfo.flatOffset;if(texNumC===stride0&&null==flatOffset)return"\n        float "+funcName+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+stride1+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+texNumC+".0, "+texNumR+".0);\n          return sampleTexture("+texName+", uv);\n        }\n      ";if(texNumC===stride1&&null==flatOffset)return"\n    float "+funcName+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+shape[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+texNumC+".0, "+texNumR+".0);\n      return sampleTexture("+texName+", uv);\n    }\n  ";var offset=getFlatOffsetUniformName(texName);return"\n      float "+funcName+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+stride0+" + col * "+stride1+" + depth + "+offset+";\n        vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n        return sampleTexture("+texName+", uv);\n      }\n  "}(inInfo);case 4:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride2=shape[3],stride1=shape[2]*stride2,stride0=shape[1]*stride1,_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,newShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        return "+funcName+"("+getSqueezedParams(["row","col","depth","depth2"],keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+stride0+", "+stride1+", "+stride2+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+stride1+", "+stride2+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride2&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+shape[1]*shape[2]+", "+shape[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" +\n          depth * "+stride2+" + depth2;\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index + "+offset+");\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 5:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),stride3=shape[4],stride2=shape[3]*stride3,stride1=shape[2]*stride2,stride0=shape[1]*stride1,_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,newShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+funcName+"("+getSqueezedParams(["row","col","depth","depth2","depth3"],keptDims)+");\n      }\n    "}if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+stride0+", "+stride1+", "+stride2+", "+stride3+")) +\n          depth3;\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+stride1+", "+stride2+", "+stride3+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride3&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+shape[1]*shape[2]*shape[3]+",\n               "+shape[2]*shape[3]+", "+shape[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" + depth * "+stride2+" +\n          depth2 * "+stride3+" + depth3 + "+offset+";\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);case 6:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),_a=util.squeezeShape(shape),newShape=_a.newShape,keptDims=_a.keptDims;if(newShape.length<shape.length){var newInputInfo=squeezeInputInfo(inputInfo,newShape);return"\n      "+getSamplerFromInInfo(newInputInfo)+"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+funcName+"("+getSqueezedParams(["row","col","depth","depth2","depth3","depth4"],keptDims)+");\n      }\n    "}var stride4=shape[5],stride3=shape[4]*stride4,stride2=shape[3]*stride3,stride1=shape[2]*stride2,stride0=shape[1]*stride1;if(inputInfo.shapeInfo.isUniform)return"\n      float "+funcName+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+stride0+", "+stride1+", "+stride2+", "+stride3+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+stride4+", 1)));\n        "+getUniformSampler(inputInfo)+"\n      }\n    ";var flatOffset=inputInfo.shapeInfo.flatOffset,texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1];if(texNumC===stride0&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+stride1+", "+stride2+", "+stride3+", "+stride4+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";if(texNumC===stride4&&null==flatOffset)return"\n      float "+funcName+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+shape[1]*shape[2]*shape[3]*shape[4]+",\n               "+shape[2]*shape[3]*shape[4]+",\n               "+shape[3]*shape[4]+",\n               "+shape[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+texNumC+".0, "+texNumR+".0);\n        return sampleTexture("+texName+", uv);\n      }\n    ";var offset=getFlatOffsetUniformName(texName);return"\n    float "+funcName+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+stride0+" + col * "+stride1+" + depth * "+stride2+" +\n          depth2 * "+stride3+" + depth3 * "+stride4+" + depth4 + "+offset+";\n      vec2 uv = uvFromFlat("+texNumR+", "+texNumC+", index);\n      return sampleTexture("+texName+", uv);\n    }\n  "}(inInfo);default:throw new Error(shape.length+"-D input sampling is not yet supported")}}function getPackedSamplerFromInInfo(inInfo){switch(inInfo.shapeInfo.logicalShape.length){case 0:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"() {\n      return "+glsl.texture2D+"("+texName+", halfCR);\n    }\n  "}(inInfo);case 1:return function(inputInfo){var texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+packedTexShape[0]+", "+packedTexShape[1]+", index);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);case 2:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,texNumR=texShape[0],texNumC=texShape[1],glsl=glsl_version_1.getGlslDifferences();if(null!=texShape&&util.arraysEqual(shape,texShape))return"\n      vec4 "+funcName+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+texNumC+".0, "+texNumR+".0);\n\n        return "+glsl.texture2D+"("+texName+", uv);\n      }\n    ";var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],valuesPerRow=Math.ceil(shape[1]/2);return"\n    vec4 "+funcName+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+valuesPerRow+", "+packedTexShape[0]+", "+packedTexShape[1]+", row, col);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);case 3:return function(inputInfo){var shape=inputInfo.shapeInfo.logicalShape,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(1===shape[0]){var squeezedShape=shape.slice(1),newInputInfo=squeezeInputInfo(inputInfo,squeezedShape);return"\n        "+getPackedSamplerFromInInfo(newInputInfo)+"\n        vec4 "+funcName+"(int b, int row, int col) {\n          return "+funcName+"("+getSqueezedParams(["b","row","col"],[1,2])+");\n        }\n      "}var texNumR=packedTexShape[0],texNumC=packedTexShape[1],valuesPerRow=Math.ceil(shape[2]/2),texelsInBatch=valuesPerRow*Math.ceil(shape[1]/2),glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+texNumR+", "+texNumC+", "+texelsInBatch+", "+valuesPerRow+", b, row, col);\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo);default:return function(inputInfo){for(var shape=inputInfo.shapeInfo.logicalShape,rank=shape.length,texName=inputInfo.name,funcName="get"+texName.charAt(0).toUpperCase()+texName.slice(1),texShape=inputInfo.shapeInfo.texShape,packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texNumR=packedTexShape[0],texNumC=packedTexShape[1],valuesPerRow=Math.ceil(shape[rank-1]/2),texelsInBatch=valuesPerRow*Math.ceil(shape[rank-2]/2),params="int b, int row, int col",index="b * "+texelsInBatch+" + (row / 2) * "+valuesPerRow+" + (col / 2)",b=2;b<rank-1;b++)params="int b"+b+", "+params,texelsInBatch*=shape[rank-b-1],index="b"+b+" * "+texelsInBatch+" + "+index;var glsl=glsl_version_1.getGlslDifferences();return"\n    vec4 "+funcName+"("+params+") {\n      int index = "+index+";\n      int texR = index / "+texNumC+";\n      int texC = index - texR * "+texNumC+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+texNumC+", "+texNumR+");\n      return "+glsl.texture2D+"("+texName+", uv);\n    }\n  "}(inInfo)}}exports.makeShader=function(inputsInfo,outputShape,userCode,usesPackedTextures){var prefixSnippets=[];inputsInfo.forEach(function(x){var size=util.sizeFromShape(x.shapeInfo.logicalShape);x.shapeInfo.isUniform?prefixSnippets.push("uniform float "+x.name+(1<size?"["+size+"]":"")+";"):(prefixSnippets.push("uniform sampler2D "+x.name+";"),prefixSnippets.push("uniform int offset"+x.name+";"))});var outputSamplingSnippet,floatTextureSetOutputSnippet,inputPrefixSnippet=prefixSnippets.join("\n"),inputSamplingSnippet=inputsInfo.map(function(x){return function(inInfo,outShapeInfo,usesPackedTextures){void 0===usesPackedTextures&&(usesPackedTextures=!1);var res="";res+=usesPackedTextures?getPackedSamplerFromInInfo(inInfo):getSamplerFromInInfo(inInfo);var inShape=inInfo.shapeInfo.logicalShape,outShape=outShapeInfo.logicalShape;inShape.length<=outShape.length&&(res+=usesPackedTextures?function(inputInfo,outShapeInfo){var coordsSnippet,texName=inputInfo.name,texFuncSnippet=texName.charAt(0).toUpperCase()+texName.slice(1),funcName="get"+texFuncSnippet+"AtOutCoords",inRank=inputInfo.shapeInfo.logicalShape.length,outRank=outShapeInfo.logicalShape.length,broadcastDims=broadcast_util_1.getBroadcastDims(inputInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape),type=getCoordsDataType(outRank),rankDiff=outRank-inRank,fields=["x","y","z","w","u","v"];coordsSnippet=0===inRank?"":outRank<2&&1<=broadcastDims.length?"coords = 0;":broadcastDims.map(function(d){return"coords."+fields[d+rankDiff]+" = 0;"}).join("\n");var unpackedCoordsSnippet="";unpackedCoordsSnippet=outRank<2&&0<inRank?"coords":inputInfo.shapeInfo.logicalShape.map(function(s,i){return"coords."+fields[i+rankDiff]}).join(", ");var output="return outputValue;",isInputScalar=1===util.sizeFromShape(inputInfo.shapeInfo.logicalShape),isOutputScalar=1===util.sizeFromShape(outShapeInfo.logicalShape);if(1!==inRank||isInputScalar||isOutputScalar){if(isInputScalar&&!isOutputScalar)output=1===outRank?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(broadcastDims.length){var rows=inRank-2,cols=inRank-1;-1<broadcastDims.indexOf(rows)&&-1<broadcastDims.indexOf(cols)?output="return vec4(outputValue.x);":-1<broadcastDims.indexOf(rows)?output="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":-1<broadcastDims.indexOf(cols)&&(output="return vec4(outputValue.xx, outputValue.zz);")}}else output="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+funcName+"() {\n      "+type+" coords = getOutputCoords();\n      "+coordsSnippet+"\n      vec4 outputValue = get"+texFuncSnippet+"("+unpackedCoordsSnippet+");\n      "+output+"\n    }\n  "}(inInfo,outShapeInfo):function(inputInfo,outShapeInfo){var texName=inputInfo.name,texFuncSnippet=texName.charAt(0).toUpperCase()+texName.slice(1),funcName="get"+texFuncSnippet+"AtOutCoords",outTexShape=outShapeInfo.texShape,inTexShape=inputInfo.shapeInfo.texShape,inRank=inputInfo.shapeInfo.logicalShape.length,outRank=outShapeInfo.logicalShape.length;if(!inputInfo.shapeInfo.isUniform&&inRank===outRank&&null==inputInfo.shapeInfo.flatOffset&&util.arraysEqual(inTexShape,outTexShape))return"\n      float "+funcName+"() {\n        return sampleTexture("+texName+", resultUV);\n      }\n    ";var coordsSnippet,type=getCoordsDataType(outRank),broadcastDims=broadcast_util_1.getBroadcastDims(inputInfo.shapeInfo.logicalShape,outShapeInfo.logicalShape),rankDiff=outRank-inRank,fields=["x","y","z","w","u","v"];coordsSnippet=0===inRank?"":outRank<2&&1<=broadcastDims.length?"coords = 0;":broadcastDims.map(function(d){return"coords."+fields[d+rankDiff]+" = 0;"}).join("\n");var unpackedCoordsSnippet="";unpackedCoordsSnippet=outRank<2&&0<inRank?"coords":inputInfo.shapeInfo.logicalShape.map(function(s,i){return"coords."+fields[i+rankDiff]}).join(", ");return"\n    float "+funcName+"() {\n      "+type+" coords = getOutputCoords();\n      "+coordsSnippet+"\n      return get"+texFuncSnippet+"("+unpackedCoordsSnippet+");\n    }\n  "}(inInfo,outShapeInfo));return res}(x,outputShape,usesPackedTextures)}).join("\n"),outTexShape=outputShape.texShape,glsl=glsl_version_1.getGlslDifferences(),floatTextureSampleSnippet=function(glsl){return"\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+glsl.texture2D+"(textureSampler, uv).r;\n    }\n  "}(glsl),shaderPrefix=function(glsl){return glsl.version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+glsl.varyingFs+" vec2 resultUV;\n    "+glsl.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    #define isnan(value) isnan_custom(value)\n    "+glsl.defineSpecialNaN+"\n    bvec4 isnan_custom(vec4 val) {\n      return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n    }\n\n    "+glsl.defineSpecialInf+"\n    "+glsl.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+SAMPLE_1D_SNIPPET+"\n    "+SAMPLE_2D_SNIPPET+"\n    "+SAMPLE_3D_SNIPPET+"\n  "}(glsl);return floatTextureSetOutputSnippet=outputShape.isPacked?(outputSamplingSnippet=function(outShape,outTexShape){switch(outShape.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];return 1!==packedTexShape[0]?1!==packedTexShape[1]?"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      return 2 * (resTexRC.x * "+packedTexShape[1]+" + resTexRC.y);\n    }\n  ":"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+packedTexShape[0]+".0);\n      }\n    ":"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+packedTexShape[1]+".0);\n      }\n    "}(0,outTexShape);case 2:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)];if(util.arraysEqual(shape,texShape))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      }\n    ";var texelsInLogicalRow=Math.ceil(shape[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(outShape,outTexShape);case 3:return function(shape,texShape){var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texelsInLogicalRow=Math.ceil(shape[2]/2),texelsInBatch=texelsInLogicalRow*Math.ceil(shape[1]/2);return"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n\n      int b = index / "+texelsInBatch+";\n      index -= b * "+texelsInBatch+";\n\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  "}(outShape,outTexShape);default:return function(shape,texShape){for(var packedTexShape=[Math.ceil(texShape[0]/2),Math.ceil(texShape[1]/2)],texelsInLogicalRow=Math.ceil(shape[shape.length-1]/2),texelsInBatch=texelsInLogicalRow*Math.ceil(shape[shape.length-2]/2),texelsInBatchN=texelsInBatch,batches="",coords="b, r, c",b=2;b<shape.length-1;b++)texelsInBatchN*=shape[shape.length-b-1],batches="\n      int b"+b+" = index / "+texelsInBatchN+";\n      index -= b"+b+" * "+texelsInBatchN+";\n    "+batches,coords="b"+b+", "+coords;return"\n    ivec"+shape.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+packedTexShape[0]+", "+packedTexShape[1]+"));\n      int index = resTexRC.x * "+packedTexShape[1]+" + resTexRC.y;\n\n      "+batches+"\n\n      int b = index / "+texelsInBatch+";\n      index -= b * "+texelsInBatch+";\n\n      int r = 2 * (index / "+texelsInLogicalRow+");\n      int c = imod(index, "+texelsInLogicalRow+") * 2;\n\n      return ivec"+shape.length+"("+coords+");\n    }\n  "}(outShape,outTexShape)}}(outputShape.logicalShape,outTexShape),function(glsl){return"\n    void setOutput(vec4 val) {\n      "+glsl.output+" = val;\n    }\n  "}(glsl)):(outputSamplingSnippet=function(outShape,outTexShape){switch(outShape.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(shape,texShape){return 1!==texShape[0]?1!==texShape[1]?"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      return resTexRC.x * "+texShape[1]+" + resTexRC.y;\n    }\n  ":"\n      int getOutputCoords() {\n        return int(resultUV.y * "+texShape[0]+".0);\n      }\n    ":"\n      int getOutputCoords() {\n        return int(resultUV.x * "+texShape[1]+".0);\n      }\n    "}(0,outTexShape);case 2:return function(shape,texShape){if(util.arraysEqual(shape,texShape))return"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+texShape[0]+", "+texShape[1]+"));\n      }\n    ";return 1!==shape[1]?1!==shape[0]?"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      int r = index / "+shape[1]+";\n      int c = index - r * "+shape[1]+";\n      return ivec2(r, c);\n    }\n  ":"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+texShape[0]+", "+texShape[1]+"));\n        int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    "}(outShape,outTexShape);case 3:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d"],shape);return"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      "+coordsFromIndexSnippet+"\n      return ivec3(r, c, d);\n    }\n  "}(outShape,outTexShape);case 4:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2"],shape);return"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n      "+coordsFromIndexSnippet+"\n      return ivec4(r, c, d, d2);\n    }\n  "}(outShape,outTexShape);case 5:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2","d3"],shape);return"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+texShape[0]+",\n                             "+texShape[1]+"));\n\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      "+coordsFromIndexSnippet+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  "}(outShape,outTexShape);case 6:return function(shape,texShape){var coordsFromIndexSnippet=shader_util.getLogicalCoordinatesFromFlatIndex(["r","c","d","d2","d3","d4"],shape);return"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+texShape[0]+", "+texShape[1]+"));\n      int index = resTexRC.x * "+texShape[1]+" + resTexRC.y;\n\n      "+coordsFromIndexSnippet+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  "}(outShape,outTexShape);default:throw new Error(outShape.length+"-D output sampling is not yet supported")}}(outputShape.logicalShape,outTexShape),function(glsl){return"\n    void setOutput(float val) {\n      "+glsl.output+" = vec4(val, 0, 0, 0);\n    }\n  "}(glsl)),usesPackedTextures&&(shaderPrefix+=SHADER_PACKED_PREFIX),[shaderPrefix,floatTextureSampleSnippet,floatTextureSetOutputSnippet,inputPrefixSnippet,outputSamplingSnippet,inputSamplingSnippet,userCode].join("\n")};var SAMPLE_1D_SNIPPET="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SAMPLE_2D_SNIPPET="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SAMPLE_3D_SNIPPET="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",SHADER_PACKED_PREFIX="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function getFlatOffsetUniformName(texName){return"offset"+texName}function getUniformSampler(inputInfo){var texName=inputInfo.name,inSize=util.sizeFromShape(inputInfo.shapeInfo.logicalShape);return inSize<2?"return "+texName+";":"\n    for (int i = 0; i < "+inSize+"; i++) {\n      if (i == index) {\n        return "+texName+"[i];\n      }\n    }\n  "}function getCoordsDataType(rank){if(rank<=1)return"int";if(2===rank)return"ivec2";if(3===rank)return"ivec3";if(4===rank)return"ivec4";if(5===rank)return"ivec5";if(6===rank)return"ivec6";throw Error("GPU for rank "+rank+" is not yet supported")}function squeezeInputInfo(inInfo,squeezedShape){var newInputInfo=JSON.parse(JSON.stringify(inInfo));return newInputInfo.shapeInfo.logicalShape=squeezedShape,newInputInfo}function getSqueezedParams(params,keptDims){return keptDims.map(function(d){return params[d]}).join(", ")}exports.getCoordsDataType=getCoordsDataType},{"../../ops/broadcast_util":169,"../../util":241,"./glsl_version":98,"./shader_compiler_util":127}],127:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../../util");function buildVec(x){return 1===x.length?""+x[0]:"vec"+x.length+"("+x.join(",")+")"}exports.getLogicalCoordinatesFromFlatIndex=function(coords,shape,index){void 0===index&&(index="index");var strides=util.computeStrides(shape);return strides.map(function(stride,i){return"int "+coords[i]+" = "+index+" / "+stride+"; "+(i===strides.length-1?"int "+coords[i+1]+" = "+index+" - "+coords[i]+" * "+stride:"index -= "+coords[i]+" * "+stride)+";"}).join("")},exports.dotify=function(x,y){if(x.length!==y.length)throw new Error("Vectors to be dotted must be of the same length -got "+x.length+" and "+y.length);for(var slices=[],nearestVec4=Math.floor(x.length/4),nearestVec4Remainder=x.length%4,i=0;i<nearestVec4;i++){var xSlice=x.slice(4*i,4*i+4),ySlice=y.slice(4*i,4*i+4);slices.push(buildVec(xSlice)+", "+buildVec(ySlice))}if(0!=nearestVec4Remainder){xSlice=x.slice(4*nearestVec4),ySlice=y.slice(4*nearestVec4);1===xSlice.length&&(xSlice=xSlice.map(function(d){return"float("+d+")"}),ySlice=ySlice.map(function(d){return"float("+d+")"})),slices.push(buildVec(xSlice)+", "+buildVec(ySlice))}return slices.map(function(d,i){return"dot("+d+")"}).join("+")},exports.getFlatIndexFrom3D=function(shape){var strides=util.computeStrides(shape).map(function(d){return d.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+strides[0]+" + coords.y * "+strides[1]+" + coords.z;\n  }\n"},exports.ENCODE_FLOAT_SNIPPET="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n"},{"../../util":241}],128:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var shader_compiler_1=require("./shader_compiler"),SliceProgram=function(){function SliceProgram(destSize){this.variableNames=["source"],this.outputShape=destSize,this.rank=destSize.length;var body,dtype=shader_compiler_1.getCoordsDataType(this.rank),uniformPart="uniform int start["+this.rank+"];",sourceCoords=function(rank){{if(1===rank)return"sourceLoc";if(rank<=6)return coords.slice(0,rank).map(function(x){return"sourceLoc."+x}).join(",");throw Error("Slicing for rank "+rank+" is not yet supported")}}(this.rank);body="\n        "+dtype+" sourceLoc;\n        "+dtype+" coords = getOutputCoords();\n        "+destSize.map(function(_,i){return"sourceLoc."+coords[i]+" = start["+i+"] + coords."+coords[i]+";"}).join("\n")+"\n      ",this.userCode="\n      "+uniformPart+"\n      void main() {\n        "+body+"\n        setOutput(getSource("+sourceCoords+"));\n      }\n    "}return SliceProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){null==_this.startLoc&&(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null==_this.startLoc)||gpgpu.gl.uniform1iv(_this.startLoc,start)}},SliceProgram}();exports.SliceProgram=SliceProgram;var coords=["x","y","z","w","u","v"]},{"./shader_compiler":126}],129:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler"),SlicePackedProgram=function(){function SlicePackedProgram(destSize){this.variableNames=["source"],this.usesPackedTextures=!0,this.outputShape=destSize,this.rank=destSize.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),coords=packing_util_1.getChannels("coords",this.rank),sourceLoc=packing_util_1.getChannels("sourceLoc",this.rank),innerDims=1===this.rank?"sourceLoc":"vec2("+sourceLoc.slice(-2).join()+")",getChannel="getChannel(getSource("+sourceLoc.join()+"), "+innerDims+")",upperRow="\n      result.x = "+getChannel+";\n      if (++"+coords[this.rank-1]+" < "+destSize[this.rank-1]+") {\n        ++"+sourceLoc[this.rank-1]+";\n        result.y = "+getChannel+";\n        --"+sourceLoc[this.rank-1]+";\n      }\n    ",lowerRow=1===this.rank?"":"\n      --"+coords[this.rank-1]+";\n      if (++"+coords[this.rank-2]+" < "+destSize[this.rank-2]+") {\n        ++"+sourceLoc[this.rank-2]+";\n        result.z = "+getChannel+";\n        if (++"+coords[this.rank-1]+" < "+destSize[this.rank-1]+") {\n          ++"+sourceLoc[this.rank-1]+";\n          result.w = "+getChannel+";\n        }\n      }\n    ",sourceLocSetup=this.rank<=4?"sourceLoc = coords +\n            "+dtype+"("+destSize.map(function(_,i){return"start["+i+"]"}).join()+");":destSize.map(function(_,i){return sourceLoc[i]+" = "+coords[i]+" + start["+i+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        "+dtype+" sourceLoc;\n        "+sourceLocSetup+" \n        vec4 result = vec4(0.);\n        "+upperRow+"\n        "+lowerRow+"\n        setOutput(result);\n      }\n    "}return SlicePackedProgram.prototype.getCustomSetupFunc=function(start){var _this=this;if(start.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+start.length+")");return function(gpgpu,webGLProgram){null==_this.startLoc&&(_this.startLoc=gpgpu.getUniformLocationNoThrow(webGLProgram,"start"),null==_this.startLoc)||gpgpu.gl.uniform1iv(_this.startLoc,start)}},SlicePackedProgram}();exports.SlicePackedProgram=SlicePackedProgram},{"../packing_util":55,"./shader_compiler":126}],130:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function StridedSliceProgram(begin,strides,size,shrinkAxis){this.variableNames=["x"];var shape=size.filter(function(v,index){return-1===shrinkAxis.indexOf(index)});this.outputShape=shape;var rank=size.length,inputDtype=shader_compiler_1.getCoordsDataType(size.length),dtype=shader_compiler_1.getCoordsDataType(shape.length),newCoords="";if(1===rank)newCoords="coords * strides + begin";else{var outputAxis_1=0;newCoords=size.map(function(_,i){return-1===shrinkAxis.indexOf(i)?(outputAxis_1++,1===shape.length?"coords * strides["+i+"] + begin["+i+"]":"coords["+(outputAxis_1-1)+"] * strides["+i+"] + begin["+i+"]"):"begin["+i+"]"}).join(",")}this.userCode="\n      "+inputDtype+" begin = "+inputDtype+"("+begin+");\n      "+inputDtype+" strides = "+inputDtype+"("+strides+");\n\n      void main() {\n        "+dtype+" coords = getOutputCoords();\n        setOutput(getX("+newCoords+"));\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.StridedSliceProgram=StridedSliceProgram},{"./shader_compiler":126}],131:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util");function getPackedMatrixTextureShapeWidthHeight(rows,columns){return[Math.max(1,Math.ceil(columns/2)),Math.max(1,Math.ceil(rows/2))]}!function(TextureUsage){TextureUsage[TextureUsage.RENDER=0]="RENDER",TextureUsage[TextureUsage.UPLOAD=1]="UPLOAD",TextureUsage[TextureUsage.PIXELS=2]="PIXELS",TextureUsage[TextureUsage.DOWNLOAD=3]="DOWNLOAD"}(exports.TextureUsage||(exports.TextureUsage={})),function(PhysicalTextureType){PhysicalTextureType[PhysicalTextureType.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",PhysicalTextureType[PhysicalTextureType.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",PhysicalTextureType[PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",PhysicalTextureType[PhysicalTextureType.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",PhysicalTextureType[PhysicalTextureType.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(exports.PhysicalTextureType||(exports.PhysicalTextureType={})),exports.getUnpackedMatrixTextureShapeWidthHeight=function(rows,columns){return[columns,rows]},exports.getUnpackedArraySizeFromMatrixSize=function(matrixSize,channelsPerTexture){return matrixSize*channelsPerTexture},exports.getColorMatrixTextureShapeWidthHeight=function(rows,columns){return[4*columns,rows]},exports.getDenseTexShape=function(shape){var size=util.sizeFromShape(shape),texelsNeeded=Math.ceil(size/4);return util.sizeToSquarishShape(texelsNeeded)},exports.getMatrixSizeFromUnpackedArraySize=function(unpackedSize,channelsPerTexture){if(unpackedSize%channelsPerTexture!=0)throw new Error("unpackedSize ("+unpackedSize+") must be a multiple of "+channelsPerTexture);return unpackedSize/channelsPerTexture},exports.decodeMatrixFromUnpackedColorRGBAArray=function(unpackedArray,matrix,channels){var requiredSize=unpackedArray.length*channels/4;if(matrix.length<requiredSize)throw new Error("matrix length ("+matrix.length+") must be >= "+requiredSize);for(var dst=0,src=0;src<unpackedArray.length;src+=4)for(var c=0;c<channels;c++)matrix[dst++]=unpackedArray[src+c]},exports.getPackedMatrixTextureShapeWidthHeight=getPackedMatrixTextureShapeWidthHeight,exports.getPackedRGBAArraySizeFromMatrixShape=function(rows,columns){var _a=getPackedMatrixTextureShapeWidthHeight(rows,columns);return _a[0]*_a[1]*4},exports.getTextureConfig=function(gl,textureHalfFloatExtension){var internalFormatFloat,internalFormatHalfFloat,internalFormatPackedHalfFloat,internalFormatPackedFloat,textureFormatFloat,downloadUnpackNumChannels,defaultNumChannels,textureTypeHalfFloat,textureTypeFloat,glany=gl;return textureTypeFloat=2===environment_1.ENV.getNumber("WEBGL_VERSION")?(internalFormatFloat=glany.R32F,internalFormatHalfFloat=glany.R16F,internalFormatPackedHalfFloat=glany.RGBA16F,internalFormatPackedFloat=glany.RGBA32F,textureFormatFloat=glany.RED,downloadUnpackNumChannels=4,defaultNumChannels=1,textureTypeHalfFloat=glany.HALF_FLOAT,glany.FLOAT):(internalFormatFloat=gl.RGBA,internalFormatHalfFloat=gl.RGBA,internalFormatPackedHalfFloat=gl.RGBA,internalFormatPackedFloat=glany.RGBA,textureFormatFloat=gl.RGBA,defaultNumChannels=downloadUnpackNumChannels=4,textureTypeHalfFloat=null!=textureHalfFloatExtension?textureHalfFloatExtension.HALF_FLOAT_OES:null,gl.FLOAT),{internalFormatFloat:internalFormatFloat,internalFormatHalfFloat:internalFormatHalfFloat,internalFormatPackedHalfFloat:internalFormatPackedHalfFloat,internalFormatPackedFloat:internalFormatPackedFloat,textureFormatFloat:textureFormatFloat,downloadTextureFormat:gl.RGBA,downloadUnpackNumChannels:downloadUnpackNumChannels,defaultNumChannels:defaultNumChannels,textureTypeHalfFloat:textureTypeHalfFloat,textureTypeFloat:textureTypeFloat}}},{"../../environment":144,"../../util":241}],132:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),tex_util_1=require("./tex_util"),TextureManager=function(){function TextureManager(gpgpu){this.gpgpu=gpgpu,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return TextureManager.prototype.acquireTexture=function(shapeRC,usage,isPacked){var newTexture,physicalTexType=getPhysicalFromLogicalTextureType(usage,isPacked),shapeKey=getKeyFromTextureShape(shapeRC,physicalTexType,isPacked);if(shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),shapeKey in this.usedTextures||(this.usedTextures[shapeKey]=[]),0<this.freeTextures[shapeKey].length){this.numFreeTextures--,this.numUsedTextures++,this.log();var newTexture_1=this.freeTextures[shapeKey].shift();return this.usedTextures[shapeKey].push(newTexture_1),newTexture_1}return this.numUsedTextures++,this.log(),physicalTexType===tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32?newTexture=this.gpgpu.createPackedMatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT16?newTexture=this.gpgpu.createFloat16PackedMatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.UNPACKED_FLOAT32?newTexture=this.gpgpu.createFloat32MatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.UNPACKED_FLOAT16?newTexture=this.gpgpu.createFloat16MatrixTexture(shapeRC[0],shapeRC[1]):physicalTexType===tex_util_1.PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE&&(newTexture=this.gpgpu.createUnsignedBytesMatrixTexture(shapeRC[0],shapeRC[1])),this.usedTextures[shapeKey].push(newTexture),newTexture},TextureManager.prototype.releaseTexture=function(texture,shape,logicalTexType,isPacked){if(null!=this.freeTextures){var shapeKey=getKeyFromTextureShape(shape,getPhysicalFromLogicalTextureType(logicalTexType,isPacked),isPacked);shapeKey in this.freeTextures||(this.freeTextures[shapeKey]=[]),this.freeTextures[shapeKey].push(texture),this.numFreeTextures++,this.numUsedTextures--;var texList=this.usedTextures[shapeKey],texIndex=texList.indexOf(texture);if(texIndex<0)throw new Error("Cannot release a texture that was never provided by this texture manager");texList.splice(texIndex,1),this.log()}},TextureManager.prototype.log=function(){if(this.logEnabled){var total=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+total+")")}},TextureManager.prototype.getNumUsedTextures=function(){return this.numUsedTextures},TextureManager.prototype.getNumFreeTextures=function(){return this.numFreeTextures},TextureManager.prototype.dispose=function(){var _this=this;if(null!=this.freeTextures){for(var texShape in this.freeTextures)this.freeTextures[texShape].forEach(function(tex){_this.gpgpu.deleteMatrixTexture(tex)});for(var texShape in this.usedTextures)this.usedTextures[texShape].forEach(function(tex){_this.gpgpu.deleteMatrixTexture(tex)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},TextureManager}();function getPhysicalFromLogicalTextureType(logicalTexType,isPacked){if(logicalTexType===tex_util_1.TextureUsage.UPLOAD)return tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32;if(logicalTexType===tex_util_1.TextureUsage.RENDER||null==logicalTexType)return isPacked?environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT32:tex_util_1.PhysicalTextureType.PACKED_2X2_FLOAT16:environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?tex_util_1.PhysicalTextureType.UNPACKED_FLOAT32:tex_util_1.PhysicalTextureType.UNPACKED_FLOAT16;if(logicalTexType===tex_util_1.TextureUsage.DOWNLOAD||logicalTexType===tex_util_1.TextureUsage.PIXELS)return tex_util_1.PhysicalTextureType.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+logicalTexType)}function getKeyFromTextureShape(shapeRowsCol,physicalTexType,isPacked){return shapeRowsCol[0]+"_"+shapeRowsCol[1]+"_"+physicalTexType+"_"+isPacked}exports.TextureManager=TextureManager},{"../../environment":144,"./tex_util":131}],133:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function TileProgram(aShape,reps){this.variableNames=["A"];for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[i]*reps[i];this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),sourceCoords=function(aShape){var rank=aShape.length;if(5<rank)throw Error("Tile for rank "+rank+" is not yet supported");if(1===rank)return"imod(resRC, "+aShape[0]+")";for(var currentCoords=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],sourceCoords=[],i=0;i<aShape.length;i++)sourceCoords.push("imod("+currentCoords[i]+", "+aShape[i]+")");return sourceCoords.join()}(aShape);this.userCode="\n      void main() {\n        "+dtype+" resRC = getOutputCoords();\n        setOutput(getA("+sourceCoords+"));\n      }\n    "}var shader_compiler_1=require("./shader_compiler");exports.TileProgram=TileProgram},{"./shader_compiler":126}],134:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function TransposeProgram(aShape,newDim){this.variableNames=["A"];for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[newDim[i]];this.outputShape=outputShape,this.rank=outputShape.length;var dtype=shader_compiler_1.getCoordsDataType(this.rank),switched=function(newDim){var rank=newDim.length;if(6<rank)throw Error("Transpose for rank "+rank+" is not yet supported");for(var originalOrder=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],switchedCoords=new Array(rank),i=0;i<newDim.length;i++)switchedCoords[newDim[i]]=originalOrder[i];return switchedCoords.join()}(newDim);this.userCode="\n    void main() {\n      "+dtype+" resRC = getOutputCoords();\n      setOutput(getA("+switched+"));\n    }\n    "}var shader_compiler_1=require("./shader_compiler");exports.TransposeProgram=TransposeProgram},{"./shader_compiler":126}],135:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function TransposePackedProgram(aShape,newDim){this.variableNames=["A"],this.usesPackedTextures=!0;for(var outputShape=new Array(aShape.length),i=0;i<outputShape.length;i++)outputShape[i]=aShape[newDim[i]];if(this.outputShape=outputShape,this.rank=outputShape.length,6<this.rank)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var dtype=shader_compiler_1.getCoordsDataType(this.rank),outputOrder=packing_util_1.getVecChannels("rc",this.rank),switchedOrder=new Array(this.rank);for(i=0;i<newDim.length;i++)switchedOrder[newDim[i]]=outputOrder[i];var innerDims="vec2("+switchedOrder.slice(-2).join()+")",nextColumn="++"+outputOrder[this.rank-1]+" < "+outputShape[this.rank-1],getc="getChannel(getA("+switchedOrder.join()+"), "+innerDims+")";this.userCode="\n    void main() {\n      "+dtype+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+getc+";\n      if("+nextColumn+") {\n        result[1] = "+getc+";\n      }\n      --"+outputOrder[this.rank-1]+";\n      if(++"+outputOrder[this.rank-2]+" < "+outputShape[this.rank-2]+") {\n        result[2] = "+getc+";\n        if("+nextColumn+") {\n          result[3] = "+getc+";\n        }\n      }  \n      setOutput(result);\n    }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.TransposePackedProgram=TransposePackedProgram},{"../packing_util":55,"./shader_compiler":126}],136:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function UnaryOpProgram(aShape,opSnippet){this.variableNames=["A"],this.outputShape=aShape,this.userCode="\n      float unaryOperation(float x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}var erf_util=require("../../ops/erf_util"),selu_util=require("../../ops/selu_util");exports.UnaryOpProgram=UnaryOpProgram;var CHECK_NAN_SNIPPET="if (isnan(x)) return x;";exports.LINEAR="return x;",exports.ABS="return abs(x);",exports.RELU=CHECK_NAN_SNIPPET+"\n  return (x < 0.0) ? 0.0 : x;\n",exports.ELU="return (x >= 0.0) ? x : (exp(x) - 1.0);",exports.SELU="\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = "+selu_util.SELU_SCALEALPHA+";\n  float scale = "+selu_util.SELU_SCALE+";\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n",exports.STEP=function(alpha){return void 0===alpha&&(alpha=0),CHECK_NAN_SNIPPET+"\n    return x > 0.0 ? 1.0 : float("+alpha+");\n  "},exports.NEG="return -x;",exports.CEIL="return ceil(x);",exports.FLOOR="return floor(x);",exports.SIGN="\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n",exports.IS_NAN="return float(isnan(x));",exports.IS_INF="return float(isinf(x));",exports.IS_FINITE="return float(!isnan(x) && !isinf(x));",exports.ROUND="\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n",exports.EXP="return exp(x);",exports.EXPM1="return exp(x) - 1.0;",exports.LOG="if (x < 0.0) return NAN;\n  return log(x);",exports.LOG1P="return log(1.0 + x);",exports.SQRT="return sqrt(x);",exports.RSQRT="return inversesqrt(x);",exports.SIGMOID="return 1.0 / (1.0 + exp(-1.0 * x));",exports.SOFTPLUS="\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n",exports.SIN=CHECK_NAN_SNIPPET+"\n  return sin(x);\n",exports.COS=CHECK_NAN_SNIPPET+"\n  return cos(x);\n",exports.TAN="return tan(x);",exports.ASIN="return asin(x);",exports.ACOS="return acos(x);",exports.ATAN=CHECK_NAN_SNIPPET+"\n  return atan(x);\n",exports.SINH="\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n",exports.COSH="\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n",exports.TANH="\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n",exports.ASINH="return log(x + sqrt(x * x + 1.0));",exports.ACOSH=CHECK_NAN_SNIPPET+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",exports.ATANH=CHECK_NAN_SNIPPET+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",exports.ERF='\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = '+erf_util.ERF_P+";\n  float a1 = "+erf_util.ERF_A1+";\n  float a2 = "+erf_util.ERF_A2+";\n  float a3 = "+erf_util.ERF_A3+";\n  float a4 = "+erf_util.ERF_A4+";\n  float a5 = "+erf_util.ERF_A5+";\n\n  float t = 1.0 / (1.0 + p * x);\n  return 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x);\n",exports.SQUARE="return x * x;",exports.RECIPROCAL="return 1.0 / x;",exports.LOGICAL_NOT="return float(!(x >= 1.0));",exports.TO_INT="return float(int(x));",exports.CLONE="return x;"},{"../../ops/erf_util":181,"../../ops/selu_util":207}],137:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LINEAR="return x;",exports.LOG="\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",exports.RELU="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n";function UnaryOpPackedProgram(aShape,opSnippet){this.variableNames=["A"],this.usesPackedTextures=!0,this.outputShape=aShape,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+opSnippet+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}exports.UnaryOpPackedProgram=UnaryOpPackedProgram},{}],138:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function UnpackProgram(outputShape){this.variableNames=["A"],this.usesPackedTextures=!0;var rank=(this.outputShape=outputShape).length,channels=packing_util_1.getChannels("rc",rank),dtype=shader_compiler_1.getCoordsDataType(rank),sourceCoords=packing_util_1.getSourceCoords(rank,channels),innerDims=channels.slice(-2),coords=rank<=1?"rc":"vec2("+innerDims.join(",")+")";this.userCode="\n      void main() {\n        "+dtype+" rc = getOutputCoords();\n        vec4 packedInput = getA("+sourceCoords+");\n\n        setOutput(getChannel(packedInput, "+coords+"));\n      }\n    "}var packing_util_1=require("../packing_util"),shader_compiler_1=require("./shader_compiler");exports.UnpackProgram=UnpackProgram},{"../packing_util":55,"./shader_compiler":126}],139:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),canvas_util_1=require("./canvas_util"),tex_util_1=require("./tex_util");function callAndCheck(gl,debugMode,func){var returnValue=func();return debugMode&&function(gl){var error=gl.getError();if(error!==gl.NO_ERROR)throw new Error("WebGL Error: "+getWebGLErrorMessage(gl,error))}(gl),returnValue}exports.callAndCheck=callAndCheck;function getWebGLErrorMessage(gl,status){switch(status){case gl.NO_ERROR:return"NO_ERROR";case gl.INVALID_ENUM:return"INVALID_ENUM";case gl.INVALID_VALUE:return"INVALID_VALUE";case gl.INVALID_OPERATION:return"INVALID_OPERATION";case gl.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case gl.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case gl.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+status}}exports.canBeRepresented=function(num){return!!(environment_1.ENV.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===num||5.96e-8<Math.abs(num)&&Math.abs(num)<65504)},exports.getWebGLErrorMessage=getWebGLErrorMessage,exports.getExtensionOrThrow=function(gl,debug,extensionName){return throwIfNull(gl,debug,function(){return gl.getExtension(extensionName)},'Extension "'+extensionName+'" not supported on this browser.')},exports.createVertexShader=function(gl,debug,vertexShaderSource){var vertexShader=throwIfNull(gl,debug,function(){return gl.createShader(gl.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(callAndCheck(gl,debug,function(){return gl.shaderSource(vertexShader,vertexShaderSource)}),callAndCheck(gl,debug,function(){return gl.compileShader(vertexShader)}),!1===gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS))throw console.log(gl.getShaderInfoLog(vertexShader)),new Error("Failed to compile vertex shader.");return vertexShader},exports.createFragmentShader=function(gl,debug,fragmentShaderSource){var fragmentShader=throwIfNull(gl,debug,function(){return gl.createShader(gl.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(callAndCheck(gl,debug,function(){return gl.shaderSource(fragmentShader,fragmentShaderSource)}),callAndCheck(gl,debug,function(){return gl.compileShader(fragmentShader)}),!1===gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS))throw function(shaderSource,shaderInfoLog){var lineNumberRegexResult=lineNumberRegex.exec(shaderInfoLog);if(null==lineNumberRegexResult)return console.log("Couldn't parse line number in error: "+shaderInfoLog),console.log(shaderSource);for(var lineNumber=+lineNumberRegexResult[1],shaderLines=shaderSource.split("\n"),pad=shaderLines.length.toString().length+2,linesWithLineNumbers=shaderLines.map(function(line,lineNumber){return util.rightPad((lineNumber+1).toString(),pad)+line}),maxLineLength=0,i=0;i<linesWithLineNumbers.length;i++)maxLineLength=Math.max(linesWithLineNumbers[i].length,maxLineLength);var beforeErrorLines=linesWithLineNumbers.slice(0,lineNumber-1),errorLine=linesWithLineNumbers.slice(lineNumber-1,lineNumber),afterErrorLines=linesWithLineNumbers.slice(lineNumber);console.log(beforeErrorLines.join("\n")),console.log(shaderInfoLog.split("\n")[0]),console.log("%c "+util.rightPad(errorLine[0],maxLineLength),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(afterErrorLines.join("\n"))}(fragmentShaderSource,gl.getShaderInfoLog(fragmentShader)),new Error("Failed to compile fragment shader.");return fragmentShader};var MAX_TEXTURE_SIZE,MAX_TEXTURES_IN_SHADER,lineNumberRegex=/ERROR: [0-9]+:([0-9]+):/g;function bindTextureUnit(gl,debug,texture,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,debug,function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)}),callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,texture)})}function getFramebufferErrorMessage(gl,status){switch(status){case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case gl.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+status}}function throwIfNull(gl,debug,returnTOrNull,failureMessage){var tOrNull=callAndCheck(gl,debug,function(){return returnTOrNull()});if(null==tOrNull)throw new Error(failureMessage);return tOrNull}function validateTextureUnit(gl,textureUnit){var maxTextureUnit=gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,glTextureUnit=textureUnit+gl.TEXTURE0;if(glTextureUnit<gl.TEXTURE0||maxTextureUnit<glTextureUnit)throw new Error("textureUnit must be in "+("[gl.TEXTURE0, gl.TEXTURE"+maxTextureUnit+"]")+".")}function getBatchDim(shape,dimsToSkip){return void 0===dimsToSkip&&(dimsToSkip=2),util.sizeFromShape(shape.slice(0,shape.length-dimsToSkip))}function getRowsCols(shape){if(0===shape.length)throw Error("Cannot get rows and columns of an empty shape array.");return[1<shape.length?shape[shape.length-2]:1,shape[shape.length-1]]}function isEven(n){return n%2==0}function hasExtension(gl,extensionName){return null!=gl.getExtension(extensionName)}function createFloatTextureAndBindToFramebuffer(gl){var texConfig=tex_util_1.getTextureConfig(gl),texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,texConfig.internalFormatFloat,1,1,0,texConfig.textureFormatFloat,texConfig.textureTypeFloat,null);var frameBuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var isFrameBufferComplete=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(texture),gl.deleteFramebuffer(frameBuffer),isFrameBufferComplete}exports.createProgram=function(gl,debug){return throwIfNull(gl,debug,function(){return gl.createProgram()},"Unable to create WebGLProgram.")},exports.linkProgram=function(gl,debug,program){if(callAndCheck(gl,debug,function(){return gl.linkProgram(program)}),!1===gl.getProgramParameter(program,gl.LINK_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Failed to link vertex and fragment shaders.")},exports.validateProgram=function(gl,debug,program){if(callAndCheck(gl,debug,function(){return gl.validateProgram(program)}),!1===gl.getProgramParameter(program,gl.VALIDATE_STATUS))throw console.log(gl.getProgramInfoLog(program)),new Error("Shader program validation failed.")},exports.createStaticVertexBuffer=function(gl,debug,data){var buffer=throwIfNull(gl,debug,function(){return gl.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)}),callAndCheck(gl,debug,function(){return gl.bufferData(gl.ARRAY_BUFFER,data,gl.STATIC_DRAW)}),buffer},exports.createStaticIndexBuffer=function(gl,debug,data){var buffer=throwIfNull(gl,debug,function(){return gl.createBuffer()},"Unable to create WebGLBuffer");return callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffer)}),callAndCheck(gl,debug,function(){return gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,data,gl.STATIC_DRAW)}),buffer},exports.getNumChannels=function(){return 2===environment_1.ENV.getNumber("WEBGL_VERSION")?1:4},exports.createTexture=function(gl,debug){return throwIfNull(gl,debug,function(){return gl.createTexture()},"Unable to create WebGLTexture.")},exports.validateTextureSize=function(width,height){var maxTextureSize=environment_1.ENV.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(width<=0||height<=0){var requested="["+width+"x"+height+"]";throw new Error("Requested texture size "+requested+" is invalid.")}if(maxTextureSize<width||maxTextureSize<height){requested="["+width+"x"+height+"]";throw new Error("Requested texture size "+requested+" greater than WebGL maximum on this browser / GPU "+("["+maxTextureSize+"x"+maxTextureSize+"]")+".")}},exports.createFramebuffer=function(gl,debug){return throwIfNull(gl,debug,function(){return gl.createFramebuffer()},"Unable to create WebGLFramebuffer.")},exports.bindVertexBufferToProgramAttribute=function(gl,debug,program,attribute,buffer,arrayEntriesPerItem,itemStrideInBytes,itemOffsetInBytes){var loc=gl.getAttribLocation(program,attribute);return-1!==loc&&(callAndCheck(gl,debug,function(){return gl.bindBuffer(gl.ARRAY_BUFFER,buffer)}),callAndCheck(gl,debug,function(){return gl.vertexAttribPointer(loc,arrayEntriesPerItem,gl.FLOAT,!1,itemStrideInBytes,itemOffsetInBytes)}),callAndCheck(gl,debug,function(){return gl.enableVertexAttribArray(loc)}),!0)},exports.bindTextureUnit=bindTextureUnit,exports.unbindTextureUnit=function(gl,debug,textureUnit){validateTextureUnit(gl,textureUnit),callAndCheck(gl,debug,function(){return gl.activeTexture(gl.TEXTURE0+textureUnit)}),callAndCheck(gl,debug,function(){return gl.bindTexture(gl.TEXTURE_2D,null)})},exports.getProgramUniformLocationOrThrow=function(gl,debug,program,uniformName){return throwIfNull(gl,debug,function(){return gl.getUniformLocation(program,uniformName)},'uniform "'+uniformName+'" not present in program.')},exports.getProgramUniformLocation=function(gl,program,uniformName){return gl.getUniformLocation(program,uniformName)},exports.bindTextureToProgramUniformSampler=function(gl,debug,program,texture,uniformSamplerLocation,textureUnit){callAndCheck(gl,debug,function(){return bindTextureUnit(gl,debug,texture,textureUnit)}),callAndCheck(gl,debug,function(){return gl.uniform1i(uniformSamplerLocation,textureUnit)})},exports.bindCanvasToFramebuffer=function(gl,debug){callAndCheck(gl,debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,null)}),callAndCheck(gl,debug,function(){return gl.viewport(0,0,gl.canvas.width,gl.canvas.height)}),callAndCheck(gl,debug,function(){return gl.scissor(0,0,gl.canvas.width,gl.canvas.height)})},exports.bindColorTextureToFramebuffer=function(gl,debug,texture,framebuffer){callAndCheck(gl,debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)}),callAndCheck(gl,debug,function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0)})},exports.unbindColorTextureFromFramebuffer=function(gl,debug,framebuffer){callAndCheck(gl,debug,function(){return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer)}),callAndCheck(gl,debug,function(){return gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,null,0)})},exports.validateFramebuffer=function(gl){var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+getFramebufferErrorMessage(gl,status))},exports.getFramebufferErrorMessage=getFramebufferErrorMessage,exports.getBatchDim=getBatchDim,exports.getRowsCols=getRowsCols,exports.getShapeAs3D=function(shape){var shapeAs3D=[1,1,1];return 0===shape.length||1===shape.length&&1===shape[0]||(shapeAs3D=[getBatchDim(shape)].concat(getRowsCols(shape))),shapeAs3D},exports.getTextureShapeFromLogicalShape=function(logShape,isPacked){var _a;void 0===isPacked&&(isPacked=!1);var maxTexSize=environment_1.ENV.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(isPacked&&(maxTexSize*=2,1===(logShape=logShape.map(function(d,i){return i>=logShape.length-2?util.nearestLargerEven(logShape[i]):logShape[i]})).length&&(logShape=[2,logShape[0]])),2!==logShape.length){var squeezeResult=util.squeezeShape(logShape);logShape=squeezeResult.newShape}var size=util.sizeFromShape(logShape);if(logShape.length<=1&&size<=maxTexSize)return[1,size];if(2===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]<=maxTexSize)return logShape;if(3===logShape.length&&logShape[0]*logShape[1]<=maxTexSize&&logShape[2]<=maxTexSize)return[logShape[0]*logShape[1],logShape[2]];if(3===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]<=maxTexSize)return[logShape[0],logShape[1]*logShape[2]];if(4===logShape.length&&logShape[0]*logShape[1]*logShape[2]<=maxTexSize&&logShape[3]<=maxTexSize)return[logShape[0]*logShape[1]*logShape[2],logShape[3]];if(4===logShape.length&&logShape[0]<=maxTexSize&&logShape[1]*logShape[2]*logShape[3]<=maxTexSize)return[logShape[0],logShape[1]*logShape[2]*logShape[3]];if(isPacked){var batchDim=getBatchDim(logShape),rows=2,cols=2;return logShape.length&&(rows=(_a=getRowsCols(logShape))[0],cols=_a[1]),size=batchDim*(rows/2)*(cols/2),util.sizeToSquarishShape(size).map(function(d){return 2*d})}return util.sizeToSquarishShape(size)},exports.isReshapeFree=function(shape1,shape2){if(shape1=shape1.slice(-2),shape2=shape2.slice(-2),util.arraysEqual(shape1,shape2))return!0;if(!shape1.length||!shape2.length)return!0;if(0===shape1[0]||0===shape1[1]||0===shape2[0]||0===shape2[1])return!0;if(shape1.length!==shape2.length){var shape1Cols=shape1.slice(-1)[0],shape2Cols=shape2.slice(-1)[0];if(shape1Cols===shape2Cols)return!0;if(isEven(shape1Cols)&&isEven(shape2Cols)&&(1===shape1[0]||1===shape2[0]))return!0}return shape1[1]===shape2[1]&&isEven(shape1[0])&&isEven(shape2[0])},exports.getWebGLMaxTextureSize=function(webGLVersion){if(null==MAX_TEXTURE_SIZE){var gl=canvas_util_1.getWebGLContext(webGLVersion);MAX_TEXTURE_SIZE=gl.getParameter(gl.MAX_TEXTURE_SIZE)}return MAX_TEXTURE_SIZE},exports.resetMaxTextureSize=function(){MAX_TEXTURE_SIZE=null},exports.resetMaxTexturesInShader=function(){MAX_TEXTURES_IN_SHADER=null},exports.getMaxTexturesInShader=function(webGLVersion){if(null==MAX_TEXTURES_IN_SHADER){var gl=canvas_util_1.getWebGLContext(webGLVersion);MAX_TEXTURES_IN_SHADER=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,MAX_TEXTURES_IN_SHADER)},exports.getWebGLDisjointQueryTimerVersion=function(webGLVersion){if(0===webGLVersion)return 0;var gl=canvas_util_1.getWebGLContext(webGLVersion);return hasExtension(gl,"EXT_disjoint_timer_query_webgl2")&&2===webGLVersion?2:hasExtension(gl,"EXT_disjoint_timer_query")?1:0},exports.hasExtension=hasExtension,exports.isWebGLVersionEnabled=function(webGLVersion){try{if(null!=canvas_util_1.getWebGLContext(webGLVersion))return!0}catch(e){return!1}return!1},exports.isRenderToFloatTextureEnabled=function(webGLVersion){if(0===webGLVersion)return!1;var gl=canvas_util_1.getWebGLContext(webGLVersion);if(1===webGLVersion){if(!hasExtension(gl,"OES_texture_float"))return!1}else if(!hasExtension(gl,"EXT_color_buffer_float"))return!1;return createFloatTextureAndBindToFramebuffer(gl)},exports.isDownloadFloatTextureEnabled=function(webGLVersion){if(0===webGLVersion)return!1;var gl=canvas_util_1.getWebGLContext(webGLVersion);if(1===webGLVersion)return!!hasExtension(gl,"OES_texture_float")&&(!!hasExtension(gl,"WEBGL_color_buffer_float")&&createFloatTextureAndBindToFramebuffer(gl));if(hasExtension(gl,"EXT_color_buffer_float"))return createFloatTextureAndBindToFramebuffer(gl);if(hasExtension(gl,"EXT_color_buffer_half_float")){var textureHalfFloatExtension=gl.getExtension("EXT_color_buffer_half_float");return function(gl,textureHalfFloatExtension){var texConfig=tex_util_1.getTextureConfig(gl,textureHalfFloatExtension),texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,texConfig.internalFormatHalfFloat,1,1,0,texConfig.textureFormatFloat,texConfig.textureTypeHalfFloat,null);var frameBuffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var isFrameBufferComplete=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(texture),gl.deleteFramebuffer(frameBuffer),isFrameBufferComplete}(gl,textureHalfFloatExtension)}return!1},exports.isWebGLFenceEnabled=function(webGLVersion){return 2===webGLVersion&&null!=canvas_util_1.getWebGLContext(webGLVersion).fenceSync}},{"../../environment":144,"../../util":241,"./canvas_util":70,"./tex_util":131}],140:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var array_ops_1=require("../ops/array_ops");exports.whereImpl=function(condShape,condVals){for(var indices=[],i=0;i<condVals.length;i++)condVals[i]&&indices.push(i);var inBuffer=array_ops_1.buffer(condShape,"int32"),out=array_ops_1.buffer([indices.length,condShape.length],"int32");for(i=0;i<indices.length;i++){var loc=inBuffer.indexToLoc(indices[i]),offset=i*condShape.length;out.values.set(loc,offset)}return out.toTensor()}},{"../ops/array_ops":163}],141:[function(require,module,exports){(function(setImmediate){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var delayCallback="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:void 0!==setImmediate?setImmediate:function(f){return f()};exports.nextFrame=function(){return new Promise(function(resolve){return delayCallback(function(){return resolve()})})}}).call(this,require("timers").setImmediate)},{timers:346}],142:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isMobile=function(){var a=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))},exports.isBrowser=function(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}},{}],143:[function(require,module,exports){(function(process,global){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var GLOBAL,environment_1=require("./environment"),profiler_1=require("./profiler"),tape_1=require("./tape"),tensor_1=require("./tensor"),tensor_util_1=require("./tensor_util"),util=require("./util"),util_1=require("./util"),EngineState=function(){function EngineState(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return EngineState.prototype.dispose=function(){for(var variableName in this.registeredVariables)this.registeredVariables[variableName].dispose()},EngineState}(),Engine=function(){function Engine(ENV){this.ENV=ENV,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new EngineState}return Engine.prototype.ready=function(){return __awaiter(this,void 0,void 0,function(){var sortedBackends,i,backendName;return __generator(this,function(_a){switch(_a.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];sortedBackends=this.getSortedBackends(),i=0,_a.label=1;case 1:return i<sortedBackends.length?(backendName=sortedBackends[i],[4,this.initializeBackend(backendName).success]):[3,5];case 2:return _a.sent()?[4,this.setBackend(backendName)]:[3,4];case 3:return _a.sent(),[2];case 4:return i++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(Engine.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() before calling other methods");if(null==this.backendInstance){var _a=this.initializeBackendsAndReturnBest(),name_1=_a.name;if(_a.asyncInit)throw new Error("The highest priority backend '"+name_1+"' has not yet been initialized. Make sure to await tf.ready() before calling other methods");this.setBackend(name_1)}return this.backendInstance},enumerable:!0,configurable:!0}),Engine.prototype.backendNames=function(){return Object.keys(this.registryFactory)},Engine.prototype.findBackend=function(backendName){if(!(backendName in this.registry)){if(!(backendName in this.registryFactory))return null;if(this.initializeBackend(backendName).asyncInit)return null}return this.registry[backendName]},Engine.prototype.findBackendFactory=function(backendName){return backendName in this.registryFactory?this.registryFactory[backendName].factory:null},Engine.prototype.registerBackend=function(backendName,factory,priority){return void 0===priority&&(priority=1),backendName in this.registryFactory?(console.warn(backendName+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[backendName]={factory:factory,priority:priority},!0)},Engine.prototype.setBackend=function(backendName){return __awaiter(this,void 0,void 0,function(){var _a,success,_b;return __generator(this,function(_c){switch(_c.label){case 0:if(null==this.registryFactory[backendName])throw new Error("Backend name '"+backendName+"' not found in registry");return this.backendName=backendName,null!=this.registry[backendName]?[3,4]:(this.backendInstance=null,_a=this.initializeBackend(backendName),success=_a.success,_a.asyncInit?[4,success]:[3,2]);case 1:return _b=_c.sent(),[3,3];case 2:_b=success,_c.label=3;case 3:if(!_b)return[2,!1];_c.label=4;case 4:return this.backendInstance=this.registry[backendName],this.profiler=new profiler_1.Profiler(this.backendInstance),[2,!0]}})})},Engine.prototype.initializeBackend=function(backendName){var _this=this,registryFactoryEntry=this.registryFactory[backendName];if(null==registryFactoryEntry)throw new Error("Cannot initialize backend "+backendName+", no registration found.");try{var backend=registryFactoryEntry.factory();if(Promise.resolve(backend)!==backend)return this.registry[backendName]=backend,{success:!0,asyncInit:!1};var promiseId_1=++this.pendingBackendInitId,success=backend.then(function(backendInstance){return!(promiseId_1<_this.pendingBackendInitId)&&(_this.registry[backendName]=backendInstance,!(_this.pendingBackendInit=null))}).catch(function(err){return promiseId_1<_this.pendingBackendInitId||(_this.pendingBackendInit=null,console.warn("Initialization of backend "+backendName+" failed"),console.warn(err.stack||err.message)),!1});return{success:this.pendingBackendInit=success,asyncInit:!0}}catch(err){return console.warn("Initialization of backend "+backendName+" failed"),console.warn(err.stack||err.message),{success:!1,asyncInit:!1}}},Engine.prototype.removeBackend=function(backendName){if(!(backendName in this.registryFactory))throw new Error(backendName+" backend not found in registry");this.backendName===backendName&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,backendName in this.registry&&(this.registry[backendName].dispose(),delete this.registry[backendName]),delete this.registryFactory[backendName],this.backendName===backendName&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},Engine.prototype.getSortedBackends=function(){var _this=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(a,b){return _this.registryFactory[b].priority-_this.registryFactory[a].priority})},Engine.prototype.initializeBackendsAndReturnBest=function(){for(var sortedBackends=this.getSortedBackends(),i=0;i<sortedBackends.length;i++){var backendName=sortedBackends[i],_a=this.initializeBackend(backendName),success=_a.success,asyncInit=_a.asyncInit;if(asyncInit||success)return{name:backendName,asyncInit:asyncInit}}throw new Error("Could not initialize any backends, all backend initializations failed.")},Engine.prototype.moveData=function(destBackend,dataId){this.write(destBackend,dataId,this.readSync(dataId))},Engine.prototype.tidy=function(nameOrFn,fn){var result,_this=this,name=null;if(null==fn){if("function"!=typeof nameOrFn)throw new Error("Please provide a function to tidy()");fn=nameOrFn}else{if("string"!=typeof nameOrFn&&!(nameOrFn instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof fn)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");name=nameOrFn}return this.scopedRun(function(){return _this.startScope(name)},function(){return _this.endScope(result)},function(){return(result=fn())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),result})},Engine.prototype.scopedRun=function(start,end,f){start();try{var res=f();return end(),res}catch(ex){throw end(),ex}},Engine.prototype.nextTensorId=function(){return Engine.nextTensorId++},Engine.prototype.nextVariableId=function(){return Engine.nextVariableId++},Engine.prototype.clone=function(x){var y=tensor_1.Tensor.make(x.shape,{dataId:x.dataId},x.dtype);return this.addTapeNode([x],y,function(dy){return[dy.toFloat()]}),y},Engine.prototype.runKernel=function(forwardFunc,inputs,backwardsFunc){function saveFunc(tensors){isTapeOn&&(saved=tensors.map(function(tensor){return _this.keep(_this.clone(tensor))}))}var result,_this=this,saved=[],isTapeOn=this.isTapeOn(),scopeName=null!=this.state.activeScope?this.state.activeScope.name:"",startingBytecount=this.state.numBytes,startingNumTensors=this.state.numTensors;if(this.scopedRun(function(){return _this.state.kernelDepth++},function(){return _this.state.kernelDepth--},function(){result=_this.ENV.getBool("DEBUG")?_this.profiler.profileKernel(scopeName,inputs,function(){return forwardFunc(_this.backend,saveFunc)}):forwardFunc(_this.backend,saveFunc)}),isTapeOn){var tapeNode={id:this.state.nextTapeNodeId++,name:scopeName,inputs:inputs,outputs:Array.isArray(result)?result:[result],saved:saved};null!=backwardsFunc&&(tapeNode.gradient=function(dy){return backwardsFunc(dy,saved)}),this.state.activeTape.push(tapeNode)}return this.state.profiling&&this.state.activeProfile.kernels.push({name:scopeName,bytesAdded:this.state.numBytes-startingBytecount,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-startingNumTensors,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(inputs).map(function(key){return inputs[key].shape}),outputShape:Array.isArray(result)?result.map(function(item){return item.shape}):result.shape}),result},Engine.prototype.registerTensor=function(a,backend){var refCount=this.state.tensorInfo.has(a.dataId)?this.state.tensorInfo.get(a.dataId).refCount:0;if(this.state.numTensors++,"string"===a.dtype&&this.state.numStringTensors++,0===refCount){this.state.numDataBuffers++;var bytes=0;"complex64"!==a.dtype&&"string"!==a.dtype&&(bytes=a.size*util.bytesPerElement(a.dtype)),this.state.tensorInfo.set(a.dataId,{backend:null!=backend?backend:this.backend,dtype:a.dtype,shape:a.shape,bytes:bytes,refCount:0}),this.state.numBytes+=bytes,null!=backend?backend.register(a.dataId,a.shape,a.dtype):this.backend.register(a.dataId,a.shape,a.dtype)}this.state.tensorInfo.get(a.dataId).refCount++,a instanceof tensor_1.Variable||this.track(a)},Engine.prototype.registerVariable=function(v){if(null!=this.state.registeredVariables[v.name])throw new Error("Variable with name "+v.name+" was already registered");this.state.registeredVariables[v.name]=v},Engine.prototype.disposeTensor=function(a){if(this.state.tensorInfo.has(a.dataId)){this.state.numTensors--,"string"===a.dtype&&this.state.numStringTensors--;var info=this.state.tensorInfo.get(a.dataId);info.refCount<=1?("complex64"!==a.dtype&&(this.state.numBytes-=info.bytes),this.state.numDataBuffers--,info.backend.disposeData(a.dataId),this.state.tensorInfo.delete(a.dataId)):this.state.tensorInfo.get(a.dataId).refCount--}},Engine.prototype.disposeVariables=function(){for(var varName in this.state.registeredVariables){var v=this.state.registeredVariables[varName];this.disposeVariable(v)}},Engine.prototype.disposeVariable=function(v){this.disposeTensor(v),null!=this.state.registeredVariables[v.name]&&delete this.state.registeredVariables[v.name]},Engine.prototype.memory=function(){var info=this.backend.memory();return info.numTensors=this.state.numTensors,info.numDataBuffers=this.state.numDataBuffers,info.numBytes=this.state.numBytes,0<this.state.numStringTensors&&(info.unreliable=!0,null==info.reasons&&(info.reasons=[]),info.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),info},Engine.prototype.profile=function(query){return __awaiter(this,void 0,void 0,function(){var startBytes,startNumTensors;return __generator(this,function(_a){return this.state.profiling=!0,startBytes=this.state.numBytes,startNumTensors=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=query(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(d){return d.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-startBytes,this.state.activeProfile.newTensors=this.state.numTensors-startNumTensors,[2,this.state.activeProfile]})})},Engine.prototype.isTapeOn=function(){return 0<this.state.gradientDepth&&0===this.state.kernelDepth},Engine.prototype.addTapeNode=function(inputs,result,gradientsFunc){var inputsMap={};inputs.forEach(function(input,idx){inputsMap[idx]=input});var tapeNode={id:this.state.nextTapeNodeId++,name:this.state.activeScope.name,inputs:inputsMap,outputs:[result],gradient:function(dy){var res=gradientsFunc(dy),resMap={};return res.forEach(function(r,idx){resMap[idx]=function(){return r}}),resMap}};this.state.activeTape.push(tapeNode)},Engine.prototype.keep=function(result){return result.kept=!0,result},Engine.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},Engine.prototype.endTape=function(){this.state.gradientDepth--},Engine.prototype.startScope=function(name){var scopeInfo={track:[],name:"unnamed scope",id:this.state.nextScopeId++};name&&(scopeInfo.name=name),this.state.scopeStack.push(scopeInfo),this.state.activeScope=scopeInfo},Engine.prototype.endScope=function(result){for(var _this=this,tensorsToTrackInParent=tensor_util_1.getTensorsInContainer(result),tensorsToTrackInParentSet=new Set(tensorsToTrackInParent.map(function(t){return t.id})),i=0;i<this.state.activeScope.track.length;i++){var tensor=this.state.activeScope.track[i];tensor.kept||tensorsToTrackInParentSet.has(tensor.id)||tensor.dispose()}var oldScope=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],tensorsToTrackInParent.forEach(function(tensor){tensor.kept||tensor.scopeId!==oldScope.id||_this.track(tensor)})},Engine.prototype.gradients=function(f,xs,dy,allowNoGradients){var _this=this;if(void 0===allowNoGradients&&(allowNoGradients=!1),util.assert(0<xs.length,function(){return"gradients() received an empty list of xs."}),null!=dy&&"float32"!==dy.dtype)throw new Error("dy must have 'float32' dtype, but has '"+dy.dtype+"'");var y=this.scopedRun(function(){return _this.startTape()},function(){return _this.endTape()},function(){return _this.tidy("forward",f)});util.assert(y instanceof tensor_1.Tensor,function(){return"The result y returned by f() must be a tensor."});var filteredTape=tape_1.getFilteredNodesXToY(this.state.activeTape,xs,y);if(!allowNoGradients&&0===filteredTape.length&&0<xs.length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var accumulatedGradientMap={};accumulatedGradientMap[y.id]=null==dy?function(shape){var values=util_1.makeOnesTypedArray(util_1.sizeFromShape(shape),"float32");return tensor_1.Tensor.make(shape,{values:values})}(y.shape):dy,tape_1.backpropagateGradients(accumulatedGradientMap,filteredTape,function(f){return _this.tidy(f)});var grads=xs.map(function(x){return accumulatedGradientMap[x.id]});return 0===_this.state.gradientDepth&&(_this.state.activeTape.forEach(function(node){for(var key in node.saved)node.saved[key].dispose()}),_this.state.activeTape=null),{value:y,grads:grads}})},Engine.prototype.customGrad=function(f){var _this=this;return util.assert(util.isFunction(f),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var res,inputs=[],_i=0;_i<arguments.length;_i++)inputs[_i]=arguments[_i];util.assert(inputs.every(function(t){return t instanceof tensor_1.Tensor}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var inputMap={};return inputs.forEach(function(input,i){inputMap[i]=input}),_this.runKernel(function(_,save){return res=f.apply(void 0,inputs.concat([save])),util.assert(res.value instanceof tensor_1.Tensor,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),util.assert(util.isFunction(res.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),res.value},inputMap,function(dy,saved){var gradRes=res.gradFunc(dy,saved),grads=Array.isArray(gradRes)?gradRes:[gradRes];util.assert(grads.length===inputs.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),util.assert(grads.every(function(t){return t instanceof tensor_1.Tensor}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var gradMap={};return grads.forEach(function(grad,i){gradMap[i]=function(){return grad}}),gradMap})}},Engine.prototype.write=function(destBackend,dataId,values){var info=this.state.tensorInfo.get(dataId),srcBackend=info.backend;if(destBackend=destBackend||this.backend,"string"===info.dtype){var newBytes=util_1.bytesFromStringArray(values);this.state.numBytes+=newBytes-info.bytes,info.bytes=newBytes}destBackend!==srcBackend&&(srcBackend.disposeData(dataId),(info.backend=destBackend).register(dataId,info.shape,info.dtype)),destBackend.write(dataId,values)},Engine.prototype.readSync=function(dataId){return this.state.tensorInfo.get(dataId).backend.readSync(dataId)},Engine.prototype.read=function(dataId){return this.state.tensorInfo.get(dataId).backend.read(dataId)},Engine.prototype.fromPixels=function(pixels,numChannels){return this.backend.fromPixels(pixels,numChannels)},Engine.prototype.time=function(query){return __awaiter(this,void 0,void 0,function(){var start,timingInfo;return __generator(this,function(_a){switch(_a.label){case 0:return start=util_1.now(),[4,this.backend.time(query)];case 1:return(timingInfo=_a.sent()).wallMs=util_1.now()-start,[2,timingInfo]}})})},Engine.prototype.track=function(result){return null!=this.state.activeScope&&(result.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(result)),result},Object.defineProperty(Engine.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),Engine.prototype.reset=function(){for(var backendName in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new EngineState,this.registry)this.registry[backendName].dispose(),delete this.registry[backendName];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},Engine.nextTensorId=0,Engine.nextVariableId=0,Engine}();exports.Engine=Engine,exports.ENGINE=function(){var ns=function(){if(null==GLOBAL){var ns=void 0;if("undefined"!=typeof window)ns=window;else if(void 0!==global)ns=global;else if(void 0!==process)ns=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");ns=self}GLOBAL=ns}return GLOBAL}();if(null==ns._tfengine){var environment=new environment_1.Environment(ns);ns._tfengine=new Engine(environment)}return environment_1.setEnvironmentGlobal(ns._tfengine.ENV),tensor_1.setTensorTracker(function(){return ns._tfengine}),ns._tfengine}()}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./environment":144,"./profiler":231,"./tape":233,"./tensor":234,"./tensor_util":236,"./util":241,_process:337}],144:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Environment=function(){function Environment(global){this.global=global,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return Environment.prototype.setPlatform=function(platformName,platform){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+platform+"."),this.platformName=platformName,this.platform=platform},Environment.prototype.registerFlag=function(flagName,evaluationFn,setHook){if(this.flagRegistry[flagName]={evaluationFn:evaluationFn,setHook:setHook},null!=this.urlFlags[flagName]){var flagValue=this.urlFlags[flagName];console.warn("Setting feature override from URL "+flagName+": "+flagValue+"."),this.set(flagName,flagValue)}},Environment.prototype.get=function(flagName){return flagName in this.flags||(this.flags[flagName]=this.evaluateFlag(flagName)),this.flags[flagName]},Environment.prototype.getNumber=function(flagName){return this.get(flagName)},Environment.prototype.getBool=function(flagName){return this.get(flagName)},Environment.prototype.getFlags=function(){return this.flags},Object.defineProperty(Environment.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),Environment.prototype.set=function(flagName,value){if(null==this.flagRegistry[flagName])throw new Error("Cannot set flag "+flagName+" as it has not been registered.");this.flags[flagName]=value,null!=this.flagRegistry[flagName].setHook&&this.flagRegistry[flagName].setHook(value)},Environment.prototype.evaluateFlag=function(flagName){if(null==this.flagRegistry[flagName])throw new Error("Cannot evaluate flag '"+flagName+"': no evaluation function found.");return this.flagRegistry[flagName].evaluationFn()},Environment.prototype.setFlags=function(flags){this.flags=Object.assign({},flags)},Environment.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},Environment.prototype.populateURLFlags=function(){var _this=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var urlParams=getQueryParams(this.global.location.search);if("tfjsflags"in urlParams)urlParams.tfjsflags.split(",").forEach(function(keyValue){var _a=keyValue.split(":"),key=_a[0],value=_a[1];_this.urlFlags[key]=function(flagName,value){{if("true"===(value=value.toLowerCase())||"false"===value)return"true"===value;if(""+ +value===value)return+value}throw new Error("Could not parse value flag value "+value+" for flag "+flagName+".")}(key,value)})}},Environment}();function getQueryParams(queryString){var params={};return queryString.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(s){for(var t=[],_i=1;_i<arguments.length;_i++)t[_i-1]=arguments[_i];return function(params,name,value){params[decodeURIComponent(name)]=decodeURIComponent(value||"")}(params,t[0],t[1]),t.join("=")}),params}exports.Environment=Environment,exports.getQueryParams=getQueryParams,exports.ENV=null,exports.setEnvironmentGlobal=function(environment){exports.ENV=environment}},{}],145:[function(require,module,exports){(function(process){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var device_util=require("./device_util"),environment_1=require("./environment");environment_1.ENV.registerFlag("DEBUG",function(){return!1},function(debugValue){debugValue&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),environment_1.ENV.registerFlag("IS_BROWSER",function(){return device_util.isBrowser()}),environment_1.ENV.registerFlag("IS_NODE",function(){return void 0!==process&&void 0!==process.versions&&void 0!==process.versions.node}),environment_1.ENV.registerFlag("IS_CHROME",function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),environment_1.ENV.registerFlag("PROD",function(){return!1}),environment_1.ENV.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return environment_1.ENV.getBool("DEBUG")}),environment_1.ENV.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),environment_1.ENV.registerFlag("IS_TEST",function(){return!1})}).call(this,require("_process"))},{"./device_util":142,"./environment":144,_process:337}],146:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),environment_1=require("./environment"),tensor_1=require("./tensor"),tensor_util_1=require("./tensor_util");function deprecationWarn(msg){environment_1.ENV.getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(msg+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}exports.enableProdMode=function(){environment_1.ENV.set("PROD",!0)},exports.enableDebugMode=function(){environment_1.ENV.set("DEBUG",!0)},exports.disableDeprecationWarnings=function(){environment_1.ENV.set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")},exports.deprecationWarn=deprecationWarn,tensor_1.setDeprecationWarningFn(deprecationWarn),exports.disposeVariables=function(){engine_1.ENGINE.disposeVariables()},exports.memory=function(){return engine_1.ENGINE.memory()},exports.profile=function(f){return engine_1.ENGINE.profile(f)},exports.tidy=function(nameOrFn,fn){return engine_1.ENGINE.tidy(nameOrFn,fn)},exports.dispose=function(container){tensor_util_1.getTensorsInContainer(container).forEach(function(tensor){return tensor.dispose()})},exports.keep=function(result){return engine_1.ENGINE.keep(result)},exports.time=function(f){return engine_1.ENGINE.time(f)},exports.setBackend=function(backendName){return engine_1.ENGINE.setBackend(backendName)},exports.ready=function(){return engine_1.ENGINE.ready()},exports.getBackend=function(){return engine_1.ENGINE.backendName},exports.removeBackend=function(name){engine_1.ENGINE.removeBackend(name)},exports.findBackend=function(name){return engine_1.ENGINE.findBackend(name)},exports.findBackendFactory=function(name){return engine_1.ENGINE.findBackendFactory(name)},exports.registerBackend=function(name,factory,priority){return void 0===priority&&(priority=1),engine_1.ENGINE.registerBackend(name,factory,priority)},exports.backend=function(){return engine_1.ENGINE.backend},exports.setPlatform=function(platformName,platform){environment_1.ENV.setPlatform(platformName,platform)}},{"./engine":143,"./environment":144,"./tensor":234,"./tensor_util":236}],147:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),tensor_1=require("./tensor"),tensor_util_env_1=require("./tensor_util_env"),util=require("./util");function checkGrads(grads){if(0<grads.filter(function(g){return null==g}).length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}exports.grad=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in grad(f) must be a function"}),function(x,dy){var $x=tensor_util_env_1.convertToTensor(x,"x","tf.grad",null),$dy=null!=dy?tensor_util_env_1.convertToTensor(dy,"dy","tf.grad"):null;return engine_1.ENGINE.tidy(function(){var _a=engine_1.ENGINE.gradients(function(){return f($x)},[$x],$dy),value=_a.value,grads=_a.grads;return null!=$dy&&util.assertShapesMatch(value.shape,$dy.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),checkGrads(grads),grads[0]})}},exports.grads=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in grads(f) must be a function"}),function(args,dy){util.assert(Array.isArray(args),function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"});var $args=tensor_util_env_1.convertToTensorArray(args,"args","tf.grads",null),$dy=null!=dy?tensor_util_env_1.convertToTensor(dy,"dy","tf.grads"):null;return engine_1.ENGINE.tidy(function(){var _a=engine_1.ENGINE.gradients(function(){return f.apply(void 0,$args)},$args,$dy),value=_a.value,grads=_a.grads;return null!=$dy&&util.assertShapesMatch(value.shape,$dy.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),checkGrads(grads),grads})}},exports.valueAndGrad=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in valueAndGrad(f) must be a function"}),function(x,dy){util.assert(x instanceof tensor_1.Tensor,function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"}),util.assert(null==dy||dy instanceof tensor_1.Tensor,function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"});var _a=engine_1.ENGINE.gradients(function(){return f(x)},[x],dy),grads=_a.grads,value=_a.value;return checkGrads(grads),{grad:grads[0],value:value}}},exports.valueAndGrads=function(f){return util.assert(util.isFunction(f),function(){return"The f passed in valueAndGrads(f) must be a function"}),function(args,dy){util.assert(Array.isArray(args)&&args.every(function(arg){return arg instanceof tensor_1.Tensor}),function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"}),util.assert(null==dy||dy instanceof tensor_1.Tensor,function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"});var res=engine_1.ENGINE.gradients(function(){return f.apply(void 0,args)},args,dy);return null!=dy&&util.assertShapesMatch(res.value.shape,dy.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),checkGrads(res.grads),res}},exports.variableGrads=function(f,varList){util.assert(util.isFunction(f),function(){return"The f passed in variableGrads(f) must be a function"}),util.assert(null==varList||Array.isArray(varList)&&varList.every(function(v){return v instanceof tensor_1.Variable}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var specifiedVarList=null!=varList;if(!specifiedVarList)for(var varName in varList=[],engine_1.ENGINE.registeredVariables)varList.push(engine_1.ENGINE.registeredVariables[varName]);var specifiedNonTrainable=specifiedVarList?varList.filter(function(variable){return!variable.trainable}):null,originalVarCount=varList.length;varList=varList.filter(function(variable){return variable.trainable}),util.assert(0<varList.length,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+originalVarCount+" variables is trainable."});var _a=engine_1.ENGINE.gradients(f,varList,null,!0),value=_a.value,grads=_a.grads;util.assert(grads.some(function(g){return null!=g}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),util.assert(0===value.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+value.rank+" tensor"});var namedGrads={};return varList.forEach(function(v,i){null!=grads[i]&&(namedGrads[v.name]=grads[i])}),null!=specifiedNonTrainable&&specifiedNonTrainable.forEach(function(v){return namedGrads[v.name]=null}),{value:value,grads:namedGrads}},exports.customGrad=function(f){return engine_1.ENGINE.customGrad(f)}},{"./engine":143,"./tensor":234,"./tensor_util_env":237,"./util":241}],148:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),require("./engine"),require("./flags"),require("./backends/webgl/backend_webgl"),require("./backends/cpu/backend_cpu"),require("./platforms/platform_browser"),require("./platforms/platform_node");var backend_util=require("./backends/backend_util");exports.backend_util=backend_util;var environment=require("./environment");exports.environment=environment;var io=require("./io/io");exports.io=io;var math=require("./math");exports.math=math;var browser=require("./ops/browser");exports.browser=browser;var serialization=require("./serialization");exports.serialization=serialization;var tensor_1=require("./tensor"),tensor_util=require("./tensor_util");exports.tensor_util=tensor_util;var test_util=require("./test_util");exports.test_util=test_util;var util=require("./util");exports.util=util;var version_1=require("./version");exports.version_core=version_1.version;var webgl=require("./webgl");exports.webgl=webgl;var adadelta_optimizer_1=require("./optimizers/adadelta_optimizer");exports.AdadeltaOptimizer=adadelta_optimizer_1.AdadeltaOptimizer;var adagrad_optimizer_1=require("./optimizers/adagrad_optimizer");exports.AdagradOptimizer=adagrad_optimizer_1.AdagradOptimizer;var adam_optimizer_1=require("./optimizers/adam_optimizer");exports.AdamOptimizer=adam_optimizer_1.AdamOptimizer;var adamax_optimizer_1=require("./optimizers/adamax_optimizer");exports.AdamaxOptimizer=adamax_optimizer_1.AdamaxOptimizer;var momentum_optimizer_1=require("./optimizers/momentum_optimizer");exports.MomentumOptimizer=momentum_optimizer_1.MomentumOptimizer;var optimizer_1=require("./optimizers/optimizer");exports.Optimizer=optimizer_1.Optimizer;var rmsprop_optimizer_1=require("./optimizers/rmsprop_optimizer");exports.RMSPropOptimizer=rmsprop_optimizer_1.RMSPropOptimizer;var sgd_optimizer_1=require("./optimizers/sgd_optimizer");exports.SGDOptimizer=sgd_optimizer_1.SGDOptimizer;var tensor_2=require("./tensor");exports.Tensor=tensor_2.Tensor,exports.TensorBuffer=tensor_2.TensorBuffer,exports.variable=tensor_2.variable,exports.Variable=tensor_2.Variable;var types_1=require("./types");exports.Rank=types_1.Rank,__export(require("./ops/ops"));var loss_ops_1=require("./ops/loss_ops");exports.Reduction=loss_ops_1.Reduction,__export(require("./train")),__export(require("./globals"));var gradients_1=require("./gradients");exports.customGrad=gradients_1.customGrad,exports.grad=gradients_1.grad,exports.grads=gradients_1.grads,exports.valueAndGrad=gradients_1.valueAndGrad,exports.valueAndGrads=gradients_1.valueAndGrads,exports.variableGrads=gradients_1.variableGrads;var environment_1=require("./environment");exports.ENV=environment_1.ENV,exports.Environment=environment_1.Environment;var browser_util_1=require("./browser_util");exports.nextFrame=browser_util_1.nextFrame;var backend_1=require("./backends/backend");exports.KernelBackend=backend_1.KernelBackend,exports.DataStorage=backend_1.DataStorage;var ops=require("./ops/ops");tensor_1.setOpHandler(ops)},{"./backends/backend":50,"./backends/backend_util":51,"./backends/cpu/backend_cpu":53,"./backends/webgl/backend_webgl":64,"./browser_util":141,"./engine":143,"./environment":144,"./flags":145,"./globals":146,"./gradients":147,"./io/io":152,"./math":162,"./ops/browser":170,"./ops/loss_ops":189,"./ops/ops":196,"./optimizers/adadelta_optimizer":220,"./optimizers/adagrad_optimizer":221,"./optimizers/adam_optimizer":222,"./optimizers/adamax_optimizer":223,"./optimizers/momentum_optimizer":224,"./optimizers/optimizer":225,"./optimizers/rmsprop_optimizer":227,"./optimizers/sgd_optimizer":228,"./platforms/platform_browser":229,"./platforms/platform_node":230,"./serialization":232,"./tensor":234,"./tensor_util":236,"./test_util":238,"./train":239,"./types":240,"./util":241,"./version":242,"./webgl":243}],149:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),io_utils_1=require("./io_utils"),router_registry_1=require("./router_registry");function defer(f){return new Promise(function(resolve){return setTimeout(resolve)}).then(f)}var BrowserDownloads=function(){function BrowserDownloads(fileNamePrefix){if(!environment_1.ENV.getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");fileNamePrefix.startsWith(BrowserDownloads.URL_SCHEME)&&(fileNamePrefix=fileNamePrefix.slice(BrowserDownloads.URL_SCHEME.length)),null!=fileNamePrefix&&0!==fileNamePrefix.length||(fileNamePrefix="model"),this.modelTopologyFileName=fileNamePrefix+".json",this.weightDataFileName=fileNamePrefix+".weights.bin"}return BrowserDownloads.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){var weightsURL,weightsManifest,modelTopologyAndWeightManifest,modelTopologyAndWeightManifestURL,jsonAnchor_1,weightDataAnchor_1;return __generator(this,function(_a){switch(_a.label){case 0:if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(weightsURL=window.URL.createObjectURL(new Blob([modelArtifacts.weightData],{type:"application/octet-stream"})),!(modelArtifacts.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return weightsManifest=[{paths:["./"+this.weightDataFileName],weights:modelArtifacts.weightSpecs}],modelTopologyAndWeightManifest={modelTopology:modelArtifacts.modelTopology,format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,weightsManifest:weightsManifest},modelTopologyAndWeightManifestURL=window.URL.createObjectURL(new Blob([JSON.stringify(modelTopologyAndWeightManifest)],{type:"application/json"})),(jsonAnchor_1=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,jsonAnchor_1.href=modelTopologyAndWeightManifestURL,[4,defer(function(){return jsonAnchor_1.dispatchEvent(new MouseEvent("click"))})];case 2:return _a.sent(),null==modelArtifacts.weightData?[3,4]:((weightDataAnchor_1=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,weightDataAnchor_1.href=weightsURL,[4,defer(function(){return weightDataAnchor_1.dispatchEvent(new MouseEvent("click"))})]);case 3:_a.sent(),_a.label=4;case 4:return[2,{modelArtifactsInfo:io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts)}]}})})},BrowserDownloads.URL_SCHEME="downloads://",BrowserDownloads}();exports.BrowserDownloads=BrowserDownloads;var BrowserFiles=function(){function BrowserFiles(files){if(null==files||files.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+files);this.files=files}return BrowserFiles.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var jsonFile,weightFiles,_this=this;return __generator(this,function(_a){return jsonFile=this.files[0],weightFiles=this.files.slice(1),[2,new Promise(function(resolve,reject){var jsonReader=new FileReader;jsonReader.onload=function(event){var modelJSON=JSON.parse(event.target.result),modelTopology=modelJSON.modelTopology;if(null!=modelTopology){0===weightFiles.length&&resolve({modelTopology:modelTopology});var weightsManifest=modelJSON.weightsManifest;if(null!=weightsManifest){var pathToFile;try{pathToFile=_this.checkManifestAndWeightFiles(weightsManifest,weightFiles)}catch(err){return void reject(err)}var weightSpecs=[],paths=[],perFileBuffers=[];weightsManifest.forEach(function(weightsGroup){weightsGroup.paths.forEach(function(path){paths.push(path),perFileBuffers.push(null)}),weightSpecs.push.apply(weightSpecs,weightsGroup.weights)}),weightsManifest.forEach(function(weightsGroup){weightsGroup.paths.forEach(function(path){var weightFileReader=new FileReader;weightFileReader.onload=function(event){var weightData=event.target.result,index=paths.indexOf(path);perFileBuffers[index]=weightData,-1===perFileBuffers.indexOf(null)&&resolve({modelTopology:modelTopology,weightSpecs:weightSpecs,weightData:io_utils_1.concatenateArrayBuffers(perFileBuffers)})},weightFileReader.onerror=function(error){return reject("Failed to weights data from file of path '"+path+"'.")},weightFileReader.readAsArrayBuffer(pathToFile[path])})})}else reject(new Error("weightManifest field is missing from file "+jsonFile.name))}else reject(new Error("modelTopology field is missing from file "+jsonFile.name))},jsonReader.onerror=function(error){return reject("Failed to read model topology and weights manifest JSON from file '"+jsonFile.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},jsonReader.readAsText(jsonFile)})]})})},BrowserFiles.prototype.checkManifestAndWeightFiles=function(manifest,files){for(var basenames=[],fileNames=files.map(function(file){return io_utils_1.basename(file.name)}),pathToFile={},_i=0,manifest_1=manifest;_i<manifest_1.length;_i++){manifest_1[_i].paths.forEach(function(path){var pathBasename=io_utils_1.basename(path);if(-1!==basenames.indexOf(pathBasename))throw new Error("Duplicate file basename found in weights manifest: '"+pathBasename+"'");if(basenames.push(pathBasename),-1===fileNames.indexOf(pathBasename))throw new Error("Weight file with basename '"+pathBasename+"' is not provided.");pathToFile[path]=files[fileNames.indexOf(pathBasename)]})}if(basenames.length!==files.length)throw new Error("Mismatch in the number of files in weights manifest ("+basenames.length+") and the number of weight files provided ("+files.length+").");return pathToFile},BrowserFiles}();function browserDownloads(fileNamePrefix){return void 0===fileNamePrefix&&(fileNamePrefix="model"),new BrowserDownloads(fileNamePrefix)}exports.browserDownloadsRouter=function(url){return environment_1.ENV.getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserDownloads.URL_SCHEME)?browserDownloads(url.slice(BrowserDownloads.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.browserDownloadsRouter),exports.browserDownloads=browserDownloads,exports.browserFiles=function(files){return new BrowserFiles(files)}},{"../environment":144,"./io_utils":153,"./router_registry":158}],150:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util_1=require("../util"),io_utils_1=require("./io_utils"),router_registry_1=require("./router_registry"),weights_loader_1=require("./weights_loader"),HTTPRequest=function(){function HTTPRequest(path,loadOptions){if(this.DEFAULT_METHOD="POST",null==loadOptions&&(loadOptions={}),this.weightPathPrefix=loadOptions.weightPathPrefix,this.onProgress=loadOptions.onProgress,null!=loadOptions.fetchFunc?(util_1.assert("function"==typeof loadOptions.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=loadOptions.fetchFunc):this.fetch=environment_1.ENV.platform.fetch,util_1.assert(null!=path&&0<path.length,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(path)&&util_1.assert(2===path.length,function(){return"URL paths for http must have a length of 2, (actual length is "+path.length+")."}),this.path=path,null!=loadOptions.requestInit&&null!=loadOptions.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=loadOptions.requestInit||{}}return HTTPRequest.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){var init,weightsManifest,modelTopologyAndWeightManifest,response;return __generator(this,function(_a){switch(_a.label){case 0:if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(init=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,weightsManifest=[{paths:["./model.weights.bin"],weights:modelArtifacts.weightSpecs}],modelTopologyAndWeightManifest={modelTopology:modelArtifacts.modelTopology,format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy,weightsManifest:weightsManifest},init.body.append("model.json",new Blob([JSON.stringify(modelTopologyAndWeightManifest)],{type:"application/json"}),"model.json"),null!=modelArtifacts.weightData&&init.body.append("model.weights.bin",new Blob([modelArtifacts.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,init)];case 1:if((response=_a.sent()).ok)return[2,{modelArtifactsInfo:io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts),responses:[response]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+response.status+".")}})})},HTTPRequest.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var modelConfigRequest,modelConfig,message,modelTopology,weightsManifest,weightSpecs,weightData,results;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(modelConfigRequest=_a.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+modelConfigRequest.status+". Please verify this URL points to the model JSON of the model to load.");_a.label=2;case 2:return _a.trys.push([2,4,,5]),[4,modelConfigRequest.json()];case 3:return modelConfig=_a.sent(),[3,5];case 4:throw _a.sent(),message="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?message+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":message+=" Please make sure the server is serving valid JSON for this request.",new Error(message);case 5:if(modelTopology=modelConfig.modelTopology,weightsManifest=modelConfig.weightsManifest,null==modelTopology&&null==weightsManifest)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==weightsManifest?[3,7]:[4,this.loadWeights(weightsManifest)];case 6:results=_a.sent(),weightSpecs=results[0],weightData=results[1],_a.label=7;case 7:return[2,{modelTopology:modelTopology,weightSpecs:weightSpecs,weightData:weightData}]}})})},HTTPRequest.prototype.loadWeights=function(weightsManifest){return __awaiter(this,void 0,void 0,function(){var weightPath,_a,prefix,suffix,pathPrefix,weightSpecs,_i,weightsManifest_1,entry,fetchURLs,buffers;return __generator(this,function(_b){switch(_b.label){case 0:for(weightPath=Array.isArray(this.path)?this.path[1]:this.path,_a=parseUrl(weightPath),prefix=_a[0],suffix=_a[1],pathPrefix=this.weightPathPrefix||prefix,weightSpecs=[],_i=0,weightsManifest_1=weightsManifest;_i<weightsManifest_1.length;_i++)entry=weightsManifest_1[_i],weightSpecs.push.apply(weightSpecs,entry.weights);return fetchURLs=[],weightsManifest.forEach(function(weightsGroup){weightsGroup.paths.forEach(function(path){fetchURLs.push(pathPrefix+path+suffix)})}),[4,weights_loader_1.loadWeightsAsArrayBuffer(fetchURLs,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return buffers=_b.sent(),[2,[weightSpecs,io_utils_1.concatenateArrayBuffers(buffers)]]}})})},HTTPRequest.URL_SCHEME_REGEX=/^https?:\/\//,HTTPRequest}();function parseUrl(url){var lastSlash=url.lastIndexOf("/"),lastSearchParam=url.lastIndexOf("?");return[url.substring(0,lastSlash)+"/",lastSlash<lastSearchParam?url.substring(lastSearchParam):""]}function isHTTPScheme(url){return null!=url.match(HTTPRequest.URL_SCHEME_REGEX)}function http(path,loadOptions){return new HTTPRequest(path,loadOptions)}exports.HTTPRequest=HTTPRequest,exports.parseUrl=parseUrl,exports.isHTTPScheme=isHTTPScheme,exports.httpRouter=function(url,onProgress){if("undefined"==typeof fetch)return null;return(Array.isArray(url)?url.every(function(urlItem){return isHTTPScheme(urlItem)}):isHTTPScheme(url))?http(url,{onProgress:onProgress}):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.httpRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.httpRouter),exports.http=http,exports.browserHTTPRequest=function(path,loadOptions){return http(path,loadOptions)}},{"../environment":144,"../util":241,"./io_utils":153,"./router_registry":158,"./weights_loader":160}],151:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),io_utils_1=require("./io_utils"),model_management_1=require("./model_management"),router_registry_1=require("./router_registry"),DATABASE_NAME="tensorflowjs",MODEL_STORE_NAME="models_store",INFO_STORE_NAME="model_info_store";function getIndexedDBFactory(){if(!environment_1.ENV.getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var theWindow=window,factory=theWindow.indexedDB||theWindow.mozIndexedDB||theWindow.webkitIndexedDB||theWindow.msIndexedDB||theWindow.shimIndexedDB;if(null==factory)throw new Error("The current browser does not appear to support IndexedDB.");return factory}function setUpDatabase(openRequest){var db=openRequest.result;db.createObjectStore(MODEL_STORE_NAME,{keyPath:"modelPath"}),db.createObjectStore(INFO_STORE_NAME,{keyPath:"modelPath"})}exports.deleteDatabase=function(){return __awaiter(this,void 0,void 0,function(){var idbFactory;return __generator(this,function(_a){return idbFactory=getIndexedDBFactory(),[2,new Promise(function(resolve,reject){var deleteRequest=idbFactory.deleteDatabase(DATABASE_NAME);deleteRequest.onsuccess=function(){return resolve()},deleteRequest.onerror=function(error){return reject(error)}})]})})};var BrowserIndexedDB=function(){function BrowserIndexedDB(modelPath){if(this.indexedDB=getIndexedDBFactory(),null==modelPath||!modelPath)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=modelPath}return BrowserIndexedDB.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,modelArtifacts)]})})},BrowserIndexedDB.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.databaseAction(this.modelPath)]})})},BrowserIndexedDB.prototype.databaseAction=function(modelPath,modelArtifacts){var _this=this;return new Promise(function(resolve,reject){var openRequest=_this.indexedDB.open(DATABASE_NAME,1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var db=openRequest.result;if(null==modelArtifacts){var modelTx=db.transaction(MODEL_STORE_NAME,"readonly"),getRequest_1=modelTx.objectStore(MODEL_STORE_NAME).get(_this.modelPath);getRequest_1.onsuccess=function(){if(null==getRequest_1.result)return db.close(),reject(new Error("Cannot find model with path '"+_this.modelPath+"' in IndexedDB."));resolve(getRequest_1.result.modelArtifacts)},getRequest_1.onerror=function(error){return db.close(),reject(getRequest_1.error)},modelTx.oncomplete=function(){return db.close()}}else{var modelTx_1,modelArtifactsInfo_1=io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts),infoTx_1=db.transaction(INFO_STORE_NAME,"readwrite"),infoStore_1=infoTx_1.objectStore(INFO_STORE_NAME),putInfoRequest_1=infoStore_1.put({modelPath:_this.modelPath,modelArtifactsInfo:modelArtifactsInfo_1});putInfoRequest_1.onsuccess=function(){var putModelRequest=(modelTx_1=db.transaction(MODEL_STORE_NAME,"readwrite")).objectStore(MODEL_STORE_NAME).put({modelPath:_this.modelPath,modelArtifacts:modelArtifacts,modelArtifactsInfo:modelArtifactsInfo_1});putModelRequest.onsuccess=function(){return resolve({modelArtifactsInfo:modelArtifactsInfo_1})},putModelRequest.onerror=function(error){var deleteInfoRequest=(infoStore_1=infoTx_1.objectStore(INFO_STORE_NAME)).delete(_this.modelPath);deleteInfoRequest.onsuccess=function(){return db.close(),reject(putModelRequest.error)},deleteInfoRequest.onerror=function(error){return db.close(),reject(putModelRequest.error)}}},putInfoRequest_1.onerror=function(error){return db.close(),reject(putInfoRequest_1.error)},infoTx_1.oncomplete=function(){null==modelTx_1?db.close():modelTx_1.oncomplete=function(){return db.close()}}}},openRequest.onerror=function(error){return reject(openRequest.error)}})},BrowserIndexedDB.URL_SCHEME="indexeddb://",BrowserIndexedDB}();function browserIndexedDB(modelPath){return new BrowserIndexedDB(modelPath)}exports.BrowserIndexedDB=BrowserIndexedDB,exports.indexedDBRouter=function(url){return environment_1.ENV.getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserIndexedDB.URL_SCHEME)?browserIndexedDB(url.slice(BrowserIndexedDB.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.indexedDBRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.indexedDBRouter),exports.browserIndexedDB=browserIndexedDB;var BrowserIndexedDBManager=function(){function BrowserIndexedDBManager(){this.indexedDB=getIndexedDBFactory()}return BrowserIndexedDBManager.prototype.listModels=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return[2,new Promise(function(resolve,reject){var openRequest=_this.indexedDB.open(DATABASE_NAME,1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var db=openRequest.result,tx=db.transaction(INFO_STORE_NAME,"readonly"),getAllInfoRequest=tx.objectStore(INFO_STORE_NAME).getAll();getAllInfoRequest.onsuccess=function(){for(var out={},_i=0,_a=getAllInfoRequest.result;_i<_a.length;_i++){var item=_a[_i];out[item.modelPath]=item.modelArtifactsInfo}resolve(out)},getAllInfoRequest.onerror=function(error){return db.close(),reject(getAllInfoRequest.error)},tx.oncomplete=function(){return db.close()}},openRequest.onerror=function(error){return reject(openRequest.error)}})]})})},BrowserIndexedDBManager.prototype.removeModel=function(path){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return path=function(key){return key.startsWith(BrowserIndexedDB.URL_SCHEME)?key.slice(BrowserIndexedDB.URL_SCHEME.length):key}(path),[2,new Promise(function(resolve,reject){var openRequest=_this.indexedDB.open(DATABASE_NAME,1);openRequest.onupgradeneeded=function(){return setUpDatabase(openRequest)},openRequest.onsuccess=function(){var modelTx,db=openRequest.result,infoTx=db.transaction(INFO_STORE_NAME,"readwrite"),infoStore=infoTx.objectStore(INFO_STORE_NAME),getInfoRequest=infoStore.get(path);getInfoRequest.onsuccess=function(){if(null==getInfoRequest.result)return db.close(),reject(new Error("Cannot find model with path '"+path+"' in IndexedDB."));function deleteModelData_1(){var deleteModelRequest=(modelTx=db.transaction(MODEL_STORE_NAME,"readwrite")).objectStore(MODEL_STORE_NAME).delete(path);deleteModelRequest.onsuccess=function(){return resolve(getInfoRequest.result.modelArtifactsInfo)},deleteModelRequest.onerror=function(error){return reject(getInfoRequest.error)}}var deleteInfoRequest=infoStore.delete(path);deleteInfoRequest.onsuccess=deleteModelData_1,deleteInfoRequest.onerror=function(error){return deleteModelData_1(),db.close(),reject(getInfoRequest.error)}},getInfoRequest.onerror=function(error){return db.close(),reject(getInfoRequest.error)},infoTx.oncomplete=function(){null==modelTx?db.close():modelTx.oncomplete=function(){return db.close()}}},openRequest.onerror=function(error){return reject(openRequest.error)}})]})})},BrowserIndexedDBManager}();if(exports.BrowserIndexedDBManager=BrowserIndexedDBManager,environment_1.ENV.getBool("IS_BROWSER"))try{model_management_1.ModelStoreManagerRegistry.registerManager(BrowserIndexedDB.URL_SCHEME,new BrowserIndexedDBManager)}catch(err){}},{"../environment":144,"./io_utils":153,"./model_management":155,"./router_registry":158}],152:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("./indexed_db"),require("./local_storage");var browser_files_1=require("./browser_files");exports.browserFiles=browser_files_1.browserFiles;var http_1=require("./http");exports.browserHTTPRequest=http_1.browserHTTPRequest,exports.http=http_1.http,exports.isHTTPScheme=http_1.isHTTPScheme;var io_utils_1=require("./io_utils");exports.concatenateArrayBuffers=io_utils_1.concatenateArrayBuffers,exports.decodeWeights=io_utils_1.decodeWeights,exports.encodeWeights=io_utils_1.encodeWeights,exports.getModelArtifactsInfoForJSON=io_utils_1.getModelArtifactsInfoForJSON;var passthrough_1=require("./passthrough");exports.fromMemory=passthrough_1.fromMemory,exports.withSaveHandler=passthrough_1.withSaveHandler;var router_registry_1=require("./router_registry");exports.getLoadHandlers=router_registry_1.getLoadHandlers,exports.getSaveHandlers=router_registry_1.getSaveHandlers,exports.registerLoadRouter=router_registry_1.registerLoadRouter,exports.registerSaveRouter=router_registry_1.registerSaveRouter;var weights_loader_1=require("./weights_loader");exports.loadWeights=weights_loader_1.loadWeights,exports.weightsLoaderFactory=weights_loader_1.weightsLoaderFactory;var model_management_1=require("./model_management");exports.copyModel=model_management_1.copyModel,exports.listModels=model_management_1.listModels,exports.moveModel=model_management_1.moveModel,exports.removeModel=model_management_1.removeModel},{"./browser_files":149,"./http":150,"./indexed_db":151,"./io_utils":153,"./local_storage":154,"./model_management":155,"./passthrough":156,"./router_registry":158,"./weights_loader":160}],153:[function(require,module,exports){(function(Buffer){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_ops_1=require("../ops/tensor_ops"),util_1=require("../util"),types_1=require("./types"),NUM_BYTES_STRING_LENGTH=4;function concatenateTypedArrays(xs){if(null===xs)throw new Error("Invalid input value: "+JSON.stringify(xs));var totalByteLength=0,normalizedXs=[];xs.forEach(function(x){if(totalByteLength+=x.byteLength,normalizedXs.push(x.byteLength===x.buffer.byteLength?x:new x.constructor(x)),!(x instanceof Float32Array||x instanceof Int32Array||x instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+x.constructor.name)});var y=new Uint8Array(totalByteLength),offset=0;return normalizedXs.forEach(function(x){y.set(new Uint8Array(x.buffer),offset),offset+=x.byteLength}),y.buffer}exports.encodeWeights=function(tensors,group){return __awaiter(this,void 0,void 0,function(){var specs,dataPromises,names,_loop_1,i,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:for(specs=[],dataPromises=[],names=Array.isArray(tensors)?tensors.map(function(tensor){return tensor.name}):Object.keys(tensors),_loop_1=function(i){var name_1=names[i],t=Array.isArray(tensors)?tensors[i].tensor:tensors[name_1];if("float32"!==t.dtype&&"int32"!==t.dtype&&"bool"!==t.dtype&&"string"!==t.dtype)throw new Error("Unsupported dtype in weight '"+name_1+"': "+t.dtype);var spec={name:name_1,shape:t.shape,dtype:t.dtype};if("string"===t.dtype){var utf8bytes=new Promise(function(resolve){return __awaiter(_this,void 0,void 0,function(){var vals,totalNumBytes,bytes,offset,i_1,val,bytesOfLength;return __generator(this,function(_a){switch(_a.label){case 0:return[4,t.bytes()];case 1:for(vals=_a.sent(),totalNumBytes=vals.reduce(function(p,c){return p+c.length},0)+NUM_BYTES_STRING_LENGTH*vals.length,bytes=new Uint8Array(totalNumBytes),i_1=offset=0;i_1<vals.length;i_1++)val=vals[i_1],bytesOfLength=new Uint8Array(new Uint32Array([val.length]).buffer),bytes.set(bytesOfLength,offset),offset+=NUM_BYTES_STRING_LENGTH,bytes.set(val,offset),offset+=val.length;return resolve(bytes),[2]}})})});dataPromises.push(utf8bytes)}else dataPromises.push(t.data());null!=group&&(spec.group=group),specs.push(spec)},i=0;i<names.length;++i)_loop_1(i);return[4,Promise.all(dataPromises)];case 1:return[2,{data:concatenateTypedArrays(_a.sent()),specs:specs}]}})})},exports.decodeWeights=function(buffer,specs){for(var out={},offset=0,_loop_2=function(spec){var name_2=spec.name,dtype=spec.dtype,shape=spec.shape,size=util_1.sizeFromShape(shape),values=void 0;if("quantization"in spec){var quantization_1=spec.quantization;if("uint8"!==quantization_1.dtype&&"uint16"!==quantization_1.dtype)throw new Error("Weight "+spec.name+" has unknown quantization dtype "+quantization_1.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var quantizationSizeFactor=types_1.DTYPE_VALUE_SIZE_MAP[quantization_1.dtype],byteBuffer=buffer.slice(offset,offset+size*quantizationSizeFactor),quantizedArray="uint8"===quantization_1.dtype?new Uint8Array(byteBuffer):new Uint16Array(byteBuffer);if("float32"===dtype)values=Float32Array.from(quantizedArray,function(v){return v*quantization_1.scale+quantization_1.min});else{if("int32"!==dtype)throw new Error("Unsupported dtype in weight '"+name_2+"': "+dtype);values=Int32Array.from(quantizedArray,function(v){return Math.round(v*quantization_1.scale+quantization_1.min)})}offset+=size*quantizationSizeFactor}else if("string"===dtype){var size_1=util_1.sizeFromShape(spec.shape);values=[];for(var i=0;i<size_1;i++){var byteLength=new Uint32Array(buffer.slice(offset,offset+NUM_BYTES_STRING_LENGTH))[0];offset+=NUM_BYTES_STRING_LENGTH;var bytes=new Uint8Array(buffer.slice(offset,offset+byteLength));values.push(bytes),offset+=byteLength}}else{var dtypeFactor=types_1.DTYPE_VALUE_SIZE_MAP[dtype];byteBuffer=buffer.slice(offset,offset+size*dtypeFactor);if("float32"===dtype)values=new Float32Array(byteBuffer);else if("int32"===dtype)values=new Int32Array(byteBuffer);else{if("bool"!==dtype)throw new Error("Unsupported dtype in weight '"+name_2+"': "+dtype);values=new Uint8Array(byteBuffer)}offset+=size*dtypeFactor}out[name_2]=tensor_ops_1.tensor(values,shape,dtype)},_i=0,specs_1=specs;_i<specs_1.length;_i++){_loop_2(specs_1[_i])}return out},exports.concatenateTypedArrays=concatenateTypedArrays;var useNodeBuffer=void 0!==Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function stringByteLength(str){return useNodeBuffer?Buffer.byteLength(str):new Blob([str]).size}exports.stringByteLength=stringByteLength,exports.arrayBufferToBase64String=function(buffer){return useNodeBuffer?Buffer.from(buffer).toString("base64"):btoa(String.fromCharCode.apply(null,new Uint8Array(buffer)))},exports.base64StringToArrayBuffer=function(str){if(useNodeBuffer){var buf=Buffer.from(str,"base64");return buf.buffer.slice(buf.byteOffset,buf.byteOffset+buf.byteLength)}for(var s=atob(str),buffer=new Uint8Array(s.length),i=0;i<s.length;++i)buffer.set([s.charCodeAt(i)],i);return buffer.buffer},exports.concatenateArrayBuffers=function(buffers){var totalByteLength=0;buffers.forEach(function(buffer){totalByteLength+=buffer.byteLength});var temp=new Uint8Array(totalByteLength),offset=0;return buffers.forEach(function(buffer){temp.set(new Uint8Array(buffer),offset),offset+=buffer.byteLength}),temp.buffer},exports.basename=function(path){for(path=path.trim();path.endsWith("/");)path=path.slice(0,path.length-1);var items=path.split("/");return items[items.length-1]},exports.getModelArtifactsInfoForJSON=function(modelArtifacts){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==modelArtifacts.modelTopology?0:stringByteLength(JSON.stringify(modelArtifacts.modelTopology)),weightSpecsBytes:null==modelArtifacts.weightSpecs?0:stringByteLength(JSON.stringify(modelArtifacts.weightSpecs)),weightDataBytes:null==modelArtifacts.weightData?0:modelArtifacts.weightData.byteLength}}}).call(this,require("buffer").Buffer)},{"../ops/tensor_ops":216,"../util":241,"./types":159,buffer:334}],154:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util_1=require("../util"),io_utils_1=require("./io_utils"),model_management_1=require("./model_management"),router_registry_1=require("./router_registry"),PATH_SEPARATOR="/",PATH_PREFIX="tensorflowjs_models",INFO_SUFFIX="info",MODEL_TOPOLOGY_SUFFIX="model_topology",WEIGHT_SPECS_SUFFIX="weight_specs",WEIGHT_DATA_SUFFIX="weight_data",MODEL_METADATA_SUFFIX="model_metadata";function getModelKeys(path){return{info:[PATH_PREFIX,path,INFO_SUFFIX].join(PATH_SEPARATOR),topology:[PATH_PREFIX,path,MODEL_TOPOLOGY_SUFFIX].join(PATH_SEPARATOR),weightSpecs:[PATH_PREFIX,path,WEIGHT_SPECS_SUFFIX].join(PATH_SEPARATOR),weightData:[PATH_PREFIX,path,WEIGHT_DATA_SUFFIX].join(PATH_SEPARATOR),modelMetadata:[PATH_PREFIX,path,MODEL_METADATA_SUFFIX].join(PATH_SEPARATOR)}}function getModelPathFromKey(key){var items=key.split(PATH_SEPARATOR);if(items.length<3)throw new Error("Invalid key format: "+key);return items.slice(1,items.length-1).join(PATH_SEPARATOR)}exports.purgeLocalStorageArtifacts=function(){if(!environment_1.ENV.getBool("IS_BROWSER")||void 0===window.localStorage)throw new Error("purgeLocalStorageModels() cannot proceed because local storage is unavailable in the current environment.");for(var LS=window.localStorage,purgedModelPaths=[],i=0;i<LS.length;++i){var key=LS.key(i),prefix=PATH_PREFIX+PATH_SEPARATOR;if(key.startsWith(prefix)&&key.length>prefix.length){LS.removeItem(key);var modelName=getModelPathFromKey(key);-1===purgedModelPaths.indexOf(modelName)&&purgedModelPaths.push(modelName)}}return purgedModelPaths};var BrowserLocalStorage=function(){function BrowserLocalStorage(modelPath){if(!environment_1.ENV.getBool("IS_BROWSER")||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==modelPath||!modelPath)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=modelPath,this.keys=getModelKeys(this.modelPath)}return BrowserLocalStorage.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){var topology,weightSpecs,modelArtifactsInfo;return __generator(this,function(_a){if(modelArtifacts.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");topology=JSON.stringify(modelArtifacts.modelTopology),weightSpecs=JSON.stringify(modelArtifacts.weightSpecs),modelArtifactsInfo=io_utils_1.getModelArtifactsInfoForJSON(modelArtifacts);try{return this.LS.setItem(this.keys.info,JSON.stringify(modelArtifactsInfo)),this.LS.setItem(this.keys.topology,topology),this.LS.setItem(this.keys.weightSpecs,weightSpecs),this.LS.setItem(this.keys.weightData,io_utils_1.arrayBufferToBase64String(modelArtifacts.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:modelArtifacts.format,generatedBy:modelArtifacts.generatedBy,convertedBy:modelArtifacts.convertedBy})),[2,{modelArtifactsInfo:modelArtifactsInfo}]}catch(err){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+modelArtifactsInfo.modelTopologyBytes+", weightSpecsBytes="+modelArtifactsInfo.weightSpecsBytes+", weightDataBytes="+modelArtifactsInfo.weightDataBytes+".")}return[2]})})},BrowserLocalStorage.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var info,out,topology,weightSpecs,metadataString,metadata,weightDataBase64;return __generator(this,function(_a){if(null==(info=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==info.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(out={},null==(topology=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(out.modelTopology=topology,null==(weightSpecs=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(out.weightSpecs=weightSpecs,null!=(metadataString=this.LS.getItem(this.keys.modelMetadata))&&(metadata=JSON.parse(metadataString),out.format=metadata.format,out.generatedBy=metadata.generatedBy,out.convertedBy=metadata.convertedBy),null==(weightDataBase64=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return out.weightData=io_utils_1.base64StringToArrayBuffer(weightDataBase64),[2,out]})})},BrowserLocalStorage.URL_SCHEME="localstorage://",BrowserLocalStorage}();function browserLocalStorage(modelPath){return new BrowserLocalStorage(modelPath)}exports.BrowserLocalStorage=BrowserLocalStorage,exports.localStorageRouter=function(url){return environment_1.ENV.getBool("IS_BROWSER")&&!Array.isArray(url)&&url.startsWith(BrowserLocalStorage.URL_SCHEME)?browserLocalStorage(url.slice(BrowserLocalStorage.URL_SCHEME.length)):null},router_registry_1.IORouterRegistry.registerSaveRouter(exports.localStorageRouter),router_registry_1.IORouterRegistry.registerLoadRouter(exports.localStorageRouter),exports.browserLocalStorage=browserLocalStorage;var BrowserLocalStorageManager=function(){function BrowserLocalStorageManager(){util_1.assert(environment_1.ENV.getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),util_1.assert(void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return BrowserLocalStorageManager.prototype.listModels=function(){return __awaiter(this,void 0,void 0,function(){var out,prefix,suffix,i,key,modelPath;return __generator(this,function(_a){for(out={},prefix=PATH_PREFIX+PATH_SEPARATOR,suffix=PATH_SEPARATOR+INFO_SUFFIX,i=0;i<this.LS.length;++i)(key=this.LS.key(i)).startsWith(prefix)&&key.endsWith(suffix)&&(modelPath=getModelPathFromKey(key),out[modelPath]=JSON.parse(this.LS.getItem(key)));return[2,out]})})},BrowserLocalStorageManager.prototype.removeModel=function(path){return __awaiter(this,void 0,void 0,function(){var keys,info;return __generator(this,function(_a){if(path=function(key){return key.startsWith(BrowserLocalStorage.URL_SCHEME)?key.slice(BrowserLocalStorage.URL_SCHEME.length):key}(path),keys=getModelKeys(path),null==this.LS.getItem(keys.info))throw new Error("Cannot find model at path '"+path+"'");return info=JSON.parse(this.LS.getItem(keys.info)),this.LS.removeItem(keys.info),this.LS.removeItem(keys.topology),this.LS.removeItem(keys.weightSpecs),this.LS.removeItem(keys.weightData),[2,info]})})},BrowserLocalStorageManager}();if(exports.BrowserLocalStorageManager=BrowserLocalStorageManager,environment_1.ENV.getBool("IS_BROWSER"))try{model_management_1.ModelStoreManagerRegistry.registerManager(BrowserLocalStorage.URL_SCHEME,new BrowserLocalStorageManager)}catch(err){}},{"../environment":144,"../util":241,"./io_utils":153,"./model_management":155,"./router_registry":158}],155:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),router_registry_1=require("./router_registry"),URL_SCHEME_SUFFIX="://",ModelStoreManagerRegistry=function(){function ModelStoreManagerRegistry(){this.managers={}}return ModelStoreManagerRegistry.getInstance=function(){return null==ModelStoreManagerRegistry.instance&&(ModelStoreManagerRegistry.instance=new ModelStoreManagerRegistry),ModelStoreManagerRegistry.instance},ModelStoreManagerRegistry.registerManager=function(scheme,manager){util_1.assert(null!=scheme,function(){return"scheme must not be undefined or null."}),scheme.endsWith(URL_SCHEME_SUFFIX)&&(scheme=scheme.slice(0,scheme.indexOf(URL_SCHEME_SUFFIX))),util_1.assert(0<scheme.length,function(){return"scheme must not be an empty string."});var registry=ModelStoreManagerRegistry.getInstance();util_1.assert(null==registry.managers[scheme],function(){return"A model store manager is already registered for scheme '"+scheme+"'."}),registry.managers[scheme]=manager},ModelStoreManagerRegistry.getManager=function(scheme){var manager=this.getInstance().managers[scheme];if(null==manager)throw new Error("Cannot find model manager for scheme '"+scheme+"'");return manager},ModelStoreManagerRegistry.getSchemes=function(){return Object.keys(this.getInstance().managers)},ModelStoreManagerRegistry}();function parseURL(url){if(-1===url.indexOf(URL_SCHEME_SUFFIX))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+ModelStoreManagerRegistry.getSchemes().join(","));return{scheme:url.split(URL_SCHEME_SUFFIX)[0],path:url.split(URL_SCHEME_SUFFIX)[1]}}function cloneModelInternal(sourceURL,destURL,deleteSource){return void 0===deleteSource&&(deleteSource=!1),__awaiter(this,void 0,void 0,function(){var loadHandlers,loadHandler,saveHandlers,saveHandler,sourceScheme,sourcePath,sameMedium,modelArtifacts,saveResult;return __generator(this,function(_a){switch(_a.label){case 0:return util_1.assert(sourceURL!==destURL,function(){return"Old path and new path are the same: '"+sourceURL+"'"}),loadHandlers=router_registry_1.IORouterRegistry.getLoadHandlers(sourceURL),util_1.assert(0<loadHandlers.length,function(){return"Copying failed because no load handler is found for source URL "+sourceURL+"."}),util_1.assert(loadHandlers.length<2,function(){return"Copying failed because more than one ("+loadHandlers.length+") load handlers for source URL "+sourceURL+"."}),loadHandler=loadHandlers[0],saveHandlers=router_registry_1.IORouterRegistry.getSaveHandlers(destURL),util_1.assert(0<saveHandlers.length,function(){return"Copying failed because no save handler is found for destination URL "+destURL+"."}),util_1.assert(saveHandlers.length<2,function(){return"Copying failed because more than one ("+loadHandlers.length+") save handlers for destination URL "+destURL+"."}),saveHandler=saveHandlers[0],sourceScheme=parseURL(sourceURL).scheme,sourcePath=parseURL(sourceURL).path,sameMedium=sourceScheme===parseURL(sourceURL).scheme,[4,loadHandler.load()];case 1:return modelArtifacts=_a.sent(),deleteSource&&sameMedium?[4,ModelStoreManagerRegistry.getManager(sourceScheme).removeModel(sourcePath)]:[3,3];case 2:_a.sent(),_a.label=3;case 3:return[4,saveHandler.save(modelArtifacts)];case 4:return saveResult=_a.sent(),!deleteSource||sameMedium?[3,6]:[4,ModelStoreManagerRegistry.getManager(sourceScheme).removeModel(sourcePath)];case 5:_a.sent(),_a.label=6;case 6:return[2,saveResult.modelArtifactsInfo]}})})}exports.ModelStoreManagerRegistry=ModelStoreManagerRegistry,exports.listModels=function(){return __awaiter(this,void 0,void 0,function(){var schemes,out,_i,schemes_1,scheme,schemeOut,path;return __generator(this,function(_a){switch(_a.label){case 0:schemes=ModelStoreManagerRegistry.getSchemes(),out={},_i=0,schemes_1=schemes,_a.label=1;case 1:return _i<schemes_1.length?(scheme=schemes_1[_i],[4,ModelStoreManagerRegistry.getManager(scheme).listModels()]):[3,4];case 2:for(path in schemeOut=_a.sent())out[scheme+URL_SCHEME_SUFFIX+path]=schemeOut[path];_a.label=3;case 3:return _i++,[3,1];case 4:return[2,out]}})})},exports.removeModel=function(url){return __awaiter(this,void 0,void 0,function(){var schemeAndPath;return __generator(this,function(_a){return schemeAndPath=parseURL(url),[2,ModelStoreManagerRegistry.getManager(schemeAndPath.scheme).removeModel(schemeAndPath.path)]})})},exports.copyModel=function(sourceURL,destURL){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,cloneModelInternal(sourceURL,destURL,!1)]})})},exports.moveModel=function(sourceURL,destURL){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,cloneModelInternal(sourceURL,destURL,!0)]})})}},{"../util":241,"./router_registry":158}],156:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PassthroughLoader=function(){function PassthroughLoader(modelArtifacts){this.modelArtifacts=modelArtifacts}return PassthroughLoader.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.modelArtifacts]})})},PassthroughLoader}(),PassthroughSaver=function(){function PassthroughSaver(saveHandler){this.saveHandler=saveHandler}return PassthroughSaver.prototype.save=function(modelArtifacts){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.saveHandler(modelArtifacts)]})})},PassthroughSaver}();exports.fromMemory=function(modelArtifacts,weightSpecs,weightData,trainingConfig){return 1!==arguments.length?(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new PassthroughLoader({modelTopology:modelArtifacts,weightSpecs:weightSpecs,weightData:weightData,trainingConfig:trainingConfig})):null!=modelArtifacts.modelTopology||null!=modelArtifacts.weightSpecs?new PassthroughLoader(modelArtifacts):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new PassthroughLoader({modelTopology:modelArtifacts}))},exports.withSaveHandler=function(saveHandler){return new PassthroughSaver(saveHandler)}},{}],157:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.monitorPromisesProgress=function(promises,onProgress,startFraction,endFraction){!function(promises){util_1.assert(null!=promises&&Array.isArray(promises)&&0<promises.length,function(){return"promises must be a none empty array"})}(promises),function(startFraction,endFraction){util_1.assert(0<=startFraction&&startFraction<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+startFraction}),util_1.assert(0<=endFraction&&endFraction<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+endFraction}),util_1.assert(startFraction<=endFraction,function(){return"startFraction must be no more than endFraction, but got startFraction "+startFraction+" and endFraction "+endFraction})}(startFraction=null==startFraction?0:startFraction,endFraction=null==endFraction?1:endFraction);var resolvedPromise=0;return Promise.all(promises.map(function(promise){return promise.then(function(value){var fraction=startFraction+ ++resolvedPromise/promises.length*(endFraction-startFraction);return onProgress(fraction),value}),promise}))}},{"../util":241}],158:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var IORouterRegistry=function(){function IORouterRegistry(){this.saveRouters=[],this.loadRouters=[]}return IORouterRegistry.getInstance=function(){return null==IORouterRegistry.instance&&(IORouterRegistry.instance=new IORouterRegistry),IORouterRegistry.instance},IORouterRegistry.registerSaveRouter=function(saveRouter){IORouterRegistry.getInstance().saveRouters.push(saveRouter)},IORouterRegistry.registerLoadRouter=function(loadRouter){IORouterRegistry.getInstance().loadRouters.push(loadRouter)},IORouterRegistry.getSaveHandlers=function(url){return IORouterRegistry.getHandlers(url,"save")},IORouterRegistry.getLoadHandlers=function(url,onProgress){return IORouterRegistry.getHandlers(url,"load",onProgress)},IORouterRegistry.getHandlers=function(url,handlerType,onProgress){var validHandlers=[];return("load"===handlerType?IORouterRegistry.getInstance().loadRouters:IORouterRegistry.getInstance().saveRouters).forEach(function(router){var handler=router(url,onProgress);null!==handler&&validHandlers.push(handler)}),validHandlers},IORouterRegistry}();exports.IORouterRegistry=IORouterRegistry,exports.registerSaveRouter=function(loudRouter){return IORouterRegistry.registerSaveRouter(loudRouter)},exports.registerLoadRouter=function(loudRouter){return IORouterRegistry.registerLoadRouter(loudRouter)},exports.getSaveHandlers=function(url){return IORouterRegistry.getSaveHandlers(url)},exports.getLoadHandlers=function(url,onProgress){return IORouterRegistry.getLoadHandlers(url,onProgress)}},{}],159:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DTYPE_VALUE_SIZE_MAP={float32:4,int32:4,uint16:2,uint8:1,bool:1}},{}],160:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util=require("../util"),io_utils_1=require("./io_utils"),progress_1=require("./progress"),types_1=require("./types");function loadWeightsAsArrayBuffer(fetchURLs,loadOptions){return __awaiter(this,void 0,void 0,function(){var fetchFunc,requests,fetchStartFraction,fetchEndFraction,_a,bufferPromises,bufferStartFraction,bufferEndFraction,_b;return __generator(this,function(_c){switch(_c.label){case 0:return null==loadOptions&&(loadOptions={}),fetchFunc=null==loadOptions.fetchFunc?environment_1.ENV.platform.fetch:loadOptions.fetchFunc,requests=fetchURLs.map(function(fetchURL){return fetchFunc(fetchURL,loadOptions.requestInit,{isBinary:!0})}),fetchStartFraction=0,fetchEndFraction=.5,null!=loadOptions.onProgress?[3,2]:[4,Promise.all(requests)];case 1:return _a=_c.sent(),[3,4];case 2:return[4,progress_1.monitorPromisesProgress(requests,loadOptions.onProgress,fetchStartFraction,fetchEndFraction)];case 3:_a=_c.sent(),_c.label=4;case 4:return bufferPromises=_a.map(function(response){return response.arrayBuffer()}),bufferStartFraction=.5,bufferEndFraction=1,null!=loadOptions.onProgress?[3,6]:[4,Promise.all(bufferPromises)];case 5:return _b=_c.sent(),[3,8];case 6:return[4,progress_1.monitorPromisesProgress(bufferPromises,loadOptions.onProgress,bufferStartFraction,bufferEndFraction)];case 7:_b=_c.sent(),_c.label=8;case 8:return[2,_b]}})})}function weightsLoaderFactory(fetchWeightsFunction){var _this=this;return function(manifest,filePathPrefix,weightNames){return void 0===filePathPrefix&&(filePathPrefix=""),__awaiter(_this,void 0,void 0,function(){var groupIndicesToFetchMap,groupWeightsToFetch,weightsFound,allManifestWeightNames,weightsNotFound,groupIndicesToFetch,fetchUrls,buffers,weightsTensorMap,bufferIndexOffset;return __generator(this,function(_a){switch(_a.label){case 0:if(groupIndicesToFetchMap=manifest.map(function(){return!1}),groupWeightsToFetch={},weightsFound=null!=weightNames?weightNames.map(function(){return!1}):[],allManifestWeightNames=[],manifest.forEach(function(manifestGroupConfig,groupIndex){var groupOffset=0;manifestGroupConfig.weights.forEach(function(weightsEntry){function enqueueWeightsForFetchingFn(){groupIndicesToFetchMap[groupIndex]=!0,null==groupWeightsToFetch[groupIndex]&&(groupWeightsToFetch[groupIndex]=[]),groupWeightsToFetch[groupIndex].push({manifestEntry:weightsEntry,groupOffset:groupOffset,sizeBytes:weightsBytes})}var rawDtype="quantization"in weightsEntry?weightsEntry.quantization.dtype:weightsEntry.dtype,weightsBytes=types_1.DTYPE_VALUE_SIZE_MAP[rawDtype]*util.sizeFromShape(weightsEntry.shape);null!=weightNames?weightNames.forEach(function(weightName,weightIndex){weightName===weightsEntry.name&&(enqueueWeightsForFetchingFn(),weightsFound[weightIndex]=!0)}):enqueueWeightsForFetchingFn(),allManifestWeightNames.push(weightsEntry.name),groupOffset+=weightsBytes})}),!weightsFound.every(function(found){return found}))throw weightsNotFound=weightNames.filter(function(_,i){return!weightsFound[i]}),new Error("Could not find weights in manifest with names: "+weightsNotFound.join(", ")+". \nManifest JSON has weights with names: "+allManifestWeightNames.join(", ")+".");return groupIndicesToFetch=groupIndicesToFetchMap.reduce(function(accumulator,shouldFetch,i){return shouldFetch&&accumulator.push(i),accumulator},[]),fetchUrls=[],groupIndicesToFetch.forEach(function(i){manifest[i].paths.forEach(function(filepath){var fetchUrl=filePathPrefix+(filePathPrefix.endsWith("/")?"":"/")+filepath;fetchUrls.push(fetchUrl)})}),[4,fetchWeightsFunction(fetchUrls)];case 1:return buffers=_a.sent(),weightsTensorMap={},bufferIndexOffset=0,groupIndicesToFetch.forEach(function(i){for(var numBuffers=manifest[i].paths.length,groupBytes=0,i_1=0;i_1<numBuffers;i_1++)groupBytes+=buffers[bufferIndexOffset+i_1].byteLength;for(var groupBuffer=new ArrayBuffer(groupBytes),groupByteBuffer=new Uint8Array(groupBuffer),groupBufferOffset=0,i_2=0;i_2<numBuffers;i_2++){var buffer=new Uint8Array(buffers[bufferIndexOffset+i_2]);groupByteBuffer.set(buffer,groupBufferOffset),groupBufferOffset+=buffer.byteLength}groupWeightsToFetch[i].forEach(function(weightsEntry){var byteBuffer=groupBuffer.slice(weightsEntry.groupOffset,weightsEntry.groupOffset+weightsEntry.sizeBytes),nameToTensorMap=io_utils_1.decodeWeights(byteBuffer,[weightsEntry.manifestEntry]);for(var name_1 in nameToTensorMap)weightsTensorMap[name_1]=nameToTensorMap[name_1]}),bufferIndexOffset+=numBuffers}),[2,weightsTensorMap]}})})}}exports.loadWeightsAsArrayBuffer=loadWeightsAsArrayBuffer,exports.loadWeights=function(manifest,filePathPrefix,weightNames,requestInit){return void 0===filePathPrefix&&(filePathPrefix=""),__awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,weightsLoaderFactory(function(fetchUrls){return loadWeightsAsArrayBuffer(fetchUrls,{requestInit:requestInit})})(manifest,filePathPrefix,weightNames)]})})},exports.weightsLoaderFactory=weightsLoaderFactory},{"../environment":144,"../util":241,"./io_utils":153,"./progress":157,"./types":159}],161:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment");exports.warn=function(){for(var msg=[],_i=0;_i<arguments.length;_i++)msg[_i]=arguments[_i];environment_1.ENV.getBool("IS_TEST")||console.warn.apply(console,msg)},exports.log=function(){for(var msg=[],_i=0;_i<arguments.length;_i++)msg[_i]=arguments[_i];environment_1.ENV.getBool("IS_TEST")||console.log.apply(console,msg)}},{"./environment":144}],162:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var confusion_matrix_1=require("./ops/confusion_matrix");exports.confusionMatrix=confusion_matrix_1.confusionMatrix},{"./ops/confusion_matrix":175}],163:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util_1=require("./axis_util"),concat_split_1=require("./concat_split"),operation_1=require("./operation"),rand_1=require("./rand"),tensor_ops_1=require("./tensor_ops");function buffer(shape,dtype,values){return void 0===dtype&&(dtype="float32"),dtype=dtype||"float32",util.assertNonNegativeIntegerDimensions(shape),new tensor_1.TensorBuffer(shape,dtype,values)}exports.buffer=buffer,exports.print=function(x,verbose){void 0===verbose&&(verbose=!1),console.log(x.toString(verbose))},exports.batchToSpaceND=operation_1.op({batchToSpaceND_:function(x,blockShape,crops){var $x=tensor_util_env_1.convertToTensor(x,"x","batchToSpaceND"),prod=blockShape.reduce(function(a,b){return a*b});return util.assert($x.rank>=1+blockShape.length,function(){return"input rank is "+$x.rank+" but should be > than blockShape.length "+blockShape.length}),util.assert(crops.length===blockShape.length,function(){return"crops.length is "+crops.length+" but should be equal to blockShape.length  "+blockShape.length}),util.assert($x.shape[0]%prod==0,function(){return"input tensor batch is "+$x.shape[0]+" but is not divisible by the product of the elements of blockShape "+blockShape.join(" * ")+" === "+prod}),engine_1.ENGINE.runKernel(function(backend){return backend.batchToSpaceND($x,blockShape,crops)},{$x:$x},function(dy){return{$x:function(){return dy.spaceToBatchND(blockShape,crops)}}})}}),exports.cast=operation_1.op({cast_:function(x,dtype){var $x=tensor_util_env_1.convertToTensor(x,"x","cast");if(!util.isValidDtype(dtype))throw new Error("Failed to cast to unknown dtype "+dtype);if("string"===dtype&&"string"!==$x.dtype||"string"!==dtype&&"string"===$x.dtype)throw new Error("Only strings can be casted to strings");return engine_1.ENGINE.runKernel(function(backend){return backend.cast($x,dtype)},{$x:$x},function(dy){return{$x:function(){return dy.clone()}}})}}),exports.clone=operation_1.op({clone_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","clone",null);return engine_1.ENGINE.runKernel(function(backend){return tensor_1.Tensor.make($x.shape,{dataId:$x.dataId},$x.dtype)},{$x:$x},function(dy){return{$x:function(){return dy.toFloat()}}})}}),exports.cumsum=operation_1.op({cumsum_:function(x,axis,exclusive,reverse){void 0===axis&&(axis=0),void 0===exclusive&&(exclusive=!1),void 0===reverse&&(reverse=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","cumsum");axis|=0;var permutation=axis_util_1.getAxesPermutation([axis],$x.rank),permutedX=$x;null!=permutation&&(permutedX=$x.transpose(permutation));var permutedAxis=axis_util_1.getInnerMostAxes(1,$x.rank)[0],value=engine_1.ENGINE.runKernel(function(backend){return backend.cumsum(permutedX,permutedAxis,exclusive,reverse)},{permutedX:permutedX},function(dy){return{permutedX:function(){return dy.cumsum(axis,exclusive,!reverse)}}});return null!=permutation&&(value=value.transpose(permutation)),value}}),exports.depthToSpace=operation_1.op({depthToSpace_:function(x,blockSize,dataFormat){void 0===dataFormat&&(dataFormat="NHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","depthToSpace"),inputHeight="NHWC"===dataFormat?$x.shape[1]:$x.shape[2],inputWidth="NHWC"===dataFormat?$x.shape[2]:$x.shape[3],inputDepth="NHWC"===dataFormat?$x.shape[3]:$x.shape[1];return util.assert(0<=inputHeight*blockSize,function(){return"Negative dimension size caused by overflow when multiplying\n      "+inputHeight+" and "+blockSize+"  for depthToSpace with input shape\n      "+$x.shape}),util.assert(0<=inputWidth*blockSize,function(){return"Negative dimension size caused by overflow when multiplying\n      "+inputWidth+" and "+blockSize+" for depthToSpace with input shape\n          "+$x.shape}),util.assert(inputDepth%(blockSize*blockSize)==0,function(){return"Dimension size must be evenly divisible by "+blockSize*blockSize+" but is "+inputDepth+" for depthToSpace with input shape "+$x.shape}),engine_1.ENGINE.runKernel(function(backend){return backend.depthToSpace($x,blockSize,dataFormat)},{$x:$x})}}),exports.expandDims=operation_1.op({expandDims_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","expandDims",null);util.assert(axis<=$x.rank,function(){return"Axis must be <= rank of the tensor"});var newShape=$x.shape.slice();return axis<0&&(util.assert(-($x.rank+1)<=axis,function(){return"Axis must be in the interval ["+-($x.rank+1)+", "+$x.rank+"]"}),axis=$x.rank+axis+1),newShape.splice(axis,0,1),exports.reshape($x,newShape)}}),exports.eye=operation_1.op({eye_:function(numRows,numColumns,batchShape,dtype){void 0===dtype&&(dtype="float32"),null==numColumns&&(numColumns=numRows);for(var buff=buffer([numRows,numColumns],dtype),n=numRows<=numColumns?numRows:numColumns,i=0;i<n;++i)buff.set(1,i,i);var out=buff.toTensor().as2D(numRows,numColumns);if(null==batchShape)return out;if(1===batchShape.length)return exports.tile(exports.expandDims(out,0),[batchShape[0],1,1]);if(2===batchShape.length)return exports.tile(exports.expandDims(exports.expandDims(out,0),0),[batchShape[0],batchShape[1],1,1]);if(3===batchShape.length)return exports.tile(exports.expandDims(exports.expandDims(exports.expandDims(out,0),0),0),[batchShape[0],batchShape[1],batchShape[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+batchShape.length+"D.")}}),exports.multinomial=operation_1.op({multinomial_:function(logits,numSamples,seed,normalized){void 0===normalized&&(normalized=!1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","multinomial"),numOutcomes=$logits.size,origRank=$logits.rank;if(numOutcomes<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+numOutcomes+".");if(2<origRank)throw new Error("Rank of probabilities must be 1 or 2, but is "+origRank);seed=seed||Math.random();var logits2D=1===origRank?$logits.as2D(1,-1):$logits,res=engine_1.ENGINE.runKernel(function(backend){return backend.multinomial(logits2D,normalized,numSamples,seed)},{logits2D:logits2D});return 1===origRank?res.as1D():res}}),exports.oneHot=operation_1.op({oneHot_:function(indices,depth,onValue,offValue){if(void 0===onValue&&(onValue=1),void 0===offValue&&(offValue=0),depth<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+depth);var $indices=tensor_util_env_1.convertToTensor(indices,"indices","oneHot","int32"),outShape=$indices.shape.concat([depth]);return $indices=$indices.flatten(),engine_1.ENGINE.runKernel(function(backend){return backend.oneHot($indices,depth,onValue,offValue)},{$indices:$indices},function(dy){return{$indices:function(){return tensor_ops_1.zeros($indices.shape,"float32")}}}).reshape(outShape)}}),exports.pad=operation_1.op({pad_:function(x,paddings,constantValue){void 0===constantValue&&(constantValue=0);var $x=tensor_util_env_1.convertToTensor(x,"x","pad");if(0===$x.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");var begin=paddings.map(function(p){return p[0]});return engine_1.ENGINE.runKernel(function(backend){return backend.pad($x,paddings,constantValue)},{$x:$x},function(dy){return{$x:function(){return dy.slice(begin,$x.shape)}}})}}),exports.pad1d=operation_1.op({pad1d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(2===paddings.length,function(){return"Invalid number of paddings. Must be length of 2."}),exports.pad(x,[paddings],constantValue)}}),exports.pad2d=operation_1.op({pad2d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(2===paddings.length&&2===paddings[0].length&&2===paddings[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),exports.pad(x,paddings,constantValue)}}),exports.pad3d=operation_1.op({pad3d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(3===paddings.length&&2===paddings[0].length&&2===paddings[1].length&&2===paddings[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),exports.pad(x,paddings,constantValue)}}),exports.pad4d=operation_1.op({pad4d_:function(x,paddings,constantValue){return void 0===constantValue&&(constantValue=0),util.assert(4===paddings.length&&2===paddings[0].length&&2===paddings[1].length&&2===paddings[2].length&&2===paddings[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),exports.pad(x,paddings,constantValue)}}),exports.rand=operation_1.op({rand_:function(shape,randFunction,dtype){var size=util.sizeFromShape(shape),values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else{if("bool"!==dtype)throw new Error("Unknown data type "+dtype);values=new Uint8Array(size)}for(var i=0;i<size;i++)values[i]=randFunction();return tensor_1.Tensor.make(shape,{values:values},dtype)}}),exports.randomNormal=operation_1.op({randomNormal_:function(shape,mean,stdDev,dtype,seed){if(void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),null!=dtype&&"bool"===dtype)throw new Error("Unsupported data type "+dtype);for(var randGauss=new rand_1.MPRandGauss(mean,stdDev,dtype,!1,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=randGauss.nextValue();return res.toTensor()}}),exports.randomGamma=operation_1.op({randomGamma_:function(shape,alpha,beta,dtype,seed){if(void 0===beta&&(beta=1),void 0===dtype&&(dtype="float32"),null==beta&&(beta=1),null==dtype&&(dtype="float32"),"float32"!==dtype&&"int32"!==dtype)throw new Error("Unsupported data type "+dtype);for(var rgamma=new rand_1.RandGamma(alpha,beta,dtype,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=rgamma.nextValue();return res.toTensor()}}),exports.randomUniform=operation_1.op({randomUniform_:function(shape,minval,maxval,dtype,seed){void 0===minval&&(minval=0),void 0===maxval&&(maxval=1),void 0===dtype&&(dtype="float32");for(var res=buffer(shape,dtype),random=new rand_1.UniformRandom(minval,maxval,null,seed),i=0;i<res.values.length;i++)res.values[i]=random.nextValue();return res.toTensor()}}),exports.reshape=operation_1.op({reshape_:function(x,shape){var $x=tensor_util_env_1.convertToTensor(x,"x","reshape",null);return shape=util.inferFromImplicitShape(shape,$x.size),util.assert($x.size===util.sizeFromShape(shape),function(){return"new shape and old shape must have the same number of elements."}),engine_1.ENGINE.runKernel(function(backend){return backend.reshape($x,shape)},{$x:$x},function(dy){return{$x:function(){return dy.reshape($x.shape)}}})}}),exports.spaceToBatchND=operation_1.op({spaceToBatchND_:function(x,blockShape,paddings){var $x=tensor_util_env_1.convertToTensor(x,"x","spaceToBatchND");return util.assert($x.rank>=1+blockShape.length,function(){return"input rank "+$x.rank+" should be > than [blockShape] "+blockShape.length}),util.assert(paddings.length===blockShape.length,function(){return"paddings.shape[0] "+paddings.length+" must be equal to [blockShape] "+blockShape.length}),util.assert($x.shape.reduce(function(a,b,i){return 0<i&&i<=blockShape.length?a&&(b+paddings[i-1][0]+paddings[i-1][1])%blockShape[i-1]==0:a},!0),function(){return"input spatial dimensions "+$x.shape.slice(1)+" with paddings "+paddings.toString()+" must be divisible by blockShapes "+blockShape.toString()}),engine_1.ENGINE.runKernel(function(backend){return backend.spaceToBatchND($x,blockShape,paddings)},{$x:$x},function(dy){return{$x:function(){return dy.batchToSpaceND(blockShape,paddings)}}})}}),exports.squeeze=operation_1.op({squeeze_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","squeeze");return exports.reshape($x,util.squeezeShape($x.shape,axis).newShape)}}),exports.stack=operation_1.op({stack_:function(tensors,axis){void 0===axis&&(axis=0);var $tensors=tensor_util_env_1.convertToTensorArray(tensors,"tensors","stack");if(util.assert(1<=$tensors.length,function(){return"Pass at least one tensor to tf.stack"}),1===$tensors.length)return $tensors[0].expandDims(axis);var rank=$tensors[0].rank,shape=$tensors[0].shape,dtype=$tensors[0].dtype;util.assert(axis<=rank,function(){return"Axis must be <= rank of the tensor"}),$tensors.forEach(function(t){util.assertShapesMatch(shape,t.shape,"All tensors passed to stack must have matching shapes")}),$tensors.forEach(function(t){util.assert(dtype===t.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var expandedTensors=$tensors.map(function(t){return t.expandDims(axis)});return concat_split_1.concat(expandedTensors,axis)}}),exports.tile=operation_1.op({tile_:function(x,reps){var $x=tensor_util_env_1.convertToTensor(x,"x","tile",null);return util.assert($x.rank===reps.length,function(){return"Error in transpose: rank of input "+$x.rank+" must match length of reps "+reps+"."}),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.tile($x,reps);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){var xGrad=tensor_ops_1.zerosLike($x);if(1===$x.rank)for(var i=0;i<reps[0];++i)xGrad=xGrad.add(dy.slice([i*$x.shape[0]],[$x.shape[0]]));else if(2===$x.rank)for(i=0;i<reps[0];++i)for(var j=0;j<reps[1];++j)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1]],[$x.shape[0],$x.shape[1]]));else if(3===$x.rank)for(i=0;i<reps[0];++i)for(j=0;j<reps[1];++j)for(var k=0;k<reps[2];++k)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1],k*$x.shape[2]],[$x.shape[0],$x.shape[1],$x.shape[2]]));else{if(4!==$x.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+$x.rank+" tensors yet.");for(i=0;i<reps[0];++i)for(j=0;j<reps[1];++j)for(k=0;k<reps[2];++k)for(var l=0;l<reps[3];++l)xGrad=xGrad.add(dy.slice([i*$x.shape[0],j*$x.shape[1],k*$x.shape[2],l*$x.shape[3]],[$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3]]))}return xGrad}}})}}),exports.truncatedNormal=operation_1.op({truncatedNormal_:function(shape,mean,stdDev,dtype,seed){if(void 0===mean&&(mean=0),void 0===stdDev&&(stdDev=1),null!=dtype&&"bool"===dtype)throw new Error("Unsupported data type "+dtype);for(var randGauss=new rand_1.MPRandGauss(mean,stdDev,dtype,!0,seed),res=buffer(shape,dtype),i=0;i<res.values.length;i++)res.values[i]=randGauss.nextValue();return res.toTensor()}}),exports.unstack=operation_1.op({unstack_:function(x,axis){void 0===axis&&(axis=0),axis=axis||0;var $x=tensor_util_env_1.convertToTensor(x,"x","unstack");return util.assert(axis>=-$x.shape.length&&axis<$x.shape.length,function(){return"Axis = "+axis+" is not in [-"+$x.shape.length+", "+$x.shape.length+")"}),axis<0&&(axis+=$x.shape.length),engine_1.ENGINE.runKernel(function(backend){return backend.unstack($x,axis)},{$x:$x},function(dy){return{$x:function(){return exports.stack(dy,axis)}}})}}),exports.setdiff1dAsync=function(x,y){return __awaiter(this,void 0,void 0,function(){var $x,$y,xVals,yVals,ySet,outputSize,buffer,indices,i,p;return __generator(this,function(_a){switch(_a.label){case 0:return $x=tensor_util_env_1.convertToTensor(x,"x","setdiff1d"),$y=tensor_util_env_1.convertToTensor(y,"y","setdiff1d"),util.assert($x.dtype===$y.dtype,function(){return"x and y should have the same dtype, but got x ("+$x.dtype+") and y ("+$y.dtype+")."}),util.assert(1===$x.rank,function(){return"x should be 1D tensor, but got x ("+$x.shape+")."}),util.assert(1===$y.rank,function(){return"y should be 1D tensor, but got y ("+$y.shape+")."}),[4,$x.data()];case 1:return xVals=_a.sent(),[4,$y.data()];case 2:for(yVals=_a.sent(),ySet=new Set(yVals),i=outputSize=0;i<xVals.length;i++)ySet.has(xVals[i])||outputSize++;for(buffer=new tensor_1.TensorBuffer([outputSize],$x.dtype),indices=new tensor_1.TensorBuffer([outputSize],"int32"),p=i=0;i<xVals.length;i++)ySet.has(xVals[i])||(buffer.values[p]=xVals[i],indices.values[p]=i,p++);return[2,[buffer.toTensor(),indices.toTensor()]]}})})}},{"../engine":143,"../tensor":234,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./concat_split":173,"./operation":195,"./rand":198,"./tensor_ops":216}],164:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getReshaped=function(inputShape,blockShape,prod,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var reshaped=[];if(batchToSpace)(reshaped=reshaped.concat(blockShape.slice(0))).push(inputShape[0]/prod),reshaped=reshaped.concat(inputShape.slice(1));else{reshaped=reshaped.concat(inputShape[0]);for(var spatialLength=blockShape.length,i=0;i<spatialLength;++i)reshaped=reshaped.concat([inputShape[i+1]/blockShape[i],blockShape[i]]);reshaped=reshaped.concat(inputShape.slice(spatialLength+1))}return reshaped},exports.getPermuted=function(reshapedRank,blockShapeRank,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var permuted=[];if(batchToSpace){permuted.push(blockShapeRank);for(var i=blockShapeRank+1;i<reshapedRank;++i)i<=2*blockShapeRank?(permuted.push(i),permuted.push(i-(blockShapeRank+1))):permuted.push(i)}else{var permutedBeforeBatch=[],permutedAfterBatch=[];for(i=1;i<reshapedRank;++i)2*blockShapeRank+1<=i||i%2==1?permutedAfterBatch.push(i):permutedBeforeBatch.push(i);permuted.push.apply(permuted,permutedBeforeBatch),permuted.push(0),permuted.push.apply(permuted,permutedAfterBatch)}return permuted},exports.getReshapedPermuted=function(inputShape,blockShape,prod,batchToSpace){void 0===batchToSpace&&(batchToSpace=!0);var reshapedPermuted=[];batchToSpace?reshapedPermuted.push(inputShape[0]/prod):reshapedPermuted.push(inputShape[0]*prod);for(var i=1;i<inputShape.length;++i)i<=blockShape.length?batchToSpace?reshapedPermuted.push(blockShape[i-1]*inputShape[i]):reshapedPermuted.push(inputShape[i]/blockShape[i-1]):reshapedPermuted.push(inputShape[i]);return reshapedPermuted},exports.getSliceBeginCoords=function(crops,blockShape){for(var sliceBeginCoords=[0],i=0;i<blockShape;++i)sliceBeginCoords.push(crops[i][0]);return sliceBeginCoords},exports.getSliceSize=function(uncroppedShape,crops,blockShape){for(var sliceSize=uncroppedShape.slice(0,1),i=0;i<blockShape;++i)sliceSize.push(uncroppedShape[i+1]-crops[i][0]-crops[i][1]);return sliceSize}},{}],165:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function axesAreInnerMostDims(axes,rank){for(var i=0;i<axes.length;++i)if(axes[axes.length-i-1]!==rank-1-i)return!1;return!0}function combineLocations(outputLoc,reduceLoc,axes){for(var rank=outputLoc.length+reduceLoc.length,loc=[],outIdx=0,reduceIdx=0,dim=0;dim<rank;dim++)-1===axes.indexOf(dim)?loc.push(outputLoc[outIdx++]):loc.push(reduceLoc[reduceIdx++]);return loc}exports.axesAreInnerMostDims=axesAreInnerMostDims,exports.combineLocations=combineLocations,exports.computeOutAndReduceShapes=function(aShape,axes){for(var outShape=[],rank=aShape.length,dim=0;dim<rank;dim++)-1===axes.indexOf(dim)&&outShape.push(aShape[dim]);return[outShape,axes.map(function(dim){return aShape[dim]})]},exports.expandShapeToKeepDim=function(shape,axes){return combineLocations(shape,axes.map(function(x){return 1}),axes)},exports.assertAxesAreInnerMostDims=function(msg,axes,rank){util.assert(axesAreInnerMostDims(axes,rank),function(){return msg+" supports only inner-most axes for now. Got axes "+axes+" and rank-"+rank+" input."})},exports.getAxesPermutation=function(axes,rank){if(axesAreInnerMostDims(axes,rank))return null;for(var result=[],i=0;i<rank;++i)-1===axes.indexOf(i)&&result.push(i);return axes.forEach(function(axis){return result.push(axis)}),result},exports.getUndoAxesPermutation=function(axes){return axes.map(function(axis,i){return[i,axis]}).sort(function(a,b){return a[1]-b[1]}).map(function(x){return x[0]})},exports.getInnerMostAxes=function(numAxes,rank){for(var res=[],i=rank-numAxes;i<rank;++i)res.push(i);return res}},{"../util":241}],166:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops"),unary_ops_1=require("./unary_ops");function batchNorm2d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(2===$x.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+$x.rank+"."}),util.assert(2===$mean.rank||1===$mean.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+$mean.rank+"."}),util.assert(2===$variance.rank||1===$variance.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+$variance.rank+"."}),null!=$scale&&util.assert(2===$scale.rank||1===$scale.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+$scale.rank+"."}),null!=$offset&&util.assert(2===$offset.rank||1===$offset.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+$offset.rank+"."}),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm3d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(3===$x.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+$x.rank+"."}),util.assert(3===$mean.rank||1===$mean.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+$mean.rank+"."}),util.assert(3===$variance.rank||1===$variance.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+$variance.rank+"."}),null!=$scale&&util.assert(3===$scale.rank||1===$scale.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+$scale.rank+"."}),null!=$offset&&util.assert(3===$offset.rank||1===$offset.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+$offset.rank+"."}),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm4d_(x,mean,variance,offset,scale,varianceEpsilon){var $scale,$offset,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");return null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert(4===$x.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+$x.rank+"."}),util.assert(4===$mean.rank||1===$mean.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+$mean.rank+"."}),util.assert(4===$variance.rank||1===$variance.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+$variance.rank+"."}),null!=$scale&&util.assert(4===$scale.rank||1===$scale.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+$scale.rank+"."}),null!=$offset&&util.assert(4===$offset.rank||1===$offset.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+$offset.rank+"."}),batchNorm_($x,$mean,$variance,$offset,$scale,varianceEpsilon)}function batchNorm_(x,mean,variance,offset,scale,varianceEpsilon){null==varianceEpsilon&&(varianceEpsilon=.001);var $scale,$offset,x4D,$x=tensor_util_env_1.convertToTensor(x,"x","batchNorm"),$mean=tensor_util_env_1.convertToTensor(mean,"mean","batchNorm"),$variance=tensor_util_env_1.convertToTensor(variance,"variance","batchNorm");null!=scale&&($scale=tensor_util_env_1.convertToTensor(scale,"scale","batchNorm")),null!=offset&&($offset=tensor_util_env_1.convertToTensor(offset,"offset","batchNorm")),util.assert($mean.rank===$variance.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),util.assert(null==$offset||$mean.rank===$offset.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),util.assert(null==$scale||$mean.rank===$scale.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),x4D=0===$x.rank||1===$x.rank?$x.as4D(1,1,1,$x.size):2===$x.rank?$x.as4D(1,1,$x.shape[0],$x.shape[1]):3===$x.rank?$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2]):$x;return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.batchNormalization(x4D,batchnormReshape4D($mean),batchnormReshape4D($variance),varianceEpsilon,batchnormReshape4D($scale),batchnormReshape4D($offset));return save([$x,$mean,$variance,$scale]),res},{$x:$x,$mean:$mean,$variance:$variance,$scale:$scale,$offset:$offset},function(dy,saved){var _a=saved,$x=_a[0],$mean=_a[1],$variance=_a[2],$scale=_a[3],scaleValue=null==$scale?tensor_ops_1.scalar(1):$scale,reductionAxes=broadcast_util_1.getReductionAxes($mean.shape,x4D.shape),tileShape=[];if(1===$mean.rank){for(var i=0;i<x4D.shape.length-1;++i)tileShape.push(x4D.shape[i]);tileShape.push(1)}var xMinusMean=$x.sub($mean),dyTimesScaleValue=dy.mul(scaleValue),oneOverSqrtVariance=unary_ops_1.rsqrt($variance.add(tensor_ops_1.scalar(varianceEpsilon))),minusHalfRCube=oneOverSqrtVariance.mul(oneOverSqrtVariance).mul(oneOverSqrtVariance).mul(tensor_ops_1.scalar(-.5));return{$x:function(){return 1===$mean.rank?dy.mul(array_ops_1.tile(oneOverSqrtVariance.as4D(1,1,1,$mean.shape[0]),tileShape)).mul(scaleValue).reshape($x.shape):dy.mul(oneOverSqrtVariance).mul(scaleValue).reshape($x.shape)},$mean:function(){var meanDer=oneOverSqrtVariance.mul(tensor_ops_1.scalar(-1)).mul(dyTimesScaleValue);return 1===$mean.rank&&(meanDer=meanDer.sum(reductionAxes)),meanDer.reshape($mean.shape)},$variance:function(){var varianceDer=minusHalfRCube.mul(xMinusMean).mul(dyTimesScaleValue);return 1===$mean.rank&&(varianceDer=varianceDer.sum(reductionAxes)),varianceDer.reshape($mean.shape)},$scale:function(){var xMinusMean2TimesRsqrt=xMinusMean.mul(oneOverSqrtVariance),scaleDer=dy.mul(xMinusMean2TimesRsqrt);return 1===$mean.rank&&(scaleDer=scaleDer.sum(reductionAxes)),scaleDer.reshape($mean.shape)},$offset:function(){var offsetDer=dy;return 1===$mean.rank&&(offsetDer=offsetDer.sum(reductionAxes)),offsetDer.reshape($mean.shape)}}}).reshape($x.shape)}function batchnormReshape4D(x){return null==x?null:0===x.rank?x.as1D():1===x.rank?x:2===x.rank?x.as4D(1,1,x.shape[0],x.shape[1]):3===x.rank?x.as4D(1,x.shape[0],x.shape[1],x.shape[2]):x}function warnDeprecation(){globals_1.deprecationWarn("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}exports.batchNormalization2d=operation_1.op({batchNormalization2d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm2d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization3d=operation_1.op({batchNormalization3d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm3d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization4d=operation_1.op({batchNormalization4d_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm4d_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNormalization=operation_1.op({batchNormalization_:function(x,mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),warnDeprecation(),batchNorm_(x,mean,variance,offset,scale,varianceEpsilon)}}),exports.batchNorm=operation_1.op({batchNorm_:batchNorm_}),exports.batchNorm2d=operation_1.op({batchNorm2d_:batchNorm2d_}),exports.batchNorm3d=operation_1.op({batchNorm3d_:batchNorm3d_}),exports.batchNorm4d=operation_1.op({batchNorm4d_:batchNorm4d_})},{"../engine":143,"../globals":146,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./broadcast_util":169,"./operation":195,"./tensor_ops":216,"./unary_ops":219}],167:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),types_1=require("../types"),util=require("../util"),broadcast_util=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops"),unary_ops_1=require("./unary_ops");exports.add=operation_1.op({add_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","add"),$b=tensor_util_env_1.convertToTensor(b,"b","add");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.add($a,$b)},{$a:$a,$b:$b},function(dy){return{$a:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($b.shape)}}})}}),exports.addN=operation_1.op({addN_:function(tensors){util.assert(Array.isArray(tensors),function(){return"The argument passed to tf.addN() must be a list of tensors"}),util.assert(1<=tensors.length,function(){return"Must pass at least one tensor to tf.addN(), but got "+tensors.length});var $tensors=tensors.map(function(t,i){return tensor_util_env_1.convertToTensor(t,"tensors"+i,"addN")}),firstTensor=$tensors[0];$tensors.forEach(function(t){if(t.dtype!==firstTensor.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),$tensors.forEach(function(t){if(!util.arraysEqual(t.shape,firstTensor.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});var inputs=$tensors;return engine_1.ENGINE.runKernel(function(backend){return backend.addN($tensors)},inputs,function(dy){var ders={};return $tensors.forEach(function(t,i){ders[i]=function(){return dy.clone()}}),ders})}}),exports.addStrict=operation_1.op({addStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","addStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","addStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in addStrict: "),$a.add($b)}}),exports.atan2=operation_1.op({atan2_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","atan2"),$b=tensor_util_env_1.convertToTensor(b,"b","atan2");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.atan2($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var d=exports.add($a.square(),$b.square()),res=dy.mul($b.div(d)),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var d=exports.add($a.square(),$b.square()),res=unary_ops_1.neg(dy.mul($a.div(d))),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($b.shape)}}})}}),exports.div=operation_1.op({div_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");if(_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"int32"===$a.dtype&&"int32"===$b.dtype)return exports.floorDiv($a,$b);var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.realDivide($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var res=dy.div($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($a.shape):res},$b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);0<reduceAxes.length&&(res=res.sum(reduceAxes).reshape($b.shape));var tmp=$b.square();return res.div(tmp.toFloat()).neg()}}})}}),exports.divStrict=operation_1.op({divStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","div"),$b=tensor_util_env_1.convertToTensor(b,"b","div");return util.assertShapesMatch($a.shape,$b.shape,"Error in divideStrict: "),$a.div($b)}}),exports.floorDiv=operation_1.op({floorDiv_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","floorDiv"),$b=tensor_util_env_1.convertToTensor(b,"b","floorDiv");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.floorDiv($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var res=dy.div($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($a.shape):res},$b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);0<reduceAxes.length&&(res=res.sum(reduceAxes).reshape($b.shape));var tmp=$b.square();return res.div(tmp.toFloat()).neg()}}})}}),exports.maximum=operation_1.op({maximum_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","maximum"),$b=tensor_util_env_1.convertToTensor(b,"b","maximum");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"bool"===$a.dtype&&($a=$a.toInt(),$b=$b.toInt()),broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.maximum($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){return dy.mul($a.greaterEqual($b).toFloat())},$b:function(){return dy.mul($a.less($b).toFloat())}}})}}),exports.maximumStrict=operation_1.op({maximumStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","maximumStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","maximumStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in maximumStrict: "),$a.maximum($b)}}),exports.minimum=operation_1.op({minimum_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","minimum"),$b=tensor_util_env_1.convertToTensor(b,"b","minimum");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],"bool"===$a.dtype&&($a=$a.toInt(),$b=$b.toInt()),broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.minimum($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){return dy.mul($a.lessEqual($b).toFloat())},$b:function(){return dy.mul($a.greater($b).toFloat())}}})}}),exports.minimumStrict=operation_1.op({minimumStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","minimumStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","minimumStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in minimumStrict: "),$a.minimum($b)}}),exports.mod=operation_1.op({mod_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","mod"),$b=tensor_util_env_1.convertToTensor(b,"b","mod");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.mod($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?dy.sum(reduceAxes).reshape($a.shape):dy},$b:function(){var res=dy.mul($a.div($b).floor().neg()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($b.shape):res}}})}}),exports.modStrict=operation_1.op({modStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","modStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","modStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in modStrict: "),$a.mod($b)}}),exports.mul=operation_1.op({mul_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","mul"),$b=tensor_util_env_1.convertToTensor(b,"b","mul");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.multiply($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){var res=dy.mul($b.toFloat()),reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($a.shape):res},$b:function(){var res=dy.mul($a.toFloat()),reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length?res.sum(reduceAxes).reshape($b.shape):res}}})}}),exports.mulStrict=operation_1.op({mulStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","mul"),$b=tensor_util_env_1.convertToTensor(b,"b","mul");return util.assertShapesMatch($a.shape,$b.shape,"Error in multiplyStrict: "),$a.mul($b)}}),exports.pow=operation_1.op({pow_:function(base,exp){var $base=tensor_util_env_1.convertToTensor(base,"base","pow"),$exp=tensor_util_env_1.convertToTensor(exp,"exp","pow"),outShape=broadcast_util.assertAndGetBroadcastShape($base.shape,$exp.shape);return base=$base.cast(types_1.upcastType($base.dtype,$exp.dtype)),exp=$exp.cast(types_1.upcastType($base.dtype,$exp.dtype)),engine_1.ENGINE.runKernel(function(backend,save){var y=backend.pow($base,$exp);return save([$base,$exp,y]),y},{$base:$base,$exp:$exp},function(dy,saved){var $base=saved[0],$exp=saved[1],y=saved[2];return{$base:function(){var expFloat=$exp.toFloat(),res=dy.mul(expFloat.mul($base.pow(expFloat.sub(tensor_ops_1.scalar(1))))),reduceAxes=broadcast_util.getReductionAxes($base.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($base.shape)},$exp:function(){var condition=$base.greater(0),logBase=$base.log().where(condition,tensor_ops_1.zerosLike($base)),res=dy.mul(y.mul(logBase)),reduceAxes=broadcast_util.getReductionAxes($exp.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($exp.shape)}}})}}),exports.powStrict=operation_1.op({powStrict_:function(base,exp){return util.assertShapesMatch(base.shape,exp.shape,"Error in powStrict: "),base.pow(exp)}}),exports.squaredDifference=operation_1.op({squaredDifference_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","squaredDifference"),$b=tensor_util_env_1.convertToTensor(b,"b","squaredDifference");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.squaredDifference($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1],two=tensor_ops_1.scalar(2);return{$a:function(){return dy.mul($a.sub($b).mul(two))},$b:function(){return dy.mul($b.sub($a).mul(two))}}})}}),exports.squaredDifferenceStrict=operation_1.op({squaredDifferenceStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","squaredDifferenceStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","squaredDifferenceStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in squaredDifferenceStrict: "),$a.squaredDifference($b)}}),exports.sub=operation_1.op({sub_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","sub"),$b=tensor_util_env_1.convertToTensor(b,"b","sub");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var outShape=broadcast_util.assertAndGetBroadcastShape($a.shape,$b.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.subtract($a,$b)},{$a:$a,$b:$b},function(dy){return{$a:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($a.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($a.shape)},$b:function(){var res=dy,reduceAxes=broadcast_util.getReductionAxes($b.shape,outShape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.neg().reshape($b.shape)}}})}}),exports.subStrict=operation_1.op({subStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","subStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","subStrict");return util.assertShapesMatch($a.shape,$b.shape,"Error in subStrict: "),$a.sub($b)}})},{"../engine":143,"../tensor_util":236,"../tensor_util_env":237,"../types":240,"../util":241,"./broadcast_util":169,"./operation":195,"./tensor_ops":216,"./unary_ops":219}],168:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),logical_ops_1=require("./logical_ops"),segment_ops_1=require("./segment_ops");exports.booleanMaskAsync=function(tensor,mask,axis){return __awaiter(this,void 0,void 0,function(){var $tensor,$mask,axisFrom,maskDim,tensorShape,leadingSize,i,targetTensorShape,reshapedTensor,reshapedMask,positivePositions,indices,res;return __generator(this,function(_a){switch(_a.label){case 0:for($tensor=tensor_util_env_1.convertToTensor(tensor,"tensor","boolMask"),$mask=tensor_util_env_1.convertToTensor(mask,"mask","boolMask","bool"),axisFrom=null==axis?0:axis,maskDim=$mask.rank,tensorShape=$tensor.shape,util.assert(0<maskDim,function(){return"mask cannot be scalar"}),util.assertShapesMatch(tensorShape.slice(axisFrom,axisFrom+maskDim),$mask.shape,"mask's shape must match the first K dimensions of tensor's shape,"),leadingSize=1,i=axisFrom;i<axisFrom+maskDim;i++)leadingSize*=tensorShape[i];return targetTensorShape=tensorShape.slice(0,axisFrom).concat([leadingSize],tensorShape.slice(axisFrom+maskDim)),reshapedTensor=$tensor.reshape(targetTensorShape),reshapedMask=$mask.reshape([-1]),[4,logical_ops_1.whereAsync(reshapedMask)];case 1:return positivePositions=_a.sent(),indices=positivePositions.squeeze([1]),res=segment_ops_1.gather(reshapedTensor,indices,axisFrom),tensor!==$tensor&&$tensor.dispose(),mask!==$mask&&$mask.dispose(),indices.dispose(),reshapedTensor.dispose(),reshapedMask.dispose(),positivePositions.dispose(),[2,res]}})})}},{"../tensor_util_env":237,"../util":241,"./logical_ops":188,"./segment_ops":205}],169:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getBroadcastDims=function(inShape,outShape){for(var inRank=inShape.length,dims=[],i=0;i<inRank;i++){var dim=inRank-1-i,a=inShape[dim]||1;1<(outShape[outShape.length-1-i]||1)&&1===a&&dims.unshift(dim)}return dims},exports.getReductionAxes=function(inShape,outShape){for(var result=[],i=0;i<outShape.length;i++){var inDim=inShape[inShape.length-i-1],outAxis=outShape.length-i-1,outDim=outShape[outAxis];(null==inDim||1===inDim&&1<outDim)&&result.unshift(outAxis)}return result},exports.assertAndGetBroadcastShape=function(shapeA,shapeB){for(var result=[],l=Math.max(shapeA.length,shapeB.length),i=0;i<l;i++){var a=shapeA[shapeA.length-i-1];null==a&&(a=1);var b=shapeB[shapeB.length-i-1];if(null==b&&(b=1),1===a)result.unshift(b);else if(1===b)result.unshift(a);else{if(a!==b)throw Error("Operands could not be broadcast together with shapes "+shapeA+" and "+shapeB+".");result.unshift(a)}}return result}},{}],170:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.toPixels=function(img,canvas){return __awaiter(this,void 0,void 0,function(){var $img,_a,height,width,depth,data,minTensor,maxTensor,_b,minVals,maxVals,min,max,multiplier,bytes,i,r,g,b,a,j,ctx,imageData;return __generator(this,function(_c){switch(_c.label){case 0:if($img=tensor_util_env_1.convertToTensor(img,"img","toPixels"),img instanceof tensor_1.Tensor||($img=$img.toInt()),2!==$img.rank&&3!==$img.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+$img.rank+".");if(_a=$img.shape.slice(0,2),height=_a[0],width=_a[1],4<(depth=2===$img.rank?1:$img.shape[2])||2===depth)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+depth);return[4,$img.data()];case 1:return data=_c.sent(),minTensor=$img.min(),maxTensor=$img.max(),[4,Promise.all([minTensor.data(),maxTensor.data()])];case 2:if(_b=_c.sent(),minVals=_b[0],maxVals=_b[1],min=minVals[0],max=maxVals[0],minTensor.dispose(),maxTensor.dispose(),"float32"===$img.dtype){if(min<0||1<max)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+min+" - "+max+"].")}else{if("int32"!==$img.dtype)throw new Error("Unsupported type for toPixels: "+$img.dtype+". Please use float32 or int32 tensors.");if(min<0||255<max)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+min+" - "+max+"].")}for(multiplier="float32"===$img.dtype?255:1,bytes=new Uint8ClampedArray(width*height*4),i=0;i<height*width;++i)a=b=g=r=void 0,1===depth?(r=data[i]*multiplier,g=data[i]*multiplier,b=data[i]*multiplier,a=255):3===depth?(r=data[3*i]*multiplier,g=data[3*i+1]*multiplier,b=data[3*i+2]*multiplier,a=255):4===depth&&(r=data[4*i]*multiplier,g=data[4*i+1]*multiplier,b=data[4*i+2]*multiplier,a=data[4*i+3]*multiplier),bytes[0+(j=4*i)]=Math.round(r),bytes[1+j]=Math.round(g),bytes[2+j]=Math.round(b),bytes[3+j]=Math.round(a);return null!=canvas&&(canvas.width=width,canvas.height=height,ctx=canvas.getContext("2d"),imageData=new ImageData(bytes,width,height),ctx.putImageData(imageData,0,0)),$img!==img&&$img.dispose(),[2,bytes]}})})},exports.fromPixels=operation_1.op({fromPixels_:function(pixels,numChannels){if(void 0===numChannels&&(numChannels=3),4<numChannels)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");return engine_1.ENGINE.fromPixels(pixels,numChannels)}})},{"../engine":143,"../tensor":234,"../tensor_util_env":237,"./operation":195}],171:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.equal=operation_1.op({equal_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","equal"),$b=tensor_util_env_1.convertToTensor(b,"b","equal");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.equal($a,$b)},{$a:$a,$b:$b})}}),exports.equalStrict=operation_1.op({equalStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","equalStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","equalStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in equalStrict: "),$a.equal($b)}}),exports.greater=operation_1.op({greater_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","greater"),$b=tensor_util_env_1.convertToTensor(b,"b","greater");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.greater($a,$b)},{$a:$a,$b:$b})}}),exports.greaterEqual=operation_1.op({greaterEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","greaterEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.greaterEqual($a,$b);return save([$a,$b]),res},{$a:$a,$b:$b},function(dy,saved){var $a=saved[0],$b=saved[1];return{$a:function(){return tensor_ops_1.zerosLike($a)},$b:function(){return tensor_ops_1.zerosLike($b)}}})}}),exports.greaterEqualStrict=operation_1.op({greaterEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","greaterEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in greaterEqualStrict: "),$a.greaterEqual($b)}}),exports.greaterStrict=operation_1.op({greaterStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","greaterStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","greaterStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in greaterStrict: "),$a.greater($b)}}),exports.less=operation_1.op({less_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","less"),$b=tensor_util_env_1.convertToTensor(b,"b","less");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.less($a,$b)},{$a:$a,$b:$b})}}),exports.lessEqual=operation_1.op({lessEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","lessEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","lessEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.lessEqual($a,$b)},{$a:$a,$b:$b})}}),exports.lessEqualStrict=operation_1.op({lessEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","lessEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","lessEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in lessEqualStrict: "),$a.lessEqual($b)}}),exports.lessStrict=operation_1.op({lessStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","lessStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","lessStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in lessStrict: "),$a.less($b)}}),exports.notEqual=operation_1.op({notEqual_:function(a,b){var _a,$a=tensor_util_env_1.convertToTensor(a,"a","notEqual"),$b=tensor_util_env_1.convertToTensor(b,"b","notEqual");return _a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1],broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.notEqual($a,$b)},{$a:$a,$b:$b})}}),exports.notEqualStrict=operation_1.op({notEqualStrict_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","notEqualStrict"),$b=tensor_util_env_1.convertToTensor(b,"b","notEqualStrict");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in notEqualStrict: "),$a.notEqual($b)}})},{"../engine":143,"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./broadcast_util":169,"./operation":195,"./tensor_ops":216}],172:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.complex=operation_1.op({complex_:function(real,imag){var $real=tensor_util_env_1.convertToTensor(real,"real","complex"),$imag=tensor_util_env_1.convertToTensor(imag,"imag","complex");return util.assertShapesMatch($real.shape,$imag.shape,"real and imag shapes, "+$real.shape+" and "+$imag.shape+", must match in call to tf.complex()."),engine_1.ENGINE.runKernel(function(backend){return backend.complex($real,$imag)},{$real:$real,$imag:$imag})}}),exports.real=operation_1.op({real_:function(input){var $input=tensor_util_env_1.convertToTensor(input,"input","real");return engine_1.ENGINE.runKernel(function(backend){return backend.real($input)},{$input:$input})}}),exports.imag=operation_1.op({imag_:function(input){var $input=tensor_util_env_1.convertToTensor(input,"input","imag");return engine_1.ENGINE.runKernel(function(backend){return backend.imag($input)},{$input:$input})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],173:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),util_2=require("../util"),concat_util_1=require("./concat_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.concat=operation_1.op({concat_:function(tensors,axis){void 0===axis&&(axis=0),util_1.assert(1<=tensors.length,function(){return"Pass at least one tensor to concat"});var $tensors=tensor_util_env_1.convertToTensorArray(tensors,"tensors","concat");"complex64"===$tensors[0].dtype&&$tensors.forEach(function(tensor){if("complex64"!==tensor.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+tensor.dtype+". ")}),axis=util_2.parseAxisParam(axis,$tensors[0].shape)[0];var outShape=concat_util_1.computeOutShape($tensors.map(function(t){return t.shape}),axis);if(0===util_1.sizeFromShape(outShape))return tensor_ops_1.tensor([],outShape);if(1===($tensors=$tensors.filter(function(t){return 0<t.size})).length)return $tensors[0];var shapes=$tensors.map(function(t){return t.shape});concat_util_1.assertParamsConsistent(shapes,axis);var inputs=$tensors;return engine_1.ENGINE.runKernel(function(backend){return backend.concat($tensors,axis)},inputs,function(dy){var sizeSplits=shapes.map(function(s){return s[axis]});return exports.split(dy,sizeSplits,axis).map(function(t){return function(){return t}})})}}),exports.concat1d=operation_1.op({concat1d_:function(tensors){return exports.concat(tensors,0)}}),exports.concat2d=operation_1.op({concat2d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.concat3d=operation_1.op({concat3d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.concat4d=operation_1.op({concat4d_:function(tensors,axis){return exports.concat(tensors,axis)}}),exports.split=operation_1.op({split_:function(x,numOrSizeSplits,axis){void 0===axis&&(axis=0);var splitSizes,$x=tensor_util_env_1.convertToTensor(x,"x","split");return axis=util_2.parseAxisParam(axis,$x.shape)[0],splitSizes="number"==typeof numOrSizeSplits?(util_1.assert($x.shape[axis]%numOrSizeSplits==0,function(){return"Number of splits must evenly divide the axis."}),new Array(numOrSizeSplits).fill($x.shape[axis]/numOrSizeSplits)):(util_1.assert($x.shape[axis]===numOrSizeSplits.reduce(function(a,b){return a+b}),function(){return"The sum of sizes must match the size of the axis dimension."}),numOrSizeSplits),engine_1.ENGINE.runKernel(function(backend){return backend.split($x,splitSizes,axis)},{$x:$x},function(dy){return{$x:function(){return exports.concat(dy,axis)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./concat_util":174,"./operation":195,"./tensor_ops":216}],174:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.assertParamsConsistent=function(shapes,axis){var rank=shapes[0].length;shapes.forEach(function(shape,i){util.assert(shape.length===rank,function(){return"Error in concat"+rank+"D: rank of tensors["+i+"] must be the same as the rank of the rest ("+rank+")"})}),util.assert(0<=axis&&axis<rank,function(){return"Error in concat"+rank+"D: axis must be between 0 and "+(rank-1)+"."});var firstShape=shapes[0];shapes.forEach(function(shape,i){for(var r=0;r<rank;r++)util.assert(r===axis||shape[r]===firstShape[r],function(){return"Error in concat"+rank+"D: Shape of tensors["+i+"] ("+shape+") does not match the shape of the rest ("+firstShape+") along the non-concatenated axis "+i+"."})})},exports.computeOutShape=function(shapes,axis){for(var outputShape=shapes[0].slice(),i=1;i<shapes.length;i++)outputShape[axis]+=shapes[i][axis];return outputShape}},{"../util":241}],175:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),operation_1=require("./operation");function confusionMatrix_(labels,predictions,numClasses){var $labels=tensor_util_env_1.convertToTensor(labels,"labels","confusionMatrix"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","confusionMatrix");util.assert(null==numClasses||0<numClasses&&Number.isInteger(numClasses),function(){return"If provided, numClasses must be a positive integer, but got "+numClasses}),util.assert(1===$labels.rank,function(){return"Expected the rank of labels to be 1, but got "+$labels.rank}),util.assert(1===$predictions.rank,function(){return"Expected the rank of predictions to be 1, but got "+$predictions.rank}),util.assert($labels.shape[0]===$predictions.shape[0],function(){return"Mismatch in the number of examples: "+$labels.shape[0]+" vs. "+$predictions.shape[0]+". Labels and predictions should have the same number of elements."}),util.assert(0<numClasses&&Number.isInteger(numClasses),function(){return"numClasses is required to be a positive integer, but got "+numClasses});var oneHotLabels=array_ops_1.oneHot($labels.asType("int32"),numClasses),oneHotPredictions=array_ops_1.oneHot($predictions.asType("int32"),numClasses);return oneHotLabels.transpose().matMul(oneHotPredictions).asType("int32")}exports.confusionMatrix_=confusionMatrix_,exports.confusionMatrix=operation_1.op({confusionMatrix_:confusionMatrix_})},{"../tensor_util_env":237,"../util":241,"./array_ops":163,"./operation":195}],176:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),conv_util=require("./conv_util"),operation_1=require("./operation");function conv2dDerInput_(xShape,dy,filter,strides,pad,dataFormat,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),util.assert(xShape.length===dy.rank,function(){return"Length of inShape ("+xShape.length+") and rank of dy ("+dy.rank+") must match"});var xShape4D=xShape,dy4D=dy,reshapedTo4D=!1;3===dy.rank&&(reshapedTo4D=!0,dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]),xShape4D=[1,xShape[0],xShape[1],xShape[2]]),util.assert(4===xShape4D.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+xShape4D.length+"."}),util.assert(4===dy4D.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+dy4D.rank}),util.assert(4===filter.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+filter.rank});var inDepth="NHWC"===dataFormat?xShape4D[3]:xShape4D[1],outDepth="NHWC"===dataFormat?dy4D.shape[3]:dy4D.shape[1];util.assert(inDepth===filter.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[2]+"."}),util.assert(outDepth===filter.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+outDepth+") must match output depth for filter "+filter.shape[3]+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(xShape4D,filter.shape,strides,1,pad,dimRoundingMode,!1,$dataFormat),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.conv2dDerInput(dy4D,filter,convInfo);return save([filter,dy4D]),res},{dy4D:dy4D,filter:filter},function(ddx,saved){var filter=saved[0],dy4D=saved[1];return{dy4D:function(){return exports.conv2d(ddx,filter,strides,pad,dataFormat,1,dimRoundingMode)},filter:function(){return exports.conv2dDerFilter(ddx,dy4D,filter.shape,strides,pad,dataFormat,dimRoundingMode)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}function conv2dDerFilter_(x,dy,filterShape,strides,pad,dataFormat,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC");var x4D=x;3===x.rank&&(x4D=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]));var dy4D=dy;3===dy4D.rank&&(dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2])),util.assert(4===x4D.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+x4D.shape+"."}),util.assert(4===dy4D.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+dy4D.shape+"."}),util.assert(4===filterShape.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+filterShape+"."});var inDepth="NHWC"===dataFormat?x4D.shape[3]:x4D.shape[1],outDepth="NHWC"===dataFormat?dy4D.shape[3]:dy4D.shape[1];util.assert(inDepth===filterShape[2],function(){return"Error in conv2dDerFilter: depth of input "+inDepth+") must match input depth in filter ("+filterShape[2]+"."}),util.assert(outDepth===filterShape[3],function(){return"Error in conv2dDerFilter: depth of dy ("+outDepth+") must match output depth for filter ("+filterShape[3]+")."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(x4D.shape,filterShape,strides,1,pad,dimRoundingMode,!1,$dataFormat);return engine_1.ENGINE.runKernel(function(backend){return backend.conv2dDerFilter(x4D,dy4D,convInfo)},{x4D:x4D,dy4D:dy4D})}function tupleValuesAreOne(param){var _a=function(param){return"number"==typeof param?[param,param,param]:2===param.length?[param[0],param[1],1]:param}(param),dimA=_a[0],dimB=_a[1],dimC=_a[2];return 1===dimA&&1===dimB&&1===dimC}function conv3dDerInput_(xShape,dy,filter,strides,pad){util.assert(xShape.length===dy.rank,function(){return"Length of inShape ("+xShape.length+") and rank of dy ("+dy.rank+") must match"});var xShape5D=xShape,dy5D=dy,reshapedTo5D=!1;4===dy.rank&&(reshapedTo5D=!0,dy5D=dy.as5D(1,dy.shape[0],dy.shape[1],dy.shape[2],dy.shape[3]),xShape5D=[1,xShape[0],xShape[1],xShape[2],xShape[3]]);var inDepth=xShape5D[4],outDepth=dy5D.shape[4];util.assert(5===xShape5D.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+xShape5D.length+"."}),util.assert(5===dy5D.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+dy5D.rank}),util.assert(5===filter.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+filter.rank}),util.assert(inDepth===filter.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+inDepth+") must match input depth for filter "+filter.shape[3]+"."}),util.assert(outDepth===filter.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+outDepth+") must match output depth for filter "+filter.shape[4]+"."});var convInfo=conv_util.computeConv3DInfo(xShape5D,filter.shape,strides,1,pad),res=engine_1.ENGINE.runKernel(function(backend){return backend.conv3dDerInput(dy5D,filter,convInfo)},{dy5D:dy5D});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}exports.conv1d=operation_1.op({conv1d_:function(x,filter,stride,pad,dataFormat,dilation,dimRoundingMode){void 0===dataFormat&&(dataFormat="NWC"),void 0===dilation&&(dilation=1);var $x=tensor_util_env_1.convertToTensor(x,"x","conv1d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv1d"),x3D=$x,reshapedTo3D=!1;2===$x.rank&&(reshapedTo3D=!0,x3D=$x.as3D(1,$x.shape[0],$x.shape[1])),util.assert(3===x3D.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+x3D.rank+"."}),util.assert(3===$filter.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+$filter.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}),util.assert(x3D.shape[2]===$filter.shape[1],function(){return"Error in conv1d: depth of input ("+x3D.shape[2]+") must match input depth for filter "+$filter.shape[1]+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(stride,dilation),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+stride+" and dilation '"+dilation+"'"}),util.assert("NWC"===dataFormat,function(){return"Error in conv1d: got dataFormat of "+dataFormat+" but only NWC is currently supported."});var filter4D=$filter.as4D(1,$filter.shape[0],$filter.shape[1],$filter.shape[2]),input4D=x3D.as4D(x3D.shape[0],1,x3D.shape[1],x3D.shape[2]),strides=[1,stride],dilations=[1,dilation],res=exports.conv2d(input4D,filter4D,strides,pad,"NHWC",dilations,dimRoundingMode);return reshapedTo3D?res.as2D(res.shape[2],res.shape[3]):res.as3D(res.shape[0],res.shape[2],res.shape[3])}}),exports.conv2d=operation_1.op({conv2d_:function(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","conv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$filter.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+$filter.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var inDepth="NHWC"===dataFormat?x4D.shape[3]:x4D.shape[1];util.assert(inDepth===$filter.shape[2],function(){return"Error in conv2d: depth of input ("+inDepth+") must match input depth for filter "+$filter.shape[2]+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var $dataFormat=conv_util.convertConv2DDataFormat(dataFormat),convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!1,$dataFormat),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.conv2d(x4D,$filter,convInfo);return save([$filter,x4D]),res},{x:x4D,$filter:$filter},function(dy,saved){var _a=saved,$filter=_a[0],x4D=_a[1];return util.assert(conv_util.tupleValuesAreOne(dilations),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"}),{x:function(){return conv2dDerInput_(x4D.shape,dy,$filter,strides,pad,dataFormat)},$filter:function(){return conv2dDerFilter_(x4D,dy,$filter.shape,strides,pad,dataFormat)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.conv3d=operation_1.op({conv3d_:function(x,filter,strides,pad,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC"),void 0===dilations&&(dilations=[1,1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","conv3d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv3d"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),util.assert(5===x5D.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+x5D.rank+"."}),util.assert(5===$filter.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+$filter.rank+"."}),util.assert(x5D.shape[4]===$filter.shape[3],function(){return"Error in conv3d: depth of input ("+x5D.shape[4]+") must match input depth for filter "+$filter.shape[3]+"."}),util.assert(function(strides,dilations){return tupleValuesAreOne(strides)||tupleValuesAreOne(dilations)}(strides,dilations),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),util.assert("NDHWC"===dataFormat,function(){return"Error in conv3d: got dataFormat of "+dataFormat+" but only NDHWC is currently supported."});var convInfo=conv_util.computeConv3DInfo(x5D.shape,$filter.shape,strides,dilations,pad),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.conv3d(x5D,$filter,convInfo);return save([x5D,$filter]),res},{x:x5D,$filter:$filter},function(dy,saved){util.assert(tupleValuesAreOne(dilations),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"});var x5D=saved[0],$filter=saved[1];return{x:function(){return conv3dDerInput_(x5D.shape,dy,$filter,strides,pad)},$filter:function(){return function(x,dy,filterShape,strides,pad){var x5D=x;4===x.rank&&(x5D=x.as5D(1,x.shape[0],x.shape[1],x.shape[2],x.shape[3]));var dy5D=dy;4===dy5D.rank&&(dy5D=dy.as5D(1,dy.shape[0],dy.shape[1],dy.shape[2],dy.shape[3]));util.assert(5===x5D.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+x5D.shape+"."}),util.assert(5===dy5D.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+dy5D.shape+"."}),util.assert(5===filterShape.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+filterShape+"."}),util.assert(x5D.shape[4]===filterShape[3],function(){return"Error in conv3dDerFilter: depth of input "+x5D.shape[4]+") must match input depth in filter ("+filterShape[3]+"."}),util.assert(dy5D.shape[4]===filterShape[4],function(){return"Error in conv3dDerFilter: depth of dy ("+dy5D.shape[4]+") must match output depth for filter ("+filterShape[4]+")."});var convInfo=conv_util.computeConv3DInfo(x5D.shape,filterShape,strides,1,pad);return engine_1.ENGINE.runKernel(function(backend){return backend.conv3dDerFilter(x5D,dy5D,convInfo)},{x5D:x5D,dy5D:dy5D})}(x5D,dy,$filter.shape,strides,pad)}}});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}}),exports.conv2dDerFilter=operation_1.op({conv2dDerFilter_:conv2dDerFilter_}),exports.conv2dDerInput=operation_1.op({conv2dDerInput_:conv2dDerInput_}),exports.depthwiseConv2d=operation_1.op({depthwiseConv2d_:function(x,filter,strides,pad,dataFormat,dilations,dimRoundingMode){void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]);var $x=tensor_util_env_1.convertToTensor(x,"x","depthwiseConv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","depthwiseConv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$filter.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+$filter.rank+"."}),util.assert(x4D.shape[3]===$filter.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+x4D.shape[3]+") must match the inChannels dimension in filter "+$filter.shape[2]+"."}),null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode,!0),res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.depthwiseConv2D(x4D,$filter,convInfo);return save([x4D,$filter]),res},{x:x4D,$filter:$filter},function(dy,saved){util.assert(conv_util.tupleValuesAreOne(dilations),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+dilations+"'"});var x4D=saved[0],$filter=saved[1];return{x:function(){return function(xShape,dy,filter,convInfo){var dy4D=dy,reshapedTo4D=!1;3===dy.rank&&(reshapedTo4D=!0,dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]));var res=engine_1.ENGINE.runKernel(function(backend){return backend.depthwiseConv2DDerInput(dy4D,filter,convInfo)},{dy4D:dy4D});if(reshapedTo4D)return res.as3D(res.shape[1],res.shape[2],res.shape[3]);return res}(x4D.shape,dy,$filter,convInfo)},$filter:function(){return function(x,dy,filterShape,convInfo){var x4D=x;3===x.rank&&(x4D=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]));var dy4D=dy;3===dy4D.rank&&(dy4D=dy.as4D(1,dy.shape[0],dy.shape[1],dy.shape[2]));return engine_1.ENGINE.runKernel(function(backend){return backend.depthwiseConv2DDerFilter(x4D,dy4D,convInfo)},{x4D:x4D,dy4D:dy4D})}(x4D,dy,$filter.shape,convInfo)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.separableConv2d=operation_1.op({separableConv2d_:function(x,depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat){void 0===dilation&&(dilation=[1,1]),void 0===dataFormat&&(dataFormat="NHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","separableConv2d"),$depthwiseFilter=tensor_util_env_1.convertToTensor(depthwiseFilter,"depthwiseFilter","separableConv2d"),$pointwiseFilter=tensor_util_env_1.convertToTensor(pointwiseFilter,"pointwiseFilter","separableConv2d"),x4D=$x,reshapedTo4D=!1;if(3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),"NCHW"===dataFormat)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");util.assert(4===x4D.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$depthwiseFilter.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+$depthwiseFilter.rank+"."}),util.assert(4===$pointwiseFilter.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+$depthwiseFilter.rank+"."}),util.assert(1===$pointwiseFilter.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+$pointwiseFilter.shape[0]+"."}),util.assert(1===$pointwiseFilter.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+$pointwiseFilter.shape[1]+"."});var inChannels=$depthwiseFilter.shape[2],channelMultiplier=$depthwiseFilter.shape[3];util.assert($pointwiseFilter.shape[2]===inChannels*channelMultiplier,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+inChannels*channelMultiplier+", but got "+$pointwiseFilter.shape[2]+"."});var depthwise=exports.depthwiseConv2d(x4D,$depthwiseFilter,strides,pad,dataFormat,dilation),res=exports.conv2d(depthwise,$pointwiseFilter,1,"valid",dataFormat);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.conv2dTranspose=operation_1.op({conv2dTranspose_:function(x,filter,outputShape,strides,pad,dimRoundingMode){return conv2dDerInput_(outputShape,tensor_util_env_1.convertToTensor(x,"x","conv2dTranspose"),tensor_util_env_1.convertToTensor(filter,"filter","conv2dTranspose"),strides,pad,"NHWC",dimRoundingMode)}}),exports.conv3dTranspose=operation_1.op({conv3dTranspose_:function(x,filter,outputShape,strides,pad){return conv3dDerInput_(outputShape,tensor_util_env_1.convertToTensor(x,"x","conv3dTranspose"),tensor_util_env_1.convertToTensor(filter,"filter","conv3dTranspose"),strides,pad)}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./conv_util":177,"./operation":195}],177:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computeConv2DInfo(inShape,filterShape,strides,dilations,pad,roundingMode,depthwise,dataFormat){void 0===depthwise&&(depthwise=!1),void 0===dataFormat&&(dataFormat="channelsLast");var _a=[-1,-1,-1,-1],batchSize=_a[0],inHeight=_a[1],inWidth=_a[2],inChannels=_a[3];if("channelsLast"===dataFormat)batchSize=inShape[0],inHeight=inShape[1],inWidth=inShape[2],inChannels=inShape[3];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);batchSize=inShape[0],inChannels=inShape[1],inHeight=inShape[2],inWidth=inShape[3]}var outShape,filterHeight=filterShape[0],filterWidth=filterShape[1],filterChannels=filterShape[3],_b=parseTupleParam(strides),strideHeight=_b[0],strideWidth=_b[1],_c=parseTupleParam(dilations),dilationHeight=_c[0],dilationWidth=_c[1],effectiveFilterHeight=getEffectiveFilterSize(filterHeight,dilationHeight),effectiveFilterWidth=getEffectiveFilterSize(filterWidth,dilationWidth),_d=function(pad,inHeight,inWidth,strideHeight,strideWidth,filterHeight,filterWidth,roundingMode){var padInfo,outHeight,outWidth;if("number"==typeof pad){padInfo={top:pad,bottom:pad,left:pad,right:pad,type:0===pad?"VALID":"NUMBER"};var outShape=function(inShape,fieldSize,stride,zeroPad,roundingMode){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputRows=inShape[0],inputCols=inShape[1],outputRows=conditionalRound((inputRows-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputRows),function(){return"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters"});var outputCols=conditionalRound((inputCols-fieldSize+2*zeroPad)/stride+1,roundingMode);return util.assert(util.isInt(outputCols),function(){return"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"}),[outputRows,outputCols]}([inHeight,inWidth],filterHeight,strideHeight,pad,roundingMode);outHeight=outShape[0],outWidth=outShape[1]}else if("same"===pad){outHeight=Math.ceil(inHeight/strideHeight),outWidth=Math.ceil(inWidth/strideWidth);var padAlongHeight=Math.max(0,(outHeight-1)*strideHeight+filterHeight-inHeight),padAlongWidth=Math.max(0,(outWidth-1)*strideWidth+filterWidth-inWidth),top_1=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_1,left=Math.floor(padAlongWidth/2);padInfo={top:top_1,bottom:bottom,left:left,right:padAlongWidth-left,type:"SAME"}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);padInfo={top:0,bottom:0,left:0,right:0,type:"VALID"},outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth)}return{padInfo:padInfo,outHeight:outHeight,outWidth:outWidth}}(pad,inHeight,inWidth,strideHeight,strideWidth,effectiveFilterHeight,effectiveFilterWidth,roundingMode),padInfo=_d.padInfo,outHeight=_d.outHeight,outWidth=_d.outWidth,outChannels=depthwise?filterChannels*inChannels:filterChannels;return"channelsFirst"===dataFormat?outShape=[batchSize,outChannels,outHeight,outWidth]:"channelsLast"===dataFormat&&(outShape=[batchSize,outHeight,outWidth,outChannels]),{batchSize:batchSize,dataFormat:dataFormat,inHeight:inHeight,inWidth:inWidth,inChannels:inChannels,outHeight:outHeight,outWidth:outWidth,outChannels:outChannels,padInfo:padInfo,strideHeight:strideHeight,strideWidth:strideWidth,filterHeight:filterHeight,filterWidth:filterWidth,effectiveFilterHeight:effectiveFilterHeight,effectiveFilterWidth:effectiveFilterWidth,dilationHeight:dilationHeight,dilationWidth:dilationWidth,inShape:inShape,outShape:outShape,filterShape:filterShape}}function computeConv3DInfo(inShape,filterShape,strides,dilations,pad,depthwise,dataFormat,roundingMode){void 0===depthwise&&(depthwise=!1),void 0===dataFormat&&(dataFormat="channelsLast");var _a=[-1,-1,-1,-1,-1],batchSize=_a[0],inDepth=_a[1],inHeight=_a[2],inWidth=_a[3],inChannels=_a[4];if("channelsLast"===dataFormat)batchSize=inShape[0],inDepth=inShape[1],inHeight=inShape[2],inWidth=inShape[3],inChannels=inShape[4];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);batchSize=inShape[0],inChannels=inShape[1],inDepth=inShape[2],inHeight=inShape[3],inWidth=inShape[4]}var outShape,filterDepth=filterShape[0],filterHeight=filterShape[1],filterWidth=filterShape[2],filterChannels=filterShape[4],_b=parse3TupleParam(strides),strideDepth=_b[0],strideHeight=_b[1],strideWidth=_b[2],_c=parse3TupleParam(dilations),dilationDepth=_c[0],dilationHeight=_c[1],dilationWidth=_c[2],effectiveFilterDepth=getEffectiveFilterSize(filterDepth,dilationDepth),effectiveFilterHeight=getEffectiveFilterSize(filterHeight,dilationHeight),effectiveFilterWidth=getEffectiveFilterSize(filterWidth,dilationWidth),_d=function(pad,inDepth,inHeight,inWidth,strideDepth,strideHeight,strideWidth,filterDepth,filterHeight,filterWidth,roundingMode){var padInfo,outDepth,outHeight,outWidth;if("number"==typeof pad){padInfo={top:pad,bottom:pad,left:pad,right:pad,front:pad,back:pad,type:0===pad?"VALID":"NUMBER"};var outShape=function(inShape,fieldSize,outChannels,stride,zeroPad,roundingMode){null==zeroPad&&(zeroPad=computeDefaultPad(inShape,fieldSize,stride));var inputDepth=inShape[0],inputRows=inShape[1],inputCols=inShape[2],outputDepths=conditionalRound((inputDepth-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputDepths),function(){return"The output # of depths ("+outputDepths+") must be an integer. Change the stride and/or zero pad parameters"});var outputRows=conditionalRound((inputRows-fieldSize+2*zeroPad)/stride+1,roundingMode);util.assert(util.isInt(outputRows),function(){return"The output # of rows ("+outputRows+") must be an integer. Change the stride and/or zero pad parameters"});var outputCols=conditionalRound((inputCols-fieldSize+2*zeroPad)/stride+1,roundingMode);return util.assert(util.isInt(outputCols),function(){return"The output # of columns ("+outputCols+") must be an integer. Change the stride and/or zero pad parameters"}),[outputDepths,outputRows,outputCols,outChannels]}([inDepth,inHeight,inWidth,1],filterDepth,1,strideDepth,pad,roundingMode);outDepth=outShape[0],outHeight=outShape[1],outWidth=outShape[2]}else if("same"===pad){outDepth=Math.ceil(inDepth/strideDepth),outHeight=Math.ceil(inHeight/strideHeight),outWidth=Math.ceil(inWidth/strideWidth);var padAlongDepth=(outDepth-1)*strideDepth+filterDepth-inDepth,padAlongHeight=(outHeight-1)*strideHeight+filterHeight-inHeight,padAlongWidth=(outWidth-1)*strideWidth+filterWidth-inWidth,front=Math.floor(padAlongDepth/2),back=padAlongDepth-front,top_2=Math.floor(padAlongHeight/2),bottom=padAlongHeight-top_2,left=Math.floor(padAlongWidth/2);padInfo={top:top_2,bottom:bottom,left:left,right:padAlongWidth-left,front:front,back:back,type:"SAME"}}else{if("valid"!==pad)throw Error("Unknown padding parameter: "+pad);padInfo={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},outDepth=Math.ceil((inDepth-filterDepth+1)/strideDepth),outHeight=Math.ceil((inHeight-filterHeight+1)/strideHeight),outWidth=Math.ceil((inWidth-filterWidth+1)/strideWidth)}return{padInfo:padInfo,outDepth:outDepth,outHeight:outHeight,outWidth:outWidth}}(pad,inDepth,inHeight,inWidth,strideDepth,strideHeight,strideWidth,effectiveFilterDepth,effectiveFilterHeight,effectiveFilterWidth,roundingMode),padInfo=_d.padInfo,outDepth=_d.outDepth,outHeight=_d.outHeight,outWidth=_d.outWidth,outChannels=depthwise?filterChannels*inChannels:filterChannels;return"channelsFirst"===dataFormat?outShape=[batchSize,outChannels,outDepth,outHeight,outWidth]:"channelsLast"===dataFormat&&(outShape=[batchSize,outDepth,outHeight,outWidth,outChannels]),{batchSize:batchSize,dataFormat:dataFormat,inDepth:inDepth,inHeight:inHeight,inWidth:inWidth,inChannels:inChannels,outDepth:outDepth,outHeight:outHeight,outWidth:outWidth,outChannels:outChannels,padInfo:padInfo,strideDepth:strideDepth,strideHeight:strideHeight,strideWidth:strideWidth,filterDepth:filterDepth,filterHeight:filterHeight,filterWidth:filterWidth,effectiveFilterDepth:effectiveFilterDepth,effectiveFilterHeight:effectiveFilterHeight,effectiveFilterWidth:effectiveFilterWidth,dilationDepth:dilationDepth,dilationHeight:dilationHeight,dilationWidth:dilationWidth,inShape:inShape,outShape:outShape,filterShape:filterShape}}function computeDefaultPad(inputShape,fieldSize,stride,dilation){void 0===dilation&&(dilation=1);var effectiveFieldSize=getEffectiveFilterSize(fieldSize,dilation);return Math.floor((inputShape[0]*(stride-1)-stride+effectiveFieldSize)/2)}function parseTupleParam(param){return"number"==typeof param?[param,param,param]:2===param.length?[param[0],param[1],1]:param}function parse3TupleParam(param){return"number"==typeof param?[param,param,param]:param}function getEffectiveFilterSize(filterSize,dilation){return dilation<=1?filterSize:filterSize+(filterSize-1)*(dilation-1)}function conditionalRound(value,roundingMode){if(!roundingMode)return value;switch(roundingMode){case"round":return Math.round(value);case"ceil":return Math.ceil(value);case"floor":return Math.floor(value);default:throw new Error("Unknown roundingMode "+roundingMode)}}function tupleValuesAreOne(param){var _a=parseTupleParam(param),dimA=_a[0],dimB=_a[1],dimC=_a[2];return 1===dimA&&1===dimB&&1===dimC}exports.computePool2DInfo=function(inShape,filterSize,strides,dilations,pad,roundingMode,dataFormat){void 0===dataFormat&&(dataFormat="channelsLast");var filterShape,_a=parseTupleParam(filterSize),filterHeight=_a[0],filterWidth=_a[1];if("channelsLast"===dataFormat)filterShape=[filterHeight,filterWidth,inShape[3],inShape[3]];else{if("channelsFirst"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);filterShape=[filterHeight,filterWidth,inShape[1],inShape[1]]}return computeConv2DInfo(inShape,filterShape,strides,dilations,pad,roundingMode,!1,dataFormat)},exports.computePool3DInfo=function(inShape,filterSize,strides,dilations,pad,roundingMode,dataFormat){void 0===dataFormat&&(dataFormat="NDHWC");var filterShape,$dataFormat,_a=parse3TupleParam(filterSize),filterDepth=_a[0],filterHeight=_a[1],filterWidth=_a[2];if("NDHWC"===dataFormat)$dataFormat="channelsLast",filterShape=[filterDepth,filterHeight,filterWidth,inShape[4],inShape[4]];else{if("NCDHW"!==dataFormat)throw new Error("Unknown dataFormat "+dataFormat);$dataFormat="channelsFirst",filterShape=[filterDepth,filterHeight,filterWidth,inShape[1],inShape[1]]}return computeConv3DInfo(inShape,filterShape,strides,dilations,pad,!1,$dataFormat,roundingMode)},exports.computeConv2DInfo=computeConv2DInfo,exports.computeConv3DInfo=computeConv3DInfo,exports.computeDefaultPad=computeDefaultPad,exports.tupleValuesAreOne=tupleValuesAreOne,exports.eitherStridesOrDilationsAreOne=function(strides,dilations){return tupleValuesAreOne(strides)||tupleValuesAreOne(dilations)},exports.convertConv2DDataFormat=function(dataFormat){if("NHWC"===dataFormat)return"channelsLast";if("NCHW"===dataFormat)return"channelsFirst";throw new Error("Unknown dataFormat "+dataFormat)}},{"../util":241}],178:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.diag=operation_1.op({diag_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","diag").flatten(),outShape=x.shape.concat(x.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.diag($x)},{$x:$x}).reshape(outShape)}})},{"../engine":143,"../tensor_util_env":237,"./operation":195}],179:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),dropout_util_1=require("./dropout_util"),operation_1=require("./operation");exports.dropout=operation_1.op({dropout_:function(x,rate,noiseShape,seed){var $x=tensor_util_env_1.convertToTensor(x,"x","dropout");if(util.assert("float32"===$x.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+$x.dtype+" tensor instead."}),util.assert(0<=rate&&rate<1,function(){return"rate must be a float in the range [0, 1), but got "+rate+"."}),0===rate)return x instanceof tensor_1.Tensor?$x.clone():$x;var $noiseShape=dropout_util_1.getNoiseShape($x,noiseShape),keepProb=1-rate,multiplier=array_ops_1.randomUniform($noiseShape,0,1,"float32",seed).add(keepProb).floor().div(keepProb);return $x.mul(multiplier)}})},{"../tensor":234,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./dropout_util":180,"./operation":195}],180:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");exports.getNoiseShape=function(x,noiseShape){if(null==noiseShape)return x.shape.slice();if(util.arraysEqual(x.shape,noiseShape))return noiseShape;if(x.shape.length!==noiseShape.length)return noiseShape;for(var newDimension=[],i=0;i<x.shape.length;i++)null==noiseShape[i]&&null!=x.shape[i]?newDimension.push(x.shape[i]):newDimension.push(noiseShape[i]);return newDimension}},{"../util":241}],181:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ERF_P=.3275911,exports.ERF_A1=.254829592,exports.ERF_A2=-.284496736,exports.ERF_A3=1.421413741,exports.ERF_A4=-1.453152027,exports.ERF_A5=1.061405429},{}],182:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),conv_1=require("../ops/conv"),conv_util=require("../ops/conv_util"),operation_1=require("../ops/operation"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),broadcast_util=require("./broadcast_util");exports.matMul=operation_1.op({matMul_:function(_a){var _e,a=_a.a,b=_a.b,_b=_a.transposeA,transposeA=void 0!==_b&&_b,_c=_a.transposeB,transposeB=void 0!==_c&&_c,bias=_a.bias,_d=_a.activation,activation=void 0===_d?"linear":_d,preluActivationWeights=_a.preluActivationWeights,$a=tensor_util_env_1.convertToTensor(a,"a","fused matMul"),$b=tensor_util_env_1.convertToTensor(b,"b","fused matMul");_e=tensor_util_1.makeTypesMatch($a,$b),$a=_e[0],$b=_e[1];var innerShapeA=transposeA?$a.shape[$a.rank-2]:$a.shape[$a.rank-1],innerShapeB=transposeB?$b.shape[$b.rank-1]:$b.shape[$b.rank-2],outerShapeA=transposeA?$a.shape[$a.rank-1]:$a.shape[$a.rank-2],outerShapeB=transposeB?$b.shape[$b.rank-2]:$b.shape[$b.rank-1],outerDimsA=$a.shape.slice(0,-2),outerDimsB=$b.shape.slice(0,-2),batchDimA=util.sizeFromShape(outerDimsA),batchDimB=util.sizeFromShape(outerDimsB);util.assert(2<=$a.rank&&2<=$b.rank&&$a.rank===$b.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+$a.rank+" and "+$b.rank+"."}),util.assert(util.arraysEqual(outerDimsA,outerDimsB),function(){return"Error in fused matMul: outer dimensions ("+outerDimsA+") and ("+outerDimsB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" must match."}),util.assert(innerShapeA===innerShapeB,function(){return"Error in fused matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" and transposeA="+transposeA+" and transposeB="+transposeB+" must match."});var $bias,$preluActivationWeights,outShape=$a.shape.slice(0,-2).concat([outerShapeA,outerShapeB]),a3D=transposeA?$a.as3D(batchDimA,innerShapeA,outerShapeA):$a.as3D(batchDimA,outerShapeA,innerShapeA),b3D=transposeB?$b.as3D(batchDimB,outerShapeB,innerShapeB):$b.as3D(batchDimB,innerShapeB,outerShapeB);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused matMul"),$bias=tensor_util_1.makeTypesMatch($bias,$a)[0],broadcast_util.assertAndGetBroadcastShape(outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused matMul"));var inputs={$a:a3D,$b:b3D};return null!=bias&&(inputs.$bias=$bias),null!=preluActivationWeights&&(inputs.$preluActivationWeights=$preluActivationWeights),engine_1.ENGINE.runKernel(function(backend,save){var y=backend.fusedBatchMatMul({a:a3D,b:b3D,transposeA:transposeA,transposeB:transposeB,bias:$bias,activation:activation,preluActivationWeights:$preluActivationWeights});return save([a3D,b3D,y]),y},inputs,function(dy,saved){var dyActivation,a3D=saved[0],b3D=saved[1],y=saved[2];if(null==activation||"linear"===activation)dyActivation=dy;else{if("relu"!==activation)throw new Error("Gradient for activation "+activation+" has not been implemented yet.");dyActivation=dy.mul(y.step())}var biasGradient={};return null!=bias&&(biasGradient={$bias:function(){var res=dyActivation,reduceAxes=broadcast_util.getReductionAxes($bias.shape,dyActivation.shape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($bias.shape)}}),transposeA||transposeB?!transposeA&&transposeB?Object.assign({$a:function(){return dyActivation.matMul(b3D,!1,!1)},$b:function(){return dyActivation.matMul(a3D,!0,!1)}},biasGradient):transposeA&&!transposeB?Object.assign({$a:function(){return b3D.matMul(dyActivation,!1,!0)},$b:function(){return a3D.matMul(dyActivation,!1,!1)}},biasGradient):Object.assign({$a:function(){return b3D.matMul(dyActivation,!0,!0)},$b:function(){return dyActivation.matMul(a3D,!0,!0)}},biasGradient):Object.assign({$a:function(){return dyActivation.matMul(b3D,!1,!0)},$b:function(){return a3D.matMul(dyActivation,!0,!1)}},biasGradient)}).reshape(outShape)}}),exports.conv2d=operation_1.op({conv2d_:function(_a){var x=_a.x,filter=_a.filter,strides=_a.strides,pad=_a.pad,_b=_a.dataFormat,dataFormat=void 0===_b?"NHWC":_b,_c=_a.dilations,dilations=void 0===_c?[1,1]:_c,dimRoundingMode=_a.dimRoundingMode,bias=_a.bias,_d=_a.activation,activation=void 0===_d?"linear":_d,preluActivationWeights=_a.preluActivationWeights,$x=tensor_util_env_1.convertToTensor(x,"x","conv2d"),$filter=tensor_util_env_1.convertToTensor(filter,"filter","conv2d"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+x4D.rank+"."}),util.assert(4===$filter.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+$filter.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."}),util.assert(x4D.shape[3]===$filter.shape[2],function(){return"Error in conv2d: depth of input ("+x4D.shape[3]+") must match input depth for filter "+$filter.shape[2]+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),util.assert("NHWC"===dataFormat,function(){return"Error in conv2d: got dataFormat of "+dataFormat+" but only NHWC is currently supported."});var $bias,$preluActivationWeights,convInfo=conv_util.computeConv2DInfo(x4D.shape,$filter.shape,strides,dilations,pad,dimRoundingMode);null!=bias&&($bias=tensor_util_env_1.convertToTensor(bias,"bias","fused conv2d"),$bias=tensor_util_1.makeTypesMatch($bias,$x)[0],broadcast_util.assertAndGetBroadcastShape(convInfo.outShape,$bias.shape)),null!=preluActivationWeights&&($preluActivationWeights=tensor_util_env_1.convertToTensor(preluActivationWeights,"prelu weights","fused conv2d"));var inputs={x:x4D,$filter:$filter};null!=bias&&(inputs.$bias=$bias),null!=preluActivationWeights&&(inputs.$preluActivationWeights=$preluActivationWeights);var res=engine_1.ENGINE.runKernel(function(backend,save){var res=backend.fusedConv2d(x4D,$filter,convInfo,$bias,activation,$preluActivationWeights);return save([$filter,x4D,res]),res},inputs,function(dy,saved){var dyActivation,_a=saved,$filter=_a[0],x4D=_a[1],y=_a[2];if(null==activation||"linear"===activation)dyActivation=dy;else{if("relu"!==activation)throw new Error("Gradient for activation "+activation+" has not been implemented yet.");dyActivation=dy.mul(y.step())}util.assert(conv_util.tupleValuesAreOne(dilations),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+dilations+"'"});var biasGradient={};return null!=bias&&(biasGradient={$bias:function(){var res=dyActivation,reduceAxes=broadcast_util.getReductionAxes($bias.shape,dyActivation.shape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($bias.shape)}}),Object.assign({x:function(){return conv_1.conv2dDerInput(x4D.shape,dyActivation,$filter,strides,pad)},$filter:function(){return conv_1.conv2dDerFilter(x4D,dyActivation,$filter.shape,strides,pad)}},biasGradient)});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}})},{"../engine":143,"../ops/conv":176,"../ops/conv_util":177,"../ops/operation":195,"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./broadcast_util":169}],183:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.gatherND=operation_1.op({gatherND_:function(x,indices){var $indices=tensor_util_env_1.convertToTensor(indices,"indices","gatherND","int32"),$x=tensor_util_env_1.convertToTensor(x,"x","gatherND");return engine_1.ENGINE.runKernel(function(backend){return backend.gatherND($x,$indices)},{$x:$x,$indices:$indices})}})},{"../engine":143,"../tensor_util_env":237,"./operation":195}],184:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.prepareAndValidate=function(tensor,indices){if(tensor.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+tensor.rank+".");if(indices.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+indices.rank+".");if("int32"!==indices.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+indices.dtype+".");if(indices.shape[indices.rank-1]>tensor.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+indices.shape[indices.rank-1]+" vs. "+tensor.rank);if(0===tensor.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+tensor.shape+".");for(var indicesShape=indices.shape,sliceRank=indicesShape[indicesShape.length-1],nResult=1,i=0;i<indicesShape.length-1;++i)nResult*=indicesShape[i];var inputShape=tensor.shape,resultShape=indicesShape.slice();resultShape.pop();var sliceSize=1;for(i=sliceRank;i<tensor.rank;++i)sliceSize*=inputShape[i],resultShape.push(inputShape[i]);var strides=util_1.computeStrides(tensor.shape).map(function(stride){return stride/sliceSize}).concat([1]).slice(0,sliceRank);return[resultShape,nResult,sliceSize,strides]}},{"../util":241}],185:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var non_max_suppression_impl_1=require("../backends/non_max_suppression_impl"),engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");function nonMaxSuppSanityCheck(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){null==iouThreshold&&(iouThreshold=.5),null==scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY);var numBoxes=boxes.shape[0];return maxOutputSize=Math.min(maxOutputSize,numBoxes),util.assert(0<=iouThreshold&&iouThreshold<=1,function(){return"iouThreshold must be in [0, 1], but was '"+iouThreshold+"'"}),util.assert(2===boxes.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+boxes.rank+"'"}),util.assert(4===boxes.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+boxes.shape[1]}),util.assert(1===scores.rank,function(){return"scores must be a 1D tensor"}),util.assert(scores.shape[0]===numBoxes,function(){return"scores has incompatible shape with boxes. Expected "+numBoxes+", but was "+scores.shape[0]}),{maxOutputSize:maxOutputSize,iouThreshold:iouThreshold,scoreThreshold:scoreThreshold}}exports.resizeBilinear=operation_1.op({resizeBilinear_:function(images,size,alignCorners){void 0===alignCorners&&(alignCorners=!1);var $images=tensor_util_env_1.convertToTensor(images,"images","resizeBilinear");util.assert(3===$images.rank||4===$images.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+$images.rank+"."}),util.assert(2===size.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+size+"."});var batchImages=$images,reshapedTo4D=!1;3===$images.rank&&(reshapedTo4D=!0,batchImages=$images.as4D(1,$images.shape[0],$images.shape[1],$images.shape[2]));var newHeight=size[0],newWidth=size[1],res=engine_1.ENGINE.runKernel(function(backend,save){return save([batchImages]),backend.resizeBilinear(batchImages,newHeight,newWidth,alignCorners)},{batchImages:batchImages},function(dy,saved){return{batchImages:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.resizeBilinearBackprop(dy,saved[0],alignCorners)},{})}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.resizeNearestNeighbor=operation_1.op({resizeNearestNeighbor_:function(images,size,alignCorners){void 0===alignCorners&&(alignCorners=!1);var $images=tensor_util_env_1.convertToTensor(images,"images","resizeNearestNeighbor");util.assert(3===$images.rank||4===$images.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+$images.rank+"."}),util.assert(2===size.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+size+"."}),util.assert("float32"===$images.dtype||"int32"===$images.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var batchImages=$images,reshapedTo4D=!1;3===$images.rank&&(reshapedTo4D=!0,batchImages=$images.as4D(1,$images.shape[0],$images.shape[1],$images.shape[2]));var newHeight=size[0],newWidth=size[1],res=engine_1.ENGINE.runKernel(function(backend,save){return save([batchImages]),backend.resizeNearestNeighbor(batchImages,newHeight,newWidth,alignCorners)},{batchImages:batchImages},function(dy,saved){return{batchImages:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.resizeNearestNeighborBackprop(dy,saved[0],alignCorners)},{})}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.nonMaxSuppression=operation_1.op({nonMaxSuppression_:function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY);var $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppression"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppression"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold);return maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold,engine_1.ENGINE.runKernel(function(b){return b.nonMaxSuppression($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold)},{$boxes:$boxes})}}),exports.nonMaxSuppressionAsync=function(boxes,scores,maxOutputSize,iouThreshold,scoreThreshold){return void 0===iouThreshold&&(iouThreshold=.5),void 0===scoreThreshold&&(scoreThreshold=Number.NEGATIVE_INFINITY),__awaiter(this,void 0,void 0,function(){var $boxes,$scores,inputs,boxesVals,scoresVals,res;return __generator(this,function(_a){switch(_a.label){case 0:return $boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","nonMaxSuppressionAsync"),$scores=tensor_util_env_1.convertToTensor(scores,"scores","nonMaxSuppressionAsync"),inputs=nonMaxSuppSanityCheck($boxes,$scores,maxOutputSize,iouThreshold,scoreThreshold),maxOutputSize=inputs.maxOutputSize,iouThreshold=inputs.iouThreshold,scoreThreshold=inputs.scoreThreshold,[4,$boxes.data()];case 1:return boxesVals=_a.sent(),[4,$scores.data()];case 2:return scoresVals=_a.sent(),res=non_max_suppression_impl_1.nonMaxSuppressionImpl(boxesVals,scoresVals,maxOutputSize,iouThreshold,scoreThreshold),$boxes!==boxes&&$boxes.dispose(),$scores!==scores&&$scores.dispose(),[2,res]}})})},exports.cropAndResize=operation_1.op({cropAndResize_:function(image,boxes,boxInd,cropSize,method,extrapolationValue){var $image=tensor_util_env_1.convertToTensor(image,"image","cropAndResize","float32"),$boxes=tensor_util_env_1.convertToTensor(boxes,"boxes","cropAndResize","float32"),$boxInd=tensor_util_env_1.convertToTensor(boxInd,"boxInd","cropAndResize","int32");method=method||"bilinear",extrapolationValue=extrapolationValue||0;var numBoxes=$boxes.shape[0];return util.assert(4===$image.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+$image.rank+"."}),util.assert(2===$boxes.rank&&4===$boxes.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+numBoxes+",4] but had shape "+$boxes.shape+"."}),util.assert(1===$boxInd.rank&&$boxInd.shape[0]===numBoxes,function(){return"Error in cropAndResize: boxInd must be have size ["+numBoxes+"] but had shape "+$boxes.shape+"."}),util.assert(2===cropSize.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+cropSize.length+"."}),util.assert(1<=cropSize[0]&&1<=cropSize[1],function(){return"cropSize must be atleast [1,1], but was "+cropSize}),util.assert("bilinear"===method||"nearest"===method,function(){return"method must be bilinear or nearest, but was "+method}),engine_1.ENGINE.runKernel(function(backend,save){return backend.cropAndResize($image,$boxes,$boxInd,cropSize,method,extrapolationValue)},{$image:$image,$boxes:$boxes})}})},{"../backends/non_max_suppression_impl":54,"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],186:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),tensor_ops_1=require("./tensor_ops");exports.inTopKAsync=function(predictions,targets,k){return void 0===k&&(k=1),__awaiter(this,void 0,void 0,function(){var $predictions,$targets,lastDim,predictionsVals,targetsVals,_a,batch,size,precision,b,offset,vals,valAndInd,i;return __generator(this,function(_b){switch(_b.label){case 0:return $predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","inTopK"),$targets=tensor_util_env_1.convertToTensor(targets,"targets","inTopK"),util_1.assert(1<$predictions.rank,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+$predictions.rank}),util_1.assert($predictions.rank-1===$targets.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+$predictions.rank+" and targets rank "+$targets.rank}),util_1.assertShapesMatch($predictions.shape.slice(0,$predictions.shape.length-1),$targets.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),lastDim=$predictions.shape[$predictions.shape.length-1],util_1.assert(0<k&&k<=lastDim,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+lastDim+"), but got "+k}),[4,$predictions.data()];case 1:return predictionsVals=_b.sent(),[4,$targets.data()];case 2:for(targetsVals=_b.sent(),_a=[predictionsVals.length/lastDim,lastDim],batch=_a[0],size=_a[1],precision=util_1.getTypedArrayFromDType("bool",batch),b=0;b<batch;b++){for(offset=b*size,vals=predictionsVals.subarray(offset,offset+size),valAndInd=[],i=0;i<vals.length;i++)valAndInd.push({value:vals[i],index:i});for(valAndInd.sort(function(a,b){return b.value-a.value}),precision[b]=0,i=0;i<k;i++)if(valAndInd[i].index===targetsVals[b]){precision[b]=1;break}}return predictions!==$predictions&&$predictions.dispose(),targets!==$targets&&$targets.dispose(),[2,tensor_ops_1.tensor(precision,$targets.shape,"bool")]}})})}},{"../tensor_util_env":237,"../util":241,"./tensor_ops":216}],187:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),util_1=require("../util"),array_ops_1=require("./array_ops"),concat_split_1=require("./concat_split"),norm_1=require("./norm"),operation_1=require("./operation"),reduction_ops_1=require("./reduction_ops"),tensor_ops_1=require("./tensor_ops");function qr2d(x,fullMatrices){return void 0===fullMatrices&&(fullMatrices=!1),engine_1.ENGINE.tidy(function(){if(2!==x.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+x.shape.length+"D Tensor.");for(var m=x.shape[0],n=x.shape[1],q=array_ops_1.eye(m),r=x.clone(),one2D=tensor_ops_1.tensor2d([[1]],[1,1]),w=one2D.clone(),iters=n<=m?n:m,_loop_3=function(j){var _a,rTemp=r,wTemp=w,qTemp=q;w=(_a=engine_1.ENGINE.tidy(function(){var rjEnd1=r.slice([j,j],[m-j,1]),normX=rjEnd1.norm(),rjj=r.slice([j,j],[1,1]),s=tensor_ops_1.tensor2d([[-1]]).where(rjj.greater(0),tensor_ops_1.tensor2d([[1]])),u1=rjj.sub(s.mul(normX)),wPre=rjEnd1.div(u1);w=1===wPre.shape[0]?one2D.clone():one2D.concat(wPre.slice([1,0],[wPre.shape[0]-1,wPre.shape[1]]),0);var tau=s.matMul(u1).div(normX).neg(),rjEndAll=r.slice([j,0],[m-j,n]),tauTimesW=tau.mul(w);r=0===j?rjEndAll.sub(tauTimesW.matMul(w.transpose().matMul(rjEndAll))):r.slice([0,0],[j,n]).concat(rjEndAll.sub(tauTimesW.matMul(w.transpose().matMul(rjEndAll))),0);var qAllJEnd=q.slice([0,j],[m,q.shape[1]-j]);return q=0===j?qAllJEnd.sub(qAllJEnd.matMul(w).matMul(tauTimesW.transpose())):q.slice([0,0],[m,j]).concat(qAllJEnd.sub(qAllJEnd.matMul(w).matMul(tauTimesW.transpose())),1),[w,r,q]}))[0],r=_a[1],q=_a[2],globals_1.dispose([rTemp,wTemp,qTemp])},j=0;j<iters;++j)_loop_3(j);return!fullMatrices&&n<m&&(q=q.slice([0,0],[m,n]),r=r.slice([0,0],[n,n])),[q,r]})}exports.gramSchmidt=operation_1.op({gramSchmidt_:function(xs){var inputIsTensor2D;if(Array.isArray(xs)){inputIsTensor2D=!1,util_1.assert(null!=xs&&0<xs.length,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var dim_1=xs[0].shape[0],_loop_1=function(i){util_1.assert(xs[i].shape[0]===dim_1,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+xs[i].shape[0]+" vs. "+dim_1+")"})},i=1;i<xs.length;++i)_loop_1(i)}else inputIsTensor2D=!0,xs=concat_split_1.split(xs,xs.shape[0],0).map(function(x){return array_ops_1.squeeze(x,[0])});util_1.assert(xs.length<=xs[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+xs.length+") exceeds number of dimensions ("+xs[0].shape[0]+")."});function _loop_2(i){ys.push(engine_1.ENGINE.tidy(function(){var x=xs1d[i];if(0<i)for(var j=0;j<i;++j){var proj=reduction_ops_1.sum(ys[j].mulStrict(x)).mul(ys[j]);x=x.sub(proj)}return x.div(norm_1.norm(x,"euclidean"))}))}var ys=[],xs1d=xs;for(i=0;i<xs.length;++i)_loop_2(i);return inputIsTensor2D?array_ops_1.stack(ys,0):ys}}),exports.qr=operation_1.op({qr_:function(x,fullMatrices){if(void 0===fullMatrices&&(fullMatrices=!1),x.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+x.rank);if(2===x.rank)return qr2d(x,fullMatrices);var outerDimsProd=x.shape.slice(0,x.shape.length-2).reduce(function(value,prev){return value*prev}),x2ds=array_ops_1.unstack(x.reshape([outerDimsProd,x.shape[x.shape.length-2],x.shape[x.shape.length-1]]),0),q2ds_1=[],r2ds_1=[];return x2ds.forEach(function(x2d){var _a=qr2d(x2d,fullMatrices),q2d=_a[0],r2d=_a[1];q2ds_1.push(q2d),r2ds_1.push(r2d)}),[array_ops_1.stack(q2ds_1,0).reshape(x.shape),array_ops_1.stack(r2ds_1,0).reshape(x.shape)]}})},{"../engine":143,"../globals":146,"../util":241,"./array_ops":163,"./concat_split":173,"./norm":194,"./operation":195,"./reduction_ops":200,"./tensor_ops":216}],188:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var where_impl_1=require("../backends/where_impl"),engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),broadcast_util_1=require("./broadcast_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.logicalAnd=operation_1.op({logicalAnd_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalAnd","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalAnd","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.logicalAnd($a,$b)},{$a:$a,$b:$b})}}),exports.logicalNot=operation_1.op({logicalNot_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","logicalNot","bool");return engine_1.ENGINE.runKernel(function(backend){return backend.logicalNot($x)},{$x:$x})}}),exports.logicalOr=operation_1.op({logicalOr_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalOr","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalOr","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),engine_1.ENGINE.runKernel(function(backend){return backend.logicalOr($a,$b)},{$a:$a,$b:$b})}}),exports.logicalXor=operation_1.op({logicalXor_:function(a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","logicalXor","bool"),$b=tensor_util_env_1.convertToTensor(b,"b","logicalXor","bool");return broadcast_util_1.assertAndGetBroadcastShape($a.shape,$b.shape),exports.logicalOr(a,b).logicalAnd(exports.logicalAnd(a,b).logicalNot())}}),exports.where=operation_1.op({where_:function(condition,a,b){var $a=tensor_util_env_1.convertToTensor(a,"a","where"),$b=tensor_util_env_1.convertToTensor(b,"b","where"),$condition=tensor_util_env_1.convertToTensor(condition,"condition","where","bool");return util_1.assertShapesMatch($a.shape,$b.shape,"Error in where: "),1===$condition.rank?util_1.assert($condition.shape[0]===$a.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):util_1.assertShapesMatch($condition.shape,$b.shape,"Error in where: "),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.select($condition,$a,$b);return save([$condition]),res},{$condition:$condition,$a:$a,$b:$b},function(dy,saved){var $condition=saved[0];return{$condition:function(){return tensor_ops_1.zerosLike($condition).toFloat()},$a:function(){return dy.mul($condition.cast(dy.dtype))},$b:function(){return dy.mul($condition.logicalNot().cast(dy.dtype))}}})}}),exports.whereAsync=function(condition){return __awaiter(this,void 0,void 0,function(){var $condition,vals,res;return __generator(this,function(_a){switch(_a.label){case 0:return[4,($condition=tensor_util_env_1.convertToTensor(condition,"condition","whereAsync","bool")).data()];case 1:return vals=_a.sent(),res=where_impl_1.whereImpl($condition.shape,vals),condition!==$condition&&$condition.dispose(),[2,res]}})})}},{"../backends/where_impl":140,"../engine":143,"../tensor_util_env":237,"../util":241,"./broadcast_util":169,"./operation":195,"./tensor_ops":216}],189:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Reduction,gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),axis_util_1=require("./axis_util"),binary_ops_1=require("./binary_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");!function(Reduction){Reduction[Reduction.NONE=0]="NONE",Reduction[Reduction.MEAN=1]="MEAN",Reduction[Reduction.SUM=2]="SUM",Reduction[Reduction.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}(Reduction=exports.Reduction||(exports.Reduction={})),exports.absoluteDifference=operation_1.op({absoluteDifference_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","absoluteDifference"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","absoluteDifference"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","absoluteDifference")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in absoluteDifference: ");var losses=$labels.sub($predictions).abs();return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.computeWeightedLoss=operation_1.op({computeWeightedLoss_:function(losses,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $losses=tensor_util_env_1.convertToTensor(losses,"losses","computeWeightedLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","computeWeightedLoss"));var weightedLoss=null==$weights?$losses:$losses.mul($weights);if(reduction===Reduction.NONE)return weightedLoss;if(reduction===Reduction.SUM)return weightedLoss.sum();if(reduction===Reduction.MEAN){if(null==$weights)return weightedLoss.mean();var broadcastFactor=$losses.size/$weights.size,result=weightedLoss.sum().div($weights.sum());return 1<broadcastFactor?result.div(tensor_ops_1.scalar(broadcastFactor)):result}if(reduction!==Reduction.SUM_BY_NONZERO_WEIGHTS)throw Error("Unknown reduction: "+reduction);if(null==$weights)return weightedLoss.sum().div(tensor_ops_1.scalar($losses.size));var numNonZeros=$weights.mul(tensor_ops_1.ones($losses.shape)).notEqual(tensor_ops_1.scalar(0)).sum().toFloat();return weightedLoss.sum().div(numNonZeros)}}),exports.cosineDistance=operation_1.op({cosineDistance_:function(labels,predictions,axis,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","cosineDistance"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","cosineDistance"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","cosineDistance")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in cosineDistance: ");var losses=tensor_ops_1.scalar(1).sub($labels.mul($predictions).sum(axis,!0));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.hingeLoss=operation_1.op({hingeLoss_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","hingeLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","hingeLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","hingeLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in hingeLoss: ");var one=tensor_ops_1.scalar(1);$labels=tensor_ops_1.scalar(2).mul($labels).sub(one);var losses=one.sub($labels.mul($predictions)).relu();return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.huberLoss=operation_1.op({huberLoss_:function(labels,predictions,weights,delta,reduction){void 0===delta&&(delta=1),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","huberLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","huberLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","huberLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in huberLoss: ");var deltaScalar=tensor_ops_1.scalar(delta),error=$predictions.sub($labels).abs(),quadratic=binary_ops_1.minimum(error,deltaScalar),linear=error.sub(quadratic),losses=tensor_ops_1.scalar(.5).mul(quadratic.square()).add(deltaScalar.mul(linear));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.logLoss=operation_1.op({logLoss_:function(labels,predictions,weights,epsilon,reduction){void 0===epsilon&&(epsilon=1e-7),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","logLoss"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","logLoss"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","logLoss")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in logLoss: ");var one=tensor_ops_1.scalar(1),epsilonScalar=tensor_ops_1.scalar(epsilon),losses=$labels.mul($predictions.add(epsilonScalar).log()).neg().sub(one.sub($labels).mul(one.sub($predictions).add(epsilonScalar).log()));return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.meanSquaredError=operation_1.op({meanSquaredError_:function(labels,predictions,weights,reduction){void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $labels=tensor_util_env_1.convertToTensor(labels,"labels","meanSquaredError"),$predictions=tensor_util_env_1.convertToTensor(predictions,"predictions","meanSquaredError"),$weights=null;null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","meanSquaredError")),util_1.assertShapesMatch($labels.shape,$predictions.shape,"Error in meanSquaredError: ");var losses=$labels.squaredDifference($predictions);return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.sigmoidCrossEntropy=operation_1.op({sigmoidCrossEntropy_:function(multiClassLabels,logits,weights,labelSmoothing,reduction){void 0===labelSmoothing&&(labelSmoothing=0),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $multiClassLabels=tensor_util_env_1.convertToTensor(multiClassLabels,"multiClassLabels","sigmoidCrossEntropy"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","sigmoidCrossEntropy"),$weights=null;if(null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","sigmoidCrossEntropy")),util_1.assertShapesMatch($multiClassLabels.shape,$logits.shape,"Error in sigmoidCrossEntropy: "),0<labelSmoothing){var labelSmoothingScalar=tensor_ops_1.scalar(labelSmoothing),one=tensor_ops_1.scalar(1),half=tensor_ops_1.scalar(.5);$multiClassLabels=$multiClassLabels.mul(one.sub(labelSmoothingScalar)).add(half.mul(labelSmoothingScalar))}var losses=function(labels,logits){var $labels=tensor_util_env_1.convertToTensor(labels,"labels","sigmoidCrossEntropyWithLogits"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","sigmoidCrossEntropyWithLogits");util_1.assertShapesMatch($labels.shape,$logits.shape,"Error in sigmoidCrossEntropyWithLogits: ");var maxOutput=$logits.relu(),outputXTarget=$logits.mul($labels),sigmoidOutput=$logits.abs().neg().exp().log1p();return maxOutput.sub(outputXTarget).add(sigmoidOutput)}($multiClassLabels,$logits);return exports.computeWeightedLoss(losses,$weights,reduction)}}),exports.softmaxCrossEntropy=operation_1.op({softmaxCrossEntropy_:function(onehotLabels,logits,weights,labelSmoothing,reduction){void 0===labelSmoothing&&(labelSmoothing=0),void 0===reduction&&(reduction=Reduction.SUM_BY_NONZERO_WEIGHTS);var $onehotLabels=tensor_util_env_1.convertToTensor(onehotLabels,"onehotLabels","softmaxCrossEntropy"),$logits=tensor_util_env_1.convertToTensor(logits,"logits","softmaxCrossEntropy"),$weights=null;if(null!=weights&&($weights=tensor_util_env_1.convertToTensor(weights,"weights","softmaxCrossEntropy")),util_1.assertShapesMatch($onehotLabels.shape,$logits.shape,"Error in softmaxCrossEntropy: "),0<labelSmoothing){var labelSmoothingScalar=tensor_ops_1.scalar(labelSmoothing),one=tensor_ops_1.scalar(1),numClasses=tensor_ops_1.scalar($onehotLabels.shape[1]);$onehotLabels=$onehotLabels.mul(one.sub(labelSmoothingScalar)).add(labelSmoothingScalar.div(numClasses))}var losses=function(labels,logits,dim){if(void 0===dim&&(dim=-1),-1===dim&&(dim=logits.rank-1),dim!==logits.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+logits.rank+" and dim was "+dim);return gradients_1.customGrad(function(labels,logits,save){var lse=logits.logSumExp([dim],!0),logResult=logits.toFloat().sub(lse);save([labels,logResult]);return{value:logResult.mul(labels).neg().sum([dim]),gradFunc:function(dy,saved){var labels=saved[0],logResult=saved[1],dyShape=axis_util_1.expandShapeToKeepDim(dy.shape,[dim]);return[dy.reshape(dyShape).mul(labels.toFloat().sub(logResult.exp())),dy.reshape(dyShape).mul(logResult.exp().sub(labels.toFloat()))]}}})(labels,logits)}($onehotLabels,$logits);return exports.computeWeightedLoss(losses,$weights,reduction)}})},{"../gradients":147,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./binary_ops":167,"./operation":195,"./tensor_ops":216}],190:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.localResponseNormalization=operation_1.op({localResponseNormalization_:function(x,depthRadius,bias,alpha,beta){void 0===depthRadius&&(depthRadius=5),void 0===bias&&(bias=1),void 0===alpha&&(alpha=1),void 0===beta&&(beta=.5);var $x=tensor_util_env_1.convertToTensor(x,"x","localResponseNormalization");util.assert(4===$x.rank||3===$x.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+$x.rank+"."}),util.assert(util.isInt(depthRadius),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+depthRadius+"."});var x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2]));var res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.localResponseNormalization4D(x4D,depthRadius,bias,alpha,beta);return save([x4D,y]),y},{x4D:x4D},function(dy,saved){var x4D=saved[0],y=saved[1];return{x4D:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.LRNGrad(dy,x4D,y,depthRadius,bias,alpha,beta)},{})}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],191:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.basicLSTMCell=operation_1.op({basicLSTMCell_:function(forgetBias,lstmKernel,lstmBias,data,c,h){var $forgetBias=tensor_util_env_1.convertToTensor(forgetBias,"forgetBias","basicLSTMCell"),$lstmKernel=tensor_util_env_1.convertToTensor(lstmKernel,"lstmKernel","basicLSTMCell"),$lstmBias=tensor_util_env_1.convertToTensor(lstmBias,"lstmBias","basicLSTMCell"),$data=tensor_util_env_1.convertToTensor(data,"data","basicLSTMCell"),$c=tensor_util_env_1.convertToTensor(c,"c","basicLSTMCell"),$h=tensor_util_env_1.convertToTensor(h,"h","basicLSTMCell"),res=$data.concat($h,1).matMul($lstmKernel).add($lstmBias),batchSize=res.shape[0],sliceCols=res.shape[1]/4,sliceSize=[batchSize,sliceCols],i=res.slice([0,0],sliceSize),j=res.slice([0,sliceCols],sliceSize),f=res.slice([0,2*sliceCols],sliceSize),o=res.slice([0,3*sliceCols],sliceSize),newC=i.sigmoid().mulStrict(j.tanh()).addStrict($c.mulStrict($forgetBias.add(f).sigmoid())),newH=newC.tanh().mulStrict(o.sigmoid());return[newC,newH]}}),exports.multiRNNCell=operation_1.op({multiRNNCell_:function(lstmCells,data,c,h){for(var $data=tensor_util_env_1.convertToTensor(data,"data","multiRNNCell"),$c=tensor_util_env_1.convertToTensorArray(c,"c","multiRNNCell"),$h=tensor_util_env_1.convertToTensorArray(h,"h","multiRNNCell"),input=$data,newStates=[],i=0;i<lstmCells.length;i++){var output=lstmCells[i](input,$c[i],$h[i]);newStates.push(output[0]),newStates.push(output[1]),input=output[1]}var newC=[],newH=[];for(i=0;i<newStates.length;i+=2)newC.push(newStates[i]),newH.push(newStates[i+1]);return[newC,newH]}})},{"../tensor_util_env":237,"./operation":195}],192:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.matMul=operation_1.op({matMul_:function(a,b,transposeA,transposeB){var _a;void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1);var $a=tensor_util_env_1.convertToTensor(a,"a","matMul"),$b=tensor_util_env_1.convertToTensor(b,"b","matMul");_a=tensor_util_1.makeTypesMatch($a,$b),$a=_a[0],$b=_a[1];var innerShapeA=transposeA?$a.shape[$a.rank-2]:$a.shape[$a.rank-1],innerShapeB=transposeB?$b.shape[$b.rank-1]:$b.shape[$b.rank-2],outerShapeA=transposeA?$a.shape[$a.rank-1]:$a.shape[$a.rank-2],outerShapeB=transposeB?$b.shape[$b.rank-2]:$b.shape[$b.rank-1],outerDimsA=$a.shape.slice(0,-2),outerDimsB=$b.shape.slice(0,-2),batchDimA=util.sizeFromShape(outerDimsA),batchDimB=util.sizeFromShape(outerDimsB);util.assert(2<=$a.rank&&2<=$b.rank&&$a.rank===$b.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+$a.rank+" and "+$b.rank+"."}),util.assert(util.arraysEqual(outerDimsA,outerDimsB),function(){return"Error in matMul: outer dimensions ("+outerDimsA+") and ("+outerDimsB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" must match."}),util.assert(innerShapeA===innerShapeB,function(){return"Error in matMul: inner shapes ("+innerShapeA+") and ("+innerShapeB+") of Tensors with shapes "+$a.shape+" and "+$b.shape+" and transposeA="+transposeA+" and transposeB="+transposeB+" must match."});var outShape=$a.shape.slice(0,-2).concat([outerShapeA,outerShapeB]),a3D=transposeA?$a.as3D(batchDimA,innerShapeA,outerShapeA):$a.as3D(batchDimA,outerShapeA,innerShapeA),b3D=transposeB?$b.as3D(batchDimB,outerShapeB,innerShapeB):$b.as3D(batchDimB,innerShapeB,outerShapeB);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.batchMatMul(a3D,b3D,transposeA,transposeB);return save([a3D,b3D]),res},{$a:a3D,$b:b3D},function(dy,saved){var _a=saved,a3D=_a[0],b3D=_a[1];return transposeA||transposeB?!transposeA&&transposeB?{$a:function(){return dy.matMul(b3D,!1,!1)},$b:function(){return dy.matMul(a3D,!0,!1)}}:transposeA&&!transposeB?{$a:function(){return b3D.matMul(dy,!1,!0)},$b:function(){return a3D.matMul(dy,!1,!1)}}:{$a:function(){return b3D.matMul(dy,!0,!0)},$b:function(){return dy.matMul(a3D,!0,!0)}}:{$a:function(){return dy.matMul(b3D,!1,!0)},$b:function(){return a3D.matMul(dy,!0,!1)}}}).reshape(outShape)}}),exports.dot=operation_1.op({dot_:function(t1,t2){var $t1=tensor_util_env_1.convertToTensor(t1,"t1","dot"),$t2=tensor_util_env_1.convertToTensor(t2,"t2","dot");util.assert(!(1!==$t1.rank&&2!==$t1.rank||1!==$t2.rank&&2!==$t2.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+$t1.rank+" and "+$t2.rank+"."});var t1Inner=1===$t1.rank?$t1.size:$t1.shape[1],t2Inner=1===$t2.rank?$t2.size:$t2.shape[0];return util.assert(t1Inner===t2Inner,function(){return"Error in dot: inner dimensions of inputs must match, but got "+t1Inner+" and "+t2Inner+"."}),1===$t1.rank&&1===$t2.rank?$t1.as2D(1,-1).matMul($t2.as2D(-1,1)).asScalar():1===$t1.rank&&2===$t2.rank?$t1.as2D(1,-1).matMul($t2.as2D($t2.shape[0],$t2.shape[1])).as1D():2===$t1.rank&&1===$t2.rank?$t1.matMul($t2.as2D(-1,1)).as1D():$t1.matMul($t2.as2D($t2.shape[0],$t2.shape[1]))}}),exports.outerProduct=operation_1.op({outerProduct_:function(v1,v2){var $v1=tensor_util_env_1.convertToTensor(v1,"v1","outerProduct"),$v2=tensor_util_env_1.convertToTensor(v2,"v2","outerProduct");return util.assert(1===$v1.rank&&1===$v2.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+$v1.rank+" and "+$v2.rank+"."}),$v1.as2D(-1,1).matMul($v2.as2D(1,-1))}})},{"../engine":143,"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./operation":195}],193:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_1=require("../tensor_util"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),binary_ops_1=require("./binary_ops"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.movingAverage=operation_1.op({movingAverage_:function(v,x,decay,step,zeroDebias){void 0===zeroDebias&&(zeroDebias=!0);var $v=tensor_util_env_1.convertToTensor(v,"v","movingAverage"),$x=tensor_util_env_1.convertToTensor(x,"x","movingAverage"),$decay=tensor_util_env_1.convertToTensor(decay,"decay","movingAverage");tensor_util_1.assertTypesMatch($v,$x),util.assert(util.arraysEqual($v.shape,$x.shape),function(){return"Shape mismatch in v and x"});var one=tensor_ops_1.scalar(1),oneMinusDecay=one.sub($decay),update=$x.sub($v).mul(oneMinusDecay);if(zeroDebias){util.assert(null!=step,function(){return"When using zeroDebias: true, step is required."});var $step=tensor_util_env_1.convertToTensor(step,"step","movingAverage");update=update.div(one.sub(binary_ops_1.pow($decay,$step)))}return $v.add(update)}})},{"../tensor_util":236,"../tensor_util_env":237,"../util":241,"./binary_ops":167,"./operation":195,"./tensor_ops":216}],194:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.norm=operation_1.op({norm_:function(x,ord,axis,keepDims){void 0===ord&&(ord="euclidean"),void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var norm=function normImpl(x,p,axis){void 0===axis&&(axis=null);if(0===x.rank)return x.abs();if(1!==x.rank&&null===axis)return normImpl(x.reshape([-1]),p,axis);if(1===x.rank||"number"==typeof axis||Array.isArray(axis)&&1===axis.length){if(1===p)return x.abs().sum(axis);if(p===1/0)return x.abs().max(axis);if(p===-1/0)return x.abs().min(axis);if("euclidean"===p||2===p)return x.abs().pow(tensor_ops_1.scalar(2,"int32")).sum(axis).sqrt();throw new Error("Error in norm: invalid ord value: "+p)}if(Array.isArray(axis)&&2===axis.length){if(1===p)return x.abs().sum(axis[0]).max(axis[1]-1);if(p===1/0)return x.abs().sum(axis[1]).max(axis[0]);if(p===-1/0)return x.abs().sum(axis[1]).min(axis[0]);if("fro"===p||"euclidean"===p)return x.square().sum(axis).sqrt();throw new Error("Error in norm: invalid ord value: "+p)}throw new Error("Error in norm: invalid axis: "+axis)}(x=tensor_util_env_1.convertToTensor(x,"x","norm"),ord,axis),keepDimsShape=norm.shape;if(keepDims){var axes=util_1.parseAxisParam(axis,x.shape);keepDimsShape=axis_util.expandShapeToKeepDim(norm.shape,axes)}return norm.reshape(keepDimsShape)}})},{"../tensor_util_env":237,"../util":241,"./axis_util":165,"./operation":195,"./tensor_ops":216}],195:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine");exports.op=function(f){var keys=Object.keys(f);if(1!==keys.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+keys.length+" keys.");var opName=keys[0],fn=f[opName];function f2(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];engine_1.ENGINE.startScope(opName);try{var result=fn.apply(void 0,args);return result instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),engine_1.ENGINE.endScope(result),result}catch(ex){throw engine_1.ENGINE.endScope(null),ex}}return opName.endsWith("_")&&(opName=opName.substring(0,opName.length-1)),Object.defineProperty(f2,"name",{value:opName,configurable:!0}),f2}},{"../engine":143}],196:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./batchnorm")),__export(require("./boolean_mask")),__export(require("./complex_ops")),__export(require("./concat_split")),__export(require("./conv")),__export(require("./matmul")),__export(require("./reverse")),__export(require("./pool")),__export(require("./slice")),__export(require("./unary_ops")),__export(require("./reduction_ops")),__export(require("./compare")),__export(require("./binary_ops")),__export(require("./relu_ops")),__export(require("./logical_ops")),__export(require("./array_ops")),__export(require("./tensor_ops")),__export(require("./transpose")),__export(require("./softmax")),__export(require("./lrn")),__export(require("./norm")),__export(require("./segment_ops")),__export(require("./lstm")),__export(require("./moving_average")),__export(require("./strided_slice")),__export(require("./topk")),__export(require("./scatter_nd")),__export(require("./spectral_ops")),__export(require("./sparse_to_dense")),__export(require("./gather_nd")),__export(require("./diag")),__export(require("./dropout")),__export(require("./signal_ops")),__export(require("./in_top_k"));var operation_1=require("./operation");exports.op=operation_1.op;var losses=require("./loss_ops");exports.losses=losses;var linalg=require("./linalg_ops");exports.linalg=linalg;var image=require("./image_ops");exports.image=image;var spectral=require("./spectral_ops");exports.spectral=spectral;var fused=require("./fused_ops");exports.fused=fused;var signal=require("./signal_ops");exports.signal=signal},{"./array_ops":163,"./batchnorm":166,"./binary_ops":167,"./boolean_mask":168,"./compare":171,"./complex_ops":172,"./concat_split":173,"./conv":176,"./diag":178,"./dropout":179,"./fused_ops":182,"./gather_nd":183,"./image_ops":185,"./in_top_k":186,"./linalg_ops":187,"./logical_ops":188,"./loss_ops":189,"./lrn":190,"./lstm":191,"./matmul":192,"./moving_average":193,"./norm":194,"./operation":195,"./pool":197,"./reduction_ops":200,"./relu_ops":201,"./reverse":202,"./scatter_nd":203,"./segment_ops":205,"./signal_ops":208,"./slice":209,"./softmax":211,"./sparse_to_dense":212,"./spectral_ops":214,"./strided_slice":215,"./tensor_ops":216,"./topk":217,"./transpose":218,"./unary_ops":219}],197:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),array_ops_1=require("./array_ops"),conv_util=require("./conv_util"),operation_1=require("./operation");function maxPoolImpl_(x,filterSize,strides,dilations,pad,dimRoundingMode){var $x=tensor_util_env_1.convertToTensor(x,"x","maxPool"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),null==dilations&&(dilations=[1,1]),util.assert(4===x4D.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+x4D.rank+"."}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool2DInfo(x4D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.maxPool(x4D,convInfo);return save([x4D,y]),y},{x:x4D},function(dy,saved){var x4D=saved[0],y=saved[1];return{x:function(){return function(dy,input,output,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","maxPoolBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","maxPoolBackprop"),$output=tensor_util_env_1.convertToTensor(output,"output","maxPoolBackprop");util.assert($input.rank===$dy.rank,function(){return"Rank of input ("+$input.rank+") does not match rank of dy ("+$dy.rank+")"}),null==dilations&&(dilations=[1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),util.assert(4===$dy.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+$dy.rank+"."}),util.assert(4===$input.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+$input.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool2DInfo($input.shape,filterSize,strides,dilations,pad,dimRoundingMode);return engine_1.ENGINE.runKernel(function(backend){return backend.maxPoolBackprop($dy,$input,$output,convInfo)},{$dy:$dy,$input:$input})}(dy,x4D,y,filterSize,strides,dilations,pad)}}});return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}function avgPoolImpl_(x,filterSize,strides,dilations,pad,dimRoundingMode){var $x=tensor_util_env_1.convertToTensor(x,"x","avgPool","float32");null==dilations&&(dilations=[1,1]),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(4===x4D.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+x4D.rank+"."}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool2DInfo(x4D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPool(x4D,convInfo)},{x:x4D},function(dy){return{x:function(){return function(dy,input,filterSize,strides,dilations,pad){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","avgPoolBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","avgPoolBackprop");util.assert($input.rank===$dy.rank,function(){return"Rank of input ("+$input.rank+") does not match rank of dy ("+$dy.rank+")"}),null==dilations&&(dilations=[1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var input4D=$input,dy4D=$dy,reshapedTo4D=!1;3===$input.rank&&(reshapedTo4D=!0,input4D=$input.as4D(1,$input.shape[0],$input.shape[1],$input.shape[2]),dy4D=$dy.as4D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2]));util.assert(4===dy4D.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+dy4D.rank+"."}),util.assert(4===input4D.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+input4D.rank+"."});var convInfo=conv_util.computePool2DInfo(input4D.shape,filterSize,strides,dilations,pad),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPoolBackprop(dy4D,input4D,convInfo)},{dy4D:dy4D,input4D:input4D});if(reshapedTo4D)return res.as3D(res.shape[1],res.shape[2],res.shape[3]);return res}(dy,x4D,filterSize,strides,dilations,pad)}}});return res=res.cast($x.dtype),reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}exports.maxPool=operation_1.op({maxPool_:function(x,filterSize,strides,pad,dimRoundingMode){return maxPoolImpl_(x,filterSize,strides,1,pad,dimRoundingMode)}}),exports.avgPool=operation_1.op({avgPool_:function(x,filterSize,strides,pad,dimRoundingMode){return avgPoolImpl_(x,filterSize,strides,1,pad,dimRoundingMode)}}),exports.pool=operation_1.op({pool_:function(input,windowShape,poolingType,pad,dilations,strides){null==dilations&&(dilations=[1,1]),null==strides&&(strides=1),0===pad&&(pad="valid");var $x=tensor_util_env_1.convertToTensor(input,"x","maxPool"),x4D=$x,reshapedTo4D=!1;3===$x.rank&&(reshapedTo4D=!0,x4D=$x.as4D(1,$x.shape[0],$x.shape[1],$x.shape[2])),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"});var basePadding,convInfo=conv_util.computePool2DInfo(x4D.shape,windowShape,strides,dilations,pad),dilation=[convInfo.dilationHeight,convInfo.dilationWidth];basePadding="same"===pad?function(filterShape,dilation){var padExtraShape=filterShape.map(function(s,i){return s+(s-1)*(dilation[i]-1)}).map(function(s){return s-1}),padExtraStart=padExtraShape.map(function(s){return Math.floor(s/2)}),padExtraEnd=padExtraShape.map(function(s,i){return s-padExtraStart[i]});return padExtraShape.map(function(_,i){return[padExtraStart[i],padExtraEnd[i]]})}([convInfo.filterHeight,convInfo.filterWidth],dilation):[[0,0],[0,0]];var isDilationOne=1===dilation[0]&&1===dilation[1],_a=function(inputShape,blockShape,basePadding){var padStart=basePadding.map(function(b){return b[0]}),origPadEnd=basePadding.map(function(b){return b[1]}),fullInputShape=inputShape.concat(padStart,origPadEnd),padEndExtra=blockShape.map(function(b,i){return(b-fullInputShape[i]%b)%b}),padEnd=origPadEnd.map(function(s,i){return s+padEndExtra[i]}),paddings=blockShape.map(function(_,i){return[padStart[i],padEnd[i]]}),crops=blockShape.map(function(_,i){return[0,padEndExtra[i]]});return[paddings,crops]}([convInfo.inHeight,convInfo.inWidth],dilation,basePadding),adjustedPadding=_a[0],adjustedCrops=_a[1],convertedPad=isDilationOne?pad:"valid",convertedX=isDilationOne?x4D:array_ops_1.spaceToBatchND(x4D,dilation,adjustedPadding),y=("avg"===poolingType?function(){return avgPoolImpl_(convertedX,windowShape,strides,1,convertedPad)}:function(){return maxPoolImpl_(convertedX,windowShape,strides,1,convertedPad)})(),res=isDilationOne?y:array_ops_1.batchToSpaceND(y,dilation,adjustedCrops);return reshapedTo4D?res.as3D(res.shape[1],res.shape[2],res.shape[3]):res}}),exports.maxPool3d=operation_1.op({maxPool3d_:function(x,filterSize,strides,pad,dimRoundingMode,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","maxPool3d"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),null==dilations&&(dilations=[1,1,1]),util.assert(5===x5D.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+x5D.rank+"."}),util.assert("NDHWC"===dataFormat,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+dataFormat}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(x5D.shape,filterSize,strides,dilations,pad,dimRoundingMode,dataFormat),res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.maxPool3d(x5D,convInfo);return save([x5D,y]),y},{x:x5D},function(dy,saved){var x5D=saved[0],y=saved[1];return{x:function(){return function(dy,input,output,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","maxPool3dBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","maxPool3dBackprop"),$output=tensor_util_env_1.convertToTensor(output,"output","maxPool3dBackprop"),dy5D=$dy,input5D=$input,output5D=$output,reshapedTo5D=!1;4===$input.rank&&(reshapedTo5D=!0,dy5D=$dy.as5D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2],$dy.shape[3]),input5D=$input.as5D(1,$input.shape[0],$input.shape[1],$input.shape[2],$input.shape[3]),output5D=$output.as5D(1,$output.shape[0],$output.shape[1],$output.shape[2],$output.shape[3]));util.assert(5===dy5D.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+dy5D.rank+"."}),util.assert(5===input5D.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+input5D.rank+"."}),util.assert(5===output5D.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+output5D.rank+"."}),null==dilations&&(dilations=[1,1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(input5D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend){return backend.maxPool3dBackprop(dy5D,input5D,output5D,convInfo)},{dy5D:dy5D,input5D:input5D});if(reshapedTo5D)return res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]);return res}(dy,x5D,y,filterSize,strides,dilations,pad,dimRoundingMode)}}});return reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}}),exports.avgPool3d=operation_1.op({avgPool3d_:function(x,filterSize,strides,pad,dimRoundingMode,dataFormat,dilations){void 0===dataFormat&&(dataFormat="NDHWC");var $x=tensor_util_env_1.convertToTensor(x,"x","avgPool3d","float32"),x5D=$x,reshapedTo5D=!1;4===$x.rank&&(reshapedTo5D=!0,x5D=$x.as5D(1,$x.shape[0],$x.shape[1],$x.shape[2],$x.shape[3])),null==dilations&&(dilations=[1,1,1]),util.assert(5===x5D.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+x5D.rank+"."}),util.assert("NDHWC"===dataFormat,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+dataFormat}),util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(x5D.shape,filterSize,strides,dilations,pad,dimRoundingMode,dataFormat),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPool3d(x5D,convInfo)},{x:x5D},function(dy){return{x:function(){return function(dy,input,filterSize,strides,dilations,pad,dimRoundingMode){var $dy=tensor_util_env_1.convertToTensor(dy,"dy","avgPool3dBackprop"),$input=tensor_util_env_1.convertToTensor(input,"input","avgPool3dBackprop"),dy5D=$dy,input5D=$input,reshapedTo5D=!1;4===$input.rank&&(reshapedTo5D=!0,dy5D=$dy.as5D(1,$dy.shape[0],$dy.shape[1],$dy.shape[2],$dy.shape[3]),input5D=$input.as5D(1,$input.shape[0],$input.shape[1],$input.shape[2],$input.shape[3]));util.assert(5===dy5D.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+dy5D.rank+"."}),util.assert(5===input5D.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+input5D.rank+"."}),null==dilations&&(dilations=[1,1,1]);util.assert(conv_util.eitherStridesOrDilationsAreOne(strides,dilations),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+strides+" and dilations '"+dilations+"'"}),null!=dimRoundingMode&&util.assert(util.isInt(pad),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+dimRoundingMode+" but got pad "+pad+"."});var convInfo=conv_util.computePool3DInfo(input5D.shape,filterSize,strides,dilations,pad,dimRoundingMode),res=engine_1.ENGINE.runKernel(function(backend){return backend.avgPool3dBackprop(dy5D,input5D,convInfo)},{dy5D:dy5D,input5D:input5D});if(reshapedTo5D)return res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]);return res}(dy,x5D,filterSize,strides,dilations,pad,dimRoundingMode)}}});return res=res.cast(x5D.dtype),reshapedTo5D?res.as4D(res.shape[1],res.shape[2],res.shape[3],res.shape[4]):res}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./conv_util":177,"./operation":195}],198:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),MPRandGauss=function(){function MPRandGauss(mean,stdDeviation,dtype,truncated,seed){this.mean=mean,this.stdDev=stdDeviation,this.dtype=dtype,this.nextVal=NaN,this.truncated=truncated,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var seedValue=seed||Math.random();this.random=seedrandom.alea(seedValue.toString())}return MPRandGauss.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var value=this.nextVal;return this.nextVal=NaN,value}for(var resultX,resultY,isValid=!1;!isValid;){for(var v1=void 0,v2=void 0,s=void 0;1<=(s=(v1=2*this.random()-1)*v1+(v2=2*this.random()-1)*v2)||0===s;);var mul=Math.sqrt(-2*Math.log(s)/s);resultX=this.mean+this.stdDev*v1*mul,resultY=this.mean+this.stdDev*v2*mul,this.truncated&&!this.isValidTruncated(resultX)||(isValid=!0)}return this.truncated&&!this.isValidTruncated(resultY)||(this.nextVal=this.convertValue(resultY)),this.convertValue(resultX)},MPRandGauss.prototype.convertValue=function(value){return null==this.dtype||"float32"===this.dtype?value:Math.round(value)},MPRandGauss.prototype.isValidTruncated=function(value){return value<=this.upper&&value>=this.lower},MPRandGauss}();exports.MPRandGauss=MPRandGauss;var RandGamma=function(){function RandGamma(alpha,beta,dtype,seed){this.alpha=alpha,this.beta=1/beta,this.dtype=dtype;var seedValue=seed||Math.random();this.randu=seedrandom.alea(seedValue.toString()),this.randn=new MPRandGauss(0,1,dtype,!1,this.randu()),this.d=alpha<1?alpha+2/3:alpha-1/3,this.c=1/Math.sqrt(9*this.d)}return RandGamma.prototype.nextValue=function(){for(var x2,v0,v1,x,u,v;;){for(;x=this.randn.nextValue(),(v=1+this.c*x)<=0;);if(v*=v*v,v0=1-.331*(x2=x*x)*x2,v1=.5*x2+this.d*(1-v+Math.log(v)),(u=this.randu())<v0||Math.log(u)<v1)break}return v=1/this.beta*this.d*v,this.alpha<1&&(v*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(v)},RandGamma.prototype.convertValue=function(value){return"float32"===this.dtype?value:Math.round(value)},RandGamma}();exports.RandGamma=RandGamma;var UniformRandom=function(){function UniformRandom(min,max,dtype,seed){void 0===min&&(min=0),void 0===max&&(max=1);var _this=this;if(this.canReturnFloat=function(){return null==_this.dtype||"float32"===_this.dtype},this.min=min,this.range=max-min,this.dtype=dtype,null==seed&&(seed=Math.random()),"number"==typeof seed&&(seed=seed.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+min+" - "+max+" <= 1 and dtype is not float");this.random=seedrandom.alea(seed)}return UniformRandom.prototype.convertValue=function(value){return this.canReturnFloat()?value:Math.round(value)},UniformRandom.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},UniformRandom}();exports.UniformRandom=UniformRandom},{seedrandom:244}],199:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");exports.PARALLELIZE_THRESHOLD=30,exports.computeOptimalWindowSize=function(inSize){return inSize<=exports.PARALLELIZE_THRESHOLD?inSize:util_1.nearestDivisor(inSize,Math.floor(Math.sqrt(inSize)))}},{"../util":241}],200:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");function gradForMinAndMax(dy,y,xOrig,origAxes,permutedAxes){return y.rank<xOrig.rank&&(y=y.reshape(axis_util.expandShapeToKeepDim(y.shape,origAxes))),dy.rank<xOrig.rank&&(dy=dy.reshape(axis_util.expandShapeToKeepDim(dy.shape,origAxes))),{$x:function(){var dx=dy.mul(xOrig.equal(y).cast(dy.dtype));return null==permutedAxes?dx:dx.transpose(permutedAxes)}}}exports.all=operation_1.op({all_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","all","bool"),origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend){return backend.all($x,axes)},{$x:$x});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);return res.reshape(newShape)}return res}}),exports.any=operation_1.op({any_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","any","bool"),origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend){return backend.any($x,axes)},{$x:$x});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);return res.reshape(newShape)}return res}}),exports.argMax=operation_1.op({argMax_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","argMax");null==axis&&(axis=0);var axes=util.parseAxisParam(axis,$x.shape),permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);return null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank)),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.argMax($x,axes[0]);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return tensor_ops_1.zerosLike($x)}}})}}),exports.argMin=operation_1.op({argMin_:function(x,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","argMin");null==axis&&(axis=0);var axes=util.parseAxisParam(axis,$x.shape),permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);return null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank)),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.argMin($x,axes[0]);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return tensor_ops_1.zerosLike($x)}}})}}),exports.logSumExp=operation_1.op({logSumExp_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","logSumExp"),axes=util.parseAxisParam(axis,$x.shape),xMax=$x.max(axes,!0),d=$x.sub(xMax).exp().sum(axes).log(),res=xMax.reshape(d.shape).add(d);if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,axes);return res.reshape(newShape)}return res}}),exports.max=operation_1.op({max_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","max"),xOrig=$x,origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.max($x,axes);return save([xOrig,y]),y},{$x:$x},function(dy,saved){return gradForMinAndMax(dy,saved[1],saved[0],origAxes,permutedAxes)});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);res=res.reshape(newShape)}return res}}),exports.mean=operation_1.op({mean_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","mean"),axes=util.parseAxisParam(axis,$x.shape),reduceShape=axis_util.computeOutAndReduceShapes($x.shape,axes)[1],reduceSize=util.sizeFromShape(reduceShape);return gradients_1.customGrad(function(x){var reduceSizeScalar=tensor_ops_1.scalar(reduceSize);return{value:(reduceSizeScalar.dtype===x.dtype?x:x.cast(reduceSizeScalar.dtype)).div(reduceSizeScalar).sum(axis,keepDims),gradFunc:function(dy){var expandedDyShape=x.shape.slice();return axes.forEach(function(axis){expandedDyShape[axis]=1}),dy.reshape(expandedDyShape).mul(tensor_ops_1.ones(x.shape,"float32")).div(reduceSize)}}})($x)}}),exports.min=operation_1.op({min_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","min"),xOrig=$x,origAxes=util.parseAxisParam(axis,$x.shape),axes=origAxes,permutedAxes=axis_util.getAxesPermutation(axes,$x.rank);null!=permutedAxes&&($x=$x.transpose(permutedAxes),axes=axis_util.getInnerMostAxes(axes.length,$x.rank));var res=engine_1.ENGINE.runKernel(function(backend,save){var y=backend.min($x,axes);return save([xOrig,y]),y},{$x:$x},function(dy,saved){return gradForMinAndMax(dy,saved[1],saved[0],origAxes,permutedAxes)});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(res.shape,origAxes);res=res.reshape(newShape)}return res}}),exports.moments=operation_1.op({moments_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),x=tensor_util_env_1.convertToTensor(x,"x","moments");var axes=util.parseAxisParam(axis,x.shape),mean=x.mean(axes,keepDims),keepDimsShape=mean.shape;keepDims||(keepDimsShape=axis_util.expandShapeToKeepDim(mean.shape,axes));var devSquared=x.toFloat().sub(mean.reshape(keepDimsShape)).square();return{mean:mean,variance:devSquared.mean(axes,keepDims)}}}),exports.sum=operation_1.op({sum_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","sum");"bool"===$x.dtype&&($x=$x.toInt());var axes=util.parseAxisParam(axis,$x.shape);return gradients_1.customGrad(function(x){var permutation=axis_util.getAxesPermutation(axes,x.rank),reductionAxes=axes,permutedX=x;null!=permutation&&(permutedX=x.transpose(permutation),reductionAxes=axis_util.getInnerMostAxes(reductionAxes.length,x.rank));var value=engine_1.ENGINE.runKernel(function(backend){return backend.sum(permutedX,reductionAxes)},{permutedX:permutedX});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(value.shape,axes);value=value.reshape(newShape)}return{value:value,gradFunc:function(dy){var expandedDyShape=x.shape.slice();return axes.forEach(function(axis){expandedDyShape[axis]=1}),dy.reshape(expandedDyShape).mul(tensor_ops_1.ones(x.shape,"float32"))}}})($x)}}),exports.prod=operation_1.op({prod_:function(x,axis,keepDims){void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1);var $x=tensor_util_env_1.convertToTensor(x,"x","prod");"bool"===$x.dtype&&($x=$x.toInt());var axes=util.parseAxisParam(axis,$x.shape),permutation=axis_util.getAxesPermutation(axes,$x.rank),reductionAxes=axes,permutedX=$x;null!=permutation&&(permutedX=$x.transpose(permutation),reductionAxes=axis_util.getInnerMostAxes(reductionAxes.length,$x.rank));var value=engine_1.ENGINE.runKernel(function(backend){return backend.prod(permutedX,reductionAxes)},{permutedX:permutedX});if(keepDims){var newShape=axis_util.expandShapeToKeepDim(value.shape,axes);value=value.reshape(newShape)}return value}})},{"../engine":143,"../gradients":147,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./operation":195,"./tensor_ops":216}],201:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),binary_ops_1=require("./binary_ops"),broadcast_util_1=require("./broadcast_util"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),selu_util_1=require("./selu_util"),tensor_ops_1=require("./tensor_ops");exports.elu=operation_1.op({elu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","elu");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.elu($x);return save([y]),y},{$x:$x},function(dy,saved){var y=saved[0];return{$x:function(){return engine_1.ENGINE.runKernel(function(backend){return backend.eluDer(dy,y)},{dy:dy,y:y})}}})}}),exports.leakyRelu=operation_1.op({leakyRelu_:function(x,alpha){void 0===alpha&&(alpha=.2);var $x=tensor_util_env_1.convertToTensor(x,"x","leakyRelu");return binary_ops_1.maximum(tensor_ops_1.scalar(alpha).mul($x),$x)}}),exports.prelu=operation_1.op({prelu_:function(x,alpha){var $x=tensor_util_env_1.convertToTensor(x,"x","prelu"),$alpha=tensor_util_env_1.convertToTensor(alpha,"alpha","prelu");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.prelu($x,$alpha);return save([$x,$alpha]),res},{$x:$x,$alpha:$alpha},function(dy,saved){var $x=saved[0],$alpha=saved[1],mask=$x.greater(0);return{$x:function(){return logical_ops_1.where(mask,dy,dy.mul($alpha))},$alpha:function(){var res=logical_ops_1.where(mask,tensor_ops_1.zerosLike(dy),dy.mul($x)),reduceAxes=broadcast_util_1.getReductionAxes($alpha.shape,dy.shape);return 0<reduceAxes.length&&(res=res.sum(reduceAxes)),res.reshape($alpha.shape)}}})}}),exports.relu=operation_1.op({relu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","relu");return"bool"===$x.dtype?$x.toInt():engine_1.ENGINE.runKernel(function(backend,save){var res=backend.relu($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mulStrict($x.step().toFloat())}}})}}),exports.selu=operation_1.op({selu_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","selu");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.selu($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){var mask=$x.greater(tensor_ops_1.scalar(0)),scaleAlpha=tensor_ops_1.scalar(selu_util_1.SELU_SCALEALPHA),scale=tensor_ops_1.scalar(selu_util_1.SELU_SCALE),greaterThanZeroDer=dy.mul(scale),lessEqualZeroDer=dy.mul(scaleAlpha).mul($x.toFloat().exp());return logical_ops_1.where(mask,greaterThanZeroDer,lessEqualZeroDer)}}})}})},{"../engine":143,"../tensor_util_env":237,"./binary_ops":167,"./broadcast_util":169,"./logical_ops":188,"./operation":195,"./selu_util":207,"./tensor_ops":216}],202:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation");exports.reverse=operation_1.op({reverse_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");if(0===$x.rank)return $x.clone();var axes=util.parseAxisParam(axis,$x.shape);return engine_1.ENGINE.runKernel(function(backend){return backend.reverse($x,axes)},{$x:$x},function(dy){return{$x:function(){return dy.reverse(axes)}}}).reshapeAs($x)}}),exports.reverse1d=operation_1.op({reverse1d_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(1===$x.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+$x.rank+"."}),exports.reverse($x,0)}}),exports.reverse2d=operation_1.op({reverse2d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(2===$x.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+$x.rank+"."}),exports.reverse($x,axis)}}),exports.reverse3d=operation_1.op({reverse3d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(3===$x.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+$x.rank+"."}),exports.reverse($x,axis)}}),exports.reverse4d=operation_1.op({reverse4d_:function(x,axis){var $x=tensor_util_env_1.convertToTensor(x,"x","reverse");return util.assert(4===$x.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+$x.rank+"."}),exports.reverse($x,axis)}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195}],203:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),scatter_nd_util=require("./scatter_nd_util");exports.scatterND=operation_1.op({scatterND_:function(indices,updates,shape){var $indices=tensor_util_env_1.convertToTensor(indices,"indices","scatterND","int32"),$updates=tensor_util_env_1.convertToTensor(updates,"updates","scatterND");return scatter_nd_util.validateInput($updates,$indices,shape),engine_1.ENGINE.runKernel(function(backend){return backend.scatterND($indices,$updates,shape)},{$indices:$indices,$updates:$updates})}})},{"../engine":143,"../tensor_util_env":237,"./operation":195,"./scatter_nd_util":204}],204:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util");function validateUpdateShape(shape,indices,updates){var sliceDim=1<indices.rank?indices.shape[indices.rank-1]:1,batchDim=1<indices.rank?indices.rank-1:1,shapeError="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+updates.shape+", indices.shape: "+indices.shape+", shape: "+shape+", sliceDim: "+sliceDim+", and batchDim: "+batchDim+".";if(updates.rank<batchDim)throw new Error(shapeError+" update.rank < "+batchDim+". ");if(shape.length<sliceDim+(updates.rank-batchDim))throw new Error(shapeError+" Output shape length < "+(sliceDim+(updates.rank-batchDim)));if(updates.rank!==batchDim+shape.length-sliceDim)throw new Error(shapeError+" update.rank != "+(batchDim+shape.length-sliceDim));for(var d=0;d<batchDim;++d)if(updates.shape[d]!==indices.shape[d])throw new Error(shapeError+" updates.shape["+d+"] ("+updates.shape[d]+") != indices.shape["+d+"] ("+indices.shape[d]+").");for(d=0;d<updates.rank-batchDim;++d)if(updates.shape[d+batchDim]!==shape[d+sliceDim])throw new Error(shapeError+" updates.shape["+(d+batchDim)+"] ("+updates.shape[d+batchDim]+") != shape["+(d+batchDim)+"] ("+shape[d+batchDim]+")")}exports.validateUpdateShape=validateUpdateShape,exports.validateInput=function(updates,indices,shape){if(indices.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+indices.rank+".");if(updates.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+updates.rank+".");if("int32"!==indices.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+indices.dtype);if(shape.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+shape);if(0===shape.length){if(0===indices.size)throw new Error("Indices specified for empty output. indices shape: "+indices.shape);if(0===updates.size)throw new Error("Updates specified for empty output. updates shape: "+updates.shape)}validateUpdateShape(shape,indices,updates)},exports.calculateShapes=function(updates,indices,shape){for(var sliceRank=1<indices.rank?indices.shape[indices.rank-1]:1,totalNd=shape.length,sliceSize=1,i=sliceRank;i<totalNd;++i)sliceSize*=shape[i];var safeSliceDim=sliceRank<1?1:sliceRank;return{sliceRank:sliceRank,numUpdates:indices.size/safeSliceDim,sliceSize:sliceSize,strides:util_1.computeStrides(shape.slice(0,sliceRank)).concat([1]),outputSize:util_1.sizeFromShape(shape)}}},{"../util":241}],205:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),array_ops_1=require("./array_ops"),axis_util_1=require("./axis_util"),binary_ops_1=require("./binary_ops"),compare_1=require("./compare"),logical_ops_1=require("./logical_ops"),operation_1=require("./operation"),segment_util_1=require("./segment_util"),tensor_ops_1=require("./tensor_ops");function arrayRange(start,stop){for(var result=[],i=start;i<stop;++i)result.push(i);return result}function arrayConcat(arrays){for(var result=[],i=0;i<arrays.length;++i)for(var j=0;j<arrays[i].length;++j)result.push(arrays[i][j]);return result}exports.gather=operation_1.op({gather_:function(x,indices,axis){void 0===axis&&(axis=0);var $x=tensor_util_env_1.convertToTensor(x,"x","gather"),$indices=tensor_util_env_1.convertToTensor(indices,"indices","gather","int32");axis=util_1.parseAxisParam(axis,$x.shape)[0];var shapeInfo=segment_util_1.collectGatherOpShapeInfo($x,$indices,axis);return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.gather($x,$indices.flatten(),axis);return save([$indices]),res},{$x:$x},function(dy,saved){var $indices=saved[0];return{$x:function(){var paramsShape=$x.shape,indicesSize=$indices.size,outerShape=paramsShape.slice(0,axis),outerDims=outerShape.length,innerShape=paramsShape.slice(axis,paramsShape.length).slice(1),innerDims=innerShape.length,outerAxesIndices=arrayRange(0,outerDims),innerAxesIndices=arrayRange(outerDims+1,outerDims+1+innerDims),valuesShape=arrayConcat([outerShape,[indicesSize],innerShape]),values=dy.reshape(valuesShape),reshapedIndices=$indices.reshape([indicesSize]),transposeDims=arrayConcat([[outerDims],outerAxesIndices,innerAxesIndices]),valuesTranspose=values.transpose(transposeDims),paramsGrad=exports.unsortedSegmentSum(valuesTranspose,reshapedIndices,$x.shape[axis]),invertTransposeDims=axis_util_1.getUndoAxesPermutation(transposeDims);return paramsGrad=paramsGrad.transpose(invertTransposeDims)}}}).reshape(shapeInfo.outputShape)}}),exports.unsortedSegmentSum=operation_1.op({unsortedSegmentSum_:function(x,segmentIds,numSegments){var $x=tensor_util_env_1.convertToTensor(x,"x","unsortedSegmentSum"),$segmentIds=tensor_util_env_1.convertToTensor(segmentIds,"segmentIds","unsortedSegmentSum","int32");return util_1.assert(util_1.isInt(numSegments),function(){return"numSegments must be of dtype int"}),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.unsortedSegmentSum($x,$segmentIds,numSegments);return save([$segmentIds]),res},{$x:$x},function(dy,saved){var $segmentIds=saved[0];return{$x:function(){return function(x,indices){for(var zeroClippedIndices=binary_ops_1.maximum(indices,tensor_ops_1.zerosLike(indices)),gathered=exports.gather(x,zeroClippedIndices),isPositive=compare_1.greaterEqual(indices,tensor_ops_1.scalar(0,"int32")),numIters=gathered.rank-isPositive.rank,i=0;i<numIters;++i)isPositive=array_ops_1.expandDims(isPositive,i+1);isPositive=logical_ops_1.logicalAnd(isPositive,tensor_ops_1.ones(gathered.shape,"bool"));var zeroSlice=tensor_ops_1.zerosLike(gathered);return logical_ops_1.where(isPositive,gathered,zeroSlice)}(dy,$segmentIds)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./array_ops":163,"./axis_util":165,"./binary_ops":167,"./compare":171,"./logical_ops":188,"./operation":195,"./segment_util":206,"./tensor_ops":216}],206:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),reduce_util_1=require("./reduce_util");exports.segOpComputeOptimalWindowSize=function(inSize,numSegments){var res,done=!1;for(inSize<=reduce_util_1.PARALLELIZE_THRESHOLD?(res=inSize,done=!0):res=util_1.nearestDivisor(inSize,Math.floor(Math.sqrt(inSize)));!done;)numSegments<res||res===inSize?done=!0:res=util_1.nearestDivisor(inSize,res+1);return res},exports.computeOutShape=function(aShape,axis,numSegments){for(var outShape=[],rank=aShape.length,dim=0;dim<rank;dim++)dim!==axis?outShape.push(aShape[dim]):outShape.push(numSegments);return outShape},exports.collectGatherOpShapeInfo=function(x,indices,axis){for(var dimSize=x.shape[axis],outputShape=[],batchSize=1,sliceSize=1,i=0;i<axis;i++)outputShape.push(x.shape[i]),batchSize*=x.shape[i];for(i=0;i<indices.rank;i++)outputShape.push(indices.shape[i]);for(i=axis+1;i<x.rank;i++)outputShape.push(x.shape[i]),sliceSize*=x.shape[i];return{batchSize:batchSize,sliceSize:sliceSize,dimSize:dimSize,outputShape:outputShape}}},{"../util":241,"./reduce_util":199}],207:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SELU_SCALEALPHA=1.7580993408473768,exports.SELU_SCALE=1.0507009873554805},{}],208:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var operation_1=require("../ops/operation"),binary_ops_1=require("./binary_ops"),concat_split_1=require("./concat_split"),slice_1=require("./slice"),spectral_ops_1=require("./spectral_ops"),tensor_ops_1=require("./tensor_ops");function cosineWindow(windowLength,a,b){for(var even=1-windowLength%2,newValues=new Float32Array(windowLength),i=0;i<windowLength;++i){var cosArg=2*Math.PI*i/(windowLength+even-1);newValues[i]=a-b*Math.cos(cosArg)}return tensor_ops_1.tensor1d(newValues,"float32")}exports.hannWindow=operation_1.op({hannWindow_:function(windowLength){return cosineWindow(windowLength,.5,.5)}}),exports.hammingWindow=operation_1.op({hammingWindow_:function(windowLength){return cosineWindow(windowLength,.54,.46)}}),exports.frame=operation_1.op({frame_:function(signal,frameLength,frameStep,padEnd,padValue){void 0===padEnd&&(padEnd=!1),void 0===padValue&&(padValue=0);for(var start=0,output=[];start+frameLength<=signal.size;)output.push(slice_1.slice(signal,start,frameLength)),start+=frameStep;if(padEnd){var padLen=start+frameLength-signal.size,pad=concat_split_1.concat([slice_1.slice(signal,start,frameLength-padLen),tensor_ops_1.fill([padLen],padValue)]);output.push(pad)}return 0===output.length?tensor_ops_1.tensor2d([],[0,frameLength]):concat_split_1.concat(output).as2D(output.length,frameLength)}}),exports.stft=operation_1.op({stft_:function(signal,frameLength,frameStep,fftLength,windowFn){void 0===windowFn&&(windowFn=exports.hannWindow),null==fftLength&&(fftLength=function(value){return Math.floor(Math.pow(2,Math.ceil(Math.log(value)/Math.log(2))))}(frameLength));for(var framedSignal=exports.frame(signal,frameLength,frameStep),windowedSignal=binary_ops_1.mul(framedSignal,windowFn(frameLength)),output=[],i=0;i<framedSignal.shape[0];i++)output.push(spectral_ops_1.rfft(windowedSignal.slice([i,0],[1,frameLength]),fftLength));return concat_split_1.concat(output)}})},{"../ops/operation":195,"./binary_ops":167,"./concat_split":173,"./slice":209,"./spectral_ops":214,"./tensor_ops":216}],209:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation"),slice_util=require("./slice_util");exports.slice=operation_1.op({slice_:function(x,begin,size){var begin_,size_,$x=tensor_util_env_1.convertToTensor(x,"x","slice");if(0===$x.rank)throw new Error("Slicing scalar is not possible");begin_="number"==typeof begin?[begin].concat(new Array($x.rank-1).fill(0)):begin.length<$x.rank?begin.concat(new Array($x.rank-begin.length).fill(0)):begin.slice(),size_=(size_=null==size?new Array($x.rank).fill(-1):"number"==typeof size?[size].concat(new Array($x.rank-1).fill(-1)):size.length<$x.rank?size.concat(new Array($x.rank-size.length).fill(-1)):size).map(function(d,i){return 0<=d?d:(util.assert(-1===d,function(){return"Bad value in size"}),$x.shape[i]-begin_[i])}),slice_util.assertParamsValid($x,begin_,size_);var inputShape=$x.shape;return engine_1.ENGINE.runKernel(function(backend){return backend.slice($x,begin_,size_)},{$x:$x},function(dy){for(var paddings=[],i=0;i<dy.rank;i++)paddings.push([begin_[i],inputShape[i]-begin_[i]-size_[i]]);return{$x:function(){return dy.pad(paddings)}}})}}),exports.slice1d=operation_1.op({slice1d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice1d");return util.assert(1===$x.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,[begin],[size])}}),exports.slice2d=operation_1.op({slice2d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice2d");return util.assert(2===$x.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,begin,size)}}),exports.slice3d=operation_1.op({slice3d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice3d");return util.assert(3===$x.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,begin,size)}}),exports.slice4d=operation_1.op({slice4d_:function(x,begin,size){var $x=tensor_util_env_1.convertToTensor(x,"x","slice4d");return util.assert(4===$x.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+$x.rank+" tensor"}),exports.slice($x,begin,size)}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195,"./slice_util":210}],210:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function startForAxis(beginMask,startIndices,strides,inputShape,axis){var start=startIndices[axis],stride=strides[axis]||1;(beginMask&1<<axis||null==start)&&(start=0<stride?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var axisSize=inputShape[axis];return start<0&&(start+=axisSize),start=util.clamp(0,start,axisSize-1)}function stopForAxis(endMask,stopIndices,strides,inputShape,axis){var stop=stopIndices[axis],stride=strides[axis]||1;(endMask&1<<axis||null==stop)&&(stop=0<stride?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var axisSize=inputShape[axis];return stop<0&&(stop+=axisSize),stop=0<stride?util.clamp(0,stop,axisSize):util.clamp(-1,stop,axisSize-1)}exports.assertParamsValid=function(input,begin,size){util.assert(input.rank===begin.length,function(){return"Error in slice"+input.rank+"D: Length of begin "+begin+" must match the rank of the array ("+input.rank+")."}),util.assert(input.rank===size.length,function(){return"Error in slice"+input.rank+"D: Length of size "+size+" must match the rank of the array ("+input.rank+")."});for(var _loop_1=function(i){util.assert(begin[i]+size[i]<=input.shape[i],function(){return"Error in slice"+input.rank+"D: begin["+i+"] + size["+i+"] ("+(begin[i]+size[i])+") would overflow input.shape["+i+"] ("+input.shape[i]+")"})},i=0;i<input.rank;++i)_loop_1(i)},exports.getStridedSlicedInfo=function(shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),0!==ellipsisMask)throw new Error("ellipsis mask is not yet supported");if(0!==newAxisMask)throw new Error("new axis mask is not yet supported");for(var startIndex=[],endIndex=[],shrinkAxis=[],i=0;i<shape.length;i++)startIndex[i]=startForAxis(beginMask,begin,strides,shape,i),endIndex[i]=stopForAxis(endMask,end,strides,shape,i),shrinkAxisMask&1<<i&&(endIndex[i]=startIndex[i]+1,shrinkAxis.push(i));var size=new Array(shape.length).fill(0);return size=size.map(function(d,i){for(var count=0,stride=strides[i]||1,start=startIndex[i];!(0<stride?start>=endIndex[i]:start<=endIndex[i]);start+=stride)count+=1;return count}),[startIndex,size,shrinkAxis]},exports.startForAxis=startForAxis,exports.stopForAxis=stopForAxis,exports.isSliceContinous=function(shape,begin,size){for(var firstNonOneAxis=size.length,i=0;i<size.length;i++)if(1<size[i]){firstNonOneAxis=i;break}for(i=firstNonOneAxis+1;i<size.length;i++)if(0<begin[i]||size[i]!==shape[i])return!1;return!0},exports.computeFlatOffset=function(begin,strides){for(var flatOffset=0<begin.length?begin[begin.length-1]:1,i=0;i<begin.length-1;i++)flatOffset+=begin[i]*strides[i];return flatOffset}},{"../util":241}],211:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gradients_1=require("../gradients"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.softmax=operation_1.op({softmax_:function(logits,dim){void 0===dim&&(dim=-1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","softmax");if(-1===dim&&(dim=$logits.rank-1),dim!==$logits.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+$logits.rank+" and dim was "+dim);return gradients_1.customGrad(function(logits,save){var lse=logits.logSumExp([dim],!0),y=logits.toFloat().sub(lse).exp();save([y]);return{value:y,gradFunc:function(dy,saved){var y=saved[0],dyTimesY=dy.mul(y);return dyTimesY.sub(dyTimesY.sum([dim],!0).mul(y))}}})($logits)}}),exports.logSoftmax=operation_1.op({logSoftmax_:function(logits,axis){void 0===axis&&(axis=-1);var $logits=tensor_util_env_1.convertToTensor(logits,"logits","logSoftmax");if(-1===axis&&(axis=$logits.rank-1),axis!==$logits.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+$logits.rank+" and axis was "+axis);return gradients_1.customGrad(function(logits,save){var xMax=logits.max(axis,!0),shifted=logits.sub(xMax),value=shifted.toFloat().sub(shifted.exp().sum(axis,!0).log());save([value]);return{value:value,gradFunc:function(dy,saved){var softmax=saved[0].exp();return dy.sub(dy.sum(axis,!0).mul(softmax))}}})($logits)}})},{"../gradients":147,"../tensor_util_env":237,"./operation":195}],212:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),sparse_to_dense=require("../ops/sparse_to_dense_util"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.sparseToDense=operation_1.op({sparseToDense_:function(sparseIndices,sparseValues,outputShape,defaultValue){void 0===defaultValue&&(defaultValue=0);var $sparseIndices=tensor_util_env_1.convertToTensor(sparseIndices,"sparseIndices","sparseToDense","int32"),$sparseValues=tensor_util_env_1.convertToTensor(sparseValues,"sparseValues","sparseToDense"),$defaultValue=tensor_util_env_1.convertToTensor(defaultValue,"defaultValue","sparseToDense",$sparseValues.dtype);return sparse_to_dense.validateInput($sparseIndices,$sparseValues,outputShape,$defaultValue),engine_1.ENGINE.runKernel(function(backend){return backend.sparseToDense($sparseIndices,$sparseValues,outputShape,$defaultValue)},{$sparseIndices:$sparseIndices,$sparseValues:$sparseValues,$defaultValue:$defaultValue})}})},{"../engine":143,"../ops/sparse_to_dense_util":213,"../tensor_util_env":237,"./operation":195}],213:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateInput=function(sparseIndices,sparseValues,outputShape,defaultValues){if("int32"!==sparseIndices.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+sparseIndices.dtype+".");if(2<sparseIndices.rank)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+sparseIndices.shape+".");var numElems=0<sparseIndices.rank?sparseIndices.shape[0]:1,numDims=1<sparseIndices.rank?sparseIndices.shape[1]:1;if(outputShape.length!==numDims)throw new Error("outputShape has incorrect number of elements:, "+outputShape.length+", should be: "+numDims+".");var numValues=sparseValues.size;if(0!==sparseValues.rank&&(1!==sparseValues.rank||numValues!==numElems))throw new Error("sparseValues has incorrect shape "+sparseValues.shape+", should be [] or ["+numElems+"]");if(sparseValues.dtype!==defaultValues.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}},{}],214:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),complex_ops_1=require("../ops/complex_ops"),operation_1=require("../ops/operation"),util_1=require("../util"),tensor_ops_1=require("./tensor_ops");exports.fft=operation_1.op({fft_:function(input){util_1.assert("complex64"===input.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+input.dtype+"."});var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize,input2D=input.as2D(batch,innerDimensionSize);return engine_1.ENGINE.runKernel(function(backend){return backend.fft(input2D)},{input:input}).reshape(input.shape)}}),exports.ifft=operation_1.op({ifft_:function(input){util_1.assert("complex64"===input.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+input.dtype+"."});var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize,input2D=input.as2D(batch,innerDimensionSize);return engine_1.ENGINE.runKernel(function(backend){return backend.ifft(input2D)},{input:input}).reshape(input.shape)}}),exports.rfft=operation_1.op({rfft_:function(input,fftLength){util_1.assert("float32"===input.dtype,function(){return"The dtype for rfft() must be real value but got "+input.dtype});var adjustedInput,innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize;if(null!=fftLength&&fftLength<innerDimensionSize){var begin=input.shape.map(function(v){return 0}),size=input.shape.map(function(v){return v});size[input.shape.length-1]=fftLength,adjustedInput=input.slice(begin,size),innerDimensionSize=fftLength}else if(null!=fftLength&&innerDimensionSize<fftLength){var zerosShape=input.shape.map(function(v){return v});zerosShape[input.shape.length-1]=fftLength-innerDimensionSize,adjustedInput=input.concat(tensor_ops_1.zeros(zerosShape),input.shape.length-1),innerDimensionSize=fftLength}else adjustedInput=input;var zerosInput=adjustedInput.zerosLike(),complexInput=complex_ops_1.complex(adjustedInput,zerosInput).as2D(batch,innerDimensionSize),ret=exports.fft(complexInput),half=Math.floor(innerDimensionSize/2)+1,realValues=complex_ops_1.real(ret),imagValues=complex_ops_1.imag(ret),realComplexConjugate=realValues.split([half,innerDimensionSize-half],realValues.shape.length-1),imagComplexConjugate=imagValues.split([half,innerDimensionSize-half],imagValues.shape.length-1),outputShape=adjustedInput.shape.slice();return outputShape[adjustedInput.shape.length-1]=half,complex_ops_1.complex(realComplexConjugate[0],imagComplexConjugate[0]).reshape(outputShape)}}),exports.irfft=operation_1.op({irfft_:function(input){var innerDimensionSize=input.shape[input.shape.length-1],batch=input.size/innerDimensionSize;if(innerDimensionSize<=2){var complexInput=input.as2D(batch,innerDimensionSize),ret=exports.ifft(complexInput);return complex_ops_1.real(ret)}var outputShape=[batch,2*(innerDimensionSize-1)],realInput=complex_ops_1.real(input).as2D(batch,innerDimensionSize),imagInput=complex_ops_1.imag(input).as2D(batch,innerDimensionSize),realConjugate=realInput.slice([0,1],[batch,innerDimensionSize-2]).reverse(1),imagConjugate=imagInput.slice([0,1],[batch,innerDimensionSize-2]).reverse(1).mul(tensor_ops_1.scalar(-1)),r=realInput.concat(realConjugate,1),i=imagInput.concat(imagConjugate,1);return complexInput=complex_ops_1.complex(r,i).as2D(outputShape[0],outputShape[1]),ret=exports.ifft(complexInput),complex_ops_1.real(ret)}})},{"../engine":143,"../ops/complex_ops":172,"../ops/operation":195,"../util":241,"./tensor_ops":216}],215:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation"),slice_1=require("./slice"),slice_util_1=require("./slice_util");exports.stridedSlice=operation_1.op({stridedSlice_:function(x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){if(void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),0!==ellipsisMask)throw new Error("ellipsis mask is not yet supported");if(0!==newAxisMask)throw new Error("new axis mask is not yet supported");var $x=tensor_util_env_1.convertToTensor(x,"x","stridedSlice");if(strides.every(function(v){return 1===v})){var _a=slice_util_1.getStridedSlicedInfo($x.shape,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask),beginIndex=_a[0],size=_a[1],shrinkAxis_1=_a[2],outShape=size.filter(function(_,index){return-1===shrinkAxis_1.indexOf(index)});return slice_1.slice($x,beginIndex,size).reshape(outShape)}return engine_1.ENGINE.runKernel(function(backend){return backend.stridedSlice($x,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)},{$x:$x})}})},{"../engine":143,"../tensor_util_env":237,"./operation":195,"./slice":209,"./slice_util":210}],216:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),environment_1=require("../environment"),tensor_1=require("../tensor"),tensor_util_env_1=require("../tensor_util_env"),util_1=require("../util"),complex_ops_1=require("./complex_ops"),operation_1=require("./operation");function makeTensor(values,shape,inferredShape,dtype){if(null==dtype&&(dtype=util_1.inferDtype(values)),"complex64"===dtype)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!util_1.isTypedArray(values)&&!Array.isArray(values)&&"number"!=typeof values&&"boolean"!=typeof values&&"string"!=typeof values)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=shape){util_1.assertNonNegativeIntegerDimensions(shape);var providedSize_1=util_1.sizeFromShape(shape),inferredSize_1=util_1.sizeFromShape(inferredShape);util_1.assert(providedSize_1===inferredSize_1,function(){return"Based on the provided shape, ["+shape+"], the tensor should have "+providedSize_1+" values but has "+inferredSize_1});for(var i=0;i<inferredShape.length;++i){var inferred=inferredShape[i],flatDimsDontMatch=i!==inferredShape.length-1||inferred!==util_1.sizeFromShape(shape.slice(i));util_1.assert(inferredShape[i]===shape[i]||!flatDimsDontMatch,function(){return"Error creating a new Tensor. Inferred shape ("+inferredShape+") does not match the provided shape ("+shape+"). "})}}return util_1.isTypedArray(values)||Array.isArray(values)||(values=[values]),shape=shape||inferredShape,values="string"!==dtype?util_1.toTypedArray(values,dtype,environment_1.ENV.getBool("DEBUG")):util_1.flatten(values,[],!0),tensor_1.Tensor.make(shape,{values:values},dtype)}function tensor1d(values,dtype){util_1.assertNonNull(values);var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(1!==inferredShape.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return makeTensor(values,null,inferredShape,dtype)}function zeros(shape,dtype){if(void 0===dtype&&(dtype="float32"),"complex64"===dtype){var real_2=zeros(shape,"float32"),imag_2=zeros(shape,"float32");return complex_ops_1.complex(real_2,imag_2)}var values=util_1.makeZerosTypedArray(util_1.sizeFromShape(shape),dtype);return tensor_1.Tensor.make(shape,{values:values},dtype)}exports.tensor=function(values,shape,dtype){return makeTensor(values,shape,tensor_util_env_1.inferShape(values,dtype),dtype)},exports.scalar=function(value,dtype){if((util_1.isTypedArray(value)&&"string"!==dtype||Array.isArray(value))&&"complex64"!==dtype)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===dtype&&util_1.isTypedArray(value)&&!(value instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return makeTensor(value,[],[],dtype)},exports.tensor1d=tensor1d,exports.tensor2d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&2!==shape.length)throw new Error("tensor2d() requires shape to have two numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(2!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor3d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&3!==shape.length)throw new Error("tensor3d() requires shape to have three numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(3!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor4d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&4!==shape.length)throw new Error("tensor4d() requires shape to have four numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(4!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor5d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&5!==shape.length)throw new Error("tensor5d() requires shape to have five numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(5!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape,inferredShape,dtype)},exports.tensor6d=function(values,shape,dtype){if(util_1.assertNonNull(values),null!=shape&&6!==shape.length)throw new Error("tensor6d() requires shape to have six numbers");var inferredShape=tensor_util_env_1.inferShape(values,dtype);if(6!==inferredShape.length&&1!==inferredShape.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===inferredShape.length&&null==shape)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return makeTensor(values,shape=shape||inferredShape,inferredShape,dtype)},exports.ones=function ones(shape,dtype){if(void 0===dtype&&(dtype="float32"),"complex64"===dtype){var real_1=ones(shape,"float32"),imag_1=zeros(shape,"float32");return complex_ops_1.complex(real_1,imag_1)}var values=util_1.makeOnesTypedArray(util_1.sizeFromShape(shape),dtype);return tensor_1.Tensor.make(shape,{values:values},dtype)},exports.zeros=zeros,exports.fill=function(shape,value,dtype){return engine_1.ENGINE.runKernel(function(backend){return backend.fill(shape,value,dtype)},{})},exports.linspace=function(start,stop,num){if(num<=0)throw new Error("The number of values should be positive.");return engine_1.ENGINE.runKernel(function(backend){return backend.linspace(start,stop,num)},{})},exports.range=function(start,stop,step,dtype){if(void 0===step&&(step=1),void 0===dtype&&(dtype="float32"),0===step)throw new Error("Cannot have a step of zero");if(start===stop||start<stop&&step<0||stop<start&&1<step)return zeros([0],dtype);var numElements=Math.abs(Math.ceil((stop-start)/step)),values=util_1.makeZerosTypedArray(numElements,dtype);stop<start&&1===step&&(step=-1),values[0]=start;for(var i=1;i<values.length;i++)values[i]=values[i-1]+step;return tensor1d(values,dtype)},exports.onesLike=operation_1.op({onesLike_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","onesLike");if("complex64"!==$x.dtype)return engine_1.ENGINE.runKernel(function(backend){return backend.onesLike($x)},{$x:$x},function(dy,saved){return{$x:function(){return exports.zerosLike(dy)}}});var r=exports.onesLike(complex_ops_1.real($x)),i=exports.zerosLike(complex_ops_1.imag($x));return complex_ops_1.complex(r,i)}}),exports.zerosLike=operation_1.op({zerosLike_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","zerosLike");return engine_1.ENGINE.runKernel(function(backend){return backend.zerosLike($x)},{$x:$x},function(dy,saved){return{$x:function(){return exports.zerosLike(dy)}}})}})},{"../engine":143,"../environment":144,"../tensor":234,"../tensor_util_env":237,"../util":241,"./complex_ops":172,"./operation":195}],217:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),operation_1=require("./operation");exports.topk=operation_1.op({topk_:function(x,k,sorted){void 0===k&&(k=1),void 0===sorted&&(sorted=!0);var $x=tensor_util_env_1.convertToTensor(x,"x","topk");if(0===$x.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var lastDim=$x.shape[$x.shape.length-1];if(lastDim<k)throw new Error("'k' passed to topk() must be <= the last dimension ("+lastDim+") but got "+k);var _a=engine_1.ENGINE.runKernel(function(b){return b.topk($x,k,sorted)},{$x:$x});return{values:_a[0],indices:_a[1]}}})},{"../engine":143,"../tensor_util_env":237,"./operation":195}],218:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation");exports.transpose=operation_1.op({transpose_:function(x,perm){var $x=tensor_util_env_1.convertToTensor(x,"x","transpose");return null==perm&&(perm=$x.shape.map(function(s,i){return i}).reverse()),util.assert($x.rank===perm.length,function(){return"Error in transpose: rank of input "+$x.rank+" must match length of perm "+perm+"."}),perm.forEach(function(axis){util.assert(0<=axis&&axis<$x.rank,function(){return"All entries in 'perm' must be between 0 and "+($x.rank-1)+" but got "+perm})}),$x.rank<=1?$x.clone():engine_1.ENGINE.runKernel(function(backend){return backend.transpose($x,perm)},{$x:$x},function(dy){var undoPerm=axis_util.getUndoAxesPermutation(perm);return{$x:function(){return dy.transpose(undoPerm)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./axis_util":165,"./operation":195}],219:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),tensor_util_env_1=require("../tensor_util_env"),util=require("../util"),operation_1=require("./operation"),tensor_ops_1=require("./tensor_ops");exports.abs=operation_1.op({abs_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","abs");return"complex64"===$x.dtype?engine_1.ENGINE.runKernel(function(backend){return backend.complexAbs($x)},{$x:$x}):engine_1.ENGINE.runKernel(function(backend,save){var res=backend.abs($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.toFloat().step(-1))}}})}}),exports.acos=operation_1.op({acos_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","acos");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.acos($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).sub($x.toFloat().square()).sqrt()).neg()}}})}}),exports.acosh=operation_1.op({acosh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","acosh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.acosh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict($x.toFloat().square().sub(1).sqrt())}}})}}),exports.asin=operation_1.op({asin_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","asin");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.asin($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).sub($x.toFloat().square()).sqrt())}}})}}),exports.asinh=operation_1.op({asinh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","asinh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.asinh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.divStrict(tensor_ops_1.scalar(1).add($x.toFloat().square()).sqrt())}}})}}),exports.atan=operation_1.op({atan_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","atan");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.atan($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat().square().add(1))}}})}}),exports.atanh=operation_1.op({atanh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","atanh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.atanh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div(tensor_ops_1.scalar(1).sub($x.toFloat().square()))}}})}}),exports.ceil=operation_1.op({ceil_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","ceil");return engine_1.ENGINE.runKernel(function(backend){return backend.ceil($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.clipByValue=operation_1.op({clipByValue_:function(x,clipValueMin,clipValueMax){var $x=tensor_util_env_1.convertToTensor(x,"x","clipByValue");return util.assert(clipValueMin<=clipValueMax,function(){return"Error in clip: min ("+clipValueMin+") must be less than or equal to max ("+clipValueMax+")."}),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.clip($x,clipValueMin,clipValueMax);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.where($x.greaterEqual(clipValueMin).logicalAnd($x.lessEqual(clipValueMax)),tensor_ops_1.zerosLike(dy))}}})}}),exports.cos=operation_1.op({cos_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","cos");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.cos($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().sin().neg().mul(dy)}}})}}),exports.cosh=operation_1.op({cosh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","cosh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.cosh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().sinh().mulStrict(dy)}}})}}),exports.erf=operation_1.op({erf_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","erf");return util.assert("int32"===$x.dtype||"float32"===$x.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===$x.dtype&&($x=$x.toFloat()),engine_1.ENGINE.runKernel(function(backend,save){var res=backend.erf($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),exports.exp=operation_1.op({exp_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","exp");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.exp($x);return save([y]),y},{$x:$x},function(dy,saved){return{$x:function(){return dy.mulStrict(saved[0])}}})}}),exports.expm1=operation_1.op({expm1_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","expm1");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.expm1($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.exp())}}})}}),exports.floor=operation_1.op({floor_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","floor");return engine_1.ENGINE.runKernel(function(backend){return backend.floor($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.log=operation_1.op({log_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","log");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.log($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat())}}})}}),exports.log1p=operation_1.op({log1p_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","log1p");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.log1p($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.add(1))}}})}}),exports.logSigmoid=operation_1.op({logSigmoid_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","logSigmoid");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.softplus($x.neg()).neg();return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.neg().sigmoid())}}})}}),exports.neg=operation_1.op({neg_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","neg");return engine_1.ENGINE.runKernel(function(backend){return backend.neg($x)},{$x:$x},function(dy){return{$x:function(){return dy.neg()}}})}}),exports.reciprocal=operation_1.op({reciprocal_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","reciprocal");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.reciprocal($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.square().neg())}}})}}),exports.round=operation_1.op({round_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","round");return engine_1.ENGINE.runKernel(function(backend){return backend.round($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.rsqrt=operation_1.op({rsqrt_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","rsqrt");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.rsqrt($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.pow(1.5).mul(2)).neg()}}})}}),exports.sigmoid=operation_1.op({sigmoid_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sigmoid");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.sigmoid($x);return save([y]),y},{$x:$x},function(dy,saved){var y=saved[0];return{$x:function(){return dy.mul(y.mul(tensor_ops_1.scalar(1).sub(y)))}}})}}),exports.sign=operation_1.op({sign_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sign");return engine_1.ENGINE.runKernel(function(backend){return backend.sign($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.isNaN=operation_1.op({isNaN_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isNaN");return engine_1.ENGINE.runKernel(function(backend){return backend.isNaN($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.isInf=operation_1.op({isInf_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isInf");return engine_1.ENGINE.runKernel(function(backend){return backend.isInf($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.isFinite=operation_1.op({isFinite_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","isFinite");return engine_1.ENGINE.runKernel(function(backend){return backend.isFinite($x)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.sin=operation_1.op({sin_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sin");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.sin($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().cos().mul(dy)}}})}}),exports.sinh=operation_1.op({sinh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sinh");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.sinh($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return $x.toFloat().cosh().mulStrict(dy)}}})}}),exports.softplus=operation_1.op({softplus_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","softplus");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.softplus($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.sigmoid())}}})}}),exports.sqrt=operation_1.op({sqrt_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","sqrt");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.sqrt($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.toFloat().sqrt().mul(2))}}})}}),exports.square=operation_1.op({square_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","square");return engine_1.ENGINE.runKernel(function(backend,save){return save([$x]),backend.square($x)},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.mul($x.toFloat().mul(2))}}})}}),exports.step=operation_1.op({step_:function(x,alpha){void 0===alpha&&(alpha=0);var $x=tensor_util_env_1.convertToTensor(x,"x","step");return engine_1.ENGINE.runKernel(function(backend){return backend.step($x,alpha)},{$x:$x},function(dy){return{$x:function(){return tensor_ops_1.zerosLike(dy)}}})}}),exports.tan=operation_1.op({tan_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","tan");return engine_1.ENGINE.runKernel(function(backend,save){var res=backend.tan($x);return save([$x]),res},{$x:$x},function(dy,saved){var $x=saved[0];return{$x:function(){return dy.div($x.cos().square())}}})}}),exports.tanh=operation_1.op({tanh_:function(x){var $x=tensor_util_env_1.convertToTensor(x,"x","tanh");return engine_1.ENGINE.runKernel(function(backend,save){var y=backend.tanh($x);return save([y]),y},{$x:$x},function(dy,saved){var y=saved[0];return{$x:function(){return tensor_ops_1.scalar(1).sub(y.square()).mulStrict(dy)}}})}})},{"../engine":143,"../tensor_util_env":237,"../util":241,"./operation":195,"./tensor_ops":216}],220:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdadeltaOptimizer=function(_super){function AdadeltaOptimizer(learningRate,rho,epsilon){void 0===epsilon&&(epsilon=null);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.rho=rho,_this.epsilon=epsilon,_this.accumulatedGrads=[],_this.accumulatedUpdates=[],null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdadeltaOptimizer,_super),AdadeltaOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedGrads[i]&&(_this.accumulatedGrads[i]={originalName:name+"/accum_grad",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedUpdates[i]&&(_this.accumulatedUpdates[i]={originalName:name+"/accum_var",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedGrad=_this.accumulatedGrads[i].variable,accumulatedUpdate=_this.accumulatedUpdates[i].variable;globals_1.tidy(function(){var newAccumulatedGrad=accumulatedGrad.mul(_this.rho).add(gradient.square().mul(1-_this.rho)),updates=accumulatedUpdate.add(_this.epsilon).sqrt().div(accumulatedGrad.add(_this.epsilon).sqrt()).mul(gradient),newAccumulatedUpdate=accumulatedUpdate.mul(_this.rho).add(updates.square().mul(1-_this.rho));accumulatedGrad.assign(newAccumulatedGrad),accumulatedUpdate.assign(newAccumulatedUpdate);var newValue=updates.mul(-_this.learningRate).add(value);value.assign(newValue)})}}),this.incrementIterations()},AdadeltaOptimizer.prototype.dispose=function(){null!=this.accumulatedUpdates&&(globals_1.dispose(this.accumulatedGrads.map(function(v){return v.variable})),globals_1.dispose(this.accumulatedUpdates.map(function(v){return v.variable})))},AdadeltaOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){var variables;return __generator(this,function(_a){switch(_a.label){case 0:return variables=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},AdadeltaOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){var variableCount;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),variableCount=weightValues.length/2,!1,this.accumulatedGrads=weightValues.slice(0,variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.accumulatedUpdates=weightValues.slice(variableCount,2*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},AdadeltaOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},AdadeltaOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.rho,config.epsilon)},AdadeltaOptimizer.className="Adadelta",AdadeltaOptimizer}(require("./optimizer").Optimizer);exports.AdadeltaOptimizer=AdadeltaOptimizer,serialization_1.registerClass(AdadeltaOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],221:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdagradOptimizer=function(_super){function AdagradOptimizer(learningRate,initialAccumulatorValue){void 0===initialAccumulatorValue&&(initialAccumulatorValue=.1);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.initialAccumulatorValue=initialAccumulatorValue,_this.accumulatedGrads=[],_this}return __extends(AdagradOptimizer,_super),AdagradOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];if(null==_this.accumulatedGrads[i]){_this.accumulatedGrads[i]={originalName:name+"/accumulator",variable:globals_1.tidy(function(){return ops_1.fill(value.shape,_this.initialAccumulatorValue).variable(!1)})}}var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedGrad=_this.accumulatedGrads[i].variable;globals_1.tidy(function(){var newAccumulatedGrad=accumulatedGrad.add(gradient.square());accumulatedGrad.assign(newAccumulatedGrad);var newValue=gradient.div(newAccumulatedGrad.add(engine_1.ENGINE.backend.epsilon()).sqrt()).mul(-_this.learningRate).add(value);value.assign(newValue)})}}),this.incrementIterations()},AdagradOptimizer.prototype.dispose=function(){null!=this.accumulatedGrads&&globals_1.dispose(this.accumulatedGrads.map(function(v){return v.variable}))},AdagradOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(this.accumulatedGrads.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},AdagradOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),!1,this.accumulatedGrads=weightValues.map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},AdagradOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},AdagradOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.initialAccumulatorValue)},AdagradOptimizer.className="Adagrad",AdagradOptimizer}(require("./optimizer").Optimizer);exports.AdagradOptimizer=AdagradOptimizer,serialization_1.registerClass(AdagradOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],222:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdamOptimizer=function(_super){function AdamOptimizer(learningRate,beta1,beta2,epsilon){void 0===epsilon&&(epsilon=null);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.beta1=beta1,_this.beta2=beta2,_this.epsilon=epsilon,_this.accumulatedFirstMoment=[],_this.accumulatedSecondMoment=[],globals_1.tidy(function(){_this.accBeta1=ops_1.scalar(beta1).variable(),_this.accBeta2=ops_1.scalar(beta2).variable()}),null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdamOptimizer,_super),AdamOptimizer.prototype.applyGradients=function(variableGradients){var _this=this,varNames=Array.isArray(variableGradients)?variableGradients.map(function(v){return v.name}):Object.keys(variableGradients);globals_1.tidy(function(){var oneMinusAccBeta1=ops_1.sub(1,_this.accBeta1),oneMinusAccBeta2=ops_1.sub(1,_this.accBeta2);varNames.forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedFirstMoment[i]&&(_this.accumulatedFirstMoment[i]={originalName:name+"/m",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedSecondMoment[i]&&(_this.accumulatedSecondMoment[i]={originalName:name+"/v",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var firstMoment=_this.accumulatedFirstMoment[i].variable,secondMoment=_this.accumulatedSecondMoment[i].variable,newFirstMoment=firstMoment.mul(_this.beta1).add(gradient.mul(1-_this.beta1)),newSecondMoment=secondMoment.mul(_this.beta2).add(gradient.square().mul(1-_this.beta2)),biasCorrectedFirstMoment=newFirstMoment.div(oneMinusAccBeta1),biasCorrectedSecondMoment=newSecondMoment.div(oneMinusAccBeta2);firstMoment.assign(newFirstMoment),secondMoment.assign(newSecondMoment);var newValue=biasCorrectedFirstMoment.div(biasCorrectedSecondMoment.sqrt().add(_this.epsilon)).mul(-_this.learningRate).add(value);value.assign(newValue)}}),_this.accBeta1.assign(_this.accBeta1.mul(_this.beta1)),_this.accBeta2.assign(_this.accBeta2.mul(_this.beta2))}),this.incrementIterations()},AdamOptimizer.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&globals_1.dispose(this.accumulatedFirstMoment.map(function(v){return v.variable})),null!=this.accumulatedSecondMoment&&globals_1.dispose(this.accumulatedSecondMoment.map(function(v){return v.variable}))},AdamOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){var variables;return __generator(this,function(_a){switch(_a.label){case 0:return variables=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},AdamOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){var variableCount,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),globals_1.tidy(function(){_this.accBeta1.assign(ops_1.pow(_this.beta1,_this.iterations_+1)),_this.accBeta2.assign(ops_1.pow(_this.beta2,_this.iterations_+1))}),variableCount=weightValues.length/2,!1,this.accumulatedFirstMoment=weightValues.slice(0,variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.accumulatedSecondMoment=weightValues.slice(variableCount,2*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},AdamOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},AdamOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.beta1,config.beta2,config.epsilon)},AdamOptimizer.className="Adam",AdamOptimizer}(require("./optimizer").Optimizer);exports.AdamOptimizer=AdamOptimizer,serialization_1.registerClass(AdamOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],223:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),AdamaxOptimizer=function(_super){function AdamaxOptimizer(learningRate,beta1,beta2,epsilon,decay){void 0===epsilon&&(epsilon=null),void 0===decay&&(decay=0);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.beta1=beta1,_this.beta2=beta2,_this.epsilon=epsilon,_this.decay=decay,_this.accumulatedFirstMoment=[],_this.accumulatedWeightedInfNorm=[],globals_1.tidy(function(){_this.iteration=ops_1.scalar(0).variable(),_this.accBeta1=ops_1.scalar(beta1).variable()}),null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(AdamaxOptimizer,_super),AdamaxOptimizer.prototype.applyGradients=function(variableGradients){var _this=this,variableNames=Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients);globals_1.tidy(function(){var oneMinusAccBeta1=ops_1.sub(1,_this.accBeta1),lr=ops_1.div(-_this.learningRate,_this.iteration.mul(_this.decay).add(1));variableNames.forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedFirstMoment[i]&&(_this.accumulatedFirstMoment[i]={originalName:name+"/m",variable:ops_1.zerosLike(value).variable(!1)}),null==_this.accumulatedWeightedInfNorm[i]&&(_this.accumulatedWeightedInfNorm[i]={originalName:name+"/v",variable:ops_1.zerosLike(value).variable(!1)});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var firstMoment=_this.accumulatedFirstMoment[i].variable,weightedInfNorm=_this.accumulatedWeightedInfNorm[i].variable,newFirstMoment=firstMoment.mul(_this.beta1).add(gradient.mul(1-_this.beta1)),ut0=weightedInfNorm.mul(_this.beta2),ut1=gradient.abs(),newWeightedInfNorm=ut0.maximum(ut1);firstMoment.assign(newFirstMoment),weightedInfNorm.assign(newWeightedInfNorm);var newValue=lr.div(oneMinusAccBeta1).mul(newFirstMoment.div(newWeightedInfNorm.add(_this.epsilon))).add(value);value.assign(newValue)}}),_this.iteration.assign(_this.iteration.add(1)),_this.accBeta1.assign(_this.accBeta1.mul(_this.beta1))}),this.incrementIterations()},AdamaxOptimizer.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&globals_1.dispose(this.accumulatedFirstMoment.map(function(v){return v.variable})),null!=this.accumulatedWeightedInfNorm&&globals_1.dispose(this.accumulatedWeightedInfNorm.map(function(v){return v.variable}))},AdamaxOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("getWeights() is not implemented for Adamax yet.")})})},AdamaxOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("setWeights() is not implemented for Adamax yet.")})})},AdamaxOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},AdamaxOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.beta1,config.beta2,config.epsilon,config.decay)},AdamaxOptimizer.className="Adamax",AdamaxOptimizer}(require("./optimizer").Optimizer);exports.AdamaxOptimizer=AdamaxOptimizer,serialization_1.registerClass(AdamaxOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],224:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),MomentumOptimizer=function(_super){function MomentumOptimizer(learningRate,momentum,useNesterov){void 0===useNesterov&&(useNesterov=!1);var _this=_super.call(this,learningRate)||this;return _this.learningRate=learningRate,_this.momentum=momentum,_this.useNesterov=useNesterov,_this.accumulations=[],_this.m=ops_1.scalar(_this.momentum),_this}return __extends(MomentumOptimizer,_super),MomentumOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];if(null==_this.accumulations[i]){_this.accumulations[i]={originalName:name+"/momentum",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}}var accumulation=_this.accumulations[i].variable,gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];null!=gradient&&globals_1.tidy(function(){var newValue,newAccumulation=_this.m.mul(accumulation).add(gradient);newValue=_this.useNesterov?_this.c.mul(gradient.add(newAccumulation.mul(_this.m))).add(value):_this.c.mul(newAccumulation).add(value),accumulation.assign(newAccumulation),value.assign(newValue)})}),this.incrementIterations()},MomentumOptimizer.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&globals_1.dispose(this.accumulations.map(function(v){return v.variable}))},MomentumOptimizer.prototype.setMomentum=function(momentum){this.momentum=momentum},MomentumOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(this.accumulations.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},MomentumOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),!1,this.accumulations=weightValues.map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),[2]}})})},MomentumOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},MomentumOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.momentum,config.useNesterov)},MomentumOptimizer.className="Momentum",MomentumOptimizer}(require("./sgd_optimizer").SGDOptimizer);exports.MomentumOptimizer=MomentumOptimizer,serialization_1.registerClass(MomentumOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./sgd_optimizer":228}],225:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var globals_1=require("../globals"),gradients_1=require("../gradients"),ops_1=require("../ops/ops"),Optimizer=function(_super){function Optimizer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Optimizer,_super),Optimizer.prototype.minimize=function(f,returnCost,varList){void 0===returnCost&&(returnCost=!1);var _a=this.computeGradients(f,varList),value=_a.value,grads=_a.grads;if(null!=varList){var gradArray=varList.map(function(v){return{name:v.name,tensor:grads[v.name]}});this.applyGradients(gradArray)}else this.applyGradients(grads);return globals_1.dispose(grads),returnCost?value:(value.dispose(),null)},Object.defineProperty(Optimizer.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),Optimizer.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},Optimizer.prototype.computeGradients=function(f,varList){return gradients_1.variableGrads(f,varList)},Optimizer.prototype.dispose=function(){null!=this.iterations_&&globals_1.dispose(this.iterations_)},Optimizer.prototype.saveIterations=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:ops_1.scalar(this.iterations_,"int32")}]})})},Optimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},Optimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},Optimizer.prototype.extractIterations=function(weightValues){return __awaiter(this,void 0,void 0,function(){var _a;return __generator(this,function(_b){switch(_b.label){case 0:return _a=this,[4,weightValues[0].tensor.data()];case 1:return _a.iterations_=_b.sent()[0],[2,weightValues.slice(1)]}})})},Optimizer}(require("../serialization").Serializable);exports.Optimizer=Optimizer,Object.defineProperty(Optimizer,Symbol.hasInstance,{value:function(instance){return null!=instance.minimize&&null!=instance.computeGradients&&null!=instance.applyGradients}})},{"../globals":146,"../gradients":147,"../ops/ops":196,"../serialization":232}],226:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var adadelta_optimizer_1=require("./adadelta_optimizer"),adagrad_optimizer_1=require("./adagrad_optimizer"),adam_optimizer_1=require("./adam_optimizer"),adamax_optimizer_1=require("./adamax_optimizer"),momentum_optimizer_1=require("./momentum_optimizer"),rmsprop_optimizer_1=require("./rmsprop_optimizer"),sgd_optimizer_1=require("./sgd_optimizer"),OptimizerConstructors=function(){function OptimizerConstructors(){}return OptimizerConstructors.sgd=function(learningRate){return new sgd_optimizer_1.SGDOptimizer(learningRate)},OptimizerConstructors.momentum=function(learningRate,momentum,useNesterov){return void 0===useNesterov&&(useNesterov=!1),new momentum_optimizer_1.MomentumOptimizer(learningRate,momentum,useNesterov)},OptimizerConstructors.rmsprop=function(learningRate,decay,momentum,epsilon,centered){return void 0===decay&&(decay=.9),void 0===momentum&&(momentum=0),void 0===epsilon&&(epsilon=null),void 0===centered&&(centered=!1),new rmsprop_optimizer_1.RMSPropOptimizer(learningRate,decay,momentum,epsilon,centered)},OptimizerConstructors.adam=function(learningRate,beta1,beta2,epsilon){return void 0===learningRate&&(learningRate=.001),void 0===beta1&&(beta1=.9),void 0===beta2&&(beta2=.999),void 0===epsilon&&(epsilon=null),new adam_optimizer_1.AdamOptimizer(learningRate,beta1,beta2,epsilon)},OptimizerConstructors.adadelta=function(learningRate,rho,epsilon){return void 0===learningRate&&(learningRate=.001),void 0===rho&&(rho=.95),void 0===epsilon&&(epsilon=null),new adadelta_optimizer_1.AdadeltaOptimizer(learningRate,rho,epsilon)},OptimizerConstructors.adamax=function(learningRate,beta1,beta2,epsilon,decay){return void 0===learningRate&&(learningRate=.002),void 0===beta1&&(beta1=.9),void 0===beta2&&(beta2=.999),void 0===epsilon&&(epsilon=null),void 0===decay&&(decay=0),new adamax_optimizer_1.AdamaxOptimizer(learningRate,beta1,beta2,epsilon,decay)},OptimizerConstructors.adagrad=function(learningRate,initialAccumulatorValue){return void 0===initialAccumulatorValue&&(initialAccumulatorValue=.1),new adagrad_optimizer_1.AdagradOptimizer(learningRate,initialAccumulatorValue)},OptimizerConstructors}();exports.OptimizerConstructors=OptimizerConstructors},{"./adadelta_optimizer":220,"./adagrad_optimizer":221,"./adam_optimizer":222,"./adamax_optimizer":223,"./momentum_optimizer":224,"./rmsprop_optimizer":227,"./sgd_optimizer":228}],227:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),RMSPropOptimizer=function(_super){function RMSPropOptimizer(learningRate,decay,momentum,epsilon,centered){void 0===decay&&(decay=.9),void 0===momentum&&(momentum=0),void 0===epsilon&&(epsilon=null),void 0===centered&&(centered=!1);var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.decay=decay,_this.momentum=momentum,_this.epsilon=epsilon,_this.accumulatedMeanSquares=[],_this.accumulatedMoments=[],_this.accumulatedMeanGrads=[],_this.centered=centered,null==epsilon&&(_this.epsilon=engine_1.ENGINE.backend.epsilon()),_this}return __extends(RMSPropOptimizer,_super),RMSPropOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(item){return item.name}):Object.keys(variableGradients)).forEach(function(name,i){var value=engine_1.ENGINE.registeredVariables[name];null==_this.accumulatedMeanSquares[i]&&(_this.accumulatedMeanSquares[i]={originalName:name+"/rms",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedMoments[i]&&(_this.accumulatedMoments[i]={originalName:name+"/momentum",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})}),null==_this.accumulatedMeanGrads[i]&&_this.centered&&(_this.accumulatedMeanGrads[i]={originalName:name+"/mg",variable:globals_1.tidy(function(){return ops_1.zerosLike(value).variable(!1)})});var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var accumulatedMeanSquare=_this.accumulatedMeanSquares[i].variable,accumulatedMoments=_this.accumulatedMoments[i].variable;globals_1.tidy(function(){var newAccumulatedMeanSquare=accumulatedMeanSquare.mul(_this.decay).add(gradient.square().mul(1-_this.decay));if(_this.centered){var accumulatedMeanGrad=_this.accumulatedMeanGrads[i].variable,newAccumulatedMeanGrad=accumulatedMeanGrad.mul(_this.decay).add(gradient.mul(1-_this.decay)),newAccumulatedMoments=accumulatedMoments.mul(_this.momentum).add(gradient.mul(_this.learningRate).div(newAccumulatedMeanSquare.sub(newAccumulatedMeanGrad.square().add(_this.epsilon)).sqrt()));accumulatedMeanSquare.assign(newAccumulatedMeanSquare),accumulatedMeanGrad.assign(newAccumulatedMeanGrad),accumulatedMoments.assign(newAccumulatedMoments);var newValue=value.sub(newAccumulatedMoments);value.assign(newValue)}else{var newAccumulatedMeanSquare_1=accumulatedMeanSquare.mul(_this.decay).add(gradient.square().mul(1-_this.decay));newAccumulatedMoments=accumulatedMoments.mul(_this.momentum).add(gradient.mul(_this.learningRate).div(newAccumulatedMeanSquare_1.add(_this.epsilon).sqrt()));accumulatedMeanSquare.assign(newAccumulatedMeanSquare_1),accumulatedMoments.assign(newAccumulatedMoments);newValue=value.sub(newAccumulatedMoments);value.assign(newValue)}})}}),this.incrementIterations()},RMSPropOptimizer.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&globals_1.dispose(this.accumulatedMeanSquares.map(function(v){return v.variable})),null!=this.accumulatedMeanGrads&&this.centered&&globals_1.dispose(this.accumulatedMeanGrads.map(function(v){return v.variable})),null!=this.accumulatedMoments&&globals_1.dispose(this.accumulatedMoments.map(function(v){return v.variable}))},RMSPropOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){var variables;return __generator(this,function(_a){switch(_a.label){case 0:return variables=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&variables.push.apply(variables,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[_a.sent()].concat(variables.map(function(v){return{name:v.originalName,tensor:v.variable}}))]}})})},RMSPropOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){var variableCount;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:return weightValues=_a.sent(),variableCount=this.centered?weightValues.length/3:weightValues.length/2,!1,this.accumulatedMeanSquares=weightValues.slice(0,variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.accumulatedMoments=weightValues.slice(variableCount,2*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=weightValues.slice(2*variableCount,3*variableCount).map(function(v){return{originalName:v.name,variable:v.tensor.variable(!1)}})),[2]}})})},RMSPropOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},RMSPropOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate,config.decay,config.momentum,config.epsilon,config.centered)},RMSPropOptimizer.className="RMSProp",RMSPropOptimizer}(require("./optimizer").Optimizer);exports.RMSPropOptimizer=RMSPropOptimizer,serialization_1.registerClass(RMSPropOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],228:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("../engine"),globals_1=require("../globals"),ops_1=require("../ops/ops"),serialization_1=require("../serialization"),SGDOptimizer=function(_super){function SGDOptimizer(learningRate){var _this=_super.call(this)||this;return _this.learningRate=learningRate,_this.setLearningRate(learningRate),_this}return __extends(SGDOptimizer,_super),SGDOptimizer.prototype.applyGradients=function(variableGradients){var _this=this;(Array.isArray(variableGradients)?variableGradients.map(function(v){return v.name}):Object.keys(variableGradients)).forEach(function(name,i){var gradient=Array.isArray(variableGradients)?variableGradients[i].tensor:variableGradients[name];if(null!=gradient){var value=engine_1.ENGINE.registeredVariables[name];globals_1.tidy(function(){var newValue=_this.c.mul(gradient).add(value);value.assign(newValue)})}}),this.incrementIterations()},SGDOptimizer.prototype.setLearningRate=function(learningRate){this.learningRate=learningRate,null!=this.c&&this.c.dispose(),this.c=globals_1.keep(ops_1.scalar(-learningRate))},SGDOptimizer.prototype.dispose=function(){this.c.dispose()},SGDOptimizer.prototype.getWeights=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[_a.sent()]]}})})},SGDOptimizer.prototype.setWeights=function(weightValues){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.extractIterations(weightValues)];case 1:if(0!==(weightValues=_a.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},SGDOptimizer.prototype.getConfig=function(){return{learningRate:this.learningRate}},SGDOptimizer.fromConfig=function(cls,config){return new cls(config.learningRate)},SGDOptimizer.className="SGD",SGDOptimizer}(require("./optimizer").Optimizer);exports.SGDOptimizer=SGDOptimizer,serialization_1.registerClass(SGDOptimizer)},{"../engine":143,"../globals":146,"../ops/ops":196,"../serialization":232,"./optimizer":225}],229:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),PlatformBrowser=function(){function PlatformBrowser(){this.textEncoder=new TextEncoder}return PlatformBrowser.prototype.fetch=function(path,init){return fetch(path,init)},PlatformBrowser.prototype.now=function(){return performance.now()},PlatformBrowser.prototype.encode=function(text,encoding){if("utf-8"!==encoding&&"utf8"!==encoding)throw new Error("Browser's encoder only supports utf-8, but got "+encoding);return this.textEncoder.encode(text)},PlatformBrowser.prototype.decode=function(bytes,encoding){return new TextDecoder(encoding).decode(bytes)},PlatformBrowser}();exports.PlatformBrowser=PlatformBrowser,environment_1.ENV.get("IS_BROWSER")&&environment_1.ENV.setPlatform("browser",new PlatformBrowser)},{"../environment":144}],230:[function(require,module,exports){(function(process){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment");exports.getNodeFetch={importFetch:function(){return require("node-fetch")}};var PlatformNode=function(){function PlatformNode(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}return PlatformNode.prototype.fetch=function(path,requestInits){return null!=environment_1.ENV.global.fetch?environment_1.ENV.global.fetch(path,requestInits):(null==exports.systemFetch&&(exports.systemFetch=exports.getNodeFetch.importFetch()),exports.systemFetch(path,requestInits))},PlatformNode.prototype.now=function(){var time=process.hrtime();return 1e3*time[0]+time[1]/1e6},PlatformNode.prototype.encode=function(text,encoding){if("utf-8"!==encoding&&"utf8"!==encoding)throw new Error("Node built-in encoder only supports utf-8, but got "+encoding);return this.textEncoder.encode(text)},PlatformNode.prototype.decode=function(bytes,encoding){return 0===bytes.length?"":new this.util.TextDecoder(encoding).decode(bytes)},PlatformNode}();exports.PlatformNode=PlatformNode,environment_1.ENV.get("IS_NODE")&&environment_1.ENV.setPlatform("node",new PlatformNode)}).call(this,require("_process"))},{"../environment":144,_process:337,"node-fetch":333,util:333}],231:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("./util"),Profiler=function(){function Profiler(backendTimer,logger){this.backendTimer=backendTimer,null==(this.logger=logger)&&(this.logger=new Logger)}return Profiler.prototype.profileKernel=function(name,inputs,f){var result,_this=this,timer=this.backendTimer.time(function(){result=f()});return(Array.isArray(result)?result:[result]).forEach(function(r){var vals=r.dataSync();util.checkComputationForErrors(vals,r.dtype,name),timer.then(function(timing){var extraInfo="";null!=timing.getExtraProfileInfo&&(extraInfo=timing.getExtraProfileInfo()),_this.logger.logKernelProfile(name,r,vals,timing.kernelMs,inputs,extraInfo)})}),result},Profiler}();exports.Profiler=Profiler;var Logger=function(){function Logger(){}return Logger.prototype.logKernelProfile=function(name,result,vals,timeMs,inputs,extraInfo){var time=util.rightPad(timeMs+"ms",9),paddedName=util.rightPad(name,25),rank=result.rank,size=result.size,shape=util.rightPad(result.shape.toString(),14),inputShapesDescription="";for(var name_1 in inputs){var inputShape=inputs[name_1].shape,inputRank=inputShape.length;inputShapesDescription+=name_1+": "+inputRank+"D "+(0<inputRank?inputShape:"")+" "}console.log("%c"+paddedName+"\t%c"+time+"\t%c"+rank+"D "+shape+"\t%c"+size+"\t%c"+inputShapesDescription+"\t%c"+extraInfo,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},Logger}();exports.Logger=Logger},{"./util":241}],232:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./util"),Serializable=function(){function Serializable(){}return Serializable.prototype.getClassName=function(){return this.constructor.className},Serializable.fromConfig=function(cls,config){return new cls(config)},Serializable}();exports.Serializable=Serializable;var SerializationMap=function(){function SerializationMap(){this.classNameMap={}}return SerializationMap.getMap=function(){return null==SerializationMap.instance&&(SerializationMap.instance=new SerializationMap),SerializationMap.instance},SerializationMap.register=function(cls){SerializationMap.getMap().classNameMap[cls.className]=[cls,cls.fromConfig]},SerializationMap}();exports.SerializationMap=SerializationMap,exports.registerClass=function(cls){util_1.assert(null!=cls.className,function(){return"Class being registered does not have the static className property defined."}),util_1.assert("string"==typeof cls.className,function(){return"className is required to be a string, but got type "+typeof cls.className}),util_1.assert(0<cls.className.length,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),SerializationMap.register(cls)}},{"./util":241}],233:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("./tensor"),util=require("./util");exports.getFilteredNodesXToY=function(tape,xs,y){for(var tensorsFromX={},nodesFromX={},i=0;i<xs.length;i++)tensorsFromX[xs[i].id]=!0;for(i=0;i<tape.length;i++){var nodeInputs=(node=tape[i]).inputs;for(var inputName in nodeInputs){for(var input=nodeInputs[inputName],anyInputFromX=!1,j=0;j<xs.length;j++)if(tensorsFromX[input.id]){node.outputs.forEach(function(output){return tensorsFromX[output.id]=!0}),anyInputFromX=!0,nodesFromX[node.id]=!0;break}if(anyInputFromX)break}}var tensorsLeadToY={};tensorsLeadToY[y.id]=!0;var nodesToY={};for(i=tape.length-1;0<=i;i--)for(nodeInputs=(node=tape[i]).inputs,j=0;j<node.outputs.length;j++)if(tensorsLeadToY[node.outputs[j].id]){for(var inputName in nodeInputs)tensorsLeadToY[nodeInputs[inputName].id]=!0,nodesToY[node.id]=!0;break}var filteredTape=[];for(i=0;i<tape.length;i++){var node;if(nodesFromX[(node=tape[i]).id]&&nodesToY[node.id]){var prunedInputs={};for(var inputName in node.inputs){var nodeInput=node.inputs[inputName];tensorsFromX[nodeInput.id]&&(prunedInputs[inputName]=nodeInput)}var prunedNode=Object.assign({},node);prunedNode.inputs=prunedInputs,prunedNode.outputs=node.outputs,filteredTape.push(prunedNode)}}return filteredTape},exports.backpropagateGradients=function(tensorAccumulatedGradientMap,filteredTape,tidy){for(var _loop_1=function(i){var node=filteredTape[i],dys=[];if(node.outputs.forEach(function(o){var gradTensor=tensorAccumulatedGradientMap[o.id];if(null!=gradTensor)dys.push(gradTensor);else{var dy=tensor_1.Tensor.make(o.shape,{values:util.makeZerosTypedArray(o.size,o.dtype)},o.dtype);dys.push(dy)}}),null==node.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+node.name+".");function _loop_2(inputName){if(!(inputName in inputGradients))throw new Error("Cannot backprop through input "+inputName+". Available gradients found: "+Object.keys(inputGradients)+".");var dx=tidy(function(){return inputGradients[inputName]()});if("float32"!==dx.dtype)throw new Error("Error in gradient for op "+node.name+". The gradient of input "+inputName+" must have 'float32' dtype, but has '"+dx.dtype+"'");var x=node.inputs[inputName];if(!util.arraysEqual(dx.shape,x.shape))throw new Error("Error in gradient for op "+node.name+". The gradient of input '"+inputName+"' has shape '"+dx.shape+"', which does not match the shape of the input '"+x.shape+"'");if(null==tensorAccumulatedGradientMap[x.id])tensorAccumulatedGradientMap[x.id]=dx;else{var curGradient=tensorAccumulatedGradientMap[x.id];tensorAccumulatedGradientMap[x.id]=curGradient.add(dx),curGradient.dispose()}}var inputGradients=node.gradient(1===node.outputs.length?dys[0]:dys);for(var inputName in node.inputs)_loop_2(inputName)},i=filteredTape.length-1;0<=i;i--)_loop_1(i)}},{"./tensor":234,"./util":241}],234:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tensor_format_1=require("./tensor_format"),util=require("./util"),util_1=require("./util"),TensorBuffer=function(){function TensorBuffer(shape,dtype,values){var _this=this;if(this.dtype=dtype,this.shape=shape.slice(),this.size=util.sizeFromShape(shape),null!=values){var n_1=values.length;util.assert(n_1===this.size,function(){return"Length of values '"+n_1+"' does not match the size inferred by the shape '"+_this.size+"'."})}if("complex64"===dtype)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=values||util.getArrayFromDType(dtype,this.size),this.strides=util_1.computeStrides(shape)}return TensorBuffer.prototype.set=function(value){for(var _this=this,locs=[],_i=1;_i<arguments.length;_i++)locs[_i-1]=arguments[_i];0===locs.length&&(locs=[0]),util.assert(locs.length===this.rank,function(){return"The number of provided coordinates ("+locs.length+") must match the rank ("+_this.rank+")"});var index=this.locToIndex(locs);this.values[index]=value},TensorBuffer.prototype.get=function(){for(var locs=[],_i=0;_i<arguments.length;_i++)locs[_i]=arguments[_i];0===locs.length&&(locs=[0]);for(var i=0,_a=0,locs_1=locs;_a<locs_1.length;_a++){var loc=locs_1[_a];if(loc<0||loc>=this.shape[i]){var msg="Requested out of range element at "+locs+".   Buffer shape="+this.shape;throw new Error(msg)}i++}for(var index=locs[locs.length-1],i_1=0;i_1<locs.length-1;++i_1)index+=this.strides[i_1]*locs[i_1];return this.values[index]},TensorBuffer.prototype.locToIndex=function(locs){if(0===this.rank)return 0;if(1===this.rank)return locs[0];for(var index=locs[locs.length-1],i=0;i<locs.length-1;++i)index+=this.strides[i]*locs[i];return index},TensorBuffer.prototype.indexToLoc=function(index){if(0===this.rank)return[];if(1===this.rank)return[index];for(var locs=new Array(this.shape.length),i=0;i<locs.length-1;++i)locs[i]=Math.floor(index/this.strides[i]),index-=locs[i]*this.strides[i];return locs[locs.length-1]=index,locs},Object.defineProperty(TensorBuffer.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),TensorBuffer.prototype.toTensor=function(){return Tensor.make(this.shape,{values:this.values},this.dtype)},TensorBuffer}();exports.TensorBuffer=TensorBuffer;var trackerFn=null,opHandler=null,deprecationWarningFn=null;exports.setTensorTracker=function(fn){trackerFn=fn},exports.setOpHandler=function(handler){opHandler=handler},exports.setDeprecationWarningFn=function(fn){deprecationWarningFn=fn};var Tensor=function(){function Tensor(shape,dtype,values,dataId,backend){this.kept=!1,this.isDisposedInternal=!1,this.shape=shape.slice(),this.dtype=dtype||"float32",this.size=util.sizeFromShape(shape),this.strides=util_1.computeStrides(shape),this.dataId=null!=dataId?dataId:{},this.id=trackerFn().nextTensorId(),this.rankType=this.rank<5?this.rank.toString():"higher",trackerFn().registerTensor(this,backend),null!=values&&trackerFn().write(backend,this.dataId,values)}return Tensor.make=function(shape,data,dtype,backend){var backendVals=data.values;return null!=data.values&&"string"===dtype&&util.isString(data.values[0])&&(backendVals=data.values.map(function(d){return util.encodeString(d)})),new Tensor(shape,dtype,backendVals,data.dataId,backend)},Tensor.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},Tensor.prototype.asScalar=function(){return this.throwIfDisposed(),util.assert(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},Tensor.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},Tensor.prototype.as2D=function(rows,columns){return this.throwIfDisposed(),this.reshape([rows,columns])},Tensor.prototype.as3D=function(rows,columns,depth){return this.throwIfDisposed(),this.reshape([rows,columns,depth])},Tensor.prototype.as4D=function(rows,columns,depth,depth2){return this.throwIfDisposed(),this.reshape([rows,columns,depth,depth2])},Tensor.prototype.as5D=function(rows,columns,depth,depth2,depth3){return this.throwIfDisposed(),this.reshape([rows,columns,depth,depth2,depth3])},Tensor.prototype.asType=function(dtype){return this.throwIfDisposed(),opHandler.cast(this,dtype)},Object.defineProperty(Tensor.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),Tensor.prototype.buffer=function(){return __awaiter(this,void 0,void 0,function(){var vals;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.data()];case 1:return vals=_a.sent(),[2,opHandler.buffer(this.shape,this.dtype,vals)]}})})},Tensor.prototype.bufferSync=function(){return opHandler.buffer(this.shape,this.dtype,this.dataSync())},Tensor.prototype.array=function(){return __awaiter(this,void 0,void 0,function(){var vals;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.data()];case 1:return vals=_a.sent(),[2,util_1.toNestedArray(this.shape,vals)]}})})},Tensor.prototype.arraySync=function(){return util_1.toNestedArray(this.shape,this.dataSync())},Tensor.prototype.data=function(){return __awaiter(this,void 0,void 0,function(){var data,bytes;return __generator(this,function(_a){switch(_a.label){case 0:return this.throwIfDisposed(),data=trackerFn().read(this.dataId),"string"!==this.dtype?[3,2]:[4,data];case 1:bytes=_a.sent();try{return[2,bytes.map(function(b){return util.decodeString(b)})]}catch(_b){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}_a.label=2;case 2:return[2,data]}})})},Tensor.prototype.dataSync=function(){this.throwIfDisposed();var data=trackerFn().readSync(this.dataId);if("string"===this.dtype)try{return data.map(function(b){return util.decodeString(b)})}catch(_a){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return data},Tensor.prototype.bytes=function(){return __awaiter(this,void 0,void 0,function(){var data;return __generator(this,function(_a){switch(_a.label){case 0:return this.throwIfDisposed(),[4,trackerFn().read(this.dataId)];case 1:return data=_a.sent(),"string"===this.dtype?[2,data]:[2,new Uint8Array(data.buffer)]}})})},Tensor.prototype.dispose=function(){this.isDisposed||(trackerFn().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(Tensor.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),Tensor.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},Tensor.prototype.toFloat=function(){return this.asType("float32")},Tensor.prototype.toInt=function(){return this.asType("int32")},Tensor.prototype.toBool=function(){return this.asType("bool")},Tensor.prototype.print=function(verbose){return void 0===verbose&&(verbose=!1),opHandler.print(this,verbose)},Tensor.prototype.reshape=function(newShape){return this.throwIfDisposed(),opHandler.reshape(this,newShape)},Tensor.prototype.reshapeAs=function(x){return this.throwIfDisposed(),this.reshape(x.shape)},Tensor.prototype.expandDims=function(axis){return void 0===axis&&(axis=0),opHandler.expandDims(this,axis)},Tensor.prototype.cumsum=function(axis,exclusive,reverse){return void 0===axis&&(axis=0),void 0===exclusive&&(exclusive=!1),void 0===reverse&&(reverse=!1),opHandler.cumsum(this,axis,exclusive,reverse)},Tensor.prototype.squeeze=function(axis){return this.throwIfDisposed(),opHandler.squeeze(this,axis)},Tensor.prototype.clone=function(){return this.throwIfDisposed(),opHandler.clone(this)},Tensor.prototype.oneHot=function(depth,onValue,offValue){return this.throwIfDisposed(),opHandler.oneHot(this,depth,onValue,offValue)},Tensor.prototype.toString=function(verbose){void 0===verbose&&(verbose=!1);var vals=this.dataSync();return tensor_format_1.tensorToString(vals,this.shape,this.dtype,verbose)},Tensor.prototype.tile=function(reps){return this.throwIfDisposed(),opHandler.tile(this,reps)},Tensor.prototype.gather=function(indices,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),opHandler.gather(this,indices,axis)},Tensor.prototype.matMul=function(b,transposeA,transposeB){return void 0===transposeA&&(transposeA=!1),void 0===transposeB&&(transposeB=!1),this.throwIfDisposed(),opHandler.matMul(this,b,transposeA,transposeB)},Tensor.prototype.dot=function(b){return this.throwIfDisposed(),opHandler.dot(this,b)},Tensor.prototype.norm=function(ord,axis,keepDims){return void 0===ord&&(ord="euclidean"),void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.norm(this,ord,axis,keepDims)},Tensor.prototype.slice=function(begin,size){return this.throwIfDisposed(),opHandler.slice(this,begin,size)},Tensor.prototype.reverse=function(axis){return this.throwIfDisposed(),opHandler.reverse(this,axis)},Tensor.prototype.concat=function(x,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),x instanceof Tensor&&(x=[x]),opHandler.concat([this].concat(x),axis)},Tensor.prototype.split=function(numOrSizeSplits,axis){return void 0===axis&&(axis=0),this.throwIfDisposed(),opHandler.split(this,numOrSizeSplits,axis)},Tensor.prototype.stack=function(x,axis){return void 0===axis&&(axis=0),opHandler.stack([this,x],axis)},Tensor.prototype.unstack=function(axis){return void 0===axis&&(axis=0),opHandler.unstack(this,axis)},Tensor.prototype.pad=function(paddings,constantValue){return void 0===constantValue&&(constantValue=0),opHandler.pad(this,paddings,constantValue)},Tensor.prototype.batchNormalization=function(mean,variance,varianceEpsilon,scale,offset){return void 0===varianceEpsilon&&(varianceEpsilon=.001),deprecationWarningFn("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(mean,variance,offset,scale,varianceEpsilon)},Tensor.prototype.batchNorm=function(mean,variance,offset,scale,varianceEpsilon){return void 0===varianceEpsilon&&(varianceEpsilon=.001),this.throwIfDisposed(),opHandler.batchNorm(this,mean,variance,offset,scale,varianceEpsilon)},Tensor.prototype.all=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.all(this,axis,keepDims)},Tensor.prototype.any=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.any(this,axis,keepDims)},Tensor.prototype.logSumExp=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.logSumExp(this,axis,keepDims)},Tensor.prototype.sum=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.sum(this,axis,keepDims)},Tensor.prototype.prod=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.prod(this,axis,keepDims)},Tensor.prototype.mean=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.mean(this,axis,keepDims)},Tensor.prototype.min=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.min(this,axis,keepDims)},Tensor.prototype.max=function(axis,keepDims){return void 0===axis&&(axis=null),void 0===keepDims&&(keepDims=!1),this.throwIfDisposed(),opHandler.max(this,axis,keepDims)},Tensor.prototype.argMin=function(axis){return void 0===axis&&(axis=null),this.throwIfDisposed(),opHandler.argMin(this,axis)},Tensor.prototype.argMax=function(axis){return void 0===axis&&(axis=null),this.throwIfDisposed(),opHandler.argMax(this,axis)},Tensor.prototype.cast=function(dtype){return this.throwIfDisposed(),opHandler.cast(this,dtype)},Tensor.prototype.add=function(x){return this.throwIfDisposed(),opHandler.add(this,x)},Tensor.prototype.addStrict=function(x){return this.throwIfDisposed(),opHandler.addStrict(this,x)},Tensor.prototype.atan2=function(x){return this.throwIfDisposed(),opHandler.atan2(this,x)},Tensor.prototype.sub=function(x){return this.throwIfDisposed(),opHandler.sub(this,x)},Tensor.prototype.subStrict=function(x){return this.throwIfDisposed(),opHandler.subStrict(this,x)},Tensor.prototype.pow=function(exp){return this.throwIfDisposed(),opHandler.pow(this,exp)},Tensor.prototype.powStrict=function(exp){return this.throwIfDisposed(),opHandler.powStrict(this,exp)},Tensor.prototype.mul=function(x){return this.throwIfDisposed(),opHandler.mul(this,x)},Tensor.prototype.mulStrict=function(x){return this.throwIfDisposed(),opHandler.mulStrict(this,x)},Tensor.prototype.div=function(x){return this.throwIfDisposed(),opHandler.div(this,x)},Tensor.prototype.floorDiv=function(x){return this.throwIfDisposed(),opHandler.floorDiv(this,x)},Tensor.prototype.divStrict=function(x){return this.throwIfDisposed(),opHandler.divStrict(this,x)},Tensor.prototype.minimum=function(x){return this.throwIfDisposed(),opHandler.minimum(this,x)},Tensor.prototype.minimumStrict=function(x){return this.throwIfDisposed(),opHandler.minimumStrict(this,x)},Tensor.prototype.maximum=function(x){return this.throwIfDisposed(),opHandler.maximum(this,x)},Tensor.prototype.maximumStrict=function(x){return this.throwIfDisposed(),opHandler.maximumStrict(this,x)},Tensor.prototype.mod=function(x){return this.throwIfDisposed(),opHandler.mod(this,x)},Tensor.prototype.modStrict=function(x){return this.throwIfDisposed(),opHandler.modStrict(this,x)},Tensor.prototype.squaredDifference=function(x){return this.throwIfDisposed(),opHandler.squaredDifference(this,x)},Tensor.prototype.squaredDifferenceStrict=function(x){return this.throwIfDisposed(),opHandler.squaredDifferenceStrict(this,x)},Tensor.prototype.transpose=function(perm){return this.throwIfDisposed(),opHandler.transpose(this,perm)},Tensor.prototype.notEqual=function(x){return this.throwIfDisposed(),opHandler.notEqual(this,x)},Tensor.prototype.notEqualStrict=function(x){return this.throwIfDisposed(),opHandler.notEqualStrict(this,x)},Tensor.prototype.less=function(x){return this.throwIfDisposed(),opHandler.less(this,x)},Tensor.prototype.lessStrict=function(x){return this.throwIfDisposed(),opHandler.lessStrict(this,x)},Tensor.prototype.equal=function(x){return this.throwIfDisposed(),opHandler.equal(this,x)},Tensor.prototype.equalStrict=function(x){return this.throwIfDisposed(),opHandler.equalStrict(this,x)},Tensor.prototype.lessEqual=function(x){return this.throwIfDisposed(),opHandler.lessEqual(this,x)},Tensor.prototype.lessEqualStrict=function(x){return this.throwIfDisposed(),opHandler.lessEqualStrict(this,x)},Tensor.prototype.greater=function(x){return this.throwIfDisposed(),opHandler.greater(this,x)},Tensor.prototype.greaterStrict=function(x){return this.throwIfDisposed(),opHandler.greaterStrict(this,x)},Tensor.prototype.greaterEqual=function(x){return this.throwIfDisposed(),opHandler.greaterEqual(this,x)},Tensor.prototype.greaterEqualStrict=function(x){return this.throwIfDisposed(),opHandler.greaterEqualStrict(this,x)},Tensor.prototype.logicalAnd=function(x){return this.throwIfDisposed(),opHandler.logicalAnd(this,x)},Tensor.prototype.logicalOr=function(x){return this.throwIfDisposed(),opHandler.logicalOr(this,x)},Tensor.prototype.logicalNot=function(){return this.throwIfDisposed(),opHandler.logicalNot(this)},Tensor.prototype.logicalXor=function(x){return this.throwIfDisposed(),opHandler.logicalXor(this,x)},Tensor.prototype.where=function(condition,x){return this.throwIfDisposed(),opHandler.where(condition,this,x)},Tensor.prototype.neg=function(){return this.throwIfDisposed(),opHandler.neg(this)},Tensor.prototype.ceil=function(){return this.throwIfDisposed(),opHandler.ceil(this)},Tensor.prototype.floor=function(){return this.throwIfDisposed(),opHandler.floor(this)},Tensor.prototype.sign=function(){return this.throwIfDisposed(),opHandler.sign(this)},Tensor.prototype.isNaN=function(){return this.throwIfDisposed(),opHandler.isNaN(this)},Tensor.prototype.isInf=function(){return this.throwIfDisposed(),opHandler.isInf(this)},Tensor.prototype.isFinite=function(){return this.throwIfDisposed(),opHandler.isFinite(this)},Tensor.prototype.exp=function(){return this.throwIfDisposed(),opHandler.exp(this)},Tensor.prototype.expm1=function(){return this.throwIfDisposed(),opHandler.expm1(this)},Tensor.prototype.log=function(){return this.throwIfDisposed(),opHandler.log(this)},Tensor.prototype.log1p=function(){return this.throwIfDisposed(),opHandler.log1p(this)},Tensor.prototype.sqrt=function(){return this.throwIfDisposed(),opHandler.sqrt(this)},Tensor.prototype.rsqrt=function(){return this.throwIfDisposed(),opHandler.rsqrt(this)},Tensor.prototype.square=function(){return this.throwIfDisposed(),opHandler.square(this)},Tensor.prototype.reciprocal=function(){return this.throwIfDisposed(),opHandler.reciprocal(this)},Tensor.prototype.abs=function(){return this.throwIfDisposed(),opHandler.abs(this)},Tensor.prototype.clipByValue=function(min,max){return this.throwIfDisposed(),opHandler.clipByValue(this,min,max)},Tensor.prototype.relu=function(){return this.throwIfDisposed(),opHandler.relu(this)},Tensor.prototype.elu=function(){return this.throwIfDisposed(),opHandler.elu(this)},Tensor.prototype.selu=function(){return this.throwIfDisposed(),opHandler.selu(this)},Tensor.prototype.leakyRelu=function(alpha){return void 0===alpha&&(alpha=.2),this.throwIfDisposed(),opHandler.leakyRelu(this,alpha)},Tensor.prototype.prelu=function(alpha){return this.throwIfDisposed(),opHandler.prelu(this,alpha)},Tensor.prototype.sigmoid=function(){return this.throwIfDisposed(),opHandler.sigmoid(this)},Tensor.prototype.logSigmoid=function(){return this.throwIfDisposed(),opHandler.logSigmoid(this)},Tensor.prototype.softplus=function(){return this.throwIfDisposed(),opHandler.softplus(this)},Tensor.prototype.zerosLike=function(){return this.throwIfDisposed(),opHandler.zerosLike(this)},Tensor.prototype.onesLike=function(){return this.throwIfDisposed(),opHandler.onesLike(this)},Tensor.prototype.sin=function(){return this.throwIfDisposed(),opHandler.sin(this)},Tensor.prototype.cos=function(){return this.throwIfDisposed(),opHandler.cos(this)},Tensor.prototype.tan=function(){return this.throwIfDisposed(),opHandler.tan(this)},Tensor.prototype.asin=function(){return this.throwIfDisposed(),opHandler.asin(this)},Tensor.prototype.acos=function(){return this.throwIfDisposed(),opHandler.acos(this)},Tensor.prototype.atan=function(){return this.throwIfDisposed(),opHandler.atan(this)},Tensor.prototype.sinh=function(){return this.throwIfDisposed(),opHandler.sinh(this)},Tensor.prototype.cosh=function(){return this.throwIfDisposed(),opHandler.cosh(this)},Tensor.prototype.tanh=function(){return this.throwIfDisposed(),opHandler.tanh(this)},Tensor.prototype.asinh=function(){return this.throwIfDisposed(),opHandler.asinh(this)},Tensor.prototype.acosh=function(){return this.throwIfDisposed(),opHandler.acosh(this)},Tensor.prototype.atanh=function(){return this.throwIfDisposed(),opHandler.atanh(this)},Tensor.prototype.erf=function(){return this.throwIfDisposed(),opHandler.erf(this)},Tensor.prototype.round=function(){return this.throwIfDisposed(),opHandler.round(this)},Tensor.prototype.step=function(alpha){return void 0===alpha&&(alpha=0),this.throwIfDisposed(),opHandler.step(this,alpha)},Tensor.prototype.softmax=function(dim){return void 0===dim&&(dim=-1),this.throwIfDisposed(),opHandler.softmax(this,dim)},Tensor.prototype.logSoftmax=function(axis){return void 0===axis&&(axis=-1),this.throwIfDisposed(),opHandler.logSoftmax(this,axis)},Tensor.prototype.resizeBilinear=function(newShape2D,alignCorners){return void 0===alignCorners&&(alignCorners=!1),this.throwIfDisposed(),opHandler.image.resizeBilinear(this,newShape2D,alignCorners)},Tensor.prototype.resizeNearestNeighbor=function(newShape2D,alignCorners){return void 0===alignCorners&&(alignCorners=!1),this.throwIfDisposed(),opHandler.image.resizeNearestNeighbor(this,newShape2D,alignCorners)},Tensor.prototype.conv1d=function(filter,stride,pad,dataFormat,dilation,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NWC"),void 0===dilation&&(dilation=1),this.throwIfDisposed(),opHandler.conv1d(this,filter,stride,pad,dataFormat,dilation,dimRoundingMode)},Tensor.prototype.conv2d=function(filter,strides,pad,dataFormat,dilations,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]),this.throwIfDisposed(),opHandler.conv2d(this,filter,strides,pad,dataFormat,dilations,dimRoundingMode)},Tensor.prototype.conv2dTranspose=function(filter,outputShape,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.conv2dTranspose(this,filter,outputShape,strides,pad,dimRoundingMode)},Tensor.prototype.depthwiseConv2D=function(filter,strides,pad,dataFormat,dilations,dimRoundingMode){return void 0===dataFormat&&(dataFormat="NHWC"),void 0===dilations&&(dilations=[1,1]),this.throwIfDisposed(),opHandler.depthwiseConv2d(this,filter,strides,pad,dataFormat,dilations,dimRoundingMode)},Tensor.prototype.separableConv2d=function(depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat){return void 0===dilation&&(dilation=[1,1]),void 0===dataFormat&&(dataFormat="NHWC"),this.throwIfDisposed(),opHandler.separableConv2d(this,depthwiseFilter,pointwiseFilter,strides,pad,dilation,dataFormat)},Tensor.prototype.avgPool=function(filterSize,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.avgPool(this,filterSize,strides,pad,dimRoundingMode)},Tensor.prototype.maxPool=function(filterSize,strides,pad,dimRoundingMode){return this.throwIfDisposed(),opHandler.maxPool(this,filterSize,strides,pad,dimRoundingMode)},Tensor.prototype.localResponseNormalization=function(radius,bias,alpha,beta){return void 0===radius&&(radius=5),void 0===bias&&(bias=1),void 0===alpha&&(alpha=1),void 0===beta&&(beta=.5),opHandler.localResponseNormalization(this,radius,bias,alpha,beta)},Tensor.prototype.pool=function(windowShape,poolingType,padding,dilationRate,strides){return this.throwIfDisposed(),opHandler.pool(this,windowShape,poolingType,padding,dilationRate,strides)},Tensor.prototype.variable=function(trainable,name,dtype){return void 0===trainable&&(trainable=!0),this.throwIfDisposed(),Variable.variable(this,trainable,name,dtype)},Tensor.prototype.unsortedSegmentSum=function(segmentIds,numSegments){return this.throwIfDisposed(),opHandler.unsortedSegmentSum(this,segmentIds,numSegments)},Tensor.prototype.batchToSpaceND=function(blockShape,crops){return this.throwIfDisposed(),opHandler.batchToSpaceND(this,blockShape,crops)},Tensor.prototype.spaceToBatchND=function(blockShape,paddings){return this.throwIfDisposed(),opHandler.spaceToBatchND(this,blockShape,paddings)},Tensor.prototype.topk=function(k,sorted){return void 0===k&&(k=1),void 0===sorted&&(sorted=!0),this.throwIfDisposed(),opHandler.topk(this,k,sorted)},Tensor.prototype.stridedSlice=function(begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask){return void 0===beginMask&&(beginMask=0),void 0===endMask&&(endMask=0),void 0===ellipsisMask&&(ellipsisMask=0),void 0===newAxisMask&&(newAxisMask=0),void 0===shrinkAxisMask&&(shrinkAxisMask=0),this.throwIfDisposed(),opHandler.stridedSlice(this,begin,end,strides,beginMask,endMask,ellipsisMask,newAxisMask,shrinkAxisMask)},Tensor.prototype.depthToSpace=function(blockSize,dataFormat){return this.throwIfDisposed(),opHandler.depthToSpace(this,blockSize,dataFormat)},Tensor.prototype.fft=function(){return this.throwIfDisposed(),opHandler.spectral.fft(this)},Tensor.prototype.ifft=function(){return this.throwIfDisposed(),opHandler.spectral.ifft(this)},Tensor.prototype.rfft=function(){return this.throwIfDisposed(),opHandler.spectral.rfft(this)},Tensor.prototype.irfft=function(){return this.throwIfDisposed(),opHandler.spectral.irfft(this)},Tensor}();exports.Tensor=Tensor,Object.defineProperty(Tensor,Symbol.hasInstance,{value:function(instance){return!!instance&&null!=instance.dataId&&null!=instance.shape&&null!=instance.dtype}});var Variable=function(_super){function Variable(initialValue,trainable,name){void 0===trainable&&(trainable=!0);var _this=_super.call(this,initialValue.shape,initialValue.dtype,null,initialValue.dataId)||this;_this.trainable=trainable,_this.name=name,null==_this.name&&(_this.name=trackerFn().nextVariableId().toString());try{trackerFn().registerVariable(_this)}catch(ex){throw trackerFn().disposeTensor(_this),ex}return _this}return __extends(Variable,_super),Variable.variable=function(initialValue,trainable,name,dtype){return void 0===trainable&&(trainable=!0),null!=dtype&&dtype!==initialValue.dtype&&(initialValue=initialValue.asType(dtype)),new Variable(initialValue,trainable,name)},Variable.prototype.assign=function(newValue){if(newValue.dtype!==this.dtype)throw new Error("dtype of the new value ("+newValue.dtype+") and previous value ("+this.dtype+") must match");if(!util.arraysEqual(newValue.shape,this.shape))throw new Error("shape of the new value ("+newValue.shape+") and previous value ("+this.shape+") must match");trackerFn().disposeTensor(this),this.dataId=newValue.dataId,trackerFn().registerTensor(this)},Variable.prototype.dispose=function(){trackerFn().disposeVariable(this),this.isDisposedInternal=!0},Variable}(Tensor);exports.Variable=Variable,Object.defineProperty(Variable,Symbol.hasInstance,{value:function(instance){return instance instanceof Tensor&&null!=instance.assign&&instance.assign instanceof Function}});var variable=Variable.variable;exports.variable=variable},{"./tensor_format":235,"./util":241}],235:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./util"),FORMAT_LIMIT_NUM_VALS=20,FORMAT_NUM_FIRST_LAST_VALS=3,FORMAT_NUM_SIG_DIGITS=7;function valToString(val,pad,dtype){var valStr;return valStr=Array.isArray(val)?parseFloat(val[0].toFixed(FORMAT_NUM_SIG_DIGITS))+" + "+parseFloat(val[1].toFixed(FORMAT_NUM_SIG_DIGITS))+"j":util_1.isString(val)?"'"+val+"'":"bool"===dtype?boolNumToString(val):parseFloat(val.toFixed(FORMAT_NUM_SIG_DIGITS)).toString(),util_1.rightPad(valStr,pad)}function boolNumToString(v){return 0===v?"false":"true"}function createComplexTuples(vals){for(var complexTuples=[],i=0;i<vals.length;i+=2)complexTuples.push([vals[i],vals[i+1]]);return complexTuples}exports.tensorToString=function(vals,shape,dtype,verbose){var strides=util_1.computeStrides(shape),padPerCol=function(vals,shape,dtype,strides){var n=util_1.sizeFromShape(shape),numCols=strides[strides.length-1],padPerCol=new Array(numCols).fill(0),rank=shape.length,valuesOrTuples="complex64"===dtype?createComplexTuples(vals):vals;if(1<rank)for(var row=0;row<n/numCols;row++)for(var offset=row*numCols,j=0;j<numCols;j++)padPerCol[j]=Math.max(padPerCol[j],valToString(valuesOrTuples[offset+j],0,dtype).length);return padPerCol}(vals,shape,dtype,strides),rank=shape.length,valsLines=function subTensorToString(vals,shape,dtype,strides,padPerCol,isLast){void 0===isLast&&(isLast=!0);var storagePerElement="complex64"===dtype?2:1;var size=shape[0];var rank=shape.length;if(0===rank){if("complex64"!==dtype)return"bool"===dtype?[boolNumToString(vals[0])]:[vals[0].toString()];var complexTuple=createComplexTuples(vals);return[valToString(complexTuple[0],0,dtype)]}if(1===rank){if(FORMAT_LIMIT_NUM_VALS<size){var firstValsSize=FORMAT_NUM_FIRST_LAST_VALS*storagePerElement,firstVals=Array.from(vals.slice(0,firstValsSize)),lastVals=Array.from(vals.slice(size-FORMAT_NUM_FIRST_LAST_VALS*storagePerElement,size));return"complex64"===dtype&&(firstVals=createComplexTuples(firstVals),lastVals=createComplexTuples(lastVals)),["["+firstVals.map(function(x,i){return valToString(x,padPerCol[i],dtype)}).join(", ")+", ..., "+lastVals.map(function(x,i){return valToString(x,padPerCol[size-FORMAT_NUM_FIRST_LAST_VALS+i],dtype)}).join(", ")+"]"]}var displayVals="complex64"===dtype?createComplexTuples(vals):Array.from(vals);return["["+displayVals.map(function(x,i){return valToString(x,padPerCol[i],dtype)}).join(", ")+"]"]}var subshape=shape.slice(1);var substrides=strides.slice(1);var stride=strides[0]*storagePerElement;var lines=[];if(FORMAT_LIMIT_NUM_VALS<size){for(var i=0;i<FORMAT_NUM_FIRST_LAST_VALS;i++){var start=i*stride,end=start+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,!1))}lines.push("...");for(var i=size-FORMAT_NUM_FIRST_LAST_VALS;i<size;i++){var start=i*stride,end=start+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,i===size-1))}}else for(var i=0;i<size;i++){var start=i*stride,end=start+stride;lines.push.apply(lines,subTensorToString(vals.slice(start,end),subshape,dtype,substrides,padPerCol,i===size-1))}var sep=2===rank?",":"";lines[0]="["+lines[0]+sep;for(var i=1;i<lines.length-1;i++)lines[i]=" "+lines[i]+sep;var newLineSep=",\n";for(var i=2;i<rank;i++)newLineSep+="\n";lines[lines.length-1]=" "+lines[lines.length-1]+"]"+(isLast?"":newLineSep);return lines}(vals,shape,dtype,strides,padPerCol),lines=["Tensor"];return verbose&&(lines.push("  dtype: "+dtype),lines.push("  rank: "+rank),lines.push("  shape: ["+shape+"]"),lines.push("  values:")),lines.push(valsLines.map(function(l){return"    "+l}).join("\n")),lines.join("\n")}},{"./util":241}],236:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tensor_1=require("./tensor"),types_1=require("./types"),util_1=require("./util");exports.makeTypesMatch=function(a,b){if(a.dtype===b.dtype)return[a,b];var dtype=types_1.upcastType(a.dtype,b.dtype);return[a.cast(dtype),b.cast(dtype)]},exports.assertTypesMatch=function(a,b){util_1.assert(a.dtype===b.dtype,function(){return"The dtypes of the first("+a.dtype+") and second("+b.dtype+") input must match"})},exports.isTensorInList=function(tensor,tensorList){for(var i=0;i<tensorList.length;i++)if(tensorList[i].id===tensor.id)return!0;return!1},exports.getTensorsInContainer=function(result){var list=[];return function walkTensorContainer(container,list,seen){if(null==container)return;if(container instanceof tensor_1.Tensor)return void list.push(container);if(obj=container,!Array.isArray(obj)&&"object"!=typeof obj)return;var obj;var iterable=container;for(var k in iterable){var val=iterable[k];seen.has(val)||(seen.add(val),walkTensorContainer(val,list,seen))}}(result,list,new Set),list}},{"./tensor":234,"./types":240,"./util":241}],237:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment"),tensor_1=require("./tensor"),util_1=require("./util");function inferShape(val,dtype){var firstElem=val;if(util_1.isTypedArray(val))return"string"===dtype?[]:[val.length];if(!Array.isArray(val))return[];for(var shape=[];Array.isArray(firstElem)||util_1.isTypedArray(firstElem)&&"string"!==dtype;)shape.push(firstElem.length),firstElem=firstElem[0];return Array.isArray(val)&&environment_1.ENV.getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function deepAssertShapeConsistency(val,shape,indices){indices=indices||[];if(!Array.isArray(val)&&!util_1.isTypedArray(val))return void util_1.assert(0===shape.length,function(){return"Element arr["+indices.join("][")+"] is a primitive, but should be an array/TypedArray of "+shape[0]+" elements"});util_1.assert(0<shape.length,function(){return"Element arr["+indices.join("][")+"] should be a primitive, but is an array of "+val.length+" elements"});util_1.assert(val.length===shape[0],function(){return"Element arr["+indices.join("][")+"] should have "+shape[0]+" elements, but has "+val.length+" elements"});var subShape=shape.slice(1);for(var i=0;i<val.length;++i)deepAssertShapeConsistency(val[i],subShape,indices.concat(i))}(val,shape,[]),shape}function assertDtype(expectedDtype,actualDType,argName,functionName){if(null!=expectedDtype&&("numeric"!==expectedDtype&&expectedDtype!==actualDType||"numeric"===expectedDtype&&"string"===actualDType))throw new Error("Argument '"+argName+"' passed to '"+functionName+"' must be "+expectedDtype+" tensor, but got "+actualDType+" tensor")}function convertToTensor(x,argName,functionName,parseAsDtype){if(void 0===parseAsDtype&&(parseAsDtype="numeric"),x instanceof tensor_1.Tensor)return assertDtype(parseAsDtype,x.dtype,argName,functionName),x;var inferredDtype=util_1.inferDtype(x);if("string"!==inferredDtype&&0<=["bool","int32","float32"].indexOf(parseAsDtype)&&(inferredDtype=parseAsDtype),assertDtype(parseAsDtype,inferredDtype,argName,functionName),null==x||!util_1.isTypedArray(x)&&!Array.isArray(x)&&"number"!=typeof x&&"boolean"!=typeof x&&"string"!=typeof x){var type=null==x?"null":x.constructor.name;throw new Error("Argument '"+argName+"' passed to '"+functionName+"' must be a Tensor or TensorLike, but got '"+type+"'")}var inferredShape=inferShape(x,inferredDtype);util_1.isTypedArray(x)||Array.isArray(x)||(x=[x]);var values="string"!==inferredDtype?util_1.toTypedArray(x,inferredDtype,environment_1.ENV.getBool("DEBUG")):util_1.flatten(x,[],!0);return tensor_1.Tensor.make(inferredShape,{values:values},inferredDtype)}exports.inferShape=inferShape,exports.convertToTensor=convertToTensor,exports.convertToTensorArray=function(arg,argName,functionName,parseAsDtype){if(void 0===parseAsDtype&&(parseAsDtype="numeric"),!Array.isArray(arg))throw new Error("Argument "+argName+" passed to "+functionName+" must be a `Tensor[]` or `TensorLike[]`");return arg.map(function(t,i){return convertToTensor(t,argName+"["+i+"]",functionName)},parseAsDtype)}},{"./environment":144,"./tensor":234,"./util":241}],238:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var engine_1=require("./engine"),tensor_util_env_1=require("./tensor_util_env"),util_1=require("./util"),TEST_EPSILON_FLOAT32=.001;function testEpsilon(){return 32===engine_1.ENGINE.backend.floatPrecision()?TEST_EPSILON_FLOAT32:exports.TEST_EPSILON_FLOAT16}function expectArraysPredicate(actual,expected,predicate){var checkClassType=!0;if((util_1.isTypedArray(actual)||util_1.isTypedArray(expected))&&(checkClassType=!1),util_1.isTypedArray(actual)&&util_1.isTypedArray(expected)&&(checkClassType=!0),checkClassType){var aType=actual.constructor.name,bType=expected.constructor.name;if(aType!==bType)throw new Error("Arrays are of different type. Actual: "+aType+". Expected: "+bType)}if(Array.isArray(actual)&&Array.isArray(expected)){var actualShape=tensor_util_env_1.inferShape(actual),expectedShape=tensor_util_env_1.inferShape(expected);if(!util_1.arraysEqual(actualShape,expectedShape))throw new Error("Arrays have different shapes. Actual: ["+actualShape+"]. Expected: ["+expectedShape+"]")}var actualFlat=util_1.isTypedArray(actual)?actual:util_1.flatten(actual),expectedFlat=util_1.isTypedArray(expected)?expected:util_1.flatten(expected);if(actualFlat.length!==expectedFlat.length)throw new Error("Arrays have different lengths actual: "+actualFlat.length+" vs expected: "+expectedFlat.length+".\nActual:   "+actualFlat+".\nExpected: "+expectedFlat+".");for(var i=0;i<expectedFlat.length;++i){var a=actualFlat[i],e=expectedFlat[i];if(!predicate(a,e))throw new Error("Arrays differ: actual["+i+"] = "+a+", expected["+i+"] = "+e+".\nActual:   "+actualFlat+".\nExpected: "+expectedFlat+".")}}function areClose(a,e,epsilon){return!isFinite(a)&&!isFinite(e)||!(isNaN(a)||isNaN(e)||Math.abs(a-e)>epsilon)}exports.TEST_EPSILON_FLOAT16=.1,exports.expectArraysClose=function(actual,expected,epsilon){return null==epsilon&&(epsilon=testEpsilon()),expectArraysPredicate(actual,expected,function(a,b){return areClose(a,b,epsilon)})},exports.testEpsilon=testEpsilon,exports.expectPromiseToFail=function(fn,done){fn().then(function(){return done.fail()},function(){return done()})},exports.expectArraysEqual=function(actual,expected){var exp="string"==typeof expected||"number"==typeof expected||"boolean"==typeof expected?[expected]:expected;return util_1.isString(actual)||util_1.isString(actual[0])||util_1.isString(expected)||util_1.isString(expected[0])?expectArraysPredicate(actual,exp,function(a,b){return a==b}):expectArraysPredicate(actual,expected,function(a,b){return areClose(a,b,0)})},exports.expectNumbersClose=function(a,e,epsilon){if(null==epsilon&&(epsilon=testEpsilon()),!areClose(a,e,epsilon))throw new Error("Numbers differ: actual === "+a+", expected === "+e)},exports.expectValuesInRange=function(actual,low,high){for(var i=0;i<actual.length;i++)if(actual[i]<low||actual[i]>high)throw new Error("Value out of range:"+actual[i]+" low: "+low+", high: "+high)},exports.expectArrayBuffersEqual=function(actual,expected){expect(new Float32Array(actual)).toEqual(new Float32Array(expected))}},{"./engine":143,"./tensor_util_env":237,"./util":241}],239:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var adadelta_optimizer_1=require("./optimizers/adadelta_optimizer"),adagrad_optimizer_1=require("./optimizers/adagrad_optimizer"),adam_optimizer_1=require("./optimizers/adam_optimizer"),adamax_optimizer_1=require("./optimizers/adamax_optimizer"),momentum_optimizer_1=require("./optimizers/momentum_optimizer"),optimizer_constructors_1=require("./optimizers/optimizer_constructors"),rmsprop_optimizer_1=require("./optimizers/rmsprop_optimizer"),sgd_optimizer_1=require("./optimizers/sgd_optimizer");momentum_optimizer_1.MomentumOptimizer,sgd_optimizer_1.SGDOptimizer,adadelta_optimizer_1.AdadeltaOptimizer,adagrad_optimizer_1.AdagradOptimizer,rmsprop_optimizer_1.RMSPropOptimizer,adamax_optimizer_1.AdamaxOptimizer,adam_optimizer_1.AdamOptimizer,exports.train={sgd:optimizer_constructors_1.OptimizerConstructors.sgd,momentum:optimizer_constructors_1.OptimizerConstructors.momentum,adadelta:optimizer_constructors_1.OptimizerConstructors.adadelta,adagrad:optimizer_constructors_1.OptimizerConstructors.adagrad,rmsprop:optimizer_constructors_1.OptimizerConstructors.rmsprop,adamax:optimizer_constructors_1.OptimizerConstructors.adamax,adam:optimizer_constructors_1.OptimizerConstructors.adam}},{"./optimizers/adadelta_optimizer":220,"./optimizers/adagrad_optimizer":221,"./optimizers/adam_optimizer":222,"./optimizers/adamax_optimizer":223,"./optimizers/momentum_optimizer":224,"./optimizers/optimizer_constructors":226,"./optimizers/rmsprop_optimizer":227,"./optimizers/sgd_optimizer":228}],240:[function(require,module,exports){"use strict";var UpcastInt32AndMap,UpcastBoolAndMap,UpcastFloat32AndMap,UpcastComplex64AndMap;Object.defineProperty(exports,"__esModule",{value:!0}),function(Rank){Rank.R0="R0",Rank.R1="R1",Rank.R2="R2",Rank.R3="R3",Rank.R4="R4",Rank.R5="R5",Rank.R6="R6"}(exports.Rank||(exports.Rank={})),function(UpcastInt32AndMap){UpcastInt32AndMap.float32="float32",UpcastInt32AndMap.int32="int32",UpcastInt32AndMap.bool="int32",UpcastInt32AndMap.complex64="complex64"}(UpcastInt32AndMap=UpcastInt32AndMap||{}),function(UpcastBoolAndMap){UpcastBoolAndMap.float32="float32",UpcastBoolAndMap.int32="int32",UpcastBoolAndMap.bool="bool",UpcastBoolAndMap.complex64="complex64"}(UpcastBoolAndMap=UpcastBoolAndMap||{}),function(UpcastFloat32AndMap){UpcastFloat32AndMap.float32="float32",UpcastFloat32AndMap.int32="float32",UpcastFloat32AndMap.bool="float32",UpcastFloat32AndMap.complex64="complex64"}(UpcastFloat32AndMap=UpcastFloat32AndMap||{}),function(UpcastComplex64AndMap){UpcastComplex64AndMap.float32="complex64",UpcastComplex64AndMap.int32="complex64",UpcastComplex64AndMap.bool="complex64",UpcastComplex64AndMap.complex64="complex64"}(UpcastComplex64AndMap=UpcastComplex64AndMap||{});var upcastTypeMap={float32:UpcastFloat32AndMap,int32:UpcastInt32AndMap,bool:UpcastBoolAndMap,complex64:UpcastComplex64AndMap};function upcastType(typeA,typeB){if("string"!==typeA&&"string"!==typeB)return upcastTypeMap[typeA][typeB];if("string"===typeA&&"string"===typeB)return"string";throw new Error("Can not upcast "+typeA+" with "+typeB)}exports.upcastType=upcastType,exports.sumOutType=function(type){return upcastType(type,"int32")}},{}],241:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment");function shuffle(array){for(var counter=array.length,temp=0,index=0;0<counter;)index=Math.random()*counter|0,temp=array[--counter],array[counter]=array[index],array[index]=temp}function assert(expr,msg){if(!expr)throw new Error("string"==typeof msg?msg:msg())}function flatten(arr,result,skipTypedArray){if(void 0===result&&(result=[]),void 0===skipTypedArray&&(skipTypedArray=!1),null==result&&(result=[]),Array.isArray(arr)||isTypedArray(arr)&&!skipTypedArray)for(var i=0;i<arr.length;++i)flatten(arr[i],result,skipTypedArray);else result.push(arr);return result}function arraysEqual(n1,n2){if(n1===n2)return!0;if(null==n1||null==n2)return!1;if(n1.length!==n2.length)return!1;for(var i=0;i<n1.length;i++)if(n1[i]!==n2[i])return!1;return!0}function isInt(a){return a%1==0}function parseAxisParam(axis,shape){var rank=shape.length;return assert((axis=null==axis?shape.map(function(s,i){return i}):[].concat(axis)).every(function(ax){return-rank<=ax&&ax<rank}),function(){return"All values in axis param must be in range [-"+rank+", "+rank+") but got axis "+axis}),assert(axis.every(function(ax){return isInt(ax)}),function(){return"All values in axis param must be integers but got axis "+axis}),axis.map(function(a){return a<0?rank+a:a})}function checkConversionForErrors(vals,dtype){for(var i=0;i<vals.length;i++){var num=vals[i];if(isNaN(num)||!isFinite(num))throw Error("A tensor of type "+dtype+" being uploaded contains "+num+".")}}function isTypedArray(a){return a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array}function isString(value){return"string"==typeof value||value instanceof String}function isBoolean(value){return"boolean"==typeof value}function isNumber(value){return"number"==typeof value}function makeZerosTypedArray(size,dtype){if(null==dtype||"float32"===dtype||"complex64"===dtype)return new Float32Array(size);if("int32"===dtype)return new Int32Array(size);if("bool"===dtype)return new Uint8Array(size);throw new Error("Unknown data type "+dtype)}exports.shuffle=shuffle,exports.clamp=function(min,x,max){return Math.max(min,Math.min(x,max))},exports.nearestLargerEven=function(val){return val%2==0?val:val+1},exports.sum=function(arr){for(var sum=0,i=0;i<arr.length;i++)sum+=arr[i];return sum},exports.randUniform=function(a,b){var r=Math.random();return b*r+(1-r)*a},exports.distSquared=function(a,b){for(var result=0,i=0;i<a.length;i++){var diff=Number(a[i])-Number(b[i]);result+=diff*diff}return result},exports.assert=assert,exports.assertShapesMatch=function(shapeA,shapeB,errorMessagePrefix){void 0===errorMessagePrefix&&(errorMessagePrefix=""),assert(arraysEqual(shapeA,shapeB),function(){return errorMessagePrefix+" Shapes "+shapeA+" and "+shapeB+" must match"})},exports.assertNonNull=function(a){assert(null!=a,function(){return"The input to the tensor constructor must be a non-null value."})},exports.flatten=flatten,exports.sizeFromShape=function(shape){if(0===shape.length)return 1;for(var size=shape[0],i=1;i<shape.length;i++)size*=shape[i];return size},exports.isScalarShape=function(shape){return 0===shape.length},exports.arraysEqual=arraysEqual,exports.isInt=isInt,exports.tanh=function(x){if(null!=Math.tanh)return Math.tanh(x);if(x===1/0)return 1;if(x===-1/0)return-1;var e2x=Math.exp(2*x);return(e2x-1)/(e2x+1)},exports.sizeToSquarishShape=function(size){var width=Math.ceil(Math.sqrt(size));return[width,Math.ceil(size/width)]},exports.createShuffledIndices=function(n){for(var shuffledIndices=new Uint32Array(n),i=0;i<n;++i)shuffledIndices[i]=i;return shuffle(shuffledIndices),shuffledIndices},exports.rightPad=function(a,size){return size<=a.length?a:a+" ".repeat(size-a.length)},exports.repeatedTry=function(checkFn,delayFn,maxCounter){return void 0===delayFn&&(delayFn=function(counter){return 0}),new Promise(function(resolve,reject){var tryCount=0,tryFn=function(){if(checkFn())resolve();else{var nextBackoff=delayFn(++tryCount);null!=maxCounter&&maxCounter<=tryCount?reject():setTimeout(tryFn,nextBackoff)}};tryFn()})},exports.inferFromImplicitShape=function(shape,size){for(var shapeProd=1,implicitIdx=-1,i=0;i<shape.length;++i)if(0<=shape[i])shapeProd*=shape[i];else if(-1===shape[i]){if(-1!==implicitIdx)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+implicitIdx+" and dim "+i);implicitIdx=i}else if(shape[i]<0)throw Error("Shapes can not be < 0. Found "+shape[i]+" at dim "+i);if(-1===implicitIdx){if(0<size&&size!==shapeProd)throw Error("Size("+size+") must match the product of shape "+shape);return shape}if(0===shapeProd)throw Error("Cannot infer the missing size in ["+shape+"] when there are 0 elements");if(size%shapeProd!=0)throw Error("The implicit shape can't be a fractional number. Got "+size+" / "+shapeProd);var newShape=shape.slice();return newShape[implicitIdx]=size/shapeProd,newShape},exports.parseAxisParam=parseAxisParam,exports.squeezeShape=function(shape,axis){for(var newShape=[],keptDims=[],axes=null==axis?null:parseAxisParam(axis,shape).sort(),j=0,i=0;i<shape.length;++i){if(null!=axes){if(axes[j]===i&&1!==shape[i])throw new Error("Can't squeeze axis "+i+" since its dim '"+shape[i]+"' is not 1");(null==axes[j]||axes[j]>i)&&1===shape[i]&&(newShape.push(shape[i]),keptDims.push(i)),axes[j]<=i&&j++}1!==shape[i]&&(newShape.push(shape[i]),keptDims.push(i))}return{newShape:newShape,keptDims:keptDims}},exports.getTypedArrayFromDType=function(dtype,size){var values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else{if("bool"!==dtype)throw new Error("Unknown data type "+dtype);values=new Uint8Array(size)}return values},exports.getArrayFromDType=function(dtype,size){var values=null;if(null==dtype||"float32"===dtype)values=new Float32Array(size);else if("int32"===dtype)values=new Int32Array(size);else if("bool"===dtype)values=new Uint8Array(size);else{if("string"!==dtype)throw new Error("Unknown data type "+dtype);values=new Array(size)}return values},exports.checkComputationForErrors=function(vals,dtype,name){if("float32"===dtype)for(var i=0;i<vals.length;i++){var num=vals[i];if(isNaN(num)||!isFinite(num))throw Error("The result of the '"+name+"' is "+num+".")}},exports.checkConversionForErrors=checkConversionForErrors,exports.isValidDtype=function(dtype){return"bool"===dtype||"complex64"===dtype||"float32"===dtype||"int32"===dtype||"string"===dtype},exports.hasEncodingLoss=function(oldType,newType){return"complex64"!==newType&&(("float32"!==newType||"complex64"===oldType)&&(("int32"!==newType||"float32"===oldType||"complex64"===oldType)&&("bool"!==newType||"bool"!==oldType)))},exports.isTypedArray=isTypedArray,exports.bytesPerElement=function(dtype){if("float32"===dtype||"int32"===dtype)return 4;if("complex64"===dtype)return 8;if("bool"===dtype)return 1;throw new Error("Unknown dtype "+dtype)},exports.bytesFromStringArray=function(arr){if(null==arr)return 0;var bytes=0;return arr.forEach(function(x){return bytes+=x.length}),bytes},exports.isString=isString,exports.isBoolean=isBoolean,exports.isNumber=isNumber,exports.inferDtype=function inferDtype(values){return Array.isArray(values)?inferDtype(values[0]):values instanceof Float32Array?"float32":values instanceof Int32Array||values instanceof Uint8Array?"int32":isNumber(values)?"float32":isString(values)?"string":isBoolean(values)?"bool":"float32"},exports.isFunction=function(f){return!!(f&&f.constructor&&f.call&&f.apply)},exports.nearestDivisor=function(size,start){for(var i=start;i<size;++i)if(size%i==0)return i;return size},exports.computeStrides=function(shape){var rank=shape.length;if(rank<2)return[];var strides=new Array(rank-1);strides[rank-2]=shape[rank-1];for(var i=rank-3;0<=i;--i)strides[i]=strides[i+1]*shape[i+1];return strides},exports.toTypedArray=function(a,dtype,debugMode){if("string"===dtype)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(a)&&(a=flatten(a)),debugMode&&checkConversionForErrors(a,dtype),function(a,dtype){return a instanceof Float32Array&&"float32"===dtype||a instanceof Int32Array&&"int32"===dtype||a instanceof Uint8Array&&"bool"===dtype}(a,dtype))return a;if(null==dtype||"float32"===dtype||"complex64"===dtype)return new Float32Array(a);if("int32"===dtype)return new Int32Array(a);if("bool"!==dtype)throw new Error("Unknown data type "+dtype);for(var bool=new Uint8Array(a.length),i=0;i<bool.length;++i)0!==Math.round(a[i])&&(bool[i]=1);return bool},exports.toNestedArray=function(shape,a){if(0===shape.length)return a[0];var size=shape.reduce(function(acc,c){return acc*c});if(0===size)return[];if(size!==a.length)throw new Error("["+shape+"] does not match the input size.");return function createNestedArray(offset,shape,a){var ret=new Array;if(1===shape.length)for(var d=shape[0],i=0;i<d;i++)ret[i]=a[offset+i];else{d=shape[0];var rest=shape.slice(1),len=rest.reduce(function(acc,c){return acc*c});for(i=0;i<d;i++)ret[i]=createNestedArray(offset+i*len,rest,a)}return ret}(0,shape,a)},exports.makeOnesTypedArray=function(size,dtype){for(var array=makeZerosTypedArray(size,dtype),i=0;i<array.length;i++)array[i]=1;return array},exports.makeZerosTypedArray=makeZerosTypedArray,exports.now=function(){return environment_1.ENV.platform.now()},exports.assertNonNegativeIntegerDimensions=function(shape){shape.forEach(function(dimSize){assert(Number.isInteger(dimSize)&&0<=dimSize,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+shape+"]."})})},exports.fetch=function(path,requestInits){return environment_1.ENV.platform.fetch(path,requestInits)},exports.encodeString=function(s,encoding){return void 0===encoding&&(encoding="utf-8"),encoding=encoding||"utf-8",environment_1.ENV.platform.encode(s,encoding)},exports.decodeString=function(bytes,encoding){return void 0===encoding&&(encoding="utf-8"),encoding=encoding||"utf-8",environment_1.ENV.platform.decode(bytes,encoding)}},{"./environment":144}],242:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],243:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gpgpu_util=require("./backends/webgl/gpgpu_util");exports.gpgpu_util=gpgpu_util;var webgl_util=require("./backends/webgl/webgl_util");exports.webgl_util=webgl_util;var backend_webgl_1=require("./backends/webgl/backend_webgl");exports.MathBackendWebGL=backend_webgl_1.MathBackendWebGL;var canvas_util_1=require("./backends/webgl/canvas_util");exports.setWebGLContext=canvas_util_1.setWebGLContext;var gpgpu_context_1=require("./backends/webgl/gpgpu_context");exports.GPGPUContext=gpgpu_context_1.GPGPUContext},{"./backends/webgl/backend_webgl":64,"./backends/webgl/canvas_util":70,"./backends/webgl/gpgpu_context":99,"./backends/webgl/gpgpu_util":101,"./backends/webgl/webgl_util":139}],244:[function(require,module,exports){var alea=require("./lib/alea"),xor128=require("./lib/xor128"),xorwow=require("./lib/xorwow"),xorshift7=require("./lib/xorshift7"),xor4096=require("./lib/xor4096"),tychei=require("./lib/tychei"),sr=require("./seedrandom");sr.alea=alea,sr.xor128=xor128,sr.xorwow=xorwow,sr.xorshift7=xorshift7,sr.xor4096=xor4096,sr.tychei=tychei,module.exports=sr},{"./lib/alea":245,"./lib/tychei":246,"./lib/xor128":247,"./lib/xor4096":248,"./lib/xorshift7":249,"./lib/xorwow":250,"./seedrandom":251}],245:[function(require,module,exports){!function(global,module,define){function Alea(seed){var me=this,mash=function(){var n=4022871197;return function(data){data=data.toString();for(var i=0;i<data.length;i++){var h=.02519603282416938*(n+=data.charCodeAt(i));h-=n=h>>>0,n=(h*=n)>>>0,n+=4294967296*(h-=n)}return 2.3283064365386963e-10*(n>>>0)}}();me.next=function(){var t=2091639*me.s0+2.3283064365386963e-10*me.c;return me.s0=me.s1,me.s1=me.s2,me.s2=t-(me.c=0|t)},me.c=1,me.s0=mash(" "),me.s1=mash(" "),me.s2=mash(" "),me.s0-=mash(seed),me.s0<0&&(me.s0+=1),me.s1-=mash(seed),me.s1<0&&(me.s1+=1),me.s2-=mash(seed),me.s2<0&&(me.s2+=1),mash=null}function copy(f,t){return t.c=f.c,t.s0=f.s0,t.s1=f.s1,t.s2=f.s2,t}function impl(seed,opts){var xg=new Alea(seed),state=opts&&opts.state,prng=xg.next;return prng.int32=function(){return 4294967296*xg.next()|0},prng.double=function(){return prng()+11102230246251565e-32*(2097152*prng()|0)},prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.alea=impl}(0,"object"==typeof module&&module,!1)},{}],246:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var b=me.b,c=me.c,d=me.d,a=me.a;return b=b<<25^b>>>7^c,c=c-d|0,d=d<<24^d>>>8^a,a=a-b|0,me.b=b=b<<20^b>>>12^c,me.c=c=c-d|0,me.d=d<<16^c>>>16^a,me.a=a-b|0},me.a=0,me.b=0,me.c=-1640531527,me.d=1367130551,seed===Math.floor(seed)?(me.a=seed/4294967296|0,me.b=0|seed):strseed+=seed;for(var k=0;k<strseed.length+20;k++)me.b^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.a=f.a,t.b=f.b,t.c=f.c,t.d=f.d,t}function impl(seed,opts){function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.tychei=impl}(0,"object"==typeof module&&module,!1)},{}],247:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.x=0,me.y=0,me.z=0,me.w=0,me.next=function(){var t=me.x^me.x<<11;return me.x=me.y,me.y=me.z,me.z=me.w,me.w^=me.w>>>19^t^t>>>8},seed===(0|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t}function impl(seed,opts){function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xor128=impl}(0,"object"==typeof module&&module,!1)},{}],248:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,w=me.w,X=me.X,i=me.i;return me.w=w=w+1640531527|0,v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,v=X[i]=v^t,me.i=i,v+(w^w>>>16)|0},function(me,seed){var t,v,i,j,w,X=[],limit=128;for(seed===(0|seed)?(v=seed,seed=null):(seed+="\0",v=0,limit=Math.max(limit,seed.length)),i=0,j=-32;j<limit;++j)seed&&(v^=seed.charCodeAt((j+32)%seed.length)),0===j&&(w=v),v^=v<<10,v^=v>>>15,v^=v<<4,v^=v>>>13,0<=j&&(w=w+1640531527|0,i=0==(t=X[127&j]^=v+w)?i+1:0);for(128<=i&&(X[127&(seed&&seed.length||0)]=-1),i=127,j=512;0<j;--j)v=X[i+34&127],t=X[i=i+1&127],v^=v<<13,t^=t<<17,v^=v>>>15,t^=t>>>12,X[i]=v^t;me.w=w,me.X=X,me.i=i}(me,seed)}function copy(f,t){return t.i=f.i,t.w=f.w,t.X=f.X.slice(),t}function impl(seed,opts){null==seed&&(seed=+new Date);function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.X&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xor4096=impl}(0,"object"==typeof module&&module,!1)},{}],249:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this;me.next=function(){var t,v,X=me.x,i=me.i;return t=X[i],v=(t^=t>>>7)^t<<24,v^=(t=X[i+1&7])^t>>>10,v^=(t=X[i+3&7])^t>>>3,v^=(t=X[i+4&7])^t<<7,t=X[i+7&7],v^=(t^=t<<13)^t<<9,X[i]=v,me.i=i+1&7,v},function(me,seed){var j,X=[];if(seed===(0|seed))X[0]=seed;else for(seed=""+seed,j=0;j<seed.length;++j)X[7&j]=X[7&j]<<15^seed.charCodeAt(j)+X[j+1&7]<<13;for(;X.length<8;)X.push(0);for(j=0;j<8&&0===X[j];++j);for(8==j?X[7]=-1:X[j],me.x=X,me.i=0,j=256;0<j;--j)me.next()}(me,seed)}function copy(f,t){return t.x=f.x.slice(),t.i=f.i,t}function impl(seed,opts){null==seed&&(seed=+new Date);function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&(state.x&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xorshift7=impl}(0,"object"==typeof module&&module,!1)},{}],250:[function(require,module,exports){!function(global,module,define){function XorGen(seed){var me=this,strseed="";me.next=function(){var t=me.x^me.x>>>2;return me.x=me.y,me.y=me.z,me.z=me.w,me.w=me.v,(me.d=me.d+362437|0)+(me.v=me.v^me.v<<4^t^t<<1)|0},me.x=0,me.y=0,me.z=0,me.w=0,seed===((me.v=0)|seed)?me.x=seed:strseed+=seed;for(var k=0;k<strseed.length+64;k++)me.x^=0|strseed.charCodeAt(k),k==strseed.length&&(me.d=me.x<<10^me.x>>>4),me.next()}function copy(f,t){return t.x=f.x,t.y=f.y,t.z=f.z,t.w=f.w,t.v=f.v,t.d=f.d,t}function impl(seed,opts){function prng(){return(xg.next()>>>0)/4294967296}var xg=new XorGen(seed),state=opts&&opts.state;return prng.double=function(){do{var result=((xg.next()>>>11)+(xg.next()>>>0)/4294967296)/(1<<21)}while(0===result);return result},prng.int32=xg.next,prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.xorwow=impl}(0,"object"==typeof module&&module,!1)},{}],251:[function(require,module,exports){!function(pool,math){var nodecrypto,global=this,width=256,chunks=6,rngname="random",startdenom=math.pow(width,chunks),significance=math.pow(2,52),overflow=2*significance,mask=width-1;function seedrandom(seed,options,callback){function prng(){for(var n=arc4.g(chunks),d=startdenom,x=0;n<significance;)n=(n+x)*width,d*=width,x=arc4.g(1);for(;overflow<=n;)n/=2,d/=2,x>>>=1;return(n+x)/d}var key=[],shortseed=mixkey(function flatten(obj,depth){var prop,result=[],typ=typeof obj;if(depth&&"object"==typ)for(prop in obj)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:"string"==typ?obj:obj+"\0"}((options=1==options?{entropy:!0}:options||{}).entropy?[seed,tostring(pool)]:null==seed?function(){try{var out;return nodecrypto&&(out=nodecrypto.randomBytes)?out=out(width):(out=new Uint8Array(width),(global.crypto||global.msCrypto).getRandomValues(out)),tostring(out)}catch(e){var browser=global.navigator,plugins=browser&&browser.plugins;return[+new Date,global,plugins,global.screen,tostring(pool)]}}():seed,3),key),arc4=new ARC4(key);return prng.int32=function(){return 0|arc4.g(4)},prng.quick=function(){return arc4.g(4)/4294967296},prng.double=prng,mixkey(tostring(arc4.S),pool),(options.pass||callback||function(prng,seed,is_math_call,state){return state&&(state.S&&copy(state,arc4),prng.state=function(){return copy(arc4,{})}),is_math_call?(math[rngname]=prng,seed):prng})(prng,shortseed,"global"in options?options.global:this==math,options.state)}function ARC4(key){var t,keylen=key.length,me=this,i=0,j=me.i=me.j=0,s=me.S=[];for(keylen||(key=[keylen++]);i<width;)s[i]=i++;for(i=0;i<width;i++)s[i]=s[j=mask&j+key[i%keylen]+(t=s[i])],s[j]=t;(me.g=function(count){for(var t,r=0,i=me.i,j=me.j,s=me.S;count--;)t=s[i=mask&i+1],r=r*width+s[mask&(s[i]=s[j=mask&j+t])+(s[j]=t)];return me.i=i,me.j=j,r})(width)}function copy(f,t){return t.i=f.i,t.j=f.j,t.S=f.S.slice(),t}function mixkey(seed,key){for(var smear,stringseed=seed+"",j=0;j<stringseed.length;)key[mask&j]=mask&(smear^=19*key[mask&j])+stringseed.charCodeAt(j++);return tostring(key)}function tostring(a){return String.fromCharCode.apply(0,a)}if(math["seed"+rngname]=seedrandom,mixkey(math.random(),pool),"object"==typeof module&&module.exports){module.exports=seedrandom;try{nodecrypto=require("crypto")}catch(ex){}}else 0}([],Math)},{crypto:333}],252:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),seedrandom=require("seedrandom"),lazy_iterator_1=require("./iterators/lazy_iterator"),deep_map_1=require("./util/deep_map"),Dataset=function(){function Dataset(){this.size=null}return Dataset.prototype.batch=function(batchSize,smallLastBatch){var _this=this;void 0===smallLastBatch&&(smallLastBatch=!0);var base=this;return tf.util.assert(0<batchSize,function(){return"batchSize needs to be positive, but it is\n      "+batchSize}),datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().columnMajorBatch(batchSize,smallLastBatch,deepBatchConcat)]}})})},this.size===1/0||null==this.size?this.size:smallLastBatch?Math.ceil(this.size/batchSize):Math.floor(this.size/batchSize))},Dataset.prototype.concatenate=function(dataset){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var _a,_b;return __generator(this,function(_c){switch(_c.label){case 0:return[4,base.iterator()];case 1:return _b=(_a=_c.sent()).concatenate,[4,dataset.iterator()];case 2:return[2,_b.apply(_a,[_c.sent()])]}})})},this.size===1/0||dataset.size===1/0?1/0:null!=this.size&&null!=dataset.size?this.size+dataset.size:null)},Dataset.prototype.filter=function(predicate){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().filter(function(x){return tf.tidy(function(){return predicate(x)})})]}})})},this.size===1/0?1/0:null)},Dataset.prototype.forEachAsync=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.iterator()];case 1:return[2,_a.sent().forEachAsync(f)]}})})},Dataset.prototype.forEach=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return tf.deprecationWarn("dataset.forEach() is deprecated and will be removed. Please use dataset.forEachAsync() instead"),[2,this.forEachAsync(f)]})})},Dataset.prototype.map=function(transform){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().map(function(x){return tf.tidy(function(){return transform(x)})})]}})})},this.size)},Dataset.prototype.mapAsync=function(transform){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().mapAsync(transform)]}})})},this.size)},Dataset.prototype.prefetch=function(bufferSize){var _this=this;if(null==bufferSize)throw new RangeError("`Dataset.prefetch()` requires bufferSize to be specified.");var base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().prefetch(bufferSize)]}})})},this.size)},Dataset.prototype.repeat=function(count){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var iteratorIterator,_this=this;return __generator(this,function(_a){return iteratorIterator=lazy_iterator_1.iteratorFromFunction(function(){return __awaiter(_this,void 0,void 0,function(){var _a;return __generator(this,function(_b){switch(_b.label){case 0:return _a={},[4,base.iterator()];case 1:return[2,(_a.value=_b.sent(),_a.done=!1,_a)]}})})}),[2,lazy_iterator_1.iteratorFromConcatenated(iteratorIterator.take(count))]})})},null!=this.size&&0<count?this.size*count:0===count?0:null!=this.size&&(void 0===count||count<0)?1/0:null)},Dataset.prototype.skip=function(count){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().skip(count)]}})})},null!=this.size&&0<=count&&this.size>=count?this.size-count:null!=this.size&&(this.size<count||void 0===count||count<0)?0:null)},Dataset.prototype.shuffle=function(bufferSize,seed,reshuffleEachIteration){var _this=this;if(void 0===reshuffleEachIteration&&(reshuffleEachIteration=!0),null==bufferSize||bufferSize<0)throw null==this.size?new RangeError("`Dataset.shuffle()` requires bufferSize to be specified."):new RangeError("`Dataset.shuffle()` requires bufferSize to be specified.  If your data fits in main memory (for regular JS objects), and/or GPU memory (for `tf.Tensor`s), consider setting bufferSize to the dataset size ("+this.size+" elements)");var base=this,random=seedrandom.alea(seed||tf.util.now().toString());return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var seed2;return __generator(this,function(_a){switch(_a.label){case 0:return seed2=random.int32(),reshuffleEachIteration&&(seed2+=random.int32()),[4,base.iterator()];case 1:return[2,_a.sent().shuffle(bufferSize,seed2.toString())]}})})},this.size)},Dataset.prototype.take=function(count){var _this=this,base=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,base.iterator()];case 1:return[2,_a.sent().take(count)]}})})},null!=this.size&&this.size>count?count:null!=this.size&&this.size<=count?this.size:null)},Dataset.prototype.toArray=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return[4,this.iterator()];case 1:return[2,_a.sent().toArray()]}})})},Dataset.prototype.toArrayForTest=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return[4,this.iterator()];case 1:return[2,_a.sent().toArrayForTest()]}})})},Dataset.MAX_BUFFER_SIZE=1e4,Dataset}();function datasetFromIteratorFn(iteratorFn,size){return void 0===size&&(size=null),__extends(class_1,_super=Dataset),class_1.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,iteratorFn()]})})},new class_1;function class_1(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.size=size,_this}var _super}function deepBatchConcat(rows){if(null===rows)return null;var exampleRow=rows[0];return deep_map_1.canTensorify(exampleRow)?{value:function(arrays){if(0===arrays.length)throw new Error("Can't make a batch of zero elements.");return arrays[0]instanceof tf.Tensor?tf.stack(arrays):tf.tensor(arrays)}(rows),recurse:!1}:{value:null,recurse:!0}}exports.Dataset=Dataset,exports.datasetFromIteratorFn=datasetFromIteratorFn,exports.array=function(items){var _this=this;return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){return[2,lazy_iterator_1.iteratorFromItems(items)]})})},items.length)},exports.zip=function(datasets){var size,_this=this;if(!deep_map_1.isIterable(datasets))throw new Error("The argument to zip() must be an object or array.");if(Array.isArray(datasets))for(var i=0;i<datasets.length;i++)size=null==size?datasets[i].size:Math.min(size,datasets[i].size);else if(datasets instanceof Object)for(var ds in datasets)size=null==size?datasets[ds].size:Math.min(size,datasets[ds].size);return datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var streams;return __generator(this,function(_a){switch(_a.label){case 0:return[4,deep_map_1.deepMapAndAwaitAll(datasets,function(d){if(d instanceof Dataset)return{value:d.iterator(),recurse:!1};if(deep_map_1.isIterable(d))return{value:null,recurse:!0};throw new Error("Leaves of the structure passed to zip() must be Datasets, not primitives.")})];case 1:return streams=_a.sent(),[2,lazy_iterator_1.iteratorFromZipped(streams,lazy_iterator_1.ZipMismatchMode.SHORTEST)]}})})},size)}},{"./iterators/lazy_iterator":259,"./util/deep_map":268,"@tensorflow/tfjs-core":148,seedrandom:338}],253:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),dataset_1=require("../dataset"),text_line_dataset_1=require("./text_line_dataset"),STATE_OUT=Symbol("out"),STATE_FIELD=Symbol("field"),STATE_QUOTE=Symbol("quote"),STATE_QUOTE_AFTER_QUOTE=Symbol("quoteafterquote"),STATE_WITHIN_QUOTE_IN_QUOTE=Symbol("quoteinquote"),CSVDataset=function(_super){function CSVDataset(input,csvConfig){var _this=_super.call(this)||this;return _this.input=input,_this.hasHeader=!0,_this.fullColumnNames=null,_this.columnNamesValidated=!1,_this.columnConfigs=null,_this.configuredColumnsOnly=!1,_this.delimiter=",",_this.delimWhitespace=!1,_this.base=new text_line_dataset_1.TextLineDataset(input),csvConfig=csvConfig||{},_this.hasHeader=!1!==csvConfig.hasHeader,_this.fullColumnNames=csvConfig.columnNames,_this.columnConfigs=csvConfig.columnConfigs,_this.configuredColumnsOnly=csvConfig.configuredColumnsOnly,csvConfig.delimWhitespace?(tfjs_core_1.util.assert(null==csvConfig.delimiter,function(){return"Delimiter should not be provided when delimWhitespace is true."}),_this.delimWhitespace=!0,_this.delimiter=" "):_this.delimiter=csvConfig.delimiter?csvConfig.delimiter:",",_this}return __extends(CSVDataset,_super),CSVDataset.prototype.columnNames=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.columnNamesValidated?[3,2]:[4,this.setColumnNames()];case 1:_a.sent(),_a.label=2;case 2:return[2,this.configuredColumnsOnly?Object.keys(this.columnConfigs):this.fullColumnNames]}})})},CSVDataset.prototype.setColumnNames=function(){return __awaiter(this,void 0,void 0,function(){var columnNamesFromFile,counts,duplicateNames,_i,_a,key,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:return[4,this.maybeReadHeaderLine()];case 1:if(columnNamesFromFile=_b.sent(),!this.fullColumnNames&&!columnNamesFromFile)throw new Error("Column names must be provided if there is no header line.");if(this.fullColumnNames&&columnNamesFromFile&&tfjs_core_1.util.assert(columnNamesFromFile.length===this.fullColumnNames.length,function(){return"The length of provided columnNames ("+_this.fullColumnNames.length.toString()+") does not match the length of the header line read from file ("+columnNamesFromFile.length.toString()+")."}),this.fullColumnNames||(this.fullColumnNames=columnNamesFromFile),counts=this.fullColumnNames.reduce(function(countAcc,name){return countAcc[name]=countAcc[name]+1||1,countAcc},{}),duplicateNames=Object.keys(counts).filter(function(name){return 1<counts[name]}),tfjs_core_1.util.assert(0===duplicateNames.length,function(){return"Duplicate column names found: "+duplicateNames.toString()}),this.columnConfigs)for(_i=0,_a=Object.keys(this.columnConfigs);_i<_a.length;_i++)if(key=_a[_i],-1===this.fullColumnNames.indexOf(key))throw new Error('The key "'+key+'" provided in columnConfigs does not match any of the column names ('+this.fullColumnNames.toString()+").");return this.columnNamesValidated=!0,[2]}})})},CSVDataset.prototype.maybeReadHeaderLine=function(){return __awaiter(this,void 0,void 0,function(){var firstElement,firstLine;return __generator(this,function(_a){switch(_a.label){case 0:return this.hasHeader?[4,this.base.iterator()]:[3,3];case 1:return[4,_a.sent().next()];case 2:if((firstElement=_a.sent()).done)throw new Error("No data was found for CSV parsing.");return firstLine=firstElement.value,[2,this.parseRow(firstLine,!1)];case 3:return[2,null]}})})},CSVDataset.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){var lines,_this=this;return __generator(this,function(_a){switch(_a.label){case 0:return this.columnNamesValidated?[3,2]:[4,this.setColumnNames()];case 1:_a.sent(),_a.label=2;case 2:return[4,this.base.iterator()];case 3:return lines=_a.sent(),this.hasHeader&&(lines=lines.skip(1)),[2,lines.map(function(x){return _this.makeDataElement(x)})]}})})},CSVDataset.prototype.makeDataElement=function(line){for(var values=this.parseRow(line),features={},labels={},i=0;i<this.fullColumnNames.length;i++){var key=this.fullColumnNames[i],config=this.columnConfigs?this.columnConfigs[key]:null;if(!this.configuredColumnsOnly||config){var value=values[i],parsedValue=null;if(""===value)if(config&&void 0!==config.default)parsedValue=config.default;else{if(config&&(config.required||config.isLabel))throw new Error("Required column "+key+" is empty in this line: "+line);parsedValue=void 0}else{var valueAsNum=Number(value);if(isNaN(valueAsNum))parsedValue=config&&"bool"===config.dtype?this.getBoolean(value):value;else if(config&&config.dtype)switch(config.dtype){case"float32":parsedValue=valueAsNum;break;case"int32":parsedValue=Math.floor(valueAsNum);break;case"bool":parsedValue=this.getBoolean(value);break;default:parsedValue=valueAsNum}else parsedValue=valueAsNum}config&&config.isLabel?labels[key]=parsedValue:features[key]=parsedValue}}return 0===Object.keys(labels).length?features:{xs:features,ys:labels}},CSVDataset.prototype.getBoolean=function(value){return"1"===value||"true"===value.toLowerCase()?1:0},CSVDataset.prototype.parseRow=function(line,validateElementCount){void 0===validateElementCount&&(validateElementCount=!0);for(var result=[],readOffset=0,readLength=line.length,currentState=STATE_OUT,i=0;i<readLength;i++)switch(currentState){case STATE_OUT:switch(line.charAt(i)){case'"':readOffset=i+1,currentState=STATE_QUOTE;break;case this.delimiter:if(readOffset=i+1," "===this.delimiter&&this.delimWhitespace)break;result.push(""),currentState=STATE_OUT;break;default:currentState=STATE_FIELD,readOffset=i}break;case STATE_FIELD:switch(line.charAt(i)){case this.delimiter:result.push(line.substring(readOffset,i)),currentState=STATE_OUT,readOffset=i+1}break;case STATE_QUOTE:switch(line.charAt(i)){case'"':currentState=STATE_QUOTE_AFTER_QUOTE}break;case STATE_QUOTE_AFTER_QUOTE:switch(line.charAt(i)){case this.delimiter:result.push(line.substring(readOffset,i-1)),currentState=STATE_OUT,readOffset=i+1;break;case'"':currentState=STATE_QUOTE;break;default:currentState=STATE_WITHIN_QUOTE_IN_QUOTE}break;case STATE_WITHIN_QUOTE_IN_QUOTE:switch(line.charAt(i)){case'"':currentState=STATE_QUOTE}}if(currentState===STATE_QUOTE_AFTER_QUOTE?result.push(line.substring(readOffset,readLength-1)):result.push(line.substring(readOffset)),validateElementCount&&result.length!==this.fullColumnNames.length)throw new Error("Invalid row in csv file. Should have "+this.fullColumnNames.length+" elements in a row, but got "+result);return result},CSVDataset}(dataset_1.Dataset);exports.CSVDataset=CSVDataset},{"../dataset":252,"./text_line_dataset":254,"@tensorflow/tfjs-core":148}],254:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var TextLineDataset=function(_super){function TextLineDataset(input){var _this=_super.call(this)||this;return _this.input=input,_this}return __extends(TextLineDataset,_super),TextLineDataset.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){var inputIterator,utf8Iterator;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.input.iterator()];case 1:return inputIterator=_a.sent(),utf8Iterator=inputIterator.decodeUTF8(),[2,utf8Iterator.split("\n").map(function(line){return line.endsWith("\r")&&(line=line.slice(0,-1)),line})]}})})},TextLineDataset}(require("../dataset").Dataset);exports.TextLineDataset=TextLineDataset},{"../dataset":252}],255:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function DataSource(){}exports.DataSource=DataSource},{}],256:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var dataset_1=require("./dataset");exports.array=dataset_1.array,exports.Dataset=dataset_1.Dataset,exports.zip=dataset_1.zip;var csv_dataset_1=require("./datasets/csv_dataset");exports.CSVDataset=csv_dataset_1.CSVDataset;var text_line_dataset_1=require("./datasets/text_line_dataset");exports.TextLineDataset=text_line_dataset_1.TextLineDataset;var readers_1=require("./readers");exports.csv=readers_1.csv,exports.func=readers_1.func,exports.generator=readers_1.generator,exports.microphone=readers_1.microphone,exports.webcam=readers_1.webcam;var file_data_source_1=require("./sources/file_data_source");exports.FileDataSource=file_data_source_1.FileDataSource;var url_data_source_1=require("./sources/url_data_source");exports.URLDataSource=url_data_source_1.URLDataSource;var version_1=require("./version");exports.version_data=version_1.version},{"./dataset":252,"./datasets/csv_dataset":253,"./datasets/text_line_dataset":254,"./readers":264,"./sources/file_data_source":265,"./sources/url_data_source":266,"./version":272}],257:[function(require,module,exports){(function(Buffer){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),lazy_iterator_1=require("./lazy_iterator"),string_iterator_1=require("./string_iterator"),ByteChunkIterator=function(_super){function ByteChunkIterator(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(ByteChunkIterator,_super),ByteChunkIterator.prototype.decodeUTF8=function(){return new Utf8Iterator(this)},ByteChunkIterator}(lazy_iterator_1.LazyIterator);exports.ByteChunkIterator=ByteChunkIterator;var Utf8Iterator=function(_super){function Utf8Iterator(upstream){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.impl=new Utf8IteratorImpl(upstream),_this}return __extends(Utf8Iterator,_super),Utf8Iterator.prototype.summary=function(){return this.impl.summary()},Utf8Iterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.impl.next()]})})},Utf8Iterator}(string_iterator_1.StringIterator),Utf8IteratorImpl=function(_super){function Utf8IteratorImpl(upstream){var _this=_super.call(this)||this;if(_this.upstream=upstream,tfjs_core_1.ENV.get("IS_BROWSER"))_this.decoder=new TextDecoder("utf-8");else{var StringDecoder=require("string_decoder").StringDecoder;_this.decoder=new StringDecoder("utf8")}return _this}return __extends(Utf8IteratorImpl,_super),Utf8IteratorImpl.prototype.summary=function(){return this.upstream.summary()+" -> Utf8"},Utf8IteratorImpl.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var chunkResult,chunk,text;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:return(chunkResult=_a.sent()).done?[2,!1]:(chunk=chunkResult.value,text=tfjs_core_1.ENV.get("IS_BROWSER")?this.decoder.decode(chunk,{stream:!0}):this.decoder.write(Buffer.from(chunk.buffer)),this.outputQueue.push(text),[2,!0])}})})},Utf8IteratorImpl}(lazy_iterator_1.OneToManyIterator)}).call(this,require("buffer").Buffer)},{"./lazy_iterator":259,"./string_iterator":261,"@tensorflow/tfjs-core":148,buffer:334,string_decoder:333}],258:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),FileChunkIterator=function(_super){function FileChunkIterator(file,options){void 0===options&&(options={});var _this=_super.call(this)||this;return _this.file=file,_this.options=options,tfjs_core_1.util.assert(file instanceof Uint8Array||!!tfjs_core_1.ENV.get("IS_BROWSER")&&(file instanceof File||file instanceof Blob),function(){return"FileChunkIterator only supports File, Blob and Uint8Array right now."}),_this.offset=options.offset||0,_this.chunkSize=options.chunkSize||1048576,_this}return __extends(FileChunkIterator,_super),FileChunkIterator.prototype.summary=function(){return"FileChunks "+this.file},FileChunkIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var chunk,_a,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:return this.offset>=(this.file instanceof Uint8Array?this.file.byteLength:this.file.size)?[2,{value:null,done:!0}]:(chunk=new Promise(function(resolve,reject){var end=_this.offset+_this.chunkSize;if(_this.file instanceof Uint8Array)resolve(new Uint8Array(_this.file.slice(_this.offset,end)));else{var fileReader_1=new FileReader;fileReader_1.onload=function(event){var data=fileReader_1.result;if(data instanceof ArrayBuffer&&(data=new Uint8Array(data)),!(data instanceof Uint8Array))return reject(new TypeError("FileReader returned unknown type."));resolve(data)},fileReader_1.onabort=function(event){return reject(new Error("Aborted"))},fileReader_1.onerror=function(event){return reject(new Error(event.type))};var slice=_this.file.slice(_this.offset,end);fileReader_1.readAsArrayBuffer(slice)}_this.offset=end}),_a={},[4,chunk]);case 1:return[2,(_a.value=_b.sent(),_a.done=!1,_a)]}})})},FileChunkIterator}(require("./byte_chunk_iterator").ByteChunkIterator);exports.FileChunkIterator=FileChunkIterator},{"./byte_chunk_iterator":257,"@tensorflow/tfjs-core":148}],259:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),seedrandom=require("seedrandom"),deep_clone_1=require("../util/deep_clone"),deep_map_1=require("../util/deep_map"),growing_ring_buffer_1=require("../util/growing_ring_buffer"),ring_buffer_1=require("../util/ring_buffer");function iteratorFromItems(items){return new ArrayIterator(items)}function iteratorFromFunction(func){return new FunctionCallIterator(func)}function iteratorFromConcatenated(baseIterators,baseErrorHandler){return new ChainedIterator(baseIterators,baseErrorHandler)}exports.iteratorFromItems=iteratorFromItems,exports.iteratorFromIncrementing=function(start){var i=start;return iteratorFromFunction(function(){return{value:i++,done:!1}})},exports.iteratorFromFunction=iteratorFromFunction,exports.iteratorFromConcatenated=iteratorFromConcatenated,exports.iteratorFromConcatenatedFunction=function(iteratorFunc,count,baseErrorHandler){return iteratorFromConcatenated(iteratorFromFunction(iteratorFunc).take(count),baseErrorHandler)},exports.iteratorFromZipped=function(iterators,mismatchMode){return void 0===mismatchMode&&(mismatchMode=ZipMismatchMode.FAIL),new ZipIterator(iterators,mismatchMode)};var ZipMismatchMode,LazyIterator=function(){function LazyIterator(){}return LazyIterator.prototype.toArray=function(){return __awaiter(this,void 0,void 0,function(){var result,x;return __generator(this,function(_a){switch(_a.label){case 0:return result=[],[4,this.next()];case 1:x=_a.sent(),_a.label=2;case 2:return x.done?[3,4]:(result.push(x.value),[4,this.next()]);case 3:return x=_a.sent(),[3,2];case 4:return[2,result]}})})},LazyIterator.prototype.toArrayForTest=function(){return __awaiter(this,void 0,void 0,function(){var stream,result,x;return __generator(this,function(_a){switch(_a.label){case 0:return stream=this.prefetch(100),result=[],[4,stream.next()];case 1:x=_a.sent(),_a.label=2;case 2:return x.done?[3,4]:(result.push(x.value),[4,stream.next()]);case 3:return x=_a.sent(),[3,2];case 4:return[2,result]}})})},LazyIterator.prototype.resolveFully=function(){return __awaiter(this,void 0,void 0,function(){var x;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:x=_a.sent(),_a.label=2;case 2:return x.done?[3,4]:[4,this.next()];case 3:return x=_a.sent(),[3,2];case 4:return[2]}})})},LazyIterator.prototype.resolveWhile=function(predicate){return __awaiter(this,void 0,void 0,function(){var x,shouldContinue;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:x=_a.sent(),shouldContinue=predicate(x.value),_a.label=2;case 2:return x.done||!shouldContinue?[3,4]:[4,this.next()];case 3:return x=_a.sent(),shouldContinue=predicate(x.value),[3,2];case 4:return[2]}})})},LazyIterator.prototype.handleErrors=function(handler){return new ErrorHandlingLazyIterator(this,handler)},LazyIterator.prototype.filter=function(predicate){return new FilterIterator(this,predicate)},LazyIterator.prototype.map=function(transform){return new MapIterator(this,transform)},LazyIterator.prototype.mapAsync=function(transform){return new AsyncMapIterator(this,transform)},LazyIterator.prototype.serialMapAsync=function(transform){return new AsyncMapIterator(this,transform).serial()},LazyIterator.prototype.flatmap=function(transform){return new FlatmapIterator(this,transform)},LazyIterator.prototype.forEachAsync=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.map(f).resolveFully()]})})},LazyIterator.prototype.serialForEach=function(f){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.serialMapAsync(f).resolveWhile(function(x){return!0===x})]})})},LazyIterator.prototype.rowMajorBatch=function(batchSize,smallLastBatch){return void 0===smallLastBatch&&(smallLastBatch=!0),new RowMajorBatchIterator(this,batchSize,smallLastBatch)},LazyIterator.prototype.columnMajorBatch=function(batchSize,smallLastBatch,zipFn){return void 0===smallLastBatch&&(smallLastBatch=!0),void 0===zipFn&&(zipFn=deep_map_1.zipToList),this.rowMajorBatch(batchSize,smallLastBatch).map(function(x){return deep_map_1.deepZip(x,zipFn)})},LazyIterator.prototype.concatenate=function(iterator,baseErrorHandler){return new ChainedIterator(iteratorFromItems([this,iterator]),baseErrorHandler)},LazyIterator.prototype.take=function(count){return count<0||null==count?this:new TakeIterator(this,count)},LazyIterator.prototype.skip=function(count){return count<0||null==count?this:new SkipIterator(this,count)},LazyIterator.prototype.prefetch=function(bufferSize){return new PrefetchIterator(this,bufferSize)},LazyIterator.prototype.shuffle=function(windowSize,seed){return new ShuffleIterator(this,windowSize,seed)},LazyIterator.prototype.serial=function(){return new SerialIterator(this)},LazyIterator}(),ArrayIterator=function(_super){function ArrayIterator(items){var _this=_super.call(this)||this;return _this.items=items,_this.trav=0,_this}return __extends(ArrayIterator,_super),ArrayIterator.prototype.summary=function(){return"Array of "+this.items.length+" items"},ArrayIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var item;return __generator(this,function(_a){return this.trav>=this.items.length?[2,{value:null,done:!0}]:(item=this.items[this.trav],this.trav++,[2,{value:deep_clone_1.deepClone(item),done:!1}])})})},ArrayIterator}(exports.LazyIterator=LazyIterator),FunctionCallIterator=function(_super){function FunctionCallIterator(nextFn){var _this=_super.call(this)||this;return _this.nextFn=nextFn,_this}return __extends(FunctionCallIterator,_super),FunctionCallIterator.prototype.summary=function(){return"Function call"},FunctionCallIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){try{return[2,this.nextFn()]}catch(e){throw e.message="Error thrown while iterating through a dataset: "+e.message,e}return[2]})})},FunctionCallIterator}(LazyIterator),SerialIterator=function(_super){function SerialIterator(upstream){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(SerialIterator,_super),SerialIterator.prototype.summary=function(){return this.upstream.summary()+" -> Serial"},SerialIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},SerialIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.upstream.next()]})})},SerialIterator}(LazyIterator),SkipIterator=function(_super){function SkipIterator(upstream,maxCount){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.maxCount=maxCount,_this.count=0,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(SkipIterator,_super),SkipIterator.prototype.summary=function(){return this.upstream.summary()+" -> Skip"},SkipIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},SkipIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var skipped;return __generator(this,function(_a){switch(_a.label){case 0:return this.count++<this.maxCount?[4,this.upstream.next()]:[3,2];case 1:return(skipped=_a.sent()).done?[2,skipped]:(tf.dispose(skipped.value),[3,0]);case 2:return[2,this.upstream.next()]}})})},SkipIterator}(LazyIterator),TakeIterator=function(_super){function TakeIterator(upstream,maxCount){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.maxCount=maxCount,_this.count=0,_this}return __extends(TakeIterator,_super),TakeIterator.prototype.summary=function(){return this.upstream.summary()+" -> Take"},TakeIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.count++>=this.maxCount?[2,{value:null,done:!0}]:[2,this.upstream.next()]})})},TakeIterator}(LazyIterator),RowMajorBatchIterator=function(_super){function RowMajorBatchIterator(upstream,batchSize,enableSmallLastBatch){void 0===enableSmallLastBatch&&(enableSmallLastBatch=!0);var _this=_super.call(this)||this;return _this.upstream=upstream,_this.batchSize=batchSize,_this.enableSmallLastBatch=enableSmallLastBatch,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(RowMajorBatchIterator,_super),RowMajorBatchIterator.prototype.summary=function(){return this.upstream.summary()+" -> RowMajorBatch"},RowMajorBatchIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},RowMajorBatchIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var batch,item;return __generator(this,function(_a){switch(_a.label){case 0:batch=[],_a.label=1;case 1:return batch.length<this.batchSize?[4,this.upstream.next()]:[3,3];case 2:return(item=_a.sent()).done?this.enableSmallLastBatch&&0<batch.length?[2,{value:batch,done:!1}]:[2,{value:null,done:!0}]:(batch.push(item.value),[3,1]);case 3:return[2,{value:batch,done:!1}]}})})},RowMajorBatchIterator}(LazyIterator),FilterIterator=function(_super){function FilterIterator(upstream,predicate){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.predicate=predicate,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(FilterIterator,_super),FilterIterator.prototype.summary=function(){return this.upstream.summary()+" -> Filter"},FilterIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},FilterIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var item;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:return(item=_a.sent()).done||this.predicate(item.value)?[2,item]:(tf.dispose(item.value),[3,0]);case 2:return[2]}})})},FilterIterator}(LazyIterator),MapIterator=function(_super){function MapIterator(upstream,transform){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.transform=transform,_this}return __extends(MapIterator,_super),MapIterator.prototype.summary=function(){return this.upstream.summary()+" -> Map"},MapIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var item,inputTensors,mapped,outputTensors,_i,inputTensors_1,t;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:if((item=_a.sent()).done)return[2,{value:null,done:!0}];for(inputTensors=tf.tensor_util.getTensorsInContainer(item.value),mapped=this.transform(item.value),outputTensors=tf.tensor_util.getTensorsInContainer(mapped),_i=0,inputTensors_1=inputTensors;_i<inputTensors_1.length;_i++)t=inputTensors_1[_i],tf.tensor_util.isTensorInList(t,outputTensors)||t.dispose();return[2,{value:mapped,done:!1}]}})})},MapIterator}(LazyIterator),ErrorHandlingLazyIterator=function(_super){function ErrorHandlingLazyIterator(upstream,handler){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.handler=handler,_this.count=0,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(ErrorHandlingLazyIterator,_super),ErrorHandlingLazyIterator.prototype.summary=function(){return this.upstream.summary()+" -> handleErrors"},ErrorHandlingLazyIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},ErrorHandlingLazyIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var e_1;return __generator(this,function(_a){switch(_a.label){case 0:0,_a.label=1;case 1:return _a.trys.push([1,3,,4]),[4,this.upstream.next()];case 2:return[2,_a.sent()];case 3:return e_1=_a.sent(),this.handler(e_1)?[3,4]:[2,{value:null,done:!0}];case 4:return[3,0];case 5:return[2]}})})},ErrorHandlingLazyIterator}(LazyIterator),AsyncMapIterator=function(_super){function AsyncMapIterator(upstream,transform){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.transform=transform,_this}return __extends(AsyncMapIterator,_super),AsyncMapIterator.prototype.summary=function(){return this.upstream.summary()+" -> AsyncMap"},AsyncMapIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var item,inputTensors,mapped,outputTensors,_i,inputTensors_2,t;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:return(item=_a.sent()).done?[2,{value:null,done:!0}]:(inputTensors=tf.tensor_util.getTensorsInContainer(item.value),[4,this.transform(item.value)]);case 2:for(mapped=_a.sent(),outputTensors=tf.tensor_util.getTensorsInContainer(mapped),_i=0,inputTensors_2=inputTensors;_i<inputTensors_2.length;_i++)t=inputTensors_2[_i],tf.tensor_util.isTensorInList(t,outputTensors)||t.dispose();return[2,{value:mapped,done:!1}]}})})},AsyncMapIterator}(LazyIterator),OneToManyIterator=function(_super){function OneToManyIterator(){var _this=_super.call(this)||this;return _this.outputQueue=new growing_ring_buffer_1.GrowingRingBuffer,_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(OneToManyIterator,_super),OneToManyIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},OneToManyIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return 0!==this.outputQueue.length()?[3,2]:[4,this.pump()];case 1:return _a.sent()?[3,0]:[2,{value:null,done:!0}];case 2:return[2,{value:this.outputQueue.shift(),done:!1}]}})})},OneToManyIterator}(LazyIterator),FlatmapIterator=function(_super){function FlatmapIterator(upstream,transform){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.transform=transform,_this}return __extends(FlatmapIterator,_super),FlatmapIterator.prototype.summary=function(){return this.upstream.summary()+" -> Flatmap"},FlatmapIterator.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var item,inputTensors,mappedArray,outputTensors,_i,inputTensors_3,t;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.upstream.next()];case 1:if((item=_a.sent()).done)return[2,!1];for(inputTensors=tf.tensor_util.getTensorsInContainer(item.value),mappedArray=this.transform(item.value),outputTensors=tf.tensor_util.getTensorsInContainer(mappedArray),this.outputQueue.pushAll(mappedArray),_i=0,inputTensors_3=inputTensors;_i<inputTensors_3.length;_i++)t=inputTensors_3[_i],tf.tensor_util.isTensorInList(t,outputTensors)||t.dispose();return[2,!0]}})})},FlatmapIterator}(exports.OneToManyIterator=OneToManyIterator),ChainedIterator=function(_super){function ChainedIterator(iterators,baseErrorHandler){var _this=_super.call(this)||this;return _this.baseErrorHandler=baseErrorHandler,_this.lastRead=null,_this.iterator=null,_this.moreIterators=iterators,_this}return __extends(ChainedIterator,_super),ChainedIterator.prototype.summary=function(){return"TODO: fill in upstream of chained summaries -> Chained"},ChainedIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.lastRead=this.readFromChain(this.lastRead),[2,this.lastRead]})})},ChainedIterator.prototype.readFromChain=function(lastRead){return __awaiter(this,void 0,void 0,function(){var iteratorResult,itemResult;return __generator(this,function(_a){switch(_a.label){case 0:return[4,lastRead];case 1:return _a.sent(),null!=this.iterator?[3,3]:[4,this.moreIterators.next()];case 2:if((iteratorResult=_a.sent()).done)return[2,{value:null,done:!0}];this.iterator=iteratorResult.value,null!=this.baseErrorHandler&&(this.iterator=this.iterator.handleErrors(this.baseErrorHandler)),_a.label=3;case 3:return[4,this.iterator.next()];case 4:return(itemResult=_a.sent()).done?(this.iterator=null,[2,this.readFromChain(lastRead)]):[2,itemResult]}})})},ChainedIterator}(LazyIterator);exports.ChainedIterator=ChainedIterator,function(ZipMismatchMode){ZipMismatchMode[ZipMismatchMode.FAIL=0]="FAIL",ZipMismatchMode[ZipMismatchMode.SHORTEST=1]="SHORTEST",ZipMismatchMode[ZipMismatchMode.LONGEST=2]="LONGEST"}(ZipMismatchMode=exports.ZipMismatchMode||(exports.ZipMismatchMode={}));var ZipIterator=function(_super){function ZipIterator(iterators,mismatchMode){void 0===mismatchMode&&(mismatchMode=ZipMismatchMode.FAIL);var _this=_super.call(this)||this;return _this.iterators=iterators,_this.mismatchMode=mismatchMode,_this.count=0,_this.currentPromise=null,_this}return __extends(ZipIterator,_super),ZipIterator.prototype.summary=function(){return"{TODO: fill in upstream of zip summaries} -> Zip"},ZipIterator.prototype.nextState=function(afterState){return __awaiter(this,void 0,void 0,function(){function getNext(container){return container instanceof LazyIterator?{value:container.next().then(function(x){return numIterators++,x.done&&iteratorsDone++,x.value}),recurse:!1}:{value:null,recurse:!0}}var numIterators,iteratorsDone,mapped;return __generator(this,function(_a){switch(_a.label){case 0:return[4,afterState];case 1:return _a.sent(),iteratorsDone=numIterators=0,[4,deep_map_1.deepMapAndAwaitAll(this.iterators,getNext)];case 2:if(mapped=_a.sent(),numIterators===iteratorsDone)return[2,{value:null,done:!0}];if(0<iteratorsDone)switch(this.mismatchMode){case ZipMismatchMode.FAIL:throw new Error("Zipped streams should have the same length. Mismatched at element "+this.count+".");case ZipMismatchMode.SHORTEST:return[2,{value:null,done:!0}];case ZipMismatchMode.LONGEST:}return this.count++,[2,{value:mapped,done:!1}]}})})},ZipIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.currentPromise=this.nextState(this.currentPromise),[4,this.currentPromise];case 1:return[2,_a.sent()]}})})},ZipIterator}(LazyIterator),PrefetchIterator=function(_super){function PrefetchIterator(upstream,bufferSize){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.bufferSize=bufferSize,_this.buffer=new ring_buffer_1.RingBuffer(bufferSize),_this}return __extends(PrefetchIterator,_super),PrefetchIterator.prototype.summary=function(){return this.upstream.summary()+" -> Prefetch"},PrefetchIterator.prototype.refill=function(){for(;!this.buffer.isFull();){var v=this.upstream.next();this.buffer.push(v)}},PrefetchIterator.prototype.next=function(){return this.refill(),this.buffer.shift()},PrefetchIterator}(LazyIterator),ShuffleIterator=function(_super){function ShuffleIterator(upstream,windowSize,seed){var _this=_super.call(this,upstream,windowSize)||this;return _this.upstream=upstream,_this.windowSize=windowSize,_this.upstreamExhausted=!1,_this.random=seedrandom.alea(seed||tf.util.now().toString()),_this.lastRead=Promise.resolve({value:null,done:!1}),_this}return __extends(ShuffleIterator,_super),ShuffleIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return this.lastRead=this.lastRead.then(function(){return _this.serialNext()}),[2,this.lastRead]})})},ShuffleIterator.prototype.randomInt=function(max){return Math.floor(this.random()*max)},ShuffleIterator.prototype.chooseIndex=function(){return this.randomInt(this.buffer.length())},ShuffleIterator.prototype.serialNext=function(){return __awaiter(this,void 0,void 0,function(){var chosenIndex,result;return __generator(this,function(_a){switch(_a.label){case 0:this.upstreamExhausted||this.refill(),_a.label=1;case 1:return this.buffer.isEmpty()?[3,3]:(chosenIndex=this.chooseIndex(),[4,this.buffer.shuffleExcise(chosenIndex)]);case 2:return(result=_a.sent()).done?(this.upstreamExhausted=!0,[3,1]):(this.refill(),[2,result]);case 3:return[2,{value:null,done:!0}]}})})},ShuffleIterator}(exports.PrefetchIterator=PrefetchIterator);exports.ShuffleIterator=ShuffleIterator},{"../util/deep_clone":267,"../util/deep_map":268,"../util/growing_ring_buffer":269,"../util/ring_buffer":270,"@tensorflow/tfjs-core":148,seedrandom:338}],260:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),MicrophoneIterator=function(_super){function MicrophoneIterator(microphoneConfig){var _this=_super.call(this)||this;_this.microphoneConfig=microphoneConfig,_this.isClosed=!1,_this.fftSize=microphoneConfig.fftSize||1024;var fftSizeLog2=Math.log2(_this.fftSize);if(_this.fftSize<0||fftSizeLog2<4||14<fftSizeLog2||!Number.isInteger(fftSizeLog2))throw new Error("Invalid fftSize: it must be a power of 2 between 2 to 4 and 2 to 14, but got "+_this.fftSize);if(_this.numFrames=microphoneConfig.numFramesPerSpectrogram||43,_this.sampleRateHz=microphoneConfig.sampleRateHz,_this.columnTruncateLength=microphoneConfig.columnTruncateLength||_this.fftSize,_this.audioTrackConstraints=microphoneConfig.audioTrackConstraints,_this.smoothingTimeConstant=microphoneConfig.smoothingTimeConstant||0,_this.includeSpectrogram=!1!==microphoneConfig.includeSpectrogram,_this.includeWaveform=!0===microphoneConfig.includeWaveform,!_this.includeSpectrogram&&!_this.includeWaveform)throw new Error("Both includeSpectrogram and includeWaveform are false. At least one type of data should be returned.");return _this}return __extends(MicrophoneIterator,_super),MicrophoneIterator.prototype.summary=function(){return"microphone"},MicrophoneIterator.create=function(microphoneConfig){return void 0===microphoneConfig&&(microphoneConfig={}),__awaiter(this,void 0,void 0,function(){var microphoneIterator;return __generator(this,function(_a){switch(_a.label){case 0:if(tfjs_core_1.ENV.get("IS_NODE"))throw new Error("microphone API is only supported in browser environment.");return[4,(microphoneIterator=new MicrophoneIterator(microphoneConfig)).start()];case 1:return _a.sent(),[2,microphoneIterator]}})})},MicrophoneIterator.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){var _a,e_1,ctxConstructor,streamSource;return __generator(this,function(_b){switch(_b.label){case 0:return _b.trys.push([0,2,,3]),_a=this,[4,navigator.mediaDevices.getUserMedia({audio:null==this.audioTrackConstraints||this.audioTrackConstraints,video:!1})];case 1:return _a.stream=_b.sent(),[3,3];case 2:throw e_1=_b.sent(),new Error("Error thrown while initializing video stream: "+e_1.message);case 3:if(!this.stream)throw new Error("Could not obtain audio from microphone.");if(ctxConstructor=window.AudioContext||window.webkitAudioContext,this.audioContext=new ctxConstructor,this.sampleRateHz){if(this.audioContext.sampleRate!==this.sampleRateHz)throw new Error("Mismatch in sampling rate: Expected: "+this.sampleRateHz+"; Actual: "+this.audioContext.sampleRate)}else this.sampleRateHz=this.audioContext.sampleRate;return streamSource=this.audioContext.createMediaStreamSource(this.stream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2*this.fftSize,this.analyser.smoothingTimeConstant=this.smoothingTimeConstant,streamSource.connect(this.analyser),this.freqData=new Float32Array(this.fftSize),this.timeData=new Float32Array(this.fftSize),[2]}})})},MicrophoneIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var spectrogramTensor,waveformTensor,audioDataQueue,freqData,timeData;return __generator(this,function(_a){switch(_a.label){case 0:return this.isClosed?[2,{value:null,done:!0}]:[4,this.getAudioData()];case 1:return audioDataQueue=_a.sent(),this.includeSpectrogram&&(freqData=this.flattenQueue(audioDataQueue.freqDataQueue),spectrogramTensor=this.getTensorFromAudioDataArray(freqData,[this.numFrames,this.columnTruncateLength,1])),this.includeWaveform&&(timeData=this.flattenQueue(audioDataQueue.timeDataQueue),waveformTensor=this.getTensorFromAudioDataArray(timeData,[this.numFrames*this.fftSize,1])),[2,{value:{spectrogram:spectrogramTensor,waveform:waveformTensor},done:!1}]}})})},MicrophoneIterator.prototype.capture=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:return[2,_a.sent().value]}})})},MicrophoneIterator.prototype.getAudioData=function(){return __awaiter(this,void 0,void 0,function(){var freqDataQueue,timeDataQueue,currentFrames,_this=this;return __generator(this,function(_a){return freqDataQueue=[],timeDataQueue=[],currentFrames=0,[2,new Promise(function(resolve){var intervalID=setInterval(function(){_this.includeSpectrogram&&(_this.analyser.getFloatFrequencyData(_this.freqData),_this.freqData[0]===-1/0&&resolve({freqDataQueue:freqDataQueue,timeDataQueue:timeDataQueue}),freqDataQueue.push(_this.freqData.slice(0,_this.columnTruncateLength))),_this.includeWaveform&&(_this.analyser.getFloatTimeDomainData(_this.timeData),timeDataQueue.push(_this.timeData.slice())),++currentFrames===_this.numFrames&&(clearInterval(intervalID),resolve({freqDataQueue:freqDataQueue,timeDataQueue:timeDataQueue}))},_this.fftSize/_this.sampleRateHz*1e3)})]})})},MicrophoneIterator.prototype.stop=function(){this.isClosed=!0,this.analyser.disconnect(),this.audioContext.close(),null!=this.stream&&0<this.stream.getTracks().length&&this.stream.getTracks()[0].stop()},MicrophoneIterator.prototype.toArray=function(){throw new Error("Can not convert infinite audio stream to array.")},MicrophoneIterator.prototype.getSampleRate=function(){return this.sampleRateHz},MicrophoneIterator.prototype.flattenQueue=function(queue){var frameSize=queue[0].length,freqData=new Float32Array(queue.length*frameSize);return queue.forEach(function(data,i){return freqData.set(data,i*frameSize)}),freqData},MicrophoneIterator.prototype.getTensorFromAudioDataArray=function(freqData,shape){var vals=new Float32Array(tfjs_core_1.util.sizeFromShape(shape));return vals.set(freqData,vals.length-freqData.length),tfjs_core_1.tensor(vals,shape)},MicrophoneIterator}(require("./lazy_iterator").LazyIterator);exports.MicrophoneIterator=MicrophoneIterator},{"./lazy_iterator":259,"@tensorflow/tfjs-core":148}],261:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var lazy_iterator_1=require("./lazy_iterator"),StringIterator=function(_super){function StringIterator(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(StringIterator,_super),StringIterator.prototype.split=function(separator){return new SplitIterator(this,separator)},StringIterator}(lazy_iterator_1.LazyIterator),SplitIterator=function(_super){function SplitIterator(upstream,separator){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.impl=new SplitIteratorImpl(upstream,separator),_this}return __extends(SplitIterator,_super),SplitIterator.prototype.summary=function(){return this.impl.summary()},SplitIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.impl.next()]})})},SplitIterator}(exports.StringIterator=StringIterator),SplitIteratorImpl=function(_super){function SplitIteratorImpl(upstream,separator){var _this=_super.call(this)||this;return _this.upstream=upstream,_this.separator=separator,_this.carryover="",_this}return __extends(SplitIteratorImpl,_super),SplitIteratorImpl.prototype.summary=function(){return this.upstream.summary()+" -> Split('"+this.separator+"')"},SplitIteratorImpl.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var chunkResult,lines,_i,_a,line;return __generator(this,function(_b){switch(_b.label){case 0:return[4,this.upstream.next()];case 1:if((chunkResult=_b.sent()).done)return""===this.carryover?[2,!1]:(this.outputQueue.push(this.carryover),[2,!(this.carryover="")]);for((lines=chunkResult.value.split(this.separator))[0]=this.carryover+lines[0],_i=0,_a=lines.slice(0,-1);_i<_a.length;_i++)line=_a[_i],this.outputQueue.push(line);return this.carryover=lines[lines.length-1],[2,!0]}})})},SplitIteratorImpl}(lazy_iterator_1.OneToManyIterator)},{"./lazy_iterator":259}],262:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),file_chunk_iterator_1=require("./file_chunk_iterator");exports.urlChunkIterator=function(url,options){return void 0===options&&(options={}),__awaiter(this,void 0,void 0,function(){var urlString,requestInit,response,uint8Array,_a;return __generator(this,function(_b){switch(_b.label){case 0:return"string"==typeof url?urlString=url:(urlString=url.url,requestInit=getRequestInitFromRequest(url)),[4,tfjs_core_1.util.fetch(urlString,requestInit)];case 1:return(response=_b.sent()).ok?(_a=Uint8Array.bind,[4,response.arrayBuffer()]):[3,3];case 2:return uint8Array=new(_a.apply(Uint8Array,[void 0,_b.sent()])),[2,new file_chunk_iterator_1.FileChunkIterator(uint8Array,options)];case 3:throw new Error(response.statusText)}})})};var getRequestInitFromRequest=function(request){return{method:request.method,headers:request.headers,body:request.body,mode:request.mode,credentials:request.credentials,cache:request.cache,redirect:request.redirect,referrer:request.referrer,integrity:request.integrity}}},{"./file_chunk_iterator":258,"@tensorflow/tfjs-core":148}],263:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),WebcamIterator=function(_super){function WebcamIterator(webcamVideoElement,webcamConfig){var _this=_super.call(this)||this;if(_this.webcamVideoElement=webcamVideoElement,_this.webcamConfig=webcamConfig,_this.isClosed=!0,_this.resize=!1,_this.needToResize())if(_this.resize=!0,_this.cropSize=[_this.webcamConfig.resizeHeight,_this.webcamConfig.resizeWidth],_this.cropBoxInd=tfjs_core_1.tensor1d([0],"int32"),_this.webcamConfig.centerCrop){var widthCroppingRatio=1*_this.webcamConfig.resizeWidth/_this.webcamVideoElement.width,heightCroppingRatio=1*_this.webcamConfig.resizeHeight/_this.webcamVideoElement.height,widthCropStart=(1-widthCroppingRatio)/2,heightCropStart=(1-heightCroppingRatio)/2,widthCropEnd=widthCropStart+widthCroppingRatio,heightCropEnd=heightCroppingRatio+heightCropStart;_this.cropBox=tfjs_core_1.tensor2d([heightCropStart,widthCropStart,heightCropEnd,widthCropEnd],[1,4])}else _this.cropBox=tfjs_core_1.tensor2d([0,0,1,1],[1,4]);return _this}return __extends(WebcamIterator,_super),WebcamIterator.prototype.summary=function(){return"webcam"},WebcamIterator.create=function(webcamVideoElement,webcamConfig){return void 0===webcamConfig&&(webcamConfig={}),__awaiter(this,void 0,void 0,function(){var webcamIterator;return __generator(this,function(_a){switch(_a.label){case 0:if(tfjs_core_1.ENV.get("IS_NODE"))throw new Error("tf.data.webcam is only supported in browser environment.");if(!webcamVideoElement){if(webcamVideoElement=document.createElement("video"),!webcamConfig.resizeWidth||!webcamConfig.resizeHeight)throw new Error("Please provide webcam video element, or resizeWidth and resizeHeight to create a hidden video element.");webcamVideoElement.width=webcamConfig.resizeWidth,webcamVideoElement.height=webcamConfig.resizeHeight}return[4,(webcamIterator=new WebcamIterator(webcamVideoElement,webcamConfig)).start()];case 1:return _a.sent(),[2,webcamIterator]}})})},WebcamIterator.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){var _a,e_1,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:this.webcamConfig.facingMode&&tfjs_core_1.util.assert("user"===this.webcamConfig.facingMode||"environment"===this.webcamConfig.facingMode,function(){return"Invalid webcam facing mode: "+_this.webcamConfig.facingMode+". Please provide 'user' or 'environment'"}),_b.label=1;case 1:return _b.trys.push([1,3,,4]),_a=this,[4,navigator.mediaDevices.getUserMedia({video:{deviceId:this.webcamConfig.deviceId,facingMode:this.webcamConfig.facingMode?this.webcamConfig.facingMode:"user",width:this.webcamVideoElement.width,height:this.webcamVideoElement.height}})];case 2:return _a.stream=_b.sent(),[3,4];case 3:throw(e_1=_b.sent()).message="Error thrown while initializing video stream: "+e_1.message,e_1;case 4:if(!this.stream)throw new Error("Could not obtain video from webcam.");try{this.webcamVideoElement.srcObject=this.stream}catch(error){console.log(error),this.webcamVideoElement.src=window.URL.createObjectURL(this.stream)}return this.webcamVideoElement.play(),this.isClosed=!1,[2,new Promise(function(resolve){_this.webcamVideoElement.onloadedmetadata=function(){resolve()}})]}})})},WebcamIterator.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var img;return __generator(this,function(_a){if(this.isClosed)return[2,{value:null,done:!0}];try{img=tfjs_core_1.browser.fromPixels(this.webcamVideoElement)}catch(e){throw new Error("Error thrown converting video to pixels: "+JSON.stringify(e))}if(!this.resize)return[2,{value:img,done:!1}];try{return[2,{value:this.cropAndResizeFrame(img),done:!1}]}catch(e){throw new Error("Error thrown cropping the video: "+e.message)}finally{img.dispose()}return[2]})})},WebcamIterator.prototype.needToResize=function(){return!(!this.webcamConfig.resizeWidth||!this.webcamConfig.resizeHeight||this.webcamVideoElement.width===this.webcamConfig.resizeWidth&&this.webcamVideoElement.height===this.webcamConfig.resizeHeight)},WebcamIterator.prototype.cropAndResizeFrame=function(img){var _this=this;return tfjs_core_1.tidy(function(){var resizedImage,expandedImage=img.toFloat().expandDims(0),shape=(resizedImage=tfjs_core_1.image.cropAndResize(expandedImage,_this.cropBox,_this.cropBoxInd,_this.cropSize,"bilinear")).shape;return resizedImage.reshape(shape.slice(1))})},WebcamIterator.prototype.capture=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.next()];case 1:return[2,_a.sent().value]}})})},WebcamIterator.prototype.stop=function(){this.stream.getTracks().forEach(function(track){return track.stop()});try{this.webcamVideoElement.srcObject=null}catch(error){console.log(error),this.webcamVideoElement.src=null}this.isClosed=!0},WebcamIterator.prototype.toArray=function(){throw new Error("Can not convert infinite video stream to array.")},WebcamIterator}(require("./lazy_iterator").LazyIterator);exports.WebcamIterator=WebcamIterator},{"./lazy_iterator":259,"@tensorflow/tfjs-core":148}],264:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var dataset_1=require("./dataset"),csv_dataset_1=require("./datasets/csv_dataset"),lazy_iterator_1=require("./iterators/lazy_iterator"),microphone_iterator_1=require("./iterators/microphone_iterator"),webcam_iterator_1=require("./iterators/webcam_iterator"),url_data_source_1=require("./sources/url_data_source");exports.csv=function(source,csvConfig){return void 0===csvConfig&&(csvConfig={}),new csv_dataset_1.CSVDataset(new url_data_source_1.URLDataSource(source),csvConfig)},exports.func=function(f){var _this=this,iter=lazy_iterator_1.iteratorFromFunction(f);return dataset_1.datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){return[2,iter]})})})},exports.generator=function(generator){var _this=this;return dataset_1.datasetFromIteratorFn(function(){return __awaiter(_this,void 0,void 0,function(){var gen;return __generator(this,function(_a){switch(_a.label){case 0:return[4,generator()];case 1:return gen=_a.sent(),[2,lazy_iterator_1.iteratorFromFunction(function(){return gen.next()})]}})})})},exports.webcam=function(webcamVideoElement,webcamConfig){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,webcam_iterator_1.WebcamIterator.create(webcamVideoElement,webcamConfig)]})})},exports.microphone=function(microphoneConfig){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,microphone_iterator_1.MicrophoneIterator.create(microphoneConfig)]})})}},{"./dataset":252,"./datasets/csv_dataset":253,"./iterators/lazy_iterator":259,"./iterators/microphone_iterator":260,"./iterators/webcam_iterator":263,"./sources/url_data_source":266}],265:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),datasource_1=require("../datasource"),file_chunk_iterator_1=require("../iterators/file_chunk_iterator"),source_util_1=require("../util/source_util"),FileDataSource=function(_super){function FileDataSource(input,options){void 0===options&&(options={});var _this=_super.call(this)||this;return _this.input=input,_this.options=options,_this}return __extends(FileDataSource,_super),FileDataSource.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){var fs;return __generator(this,function(_a){return source_util_1.isLocalPath(this.input)&&tfjs_core_1.ENV.get("IS_NODE")&&(fs=require("fs"),this.input=fs.readFileSync(this.input.substr(7))),[2,new file_chunk_iterator_1.FileChunkIterator(this.input,this.options)]})})},FileDataSource}(datasource_1.DataSource);exports.FileDataSource=FileDataSource},{"../datasource":255,"../iterators/file_chunk_iterator":258,"../util/source_util":271,"@tensorflow/tfjs-core":148,fs:333}],266:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var datasource_1=require("../datasource"),url_chunk_iterator_1=require("../iterators/url_chunk_iterator"),source_util_1=require("../util/source_util"),file_data_source_1=require("./file_data_source"),URLDataSource=function(_super){function URLDataSource(url,fileOptions){void 0===fileOptions&&(fileOptions={});var _this=_super.call(this)||this;return _this.url=url,_this.fileOptions=fileOptions,_this}return __extends(URLDataSource,_super),URLDataSource.prototype.iterator=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return source_util_1.isLocalPath(this.url)?[2,new file_data_source_1.FileDataSource(this.url,this.fileOptions).iterator()]:[2,url_chunk_iterator_1.urlChunkIterator(this.url,this.fileOptions)]})})},URLDataSource}(datasource_1.DataSource);exports.URLDataSource=URLDataSource},{"../datasource":255,"../iterators/url_chunk_iterator":262,"../util/source_util":271,"./file_data_source":265}],267:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core"),deep_map_1=require("./deep_map");function cloneIfTensor(item){return item instanceof tf.Tensor?{value:item.clone(),recurse:!1}:deep_map_1.isIterable(item)?{value:null,recurse:!0}:{value:item,recurse:!1}}exports.deepClone=function(container){return deep_map_1.deepMap(container,cloneIfTensor)}},{"./deep_map":268,"@tensorflow/tfjs-core":148}],268:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tf=require("@tensorflow/tfjs-core");function deepMapInternal(input,mapFn,seen,containedIn){if(void 0===seen&&(seen=new Map),void 0===containedIn&&(containedIn=new Set),null==input)return null;if(containedIn.has(input))throw new Error("Circular references are not supported.");if(seen.has(input))return seen.get(input);var result=mapFn(input);if(result.recurse&&null!==result.value)throw new Error("A deep map function may not return both a value and recurse=true.");if(result.recurse){if(isIterable(input)){var mappedIterable=Array.isArray(input)?[]:{};for(var k in containedIn.add(input),input){var childResult=deepMapInternal(input[k],mapFn,seen,containedIn);mappedIterable[k]=childResult}return containedIn.delete(input),mappedIterable}throw new Error("Can't recurse into non-iterable type: "+input)}return seen.set(input,result.value),result.value}function zipToList(x){return null===x?null:isIterable(x[0])?{value:null,recurse:!0}:{value:x,recurse:!1}}function isIterable(obj){return null!=obj&&(Array.isArray(obj)||"object"==typeof obj&&!(obj instanceof tf.Tensor))}exports.deepMap=function(input,mapFn){return deepMapInternal(input,mapFn)},exports.deepZip=function(inputs,zipFn){return void 0===zipFn&&(zipFn=zipToList),function deepZipInternal(inputs,zipFn,containedIn){void 0===containedIn&&(containedIn=new Set);var input=inputs[0];if(containedIn.has(input))throw new Error("Circular references are not supported.");var result=zipFn(inputs);if(result.recurse&&null!==result.value)throw new Error("A deep zip function may not return both a value and recurse=true.");{if(result.recurse){if(isIterable(input)){var mappedIterable=Array.isArray(input)?[]:{};containedIn.add(input);var _loop_1=function(k){var children=inputs.map(function(x){return x[k]}),childResult=deepZipInternal(children,zipFn,containedIn);mappedIterable[k]=childResult};for(var k in input)_loop_1(k);return containedIn.delete(input),mappedIterable}throw new Error("Can't recurse into non-iterable type: "+input)}return result.value}}(inputs,zipFn)},exports.zipToList=zipToList,exports.deepMapAndAwaitAll=function(input,mapFn){return __awaiter(this,void 0,void 0,function(){var seen,_i,_a,key,value,mappedValue;return __generator(this,function(_b){switch(_b.label){case 0:seen=new Map,deepMapInternal(input,mapFn,seen),_i=0,_a=Array.from(seen.keys()),_b.label=1;case 1:return _i<_a.length?(key=_a[_i],(value=seen.get(key))instanceof Promise?[4,value]:[3,3]):[3,4];case 2:mappedValue=_b.sent(),seen.set(key,mappedValue),_b.label=3;case 3:return _i++,[3,1];case 4:return[2,deepMapInternal(input,mapFn,seen)]}})})},exports.isIterable=isIterable,exports.canTensorify=function(obj){return null==obj||function(value){return null===value||"object"!=typeof value&&"function"!=typeof value}(obj)||Array.isArray(obj)||"object"==typeof obj&&obj instanceof tf.Tensor||tf.util.isTypedArray(obj)}},{"@tensorflow/tfjs-core":148}],269:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var GrowingRingBuffer=function(_super){function GrowingRingBuffer(){return _super.call(this,GrowingRingBuffer.INITIAL_CAPACITY)||this}return __extends(GrowingRingBuffer,_super),GrowingRingBuffer.prototype.isFull=function(){return!1},GrowingRingBuffer.prototype.push=function(value){_super.prototype.isFull.call(this)&&this.expand(),_super.prototype.push.call(this,value)},GrowingRingBuffer.prototype.unshift=function(value){_super.prototype.isFull.call(this)&&this.expand(),_super.prototype.unshift.call(this,value)},GrowingRingBuffer.prototype.expand=function(){for(var newCapacity=2*this.capacity,newData=new Array(newCapacity),len=this.length(),i=0;i<len;i++)newData[i]=this.get(this.wrap(this.begin+i));this.data=newData,this.capacity=newCapacity,this.doubledCapacity=2*this.capacity,this.begin=0,this.end=len},GrowingRingBuffer.INITIAL_CAPACITY=32,GrowingRingBuffer}(require("./ring_buffer").RingBuffer);exports.GrowingRingBuffer=GrowingRingBuffer},{"./ring_buffer":270}],270:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var RingBuffer=function(){function RingBuffer(capacity){if(this.capacity=capacity,this.begin=0,this.end=0,null==capacity)throw new RangeError("Can't create a ring buffer of unknown capacity.");if(capacity<1)throw new RangeError("Can't create ring buffer of capacity < 1.");this.data=new Array(capacity),this.doubledCapacity=2*capacity}return RingBuffer.prototype.wrap=function(index){for(;index<0;)index+=this.doubledCapacity;return index%this.doubledCapacity},RingBuffer.prototype.get=function(index){if(index<0)throw new RangeError("Can't get item at a negative index.");return this.data[index%this.capacity]},RingBuffer.prototype.set=function(index,value){if(index<0)throw new RangeError("Can't set item at a negative index.");this.data[index%this.capacity]=value},RingBuffer.prototype.length=function(){var length=this.end-this.begin;return length<0&&(length=this.doubledCapacity+length),length},RingBuffer.prototype.isFull=function(){return this.length()===this.capacity},RingBuffer.prototype.isEmpty=function(){return 0===this.length()},RingBuffer.prototype.push=function(value){if(this.isFull())throw new RangeError("Ring buffer is full.");this.set(this.end,value),this.end=this.wrap(this.end+1)},RingBuffer.prototype.pushAll=function(values){for(var _i=0,values_1=values;_i<values_1.length;_i++){var value=values_1[_i];this.push(value)}},RingBuffer.prototype.pop=function(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");this.end=this.wrap(this.end-1);var result=this.get(this.end);return this.set(this.end,void 0),result},RingBuffer.prototype.unshift=function(value){if(this.isFull())throw new RangeError("Ring buffer is full.");this.begin=this.wrap(this.begin-1),this.set(this.begin,value)},RingBuffer.prototype.shift=function(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");var result=this.get(this.begin);return this.set(this.begin,void 0),this.begin=this.wrap(this.begin+1),result},RingBuffer.prototype.shuffleExcise=function(relativeIndex){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");var index=this.wrap(this.begin+relativeIndex),result=this.get(index);return this.set(index,this.pop()),result},RingBuffer}();exports.RingBuffer=RingBuffer},{}],271:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isLocalPath=function(source){return"string"==typeof source&&"file://"===source.substr(0,7)}},{}],272:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],273:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),generic_utils_1=require("./utils/generic_utils"),Activation=function(_super){function Activation(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Activation,_super),Activation.prototype.getConfig=function(){return{}},Activation}(tfjs_core_1.serialization.Serializable),Elu=function(_super){function Elu(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Elu,_super),Elu.prototype.apply=function(x,alpha){return void 0===alpha&&(alpha=1),K.elu(x,alpha)},Elu.className="elu",Elu}(exports.Activation=Activation);exports.Elu=Elu,tfjs_core_1.serialization.registerClass(Elu);var Selu=function(_super){function Selu(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Selu,_super),Selu.prototype.apply=function(x){return tfc.selu(x)},Selu.className="selu",Selu}(Activation);exports.Selu=Selu,tfjs_core_1.serialization.registerClass(Selu);var Relu=function(_super){function Relu(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Relu,_super),Relu.prototype.apply=function(x){return tfc.relu(x)},Relu.className="relu",Relu}(Activation);exports.Relu=Relu,tfjs_core_1.serialization.registerClass(Relu);var Relu6=function(_super){function Relu6(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Relu6,_super),Relu6.prototype.apply=function(x){return tfjs_core_1.tidy(function(){return tfc.minimum(6,tfc.relu(x))})},Relu6.className="relu6",Relu6}(Activation);exports.Relu6=Relu6,tfjs_core_1.serialization.registerClass(Relu6);var Linear=function(_super){function Linear(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Linear,_super),Linear.prototype.apply=function(x){return x},Linear.className="linear",Linear}(Activation);exports.Linear=Linear,tfjs_core_1.serialization.registerClass(Linear);var Sigmoid=function(_super){function Sigmoid(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Sigmoid,_super),Sigmoid.prototype.apply=function(x){return tfc.sigmoid(x)},Sigmoid.className="sigmoid",Sigmoid}(Activation);exports.Sigmoid=Sigmoid,tfjs_core_1.serialization.registerClass(Sigmoid);var HardSigmoid=function(_super){function HardSigmoid(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(HardSigmoid,_super),HardSigmoid.prototype.apply=function(x){return K.hardSigmoid(x)},HardSigmoid.className="hardSigmoid",HardSigmoid}(Activation);exports.HardSigmoid=HardSigmoid,tfjs_core_1.serialization.registerClass(HardSigmoid);var Softplus=function(_super){function Softplus(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Softplus,_super),Softplus.prototype.apply=function(x){return tfc.softplus(x)},Softplus.className="softplus",Softplus}(Activation);exports.Softplus=Softplus,tfjs_core_1.serialization.registerClass(Softplus);var Softsign=function(_super){function Softsign(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Softsign,_super),Softsign.prototype.apply=function(x){return K.softsign(x)},Softsign.className="softsign",Softsign}(Activation);exports.Softsign=Softsign,tfjs_core_1.serialization.registerClass(Softsign);var Tanh=function(_super){function Tanh(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Tanh,_super),Tanh.prototype.apply=function(x){return tfc.tanh(x)},Tanh.className="tanh",Tanh}(Activation);exports.Tanh=Tanh,tfjs_core_1.serialization.registerClass(Tanh);var Softmax=function(_super){function Softmax(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Softmax,_super),Softmax.prototype.apply=function(x,axis){return void 0===axis&&(axis=-1),tfc.softmax(x,axis)},Softmax.className="softmax",Softmax}(Activation);exports.Softmax=Softmax,tfjs_core_1.serialization.registerClass(Softmax);var LogSoftmax=function(_super){function LogSoftmax(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(LogSoftmax,_super),LogSoftmax.prototype.apply=function(x,axis){return void 0===axis&&(axis=-1),tfc.logSoftmax(x,axis)},LogSoftmax.className="logSoftmax",LogSoftmax}(Activation);function deserializeActivation(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"activation")}exports.LogSoftmax=LogSoftmax,tfjs_core_1.serialization.registerClass(LogSoftmax),exports.serializeActivation=function(activation){return activation.getClassName()},exports.deserializeActivation=deserializeActivation,exports.getActivation=function(identifier){return null!=identifier?"string"!=typeof identifier?identifier instanceof Activation?identifier:deserializeActivation(identifier):((config={}).className=identifier,config.config={},deserializeActivation(config)):deserializeActivation(config={className:"linear",config:{}});var config}},{"./backend/tfjs_backend":276,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],274:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _epsilon,tfjs_core_1=require("@tensorflow/tfjs-core");exports.epsilon=function(){return null==_epsilon&&(_epsilon=tfjs_core_1.backend().epsilon()),_epsilon},exports.setEpsilon=function(e){_epsilon=e},exports.imageDataFormat=function(){return"channelsLast"}},{"@tensorflow/tfjs-core":148}],275:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _nextUniqueTensorId=0;exports.getNextUniqueTensorId=function(){return _nextUniqueTensorId++};var _uidPrefixes={};exports.getUid=function(prefix){return void 0===prefix&&(prefix=""),prefix in _uidPrefixes||(_uidPrefixes[prefix]=0),_uidPrefixes[prefix]+=1,prefix+_uidPrefixes[prefix].toString()}},{}],276:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../common"),errors_1=require("../errors"),math_utils=require("../utils/math_utils"),common_2=require("./common"),backend="webgl";function expandDims(x,axis){void 0===axis&&(axis=-1);var outShape=x.shape.slice();return axis<0&&(axis=outShape.length+axis+1),outShape.splice(axis,0,1),x.reshape(outShape)}function sliceAlongFirstAxis(array,start,size){return tfjs_core_1.tidy(function(){switch(array.rank){case 1:return tfc.slice1d(array,start,size);case 2:return tfc.slice2d(array,[start,0],[size,array.shape[1]]);case 3:return tfc.slice3d(array,[start,0,0],[size,array.shape[1],array.shape[2]]);case 4:return tfc.slice4d(array,[start,0,0,0],[size,array.shape[1],array.shape[2],array.shape[3]]);default:throw new errors_1.ValueError("sliceAlongFirstAxis() received an unsupported tensor rank: "+array.rank)}})}function sliceAlongLastAxis(array,start,size){return tfjs_core_1.tidy(function(){switch(array.rank){case 1:return tfc.slice1d(array,start,size);case 2:return tfc.slice2d(array,[0,start],[array.shape[0],size]);case 3:return tfc.slice3d(array,[0,0,start],[array.shape[0],array.shape[1],size]);case 4:return tfc.slice4d(array,[0,0,0,start],[array.shape[0],array.shape[1],array.shape[2],size]);default:throw new errors_1.ValueError("sliceAlongLastAxis() received an unsupported tensor rank: "+array.rank)}})}function tile(x,n){if(Array.isArray(n)||(n=[n]),x.rank!==n.length)throw new errors_1.ValueError("The length of input n ("+n.length+") does not match the number of dimensions in input x ("+x.rank+")");return tfc.tile(x,n)}function reshapeBias(xRank,bias,dataFormat){var biasShape=bias.shape;if(1!==bias.rank&&bias.rank!==xRank)throw new errors_1.ValueError("Unexpected bias dimensions: "+bias.rank+"; expected it to be 1 or "+xRank);if(5===xRank){if("channelsFirst"===dataFormat)return 1===biasShape.length?bias.reshape([1,biasShape[0],1,1,1]):bias.reshape([1,biasShape[3],biasShape[0],biasShape[1],biasShape[2]]);if("channelsLast"===dataFormat)return 1===biasShape.length?bias.reshape([1,1,1,1,biasShape[0]]):bias.reshape([1].concat(biasShape))}else if(4===xRank){if("channelsFirst"===dataFormat)return 1===biasShape.length?bias.reshape([1,biasShape[0],1,1]):bias.reshape([1,biasShape[2],biasShape[0],biasShape[1]]);if("channelsLast"===dataFormat)return 1===biasShape.length?bias.reshape([1,1,1,biasShape[0]]):bias.reshape([1].concat(biasShape))}else if(3===xRank){if("channelsFirst"===dataFormat)return 1===biasShape.length?bias.reshape([1,biasShape[0],1]):bias.reshape([1,biasShape[1],biasShape[0]]);if("channelsLast"===dataFormat)return 1===biasShape.length?bias.reshape([1,1,biasShape[0]]):bias.reshape([1].concat(biasShape))}else if(xRank<3)return bias;throw new errors_1.ValueError("Unsupported input rank by biasAdd: "+bias.rank)}exports.setBackend=function(requestedBackend){tfc.setBackend(requestedBackend),backend=requestedBackend},exports.getBackend=function(){return backend},exports.isBackendSymbolic=function(){return!1},exports.countParams=function(x){var shape=x.shape;return 0<shape.length?shape.reduce(function(a,b){return a*b}):1},exports.cast=function(x,dtype){return x.asType(dtype)},exports.expandDims=expandDims,exports.repeat=function(x,n){return tfjs_core_1.tidy(function(){if(2!==x.shape.length)throw new errors_1.ValueError("repeat() expects a rank-2 tensor, but received a rank-"+x.shape.length+" tensor.");return tile(expandDims(x,1),[1,n,1])})},exports.flatten=function(x){var newShape=[math_utils.arrayProd(x.shape)];return x.reshape(newShape)},exports.batchFlatten=function(x){if(x.rank<=1)throw new errors_1.ValueError("batchFlatten requires a minimum rank of 2. Got rank: "+x.rank+".");var newShape=[x.shape[0],math_utils.arrayProd(x.shape,1)];return x.reshape(newShape)},exports.sliceAlongFirstAxis=sliceAlongFirstAxis,exports.sliceAlongLastAxis=sliceAlongLastAxis,exports.sliceAlongAxis=function(array,start,size,axis){return tfjs_core_1.tidy(function(){switch(array.rank){case 1:return tfc.slice1d(array,start,size);case 2:switch(axis){case 1:return sliceAlongFirstAxis(array,start,size);case 2:return sliceAlongLastAxis(array,start,size);default:throw new errors_1.ValueError("The axis is not within the rank of the tensor "+axis)}case 3:switch(axis){case 1:return sliceAlongFirstAxis(array,start,size);case 2:return tfc.slice3d(array,[0,start,0],[array.shape[0],size,array.shape[2]]);case 3:return sliceAlongLastAxis(array,start,size);default:throw new errors_1.ValueError("The axis is not within the rank of the tensor "+axis)}case 4:switch(axis){case 1:return sliceAlongFirstAxis(array,start,size);case 2:return tfc.slice4d(array,[0,start,0,0],[array.shape[0],size,array.shape[2],array.shape[3]]);case 3:return tfc.slice4d(array,[0,0,start,0],[array.shape[0],array.shape[1],size,array.shape[3]]);case 4:return sliceAlongLastAxis(array,start,size);default:throw new errors_1.ValueError("The axis is not within the rank of the tensor "+axis)}default:throw new errors_1.ValueError("sliceAlongLastAxis() received an unsupported tensor rank: "+array.rank)}})},exports.concatenate=function(tensors,axis){var rank;return void 0===axis&&(axis=-1),axis<0&&(axis=0!==(rank=tensors[0].rank)?rank:0),axis===tensors[0].rank&&(axis=-1),tfc.concat(tensors,axis)},exports.concatAlongFirstAxis=function(a,b){switch(a.rank){case 1:return tfc.concat1d([a,b]);case 2:return tfc.concat2d([a,b],0);case 3:return tfc.concat3d([a,b],0);case 4:return tfc.concat4d([a,b],0);default:throw new errors_1.ValueError("concatAlongFirstAxis() received an unsupported tensor rank: "+a.rank)}},exports.tile=tile,exports.randomNormal=function(shape,mean,stddev,dtype,seed){return void 0===mean&&(mean=0),void 0===stddev&&(stddev=1),tfc.randomNormal(shape,mean,stddev,dtype,seed)},exports.dot=function(a,b,activation,bias){if(a.rank<2||b.rank<2)throw new errors_1.NotImplementedError("dot requires both inputs to be rank >= 2 but got x shape = "+a.shape+" and y shape = "+b.shape);if(3<=b.rank&&a.shape.slice(-1)[0]!==(ySecondLastDim=b.shape.slice(-2)[0]))throw new errors_1.NotImplementedError("If rank y >= 3, then the second last dim of y must equal the last dim of x but got x shape = "+a.shape+" and  y shape = "+b.shape);if(2===a.rank&&2===b.rank){var transposeA=!1,transposeB=!1;return tfc.fused.matMul({a:a,b:b,transposeA:transposeA,transposeB:transposeB,bias:bias?reshapeBias(a.rank,bias,common_2.imageDataFormat()):null,activation:activation})}var aFirstDims=a.shape.slice(),aLastDim=aFirstDims.pop();a=a.reshape([-1,aLastDim]);var bShape=b.shape.slice(),bLastDim=bShape.pop(),ySecondLastDim=bShape.pop(),yOtherDims=bShape.concat([bLastDim]),perm=Array.from({length:b.rank},function(_,i){return 0===i?b.rank-2:i<=b.rank-2?i-1:i});b=b.transpose(perm).reshape([ySecondLastDim,-1]);var outputShape=aFirstDims.concat(yOtherDims);return transposeB=transposeA=!1,tfc.fused.matMul({a:a,b:b,transposeA:transposeA,transposeB:transposeB,bias:bias?reshapeBias(a.rank,bias,common_2.imageDataFormat()):null,activation:activation}).reshape(outputShape)},exports.sign=function(x){return tfjs_core_1.tidy(function(){var zerosLikeX=tfjs_core_1.zerosLike(x),onesLikeX=tfjs_core_1.onesLike(x);return tfjs_core_1.where(tfc.equal(x,zerosLikeX),zerosLikeX,tfjs_core_1.where(tfc.greater(x,tfjs_core_1.zerosLike(x)),onesLikeX,tfc.mul(-1,onesLikeX)))})},exports.oneHot=function(indices,numClasses){return tfjs_core_1.tidy(function(){if(1!==indices.rank)throw new Error("Only 1D one-hot tensors are supported in the deeplearn backend, at present.");return indices=indices.toInt(),tfc.oneHot(indices,numClasses).toFloat()})},exports.gather=function(reference,indices,axis){return tfjs_core_1.tidy(function(){return indices=Array.isArray(indices)?tfjs_core_1.tensor1d(indices,"int32"):indices.toInt(),tfc.gather(reference,indices,axis)})},exports.square=function(x){return tfc.mulStrict(x,x)},exports.pow=function(x,a){return tfjs_core_1.tidy(function(){if("number"==typeof a&&(a=tfjs_core_1.scalar(Math.round(a),"int32")),"int32"!==a.dtype)throw new errors_1.NotImplementedError("Non-int32 dtype ("+a.dtype+") is not supported by pow() yet");return tfc.pow(x,a)})},exports.biasAdd=function(x,bias,dataFormat){return tfjs_core_1.tidy(function(){return null==dataFormat&&(dataFormat=common_2.imageDataFormat()),common_1.checkDataFormat(dataFormat),x.add(reshapeBias(x.rank,bias,dataFormat))})},exports.elu=function(x,alpha){if(void 0===alpha&&(alpha=1),1!==alpha)throw new errors_1.NotImplementedError("Support for alpha values other than 1 ("+alpha+") is not implemented yet.");return tfc.elu(x)},exports.softsign=function(x){return tfjs_core_1.tidy(function(){return tfc.div(x,tfc.abs(x).add(1))})},exports.dropout=function(x,level,noiseShape,seed){return tfjs_core_1.tidy(function(){return tfc.dropout(x,level,noiseShape,seed)})},exports.hardSigmoid=function(x){return tfjs_core_1.tidy(function(){var y=tfc.add(.5,tfc.mul(.2,x));return tfc.clipByValue(y,0,1)})},exports.inTrainPhase=function(x,alt,training){return void 0===training&&(training=!1),training?x():alt()}},{"../common":279,"../errors":289,"../utils/math_utils":324,"./common":274,"@tensorflow/tfjs-core":148}],277:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("./errors"),logs_1=require("./logs"),generic_utils=require("./utils/generic_utils");!function(ModelLoggingVerbosity){ModelLoggingVerbosity[ModelLoggingVerbosity.SILENT=0]="SILENT",ModelLoggingVerbosity[ModelLoggingVerbosity.VERBOSE=1]="VERBOSE"}(exports.ModelLoggingVerbosity||(exports.ModelLoggingVerbosity={})),exports.DEFAULT_YIELD_EVERY_MS=125;var BaseCallback=function(){function BaseCallback(){this.validationData=null}return BaseCallback.prototype.setParams=function(params){this.params=params},BaseCallback.prototype.onEpochBegin=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onBatchBegin=function(batch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2]})})},BaseCallback.prototype.setModel=function(model){},BaseCallback}();exports.BaseCallback=BaseCallback;var CallbackList=function(){function CallbackList(callbacks,queueLength){void 0===queueLength&&(queueLength=10),null==callbacks&&(callbacks=[]),this.callbacks=callbacks,this.queueLength=queueLength}return CallbackList.prototype.append=function(callback){this.callbacks.push(callback)},CallbackList.prototype.setParams=function(params){for(var _i=0,_a=this.callbacks;_i<_a.length;_i++){_a[_i].setParams(params)}},CallbackList.prototype.setModel=function(model){for(var _i=0,_a=this.callbacks;_i<_a.length;_i++){_a[_i].setModel(model)}},CallbackList.prototype.onEpochBegin=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onEpochBegin(epoch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onEpochEnd(epoch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onBatchBegin=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onBatchBegin(batch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onBatchEnd(batch,logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onTrainBegin(logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){var _i,_a;return __generator(this,function(_b){switch(_b.label){case 0:null==logs&&(logs={}),_i=0,_a=this.callbacks,_b.label=1;case 1:return _i<_a.length?[4,_a[_i].onTrainEnd(logs)]:[3,4];case 2:_b.sent(),_b.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})},CallbackList}();exports.CallbackList=CallbackList;var BaseLogger=function(_super){function BaseLogger(){return _super.call(this)||this}return __extends(BaseLogger,_super),BaseLogger.prototype.onEpochBegin=function(epoch){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.seen=0,this.totals={},[2]})})},BaseLogger.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var batchSize,_loop_1,this_1,key,_this=this;return __generator(this,function(_a){for(key in null==logs&&(logs={}),batchSize=null==logs.size?0:logs.size,this.seen+=batchSize,_loop_1=function(key){var value=logs[key];if("number"==typeof value)this_1.totals.hasOwnProperty(key)||(this_1.totals[key]=0),this_1.totals[key]=this_1.totals[key]+value*batchSize;else{var oldTotalsToDispose=void 0;key in this_1.totals?oldTotalsToDispose=this_1.totals[key]:this_1.totals[key]=0,this_1.totals[key]=tfjs_core_1.tidy(function(){return tfjs_core_1.add(_this.totals[key],tfjs_core_1.mul(value,batchSize))}),null!=oldTotalsToDispose&&oldTotalsToDispose.dispose()}},this_1=this,logs)_loop_1(key);return[2]})})},BaseLogger.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var _loop_2,this_2,_i,_a,key,_this=this;return __generator(this,function(_b){if(null!=logs)for(_loop_2=function(key){if(null==this_2.totals[key])return"continue";"number"==typeof this_2.totals[key]?logs[key]=this_2.totals[key]/this_2.seen:tfjs_core_1.tidy(function(){logs[key]=tfjs_core_1.mul(tfjs_core_1.div(1,_this.seen),_this.totals[key]),_this.totals[key].dispose(),tfjs_core_1.keep(logs[key])})},_i=0,_a=(this_2=this).params.metrics;_i<_a.length;_i++)key=_a[_i],_loop_2(key);return[2]})})},BaseLogger}(BaseCallback);exports.BaseLogger=BaseLogger;var History=function(_super){function History(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(History,_super),History.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.epoch=[],this.history={},[2]})})},History.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var key;return __generator(this,function(_a){for(key in null==logs&&(logs={}),this.epoch.push(epoch),logs)null==this.history[key]&&(this.history[key]=[]),this.history[key].push(logs[key]);return[2]})})},History.prototype.syncData=function(){return __awaiter(this,void 0,void 0,function(){var promises,keys,indices,key,valueArray,i,valueScalar,values,n;return __generator(this,function(_a){switch(_a.label){case 0:for(key in promises=[],keys=[],indices=[],this.history)for(valueArray=this.history[key],i=0;i<valueArray.length;++i)"number"!=typeof valueArray[i]&&(valueScalar=valueArray[i],promises.push(valueScalar.data()),keys.push(key),indices.push(i));return[4,Promise.all(promises)];case 1:for(values=_a.sent(),n=0;n<values.length;++n)this.history[keys[n]][indices[n]].dispose(),this.history[keys[n]][indices[n]]=values[n][0];return[2]}})})},History}(BaseCallback);exports.History=History;var CustomCallback=function(_super){function CustomCallback(args,yieldEvery){var _this=_super.call(this)||this;if(_this.currentEpoch=0,_this.yieldEvery=yieldEvery||"auto","auto"===_this.yieldEvery&&(_this.yieldEvery=exports.DEFAULT_YIELD_EVERY_MS),"never"===_this.yieldEvery&&null!=args.onYield)throw new Error("yieldEvery is `never` but you provided an `onYield` callback. Either change `yieldEvery` or remove the callback");return tfjs_core_1.util.isNumber(_this.yieldEvery)&&(_this.maybeWait=generic_utils.debounce(_this.maybeWait.bind(_this),_this.yieldEvery)),_this.trainBegin=args.onTrainBegin,_this.trainEnd=args.onTrainEnd,_this.epochBegin=args.onEpochBegin,_this.epochEnd=args.onEpochEnd,_this.batchBegin=args.onBatchBegin,_this.batchEnd=args.onBatchEnd,_this.yield=args.onYield,_this}return __extends(CustomCallback,_super),CustomCallback.prototype.maybeWait=function(epoch,batch,logs){return __awaiter(this,void 0,void 0,function(){var ps;return __generator(this,function(_a){switch(_a.label){case 0:return ps=[],null==this.yield?[3,2]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:_a.sent(),ps.push(this.yield(epoch,batch,logs)),_a.label=2;case 2:return ps.push(tfjs_core_1.nextFrame()),[4,Promise.all(ps)];case 3:return _a.sent(),[2]}})})},CustomCallback.prototype.onEpochBegin=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.currentEpoch=epoch,null==this.epochBegin?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.epochBegin(epoch,logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var ps;return __generator(this,function(_a){switch(_a.label){case 0:return ps=[],null==this.epochEnd?[3,2]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:_a.sent(),ps.push(this.epochEnd(epoch,logs)),_a.label=2;case 2:return"epoch"===this.yieldEvery&&ps.push(tfjs_core_1.nextFrame()),[4,Promise.all(ps)];case 3:return _a.sent(),[2]}})})},CustomCallback.prototype.onBatchBegin=function(batch,logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return null==this.batchBegin?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.batchBegin(batch,logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback.prototype.onBatchEnd=function(batch,logs){return __awaiter(this,void 0,void 0,function(){var ps;return __generator(this,function(_a){switch(_a.label){case 0:return ps=[],null==this.batchEnd?[3,2]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:_a.sent(),ps.push(this.batchEnd(batch,logs)),_a.label=2;case 2:return"batch"===this.yieldEvery?ps.push(tfjs_core_1.nextFrame()):tfjs_core_1.util.isNumber(this.yieldEvery)&&ps.push(this.maybeWait(this.currentEpoch,batch,logs)),[4,Promise.all(ps)];case 3:return _a.sent(),[2]}})})},CustomCallback.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return null==this.trainBegin?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.trainBegin(logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return null==this.trainEnd?[3,3]:[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),[4,this.trainEnd(logs)];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})},CustomCallback}(BaseCallback);exports.CustomCallback=CustomCallback,exports.standardizeCallbacks=function(callbacks,yieldEvery){return null==callbacks&&(callbacks={}),callbacks instanceof BaseCallback?[callbacks]:Array.isArray(callbacks)&&callbacks[0]instanceof BaseCallback?callbacks:generic_utils.toList(callbacks).map(function(callbackConfig){return new CustomCallback(callbackConfig,yieldEvery)})};var CallbackConstructorRegistry=function(){function CallbackConstructorRegistry(){}return CallbackConstructorRegistry.registerCallbackConstructor=function(verbosityLevel,callbackConstructor){tfjs_core_1.util.assert(0<=verbosityLevel&&Number.isInteger(verbosityLevel),function(){return"Verbosity level is expected to be an integer >= 0, but got "+verbosityLevel}),CallbackConstructorRegistry.checkForDuplicate(callbackConstructor),null==CallbackConstructorRegistry.constructors[verbosityLevel]&&(CallbackConstructorRegistry.constructors[verbosityLevel]=[]),CallbackConstructorRegistry.constructors[verbosityLevel].push(callbackConstructor)},CallbackConstructorRegistry.checkForDuplicate=function(callbackConstructor){for(var levelName in CallbackConstructorRegistry.constructors){CallbackConstructorRegistry.constructors[+levelName].forEach(function(ctor){if(ctor===callbackConstructor)throw new errors_1.ValueError("Duplicate callback constructor.")})}},CallbackConstructorRegistry.clear=function(){CallbackConstructorRegistry.constructors={}},CallbackConstructorRegistry.createCallbacks=function(verbosityLevel){var constructors=[];for(var levelName in CallbackConstructorRegistry.constructors){var level=+levelName;level<=verbosityLevel&&constructors.push.apply(constructors,CallbackConstructorRegistry.constructors[level])}return constructors.map(function(ctor){return new ctor})},CallbackConstructorRegistry.constructors={},CallbackConstructorRegistry}();exports.CallbackConstructorRegistry=CallbackConstructorRegistry,exports.configureCallbacks=function(callbacks,verbose,epochs,initialEpoch,numTrainSamples,stepsPerEpoch,batchSize,doValidation,callbackMetrics){var history=new History,actualCallbacks=[new BaseLogger].concat(CallbackConstructorRegistry.createCallbacks(verbose));null!=callbacks&&actualCallbacks.push.apply(actualCallbacks,callbacks),actualCallbacks.push(history);var callbackList=new CallbackList(actualCallbacks);return callbackList.setParams({epochs:epochs,initialEpoch:initialEpoch,samples:numTrainSamples,steps:stepsPerEpoch,batchSize:batchSize,verbose:verbose,doValidation:doValidation,metrics:callbackMetrics}),{callbackList:callbackList,history:history}}},{"./errors":289,"./logs":314,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],278:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var base_callbacks_1=require("./base_callbacks"),training_1=require("./engine/training"),errors_1=require("./errors"),logs_1=require("./logs"),Callback=function(_super){function Callback(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.model=null,_this}return __extends(Callback,_super),Callback.prototype.setModel=function(model){if(!(model instanceof training_1.LayersModel))throw new Error("model must be a LayersModel, not some other Container");this.model=model},Callback}(base_callbacks_1.BaseCallback);function less(currVal,prevVal){return currVal<prevVal}function greater(currVal,prevVal){return prevVal<currVal}var EarlyStopping=function(_super){function EarlyStopping(args){var _this=_super.call(this)||this;if(null==args&&(args={}),args.restoreBestWeights)throw new errors_1.NotImplementedError("restoreBestWeights = True is not implemented in EarlyStopping yet.");return _this.monitor=args.monitor||"val_loss",_this.minDelta=Math.abs(args.minDelta||0),_this.patience=args.patience||0,_this.verbose=args.verbose||0,_this.mode=args.mode||"auto",_this.baseline=args.baseline,-1===["auto","min","max"].indexOf(_this.mode)&&(console.warn("EarlyStopping mode '"+_this.mode+"' is invalid. Falling back to mode 'auto'."),_this.mode="auto"),"min"===_this.mode?_this.monitorFunc=less:"max"===_this.mode?_this.monitorFunc=greater:-1!==_this.monitor.indexOf("acc")?_this.monitorFunc=greater:_this.monitorFunc=less,_this.monitorFunc===less&&(_this.minDelta*=-1),_this}return __extends(EarlyStopping,_super),EarlyStopping.prototype.onTrainBegin=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.wait=0,this.stoppedEpoch=0,null!=this.baseline?this.best=this.baseline:this.best=this.monitorFunc===less?1/0:-1/0,[2]})})},EarlyStopping.prototype.onEpochEnd=function(epoch,logs){return __awaiter(this,void 0,void 0,function(){var current;return __generator(this,function(_a){switch(_a.label){case 0:return[4,logs_1.resolveScalarsInLogs(logs)];case 1:return _a.sent(),null==(current=this.getMonitorValue(logs))?[2]:(this.monitorFunc(current-this.minDelta,this.best)?(this.best=current,this.wait=0):(this.wait++,this.wait>=this.patience&&(this.stoppedEpoch=epoch,this.model.stopTraining=!0)),[2])}})})},EarlyStopping.prototype.onTrainEnd=function(logs){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return 0<this.stoppedEpoch&&this.verbose&&console.log("Epoch "+this.stoppedEpoch+": early stopping."),[2]})})},EarlyStopping.prototype.getMonitorValue=function(logs){null==logs&&(logs={});var monitorValue=logs[this.monitor];return null==monitorValue&&console.warn("Metric for EarlyStopping "+this.monitor+" is not available. Available metrics are: "+Object.keys(logs)),monitorValue},EarlyStopping}(exports.Callback=Callback);function earlyStopping(args){return new EarlyStopping(args)}exports.EarlyStopping=EarlyStopping,exports.earlyStopping=earlyStopping,exports.callbacks={earlyStopping:earlyStopping}},{"./base_callbacks":277,"./engine/training":285,"./errors":289,"./logs":314}],279:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("./keras_format/common"),generic_utils_1=require("./utils/generic_utils"),nameMap=new Map;exports.checkDataFormat=function(value){generic_utils_1.checkStringTypeUnionValue(common_1.VALID_DATA_FORMAT_VALUES,"DataFormat",value)},exports.checkPaddingMode=function(value){generic_utils_1.checkStringTypeUnionValue(common_1.VALID_PADDING_MODE_VALUES,"PaddingMode",value)},exports.checkPoolMode=function(value){generic_utils_1.checkStringTypeUnionValue(common_1.VALID_POOL_MODE_VALUES,"PoolMode",value)};var _nameScopeStack=[],_nameScopeDivider="/";exports.nameScope=function(name,fn){_nameScopeStack.push(name);try{var val=fn();return _nameScopeStack.pop(),val}catch(e){throw _nameScopeStack.pop(),e}},exports.getScopedTensorName=function(tensorName){if(!isValidTensorName(tensorName))throw new Error("Not a valid tensor name: '"+tensorName+"'");return(0===_nameScopeStack.length?"":_nameScopeStack.join(_nameScopeDivider)+_nameScopeDivider)+tensorName},exports.getUniqueTensorName=function(scopedName){if(!isValidTensorName(scopedName))throw new Error("Not a valid tensor name: '"+scopedName+"'");nameMap.has(scopedName)||nameMap.set(scopedName,0);var index=nameMap.get(scopedName);if(nameMap.set(scopedName,nameMap.get(scopedName)+1),0<index){var result=scopedName+"_"+index;return nameMap.set(result,1),result}return scopedName};var tensorNameRegex=new RegExp(/^[A-Za-z0-9][-A-Za-z0-9\._\/]*$/);function isValidTensorName(name){return!!name.match(tensorNameRegex)}exports.isValidTensorName=isValidTensorName},{"./keras_format/common":299,"./utils/generic_utils":322}],280:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("./backend/common"),generic_utils_1=require("./utils/generic_utils");function calcL2Norms(w,axis){return tfjs_core_1.tidy(function(){return tfc.sqrt(tfc.sum(tfc.mulStrict(w,w),axis,!0))})}var Constraint=function(_super){function Constraint(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Constraint,_super),Constraint.prototype.getConfig=function(){return{}},Constraint}(tfjs_core_1.serialization.Serializable),MaxNorm=function(_super){function MaxNorm(args){var _this=_super.call(this)||this;return _this.defaultMaxValue=2,_this.defaultAxis=0,_this.maxValue=null!=args.maxValue?args.maxValue:_this.defaultMaxValue,_this.axis=null!=args.axis?args.axis:_this.defaultAxis,_this}return __extends(MaxNorm,_super),MaxNorm.prototype.apply=function(w){var _this=this;return tfjs_core_1.tidy(function(){var norms=calcL2Norms(w,_this.axis),desired=tfc.clipByValue(norms,0,_this.maxValue);return tfc.mul(w,tfc.div(desired,tfc.add(common_1.epsilon(),norms)))})},MaxNorm.prototype.getConfig=function(){return{maxValue:this.maxValue,axis:this.axis}},MaxNorm.className="MaxNorm",MaxNorm}(exports.Constraint=Constraint);exports.MaxNorm=MaxNorm,tfjs_core_1.serialization.registerClass(MaxNorm);var UnitNorm=function(_super){function UnitNorm(args){var _this=_super.call(this)||this;return _this.defaultAxis=0,_this.axis=null!=args.axis?args.axis:_this.defaultAxis,_this}return __extends(UnitNorm,_super),UnitNorm.prototype.apply=function(w){var _this=this;return tfjs_core_1.tidy(function(){return tfc.div(w,tfc.add(common_1.epsilon(),calcL2Norms(w,_this.axis)))})},UnitNorm.prototype.getConfig=function(){return{axis:this.axis}},UnitNorm.className="UnitNorm",UnitNorm}(Constraint);exports.UnitNorm=UnitNorm,tfjs_core_1.serialization.registerClass(UnitNorm);var NonNeg=function(_super){function NonNeg(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(NonNeg,_super),NonNeg.prototype.apply=function(w){return tfc.relu(w)},NonNeg.className="NonNeg",NonNeg}(Constraint);exports.NonNeg=NonNeg,tfjs_core_1.serialization.registerClass(NonNeg);var MinMaxNorm=function(_super){function MinMaxNorm(args){var _this=_super.call(this)||this;return _this.defaultMinValue=0,_this.defaultMaxValue=1,_this.defaultRate=1,_this.defaultAxis=0,_this.minValue=null!=args.minValue?args.minValue:_this.defaultMinValue,_this.maxValue=null!=args.maxValue?args.maxValue:_this.defaultMaxValue,_this.rate=null!=args.rate?args.rate:_this.defaultRate,_this.axis=null!=args.axis?args.axis:_this.defaultAxis,_this}return __extends(MinMaxNorm,_super),MinMaxNorm.prototype.apply=function(w){var _this=this;return tfjs_core_1.tidy(function(){var norms=calcL2Norms(w,_this.axis),desired=tfc.add(tfc.mul(_this.rate,tfc.clipByValue(norms,_this.minValue,_this.maxValue)),tfc.mul(1-_this.rate,norms));return tfc.mul(w,tfc.div(desired,tfc.add(common_1.epsilon(),norms)))})},MinMaxNorm.prototype.getConfig=function(){return{minValue:this.minValue,maxValue:this.maxValue,rate:this.rate,axis:this.axis}},MinMaxNorm.className="MinMaxNorm",MinMaxNorm}(Constraint);function deserializeConstraint(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"constraint")}exports.MinMaxNorm=MinMaxNorm,tfjs_core_1.serialization.registerClass(MinMaxNorm),exports.CONSTRAINT_IDENTIFIER_REGISTRY_SYMBOL_MAP={maxNorm:"MaxNorm",minMaxNorm:"MinMaxNorm",nonNeg:"NonNeg",unitNorm:"UnitNorm"},exports.serializeConstraint=function(constraint){return generic_utils_1.serializeKerasObject(constraint)},exports.deserializeConstraint=deserializeConstraint,exports.getConstraint=function(identifier){return null==identifier?null:"string"!=typeof identifier?identifier instanceof Constraint?identifier:deserializeConstraint(identifier):deserializeConstraint({className:identifier in exports.CONSTRAINT_IDENTIFIER_REGISTRY_SYMBOL_MAP?exports.CONSTRAINT_IDENTIFIER_REGISTRY_SYMBOL_MAP[identifier]:identifier,config:{}})}},{"./backend/common":274,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],281:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("../backend/state"),errors_1=require("../errors"),serialization_1=require("../layers/serialization"),generic_utils=require("../utils/generic_utils"),serialization_utils_1=require("../utils/serialization_utils"),types_utils=require("../utils/types_utils"),variables_1=require("../variables"),version_1=require("../version"),executor_1=require("./executor"),input_layer_1=require("./input_layer"),topology_1=require("./topology"),Container=function(_super){function Container(args){var _this=_super.call(this,{})||this;if(_this.containerNodes=new Set,_this.name=args.name,null==_this.name){var prefix=_this.getClassName().toLowerCase();_this.name=state_1.getUid(prefix)}if(_this.supportsMasking=!1,_this.trainable_=!0,Array.isArray(args.inputs)?_this.inputs=args.inputs.slice():_this.inputs=[args.inputs],Array.isArray(args.outputs)?_this.outputs=args.outputs.slice():_this.outputs=[args.outputs],generic_utils.unique(_this.inputs).length!==_this.inputs.length)throw new errors_1.ValueError("The list of inputs passed to the model is redundant. All inputs should only appear once. Found: "+_this.inputs.map(function(x){return x.name}));generic_utils.unique(_this.outputs).length!==_this.outputs.length&&console.warn("The list of outputs passed to the model is redundant. All outputs should only appear once. Found: "+_this.outputs.map(function(x){return x.name})),_this.inputLayers=[],_this.inputLayersNodeIndices=[],_this.inputLayersTensorIndices=[],_this.outputLayers=[],_this.outputLayersNodeIndices=[],_this.outputLayersTensorIndices=[],_this.layers=[];for(var _i=0,_a=_this.outputs;_i<_a.length;_i++){var layer=(x=_a[_i]).sourceLayer,nodeIndex=x.nodeIndex,tensorIndex=x.tensorIndex;_this.outputLayers.push(layer),_this.outputLayersNodeIndices.push(nodeIndex),_this.outputLayersTensorIndices.push(tensorIndex)}for(var _b=0,_c=_this.inputs;_b<_c.length;_b++){layer=(x=_c[_b]).sourceLayer,nodeIndex=x.nodeIndex,tensorIndex=x.tensorIndex;generic_utils.assert(0===nodeIndex,"input layer has >1 nodes"),generic_utils.assert(0===tensorIndex,"input layer has >1 tensors"),_this.inputLayers.push(layer),_this.inputLayersNodeIndices.push(nodeIndex),_this.inputLayersTensorIndices.push(tensorIndex)}_this.inputNames=[],_this.outputNames=[],_this.feedInputShapes=[],_this.feedInputNames=[],_this.feedOutputNames=[];for(var i=0;i<_this.inputLayers.length;i++){if(!((layer=_this.inputLayers[i])instanceof input_layer_1.InputLayer))throw new TypeError("Input layers to a LayersModel must be InputLayer objects. Received inputs: "+args.inputs+". Input "+i+" (0-based) originates from layer type "+layer.getClassName()+".");_this.inputNames.push(layer.name),_this.feedInputShapes.push(layer.batchInputShape),_this.feedInputNames.push(layer.name)}for(var _d=0,_e=_this.outputLayers;_d<_e.length;_d++){layer=_e[_d];_this.outputNames.push(layer.name)}_this.internalInputShapes=_this.inputs.map(function(x){return x.shape}),_this.internalOutputShapes=_this.outputs.map(function(x){return x.shape});for(var nodesDepths={},nodeIDToNode={},layersDepths={},layerIDToLayer={},layerIndices={},nodesInDecreasingDepth=[],buildMapOfGraph=function(tensor,finishedNodes,nodesInProgress,layer,nodeIndex,tensorIndex){null!=layer&&null!=nodeIndex&&null!=tensorIndex||(layer=tensor.sourceLayer,nodeIndex=tensor.nodeIndex,tensorIndex=tensor.tensorIndex);var node=layer.inboundNodes[nodeIndex];if(-1!==nodesInProgress.indexOf(node))throw new errors_1.RuntimeError("The tensor "+tensor.name+' at layer "'+layer.name+'" is part of a cycle.');if(-1===finishedNodes.indexOf(node)){_this.containerNodes.add(Container.nodeKey(layer,nodeIndex)),layer.id in layerIndices||(layerIndices[layer.id]=Object.keys(layerIndices).length),-1===nodesInProgress.indexOf(node)&&nodesInProgress.push(node);for(var numInboundLayers=node.inboundLayers.length,i=0;i<numInboundLayers;i++){var x=node.inputTensors[i],layer_1=node.inboundLayers[i],nodeIndex_1=node.nodeIndices[i],tensorIndex_1=node.tensorIndices[i];buildMapOfGraph(x,finishedNodes,nodesInProgress,layer_1,nodeIndex_1,tensorIndex_1)}for(finishedNodes.push(node);0<=nodesInProgress.indexOf(node);)nodesInProgress.splice(nodesInProgress.indexOf(node),1);nodesInDecreasingDepth.push(node)}},finishedNodes=[],nodesInProgress=[],_f=0,_g=_this.outputs;_f<_g.length;_f++){var x=_g[_f];buildMapOfGraph(x,finishedNodes,nodesInProgress)}for(var _h=0,reversedNodesInDecreasingDepth_1=nodesInDecreasingDepth.slice().reverse();_h<reversedNodesInDecreasingDepth_1.length;_h++){(nodeIDToNode[(node=reversedNodesInDecreasingDepth_1[_h]).id]=node).id in nodesDepths||(nodesDepths[node.id]=0);var depth=nodesDepths[node.id],previousDepth=null==layersDepths[node.outboundLayer.id]?0:layersDepths[node.outboundLayer.id];depth=Math.max(depth,previousDepth),layersDepths[node.outboundLayer.id]=depth,layerIDToLayer[node.outboundLayer.id]=node.outboundLayer,nodesDepths[node.id]=depth;for(i=0;i<node.inboundLayers.length;i++){var inboundLayer=node.inboundLayers[i],inboundNode=(nodeIndex=node.nodeIndices[i],inboundLayer.inboundNodes[nodeIndex]),previousDepth_1=null==nodesDepths[inboundNode.id]?0:nodesDepths[inboundNode.id];nodesDepths[inboundNode.id]=Math.max(depth+1,previousDepth_1),nodeIDToNode[inboundNode.id]=inboundNode}}var nodesByDepth={};for(var nodeID in nodesDepths){(depth=nodesDepths[nodeID])in nodesByDepth||(nodesByDepth[depth]=[]),nodesByDepth[depth].push(nodeIDToNode[nodeID])}var layersByDepth={};for(var layerID in layersDepths){(depth=layersDepths[layerID])in layersByDepth||(layersByDepth[depth]=[]),layersByDepth[depth].push(layerIDToLayer[layerID])}var depthKeys=Object.keys(layersByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);_this.layers=[];for(var _j=0,depthKeys_1=depthKeys;_j<depthKeys_1.length;_j++){var layersForDepth=layersByDepth[depth=depthKeys_1[_j]];layersForDepth.sort(function(a,b){var aIndex=layerIndices[a.id],bIndex=layerIndices[b.id];return aIndex<bIndex?-1:bIndex<aIndex?1:0});for(var _k=0,layersForDepth_1=layersForDepth;_k<layersForDepth_1.length;_k++){layer=layersForDepth_1[_k];_this.layers.push(layer)}}_this.layersByDepth=layersByDepth,depthKeys=Object.keys(nodesByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);for(var computableTensors=_this.inputs.slice(),layersWithCompleteInput=[],_l=0,depthKeys_2=depthKeys;_l<depthKeys_2.length;_l++)for(var _m=0,_o=nodesByDepth[depth=depthKeys_2[_l]];_m<_o.length;_m++){var node;if(null!=(layer=(node=_o[_m]).outboundLayer)){for(var _p=0,_q=node.inputTensors;_p<_q.length;_p++){x=_q[_p];if(-1===computableTensors.indexOf(x))throw new errors_1.RuntimeError("Graph disconnected: cannot obtain value for tensor "+x+' at layer "'+layer.name+'". The following previous layers were accessed without issue: '+layersWithCompleteInput)}for(var _r=0,_s=node.outputTensors;_r<_s.length;_r++){x=_s[_r];computableTensors.push(x)}layersWithCompleteInput.push(layer.name)}}_this.nodesByDepth=nodesByDepth;for(var allNames=_this.layers.map(function(x){return x.name}),_loop_1=function(name_1){var numOccurrences=allNames.filter(function(x){return x===name_1}).length;if(1!==numOccurrences)throw new errors_1.RuntimeError('The name "'+name_1+'" is used '+numOccurrences+" times in the model. All layer names should be unique. Layer names: "+JSON.stringify(allNames))},_t=0,allNames_1=allNames;_t<allNames_1.length;_t++){_loop_1(allNames_1[_t])}return _this.outboundNodes=[],_this.inboundNodes=[],new topology_1.Node({outboundLayer:_this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:_this.inputs,outputTensors:_this.outputs,inputMasks:_this.inputs.map(function(x){return null}),outputMasks:_this.outputs.map(function(x){return null}),inputShapes:_this.inputs.map(function(x){return x.shape}),outputShapes:_this.outputs.map(function(x){return x.shape})}),_this.built=!0,_this._refCount=1,_this}return __extends(Container,_super),Container.prototype.assertNotDisposed=function(){if(0===this._refCount)throw new Error("Container '"+this.name+"' is already disposed.")},Container.prototype.dispose=function(){this.assertNotDisposed();var result={refCountAfterDispose:null,numDisposedVariables:0};if(0==--this._refCount)for(var _i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];result.numDisposedVariables+=layer.dispose().numDisposedVariables}return result.refCountAfterDispose=this._refCount,result},Object.defineProperty(Container.prototype,"trainable",{get:function(){return this.trainable_},set:function(trainable){this.layers.forEach(function(layer){layer._trainableWeights.forEach(function(w){return w.trainable=trainable})}),this.trainable_=trainable},enumerable:!0,configurable:!0}),Object.defineProperty(Container.prototype,"trainableWeights",{get:function(){if(0<this._trainableWeights.length)throw new errors_1.ValueError("Container instance unexpectedly contains _trainableWeights.The trainable weights of a Container are a union of the trainable weights of its consituent Layers. Its own _trainableWeights must remain an empty Array.");if(!this.trainable)return[];for(var weights=[],_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];weights=weights.concat(layer.trainableWeights)}return weights},enumerable:!0,configurable:!0}),Object.defineProperty(Container.prototype,"nonTrainableWeights",{get:function(){for(var weights=[],_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];weights.push.apply(weights,layer.nonTrainableWeights)}if(this.trainable)return weights;for(var trainableWeights=[],_b=0,_c=this.layers;_b<_c.length;_b++){layer=_c[_b];trainableWeights.push.apply(trainableWeights,layer.trainableWeights)}return trainableWeights.concat(weights)},enumerable:!0,configurable:!0}),Object.defineProperty(Container.prototype,"weights",{get:function(){return this.trainableWeights.concat(this.nonTrainableWeights)},enumerable:!0,configurable:!0}),Container.prototype.loadWeights=function(weights,strict){void 0===strict&&(strict=!0);for(var nameToWeight={},totalWeightsCount=0,_i=0,_a=this.layers;_i<_a.length;_i++)for(var _b=0,_c=_a[_i].weights;_b<_c.length;_b++){var weight=_c[_b];if(null!=nameToWeight[weight.originalName])throw new errors_1.ValueError("Duplicate weight name: "+weight.originalName);nameToWeight[weight.originalName]=weight,totalWeightsCount++}var weightValueTuples=[];for(var name_2 in weights){if(null!=nameToWeight[name_2])weightValueTuples.push([nameToWeight[name_2],weights[name_2]]);else if(strict)throw new errors_1.ValueError("Provided weight data has no target variable: "+name_2);delete nameToWeight[name_2]}if(strict){var unsetNames=[];for(var name_3 in nameToWeight)unsetNames.push(name_3);if(0<unsetNames.length)throw new errors_1.ValueError(unsetNames.length+" of "+totalWeightsCount+" weights are not set: "+unsetNames)}variables_1.batchSetValue(weightValueTuples)},Container.prototype.updatedConfig=function(){var theConfig=this.getConfig(),modelConfig={};return modelConfig.className=this.getClassName(),modelConfig.config=theConfig,modelConfig.kerasVersion="tfjs-layers "+version_1.version,modelConfig.backend="TensorFlow.js",modelConfig},Container.prototype.toJSON=function(unused,returnString){void 0===returnString&&(returnString=!0);var modelConfig=serialization_utils_1.convertTsToPythonic(this.updatedConfig());return returnString?JSON.stringify(modelConfig):modelConfig},Container.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){inputs=generic_utils.toList(inputs);for(var feedDict=new executor_1.FeedDict,i=0;i<_this.inputs.length;++i)feedDict.add(_this.inputs[i],inputs[i]);return executor_1.execute(_this.outputs,feedDict,kwargs)})},Container.prototype.computeMask=function(inputs,mask){var _this=this;return tfjs_core_1.tidy(function(){var masks;return inputs=generic_utils.toList(inputs),masks=null==mask?generic_utils.pyListRepeat(null,inputs.length):generic_utils.toList(mask),_this.runInternalGraph(inputs,masks)[1]})},Container.prototype.computeOutputShape=function(inputShape){var inputShapes=types_utils.normalizeShapeList(inputShape);if(inputShapes.length!==this.inputLayers.length)throw new errors_1.ValueError("Invalid inputShape argument "+inputShape+": model has "+this.inputLayers.length+" tensor inputs.");for(var layersToOutputShapes={},i=0;i<inputShapes.length;i++){var layer=this.inputLayers[i],inputShape_1=inputShapes[i];layersToOutputShapes[shapeKey=layer.name+"_0_0"]=inputShape_1}var depthKeys=Object.keys(this.nodesByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);if(1<depthKeys.length)for(var _i=0,depthKeys_3=depthKeys;_i<depthKeys_3.length;_i++)for(var depth=depthKeys_3[_i],_a=0,nodes_1=this.nodesByDepth[depth];_a<nodes_1.length;_a++){var node=nodes_1[_a];layer=node.outboundLayer;if(-1===this.inputLayers.map(function(x){return x.id}).indexOf(layer.id)){for(var inputShapes_1=[],j=0;j<node.inboundLayers.length;j++){var inboundLayer=node.inboundLayers[j],nodeIndex_2=node.nodeIndices[j],tensorIndex=node.tensorIndices[j],inputShape_2=layersToOutputShapes[shapeKey=inboundLayer.name+"_"+nodeIndex_2+"_"+tensorIndex];inputShapes_1.push(inputShape_2)}var outputShape=layer.computeOutputShape(generic_utils.singletonOrArray(inputShapes_1)),outputShapes_1=types_utils.normalizeShapeList(outputShape),nodeIndex=layer.inboundNodes.indexOf(node);for(j=0;j<outputShapes_1.length;j++){layersToOutputShapes[shapeKey=layer.name+"_"+nodeIndex+"_"+j]=outputShapes_1[j]}}}var outputShapes=[],outputShapeKeys=[];for(i=0;i<this.outputLayers.length;i++){layer=this.outputLayers[i],nodeIndex=this.outputLayersNodeIndices[i],tensorIndex=this.outputLayersTensorIndices[i];var shapeKey=layer.name+"_"+nodeIndex+"_"+tensorIndex;outputShapeKeys.push(shapeKey)}for(i=0;i<outputShapeKeys.length;i++){var key=outputShapeKeys[i];generic_utils.assert(key in layersToOutputShapes),outputShapes.push(layersToOutputShapes[key])}return generic_utils.singletonOrArray(outputShapes)},Container.prototype.runInternalGraph=function(inputs,masks){null==masks&&(masks=generic_utils.pyListRepeat(null,inputs.length));for(var tensorMap={},i=0;i<this.inputs.length;++i){var x=this.inputs[i],y=inputs[i],mask=masks[i];tensorMap[x.id]=[y,mask]}for(var _i=0,depthKeys_4=Object.keys(this.nodesByDepth).map(function(x){return parseInt(x,10)}).sort(generic_utils.reverseNumberCompare);_i<depthKeys_4.length;_i++)for(var depth=depthKeys_4[_i],_a=0,nodes_2=this.nodesByDepth[depth];_a<nodes_2.length;_a++){for(var node=nodes_2[_a],layer=node.outboundLayer,referenceInputTensors=node.inputTensors,referenceOutputTensors=node.outputTensors,computedData=new Array,_b=0,referenceInputTensors_1=referenceInputTensors;_b<referenceInputTensors_1.length;_b++){(x=referenceInputTensors_1[_b]).id in tensorMap&&computedData.push(tensorMap[x.id])}if(computedData.length===referenceInputTensors.length){var kwargs={},computedTensors=void 0,computedMasks=void 0,outputTensors_1=void 0,outputMasks_1=void 0;if(null!=node.callArgs&&(kwargs=node.callArgs),1===computedData.length){var _c=computedData[0],computedTensor=_c[0],computedMask=_c[1];null==kwargs.mask&&(kwargs.mask=computedMask),outputTensors_1=generic_utils.toList(layer.call(computedTensor,kwargs)),outputMasks_1=generic_utils.toList(layer.computeMask(computedTensor,computedMask)),computedTensors=[computedTensor],computedMasks=[computedMask]}else computedTensors=computedData.map(function(x){return x[0]}),computedMasks=computedData.map(function(x){return x[1]}),null==kwargs.mask&&(kwargs.mask=computedMasks),outputTensors_1=generic_utils.toList(layer.call(computedTensors,kwargs)),outputMasks_1=generic_utils.toList(layer.computeMask(computedTensors,computedMasks));if(layer.activityRegularizer)throw new errors_1.NotImplementedError("LayersModel invocation with concrete Tensor value(s) in the presence of activity regularizer(s) is not supported yet.");for(i=0;i<referenceOutputTensors.length;++i){x=referenceOutputTensors[i],y=outputTensors_1[i],mask=outputMasks_1[i];tensorMap[x.id]=[y,mask]}}}for(var outputTensors=[],outputMasks=[],outputShapes=[],_d=0,_e=this.outputs;_d<_e.length;_d++){x=_e[_d];generic_utils.assert(x.id in tensorMap,"Could not compute output "+x.name+" : "+x.id);var _f=tensorMap[x.id],tensor=_f[0];mask=_f[1];outputShapes.push(tensor.shape),outputTensors.push(tensor),outputMasks.push(mask)}return[outputTensors,outputMasks,outputShapes]},Container.prototype.buildNodeConversionMap=function(layers){for(var keptNodes,nodeConversionMap={},_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];keptNodes=layer instanceof Container?1:0;for(var originalNodeIndex=0;originalNodeIndex<layer.inboundNodes.length;originalNodeIndex++){var nodeKey=Container.nodeKey(layer,originalNodeIndex);this.containerNodes.has(nodeKey)&&(nodeConversionMap[nodeKey]=keptNodes,keptNodes+=1)}}return nodeConversionMap},Container.prototype.getLayer=function(name,index){if(null!=index){if(this.layers.length<=index)throw new errors_1.ValueError("Was asked to retrieve layer at index "+index+", but model only has "+this.layers.length+" layer(s).");return this.layers[index]}if(null==name)throw new errors_1.ValueError("Provide either a layer name or layer index");for(var _i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i];if(layer.name===name)return layer}throw new errors_1.ValueError("No such layer: "+name)},Container.prototype.calculateLosses=function(){var _this=this;return tfjs_core_1.tidy(function(){for(var losses=[],_i=0,_a=_this.layers;_i<_a.length;_i++)for(var layer=_a[_i],nodeIndex=0;nodeIndex<layer.inboundNodes.length;++nodeIndex){var nodeKey=Container.nodeKey(layer,nodeIndex);_this.containerNodes.has(nodeKey)&&losses.push.apply(losses,layer.calculateLosses())}return losses})},Container.prototype.getConfig=function(){for(var config={name:this.name},nodeConversionMap=this.buildNodeConversionMap(this.layers),layerConfigs=[],_i=0,_a=this.layers;_i<_a.length;_i++){for(var layerClassName=(layer=_a[_i]).getClassName(),layerConfig=layer.getConfig(),filteredInboundNodes=[],originalNodeIndex=0;originalNodeIndex<layer.inboundNodes.length;originalNodeIndex++){var node=layer.inboundNodes[originalNodeIndex],nodeKey=Container.nodeKey(layer,originalNodeIndex),kwargs={};if(this.containerNodes.has(nodeKey)){if(node.callArgs)try{JSON.stringify(node.callArgs),kwargs=node.callArgs}catch(err){console.warn("Layer "+layer.name+" was passed non-serializable keyword arguments: "+node.callArgs+". They will not be included in the serialized model (and thus will be missing at deserialization time)."),kwargs={}}if(0<node.inboundLayers.length){for(var nodeData=[],i=0;i<node.inboundLayers.length;i++){var inboundLayer=node.inboundLayers[i],nodeIndex=node.nodeIndices[i],tensorIndex=node.tensorIndices[i];null==(newNodeIndex=nodeConversionMap[Container.nodeKey(inboundLayer,nodeIndex)])&&(newNodeIndex=0),nodeData.push([inboundLayer.name,newNodeIndex,tensorIndex,kwargs])}filteredInboundNodes.push(nodeData)}}}var dict={};dict.name=layer.name,dict.className=layerClassName,dict.config=layerConfig,dict.inboundNodes=filteredInboundNodes,layerConfigs.push(dict)}config.layers=layerConfigs;var modelInputs=[];for(i=0;i<this.inputLayers.length;i++){var layer=this.inputLayers[i];nodeIndex=this.inputLayersNodeIndices[i],nodeKey=Container.nodeKey(layer,nodeIndex);if(this.containerNodes.has(nodeKey)){null==(newNodeIndex=nodeConversionMap[nodeKey])&&(newNodeIndex=0);tensorIndex=this.inputLayersTensorIndices[i];modelInputs.push([layer.name,newNodeIndex,tensorIndex])}}config.inputLayers=modelInputs;var modelOutputs=[];for(i=0;i<this.outputLayers.length;i++){layer=this.outputLayers[i],nodeIndex=this.outputLayersNodeIndices[i],nodeKey=Container.nodeKey(layer,nodeIndex);if(this.containerNodes.has(nodeKey)){var newNodeIndex;null==(newNodeIndex=nodeConversionMap[nodeKey])&&(newNodeIndex=0);tensorIndex=this.outputLayersTensorIndices[i];modelOutputs.push([layer.name,newNodeIndex,tensorIndex])}}return config.outputLayers=modelOutputs,config},Container.fromConfig=function(cls,config,customObjects,fastWeightInit){void 0===customObjects&&(customObjects={}),void 0===fastWeightInit&&(fastWeightInit=!1);var createdLayers={},unprocessedNodes={};function addUnprocessedNode(layer,nodeData){layer.name in unprocessedNodes?unprocessedNodes[layer.name].push(nodeData):unprocessedNodes[layer.name]=[nodeData]}function processNode(layer,nodeData){for(var kwargs,inputTensors=[],_i=0,nodeData_1=nodeData;_i<nodeData_1.length;_i++){var inputData=nodeData_1[_i],inboundLayerName=inputData[0],inboundNodeIndex=inputData[1],inboundTensorIndex=inputData[2];if(kwargs=null==inputData[3]?{}:inputData[3],!(inboundLayerName in createdLayers))return void addUnprocessedNode(layer,nodeData);var inboundLayer=createdLayers[inboundLayerName];if(inboundLayer.inboundNodes.length<=inboundNodeIndex)return void addUnprocessedNode(layer,nodeData);var inboundNode=inboundLayer.inboundNodes[inboundNodeIndex];inputTensors.push(inboundNode.outputTensors[inboundTensorIndex])}0<inputTensors.length&&layer.apply(generic_utils.singletonOrArray(inputTensors),kwargs)}function processLayer(layerData){var layerName=layerData.name,layer=serialization_1.deserialize(layerData,null!=config.customObjects?config.customObjects:{});layer.setFastWeightInitDuringBuild(fastWeightInit),createdLayers[layerName]=layer,layerData.inboundNodes.forEach(function(nodeData){if(!(nodeData instanceof Array))throw new errors_1.ValueError("Corrupted configuration, expected array for nodeData: "+nodeData);addUnprocessedNode(layer,nodeData)})}for(var name=config.name,layersFromConfig=config.layers,_i=0,layersFromConfig_1=layersFromConfig;_i<layersFromConfig_1.length;_i++){processLayer(layerData=layersFromConfig_1[_i])}for(;!generic_utils.isObjectEmpty(unprocessedNodes);)for(var _a=0,layersFromConfig_2=layersFromConfig;_a<layersFromConfig_2.length;_a++){var layerData=layersFromConfig_2[_a];if((layer=createdLayers[layerData.name]).name in unprocessedNodes){var currentUnprocessedNodesForLayer=unprocessedNodes[layer.name];delete unprocessedNodes[layer.name];for(var _b=0,currentUnprocessedNodesForLayer_1=currentUnprocessedNodesForLayer;_b<currentUnprocessedNodesForLayer_1.length;_b++){processNode(layer,currentUnprocessedNodesForLayer_1[_b])}}}for(var inputTensors=[],outputTensors=[],_c=0,inputLayersFromConfig_1=config.inputLayers;_c<inputLayersFromConfig_1.length;_c++){var layerName=(layerData=inputLayersFromConfig_1[_c])[0],nodeIndex=layerData[1],tensorIndex=layerData[2];generic_utils.assert(layerName in createdLayers);var layerOutputTensors=(layer=createdLayers[layerName]).inboundNodes[nodeIndex].outputTensors;inputTensors.push(layerOutputTensors[tensorIndex])}for(var _d=0,outputLayersFromConfig_1=config.outputLayers;_d<outputLayersFromConfig_1.length;_d++){layerName=(layerData=outputLayersFromConfig_1[_d])[0],nodeIndex=layerData[1],tensorIndex=layerData[2];generic_utils.assert(layerName in createdLayers);var layer;layerOutputTensors=(layer=createdLayers[layerName]).inboundNodes[nodeIndex].outputTensors;outputTensors.push(layerOutputTensors[tensorIndex])}return new cls({inputs:inputTensors,outputs:outputTensors,name:name})},Object.defineProperty(Container.prototype,"stateful",{get:function(){if(this._stateful)throw new errors_1.ValueError("Container instance unexpectedly has _stateful = true. The statefulness of a Container is determined by the Layers it contains. Its _stateful property must remain the default false.");for(var _i=0,_a=this.layers;_i<_a.length;_i++){if(_a[_i].stateful)return!0}return!1},enumerable:!0,configurable:!0}),Container.prototype.resetStates=function(){var _this=this;tfjs_core_1.tidy(function(){_this.layers.forEach(function(layer){layer.stateful&&layer.resetStates()})})},Container}(topology_1.Layer);exports.Container=Container},{"../backend/state":275,"../errors":289,"../layers/serialization":312,"../utils/generic_utils":322,"../utils/serialization_utils":325,"../utils/types_utils":326,"../variables":328,"../version":329,"./executor":282,"./input_layer":283,"./topology":284,"@tensorflow/tfjs-core":148}],282:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("../errors"),generic_utils_1=require("../utils/generic_utils"),input_layer_1=require("./input_layer"),topology_1=require("./topology");var FeedDict=function(){function FeedDict(feeds){if(this.id2Value={},this.id2Mask={},this.name2Id={},feeds instanceof FeedDict)for(var id in feeds.id2Value)this.id2Value[id]=feeds.id2Value[id],id in feeds.id2Mask&&(this.id2Mask[id]=feeds.id2Mask[id]);else{if(null==feeds)return;for(var _i=0,feeds_1=feeds;_i<feeds_1.length;_i++){var feed=feeds_1[_i];this.add(feed.key,feed.value)}}}return FeedDict.prototype.add=function(key,value,mask){if(null!=this.id2Value[key.id])throw new errors_1.ValueError("Duplicate key: name="+key.name+", id="+key.id);return this.id2Value[key.id]=function(key,val){if(null==key.dtype||key.dtype===val.dtype)return val;try{return tfjs_core_1.cast(val,key.dtype)}catch(err){throw new errors_1.ValueError("The dtype of the feed ("+val.dtype+") can not be cast to the dtype of the key '"+key.name+"' ("+key.dtype+").")}}(key,value),this.name2Id[key.name]=key.id,null!=mask&&(this.id2Mask[key.id]=mask),this},FeedDict.prototype.addFeed=function(feed){this.add(feed.key,feed.value)},FeedDict.prototype.hasKey=function(key){return null!=this.id2Value[key.id]},FeedDict.prototype.names=function(){return Object.keys(this.name2Id)},FeedDict.prototype.getValue=function(key){if(key instanceof topology_1.SymbolicTensor){if(null==this.id2Value[key.id])throw new errors_1.ValueError("Nonexistent key: "+key.name);return this.id2Value[key.id]}var id=this.name2Id[key];if(null==id)throw new errors_1.ValueError("Feed dict has no SymbolicTensor name: "+key);return this.id2Value[id]},FeedDict.prototype.getMask=function(key){if(key instanceof topology_1.SymbolicTensor){if(null==this.id2Value[key.id])throw new errors_1.ValueError("Nonexistent key: "+key.name);return this.id2Mask[key.id]}var id=this.name2Id[key];if(null==id)throw new errors_1.ValueError("Feed dict has no SymbolicTensor name: "+key);return this.id2Mask[id]},FeedDict.prototype.disposeMasks=function(){null!=this.id2Mask&&tfjs_core_1.dispose(this.id2Mask)},FeedDict}();exports.FeedDict=FeedDict;var cachedSorted={},cachedRecipientCounts={};function getTopologicalSortAndRecipientCountsForOneFetch(fetch,feedDict){for(var visited=new Set,sorted=[],recipientMap={},_i=0,_a=feedDict.names();_i<_a.length;_i++){var key=_a[_i];visited.add(key)}var stack=[],marks=[];for(stack.push(fetch);0<stack.length;){var top_1=stack[stack.length-1];if(visited.has(top_1.name))stack.pop();else{var topIsMarked=marks[marks.length-1]===stack.length-1;if(0===top_1.inputs.length||topIsMarked)stack.pop(),sorted.push(top_1),visited.add(top_1.name),topIsMarked&&marks.pop();else{marks.push(stack.length-1);for(var _b=0,_c=top_1.inputs;_b<_c.length;_b++){var input=_c[_b];null==recipientMap[input.name]&&(recipientMap[input.name]=new Set),recipientMap[input.name].add(top_1.name),visited.has(input.name)||stack.push(input)}}}}return{sorted:sorted,recipientMap:recipientMap}}function getNodeOutputs(fetch){var layerOutputs;if(1===fetch.sourceLayer.inboundNodes.length)layerOutputs=fetch.sourceLayer.output;else{for(var nodeIndex=null,i=0;i<fetch.sourceLayer.inboundNodes.length;++i)for(var _i=0,_a=fetch.sourceLayer.inboundNodes[i].outputTensors;_i<_a.length;_i++){if(_a[_i].id===fetch.id){nodeIndex=i;break}}layerOutputs=fetch.sourceLayer.getOutputAt(nodeIndex)}return layerOutputs}exports.execute=function(fetches,feedDict,kwargs,probe){for(var training=null!=kwargs&&kwargs.training,arrayFetches=Array.isArray(fetches),fetchArray=arrayFetches?fetches:[fetches],outputNames=fetchArray.map(function(t){return t.name}),finalOutputs=[],feedNames=feedDict.names(),_i=0,outputNames_1=outputNames;_i<outputNames_1.length;_i++){var outputName=outputNames_1[_i];-1!==feedNames.indexOf(outputName)?finalOutputs.push(feedDict.getValue(outputName)):finalOutputs.push(null)}null!=probe&&(probe.maxNumTensors=-1/0,probe.minNumTensors=1/0);var sorted,recipientCounts,fetchAndFeedKey=outputNames.join(",")+"|"+feedDict.names().join(",");if(null==cachedSorted[fetchAndFeedKey]){var out=function(fetches,feedDict){tfjs_core_1.util.assert(null!=fetches&&0<fetches.length,function(){return"Expected at least one fetch, got none"});var finalSorted=[],finalRecipientMap={};if(1===fetches.length){var out=getTopologicalSortAndRecipientCountsForOneFetch(fetches[0],feedDict);finalSorted=out.sorted,finalRecipientMap=out.recipientMap}else for(var visited=new Set,_i=0,fetches_1=fetches;_i<fetches_1.length;_i++){for(var _a=getTopologicalSortAndRecipientCountsForOneFetch(fetches_1[_i],feedDict),sorted=_a.sorted,recipientMap=_a.recipientMap,_b=0,sorted_1=sorted;_b<sorted_1.length;_b++){var symbolicTensor=sorted_1[_b];visited.has(symbolicTensor.name)||(finalSorted.push(symbolicTensor),visited.add(symbolicTensor.name))}var _loop_1=function(name_1){null==finalRecipientMap[name_1]&&(finalRecipientMap[name_1]=new Set),recipientMap[name_1].forEach(function(recipient){return finalRecipientMap[name_1].add(recipient)})};for(var name_1 in recipientMap)_loop_1(name_1)}return{sorted:finalSorted,recipientCounts:function(recipientMap){var recipientCounts={};for(var name_2 in recipientMap)recipientCounts[name_2]=recipientMap[name_2].size;return recipientCounts}(finalRecipientMap)}}(fetchArray,feedDict);sorted=out.sorted,recipientCounts=out.recipientCounts,cachedSorted[fetchAndFeedKey]=sorted,cachedRecipientCounts[fetchAndFeedKey]=recipientCounts}sorted=cachedSorted[fetchAndFeedKey],recipientCounts={},training||Object.assign(recipientCounts,cachedRecipientCounts[fetchAndFeedKey]);for(var internalFeedDict=new FeedDict(feedDict),i=0;i<sorted.length;++i){if(null!=probe){var numTensors=tfjs_core_1.memory().numTensors;numTensors>probe.maxNumTensors&&(probe.maxNumTensors=numTensors),numTensors<probe.minNumTensors&&(probe.minNumTensors=numTensors)}var symbolic=sorted[i],srcLayer=symbolic.sourceLayer;if(!(srcLayer instanceof input_layer_1.InputLayer)){for(var inputValues=[],inputMasks=[],tensorsToDispose=[],maskExists=!1,_a=0,_b=symbolic.inputs;_a<_b.length;_a++){var input=_b[_a],value=internalFeedDict.getValue(input),mask=internalFeedDict.getMask(input);inputValues.push(value),inputMasks.push(mask),null!=mask&&(maskExists=!0),training||(recipientCounts[input.name]--,0!==recipientCounts[input.name]||feedDict.hasKey(input)||-1!==outputNames.indexOf(input.name)||value.isDisposed||!0===input.sourceLayer.stateful||tensorsToDispose.push(value))}maskExists&&((kwargs=kwargs||{}).mask=inputMasks[0]);var outputTensors=generic_utils_1.toList(srcLayer.apply(inputValues,kwargs)),outputMask=null;srcLayer.supportsMasking&&(outputMask=srcLayer.computeMask(inputValues,inputMasks));for(var layerOutputs=getNodeOutputs(symbolic),outputSymbolicTensors=Array.isArray(layerOutputs)?layerOutputs:[layerOutputs],i_1=0;i_1<outputSymbolicTensors.length;++i_1){internalFeedDict.hasKey(outputSymbolicTensors[i_1])||internalFeedDict.add(outputSymbolicTensors[i_1],outputTensors[i_1],Array.isArray(outputMask)?outputMask[0]:outputMask);var index=outputNames.indexOf(outputSymbolicTensors[i_1].name);-1!==index&&(finalOutputs[index]=outputTensors[i_1])}training||tfjs_core_1.dispose(tensorsToDispose)}}return internalFeedDict.disposeMasks(),arrayFetches?finalOutputs:finalOutputs[0]},exports.getTopologicalSortAndRecipientCountsForOneFetch=getTopologicalSortAndRecipientCountsForOneFetch},{"../errors":289,"../utils/generic_utils":322,"./input_layer":283,"./topology":284,"@tensorflow/tfjs-core":148}],283:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("../backend/state"),errors_1=require("../errors"),topology_1=require("./topology"),InputLayer=function(_super){function InputLayer(args){var _this=_super.call(this,{dtype:args.dtype,name:null!=args.name?args.name:state_1.getUid("input").toString()})||this;if(null==args.batchSize&&(args.batchSize=null),null==args.sparse&&(args.sparse=!1),_this.trainable=!1,_this.built=!0,_this.sparse=args.sparse,null!=args.inputShape&&null!=args.batchInputShape)throw new errors_1.ValueError("Only provide the inputShape OR batchInputShape argument to inputLayer, not both at the same time.");var batchInputShape=args.batchInputShape;if(null==batchInputShape){if(null==args.inputShape)throw new errors_1.ValueError("An InputLayer should be passed either a `batchInputShape` or an `inputShape`.");batchInputShape=[args.batchSize].concat(args.inputShape)}else if(null!=args.batchSize)throw new errors_1.ValueError("Cannot specify batchSize if batchInputShape is specified when creating an InputLayer.");var dtype=args.dtype||"float32";_this.batchInputShape=batchInputShape,_this.dtype=dtype,_this.inputSpec=[{shape:batchInputShape}];var inputTensor=new topology_1.SymbolicTensor(_this.dtype,_this.batchInputShape,_this,[],{},_this.name);return inputTensor.nodeIndex=0,inputTensor.tensorIndex=0,new topology_1.Node({outboundLayer:_this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:[inputTensor],outputTensors:[inputTensor],inputMasks:[null],outputMasks:[null],inputShapes:[batchInputShape],outputShapes:[batchInputShape]}),_this}return __extends(InputLayer,_super),InputLayer.prototype.apply=function(inputs,kwargs){throw new errors_1.ValueError("Cannot pass any input to an InputLayer's apply() method. InputLayer name: "+this.name)},InputLayer.prototype.dispose=function(){return{refCountAfterDispose:this._refCount,numDisposedVariables:0}},InputLayer.prototype.getConfig=function(){return{batchInputShape:this.batchInputShape,dtype:this.dtype,sparse:this.sparse,name:this.name}},InputLayer.className="InputLayer",InputLayer}(topology_1.Layer);exports.InputLayer=InputLayer,tfjs_core_1.serialization.registerClass(InputLayer),exports.Input=function(config){if(null==config.batchShape&&null==config.shape)throw new Error("Please provide to Input either a `shape` or a `batchShape` argument. Note that `shape` does not include the batch dimension.");if(null!=config.batchShape&&null!=config.shape)throw new errors_1.ValueError("Please provide either a `shape` or `batchShape` argument to Input, but not both.");var batchShape=config.batchShape;null!=config.shape&&null==batchShape&&(batchShape=[null].concat(config.shape));var dtype=config.dtype;return null==dtype&&(dtype="float32"),new InputLayer({batchInputShape:batchShape,name:config.name,dtype:dtype,sparse:config.sparse}).inboundNodes[0].outputTensors[0]}},{"../backend/state":275,"../errors":289,"./topology":284,"@tensorflow/tfjs-core":148}],284:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});function InputSpec(args){this.dtype=args.dtype,this.shape=args.shape,null!=args.shape?this.ndim=args.shape.length:this.ndim=args.ndim,this.maxNDim=args.maxNDim,this.minNDim=args.minNDim,this.axes=args.axes||{}}var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("../backend/state"),common_1=require("../common"),errors_1=require("../errors"),initializers_1=require("../initializers"),generic_utils=require("../utils/generic_utils"),types_utils=require("../utils/types_utils"),variable_utils=require("../utils/variable_utils"),variables_1=require("../variables");exports.InputSpec=InputSpec;var SymbolicTensor=function(dtype,shape,sourceLayer,inputs,callArgs,name,outputTensorIndex){this.dtype=dtype,this.shape=shape,this.sourceLayer=sourceLayer,this.inputs=inputs,this.callArgs=callArgs,this.outputTensorIndex=outputTensorIndex,this.id=state_1.getNextUniqueTensorId(),null!=name&&(this.originalName=common_1.getScopedTensorName(name),this.name=common_1.getUniqueTensorName(this.originalName)),this.rank=shape.length};exports.SymbolicTensor=SymbolicTensor;var _nextNodeID=0,Node=function(){function Node(args,callArgs){this.callArgs=callArgs,this.id=_nextNodeID++,this.outboundLayer=args.outboundLayer,this.inboundLayers=args.inboundLayers,this.nodeIndices=args.nodeIndices,this.tensorIndices=args.tensorIndices,this.inputTensors=args.inputTensors,this.outputTensors=args.outputTensors,this.inputMasks=args.inputMasks,this.outputMasks=args.outputMasks,this.inputShapes=args.inputShapes,this.outputShapes=args.outputShapes;for(var _i=0,_a=args.inboundLayers;_i<_a.length;_i++){var layer=_a[_i];null!=layer&&layer.outboundNodes.push(this)}args.outboundLayer.inboundNodes.push(this)}return Node.prototype.getConfig=function(){for(var inboundNames=[],_i=0,_a=this.inboundLayers;_i<_a.length;_i++){var layer=_a[_i];null!=layer?inboundNames.push(layer.name):inboundNames.push(null)}return{outboundLayer:this.outboundLayer?this.outboundLayer.name:null,inboundLayers:inboundNames,nodeIndices:this.nodeIndices,tensorIndices:this.tensorIndices}},Node}();exports.Node=Node;var _nextLayerID=0,Layer=function(_super){function Layer(args){var _this=_super.call(this)||this;_this._callHook=null,_this._addedWeightNames=[],_this._stateful=!1,_this.id=_nextLayerID++,_this.activityRegularizer=null,_this.inputSpec=null,_this.supportsMasking=!1,_this._trainableWeights=[],_this._nonTrainableWeights=[],_this._losses=[],_this._updates=[],_this._built=!1,_this.inboundNodes=[],_this.outboundNodes=[];var name=args.name;if(!name){var prefix=_this.getClassName();name=generic_utils.toSnakeCase(prefix)+"_"+state_1.getUid(prefix)}if(_this.name=name,_this.trainable_=null==args.trainable||args.trainable,null!=args.inputShape||null!=args.batchInputShape){var batchInputShape=void 0;if(null!=args.batchInputShape)batchInputShape=args.batchInputShape;else if(null!=args.inputShape){var batchSize=null;null!=args.batchSize&&(batchSize=args.batchSize),batchInputShape=[batchSize].concat(args.inputShape)}_this.batchInputShape=batchInputShape;var dtype=args.dtype;null==dtype&&(dtype=args.inputDType),null==dtype&&(dtype="float32"),_this.dtype=dtype}return null!=args.weights?_this.initialWeights=args.weights:_this.initialWeights=null,_this._refCount=null,_this.fastWeightInitDuringBuild=!1,_this}return __extends(Layer,_super),Layer.nodeKey=function(layer,nodeIndex){return layer.name+"_ib-"+nodeIndex.toString()},Layer.prototype.getNodeAtIndex=function(nodeIndex,attrName){if(0===this.inboundNodes.length)throw new errors_1.RuntimeError("The layer has never been called and thus has no defined "+attrName+".");if(this.inboundNodes.length<=nodeIndex)throw new errors_1.ValueError("Asked to get "+attrName+" at node "+nodeIndex+", but the layer has only "+this.inboundNodes.length+" inbound nodes.");return this.inboundNodes[nodeIndex]},Layer.prototype.getInputAt=function(nodeIndex){return generic_utils.singletonOrArray(this.getNodeAtIndex(nodeIndex,"input").inputTensors)},Layer.prototype.getOutputAt=function(nodeIndex){return generic_utils.singletonOrArray(this.getNodeAtIndex(nodeIndex,"output").outputTensors)},Object.defineProperty(Layer.prototype,"input",{get:function(){if(1<this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+' has multiple inbound nodes, hence the notion of "layer input" is ill-defined. Use `getInputAt(nodeIndex)` instead.');if(0===this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+" is not connected, no input to return.");return generic_utils.singletonOrArray(this.getNodeAtIndex(0,"input").inputTensors)},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"output",{get:function(){if(0===this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+" has no inbound nodes.");if(1<this.inboundNodes.length)throw new errors_1.AttributeError("Layer "+this.name+' has multiple inbound nodes, hence the notion of "layer output" is ill-defined. Use `getOutputAt(nodeIndex)` instead.');return generic_utils.singletonOrArray(this.getNodeAtIndex(0,"output").outputTensors)},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"losses",{get:function(){return this._losses},enumerable:!0,configurable:!0}),Layer.prototype.calculateLosses=function(){return this.losses.map(function(lossFn){return lossFn()})},Object.defineProperty(Layer.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"built",{get:function(){return this._built},set:function(built){this._built=built},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"trainable",{get:function(){return this.trainable_},set:function(trainable){this._trainableWeights.forEach(function(w){return w.trainable=trainable}),this.trainable_=trainable},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"trainableWeights",{get:function(){return this.trainable_?this._trainableWeights.filter(function(w){return w.trainable}):[]},set:function(weights){this._trainableWeights=weights},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"nonTrainableWeights",{get:function(){return this.trainable?this._trainableWeights.filter(function(w){return!w.trainable}).concat(this._nonTrainableWeights):this._trainableWeights.concat(this._nonTrainableWeights)},set:function(weights){this._nonTrainableWeights=weights},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"weights",{get:function(){return this.trainableWeights.concat(this.nonTrainableWeights)},enumerable:!0,configurable:!0}),Object.defineProperty(Layer.prototype,"stateful",{get:function(){return this._stateful},enumerable:!0,configurable:!0}),Layer.prototype.resetStates=function(){if(!this.stateful)throw new Error("Cannot call the resetStates() method of a non-stateful Layer object.")},Layer.prototype.assertInputCompatibility=function(inputs){if(inputs=generic_utils.toList(inputs),null!=this.inputSpec&&0!==this.inputSpec.length){var inputSpec=generic_utils.toList(this.inputSpec);if(inputs.length!==inputSpec.length)throw new errors_1.ValueError("Layer "+this.name+" expects "+inputSpec.length+" inputs, but it received "+inputs.length+" input tensors. Input received: "+inputs);for(var inputIndex=0;inputIndex<inputs.length;inputIndex++){var x=inputs[inputIndex],spec=inputSpec[inputIndex];if(null!=spec){var ndim=x.rank;if(null!=spec.ndim&&ndim!==spec.ndim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected ndim="+spec.ndim+", found ndim="+ndim);if(null!=spec.maxNDim&&ndim>spec.maxNDim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected max_ndim="+spec.maxNDim+", found ndim="+ndim);if(null!=spec.minNDim&&ndim<spec.minNDim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected min_ndim="+spec.minNDim+", found ndim="+ndim+".");if(null!=spec.dtype&&x.dtype!==spec.dtype)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+" : expected dtype="+spec.dtype+", found dtype="+x.dtype+".");if(spec.axes){var xShape=x.shape;for(var key in spec.axes){var axis=Number(key),value=spec.axes[key],xShapeAtAxis=0<=axis?xShape[axis]:xShape[xShape.length+axis];if(null!=value&&-1===[value,null].indexOf(xShapeAtAxis))throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected axis "+axis+" of input shape to have value "+value+" but got shape "+xShape+".")}}if(null!=spec.shape)for(var i=0;i<spec.shape.length;++i){var specDim=spec.shape[i],dim=x.shape[i];if(null!=specDim&&null!=dim&&specDim!==dim)throw new errors_1.ValueError("Input "+inputIndex+" is incompatible with layer "+this.name+": expected shape="+spec.shape+", found shape="+x.shape+".")}}}}},Layer.prototype.call=function(inputs,kwargs){return inputs},Layer.prototype.invokeCallHook=function(inputs,kwargs){null!=this._callHook&&this._callHook(inputs,kwargs)},Layer.prototype.setCallHook=function(callHook){this._callHook=callHook},Layer.prototype.clearCallHook=function(){this._callHook=null},Layer.prototype.apply=function(inputs,kwargs){var _this=this;kwargs=kwargs||{},this.assertNotDisposed();for(var inputsList=generic_utils.toList(inputs),allAreSymbolic=!0,_i=0,inputsList_1=inputsList;_i<inputsList_1.length;_i++){if(!(inputsList_1[_i]instanceof SymbolicTensor)){allAreSymbolic=!1;break}}for(var noneAreSymbolic=!0,_a=0,inputsList_2=inputsList;_a<inputsList_2.length;_a++){if(inputsList_2[_a]instanceof SymbolicTensor){noneAreSymbolic=!1;break}}if(allAreSymbolic===noneAreSymbolic)throw new errors_1.ValueError("Arguments to apply() must be all SymbolicTensors or all Tensors");return common_1.nameScope(this.name,function(){if(!_this.built){_this.assertInputCompatibility(inputs);for(var inputShapes=[],_i=0,_a=generic_utils.toList(inputs);_i<_a.length;_i++){var xElem=_a[_i];inputShapes.push(xElem.shape)}_this.build(generic_utils.singletonOrArray(inputShapes)),_this.built=!0,_this.initialWeights&&_this.setWeights(_this.initialWeights),null===_this._refCount&&noneAreSymbolic&&(_this._refCount=1)}if(_this.assertInputCompatibility(inputs),noneAreSymbolic){for(var output=_this.call(inputs,kwargs),outputListCopy=[],_b=0,outputList_1=generic_utils.toList(output);_b<outputList_1.length;_b++){var x=outputList_1[_b];-1!==inputsList.indexOf(x)&&(x=x.clone()),outputListCopy.push(x)}if(output=generic_utils.singletonOrArray(outputListCopy),null!=_this.activityRegularizer)throw new errors_1.NotImplementedError("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return output}var inputShape=function(inputTensors){inputTensors=generic_utils.toList(inputTensors);for(var shapes=[],_i=0,inputTensors_1=inputTensors;_i<inputTensors_1.length;_i++){var x=inputTensors_1[_i];shapes.push(x.shape)}return generic_utils.singletonOrArray(shapes)}(inputs),outputShape=_this.computeOutputShape(inputShape);output=void 0;if(_this.warnOnIncompatibleInputShape(Array.isArray(inputs)?inputShape[0]:inputShape),output=null!=outputShape&&0<outputShape.length&&Array.isArray(outputShape[0])?outputShape.map(function(shape,index){return new SymbolicTensor("float32",shape,_this,generic_utils.toList(inputs),kwargs,_this.name,index)}):new SymbolicTensor("float32",outputShape,_this,generic_utils.toList(inputs),kwargs,_this.name),_this.addInboundNode(inputs,output,null,null,inputShape,outputShape,kwargs),_this._refCount++,null!=_this.activityRegularizer)throw new errors_1.NotImplementedError("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return output})},Layer.prototype.warnOnIncompatibleInputShape=function(inputShape){if(null!=this.batchInputShape)if(inputShape.length!==this.batchInputShape.length)console.warn("The rank of the input tensor provided (shape: "+JSON.stringify(inputShape)+") does not match that of the batchInputShape ("+JSON.stringify(this.batchInputShape)+") of the layer "+this.name);else{var dimMismatch_1=!1;this.batchInputShape.forEach(function(dimension,i){null!=dimension&&null!=inputShape[i]&&inputShape[i]!==dimension&&(dimMismatch_1=!0)}),dimMismatch_1&&console.warn("The shape of the input tensor ("+JSON.stringify(inputShape)+") does not match the expectation of layer "+this.name+": "+JSON.stringify(this.batchInputShape))}},Object.defineProperty(Layer.prototype,"outputShape",{get:function(){if(null==this.inboundNodes||0===this.inboundNodes.length)throw new errors_1.AttributeError("The layer "+this.name+" has never been called and thus has no defined output shape.");for(var allOutputShapes=[],_i=0,_a=this.inboundNodes;_i<_a.length;_i++){var node=_a[_i],shapeString=JSON.stringify(node.outputShapes);-1===allOutputShapes.indexOf(shapeString)&&allOutputShapes.push(shapeString)}if(1!==allOutputShapes.length)throw new errors_1.AttributeError("The layer "+this.name+' has multiple inbound nodes with different output shapes. Hence the notion of "outut shape" is ill-defined for the layer.');var outputShapes=this.inboundNodes[0].outputShapes;return Array.isArray(outputShapes)&&Array.isArray(outputShapes[0])&&1===outputShapes.length?outputShapes[0]:outputShapes},enumerable:!0,configurable:!0}),Layer.prototype.countParams=function(){if(!this.built)throw new errors_1.RuntimeError("You tried to call countParams() on "+this.name+", but the layer is not built yet. Build it first by calling build(batchInputShape).");return variable_utils.countParamsInWeights(this.weights)},Layer.prototype.build=function(inputShape){this.built=!0},Layer.prototype.getWeights=function(trainableOnly){return void 0===trainableOnly&&(trainableOnly=!1),variables_1.batchGetValue(trainableOnly?this.trainableWeights:this.weights)},Layer.prototype.setWeights=function(weights){var _this=this;tfjs_core_1.tidy(function(){var params=_this.weights;if(params.length!==weights.length)throw new errors_1.ValueError('You called setWeights(weights) on layer "'+_this.name+'" with a weight list of length '+weights.length+", but the layer was expecting "+params.length+" weights. Provided weights: "+weights+"...");if(0!==params.length){for(var weightValueTuples=[],paramValues=variables_1.batchGetValue(params),i=0;i<paramValues.length;++i){var pv=paramValues[i],p=params[i],w=weights[i];if(!tfjs_core_1.util.arraysEqual(pv.shape,w.shape))throw new errors_1.ValueError("Layer weight shape "+pv.shape+" not compatible with provided weight shape "+w.shape);weightValueTuples.push([p,w])}variables_1.batchSetValue(weightValueTuples)}})},Layer.prototype.addWeight=function(name,shape,dtype,initializer,regularizer,trainable,constraint){if(-1!==this._addedWeightNames.indexOf(name))throw new errors_1.ValueError("Duplicate weight name "+name+" for layer "+this.name);this._addedWeightNames.push(name),null==dtype&&(dtype="float32"),this.fastWeightInitDuringBuild&&(initializer=initializers_1.getInitializer("zeros"));var initValue=initializer.apply(shape,dtype),weight=new variables_1.LayerVariable(initValue,dtype,name,trainable,constraint);return initValue.dispose(),null!=regularizer&&this.addLoss(function(){return regularizer.apply(weight.read())}),null==trainable&&(trainable=!0),trainable?this._trainableWeights.push(weight):this._nonTrainableWeights.push(weight),weight},Layer.prototype.setFastWeightInitDuringBuild=function(value){this.fastWeightInitDuringBuild=value},Layer.prototype.addLoss=function(losses){var _a;null==losses||Array.isArray(losses)&&0===losses.length||(losses=generic_utils.toList(losses),void 0!==this._losses&&null!==this._losses&&(_a=this.losses).push.apply(_a,losses))},Layer.prototype.computeOutputShape=function(inputShape){return inputShape},Layer.prototype.computeMask=function(inputs,mask){var _this=this;if(this.supportsMasking)return mask;if(null!=mask){if(!Array.isArray(mask))throw new TypeError("Layer "+this.name+" does not support masking, but was passed an inputMask.");mask.forEach(function(maskElement){if(null!=maskElement)throw new TypeError("Layer "+_this.name+" does not support masking, but was passed an inputMask.")})}return null},Layer.prototype.addInboundNode=function(inputTensors,outputTensors,inputMasks,outputMasks,inputShapes,outputShapes,kwargs){void 0===kwargs&&(kwargs=null);var inputTensorList=generic_utils.toList(inputTensors);outputTensors=generic_utils.toList(outputTensors),inputMasks=generic_utils.toList(inputMasks),outputMasks=generic_utils.toList(outputMasks),inputShapes=types_utils.normalizeShapeList(inputShapes),outputShapes=types_utils.normalizeShapeList(outputShapes);for(var inboundLayers=[],nodeIndices=[],tensorIndices=[],_i=0,inputTensorList_1=inputTensorList;_i<inputTensorList_1.length;_i++){var x=inputTensorList_1[_i];inboundLayers.push(x.sourceLayer),nodeIndices.push(x.nodeIndex),tensorIndices.push(x.tensorIndex)}new Node({outboundLayer:this,inboundLayers:inboundLayers,nodeIndices:nodeIndices,tensorIndices:tensorIndices,inputTensors:inputTensorList,outputTensors:outputTensors,inputMasks:inputMasks,outputMasks:outputMasks,inputShapes:inputShapes,outputShapes:outputShapes},kwargs);for(var i=0;i<outputTensors.length;i++)outputTensors[i].sourceLayer=this,outputTensors[i].nodeIndex=this.inboundNodes.length-1,outputTensors[i].tensorIndex=i},Layer.prototype.getConfig=function(){var config={name:this.name,trainable:this.trainable};return null!=this.batchInputShape&&(config.batchInputShape=this.batchInputShape),null!=this.dtype&&(config.dtype=this.dtype),config},Layer.prototype.disposeWeights=function(){return this.weights.forEach(function(weight){return weight.dispose()}),this.weights.length},Layer.prototype.assertNotDisposed=function(){if(0===this._refCount)throw new Error("Layer '"+this.name+"' is already disposed.")},Layer.prototype.dispose=function(){if(!this.built)throw new Error("Cannot dispose Layer "+this.name+" because it has not been built yet.");if(null===this._refCount)throw new Error("Cannot dispose Layer "+this.name+" because it has not been used yet.");this.assertNotDisposed();var numDisposedVariables=0;return 0==--this._refCount&&(numDisposedVariables=this.disposeWeights()),{refCountAfterDispose:this._refCount,numDisposedVariables:numDisposedVariables}},Layer}(tfjs_core_1.serialization.Serializable);exports.Layer=Layer,exports.getSourceInputs=function getSourceInputs(tensor,layer,nodeIndex){if((null==layer||null!=nodeIndex&&0<nodeIndex)&&(layer=tensor.sourceLayer,nodeIndex=tensor.nodeIndex),0===layer.inboundNodes.length)return[tensor];var node=layer.inboundNodes[nodeIndex];if(0===node.inboundLayers.length)return node.inputTensors;for(var sourceTensors=[],i=0;i<node.inboundLayers.length;i++)for(var _i=0,previousSources_1=getSourceInputs(node.inputTensors[i],node.inboundLayers[i],node.nodeIndices[i]);_i<previousSources_1.length;_i++){var x_1=previousSources_1[_i];-1===sourceTensors.indexOf(x_1)&&sourceTensors.push(x_1)}return sourceTensors}},{"../backend/state":275,"../common":279,"../errors":289,"../initializers":298,"../utils/generic_utils":322,"../utils/types_utils":326,"../utils/variable_utils":327,"../variables":328,"@tensorflow/tfjs-core":148}],285:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),common_1=require("../common"),errors_1=require("../errors"),serialization_1=require("../layers/serialization"),losses=require("../losses"),Metrics=require("../metrics"),optimizers=require("../optimizers"),user_defined_metadata_1=require("../user_defined_metadata"),generic_utils_1=require("../utils/generic_utils"),layer_utils_1=require("../utils/layer_utils"),math_utils_1=require("../utils/math_utils"),serialization_utils_1=require("../utils/serialization_utils"),version_1=require("../version"),container_1=require("./container"),executor_1=require("./executor"),training_dataset_1=require("./training_dataset"),training_tensors_1=require("./training_tensors"),training_utils_1=require("./training_utils");function isDataTensor(x){return x instanceof tfjs_core_1.Tensor}function isDataArray(x){return Array.isArray(x)}function isDataDict(x){return!isDataTensor(x)&&!isDataArray(x)}function standardizeInputData(data,names,shapes,checkBatchAxis,exceptionPrefix){if(void 0===checkBatchAxis&&(checkBatchAxis=!0),void 0===exceptionPrefix&&(exceptionPrefix=""),null==names||0===names.length){if(null!=data){var gotUnexpectedData=!1;if(isDataArray(data)&&0<data.length)gotUnexpectedData=!0;else if(isDataDict(data)){for(var key in data)if(data.hasOwnProperty(key)){gotUnexpectedData=!0;break}}else gotUnexpectedData=!0;if(gotUnexpectedData)throw new errors_1.ValueError("Error when checking model "+exceptionPrefix+" expected no data, but got "+data)}return[]}if(null==data)return names.map(function(name){return null});var arrays;if(isDataDict(data)){data=data,arrays=[];for(var _i=0,names_1=names;_i<names_1.length;_i++){var name_1=names_1[_i];if(null==data[name_1])throw new errors_1.ValueError('No data provided for "'+name_1+'". Need data for each key in: '+names);arrays.push(data[name_1])}}else if(isDataArray(data)){if((data=data).length!==names.length)throw new errors_1.ValueError("Error when checking model "+exceptionPrefix+": the Array of Tensors that you are passing to your model is not the size the model expected. Expected to see "+names.length+" Tensor(s), but instead got the following list of Tensor(s): "+data);arrays=data}else{if(data=data,1<names.length)throw new errors_1.ValueError("The model "+exceptionPrefix+" expects "+names.length+" Tensor(s), but only received one Tensor. Found: Tensor with shape "+data.shape);arrays=[data]}if(arrays=training_tensors_1.ensureTensorsRank2OrHigher(arrays),null!=shapes)for(var i=0;i<names.length;++i)if(null!=shapes[i]){var array=arrays[i];if(array.shape.length!==shapes[i].length)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have "+shapes[i].length+" dimension(s). but got array with shape "+array.shape);for(var j=0;j<shapes[i].length;++j)if(0!==j||checkBatchAxis){var dim=array.shape[j],refDim=shapes[i][j];if(null!=refDim&&0<=refDim&&dim!==refDim)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have shape ["+shapes[i]+"], but got array with shape ["+array.shape+"].")}}return arrays}function checkArrayLengths(inputs,targets,weights){var setX=generic_utils_1.unique(inputs.map(function(input){return input.shape[0]}));setX.sort();var setY=generic_utils_1.unique(targets.map(function(target){return target.shape[0]}));if(setY.sort(),1<setX.length)throw new errors_1.ValueError("All input Tensors (x) should have the same number of samples. Got array shapes: "+JSON.stringify(inputs.map(function(input){return input.shape})));if(1<setY.length)throw new errors_1.ValueError("All target Tensors (y) should have the same number of samples. Got array shapes: "+JSON.stringify(targets.map(function(target){return target.shape})));if(0<setX.length&&0<setY.length&&!tfjs_core_1.util.arraysEqual(setX,setY))throw new errors_1.ValueError("Input Tensors should have the same number of samples as target Tensors. Found "+setX[0]+" input sample(s) and "+setY[0]+" target sample(s).")}function checkInputData(data,names,shapes,checkBatchAxis,exceptionPrefix){var arrays;if(void 0===checkBatchAxis&&(checkBatchAxis=!0),void 0===exceptionPrefix&&(exceptionPrefix=""),Array.isArray(data)){if(data.length!==names.length)throw new errors_1.ValueError("Error when checking model "+exceptionPrefix+": the Array of Tensors that you are passing to your model is not the size the the model expected. Expected to see "+names.length+" Tensor(s), but instead got "+data.length+" Tensors(s).");arrays=data}else{if(1<names.length)throw new errors_1.ValueError("The model expects "+names.length+" "+exceptionPrefix+" Tensors, but only received one Tensor. Found: array with shape "+JSON.stringify(data.shape)+".");arrays=[data]}if(null!=shapes)for(var i=0;i<names.length;++i)if(null!=shapes[i]){var array=arrays[i];if(array.shape.length!==shapes[i].length)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have "+shapes[i].length+" dimension(s), but got array with shape "+JSON.stringify(array.shape));for(var j=0;j<shapes[i].length;++j)if(0!==j||checkBatchAxis){var dim=array.shape[j],refDim=shapes[i][j];if(null!=refDim&&refDim!==dim)throw new errors_1.ValueError("Error when checking "+exceptionPrefix+": expected "+names[i]+" to have shape "+JSON.stringify(shapes[i])+" but got array with shape "+JSON.stringify(array.shape)+".")}}}function collectMetrics(metrics,outputNames){if(null==metrics||Array.isArray(metrics)&&0===metrics.length)return outputNames.map(function(name){return[]});var wrappedMetrics;if("string"==typeof metrics||"function"==typeof metrics)wrappedMetrics=[metrics];else{if(!Array.isArray(metrics)&&"object"!=typeof metrics)throw new TypeError("Type of metrics argument not understood. Expected an string,function, Array, or Object, found: "+metrics);wrappedMetrics=metrics}if(Array.isArray(wrappedMetrics))return outputNames.map(function(name){return wrappedMetrics});for(var nestedMetrics=[],_i=0,outputNames_1=outputNames;_i<outputNames_1.length;_i++){var name_2=outputNames_1[_i],outputMetrics=wrappedMetrics.hasOwnProperty(name_2)?wrappedMetrics[name_2]:[];Array.isArray(outputMetrics)||(outputMetrics=[outputMetrics]),nestedMetrics.push(outputMetrics)}return nestedMetrics}exports.isDataTensor=isDataTensor,exports.isDataArray=isDataArray,exports.isDataDict=isDataDict,exports.standardizeInputData=standardizeInputData,exports.checkArrayLengths=checkArrayLengths,exports.collectMetrics=collectMetrics;var LayersModel=function(_super){function LayersModel(args){var _this=_super.call(this,args)||this;return _this.isTraining=!1,_this}return __extends(LayersModel,_super),LayersModel.prototype.summary=function(lineLength,positions,printFn){if(void 0===printFn&&(printFn=console.log),!this.built)throw new errors_1.ValueError("This model has never been called, thus its weights have not been created yet. So no summary can be displayed. Build the model first (e.g., by calling it on some test data).");layer_utils_1.printSummary(this,lineLength,positions,printFn)},LayersModel.prototype.compile=function(args){var _this=this;if(null==args.loss&&(args.loss=[]),this.loss=args.loss,"string"==typeof args.optimizer)this.optimizer_=optimizers.getOptimizer(args.optimizer),this.isOptimizerOwned=!0;else{if(!(args.optimizer instanceof tfjs_core_1.Optimizer))throw new errors_1.ValueError("User-defined optimizer must be an instance of tf.Optimizer.");this.optimizer_=args.optimizer,this.isOptimizerOwned=!1}var lossFunctions=[];if(Array.isArray(args.loss)||"string"==typeof args.loss||"function"==typeof args.loss)if(Array.isArray(args.loss)){if(args.loss.length!==this.outputs.length)throw new errors_1.ValueError("When passing an Array as loss, it should have one entry per model output. The model has "+this.outputs.length+" output(s), but you passed loss="+args.loss+".");var theLosses=args.loss;lossFunctions=theLosses.map(function(l){return losses.get(l)})}else{var lossFunction_1=losses.get(args.loss);this.outputs.forEach(function(_){lossFunctions.push(lossFunction_1)})}else{for(var name_3 in args.loss=args.loss,args.loss)if(-1===this.outputNames.indexOf(name_3))throw new errors_1.ValueError('Unknown entry in loss dictionary: "'+name_3+'". Only expected the following keys: '+this.outputNames);for(var _i=0,_a=this.outputNames;_i<_a.length;_i++){var name_4=_a[_i];null==args.loss[name_4]&&console.warn('Output "'+name_4+'" is missing from loss dictionary. We assume this was done on purpose, and we will not be expecting data to be passed to '+name_4+" during training"),lossFunctions.push(losses.get(args.loss[name_4]))}}this.lossFunctions=lossFunctions,this.feedOutputNames=[],this.feedOutputShapes=[],this.feedLossFns=[];for(var i=0;i<this.outputs.length;++i){var shape=this.internalOutputShapes[i],name_5=this.outputNames[i];this.feedOutputNames.push(name_5),this.feedOutputShapes.push(shape),this.feedLossFns.push(this.lossFunctions[i])}var skipTargetIndices=[];this.metrics=args.metrics,this.metricsNames=["loss"],this.metricsTensors=[],common_1.nameScope("loss",function(){for(var i=0;i<_this.outputs.length;++i)if(-1===skipTargetIndices.indexOf(i)){var weightedLoss=_this.lossFunctions[i];1<_this.outputs.length&&(_this.metricsTensors.push([weightedLoss,i]),_this.metricsNames.push(_this.outputNames[i]+"_loss"))}});var nestedMetrics=collectMetrics(args.metrics,this.outputNames);common_1.nameScope("metric",function(){for(var _loop_1=function(i){if(-1!==skipTargetIndices.indexOf(i))return"continue";!function(metrics){for(var metricName,accFn,weightedMetricFn,_loop_2=function(metric){if("string"==typeof metric&&-1!==["accuracy","acc","crossentropy","ce"].indexOf(metric)){var outputShape=_this.internalOutputShapes[i];1===outputShape[outputShape.length-1]||_this.lossFunctions[i]===losses.binaryCrossentropy?-1!==["accuracy","acc"].indexOf(metric)?accFn=Metrics.binaryAccuracy:-1!==["crossentropy","ce"].indexOf(metric)&&(accFn=Metrics.binaryCrossentropy):_this.lossFunctions[i]===losses.sparseCategoricalCrossentropy?-1!==["accuracy","acc"].indexOf(metric)?accFn=Metrics.sparseCategoricalAccuracy:-1!==["crossentropy","ce"].indexOf(metric)&&(accFn=Metrics.sparseCategoricalCrossentropy):-1!==["accuracy","acc"].indexOf(metric)?accFn=Metrics.categoricalAccuracy:-1!==["crossentropy","ce"].indexOf(metric)&&(accFn=Metrics.categoricalCrossentropy);var suffix=void 0;-1!==["accuracy","acc"].indexOf(metric)?suffix="acc":-1!==["crossentropy","ce"].indexOf(metric)&&(suffix="ce"),weightedMetricFn=accFn,metricName=""+suffix}else{var metricFn=Metrics.get(metric);weightedMetricFn=metricFn,metricName=""+Metrics.getLossOrMetricName(metric)}var metricResult;common_1.nameScope(metricName,function(){metricResult=weightedMetricFn}),function(outputIndex,metricName,metricTensor){1<_this.outputNames.length&&(metricName=_this.outputNames[outputIndex]+"_"+metricName),_this.metricsNames.push(metricName),_this.metricsTensors.push([metricTensor,outputIndex])}(i,metricName,metricResult)},_i=0,metrics_1=metrics;_i<metrics_1.length;_i++){_loop_2(metrics_1[_i])}}(nestedMetrics[i])},i=0;i<_this.outputs.length;++i)_loop_1(i)}),this.collectedTrainableWeights=this.trainableWeights},LayersModel.prototype.checkTrainableWeightsConsistency=function(){null!=this.collectedTrainableWeights&&this.trainableWeights.length!==this.collectedTrainableWeights.length&&console.warn("Discrepancy between trainableweights and collected trainable weights. Did you set `model.trainable` without calling `model.compile()` afterwards?")},LayersModel.prototype.evaluate=function(x,y,args){void 0===args&&(args={});var batchSize=null==args.batchSize?32:args.batchSize;training_tensors_1.checkBatchSize(batchSize);var standardizedOuts=this.standardizeUserDataXY(x,y,!0,batchSize);try{var ins=standardizedOuts[0].concat(standardizedOuts[1]);this.makeTestFunction();var f=this.testFunction,testOuts=this.testLoop(f,ins,batchSize,args.verbose,args.steps);return generic_utils_1.singletonOrArray(testOuts)}finally{training_tensors_1.disposeNewTensors(standardizedOuts[0],x),training_tensors_1.disposeNewTensors(standardizedOuts[1],y)}},LayersModel.prototype.evaluateDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return this.makeTestFunction(),[2,training_dataset_1.evaluateDataset(this,dataset,args)]})})},LayersModel.prototype.checkNumSamples=function(ins,batchSize,steps,stepsName){var numSamples;if(void 0===stepsName&&(stepsName="steps"),null!=steps){if((numSamples=null)!=batchSize)throw new errors_1.ValueError("If "+stepsName+" is set, batchSize must be null or undefined.Got batchSize = "+batchSize)}else{if(null==ins)throw new errors_1.ValueError("Either the input data should have a defined shape, or "+stepsName+" shoud be specified.");numSamples=Array.isArray(ins)?ins[0].shape[0]:ins.shape[0]}return numSamples},LayersModel.prototype.execute=function(inputs,outputs){if(Array.isArray(outputs)&&0===outputs.length)throw new errors_1.ValueError("`outputs` is an empty Array, which is not allowed.");var outputsIsArray=Array.isArray(outputs),outputNames=outputsIsArray?outputs:[outputs],outputSymbolicTensors=this.retrieveSymbolicTensors(outputNames),feedDict=new executor_1.FeedDict;if(inputs instanceof tfjs_core_1.Tensor&&(inputs=[inputs]),Array.isArray(inputs)){if(inputs.length!==this.inputs.length)throw new errors_1.ValueError("The number of inputs provided ("+inputs.length+") does not match the number of inputs of this model ("+this.inputs.length+").");for(var i=0;i<this.inputs.length;++i)feedDict.add(this.inputs[i],inputs[i])}else for(var _i=0,_a=this.inputs;_i<_a.length;_i++){var input=_a[_i],tensorValue=inputs[input.name];if(null==tensorValue)throw new errors_1.ValueError("No value is provided for the model's input "+input.name);feedDict.add(input,tensorValue)}var executeOutputs=executor_1.execute(outputSymbolicTensors,feedDict);return outputsIsArray?executeOutputs:executeOutputs[0]},LayersModel.prototype.retrieveSymbolicTensors=function(symbolicTensorNames){for(var outputSymbolicTensors=generic_utils_1.pyListRepeat(null,symbolicTensorNames.length),outputsRemaining=symbolicTensorNames.length,_i=0,_a=this.layers;_i<_a.length;_i++){for(var layer=_a[_i],layerOutputs=Array.isArray(layer.output)?layer.output:[layer.output],layerOutputNames=layerOutputs.map(function(output){return output.name}),i=0;i<symbolicTensorNames.length;++i){var index=layerOutputNames.indexOf(symbolicTensorNames[i]);if(-1!==index&&(outputSymbolicTensors[i]=layerOutputs[index],outputsRemaining--),0===outputsRemaining)break}if(0===outputsRemaining)break}if(0<outputsRemaining){var remainingNames_1=[];throw outputSymbolicTensors.forEach(function(tensor,i){null==tensor&&remainingNames_1.push(symbolicTensorNames[i])}),new errors_1.ValueError("Cannot find SymbolicTensors for output name(s): "+JSON.stringify(remainingNames_1))}return outputSymbolicTensors},LayersModel.prototype.predictLoop=function(ins,batchSize,verbose){var _this=this;return void 0===batchSize&&(batchSize=32),void 0===verbose&&(verbose=!1),tfc.tidy(function(){var numSamples=_this.checkNumSamples(ins);if(verbose)throw new errors_1.NotImplementedError("Verbose predictLoop() is not implemented yet.");for(var batches=training_tensors_1.makeBatches(numSamples,batchSize),outsBatches=_this.outputs.map(function(output){return[]}),_loop_3=function(batchIndex){tfc.tidy(function(){var batchStart=batches[batchIndex][0],batchEnd=batches[batchIndex][1],insBatch=training_tensors_1.sliceArrays(ins,batchStart,batchEnd),feeds=[];if(Array.isArray(insBatch))for(var i=0;i<insBatch.length;++i)feeds.push({key:_this.inputs[i],value:insBatch[i]});else feeds.push({key:_this.inputs[0],value:insBatch});var feedDict=new executor_1.FeedDict(feeds);return executor_1.execute(_this.outputs,feedDict)}).forEach(function(batchOut,i){return outsBatches[i].push(batchOut)})},batchIndex=0;batchIndex<batches.length;++batchIndex)_loop_3(batchIndex);return generic_utils_1.singletonOrArray(outsBatches.map(function(batches){return tfc.concat(batches,0)}))})},LayersModel.prototype.predict=function(x,args){void 0===args&&(args={});var xsRank2OrHigher=training_tensors_1.ensureTensorsRank2OrHigher(x);checkInputData(xsRank2OrHigher,this.inputNames,this.feedInputShapes,!1);try{var batchSize=null==args.batchSize?32:args.batchSize;return training_tensors_1.checkBatchSize(batchSize),this.predictLoop(xsRank2OrHigher,batchSize)}finally{training_tensors_1.disposeNewTensors(xsRank2OrHigher,x)}},LayersModel.prototype.predictOnBatch=function(x){checkInputData(x,this.inputNames,this.feedInputShapes,!0);var batchSize=(Array.isArray(x)?x[0]:x).shape[0];return this.predictLoop(x,batchSize)},LayersModel.prototype.standardizeUserDataXY=function(x,y,checkBatchAxis,batchSize){if(void 0===checkBatchAxis&&(checkBatchAxis=!0),null==this.optimizer_)throw new errors_1.RuntimeError("You must compile a model before training/testing. Use LayersModel.compile(modelCompileArgs).");for(var outputShapes=[],i=0;i<this.feedOutputShapes.length;++i){var outputShape=this.feedOutputShapes[i];this.feedLossFns[i]===losses.sparseCategoricalCrossentropy?outputShapes.push(outputShape.slice(0,outputShape.length-1).concat([1])):outputShapes.push(outputShape)}if(checkArrayLengths(x=standardizeInputData(x,this.feedInputNames,this.feedInputShapes,!1,"input"),y=standardizeInputData(y,this.feedOutputNames,outputShapes,!1,"target")),function(targets,lossFns,outputShapes){for(var keyLosses=[losses.meanSquaredError,losses.binaryCrossentropy,losses.categoricalCrossentropy],i=0;i<targets.length;++i){var y=targets[i],loss=lossFns[i],shape=outputShapes[i];if(null!=loss){if(loss===losses.categoricalCrossentropy&&1===y.shape[y.shape.length-1])throw new errors_1.ValueError("You are passing a target array of shape "+y.shape+" while using a loss 'categorical_crossentropy'. 'categorical_crossentropy'expects targets to be binary matrices (1s and 0s) of shape [samples, classes].");if(-1!==keyLosses.indexOf(loss))for(var slicedYShape=y.shape.slice(1),slicedShape=shape.slice(1),j=0;j<slicedYShape.length;++j){var targetDim=slicedYShape[j],outDim=slicedShape[j];if(null!=outDim&&targetDim!==outDim)throw new errors_1.ValueError("A target Tensor with shape "+y.shape+" was passed for an output of shape "+shape+", while using a loss function that expects targets to have the same shape as the output.")}}}}(y,this.feedLossFns,this.feedOutputShapes),this.stateful&&null!=batchSize&&0<batchSize&&x[0].shape[0]%batchSize!=0)throw new errors_1.ValueError("In a stateful network, you should only pass inputs with a number of samples that is divisible by the batch size "+batchSize+". Found: "+x[0].shape[0]+" sample(s).");return[x,y]},LayersModel.prototype.standardizeUserData=function(x,y,sampleWeight,classWeight,checkBatchAxis,batchSize){return void 0===checkBatchAxis&&(checkBatchAxis=!0),__awaiter(this,void 0,void 0,function(){var _a,standardXs,standardYs,standardSampleWeights,classWeights,i,_b,_c;return __generator(this,function(_d){switch(_d.label){case 0:if(_a=this.standardizeUserDataXY(x,y,checkBatchAxis,batchSize),standardXs=_a[0],standardYs=_a[1],null!=sampleWeight)throw new Error("sample weight is not supported yet.");if((standardSampleWeights=null)==classWeight)return[3,4];classWeights=training_utils_1.standardizeClassWeights(classWeight,this.outputNames),standardSampleWeights=[],i=0,_d.label=1;case 1:return i<classWeights.length?(_c=(_b=standardSampleWeights).push,[4,training_utils_1.standardizeWeights(standardYs[i],null,classWeights[i])]):[3,4];case 2:_c.apply(_b,[_d.sent()]),_d.label=3;case 3:return++i,[3,1];case 4:return[2,[standardXs,standardYs,standardSampleWeights]]}})})},LayersModel.prototype.testLoop=function(f,ins,batchSize,verbose,steps){var _this=this;return void 0===verbose&&(verbose=0),tfc.tidy(function(){var numSamples=_this.checkNumSamples(ins,batchSize,steps,"steps"),outs=[];if(0<verbose)throw new errors_1.NotImplementedError("Verbose mode is not implemented yet.");if(null!=steps)throw new errors_1.NotImplementedError("steps mode in testLoop() is not implemented yet");for(var batches=training_tensors_1.makeBatches(numSamples,batchSize),indexArray=tfjs_core_1.tensor1d(math_utils_1.range(0,numSamples)),batchIndex=0;batchIndex<batches.length;++batchIndex){var batchStart=batches[batchIndex][0],batchEnd=batches[batchIndex][1],batchIds=K.sliceAlongFirstAxis(indexArray,batchStart,batchEnd-batchStart),insBatch=training_tensors_1.sliceArraysByIndices(ins,batchIds),batchOuts=f(insBatch);if(0===batchIndex)for(var i=0;i<batchOuts.length;++i)outs.push(tfjs_core_1.scalar(0));for(i=0;i<batchOuts.length;++i){var batchOut=batchOuts[i];outs[i]=tfc.add(outs[i],tfc.mul(batchEnd-batchStart,batchOut))}}for(i=0;i<outs.length;++i)outs[i]=tfc.div(outs[i],numSamples);return outs})},LayersModel.prototype.getDedupedMetricsNames=function(){for(var outLabels=this.metricsNames,dedupedOutLabels=[],i=0;i<outLabels.length;++i){var label=outLabels[i],newLabel=label;if(1<generic_utils_1.count(outLabels,label))newLabel+="_"+generic_utils_1.count(outLabels.slice(0,i),label);dedupedOutLabels.push(newLabel)}return dedupedOutLabels},LayersModel.prototype.makeTrainFunction=function(){var _this=this;return function(data){var lossValues=[],inputs=data.slice(0,_this.inputs.length),targets=data.slice(_this.inputs.length,_this.inputs.length+_this.outputs.length),sampleWeights=data.slice(_this.inputs.length+_this.outputs.length,_this.inputs.length+2*_this.outputs.length),metricsValues=[],variables=_this.collectedTrainableWeights.map(function(param){return param.read()});return[_this.optimizer_.minimize(function(){for(var feeds=[],i=0;i<_this.inputs.length;++i)feeds.push({key:_this.inputs[i],value:inputs[i]});var totalLoss,feedDict=new executor_1.FeedDict(feeds),outputs=executor_1.execute(_this.outputs,feedDict,{training:!0});for(i=0;i<_this.lossFunctions.length;++i){var loss=(0,_this.lossFunctions[i])(targets[i],outputs[i]);null!=sampleWeights[i]&&(loss=training_utils_1.computeWeightedLoss(loss,sampleWeights[i]));var meanLoss=tfc.mean(loss);lossValues.push(meanLoss),totalLoss=0===i?loss:tfc.add(totalLoss,loss)}for(i=0;i<_this.metricsTensors.length;++i){var weightedMetric=void 0;if(1<_this.outputs.length&&i<_this.outputs.length)weightedMetric=lossValues[i];else{var metric=_this.metricsTensors[i][0],outputIndex=_this.metricsTensors[i][1];weightedMetric=tfc.mean(metric(targets[outputIndex],outputs[outputIndex]))}tfc.keep(weightedMetric),metricsValues.push(weightedMetric)}return totalLoss=tfc.mean(totalLoss),_this.calculateLosses().forEach(function(regularizerLoss){totalLoss=tfc.add(totalLoss,regularizerLoss)}),totalLoss},!0,variables)].concat(metricsValues)}},LayersModel.prototype.makeTestFunction=function(){var _this=this;this.testFunction=function(data){return tfc.tidy(function(){for(var totalLoss,valOutputs=[],inputs=data.slice(0,_this.inputs.length),targets=data.slice(_this.inputs.length,_this.inputs.length+_this.outputs.length),feeds=[],i=0;i<_this.inputs.length;++i)feeds.push({key:_this.inputs[i],value:inputs[i]});var feedDict=new executor_1.FeedDict(feeds),outputs=executor_1.execute(_this.outputs,feedDict);for(i=0;i<_this.lossFunctions.length;++i){var lossFunction=_this.lossFunctions[i],loss=tfc.mean(lossFunction(targets[i],outputs[i]));totalLoss=0===i?loss:tfc.add(totalLoss,loss),valOutputs.push(totalLoss)}for(i=0;i<_this.metricsTensors.length;++i){var metric=_this.metricsTensors[i][0],outputIndex=_this.metricsTensors[i][1],meanMetric=tfc.mean(metric(targets[outputIndex],outputs[outputIndex]));valOutputs.push(meanMetric)}return valOutputs})}},LayersModel.prototype.fit=function(x,y,args){return void 0===args&&(args={}),__awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,training_tensors_1.fitTensors(this,x,y,args)]})})},LayersModel.prototype.fitDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,training_dataset_1.fitDataset(this,dataset,args)]})})},LayersModel.prototype.trainOnBatch=function(x,y){return __awaiter(this,void 0,void 0,function(){var standardizeOut,inputs,targets,trainFunction,losses,lossValues,_i,losses_1,v;return __generator(this,function(_a){switch(_a.label){case 0:return[4,this.standardizeUserData(x,y)];case 1:standardizeOut=_a.sent(),inputs=standardizeOut[0],targets=standardizeOut[1],trainFunction=this.makeTrainFunction(),losses=trainFunction(inputs.concat(targets)),lossValues=[],_i=0,losses_1=losses,_a.label=2;case 2:return _i<losses_1.length?[4,losses_1[_i].data()]:[3,5];case 3:v=_a.sent(),lossValues.push(v[0]),_a.label=4;case 4:return _i++,[3,2];case 5:return tfc.dispose(losses),[2,generic_utils_1.singletonOrArray(lossValues)]}})})},LayersModel.prototype.getNamedWeights=function(config){for(var namedWeights=[],trainableOnly=null!=config&&config.trainableOnly,weights=trainableOnly?this.trainableWeights:this.weights,weightValues=this.getWeights(trainableOnly),i=0;i<weights.length;++i)trainableOnly&&!weights[i].trainable||namedWeights.push({name:weights[i].originalName,tensor:weightValues[i]});return namedWeights},Object.defineProperty(LayersModel.prototype,"stopTraining",{get:function(){return this.stopTraining_},set:function(stop){this.stopTraining_=stop},enumerable:!0,configurable:!0}),Object.defineProperty(LayersModel.prototype,"optimizer",{get:function(){return this.optimizer_},set:function(optimizer){this.optimizer_!==optimizer&&(this.optimizer_=optimizer,this.isOptimizerOwned=!1)},enumerable:!0,configurable:!0}),LayersModel.prototype.dispose=function(){var result=_super.prototype.dispose.call(this);if(0===result.refCountAfterDispose&&null!=this.optimizer&&this.isOptimizerOwned){var numTensorsBeforeOptmizerDisposal=tfc.memory().numTensors;this.optimizer_.dispose(),result.numDisposedVariables+=numTensorsBeforeOptmizerDisposal-tfc.memory().numTensors}return result},LayersModel.prototype.getLossIdentifiers=function(){var lossNames;if("string"==typeof this.loss)lossNames=generic_utils_1.toSnakeCase(this.loss);else if(Array.isArray(this.loss)){for(var _i=0,_a=this.loss;_i<_a.length;_i++){if("string"!=typeof _a[_i])throw new Error("Serialization of non-string loss is not supported.")}lossNames=this.loss.map(function(name){return generic_utils_1.toSnakeCase(name)})}else{var outputNames=Object.keys(this.loss);lossNames={};for(var losses_2=this.loss,_b=0,outputNames_2=outputNames;_b<outputNames_2.length;_b++){var outputName=outputNames_2[_b];if("string"!=typeof losses_2[outputName])throw new Error("Serialization of non-string loss is not supported.");lossNames[outputName]=generic_utils_1.toSnakeCase(losses_2[outputName])}}return lossNames},LayersModel.prototype.getMetricIdentifiers=function(){if("string"==typeof this.metrics||"function"==typeof this.metrics)return[generic_utils_1.toSnakeCase(Metrics.getLossOrMetricName(this.metrics))];if(Array.isArray(this.metrics))return this.metrics.map(function(metric){return generic_utils_1.toSnakeCase(Metrics.getLossOrMetricName(metric))});var metricsIdentifiers={};for(var key in this.metrics)metricsIdentifiers[key]=generic_utils_1.toSnakeCase(Metrics.getLossOrMetricName(this.metrics[key]));return metricsIdentifiers},LayersModel.prototype.getTrainingConfig=function(){return{loss:this.getLossIdentifiers(),metrics:this.getMetricIdentifiers(),optimizer_config:{class_name:this.optimizer.getClassName(),config:this.optimizer.getConfig()}}},LayersModel.prototype.loadTrainingConfig=function(trainingConfig){if(null!=trainingConfig.weighted_metrics)throw new Error("Loading weight_metrics is not supported yet.");if(null!=trainingConfig.loss_weights)throw new Error("Loading loss_weights is not supported yet.");if(null!=trainingConfig.sample_weight_mode)throw new Error("Loading sample_weight_mode is not supported yet.");var loss,metrics,tsConfig=serialization_utils_1.convertPythonicToTs(trainingConfig.optimizer_config),optimizer=serialization_1.deserialize(tsConfig);if("string"==typeof trainingConfig.loss)loss=generic_utils_1.toCamelCase(trainingConfig.loss);else if(Array.isArray(trainingConfig.loss))loss=trainingConfig.loss.map(function(lossEntry){return generic_utils_1.toCamelCase(lossEntry)});else if(null!=trainingConfig.loss)for(var key in loss={},trainingConfig.loss)loss[key]=generic_utils_1.toCamelCase(trainingConfig.loss[key]);if(Array.isArray(trainingConfig.metrics))metrics=trainingConfig.metrics.map(function(metric){return generic_utils_1.toCamelCase(metric)});else if(null!=trainingConfig.metrics)for(var key in metrics={},trainingConfig.metrics)metrics[key]=generic_utils_1.toCamelCase(trainingConfig.metrics[key]);this.compile({loss:loss,metrics:metrics,optimizer:optimizer})},LayersModel.prototype.save=function(handlerOrURL,config){return __awaiter(this,void 0,void 0,function(){var _a,handlers,weightDataAndSpecs,modelConfig,modelArtifacts,weightType,_b,optimizerWeightData,optimizerWeightSpecs,_c,_d;return __generator(this,function(_e){switch(_e.label){case 0:if("string"==typeof handlerOrURL){if(0===(handlers=tfjs_core_1.io.getSaveHandlers(handlerOrURL)).length)throw new errors_1.ValueError("Cannot find any save handlers for URL '"+handlerOrURL+"'");if(1<handlers.length)throw new errors_1.ValueError("Found more than one ("+handlers.length+") save handlers for URL '"+handlerOrURL+"'");handlerOrURL=handlers[0]}if(null==handlerOrURL.save)throw new errors_1.ValueError("LayersModel.save() cannot proceed because the IOHandler provided does not have the `save` attribute defined.");return[4,tfjs_core_1.io.encodeWeights(this.getNamedWeights(config))];case 1:return weightDataAndSpecs=_e.sent(),!1,null,modelConfig=this.toJSON(null,!1),modelArtifacts={modelTopology:modelConfig,format:"layers-model",generatedBy:"TensorFlow.js tfjs-layers v"+version_1.version,convertedBy:null},null!=config&&config.includeOptimizer&&null!=this.optimizer?(modelArtifacts.trainingConfig=this.getTrainingConfig(),weightType="optimizer",_d=(_c=tfjs_core_1.io).encodeWeights,[4,this.optimizer.getWeights()]):[3,4];case 2:return[4,_d.apply(_c,[_e.sent(),weightType])];case 3:_b=_e.sent(),optimizerWeightData=_b.data,optimizerWeightSpecs=_b.specs,(_a=weightDataAndSpecs.specs).push.apply(_a,optimizerWeightSpecs),weightDataAndSpecs.data=tfjs_core_1.io.concatenateArrayBuffers([weightDataAndSpecs.data,optimizerWeightData]),_e.label=4;case 4:return null!=this.userDefinedMetadata&&(!0,user_defined_metadata_1.checkUserDefinedMetadata(this.userDefinedMetadata,this.name,!0),modelArtifacts.userDefinedMetadata=this.userDefinedMetadata),modelArtifacts.weightData=weightDataAndSpecs.data,modelArtifacts.weightSpecs=weightDataAndSpecs.specs,[2,handlerOrURL.save(modelArtifacts)]}})})},LayersModel.prototype.setUserDefinedMetadata=function(userDefinedMetadata){user_defined_metadata_1.checkUserDefinedMetadata(userDefinedMetadata,this.name),this.userDefinedMetadata=userDefinedMetadata},LayersModel.prototype.getUserDefinedMetadata=function(){return this.userDefinedMetadata},LayersModel.className="Model",LayersModel}(container_1.Container);exports.LayersModel=LayersModel,tfjs_core_1.serialization.registerClass(LayersModel)},{"../backend/tfjs_backend":276,"../common":279,"../errors":289,"../layers/serialization":312,"../losses":315,"../metrics":316,"../optimizers":318,"../user_defined_metadata":320,"../utils/generic_utils":322,"../utils/layer_utils":323,"../utils/math_utils":324,"../utils/serialization_utils":325,"../version":329,"./container":281,"./executor":282,"./training_dataset":286,"./training_tensors":287,"./training_utils":288,"@tensorflow/tfjs-core":148}],286:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),base_callbacks_1=require("../base_callbacks"),errors_1=require("../errors"),logs_1=require("../logs"),generic_utils_1=require("../utils/generic_utils"),training_utils_1=require("./training_utils"),DEFAULT_VALIDATION_BATCH_SIZE=32;function standardizeDataIteratorOutput(model,iteratorOut){var xs,ys,iteratorOutObj=iteratorOut;xs=iteratorOutObj.xs,ys=iteratorOutObj.ys,tfc.util.assert(null!=xs&&null!=ys,function(){return"A Dataset iterator for fitDataset() is expected to generate objects of the form `{xs: xVal, ys: yVal}`, where the two values may be `tf.Tensor`, an array of Tensors, or a map of string to Tensor.  The provided Dataset instead generates "+iteratorOut});var flattenedXs=flattenTensorOrArrayOrMap("input",model.inputNames,xs),flattenedYs=flattenTensorOrArrayOrMap("output",model.outputNames,ys),batchSize=flattenedXs[0].shape[0];tfc.util.assert(flattenedXs.length===model.inputs.length,function(){return"LayersModel has "+model.inputs.length+" inputs, but the dataset provides "+flattenedXs.length+" inputs.  (Expected input keys: "+JSON.stringify(model.inputNames)+")"}),tfc.util.assert(flattenedYs.length===model.outputs.length,function(){return"LayersModel has "+model.outputs.length+" outputs, but the dataset provides "+flattenedYs.length+" outputs.  (Expected output keys: "+JSON.stringify(model.outputNames)+")"});function _loop_1(xIndex){tfc.util.assert(flattenedXs[xIndex].shape[0]===batchSize,function(){return"Batch size mismatch: input "+model.inputNames[xIndex]+" has "+flattenedXs[xIndex].shape[0]+"; expected  "+batchSize+" based on input "+model.inputNames[0]+"."})}for(var xIndex in flattenedXs)_loop_1(xIndex);function _loop_2(yIndex){tfc.util.assert(flattenedYs[yIndex].shape[0]===batchSize,function(){return"Batch size mismatch: output "+model.outputNames[yIndex]+" has "+flattenedYs[yIndex].shape[0]+"; expected  "+batchSize+" based on input "+model.inputNames[0]+"."})}for(var yIndex in flattenedYs)_loop_2(yIndex);return{xs:flattenedXs,ys:flattenedYs}}function flattenTensorOrArrayOrMap(inputOrOutput,names,values){if(values instanceof tfc.Tensor)return[values];if(Array.isArray(values))return tfc.util.assert(values.length===names.length,function(){return"Received an array of "+values.length+" Tensors, but expected "+names.length+" to match the "+inputOrOutput+" keys "+names+"."}),values;for(var result=[],_i=0,names_1=names;_i<names_1.length;_i++){var name_1=names_1[_i];if(null==values[name_1])throw new errors_1.ValueError("The feature data generated by the dataset lacks the required "+inputOrOutput+" key '"+name_1+"'.");result.push(values[name_1])}return result}function isDatasetObject(dataset){return"function"==typeof dataset.iterator}exports.fitDataset=function(model,dataset,args){return __awaiter(this,void 0,void 0,function(){var hasBatchesPerEpoch,doValidation,valXs,valYs,validationData,trainFunction,outLabels,callbackMetrics,callbacks,verbose,_a,callbackList,history_1,epoch,dataIterator,epochLogs,stepsDone,batchIndex,iteratorOut,_b,xs,ys,batchLogs,sampleWeights,standardClassWeights,_c,_d,ins,outs,label,out,valOuts,_e,i;return __generator(this,function(_f){switch(_f.label){case 0:if(hasBatchesPerEpoch=null!=args.batchesPerEpoch,tfc.util.assert(null!=model.optimizer,function(){return"You must compile a model before training/testing. Use LayersModel.compile(modelCompileConfig)."}),tfc.util.assert(null!=args,function(){return"For fitDataset(), the 2nd argument (config) is required, but it is not provided in this call."}),tfc.util.assert(null!=args.epochs&&0<args.epochs&&Number.isInteger(args.epochs),function(){return"For fitDataset(), config.epochs is expected to be a positive integer, but got "+args.epochs}),tfc.util.assert(!hasBatchesPerEpoch||0<args.batchesPerEpoch&&Number.isInteger(args.batchesPerEpoch),function(){return"For fitDataset(), config.batchesPerEpoch is expected to be a positive integer if specified, but got "+args.batchesPerEpoch}),tfc.util.assert(null==args.validationSplit,function(){return"`validationSplit` is not supported by `fitDataset()`. Use validationData instead."}),model.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");model.isTraining=!0,_f.label=1;case 1:return _f.trys.push([1,,26,27]),doValidation=null!=args.validationData,valYs=valXs=void 0,doValidation&&(isDatasetObject(args.validationData)?tfc.util.assert(null==args.validationBatches||0<args.validationBatches&&Number.isInteger(args.validationBatches),function(){return"For fitDataset() with dataset-based validation, config.validationBatches is expected not to be provided, or to be a positive integer, but got "+args.validationBatches}):(validationData=function(data){if(3===data.length)throw new errors_1.NotImplementedError("Validation with sample weights is not implemented yet.");return{xs:data[0],ys:data[1]}}(args.validationData),valXs=validationData.xs,valYs=validationData.ys)),trainFunction=model.makeTrainFunction(),outLabels=model.getDedupedMetricsNames(),callbackMetrics=void 0,callbackMetrics=doValidation?outLabels.slice().concat(outLabels.map(function(n){return"val_"+n})):outLabels.slice(),callbacks=base_callbacks_1.standardizeCallbacks(args.callbacks,args.yieldEvery),verbose=null==args.verbose?1:args.verbose,_a=base_callbacks_1.configureCallbacks(callbacks,verbose,args.epochs,null,null,function(dataset,args){var stepsPerEpoch=null;null!=args.batchesPerEpoch?stepsPerEpoch=args.batchesPerEpoch:Number.isFinite(dataset.size)&&(stepsPerEpoch=dataset.size);return stepsPerEpoch}(dataset,args),null,doValidation,callbackMetrics),callbackList=_a.callbackList,history_1=_a.history,callbackList.setModel(model),model.history=history_1,[4,callbackList.onTrainBegin()];case 2:return _f.sent(),model.stopTraining_=!1,epoch=null==args.initialEpoch?0:args.initialEpoch,[4,dataset.iterator()];case 3:dataIterator=_f.sent(),_f.label=4;case 4:return epoch<args.epochs?(epochLogs={},[4,callbackList.onEpochBegin(epoch)]):[3,23];case 5:return _f.sent(),batchIndex=stepsDone=0,hasBatchesPerEpoch?[3,7]:[4,dataset.iterator()];case 6:dataIterator=_f.sent(),_f.label=7;case 7:return!hasBatchesPerEpoch||stepsDone<args.batchesPerEpoch?[4,dataIterator.next()]:[3,21];case 8:return iteratorOut=_f.sent(),hasBatchesPerEpoch&&iteratorOut.done?(console.warn("You provided `batchesPerEpoch` as "+args.batchesPerEpoch+", but your dataset iterator ran out of data after "+stepsDone+" batches; interrupting training. Make sure that your dataset can generate at least `batchesPerEpoch * epochs` batches (in this case, "+args.batchesPerEpoch*args.epochs+" batches). You may need to use the repeat() function when building your dataset."),[3,21]):null==iteratorOut.value?[3,15]:(_b=standardizeDataIteratorOutput(model,iteratorOut.value),xs=_b.xs,ys=_b.ys,(batchLogs={}).batch=batchIndex,batchLogs.size=xs[0].shape[0],[4,callbackList.onBatchBegin(batchIndex,batchLogs)]);case 9:if(_f.sent(),sampleWeights=[],null==args.classWeight)return[3,13];standardClassWeights=training_utils_1.standardizeClassWeights(args.classWeight,model.outputNames),i=0,_f.label=10;case 10:return i<standardClassWeights.length?(_d=(_c=sampleWeights).push,[4,training_utils_1.standardizeWeights(ys[i],null,standardClassWeights[i])]):[3,13];case 11:_d.apply(_c,[_f.sent()]),_f.label=12;case 12:return++i,[3,10];case 13:for(ins=xs.concat(ys).concat(sampleWeights),outs=trainFunction(ins),tfc.dispose(ins),i=0;i<outLabels.length;++i)label=outLabels[i],out=outs[i],batchLogs[label]=out,tfc.keep(out);return[4,callbackList.onBatchEnd(batchIndex,batchLogs)];case 14:_f.sent(),logs_1.disposeTensorsInLogs(batchLogs),batchIndex++,stepsDone++,_f.label=15;case 15:return(hasBatchesPerEpoch?stepsDone>=args.batchesPerEpoch:iteratorOut.done)?doValidation?(valOuts=void 0,isDatasetObject(args.validationData)?(_e=generic_utils_1.toList,[4,model.evaluateDataset(args.validationData,{batches:args.validationBatches})]):[3,17]):[3,19]:[3,20];case 16:return valOuts=_e.apply(void 0,[_f.sent()]),[3,18];case 17:valOuts=generic_utils_1.toList(model.evaluate(valXs,valYs,{batchSize:null==args.validationBatchSize?DEFAULT_VALIDATION_BATCH_SIZE:args.validationBatchSize,verbose:0})),_f.label=18;case 18:for(i=0;i<model.metricsNames.length;++i)epochLogs["val_"+model.metricsNames[i]]=valOuts[i];_f.label=19;case 19:return[3,21];case 20:return model.stopTraining_?[3,21]:[3,7];case 21:return[4,callbackList.onEpochEnd(epoch,epochLogs)];case 22:return _f.sent(),epoch++,model.stopTraining_?[3,23]:[3,4];case 23:return[4,callbackList.onTrainEnd()];case 24:return _f.sent(),[4,model.history.syncData()];case 25:return _f.sent(),[2,model.history];case 26:return model.isTraining=!1,[7];case 27:return[2]}})})},exports.evaluateDataset=function(model,dataset,args){return __awaiter(this,void 0,void 0,function(){var hasBatches,f,outs,dataIterator,_a,numExamples,batch,_loop_3,i,oldScalar;return __generator(this,function(_b){switch(_b.label){case 0:if(hasBatches=null!=(args=args||{}).batches,f=model.testFunction,outs=[],0<args.verbose)throw new errors_1.NotImplementedError("Verbose mode is not implemented yet.");return tfc.util.assert(!hasBatches||0<args.batches&&Number.isInteger(args.batches),function(){return"Test loop expects `batches` to be a positive integer, but received "+JSON.stringify(args.batches)}),function(iterator){return"function"==typeof iterator.next}(dataset)?(_a=dataset,[3,3]):[3,1];case 1:return[4,dataset.iterator()];case 2:_a=_b.sent(),_b.label=3;case 3:dataIterator=_a,batch=numExamples=0,_loop_3=function(){var iteratorOut;return __generator(this,function(_a){switch(_a.label){case 0:return[4,dataIterator.next()];case 1:return iteratorOut=_a.sent(),outs=tfc.tidy(function(){if(iteratorOut.value){var _a=standardizeDataIteratorOutput(model,iteratorOut.value),xs=_a.xs,ys=_a.ys,xsAndYs_1=xs.concat(ys),batchOuts=tfc.tidy(function(){return f(xsAndYs_1)});if(tfc.dispose(xsAndYs_1),0===batch)for(var i=0;i<batchOuts.length;++i)outs.push(tfjs_core_1.scalar(0));var batchSize_1=xsAndYs_1[0].shape[0],_loop_4=function(i){var batchOut=batchOuts[i],oldScalar=outs[i];outs[i]=tfc.tidy(function(){return tfc.add(outs[i],tfc.mul(batchSize_1,batchOut))}),0<batch&&tfc.dispose(oldScalar)};for(i=0;i<batchOuts.length;++i)_loop_4(i);tfc.dispose(batchOuts),numExamples+=batchSize_1,++batch}return outs}),iteratorOut.done?(hasBatches&&console.warn("Your dataset iterator ran out of data during evaluateDataset(). Interrupting evalution. Make sure that your dataset can generate at least `batches` batches (in this case, "+args.batches+" batches). You may need to use the repeat() function when building your dataset."),[2,"break"]):[2]}})},_b.label=4;case 4:return!hasBatches||batch<args.batches?[5,_loop_3()]:[3,6];case 5:return"break"===_b.sent()?[3,6]:[3,4];case 6:for(i=0;i<outs.length;++i)oldScalar=outs[i],outs[i]=tfc.div(outs[i],numExamples),tfc.dispose(oldScalar);return[2,generic_utils_1.singletonOrArray(outs)]}})})}},{"../base_callbacks":277,"../errors":289,"../logs":314,"../utils/generic_utils":322,"./training_utils":288,"@tensorflow/tfjs-core":148}],287:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),tfjs_backend_1=require("../backend/tfjs_backend"),base_callbacks_1=require("../base_callbacks"),errors_1=require("../errors"),logs_1=require("../logs"),math_utils_1=require("../utils/math_utils");function checkBatchSize(batchSize){tfc.util.assert(0<batchSize&&Number.isInteger(batchSize),function(){return"batchSize is required to be a positive integer, but got "+batchSize})}function sliceArrays(arrays,start,stop){return null==arrays?[null]:Array.isArray(arrays)?arrays.map(function(array){return tfjs_backend_1.sliceAlongFirstAxis(array,start,stop-start)}):tfjs_backend_1.sliceAlongFirstAxis(arrays,start,stop-start)}function sliceArraysByIndices(arrays,indices){return tfc.tidy(function(){return null==arrays?null:Array.isArray(arrays)?arrays.map(function(array){return sliceArraysByIndices(array,indices)}):tfjs_backend_1.gather(arrays,"int32"===indices.dtype?indices:indices.toInt())})}function makeBatches(size,batchSize){for(var output=[],batchStart=0,batchEnd=null;batchStart<size;)size<=(batchEnd=batchStart+batchSize)&&(batchEnd=size),output.push([batchStart,batchEnd]),batchStart=batchEnd;return output}function disposeNewTensors(tensors,refTensors){if(null!=tensors){var oldTensorIds=[];if(refTensors instanceof tfjs_core_1.Tensor)oldTensorIds.push(refTensors.id);else if(Array.isArray(refTensors))refTensors.forEach(function(t){return oldTensorIds.push(t.id)});else if(null!=refTensors)for(var name_1 in refTensors){var oldTensor=refTensors[name_1];oldTensorIds.push(oldTensor.id)}var tensorsToDispose=[];if(tensors instanceof tfjs_core_1.Tensor)-1===oldTensorIds.indexOf(tensors.id)&&tensorsToDispose.push(tensors);else if(Array.isArray(tensors))tensors.forEach(function(t){-1===oldTensorIds.indexOf(t.id)&&tensorsToDispose.push(t)});else if(null!=tensors)for(var name_2 in tensors){var tensor=tensors[name_2];-1===oldTensorIds.indexOf(tensor.id)&&tensorsToDispose.push(tensor)}tensorsToDispose.forEach(function(t){t.isDisposed||t.dispose()})}}exports.checkBatchSize=checkBatchSize,exports.sliceArrays=sliceArrays,exports.sliceArraysByIndices=sliceArraysByIndices,exports.makeBatches=makeBatches,exports.fitTensors=function(model,x,y,args){return void 0===args&&(args={}),__awaiter(this,void 0,void 0,function(){var inputs,targets,inputValX,inputValY,valX,valY,sampleWeights,batchSize,standardizedOuts,doValidation,valIns,valStandardized,splitAt,originalBatchSize,ins,trainFunction,outLabels,valFunction,callbackMetrics,callbacks;return __generator(this,function(_a){switch(_a.label){case 0:if(model.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");model.isTraining=!0,_a.label=1;case 1:return _a.trys.push([1,,7,8]),checkBatchSize(batchSize=null==args.batchSize?32:args.batchSize),!1,[4,model.standardizeUserData(x,y,args.sampleWeight,args.classWeight,!1,batchSize)];case 2:if(standardizedOuts=_a.sent(),inputs=standardizedOuts[0],targets=standardizedOuts[1],sampleWeights=standardizedOuts[2],doValidation=!1,valIns=void 0,!(null!=args.validationData&&0<args.validationData.length))return[3,4];if(doValidation=!0,2!==args.validationData.length)throw 3===args.validationData.length?new errors_1.NotImplementedError("validationData including sample weights is not supported yet."):new errors_1.ValueError("When passing validation data, it must contain 2 (valX, valY) or 3 (valX, valY, valSampleWeight) items; "+args.validationData+" is invalid.");return inputValX=args.validationData[0],inputValY=args.validationData[1],!0,[4,model.standardizeUserData(inputValX,inputValY,null,null,!0,batchSize)];case 3:return valStandardized=_a.sent(),valX=valStandardized[0],valY=valStandardized[1],valIns=valX.concat(valY),[3,5];case 4:null!=args.validationSplit&&0<args.validationSplit&&args.validationSplit<1?(doValidation=!0,splitAt=Math.floor(inputs[0].shape[0]*(1-args.validationSplit)),originalBatchSize=inputs[0].shape[0],valX=sliceArrays(inputs,splitAt,originalBatchSize),inputs=sliceArrays(inputs,0,splitAt),valY=sliceArrays(targets,splitAt,originalBatchSize),targets=sliceArrays(targets,0,splitAt),valIns=valX.concat(valY)):null!=args.validationSteps&&(doValidation=!0),_a.label=5;case 5:return ins=inputs.concat(targets).concat(sampleWeights),model.checkTrainableWeightsConsistency(),trainFunction=model.makeTrainFunction(),outLabels=model.getDedupedMetricsNames(),callbackMetrics=valFunction=void 0,callbackMetrics=doValidation?(model.makeTestFunction(),valFunction=model.testFunction,outLabels.slice().concat(outLabels.map(function(n){return"val_"+n}))):(valFunction=null,valIns=[],outLabels.slice()),callbacks=base_callbacks_1.standardizeCallbacks(args.callbacks,args.yieldEvery),[4,function(model,f,ins,outLabels,batchSize,epochs,verbose,callbacks,valF,valIns,shuffle,callbackMetrics,initialEpoch,stepsPerEpoch,validationSteps){return __awaiter(this,void 0,void 0,function(){var doValidation,numTrainSamples,indexArray,_a,callbackList,history,_loop_1,epoch;return __generator(this,function(_b){switch(_b.label){case 0:if(null==batchSize&&(batchSize=32),null==epochs&&(epochs=1),null==shuffle&&(shuffle=!0),null==initialEpoch&&(initialEpoch=0),doValidation=!1,null!=valF&&null!=valIns&&(doValidation=!0),null!=validationSteps&&(doValidation=!0,null==stepsPerEpoch))throw new errors_1.ValueError("Can only use `validationSteps` when doing step-wise training, i.e., `stepsPerEpoch` must be set.");return null!=(numTrainSamples=model.checkNumSamples(ins,batchSize,stepsPerEpoch,"steps_per_epoch"))&&(indexArray=math_utils_1.range(0,numTrainSamples)),null==verbose&&(verbose=1),_a=base_callbacks_1.configureCallbacks(callbacks,verbose,epochs,initialEpoch,numTrainSamples,stepsPerEpoch,batchSize,doValidation,callbackMetrics),callbackList=_a.callbackList,history=_a.history,callbackList.setModel(model),model.history=history,[4,callbackList.onTrainBegin()];case 1:_b.sent(),model.stopTraining_=!1,_loop_1=function(epoch){var epochLogs,epochIndexArray1D_1,batches_1,_loop_2,batchIndex;return __generator(this,function(_a){switch(_a.label){case 0:return[4,callbackList.onEpochBegin(epoch)];case 1:if(_a.sent(),epochLogs={},null==stepsPerEpoch)return[3,2];throw new errors_1.NotImplementedError("stepsPerEpoch mode is not implemented yet.");case 2:if("batch"===shuffle)throw new errors_1.NotImplementedError("batch shuffling is not implemneted yet");shuffle&&tfjs_core_1.util.shuffle(indexArray),epochIndexArray1D_1=tfjs_core_1.tensor1d(indexArray),batches_1=makeBatches(numTrainSamples,batchSize),_loop_2=function(batchIndex){var batchLogs;return __generator(this,function(_a){switch(_a.label){case 0:return batchLogs={},[4,callbackList.onBatchBegin(batchIndex,batchLogs)];case 1:return _a.sent(),tfc.tidy(function(){var batchStart=batches_1[batchIndex][0],batchEnd=batches_1[batchIndex][1],batchIds=tfjs_backend_1.sliceAlongFirstAxis(epochIndexArray1D_1,batchStart,batchEnd-batchStart);batchLogs.batch=batchIndex,batchLogs.size=batchEnd-batchStart;for(var insBatch=sliceArraysByIndices(ins,batchIds),outs=f(insBatch),i=0;i<outLabels.length;++i){var label=outLabels[i],out=outs[i];batchLogs[label]=out,tfc.keep(out)}if(batchIndex===batches_1.length-1&&doValidation){var valOuts=model.testLoop(valF,valIns,batchSize);for(i=0;i<outLabels.length;++i){label=outLabels[i],out=valOuts[i];tfc.keep(out),epochLogs["val_"+label]=out}}}),[4,callbackList.onBatchEnd(batchIndex,batchLogs)];case 2:return _a.sent(),logs_1.disposeTensorsInLogs(batchLogs),model.stopTraining_?[2,"break"]:[2]}})},batchIndex=0,_a.label=3;case 3:return batchIndex<batches_1.length?[5,_loop_2(batchIndex)]:[3,6];case 4:if("break"===_a.sent())return[3,6];_a.label=5;case 5:return++batchIndex,[3,3];case 6:epochIndexArray1D_1.dispose(),_a.label=7;case 7:return[4,callbackList.onEpochEnd(epoch,epochLogs)];case 8:return _a.sent(),model.stopTraining_?[2,"break"]:[2]}})},epoch=initialEpoch,_b.label=2;case 2:return epoch<epochs?[5,_loop_1(epoch)]:[3,5];case 3:if("break"===_b.sent())return[3,5];_b.label=4;case 4:return++epoch,[3,2];case 5:return[4,callbackList.onTrainEnd()];case 6:return _b.sent(),[4,model.history.syncData()];case 7:return _b.sent(),[2,model.history]}})})}(model,trainFunction,ins,outLabels,batchSize,args.epochs,args.verbose,callbacks,valFunction,valIns,args.shuffle,callbackMetrics,args.initialEpoch,null,null)];case 6:return[2,_a.sent()];case 7:return model.isTraining=!1,disposeNewTensors(inputs,x),disposeNewTensors(targets,y),disposeNewTensors(valX,inputValX),disposeNewTensors(valY,inputValY),null!=sampleWeights&&tfc.dispose(sampleWeights),[7];case 8:return[2]}})})},exports.ensureTensorsRank2OrHigher=function(tensors){var outs=[];tensors instanceof tfjs_core_1.Tensor&&(tensors=[tensors]);for(var i=0;i<tensors.length;++i){var tensor=tensors[i];if(1===tensor.rank)outs.push(tfjs_backend_1.expandDims(tensor,1));else{if(0===tensor.rank)throw new Error("Expected tensor to be at least 1D, but received a 0D tensor (scalar).");outs.push(tensor)}}return outs},exports.disposeNewTensors=disposeNewTensors},{"../backend/tfjs_backend":276,"../base_callbacks":277,"../errors":289,"../logs":314,"../utils/math_utils":324,"@tensorflow/tfjs-core":148}],288:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core");function standardizeSampleOrClassWeights(xWeight,outputNames,weightType){var numOutputs=outputNames.length;if(null==xWeight||Array.isArray(xWeight)&&0===xWeight.length)return outputNames.map(function(name){return null});if(1===numOutputs)return Array.isArray(xWeight)&&1===xWeight.length?xWeight:"object"==typeof xWeight&&outputNames[0]in xWeight?[xWeight[outputNames[0]]]:[xWeight];if(Array.isArray(xWeight)){if(xWeight.length!==numOutputs)throw new Error("Provided "+weightType+" is an array of "+xWeight.length+" element(s), but the model has "+numOutputs+" outputs. Make sure a set of weights is provided for each model output.");return xWeight}if("object"==typeof xWeight&&0<Object.keys(xWeight).length&&"object"==typeof xWeight[Object.keys(xWeight)[0]]){var output_1=[];return outputNames.forEach(function(outputName){outputName in xWeight?output_1.push(xWeight[outputName]):output_1.push(null)}),output_1}throw new Error("The model has multiple ("+numOutputs+") outputs, so "+weightType+" must be either an array with "+numOutputs+" elements or an object with "+outputNames+" keys. Provided "+weightType+" not understood: "+JSON.stringify(xWeight))}exports.standardizeClassWeights=function(classWeight,outputNames){return standardizeSampleOrClassWeights(classWeight,outputNames,"classWeight")},exports.standardizeSampleWeights=function(classWeight,outputNames){return standardizeSampleOrClassWeights(classWeight,outputNames,"sampleWeight")},exports.standardizeWeights=function(y,sampleWeight,classWeight,sampleWeightMode){return __awaiter(this,void 0,void 0,function(){var yClasses,yClassIndices,_a,_b,classSampleWeight_1;return __generator(this,function(_c){switch(_c.label){case 0:if(null!=sampleWeight||null!=sampleWeightMode)throw new Error("Support sampleWeight is not implemented yet");return null==classWeight?[3,2]:(yClasses=tfjs_core_1.tidy(function(){if(1===y.shape.length)return y.clone();if(2!==y.shape.length)throw new Error("Unexpected rank of target (y) tensor ("+y.rank+") during handling of class weights. The rank is expected to be 1 or 2.");if(1<y.shape[1]){return y.argMax(1)}if(1===y.shape[1])return y.reshape([y.shape[0]]);throw new Error("Encountered unexpected last-dimension size ("+y.shape[1]+") during handling of class weights. The size is expected to be >= 1.")}),_b=(_a=Array).from,[4,yClasses.data()]);case 1:return yClassIndices=_b.apply(_a,[_c.sent()]),tfjs_core_1.dispose(yClasses),classSampleWeight_1=[],yClassIndices.forEach(function(classIndex){if(null==classWeight[classIndex])throw new Error("classWeight must contain all classes in the training data. The class "+classIndex+" exists in the data but not in classWeight");classSampleWeight_1.push(classWeight[classIndex])}),[2,tfjs_core_1.tensor1d(classSampleWeight_1,"float32")];case 2:return[2,null]}})})},exports.computeWeightedLoss=function(losses,sampleWeights){return tfjs_core_1.mul(losses,sampleWeights)}},{"@tensorflow/tfjs-core":148}],289:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var AttributeError=function(_super){function AttributeError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,AttributeError.prototype),_this}return __extends(AttributeError,_super),AttributeError}(Error);exports.AttributeError=AttributeError;var RuntimeError=function(_super){function RuntimeError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,RuntimeError.prototype),_this}return __extends(RuntimeError,_super),RuntimeError}(Error);exports.RuntimeError=RuntimeError;var ValueError=function(_super){function ValueError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,ValueError.prototype),_this}return __extends(ValueError,_super),ValueError}(Error);exports.ValueError=ValueError;var NotImplementedError=function(_super){function NotImplementedError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,NotImplementedError.prototype),_this}return __extends(NotImplementedError,_super),NotImplementedError}(Error);exports.NotImplementedError=NotImplementedError;var AssertionError=function(_super){function AssertionError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,AssertionError.prototype),_this}return __extends(AssertionError,_super),AssertionError}(Error);exports.AssertionError=AssertionError;var IndexError=function(_super){function IndexError(message){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,IndexError.prototype),_this}return __extends(IndexError,_super),IndexError}(Error);exports.IndexError=IndexError},{}],290:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var base_callbacks_1=require("./base_callbacks"),input_layer_1=require("./engine/input_layer"),training_1=require("./engine/training"),models_1=require("./models");exports.model=function(args){return new training_1.LayersModel(args)},exports.sequential=function(config){return new models_1.Sequential(config)},exports.loadLayersModel=function(pathOrIOHandler,options){return null==options&&(options={}),models_1.loadLayersModelInternal(pathOrIOHandler,options)},exports.input=function(config){return input_layer_1.Input(config)},exports.registerCallbackConstructor=function(verbosityLevel,callbackConstructor){base_callbacks_1.CallbackConstructorRegistry.registerCallbackConstructor(verbosityLevel,callbackConstructor)}},{"./base_callbacks":277,"./engine/input_layer":283,"./engine/training":285,"./models":317}],291:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constraints_1=require("./constraints");exports.maxNorm=function(args){return new constraints_1.MaxNorm(args)},exports.unitNorm=function(args){return new constraints_1.UnitNorm(args)},exports.nonNeg=function(){return new constraints_1.NonNeg},exports.minMaxNorm=function(config){return new constraints_1.MinMaxNorm(config)}},{"./constraints":280}],292:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var initializers_1=require("./initializers");exports.zeros=function(){return new initializers_1.Zeros},exports.ones=function(){return new initializers_1.Ones},exports.constant=function(args){return new initializers_1.Constant(args)},exports.randomUniform=function(args){return new initializers_1.RandomUniform(args)},exports.randomNormal=function(args){return new initializers_1.RandomNormal(args)},exports.truncatedNormal=function(args){return new initializers_1.TruncatedNormal(args)},exports.identity=function(args){return new initializers_1.Identity(args)},exports.varianceScaling=function(config){return new initializers_1.VarianceScaling(config)},exports.glorotUniform=function(args){return new initializers_1.GlorotUniform(args)},exports.glorotNormal=function(args){return new initializers_1.GlorotNormal(args)},exports.heNormal=function(args){return new initializers_1.HeNormal(args)},exports.heUniform=function(args){return new initializers_1.HeUniform(args)},exports.leCunNormal=function(args){return new initializers_1.LeCunNormal(args)},exports.leCunUniform=function(args){return new initializers_1.LeCunUniform(args)},exports.orthogonal=function(args){return new initializers_1.Orthogonal(args)}},{"./initializers":298}],293:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var input_layer_1=require("./engine/input_layer"),topology_1=require("./engine/topology");exports.Layer=topology_1.Layer;var exports_1=require("./exports");exports.input=exports_1.input;var advanced_activations_1=require("./layers/advanced_activations"),convolutional_1=require("./layers/convolutional"),convolutional_depthwise_1=require("./layers/convolutional_depthwise"),core_1=require("./layers/core"),embeddings_1=require("./layers/embeddings"),merge_1=require("./layers/merge"),noise_1=require("./layers/noise"),normalization_1=require("./layers/normalization"),padding_1=require("./layers/padding"),pooling_1=require("./layers/pooling"),recurrent_1=require("./layers/recurrent");exports.RNN=recurrent_1.RNN,exports.RNNCell=recurrent_1.RNNCell;var wrappers_1=require("./layers/wrappers");function averagePooling1d(args){return new pooling_1.AveragePooling1D(args)}function averagePooling2d(args){return new pooling_1.AveragePooling2D(args)}function averagePooling3d(args){return new pooling_1.AveragePooling3D(args)}function globalMaxPooling1d(args){return new pooling_1.GlobalMaxPooling1D(args)}function globalMaxPooling2d(args){return new pooling_1.GlobalMaxPooling2D(args)}function maxPooling1d(args){return new pooling_1.MaxPooling1D(args)}function maxPooling2d(args){return new pooling_1.MaxPooling2D(args)}exports.inputLayer=function(args){return new input_layer_1.InputLayer(args)},exports.elu=function(args){return new advanced_activations_1.ELU(args)},exports.reLU=function(args){return new advanced_activations_1.ReLU(args)},exports.leakyReLU=function(args){return new advanced_activations_1.LeakyReLU(args)},exports.prelu=function(args){return new advanced_activations_1.PReLU(args)},exports.softmax=function(args){return new advanced_activations_1.Softmax(args)},exports.thresholdedReLU=function(args){return new advanced_activations_1.ThresholdedReLU(args)},exports.conv1d=function(args){return new convolutional_1.Conv1D(args)},exports.conv2d=function(args){return new convolutional_1.Conv2D(args)},exports.conv2dTranspose=function(args){return new convolutional_1.Conv2DTranspose(args)},exports.conv3d=function(args){return new convolutional_1.Conv3D(args)},exports.separableConv2d=function(args){return new convolutional_1.SeparableConv2D(args)},exports.cropping2D=function(args){return new convolutional_1.Cropping2D(args)},exports.upSampling2d=function(args){return new convolutional_1.UpSampling2D(args)},exports.depthwiseConv2d=function(args){return new convolutional_depthwise_1.DepthwiseConv2D(args)},exports.activation=function(args){return new core_1.Activation(args)},exports.dense=function(args){return new core_1.Dense(args)},exports.dropout=function(args){return new core_1.Dropout(args)},exports.flatten=function(args){return new core_1.Flatten(args)},exports.repeatVector=function(args){return new core_1.RepeatVector(args)},exports.reshape=function(args){return new core_1.Reshape(args)},exports.permute=function(args){return new core_1.Permute(args)},exports.embedding=function(args){return new embeddings_1.Embedding(args)},exports.add=function(args){return new merge_1.Add(args)},exports.average=function(args){return new merge_1.Average(args)},exports.concatenate=function(args){return new merge_1.Concatenate(args)},exports.maximum=function(args){return new merge_1.Maximum(args)},exports.minimum=function(args){return new merge_1.Minimum(args)},exports.multiply=function(args){return new merge_1.Multiply(args)},exports.dot=function(args){return new merge_1.Dot(args)},exports.batchNormalization=function(args){return new normalization_1.BatchNormalization(args)},exports.zeroPadding2d=function(args){return new padding_1.ZeroPadding2D(args)},exports.averagePooling1d=averagePooling1d,exports.avgPool1d=function(args){return averagePooling1d(args)},exports.avgPooling1d=function(args){return averagePooling1d(args)},exports.averagePooling2d=averagePooling2d,exports.avgPool2d=function(args){return averagePooling2d(args)},exports.avgPooling2d=function(args){return averagePooling2d(args)},exports.averagePooling3d=averagePooling3d,exports.avgPool3d=function(args){return averagePooling3d(args)},exports.avgPooling3d=function(args){return averagePooling3d(args)},exports.globalAveragePooling1d=function(args){return new pooling_1.GlobalAveragePooling1D(args)},exports.globalAveragePooling2d=function(args){return new pooling_1.GlobalAveragePooling2D(args)},exports.globalMaxPooling1d=globalMaxPooling1d,exports.globalMaxPooling2d=globalMaxPooling2d,exports.maxPooling1d=maxPooling1d,exports.maxPooling2d=maxPooling2d,exports.maxPooling3d=function(args){return new pooling_1.MaxPooling3D(args)},exports.gru=function(args){return new recurrent_1.GRU(args)},exports.gruCell=function(args){return new recurrent_1.GRUCell(args)},exports.lstm=function(args){return new recurrent_1.LSTM(args)},exports.lstmCell=function(args){return new recurrent_1.LSTMCell(args)},exports.simpleRNN=function(args){return new recurrent_1.SimpleRNN(args)},exports.simpleRNNCell=function(args){return new recurrent_1.SimpleRNNCell(args)},exports.rnn=function(args){return new recurrent_1.RNN(args)},exports.stackedRNNCells=function(args){return new recurrent_1.StackedRNNCells(args)},exports.bidirectional=function(args){return new wrappers_1.Bidirectional(args)},exports.timeDistributed=function(args){return new wrappers_1.TimeDistributed(args)},exports.globalMaxPool1d=globalMaxPooling1d,exports.globalMaxPool2d=globalMaxPooling2d,exports.maxPool1d=maxPooling1d,exports.maxPool2d=maxPooling2d,exports.gaussianNoise=function(args){return new noise_1.GaussianNoise(args)},exports.gaussianDropout=function(args){return new noise_1.GaussianDropout(args)},exports.alphaDropout=function(args){return new noise_1.AlphaDropout(args)},exports.masking=function(args){return new core_1.Masking(args)}},{"./engine/input_layer":283,"./engine/topology":284,"./exports":290,"./layers/advanced_activations":301,"./layers/convolutional":302,"./layers/convolutional_depthwise":303,"./layers/core":304,"./layers/embeddings":305,"./layers/merge":306,"./layers/noise":307,"./layers/normalization":308,"./layers/padding":309,"./layers/pooling":310,"./layers/recurrent":311,"./layers/wrappers":313}],294:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var losses=require("./losses"),metrics=require("./metrics");exports.binaryAccuracy=function(yTrue,yPred){return metrics.binaryAccuracy(yTrue,yPred)},exports.binaryCrossentropy=function(yTrue,yPred){return metrics.binaryCrossentropy(yTrue,yPred)},exports.sparseCategoricalAccuracy=function(yTrue,yPred){return metrics.sparseCategoricalAccuracy(yTrue,yPred)},exports.categoricalAccuracy=function(yTrue,yPred){return metrics.categoricalAccuracy(yTrue,yPred)},exports.categoricalCrossentropy=function(yTrue,yPred){return metrics.categoricalCrossentropy(yTrue,yPred)},exports.precision=function(yTrue,yPred){return metrics.precision(yTrue,yPred)},exports.recall=function(yTrue,yPred){return metrics.recall(yTrue,yPred)},exports.cosineProximity=function(yTrue,yPred){return losses.cosineProximity(yTrue,yPred)},exports.meanAbsoluteError=function(yTrue,yPred){return losses.meanAbsoluteError(yTrue,yPred)},exports.meanAbsolutePercentageError=function(yTrue,yPred){return losses.meanAbsolutePercentageError(yTrue,yPred)},exports.MAPE=function(yTrue,yPred){return losses.meanAbsolutePercentageError(yTrue,yPred)},exports.mape=function(yTrue,yPred){return losses.meanAbsolutePercentageError(yTrue,yPred)},exports.meanSquaredError=function(yTrue,yPred){return losses.meanSquaredError(yTrue,yPred)},exports.MSE=function(yTrue,yPred){return losses.meanSquaredError(yTrue,yPred)},exports.mse=function(yTrue,yPred){return losses.meanSquaredError(yTrue,yPred)}},{"./losses":315,"./metrics":316}],295:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var models_1=require("./models");exports.modelFromJSON=models_1.modelFromJSON},{"./models":317}],296:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var regularizers=require("./regularizers"),regularizers_1=require("./regularizers");exports.l1l2=function(config){return new regularizers_1.L1L2(config)},exports.l1=function(config){return regularizers.l1(config)},exports.l2=function(config){return regularizers.l2(config)}},{"./regularizers":319}],297:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constraints=require("./exports_constraints");exports.constraints=constraints;var initializers=require("./exports_initializers");exports.initializers=initializers;var layers=require("./exports_layers");exports.layers=layers;var metrics=require("./exports_metrics");exports.metrics=metrics;var models=require("./exports_models");exports.models=models;var regularizers=require("./exports_regularizers");exports.regularizers=regularizers;var base_callbacks_1=require("./base_callbacks");exports.CallbackList=base_callbacks_1.CallbackList,exports.CustomCallback=base_callbacks_1.CustomCallback,exports.History=base_callbacks_1.History;var callbacks_1=require("./callbacks");exports.Callback=callbacks_1.Callback,exports.callbacks=callbacks_1.callbacks,exports.EarlyStopping=callbacks_1.EarlyStopping;var topology_1=require("./engine/topology");exports.InputSpec=topology_1.InputSpec,exports.SymbolicTensor=topology_1.SymbolicTensor;var training_1=require("./engine/training");exports.LayersModel=training_1.LayersModel;var exports_1=require("./exports");exports.input=exports_1.input,exports.loadLayersModel=exports_1.loadLayersModel,exports.model=exports_1.model,exports.registerCallbackConstructor=exports_1.registerCallbackConstructor,exports.sequential=exports_1.sequential;var recurrent_1=require("./layers/recurrent");exports.RNN=recurrent_1.RNN;var models_1=require("./models");exports.Sequential=models_1.Sequential;var variables_1=require("./variables");exports.LayerVariable=variables_1.LayerVariable;var version_1=require("./version");exports.version_layers=version_1.version},{"./base_callbacks":277,"./callbacks":278,"./engine/topology":284,"./engine/training":285,"./exports":290,"./exports_constraints":291,"./exports_initializers":292,"./exports_layers":293,"./exports_metrics":294,"./exports_models":295,"./exports_regularizers":296,"./layers/recurrent":311,"./models":317,"./variables":328,"./version":329}],298:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),common_1=require("./common"),errors_1=require("./errors"),initializer_config_1=require("./keras_format/initializer_config"),generic_utils_1=require("./utils/generic_utils"),math_utils_1=require("./utils/math_utils");function checkFanMode(value){generic_utils_1.checkStringTypeUnionValue(initializer_config_1.VALID_FAN_MODE_VALUES,"FanMode",value)}function checkDistribution(value){generic_utils_1.checkStringTypeUnionValue(initializer_config_1.VALID_DISTRIBUTION_VALUES,"Distribution",value)}exports.checkFanMode=checkFanMode,exports.checkDistribution=checkDistribution;var Initializer=function(_super){function Initializer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Initializer,_super),Initializer.prototype.fromConfigUsesCustomObjects=function(){return!1},Initializer.prototype.getConfig=function(){return{}},Initializer}(tfjs_core_1.serialization.Serializable),Zeros=function(_super){function Zeros(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Zeros,_super),Zeros.prototype.apply=function(shape,dtype){return tfjs_core_1.zeros(shape,dtype)},Zeros.className="Zeros",Zeros}(exports.Initializer=Initializer);exports.Zeros=Zeros,tfjs_core_1.serialization.registerClass(Zeros);var Ones=function(_super){function Ones(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Ones,_super),Ones.prototype.apply=function(shape,dtype){return tfjs_core_1.ones(shape,dtype)},Ones.className="Ones",Ones}(Initializer);exports.Ones=Ones,tfjs_core_1.serialization.registerClass(Ones);var Constant=function(_super){function Constant(args){var _this=_super.call(this)||this;if("object"!=typeof args)throw new errors_1.ValueError("Expected argument of type ConstantConfig but got "+args);if(void 0===args.value)throw new errors_1.ValueError("config must have value set but got "+args);return _this.value=args.value,_this}return __extends(Constant,_super),Constant.prototype.apply=function(shape,dtype){var _this=this;return tfjs_core_1.tidy(function(){return tfjs_core_1.mul(tfjs_core_1.scalar(_this.value),tfjs_core_1.ones(shape,dtype))})},Constant.prototype.getConfig=function(){return{value:this.value}},Constant.className="Constant",Constant}(Initializer);exports.Constant=Constant,tfjs_core_1.serialization.registerClass(Constant);var RandomUniform=function(_super){function RandomUniform(args){var _this=_super.call(this)||this;return _this.DEFAULT_MINVAL=-.05,_this.DEFAULT_MAXVAL=.05,_this.minval=args.minval||_this.DEFAULT_MINVAL,_this.maxval=args.maxval||_this.DEFAULT_MAXVAL,_this.seed=args.seed,_this}return __extends(RandomUniform,_super),RandomUniform.prototype.apply=function(shape,dtype){return tfjs_core_1.randomUniform(shape,this.minval,this.maxval,dtype)},RandomUniform.prototype.getConfig=function(){return{minval:this.minval,maxval:this.maxval,seed:this.seed}},RandomUniform.className="RandomUniform",RandomUniform}(Initializer);exports.RandomUniform=RandomUniform,tfjs_core_1.serialization.registerClass(RandomUniform);var RandomNormal=function(_super){function RandomNormal(args){var _this=_super.call(this)||this;return _this.DEFAULT_MEAN=0,_this.DEFAULT_STDDEV=.05,_this.mean=args.mean||_this.DEFAULT_MEAN,_this.stddev=args.stddev||_this.DEFAULT_STDDEV,_this.seed=args.seed,_this}return __extends(RandomNormal,_super),RandomNormal.prototype.apply=function(shape,dtype){if("float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("randomNormal does not support dType "+dtype+".");return K.randomNormal(shape,this.mean,this.stddev,dtype,this.seed)},RandomNormal.prototype.getConfig=function(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}},RandomNormal.className="RandomNormal",RandomNormal}(Initializer);exports.RandomNormal=RandomNormal,tfjs_core_1.serialization.registerClass(RandomNormal);var TruncatedNormal=function(_super){function TruncatedNormal(args){var _this=_super.call(this)||this;return _this.DEFAULT_MEAN=0,_this.DEFAULT_STDDEV=.05,_this.mean=args.mean||_this.DEFAULT_MEAN,_this.stddev=args.stddev||_this.DEFAULT_STDDEV,_this.seed=args.seed,_this}return __extends(TruncatedNormal,_super),TruncatedNormal.prototype.apply=function(shape,dtype){if("float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("truncatedNormal does not support dType "+dtype+".");return tfjs_core_1.truncatedNormal(shape,this.mean,this.stddev,dtype,this.seed)},TruncatedNormal.prototype.getConfig=function(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}},TruncatedNormal.className="TruncatedNormal",TruncatedNormal}(Initializer);exports.TruncatedNormal=TruncatedNormal,tfjs_core_1.serialization.registerClass(TruncatedNormal);var Identity=function(_super){function Identity(args){var _this=_super.call(this)||this;return _this.gain=null!=args.gain?args.gain:1,_this}return __extends(Identity,_super),Identity.prototype.apply=function(shape,dtype){var _this=this;return tfjs_core_1.tidy(function(){if(2!==shape.length||shape[0]!==shape[1])throw new errors_1.ValueError("Identity matrix initializer can only be used for 2D square matrices.");return tfjs_core_1.mul(_this.gain,tfjs_core_1.eye(shape[0]))})},Identity.prototype.getConfig=function(){return{gain:this.gain}},Identity.className="Identity",Identity}(Initializer);exports.Identity=Identity,tfjs_core_1.serialization.registerClass(Identity);var VarianceScaling=function(_super){function VarianceScaling(args){var _this=_super.call(this)||this;if(args.scale<0)throw new errors_1.ValueError("scale must be a positive float. Got: "+args.scale);return _this.scale=null==args.scale?1:args.scale,_this.mode=null==args.mode?"fanIn":args.mode,checkFanMode(_this.mode),_this.distribution=null==args.distribution?"normal":args.distribution,checkDistribution(_this.distribution),_this.seed=args.seed,_this}return __extends(VarianceScaling,_super),VarianceScaling.prototype.apply=function(shape,dtype){var fans=function(shape,dataFormat){var fanIn,fanOut;if(void 0===dataFormat&&(dataFormat="channelsLast"),common_1.checkDataFormat(dataFormat),2===shape.length)fanIn=shape[0],fanOut=shape[1];else if(-1!==[3,4,5].indexOf(shape.length)){if("channelsFirst"===dataFormat){var receptiveFieldSize=math_utils_1.arrayProd(shape,2);fanIn=shape[1]*receptiveFieldSize,fanOut=shape[0]*receptiveFieldSize}else if("channelsLast"===dataFormat){receptiveFieldSize=math_utils_1.arrayProd(shape,0,shape.length-2);fanIn=shape[shape.length-2]*receptiveFieldSize,fanOut=shape[shape.length-1]*receptiveFieldSize}}else{var shapeProd=math_utils_1.arrayProd(shape);fanIn=Math.sqrt(shapeProd),fanOut=Math.sqrt(shapeProd)}return[fanIn,fanOut]}(shape),fanIn=fans[0],fanOut=fans[1],scale=this.scale;if("fanIn"===this.mode?scale/=Math.max(1,fanIn):"fanOut"===this.mode?scale/=Math.max(1,fanOut):scale/=Math.max(1,(fanIn+fanOut)/2),"normal"===this.distribution){var stddev=Math.sqrt(scale);if("float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError(this.getClassName()+" does not support dType "+dtype+".");return tfjs_core_1.truncatedNormal(shape,0,stddev,dtype,this.seed)}var limit=Math.sqrt(3*scale);return tfjs_core_1.randomUniform(shape,-limit,limit,dtype)},VarianceScaling.prototype.getConfig=function(){return{scale:this.scale,mode:this.mode,distribution:this.distribution,seed:this.seed}},VarianceScaling.className="VarianceScaling",VarianceScaling}(Initializer);exports.VarianceScaling=VarianceScaling,tfjs_core_1.serialization.registerClass(VarianceScaling);var GlorotUniform=function(_super){function GlorotUniform(args){return _super.call(this,{scale:1,mode:"fanAvg",distribution:"uniform",seed:null==args?null:args.seed})||this}return __extends(GlorotUniform,_super),GlorotUniform.prototype.getClassName=function(){return VarianceScaling.className},GlorotUniform.className="GlorotUniform",GlorotUniform}(VarianceScaling);exports.GlorotUniform=GlorotUniform,tfjs_core_1.serialization.registerClass(GlorotUniform);var GlorotNormal=function(_super){function GlorotNormal(args){return _super.call(this,{scale:1,mode:"fanAvg",distribution:"normal",seed:null==args?null:args.seed})||this}return __extends(GlorotNormal,_super),GlorotNormal.prototype.getClassName=function(){return VarianceScaling.className},GlorotNormal.className="GlorotNormal",GlorotNormal}(VarianceScaling);exports.GlorotNormal=GlorotNormal,tfjs_core_1.serialization.registerClass(GlorotNormal);var HeNormal=function(_super){function HeNormal(args){return _super.call(this,{scale:2,mode:"fanIn",distribution:"normal",seed:null==args?null:args.seed})||this}return __extends(HeNormal,_super),HeNormal.prototype.getClassName=function(){return VarianceScaling.className},HeNormal.className="HeNormal",HeNormal}(VarianceScaling);exports.HeNormal=HeNormal,tfjs_core_1.serialization.registerClass(HeNormal);var HeUniform=function(_super){function HeUniform(args){return _super.call(this,{scale:2,mode:"fanIn",distribution:"uniform",seed:null==args?null:args.seed})||this}return __extends(HeUniform,_super),HeUniform.prototype.getClassName=function(){return VarianceScaling.className},HeUniform.className="HeUniform",HeUniform}(VarianceScaling);exports.HeUniform=HeUniform,tfjs_core_1.serialization.registerClass(HeUniform);var LeCunNormal=function(_super){function LeCunNormal(args){return _super.call(this,{scale:1,mode:"fanIn",distribution:"normal",seed:null==args?null:args.seed})||this}return __extends(LeCunNormal,_super),LeCunNormal.prototype.getClassName=function(){return VarianceScaling.className},LeCunNormal.className="LeCunNormal",LeCunNormal}(VarianceScaling);exports.LeCunNormal=LeCunNormal,tfjs_core_1.serialization.registerClass(LeCunNormal);var LeCunUniform=function(_super){function LeCunUniform(args){return _super.call(this,{scale:1,mode:"fanIn",distribution:"uniform",seed:null==args?null:args.seed})||this}return __extends(LeCunUniform,_super),LeCunUniform.prototype.getClassName=function(){return VarianceScaling.className},LeCunUniform.className="LeCunNormal",LeCunUniform}(VarianceScaling);exports.LeCunUniform=LeCunUniform,tfjs_core_1.serialization.registerClass(LeCunUniform);var Orthogonal=function(_super){function Orthogonal(args){var _this=_super.call(this)||this;if(_this.DEFAULT_GAIN=1,_this.gain=null==args.gain?_this.DEFAULT_GAIN:args.gain,_this.seed=args.seed,null!=_this.seed)throw new errors_1.NotImplementedError("Random seed is not implemented for Orthogonal Initializer yet.");return _this}return __extends(Orthogonal,_super),Orthogonal.prototype.apply=function(shape,dtype){var _this=this;return tfjs_core_1.tidy(function(){if(2!==shape.length)throw new errors_1.NotImplementedError("The Orthogonal Initializer does not support non-2D shapes yet.");2e3<shape[0]*shape[1]&&console.warn("Orthogonal initializer is being called on a matrix with more than 2000 ("+shape[0]*shape[1]+") elements: Slowness may result.");var normalizedShape=shape[0]>shape[1]?[shape[1],shape[0]]:shape,a=K.randomNormal(normalizedShape,0,1,"float32"),q=tfjs_core_1.linalg.gramSchmidt(a);return shape[0]>shape[1]&&(q=q.transpose()),tfjs_core_1.mul(_this.gain,q)})},Orthogonal.prototype.getConfig=function(){return{gain:this.gain,seed:this.seed}},Orthogonal.className="Orthogonal",Orthogonal}(Initializer);function deserializeInitializer(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"initializer")}exports.Orthogonal=Orthogonal,tfjs_core_1.serialization.registerClass(Orthogonal),exports.INITIALIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP={constant:"Constant",glorotNormal:"GlorotNormal",glorotUniform:"GlorotUniform",heNormal:"HeNormal",heUniform:"HeUniform",identity:"Identity",leCunNormal:"LeCunNormal",leCunUniform:"LeCunUniform",ones:"Ones",orthogonal:"Orthogonal",randomNormal:"RandomNormal",randomUniform:"RandomUniform",truncatedNormal:"TruncatedNormal",varianceScaling:"VarianceScaling",zeros:"Zeros"},exports.serializeInitializer=function(initializer){return generic_utils_1.serializeKerasObject(initializer)},exports.getInitializer=function(identifier){if("string"!=typeof identifier)return identifier instanceof Initializer?identifier:deserializeInitializer(identifier);var className=identifier in exports.INITIALIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP?exports.INITIALIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP[identifier]:identifier;if("GlorotNormal"===className)return new GlorotNormal;if("GlorotUniform"===className)return new GlorotUniform;if("HeNormal"===className)return new HeNormal;if("HeUniform"===className)return new HeUniform;if("LeCunNormal"===className)return new LeCunNormal;if("LeCunUniform"===className)return new LeCunUniform;var config={};return config.className=className,config.config={},deserializeInitializer(config)}},{"./backend/tfjs_backend":276,"./common":279,"./errors":289,"./keras_format/initializer_config":300,"./utils/generic_utils":322,"./utils/math_utils":324,"@tensorflow/tfjs-core":148}],299:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VALID_DATA_FORMAT_VALUES=["channelsFirst","channelsLast"],exports.VALID_PADDING_MODE_VALUES=["valid","same","causal"],exports.VALID_POOL_MODE_VALUES=["max","avg"],exports.VALID_BIDIRECTIONAL_MERGE_MODES=["sum","mul","concat","ave"],exports.VALID_SAMPLE_WEIGHT_MODES=["temporal"]},{}],300:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VALID_FAN_MODE_VALUES=["fanIn","fanOut","fanAvg"],exports.VALID_DISTRIBUTION_VALUES=["normal","uniform","truncatedNormal"],exports.initializerClassNames=["Zeros","Ones","Constant","RandomNormal","RandomUniform","TruncatedNormal","VarianceScaling","Orthogonal","Identity"]},{}],301:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),tfjs_backend_1=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),types_utils_1=require("../utils/types_utils"),ReLU=function(_super){function ReLU(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.supportsMasking=!0,null!=args&&(_this.maxValue=args.maxValue),_this}return __extends(ReLU,_super),ReLU.prototype.call=function(inputs,kwargs){inputs=types_utils_1.getExactlyOneTensor(inputs);var output=tfjs_core_1.relu(inputs);return null!=this.maxValue&&(output=tfjs_core_1.clipByValue(output,0,this.maxValue)),output},ReLU.prototype.computeOutputShape=function(inputShape){return inputShape},ReLU.prototype.getConfig=function(){var config={maxValue:this.maxValue},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ReLU.className="ReLU",ReLU}(topology_1.Layer);exports.ReLU=ReLU,tfjs_core_1.serialization.registerClass(ReLU);var LeakyReLU=function(_super){function LeakyReLU(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.DEFAULT_ALPHA=.3,null==args&&(args={}),_this.alpha=null==args.alpha?_this.DEFAULT_ALPHA:args.alpha,_this}return __extends(LeakyReLU,_super),LeakyReLU.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return tfjs_core_1.leakyRelu(x,this.alpha)},LeakyReLU.prototype.computeOutputShape=function(inputShape){return inputShape},LeakyReLU.prototype.getConfig=function(){var config={alpha:this.alpha},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},LeakyReLU.className="LeakyReLU",LeakyReLU}(topology_1.Layer);exports.LeakyReLU=LeakyReLU,tfjs_core_1.serialization.registerClass(LeakyReLU);var PReLU=function(_super){function PReLU(args){var _this=_super.call(this,null==args?{}:args)||this;if(_this.DEFAULT_ALPHA_INITIALIZER="zeros",null==args&&(args={}),_this.supportsMasking=!0,_this.alphaInitializer=initializers_1.getInitializer(args.alphaInitializer||_this.DEFAULT_ALPHA_INITIALIZER),_this.alphaRegularizer=regularizers_1.getRegularizer(args.alphaRegularizer),_this.alphaConstraint=constraints_1.getConstraint(args.alphaConstraint),null==args.sharedAxes)_this.sharedAxes=null;else if(Array.isArray(args.sharedAxes))_this.sharedAxes=args.sharedAxes;else{if("number"!=typeof args.sharedAxes)throw new errors_1.ValueError("Expected sharedAxes to be a number or an array of numbers, but got "+args.sharedAxes);_this.sharedAxes=[args.sharedAxes]}return _this}return __extends(PReLU,_super),PReLU.prototype.build=function(inputShape){var paramShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice(1);if(null!=this.sharedAxes)for(var _i=0,_a=this.sharedAxes;_i<_a.length;_i++){paramShape[(i=_a[_i])-1]=1}this.alpha=this.addWeight("alpha",paramShape,"float32",this.alphaInitializer,this.alphaRegularizer,!0,this.alphaConstraint);var axes={};if(null!=this.sharedAxes)for(var i=1;i<inputShape.length;++i)axes[i]=inputShape[i];this.inputSpec=[new topology_1.InputSpec({ndim:inputShape.length,axes:axes})],this.built=!0},PReLU.prototype.call=function(inputs,kwargs){return inputs=types_utils_1.getExactlyOneTensor(inputs),tfjs_core_1.prelu(inputs,this.alpha.read())},PReLU.prototype.getConfig=function(){var config={alphaInitializer:initializers_1.serializeInitializer(this.alphaInitializer),alphaRegularizer:regularizers_1.serializeRegularizer(this.alphaRegularizer),alphaConstraint:constraints_1.serializeConstraint(this.alphaConstraint),sharedAxes:this.sharedAxes},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},PReLU.className="PReLU",PReLU}(topology_1.Layer);exports.PReLU=PReLU,tfjs_core_1.serialization.registerClass(PReLU);var ELU=function(_super){function ELU(args){var _this=_super.call(this,null==args?{}:args)||this;if(_this.DEFAULT_ALPHA=1,null==args&&(args={}),null!=args.alpha&&args.alpha!==_this.DEFAULT_ALPHA)throw new errors_1.NotImplementedError("Non-default alpha value ("+args.alpha+") is not supported by the ELU layer yet.");return _this.alpha=null==args.alpha?_this.DEFAULT_ALPHA:args.alpha,_this}return __extends(ELU,_super),ELU.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return tfjs_core_1.elu(x)},ELU.prototype.computeOutputShape=function(inputShape){return inputShape},ELU.prototype.getConfig=function(){var config={alpha:this.alpha},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ELU.className="ELU",ELU}(topology_1.Layer);exports.ELU=ELU,tfjs_core_1.serialization.registerClass(ELU);var ThresholdedReLU=function(_super){function ThresholdedReLU(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.DEFAULT_THETA=1,null==args&&(args={}),_this.theta=null==args.theta?_this.DEFAULT_THETA:args.theta,_this}return __extends(ThresholdedReLU,_super),ThresholdedReLU.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return x.mul(tfjs_backend_1.cast(x.greater(this.theta),"float32"))},ThresholdedReLU.prototype.computeOutputShape=function(inputShape){return inputShape},ThresholdedReLU.prototype.getConfig=function(){var config={theta:this.theta},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ThresholdedReLU.className="ThresholdedReLU",ThresholdedReLU}(topology_1.Layer);exports.ThresholdedReLU=ThresholdedReLU,tfjs_core_1.serialization.registerClass(ThresholdedReLU);var Softmax=function(_super){function Softmax(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.DEFAULT_AXIS=1,null==args&&(args={}),_this.softmax=(new activations_1.Softmax).apply,_this.axis=null==args.axis?_this.DEFAULT_AXIS:args.axis,_this}return __extends(Softmax,_super),Softmax.prototype.call=function(inputs,kwargs){var x=types_utils_1.getExactlyOneTensor(inputs);return this.softmax(x,this.axis)},Softmax.prototype.computeOutputShape=function(inputShape){return inputShape},Softmax.prototype.getConfig=function(){var config={axis:this.axis},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Softmax.className="Softmax",Softmax}(topology_1.Layer);exports.Softmax=Softmax,tfjs_core_1.serialization.registerClass(Softmax)},{"../activations":273,"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],302:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),common_1=require("../backend/common"),K=require("../backend/tfjs_backend"),common_2=require("../common"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),conv_utils_1=require("../utils/conv_utils"),generic_utils=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils");function preprocessConv2DInput(x,dataFormat){return tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),"channelsFirst"===dataFormat?tfc.transpose(x,[0,2,3,1]):x})}function preprocessConv3DInput(x,dataFormat){return tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),"channelsFirst"===dataFormat?tfc.transpose(x,[0,2,3,4,1]):x})}function conv1dWithBias(x,kernel,bias,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=1),void 0===padding&&(padding="valid"),void 0===dilationRate&&(dilationRate=1),tfjs_core_1.tidy(function(){if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat),3!==x.shape.length)throw new errors_1.ValueError("The input of a conv1dWithBias operation should be 3, but is "+x.shape.length+" instead.");if(3!==kernel.shape.length)throw new errors_1.ValueError("The kernel for a conv1dWithBias operation should be 3, but is "+kernel.shape.length+" instead");if(null!=bias&&1!==bias.shape.length)throw new errors_1.ValueError("The bias for a conv1dWithBias operation should be 1, but is "+kernel.shape.length+" instead");if("channelsFirst"===dataFormat&&(x=tfc.transpose(x,[0,2,1])),"causal"===padding)throw new errors_1.NotImplementedError("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");var y=tfc.conv1d(x,kernel,strides,"same"===padding?"same":"valid","NWC",dilationRate);return null!=bias&&(y=K.biasAdd(y,bias)),y})}function conv2dWithBiasActivation(x,kernel,bias,strides,padding,dataFormat,dilationRate,activation){return void 0===strides&&(strides=[1,1]),void 0===padding&&(padding="valid"),void 0===activation&&(activation=null),tfjs_core_1.tidy(function(){if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat),3!==x.rank&&4!==x.rank)throw new errors_1.ValueError("conv2dWithBiasActivation expects input to be of rank 3 or 4, but received "+x.rank+".");if(3!==kernel.rank&&4!==kernel.rank)throw new errors_1.ValueError("conv2dWithBiasActivation expects kernel to be of rank 3 or 4, but received "+x.rank+".");var y=preprocessConv2DInput(x,dataFormat);if("causal"===padding)throw new errors_1.NotImplementedError("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");return y=tfc.fused.conv2d({x:y,filter:kernel,strides:strides,pad:"same"===padding?"same":"valid",dilations:dilationRate,dataFormat:"NHWC",bias:bias,activation:activation}),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,3,1,2])),y})}function conv3dWithBias(x,kernel,bias,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat),4!==x.rank&&5!==x.rank)throw new errors_1.ValueError("conv3dWithBias expects input to be of rank 4 or 5, but received "+x.rank+".");if(4!==kernel.rank&&5!==kernel.rank)throw new errors_1.ValueError("conv3dWithBias expects kernel to be of rank 4 or 5, but received "+x.rank+".");var y=preprocessConv3DInput(x,dataFormat);if("causal"===padding)throw new errors_1.NotImplementedError("The support for CAUSAL padding mode in conv3dWithBias is not implemented yet.");return y=tfc.conv3d(y,kernel,strides,"same"===padding?"same":"valid","NDHWC",dilationRate),null!=bias&&(y=K.biasAdd(y,bias)),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,4,1,2,3])),y})}exports.preprocessConv2DInput=preprocessConv2DInput,exports.preprocessConv3DInput=preprocessConv3DInput,exports.conv1dWithBias=conv1dWithBias,exports.conv1d=function(x,kernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=1),void 0===padding&&(padding="valid"),void 0===dilationRate&&(dilationRate=1),tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),conv1dWithBias(x,kernel,null,strides,padding,dataFormat,dilationRate)})},exports.conv2d=function(x,kernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),conv2dWithBiasActivation(x,kernel,null,strides,padding,dataFormat,dilationRate)})},exports.conv2dWithBiasActivation=conv2dWithBiasActivation,exports.conv3d=function(x,kernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){return common_2.checkDataFormat(dataFormat),conv3dWithBias(x,kernel,null,strides,padding,dataFormat,dilationRate)})},exports.conv3dWithBias=conv3dWithBias;var BaseConv=function(_super){function BaseConv(rank,args){var _this=_super.call(this,args)||this;if(_this.bias=null,_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_BIAS_INITIALIZER="zeros",BaseConv.verifyArgs(args),_this.rank=rank,generic_utils.assertPositiveInteger(_this.rank,"rank"),1!==_this.rank&&2!==_this.rank&&3!==_this.rank)throw new errors_1.NotImplementedError("Convolution layer for rank other than 1, 2, or 3 ("+_this.rank+") is not implemented yet.");if(_this.kernelSize=conv_utils_1.normalizeArray(args.kernelSize,rank,"kernelSize"),_this.strides=conv_utils_1.normalizeArray(null==args.strides?1:args.strides,rank,"strides"),_this.padding=null==args.padding?"valid":args.padding,common_2.checkPaddingMode(_this.padding),_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),_this.activation=activations_1.getActivation(args.activation),_this.useBias=null==args.useBias||args.useBias,_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.activityRegularizer=regularizers_1.getRegularizer(args.activityRegularizer),_this.dilationRate=conv_utils_1.normalizeArray(null==args.dilationRate?1:args.dilationRate,rank,"dilationRate"),1===_this.rank&&Array.isArray(_this.dilationRate)&&1!==_this.dilationRate.length)throw new errors_1.ValueError("dilationRate must be a number or an array of a single number for 1D convolution, but received "+JSON.stringify(_this.dilationRate));if(2===_this.rank){if("number"==typeof _this.dilationRate)_this.dilationRate=[_this.dilationRate,_this.dilationRate];else if(2!==_this.dilationRate.length)throw new errors_1.ValueError("dilationRate must be a number or array of two numbers for 2D convolution, but received "+JSON.stringify(_this.dilationRate))}else if(3===_this.rank)if("number"==typeof _this.dilationRate)_this.dilationRate=[_this.dilationRate,_this.dilationRate,_this.dilationRate];else if(3!==_this.dilationRate.length)throw new errors_1.ValueError("dilationRate must be a number or array of three numbers for 3D convolution, but received "+JSON.stringify(_this.dilationRate));return _this}return __extends(BaseConv,_super),BaseConv.verifyArgs=function(args){if(generic_utils.assert("kernelSize"in args,"required key 'kernelSize' not in config"),"number"!=typeof args.kernelSize&&!generic_utils.checkArrayTypeAndLength(args.kernelSize,"number",1,3))throw new errors_1.ValueError("BaseConv expects config.kernelSize to be number or number[] with length 1, 2, or 3, but received "+JSON.stringify(args.kernelSize)+".")},BaseConv.prototype.getConfig=function(){var config={kernelSize:this.kernelSize,strides:this.strides,padding:this.padding,dataFormat:this.dataFormat,dilationRate:this.dilationRate,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},BaseConv}(topology_1.Layer),Conv=function(_super){function Conv(rank,args){var _this=_super.call(this,rank,args)||this;return _this.kernel=null,Conv.verifyArgs(args),_this.filters=args.filters,generic_utils.assertPositiveInteger(_this.filters,"filters"),_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this}return __extends(Conv,_super),Conv.prototype.build=function(inputShape){var _a;inputShape=types_utils_1.getExactlyOneShape(inputShape);var channelAxis="channelsFirst"===this.dataFormat?1:inputShape.length-1;if(null==inputShape[channelAxis])throw new errors_1.ValueError("The channel dimension of the input should be defined. Found "+inputShape[channelAxis]);var inputDim=inputShape[channelAxis],kernelShape=this.kernelSize.concat([inputDim,this.filters]);this.kernel=this.addWeight("kernel",kernelShape,null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[{ndim:this.rank+2,axes:(_a={},_a[channelAxis]=inputDim,_a)}],this.built=!0},Conv.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var outputs;inputs=types_utils_1.getExactlyOneTensor(inputs);var biasValue=null==_this.bias?null:_this.bias.read(),fusedActivationName=function(activationName){return"relu"===activationName?"relu":"linear"===activationName?"linear":null}(_this.activation.getClassName());if(null!=fusedActivationName&&2===_this.rank)outputs=conv2dWithBiasActivation(inputs,_this.kernel.read(),biasValue,_this.strides,_this.padding,_this.dataFormat,_this.dilationRate,fusedActivationName);else{if(1===_this.rank)outputs=conv1dWithBias(inputs,_this.kernel.read(),biasValue,_this.strides[0],_this.padding,_this.dataFormat,_this.dilationRate[0]);else if(2===_this.rank)outputs=conv2dWithBiasActivation(inputs,_this.kernel.read(),biasValue,_this.strides,_this.padding,_this.dataFormat,_this.dilationRate);else{if(3!==_this.rank)throw new errors_1.NotImplementedError("convolutions greater than 3D are not implemented yet.");outputs=conv3dWithBias(inputs,_this.kernel.read(),biasValue,_this.strides,_this.padding,_this.dataFormat,_this.dilationRate)}null!=_this.activation&&(outputs=_this.activation.apply(outputs))}return outputs})},Conv.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);for(var newSpace=[],space="channelsLast"===this.dataFormat?inputShape.slice(1,inputShape.length-1):inputShape.slice(2),i=0;i<space.length;++i){var newDim=conv_utils_1.convOutputLength(space[i],this.kernelSize[i],this.padding,this.strides[i],"number"==typeof this.dilationRate?this.dilationRate:this.dilationRate[i]);newSpace.push(newDim)}var outputShape=[inputShape[0]];return"channelsLast"===this.dataFormat?(outputShape=outputShape.concat(newSpace)).push(this.filters):(outputShape.push(this.filters),outputShape=outputShape.concat(newSpace)),outputShape},Conv.prototype.getConfig=function(){var config={filters:this.filters,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Conv.verifyArgs=function(args){if(!("filters"in args)||"number"!=typeof args.filters||args.filters<1)throw new errors_1.ValueError("Convolution layer expected config.filters to be a 'number' > 0 but got "+JSON.stringify(args.filters))},Conv}(exports.BaseConv=BaseConv),Conv2D=function(_super){function Conv2D(args){var _this=_super.call(this,2,args)||this;return Conv2D.verifyArgs(args),_this}return __extends(Conv2D,_super),Conv2D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,config},Conv2D.verifyArgs=function(args){if("number"!=typeof args.kernelSize&&!generic_utils.checkArrayTypeAndLength(args.kernelSize,"number",1,2))throw new errors_1.ValueError("Conv2D expects config.kernelSize to be number or number[] with length 1 or 2, but received "+JSON.stringify(args.kernelSize)+".")},Conv2D.className="Conv2D",Conv2D}(exports.Conv=Conv);exports.Conv2D=Conv2D,tfjs_core_1.serialization.registerClass(Conv2D);var Conv3D=function(_super){function Conv3D(args){var _this=_super.call(this,3,args)||this;return Conv3D.verifyArgs(args),_this}return __extends(Conv3D,_super),Conv3D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,config},Conv3D.verifyArgs=function(args){if("number"!=typeof args.kernelSize&&(!Array.isArray(args.kernelSize)||1!==args.kernelSize.length&&3!==args.kernelSize.length))throw new errors_1.ValueError("Conv3D expects config.kernelSize to be number or [number, number, number], but received "+JSON.stringify(args.kernelSize)+".")},Conv3D.className="Conv3D",Conv3D}(Conv);exports.Conv3D=Conv3D,tfjs_core_1.serialization.registerClass(Conv3D);var Conv2DTranspose=function(_super){function Conv2DTranspose(args){var _this=_super.call(this,args)||this;if(_this.inputSpec=[new topology_1.InputSpec({ndim:4})],"same"!==_this.padding&&"valid"!==_this.padding)throw new errors_1.ValueError("Conv2DTranspose currently supports only padding modes 'same' and 'valid', but received padding mode "+_this.padding);return _this}return __extends(Conv2DTranspose,_super),Conv2DTranspose.prototype.build=function(inputShape){var _a;if(4!==(inputShape=types_utils_1.getExactlyOneShape(inputShape)).length)throw new errors_1.ValueError("Input should have rank 4; Received input shape: "+JSON.stringify(inputShape));var channelAxis="channelsFirst"===this.dataFormat?1:inputShape.length-1;if(null==inputShape[channelAxis])throw new errors_1.ValueError("The channel dimension of the inputs should be defined. Found `None`.");var inputDim=inputShape[channelAxis],kernelShape=this.kernelSize.concat([this.filters,inputDim]);this.kernel=this.addWeight("kernel",kernelShape,"float32",this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[new topology_1.InputSpec({ndim:4,axes:(_a={},_a[channelAxis]=inputDim,_a)})],this.built=!0},Conv2DTranspose.prototype.call=function(inputs,kwargs){var _this=this;return tfc.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);if(4!==input.shape.length)throw new errors_1.ValueError("Conv2DTranspose.call() expects input tensor to be rank-4, but received a tensor of rank-"+input.shape.length);var hAxis,wAxis,inputShape=input.shape,batchSize=inputShape[0];wAxis="channelsFirst"===_this.dataFormat?(hAxis=2,3):(hAxis=1,2);var height=inputShape[hAxis],width=inputShape[wAxis],kernelH=_this.kernelSize[0],kernelW=_this.kernelSize[1],strideH=_this.strides[0],strideW=_this.strides[1],outputShape=[batchSize,conv_utils_1.deconvLength(height,strideH,kernelH,_this.padding),conv_utils_1.deconvLength(width,strideW,kernelW,_this.padding),_this.filters];"channelsLast"!==_this.dataFormat&&(input=tfc.transpose(input,[0,2,3,1]));var outputs=tfc.conv2dTranspose(input,_this.kernel.read(),outputShape,_this.strides,_this.padding);return"channelsLast"!==_this.dataFormat&&(outputs=tfc.transpose(outputs,[0,3,1,2])),null!=_this.bias&&(outputs=K.biasAdd(outputs,_this.bias.read(),_this.dataFormat)),null!=_this.activation&&(outputs=_this.activation.apply(outputs)),outputs})},Conv2DTranspose.prototype.computeOutputShape=function(inputShape){var channelAxis,heightAxis,widthAxis,outputShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice();widthAxis="channelsFirst"===this.dataFormat?(channelAxis=1,heightAxis=2,3):(channelAxis=3,heightAxis=1,2);var kernelH=this.kernelSize[0],kernelW=this.kernelSize[1],strideH=this.strides[0],strideW=this.strides[1];return outputShape[channelAxis]=this.filters,outputShape[heightAxis]=conv_utils_1.deconvLength(outputShape[heightAxis],strideH,kernelH,this.padding),outputShape[widthAxis]=conv_utils_1.deconvLength(outputShape[widthAxis],strideW,kernelW,this.padding),outputShape},Conv2DTranspose.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.dilationRate,config},Conv2DTranspose.className="Conv2DTranspose",Conv2DTranspose}(Conv2D);exports.Conv2DTranspose=Conv2DTranspose,tfjs_core_1.serialization.registerClass(Conv2DTranspose);var SeparableConv=function(_super){function SeparableConv(rank,config){var _this=_super.call(this,rank,config)||this;if(_this.DEFAULT_DEPTHWISE_INITIALIZER="glorotUniform",_this.DEFAULT_POINTWISE_INITIALIZER="glorotUniform",_this.depthwiseKernel=null,(_this.pointwiseKernel=null)==config.filters)throw new errors_1.ValueError("The `filters` configuration field is required by SeparableConv, but is unspecified.");if(null!=config.kernelInitializer||null!=config.kernelRegularizer||null!=config.kernelConstraint)throw new errors_1.ValueError("Fields kernelInitializer, kernelRegularizer and kernelConstraint are invalid for SeparableConv2D. Use depthwiseInitializer, depthwiseRegularizer, depthwiseConstraint, pointwiseInitializer, pointwiseRegularizer and pointwiseConstraint instead.");if(null!=config.padding&&"same"!==config.padding&&"valid"!==config.padding)throw new errors_1.ValueError("SeparableConv"+_this.rank+"D supports only padding modes: 'same' and 'valid', but received "+JSON.stringify(config.padding));return _this.depthMultiplier=null==config.depthMultiplier?1:config.depthMultiplier,_this.depthwiseInitializer=initializers_1.getInitializer(config.depthwiseInitializer||_this.DEFAULT_DEPTHWISE_INITIALIZER),_this.depthwiseRegularizer=regularizers_1.getRegularizer(config.depthwiseRegularizer),_this.depthwiseConstraint=constraints_1.getConstraint(config.depthwiseConstraint),_this.pointwiseInitializer=initializers_1.getInitializer(config.depthwiseInitializer||_this.DEFAULT_POINTWISE_INITIALIZER),_this.pointwiseRegularizer=regularizers_1.getRegularizer(config.pointwiseRegularizer),_this.pointwiseConstraint=constraints_1.getConstraint(config.pointwiseConstraint),_this}return __extends(SeparableConv,_super),SeparableConv.prototype.build=function(inputShape){var _a;if((inputShape=types_utils_1.getExactlyOneShape(inputShape)).length<this.rank+2)throw new errors_1.ValueError("Inputs to SeparableConv"+this.rank+"D should have rank "+(this.rank+2)+", but received input shape: "+JSON.stringify(inputShape));var channelAxis="channelsFirst"===this.dataFormat?1:inputShape.length-1;if(null==inputShape[channelAxis]||inputShape[channelAxis]<0)throw new errors_1.ValueError("The channel dimension of the inputs should be defined, but found "+JSON.stringify(inputShape[channelAxis]));for(var inputDim=inputShape[channelAxis],depthwiseKernelShape=this.kernelSize.concat([inputDim,this.depthMultiplier]),pointwiseKernelShape=[],i=0;i<this.rank;++i)pointwiseKernelShape.push(1);pointwiseKernelShape.push(inputDim*this.depthMultiplier,this.filters);this.depthwiseKernel=this.addWeight("depthwise_kernel",depthwiseKernelShape,"float32",this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.pointwiseKernel=this.addWeight("pointwise_kernel",pointwiseKernelShape,"float32",this.pointwiseInitializer,this.pointwiseRegularizer,!0,this.pointwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.inputSpec=[new topology_1.InputSpec({ndim:this.rank+2,axes:(_a={},_a[channelAxis]=inputDim,_a)})],this.built=!0},SeparableConv.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var output;if(inputs=types_utils_1.getExactlyOneTensor(inputs),1===_this.rank)throw new errors_1.NotImplementedError("1D separable convolution is not implemented yet.");return 2===_this.rank&&("channelsFirst"===_this.dataFormat&&(inputs=tfc.transpose(inputs,[0,2,3,1])),output=tfc.separableConv2d(inputs,_this.depthwiseKernel.read(),_this.pointwiseKernel.read(),_this.strides,_this.padding,_this.dilationRate,"NHWC")),_this.useBias&&(output=K.biasAdd(output,_this.bias.read(),_this.dataFormat)),null!=_this.activation&&(output=_this.activation.apply(output)),"channelsFirst"===_this.dataFormat&&(output=tfc.transpose(output,[0,3,1,2])),output})},SeparableConv.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,delete config.kernelInitializer,delete config.kernelRegularizer,delete config.kernelConstraint,config.depthwiseInitializer=initializers_1.serializeInitializer(this.depthwiseInitializer),config.pointwiseInitializer=initializers_1.serializeInitializer(this.pointwiseInitializer),config.depthwiseRegularizer=regularizers_1.serializeRegularizer(this.depthwiseRegularizer),config.pointwiseRegularizer=regularizers_1.serializeRegularizer(this.pointwiseRegularizer),config.depthwiseConstraint=constraints_1.serializeConstraint(this.depthwiseConstraint),config.pointwiseConstraint=constraints_1.serializeConstraint(this.pointwiseConstraint),config},SeparableConv.className="SeparableConv",SeparableConv}(Conv),SeparableConv2D=function(_super){function SeparableConv2D(args){return _super.call(this,2,args)||this}return __extends(SeparableConv2D,_super),SeparableConv2D.className="SeparableConv2D",SeparableConv2D}(exports.SeparableConv=SeparableConv);exports.SeparableConv2D=SeparableConv2D,tfjs_core_1.serialization.registerClass(SeparableConv2D);var Conv1D=function(_super){function Conv1D(args){var _this=_super.call(this,1,args)||this;return Conv1D.verifyArgs(args),_this.inputSpec=[{ndim:3}],_this}return __extends(Conv1D,_super),Conv1D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return delete config.rank,delete config.dataFormat,config},Conv1D.verifyArgs=function(args){if("number"!=typeof args.kernelSize&&!generic_utils.checkArrayTypeAndLength(args.kernelSize,"number",1,1))throw new errors_1.ValueError("Conv1D expects config.kernelSize to be number or number[] with length 1, but received "+JSON.stringify(args.kernelSize)+".")},Conv1D.className="Conv1D",Conv1D}(Conv);exports.Conv1D=Conv1D,tfjs_core_1.serialization.registerClass(Conv1D);var Cropping2D=function(_super){function Cropping2D(args){var _this=_super.call(this,args)||this;return"number"==typeof args.cropping?_this.cropping=[[args.cropping,args.cropping],[args.cropping,args.cropping]]:"number"==typeof args.cropping[0]?_this.cropping=[[args.cropping[0],args.cropping[0]],[args.cropping[1],args.cropping[1]]]:_this.cropping=args.cropping,_this.dataFormat=void 0===args.dataFormat?"channelsLast":args.dataFormat,_this.inputSpec=[{ndim:4}],_this}return __extends(Cropping2D,_super),Cropping2D.prototype.computeOutputShape=function(inputShape){return"channelsFirst"===this.dataFormat?[inputShape[0],inputShape[1],inputShape[2]-this.cropping[0][0]-this.cropping[0][1],inputShape[3]-this.cropping[1][0]-this.cropping[1][1]]:[inputShape[0],inputShape[1]-this.cropping[0][0]-this.cropping[0][1],inputShape[2]-this.cropping[1][0]-this.cropping[1][1],inputShape[3]]},Cropping2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(inputs=types_utils_1.getExactlyOneTensor(inputs),"channelsLast"===_this.dataFormat){var hSliced=K.sliceAlongAxis(inputs,_this.cropping[0][0],inputs.shape[1]-_this.cropping[0][0]-_this.cropping[0][1],2);return K.sliceAlongAxis(hSliced,_this.cropping[1][0],inputs.shape[2]-_this.cropping[1][1]-_this.cropping[1][0],3)}hSliced=K.sliceAlongAxis(inputs,_this.cropping[0][0],inputs.shape[2]-_this.cropping[0][0]-_this.cropping[0][1],3);return K.sliceAlongAxis(hSliced,_this.cropping[1][0],inputs.shape[3]-_this.cropping[1][1]-_this.cropping[1][0],4)})},Cropping2D.prototype.getConfig=function(){var config={cropping:this.cropping,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Cropping2D.className="Cropping2D",Cropping2D}(topology_1.Layer);exports.Cropping2D=Cropping2D,tfjs_core_1.serialization.registerClass(Cropping2D);var UpSampling2D=function(_super){function UpSampling2D(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_SIZE=[2,2],_this.inputSpec=[{ndim:4}],_this.size=null==args.size?_this.DEFAULT_SIZE:args.size,_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,_this}return __extends(UpSampling2D,_super),UpSampling2D.prototype.computeOutputShape=function(inputShape){if("channelsFirst"===this.dataFormat){var height=null==inputShape[2]?null:this.size[0]*inputShape[2],width=null==inputShape[3]?null:this.size[1]*inputShape[3];return[inputShape[0],inputShape[1],height,width]}height=null==inputShape[1]?null:this.size[0]*inputShape[1],width=null==inputShape[2]?null:this.size[1]*inputShape[2];return[inputShape[0],height,width,inputShape[3]]},UpSampling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfc.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs),inputShape=input.shape;if("channelsFirst"===_this.dataFormat){input=tfc.transpose(input,[0,2,3,1]);var height=_this.size[0]*inputShape[2],width=_this.size[1]*inputShape[3],resized=input.resizeNearestNeighbor([height,width]);return tfc.transpose(resized,[0,3,1,2])}height=_this.size[0]*inputShape[1],width=_this.size[1]*inputShape[2];return input.resizeNearestNeighbor([height,width])})},UpSampling2D.prototype.getConfig=function(){var config={size:this.size,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},UpSampling2D.className="UpSampling2D",UpSampling2D}(topology_1.Layer);exports.UpSampling2D=UpSampling2D,tfjs_core_1.serialization.registerClass(UpSampling2D)},{"../activations":273,"../backend/common":274,"../backend/tfjs_backend":276,"../common":279,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/conv_utils":321,"../utils/generic_utils":322,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],303:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../backend/common"),K=require("../backend/tfjs_backend"),common_2=require("../common"),constraints_1=require("../constraints"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),conv_utils_1=require("../utils/conv_utils"),types_utils_1=require("../utils/types_utils"),convolutional_1=require("./convolutional");function depthwiseConv2d(x,depthwiseKernel,strides,padding,dataFormat,dilationRate){return void 0===strides&&(strides=[1,1]),void 0===padding&&(padding="valid"),tfjs_core_1.tidy(function(){null==dataFormat&&(dataFormat=common_1.imageDataFormat()),common_2.checkDataFormat(dataFormat);var y=convolutional_1.preprocessConv2DInput(x,dataFormat);if(4!==x.rank)throw new errors_1.ValueError("Input for depthwiseConv2d is required to be 4-D, but is instead "+x.rank+"-D");if(4!==depthwiseKernel.rank)throw new errors_1.ValueError("depthwiseKernel is required to be 4-D, but is instead "+depthwiseKernel.rank+"-D");return y=tfc.depthwiseConv2d(y,depthwiseKernel,strides,"same"===padding?"same":"valid","NHWC",dilationRate),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,3,1,2])),y})}exports.depthwiseConv2d=depthwiseConv2d;var DepthwiseConv2D=function(_super){function DepthwiseConv2D(args){var _this=_super.call(this,2,args)||this;return _this.depthwiseKernel=null,_this.depthMultiplier=null==args.depthMultiplier?1:args.depthMultiplier,_this.depthwiseInitializer=initializers_1.getInitializer(args.depthwiseInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.depthwiseConstraint=constraints_1.getConstraint(args.depthwiseConstraint),_this.depthwiseRegularizer=regularizers_1.getRegularizer(args.depthwiseRegularizer),_this}return __extends(DepthwiseConv2D,_super),DepthwiseConv2D.prototype.build=function(inputShape){if((inputShape=types_utils_1.getExactlyOneShape(inputShape)).length<4)throw new errors_1.ValueError("Inputs to DepthwiseConv2D should have rank 4. Received input shape: "+JSON.stringify(inputShape)+".");var channelAxis="channelsFirst"===this.dataFormat?1:3;if(null==inputShape[channelAxis]||inputShape[channelAxis]<0)throw new errors_1.ValueError("The channel dimension of the inputs to DepthwiseConv2D should be defined, but is not ("+inputShape[channelAxis]+").");var inputDim=inputShape[channelAxis],depthwiseKernelShape=[this.kernelSize[0],this.kernelSize[1],inputDim,this.depthMultiplier];this.depthwiseKernel=this.addWeight("depthwise_kernel",depthwiseKernelShape,null,this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[inputDim*this.depthMultiplier],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},DepthwiseConv2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var outputs=depthwiseConv2d(inputs=types_utils_1.getExactlyOneTensor(inputs),_this.depthwiseKernel.read(),_this.strides,_this.padding,_this.dataFormat,null);return _this.useBias&&(outputs=K.biasAdd(outputs,_this.bias.read(),_this.dataFormat)),null!=_this.activation&&(outputs=_this.activation.apply(outputs)),outputs})},DepthwiseConv2D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var rows="channelsFirst"===this.dataFormat?inputShape[2]:inputShape[1],cols="channelsFirst"===this.dataFormat?inputShape[3]:inputShape[2],outFilters="channelsFirst"===this.dataFormat?inputShape[1]*this.depthMultiplier:inputShape[3]*this.depthMultiplier,outRows=conv_utils_1.convOutputLength(rows,this.kernelSize[0],this.padding,this.strides[0]),outCols=conv_utils_1.convOutputLength(cols,this.kernelSize[1],this.padding,this.strides[1]);return"channelsFirst"===this.dataFormat?[inputShape[0],outFilters,outRows,outCols]:[inputShape[0],outRows,outCols,outFilters]},DepthwiseConv2D.prototype.getConfig=function(){var config=_super.prototype.getConfig.call(this);return config.depthMultiplier=this.depthMultiplier,config.depthwiseInitializer=initializers_1.serializeInitializer(this.depthwiseInitializer),config.depthwiseRegularizer=regularizers_1.serializeRegularizer(this.depthwiseRegularizer),config.depthwiseConstraint=constraints_1.serializeConstraint(this.depthwiseRegularizer),config},DepthwiseConv2D.className="DepthwiseConv2D",DepthwiseConv2D}(convolutional_1.BaseConv);exports.DepthwiseConv2D=DepthwiseConv2D,tfjs_core_1.serialization.registerClass(DepthwiseConv2D)},{"../backend/common":274,"../backend/tfjs_backend":276,"../common":279,"../constraints":280,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/conv_utils":321,"../utils/types_utils":326,"./convolutional":302,"@tensorflow/tfjs-core":148}],304:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),K=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils_1=require("../utils/generic_utils"),math_utils_1=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils");var Dropout=function(_super){function Dropout(args){var _this=_super.call(this,args)||this;return _this.rate=Math.max(Math.min(args.rate,1),0),_this.noiseShape=args.noiseShape,_this.seed=args.seed,_this.supportsMasking=!0,_this}return __extends(Dropout,_super),Dropout.prototype.getNoiseShape=function(input){if(null==this.noiseShape)return this.noiseShape;for(var inputShape=input.shape,noiseShape=[],i=0;i<this.noiseShape.length;++i)noiseShape.push(null==this.noiseShape[i]?inputShape[i]:this.noiseShape[i]);return noiseShape},Dropout.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);if(0<_this.rate&&_this.rate<1){var training=null!=kwargs.training&&kwargs.training,noiseShape_1=_this.getNoiseShape(input);return K.inTrainPhase(function(){return K.dropout(input,_this.rate,noiseShape_1,_this.seed)},function(){return input},training)}return inputs})},Dropout.prototype.getConfig=function(){var config={rate:this.rate,noiseShape:this.noiseShape,seed:this.seed},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Dropout.prototype.dispose=function(){return _super.prototype.dispose.call(this)},Dropout.className="Dropout",Dropout}(topology_1.Layer);exports.Dropout=Dropout,tfjs_core_1.serialization.registerClass(Dropout);var Dense=function(_super){function Dense(args){var _this=_super.call(this,args)||this;if(_this.activation=null,_this.useBias=!0,_this.kernel=null,_this.bias=null,_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_BIAS_INITIALIZER="zeros",null==args.batchInputShape&&null==args.inputShape&&null!=args.inputDim){var batchSize=null;null!=args.batchSize&&(batchSize=args.batchSize),_this.batchInputShape=[batchSize,args.inputDim]}return _this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(args.activation),null!=args.useBias&&(_this.useBias=args.useBias),_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.activityRegularizer=regularizers_1.getRegularizer(args.activityRegularizer),_this.supportsMasking=!0,_this.inputSpec=[{minNDim:2}],_this}return __extends(Dense,_super),Dense.prototype.build=function(inputShape){var _a,inputLastDim=(inputShape=types_utils_1.getExactlyOneShape(inputShape))[inputShape.length-1];null==this.kernel&&(this.kernel=this.addWeight("kernel",[inputLastDim,this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint))),this.inputSpec=[{minNDim:2,axes:(_a={},_a[-1]=inputLastDim,_a)}],this.built=!0},Dense.prototype.computeOutputShape=function(inputShape){var outputShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice();return outputShape[outputShape.length-1]=this.units,outputShape},Dense.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var output,input=types_utils_1.getExactlyOneTensor(inputs),fusedActivationName=function(activationName){return"relu"===activationName?"relu":"linear"===activationName?"linear":null}(_this.activation.getClassName());return null!=fusedActivationName?output=K.dot(input,_this.kernel.read(),fusedActivationName,_this.bias?_this.bias.read():null):(output=K.dot(input,_this.kernel.read()),null!=_this.bias&&(output=K.biasAdd(output,_this.bias.read())),null!=_this.activation&&(output=_this.activation.apply(output))),output})},Dense.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Dense.className="Dense",Dense}(topology_1.Layer);exports.Dense=Dense,tfjs_core_1.serialization.registerClass(Dense);var Flatten=function(_super){function Flatten(args){var _this=_super.call(this,args||{})||this;return _this.inputSpec=[{minNDim:3}],_this}return __extends(Flatten,_super),Flatten.prototype.computeOutputShape=function(inputShape){for(var _i=0,_a=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice(1);_i<_a.length;_i++){if(null==_a[_i])throw new errors_1.ValueError('The shape of the input to "Flatten" is not fully defined (got '+inputShape.slice(1)+'). Make sure to pass a complete "input_shape" or "batch_input_shape" argument to the first layer in your model.')}return[inputShape[0],math_utils_1.arrayProd(inputShape,1)]},Flatten.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return _this.invokeCallHook(inputs,kwargs),K.batchFlatten(types_utils_1.getExactlyOneTensor(inputs))})},Flatten.className="Flatten",Flatten}(topology_1.Layer);exports.Flatten=Flatten,tfjs_core_1.serialization.registerClass(Flatten);var Activation=function(_super){function Activation(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.activation=activations_1.getActivation(args.activation),_this}return __extends(Activation,_super),Activation.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);return _this.activation.apply(input)})},Activation.prototype.getConfig=function(){var config={activation:activations_1.serializeActivation(this.activation)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Activation.className="Activation",Activation}(topology_1.Layer);exports.Activation=Activation,tfjs_core_1.serialization.registerClass(Activation);var RepeatVector=function(_super){function RepeatVector(args){var _this=_super.call(this,args)||this;return _this.n=args.n,_this.inputSpec=[{ndim:2}],_this}return __extends(RepeatVector,_super),RepeatVector.prototype.computeOutputShape=function(inputShape){return[inputShape[0],this.n,inputShape[1]]},RepeatVector.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return inputs=types_utils_1.getExactlyOneTensor(inputs),K.repeat(inputs,_this.n)})},RepeatVector.prototype.getConfig=function(){var config={n:this.n},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},RepeatVector.className="RepeatVector",RepeatVector}(topology_1.Layer);exports.RepeatVector=RepeatVector,tfjs_core_1.serialization.registerClass(RepeatVector);var Reshape=function(_super){function Reshape(args){var _this=_super.call(this,args)||this;_this.targetShape=args.targetShape;for(var i=0;i<_this.targetShape.length;++i)_this.isUnknown(_this.targetShape[i])&&(_this.targetShape[i]=null);return _this}return __extends(Reshape,_super),Reshape.prototype.isUnknown=function(dim){return dim<0||null==dim},Reshape.prototype.fixUnknownDimension=function(inputShape,outputShape){for(var errorMsg="Total size of new array must be unchanged.",finalShape=outputShape.slice(),known=1,unknown=null,i=0;i<finalShape.length;++i){var dim=finalShape[i];if(this.isUnknown(dim)){if(null!==unknown)throw new errors_1.ValueError("Can only specifiy one unknown dimension.");unknown=i}else known*=dim}var originalSize=math_utils_1.arrayProd(inputShape);if(null!==unknown){if(0===known||originalSize%known!=0)throw new errors_1.ValueError(errorMsg);finalShape[unknown]=originalSize/known}else if(originalSize!==known)throw new errors_1.ValueError(errorMsg);return finalShape},Reshape.prototype.computeOutputShape=function(inputShape){for(var anyUnknownDims=!1,i=0;i<inputShape.length;++i)if(this.isUnknown(inputShape[i])){anyUnknownDims=!0;break}return anyUnknownDims?inputShape.slice(0,1).concat(this.targetShape):inputShape.slice(0,1).concat(this.fixUnknownDimension(inputShape.slice(1),this.targetShape))},Reshape.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs),inputShape=input.shape,outputShape=inputShape.slice(0,1).concat(_this.fixUnknownDimension(inputShape.slice(1),_this.targetShape));return input.reshape(outputShape)})},Reshape.prototype.getConfig=function(){var config={targetShape:this.targetShape},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Reshape.className="Reshape",Reshape}(topology_1.Layer);exports.Reshape=Reshape,tfjs_core_1.serialization.registerClass(Reshape);var Permute=function(_super){function Permute(args){var _this=_super.call(this,args)||this;if(null==args.dims)throw new Error("Required configuration field `dims` is missing during Permute constructor call.");if(!Array.isArray(args.dims))throw new Error("Permute constructor requires `dims` to be an Array, but received "+args.dims+" instead.");var expectedSortedIndices=math_utils_1.range(1,args.dims.length+1);if(!tfjs_core_1.util.arraysEqual(args.dims.slice().sort(),expectedSortedIndices))throw new Error("Invalid permutation `dims`: "+JSON.stringify(args.dims)+" `dims` must contain consecutive integers starting from 1.");return _this.dims=args.dims,_this.dimsIncludingBatch=[0].concat(_this.dims),_this.inputSpec=[new topology_1.InputSpec({ndim:_this.dims.length+1})],_this}return __extends(Permute,_super),Permute.prototype.computeOutputShape=function(inputShape){var outputShape=(inputShape=types_utils_1.getExactlyOneShape(inputShape)).slice();return this.dims.forEach(function(dim,i){outputShape[i+1]=inputShape[dim]}),outputShape},Permute.prototype.call=function(inputs,kwargs){return tfjs_core_1.transpose(types_utils_1.getExactlyOneTensor(inputs),this.dimsIncludingBatch)},Permute.prototype.getConfig=function(){var config={dims:this.dims},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Permute.className="Permute",Permute}(topology_1.Layer);exports.Permute=Permute,tfjs_core_1.serialization.registerClass(Permute);var Masking=function(_super){function Masking(args){var _this=_super.call(this,null==args?{}:args)||this;return _this.supportsMasking=!0,_this.maskValue=null!=args?null==args.maskValue?0:args.maskValue:0,_this}return __extends(Masking,_super),Masking.prototype.computeOutputShape=function(inputShape){return inputShape},Masking.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={maskValue:this.maskValue};return Object.assign(config,baseConfig),config},Masking.prototype.computeMask=function(inputs,mask){var input=types_utils_1.getExactlyOneTensor(inputs);return tfjs_core_1.any(tfjs_core_1.notEqual(input,this.maskValue),-1)},Masking.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs),booleanMask=tfjs_core_1.any(tfjs_core_1.notEqual(input,_this.maskValue),-1,!0);return input.mul(booleanMask.asType(input.dtype))})},Masking.className="Masking",Masking}(topology_1.Layer);exports.Masking=Masking,tfjs_core_1.serialization.registerClass(Masking)},{"../activations":273,"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],305:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils"),Embedding=function(_super){function Embedding(args){var _this=_super.call(this,args)||this;if(_this.embeddings=null,_this.DEFAULT_EMBEDDINGS_INITIALIZER="randomUniform",null==args.batchInputShape&&null==args.inputShape){var batchSize=null;null!=args.batchSize&&(batchSize=args.batchSize),null==args.inputLength?_this.batchInputShape=[batchSize,null]:_this.batchInputShape=[batchSize].concat(generic_utils.toList(args.inputLength))}return _this.inputDim=args.inputDim,generic_utils.assertPositiveInteger(_this.inputDim,"inputDim"),_this.outputDim=args.outputDim,generic_utils.assertPositiveInteger(_this.outputDim,"outputDim"),_this.embeddingsInitializer=initializers_1.getInitializer(args.embeddingsInitializer||_this.DEFAULT_EMBEDDINGS_INITIALIZER),_this.embeddingsRegularizer=regularizers_1.getRegularizer(args.embeddingsRegularizer),_this.activityRegularizer=regularizers_1.getRegularizer(args.activityRegularizer),_this.embeddingsConstraint=constraints_1.getConstraint(args.embeddingsConstraint),_this.maskZero=args.maskZero,_this.supportsMasking=args.maskZero,_this.inputLength=args.inputLength,_this}return __extends(Embedding,_super),Embedding.prototype.build=function(inputShape){this.embeddings=this.addWeight("embeddings",[this.inputDim,this.outputDim],this.dtype,this.embeddingsInitializer,this.embeddingsRegularizer,!0,this.embeddingsConstraint),this.built=!0},Embedding.prototype.warnOnIncompatibleInputShape=function(inputShape){},Embedding.prototype.computeMask=function(inputs,mask){var _this=this;return tfjs_core_1.tidy(function(){return _this.maskZero?(inputs=types_utils_1.getExactlyOneTensor(inputs),tfjs_core_1.notEqual(inputs,tfjs_core_1.zerosLike(inputs))):null})},Embedding.prototype.computeOutputShape=function(inputShape){if(inputShape=types_utils_1.getExactlyOneShape(inputShape),null==this.inputLength)return inputShape.concat([this.outputDim]);var inLens=generic_utils.toList(this.inputLength);if(inLens.length!==inputShape.length-1)throw new errors_1.ValueError('"inputLength" is '+this.inputLength+", but received input shape has shape "+inputShape);for(var i=0,k=0;k<inLens.length;++k){var s1=inLens[k],s2=inputShape[k+1];if(null!=s1&&null!=s2&&s1!==s2)throw new errors_1.ValueError('"inputLength" is '+this.inputLength+", but received input shape has shape "+inputShape);null==s1&&(inLens[i]=s2),i++}return[inputShape[0]].concat(inLens,[this.outputDim])},Embedding.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);return"int32"!==input.dtype&&(input=K.cast(input,"int32")),K.gather(_this.embeddings.read(),input.as1D()).reshape(types_utils_1.getExactlyOneShape(_this.computeOutputShape(input.shape)))})},Embedding.prototype.getConfig=function(){var config={inputDim:this.inputDim,outputDim:this.outputDim,embeddingsInitializer:initializers_1.serializeInitializer(this.embeddingsInitializer),embeddingsRegularizer:regularizers_1.serializeRegularizer(this.embeddingsRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),embeddingsConstraint:constraints_1.serializeConstraint(this.embeddingsConstraint),maskZero:this.maskZero,inputLength:this.inputLength},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Embedding.className="Embedding",Embedding}(topology_1.Layer);exports.Embedding=Embedding,tfjs_core_1.serialization.registerClass(Embedding)},{"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],306:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),topology_1=require("../engine/topology"),errors_1=require("../errors"),losses_1=require("../losses"),generic_utils=require("../utils/generic_utils"),mathUtils=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils"),Merge=function(_super){function Merge(args){var _this=_super.call(this,args||{})||this;return _this.supportsMasking=!0,_this}return __extends(Merge,_super),Merge.prototype.mergeFunction=function(inputs){throw new errors_1.NotImplementedError},Merge.prototype.computeElementwiseOpOutputShape=function(shape1,shape2){if(null==shape1||null==shape2)return null;if(shape1.length<shape2.length)return this.computeElementwiseOpOutputShape(shape2,shape1);if(0===shape2.length)return shape1;for(var outputShape=shape1.slice(0,shape1.length-shape2.length),k=0;k<shape2.length;++k){var i=shape1[shape1.length-shape2.length+k],j=shape2[k];if(null==i||null==j||i<0||j<0)outputShape.push(null);else if(1===i)outputShape.push(j);else if(1===j)outputShape.push(i);else{if(i!==j)throw new errors_1.ValueError("Operands could not be broadcast together with shapes "+JSON.stringify(shape1)+" "+JSON.stringify(shape2));outputShape.push(i)}}return outputShape},Merge.prototype.build=function(inputShape){if(Array.isArray(inputShape)&&!Array.isArray(inputShape[0])&&(inputShape=[types_utils_1.getExactlyOneShape(inputShape)]),(inputShape=inputShape).length<2)throw new errors_1.ValueError("A merge layer should be called on an Array of at least 2 inputs. Got "+inputShape.length+" input(s).");for(var batchSizes=[],_i=0,inputShape_1=inputShape;_i<inputShape_1.length;_i++){null!=(shape=inputShape_1[_i])&&null!==shape[0]&&batchSizes.push(shape[0])}if(1<(batchSizes=generic_utils.unique(batchSizes)).length)throw new errors_1.ValueError("Can not merge tensors with different batch sizes. Got tensors with shapes: "+JSON.stringify(inputShape)+".");for(var outputShape=null==inputShape[0]?null:inputShape[0].slice(1),i=1;i<inputShape.length;++i){var shape=null==inputShape[i]?null:inputShape[i].slice(1);outputShape=this.computeElementwiseOpOutputShape(outputShape,shape)}var allRanks=inputShape.map(function(shape){return shape.length});-1===inputShape.indexOf(null)&&1===generic_utils.unique(allRanks).length?this.reshapeRequired=!1:this.reshapeRequired=!0},Merge.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(inputs=inputs,_this.reshapeRequired){var reshapedInputs=[],inputDims=inputs.map(function(input){return input.rank});if(-1===inputDims.indexOf(null)){for(var maxNDim=mathUtils.max(inputDims),_i=0,inputs_1=inputs;_i<inputs_1.length;_i++){for(var xNDim=(x=inputs_1[_i]).rank,k=0;k<maxNDim-xNDim;++k)x=K.expandDims(x,1);reshapedInputs.push(x)}return _this.mergeFunction(reshapedInputs)}for(var transposed=!1,_a=0,inputs_2=inputs;_a<inputs_2.length;_a++){var x;if(null==(xNDim=(x=inputs_2[_a]).rank)){var xShape=x.shape,batchSize=xShape[0],newShape=xShape.slice(1).concat([batchSize]),xTransposed=x.reshape([batchSize].concat(mathUtils.arrayProd(xShape.slice(1))));xTransposed=(xTransposed=tfc.transpose(xTransposed,[1,0])).reshape(newShape),reshapedInputs.push(xTransposed),transposed=!0}else if(1<xNDim){var dims=mathUtils.range(1,xNDim).concat([0]);reshapedInputs.push(tfc.transpose(x,dims)),transposed=!0}else reshapedInputs.push(x)}var y=_this.mergeFunction(reshapedInputs),yNDim=y.rank;if(transposed)if(null==yNDim){var yShape=y.shape;newShape=[batchSize=yShape[yShape.length-1]].concat(yShape.slice(0,yShape.length-1));y=tfc.transpose(y.reshape([-1,batchSize]),[1,0]).reshape(newShape)}else if(1<yNDim){dims=[yNDim-1].concat(mathUtils.range(0,yNDim-1));y=tfc.transpose(y,dims)}return y}return _this.mergeFunction(inputs)})},Merge.prototype.computeOutputShape=function(inputShape){var outputShape;outputShape=null==(inputShape=inputShape)[0]?null:inputShape[0].slice(1);for(var i=1;i<inputShape.length;++i){var shape=null==inputShape[i]?null:inputShape[i].slice(1);outputShape=this.computeElementwiseOpOutputShape(outputShape,shape)}for(var batchSizes=[],_i=0,inputShape_2=inputShape;_i<inputShape_2.length;_i++){null!=(shape=inputShape_2[_i])&&null!==shape[0]&&batchSizes.push(shape[0])}return outputShape=1===(batchSizes=generic_utils.unique(batchSizes)).length?batchSizes.concat(outputShape):[null].concat(outputShape)},Merge.prototype.computeMask=function(inputs,mask){return tfc.tidy(function(){if(null==mask)return null;if(!Array.isArray(mask))throw new errors_1.ValueError("`mask` should be an Array");if(!Array.isArray(inputs))throw new errors_1.ValueError("`inputs` should be an Array");if(mask.length!==inputs.length)throw new errors_1.ValueError("The Array 'inputs' and 'mask' are expected to have the same length, but have different lengths ("+inputs.length+" vs "+mask.length+")");if(mask.every(function(m){return null==m}))return null;for(var output=(mask=mask.map(function(m){return null==m?m:tfc.expandDims(m,0)}))[0],i=1;i<mask.length-1;++i)output=tfc.logicalAnd(output,mask[i]);return output})},Merge}(topology_1.Layer),Add=function(_super){function Add(args){return _super.call(this,args)||this}return __extends(Add,_super),Add.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0].clone(),i=1;i<inputs.length;++i)output=tfc.add(output,inputs[i]);return output})},Add.className="Add",Add}(exports.Merge=Merge);exports.Add=Add,tfjs_core_1.serialization.registerClass(Add),exports.add=function(config){return Array.isArray(config)?new Add({}).apply(config):new Add(config)};var Multiply=function(_super){function Multiply(args){return _super.call(this,args)||this}return __extends(Multiply,_super),Multiply.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0].clone(),i=1;i<inputs.length;++i)output=tfc.mul(output,inputs[i]);return output})},Multiply.className="Multiply",Multiply}(Merge);exports.Multiply=Multiply,tfjs_core_1.serialization.registerClass(Multiply),exports.multiply=function(config){return Array.isArray(config)?new Multiply({}).apply(config):new Multiply(config)};var Average=function(_super){function Average(args){return _super.call(this,args)||this}return __extends(Average,_super),Average.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0].clone(),i=1;i<inputs.length;++i)output=tfc.add(output,inputs[i]);return tfc.mul(1/inputs.length,output)})},Average.className="Average",Average}(Merge);exports.Average=Average,tfjs_core_1.serialization.registerClass(Average),exports.average=function(config){return Array.isArray(config)?new Average({}).apply(config):new Average(config)};var Maximum=function(_super){function Maximum(args){return _super.call(this,args)||this}return __extends(Maximum,_super),Maximum.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0],i=1;i<inputs.length;++i)output=tfc.maximum(output,inputs[i]);return output})},Maximum.className="Maximum",Maximum}(Merge);exports.Maximum=Maximum,tfjs_core_1.serialization.registerClass(Maximum),exports.maximum=function(config){return Array.isArray(config)?new Maximum({}).apply(config):new Maximum(config)};var Minimum=function(_super){function Minimum(args){return _super.call(this,args)||this}return __extends(Minimum,_super),Minimum.prototype.mergeFunction=function(inputs){return tfjs_core_1.tidy(function(){for(var output=inputs[0],i=1;i<inputs.length;++i)output=tfc.minimum(output,inputs[i]);return output})},Minimum.className="Minimum",Minimum}(Merge);exports.Minimum=Minimum,tfjs_core_1.serialization.registerClass(Minimum),exports.minimum=function(config){return Array.isArray(config)?new Minimum({}).apply(config):new Minimum(config)};var Concatenate=function(_super){function Concatenate(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_AXIS=-1,null==args&&(args={}),_this.axis=null==args.axis?_this.DEFAULT_AXIS:args.axis,_this.supportsMasking=!0,_this.reshapeRequired=!1,_this}return __extends(Concatenate,_super),Concatenate.prototype.build=function(inputShape){if(!Array.isArray(inputShape)||!Array.isArray(inputShape[0])||1===inputShape.length)throw new errors_1.ValueError("A `Concatenate` layer should be called on a list of at least 2 inputs");for(var allNoneShape=!0,_i=0,inputShape_3=inputShape=inputShape;_i<inputShape_3.length;_i++){if(null!=(shape=inputShape_3[_i])){allNoneShape=!1;break}}if(!allNoneShape){for(var shapeSet=[],i=0;i<inputShape.length;++i){var shapeWithoutConcatAxis=inputShape[i].slice();shapeWithoutConcatAxis.splice(this.axis,1);for(var exists=!1,_a=0,shapeSet_1=shapeSet;_a<shapeSet_1.length;_a++){var shape=shapeSet_1[_a];if(tfjs_core_1.util.arraysEqual(shape,shapeWithoutConcatAxis)){exists=!0;break}}exists||shapeSet.push(shapeWithoutConcatAxis)}if(1<shapeSet.length)throw new errors_1.ValueError("A `Concatenate` layer requires inputs with matching shapes except for the concat axis. Got input shapes: "+JSON.stringify(inputShape))}},Concatenate.prototype.mergeFunction=function(inputs){var _this=this;return tfjs_core_1.tidy(function(){return K.concatenate(inputs,_this.axis)})},Concatenate.prototype.computeOutputShape=function(inputShape){if(!Array.isArray(inputShape)||!Array.isArray(inputShape[0]))throw new errors_1.ValueError("A `Concatenate` layer should be called on a list of inputs.");for(var inputShapes=inputShape,outputShape=inputShapes[0].slice(),axis=this.axis<0?outputShape.length+this.axis:this.axis,_i=0,_a=inputShapes.slice(1);_i<_a.length;_i++){var shape=_a[_i];if(null==outputShape[axis]||null==shape[axis]){outputShape[axis]=null;break}outputShape[axis]+=shape[axis]}return outputShape},Concatenate.prototype.computeMask=function(inputs,mask){var _this=this;if(null==mask)return null;if(!Array.isArray(mask))throw new errors_1.ValueError("`mask` should be an array for Concatenate");if(!Array.isArray(inputs))throw new errors_1.ValueError("`inputs` should be an array for Concatenate");if(mask.length!==inputs.length)throw new errors_1.ValueError("Mismatch in the length of mask ("+mask.length+") and the legnth of inputs ("+inputs.length+")");return tfc.tidy(function(){var allNullMasks=!0;if(mask.forEach(function(m){null==m||(allNullMasks=!1)}),allNullMasks)return null;for(var outputMasks=[],i=0;i<inputs.length;++i)null==mask[i]?outputMasks.push(tfc.onesLike(inputs[i]).asType("bool")):mask[i].rank<inputs[i].rank?outputMasks.push(tfc.expandDims(mask[i],-1)):outputMasks.push(mask[i]);var concatenatedMasks=tfc.concat(outputMasks,_this.axis);return tfc.all(concatenatedMasks,-1,!1)})},Concatenate.prototype.getConfig=function(){var config={axis:this.axis},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Concatenate.className="Concatenate",Concatenate}(Merge);function interpretAxis(axis,dim){for(;axis<0;)axis+=dim;return axis}exports.Concatenate=Concatenate,tfjs_core_1.serialization.registerClass(Concatenate),exports.concatenate=function(config){return Array.isArray(config)?new Concatenate({}).apply(config):new Concatenate(config)};var Dot=function(_super){function Dot(args){var _this=_super.call(this,args)||this;return _this.axes=args.axes,_this.normalize=null!=args.normalize&&args.normalize,_this.supportsMasking=!0,_this.reshapeRequired=!1,_this}return __extends(Dot,_super),Dot.prototype.build=function(inputShape){tfc.util.assert(Array.isArray(inputShape)&&2===inputShape.length&&Array.isArray(inputShape[0])&&Array.isArray(inputShape[1]),function(){return"A `Dot` layer should be called on a list of exactly 2 inputs."});var shape1=inputShape[0],shape2=inputShape[1];if(3<shape1.length||3<shape2.length)throw new errors_1.NotImplementedError("Dot layer does not support tensors of 4D or higher rank yet.");var axes=this.interpretAxes(shape1,shape2);if(shape1[axes[0]]!==shape2[axes[1]])throw new errors_1.ValueError("Dimension incompatibility: "+shape1[axes[0]]+" !== "+shape2[axes[1]])},Dot.prototype.mergeFunction=function(inputs){if(2!==inputs.length)throw new errors_1.ValueError("A `Dot` layer must be called on exactly 2 inputs, but received "+inputs.length+" input(s).");var axes,x1=inputs[0],x2=inputs[1];return axes=Array.isArray(this.axes)?this.axes.map(function(axis,i){return interpretAxis(axis,inputs[i].shape.length)}):[interpretAxis(this.axes,x1.shape.length),interpretAxis(this.axes,x2.shape.length)],this.normalize&&(x1=losses_1.l2Normalize(x1,axes[0]),x2=losses_1.l2Normalize(x2,axes[1])),function(x,y,axes){if(3<x.shape.length||3<y.shape.length)throw new errors_1.NotImplementedError("batchDot is not implemented for tensors of 4D or higher rank yet");if(tfc.util.assert(2<=x.shape.length,function(){return"batchDot requires the rank of x to be >= 2, but got "+x.shape.length}),tfc.util.assert(2<=x.shape.length,function(){return"batchDot requires the rank of y to be >= 2, but got "+y.shape.length}),"number"==typeof axes&&(axes=[axes,axes]),"complex64"===x.dtype||"complex64"===y.dtype)throw new errors_1.NotImplementedError("batchDot is not implemented for complex64-type Tensors yet.");var xNDim=x.shape.length,yNDim=y.shape.length;null==axes&&(axes=[xNDim-1,yNDim-2]);var axesArray=axes;return tfc.tidy(function(){var diff,out;if(yNDim<xNDim){diff=xNDim-yNDim;for(var diffShape=[],i=0;i<diff;++i)diffShape.push(1);y=y.reshape(y.shape.concat(diffShape))}else if(xNDim<yNDim){diff=yNDim-xNDim;for(diffShape=[],i=0;i<diff;++i)diffShape.push(1);x=x.reshape(x.shape.concat(diffShape))}else diff=0;if(2===x.shape.length&&2===y.shape.length)out=axesArray[0]===axesArray[1]?x.mulStrict(y).sum(axesArray[0]):x.transpose([1,0]).mulStrict(y).sum(axesArray[1]);else{var adjX=axesArray[0]!==x.shape.length-1,adjY=axesArray[1]===y.shape.length-1;out=x.matMul(y,adjX,adjY)}if(0<diff){var idx=void 0,squeezeAxes=[];for(i=idx=yNDim<xNDim?xNDim+yNDim-3:xNDim-1;i<idx+diff;++i)squeezeAxes.push(i);out=out.squeeze(squeezeAxes)}return 1===out.shape.length&&(out=out.expandDims(1)),out})}(x1,x2,axes)},Dot.prototype.interpretAxes=function(shape1,shape2){return Array.isArray(this.axes)?this.axes:[interpretAxis(this.axes,shape1.length),interpretAxis(this.axes,shape2.length)]},Dot.prototype.computeOutputShape=function(inputShape){tfc.util.assert(Array.isArray(inputShape)&&2===inputShape.length&&Array.isArray(inputShape[0])&&Array.isArray(inputShape[1]),function(){return"A `Dot` layer should be called on a list of exactly 2 inputs."});var shape1=inputShape[0].slice(),shape2=inputShape[1].slice();if(3<shape1.length||3<shape2.length)throw new errors_1.NotImplementedError("Dot layer does not support tensors of 4D or higher rank yet.");var axes=this.interpretAxes(shape1,shape2);shape1.splice(axes[0],1),shape2.splice(axes[1],1),shape2.splice(0,1);var outputShape=shape1.concat(shape2);return 1===outputShape.length&&outputShape.push(1),outputShape},Dot.prototype.computeMask=function(inputs,mask){return null},Dot.prototype.getConfig=function(){var config={axes:this.axes,normalize:this.normalize},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Dot.className="Dot",Dot}(Merge);exports.Dot=Dot,tfjs_core_1.serialization.registerClass(Dot)},{"../backend/tfjs_backend":276,"../engine/topology":284,"../errors":289,"../losses":315,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],307:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),topology_1=require("../engine/topology"),types_utils_1=require("../utils/types_utils"),GaussianNoise=function(_super){function GaussianNoise(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.stddev=args.stddev,_this}return __extends(GaussianNoise,_super),GaussianNoise.prototype.computeOutputShape=function(inputShape){return inputShape},GaussianNoise.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={stddev:this.stddev};return Object.assign(config,baseConfig),config},GaussianNoise.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);return K.inTrainPhase(function(){return K.randomNormal(input.shape,0,_this.stddev).add(input)},function(){return input},kwargs.training||!1)})},GaussianNoise.className="GaussianNoise",GaussianNoise}(topology_1.Layer);exports.GaussianNoise=GaussianNoise,tfjs_core_1.serialization.registerClass(GaussianNoise);var GaussianDropout=function(_super){function GaussianDropout(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.rate=args.rate,_this}return __extends(GaussianDropout,_super),GaussianDropout.prototype.computeOutputShape=function(inputShape){return inputShape},GaussianDropout.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={rate:this.rate};return Object.assign(config,baseConfig),config},GaussianDropout.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs);var input=types_utils_1.getExactlyOneTensor(inputs);if(0<_this.rate&&_this.rate<1){return K.inTrainPhase(function(){var stddev=Math.sqrt(_this.rate/(1-_this.rate));return input.mul(K.randomNormal(input.shape,1,stddev))},function(){return input},kwargs.training||!1)}return input})},GaussianDropout.className="GaussianDropout",GaussianDropout}(topology_1.Layer);exports.GaussianDropout=GaussianDropout,tfjs_core_1.serialization.registerClass(GaussianDropout);var AlphaDropout=function(_super){function AlphaDropout(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this.rate=args.rate,_this.noiseShape=args.noiseShape,_this}return __extends(AlphaDropout,_super),AlphaDropout.prototype._getNoiseShape=function(inputs){return this.noiseShape||types_utils_1.getExactlyOneTensor(inputs).shape},AlphaDropout.prototype.computeOutputShape=function(inputShape){return inputShape},AlphaDropout.prototype.getConfig=function(){var baseConfig=_super.prototype.getConfig.call(this),config={rate:this.rate};return Object.assign(config,baseConfig),config},AlphaDropout.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(_this.rate<1&&0<_this.rate){var noiseShape_1=_this._getNoiseShape(inputs);return K.inTrainPhase(function(){var input=types_utils_1.getExactlyOneTensor(inputs),alphaP=-1.7580993408473766,keptIdx=tfjs_core_1.greaterEqual(tfjs_core_1.randomUniform(noiseShape_1),_this.rate);keptIdx=K.cast(keptIdx,"float32");var a=Math.pow((1-_this.rate)*(1+_this.rate*Math.pow(alphaP,2)),-.5),b=-a*alphaP*_this.rate;return input.mul(keptIdx).add(keptIdx.add(-1).mul(alphaP)).mul(a).add(b)},function(){return types_utils_1.getExactlyOneTensor(inputs)},kwargs.training||!1)}return inputs})},AlphaDropout.className="AlphaDropout",AlphaDropout}(topology_1.Layer);exports.AlphaDropout=AlphaDropout,tfjs_core_1.serialization.registerClass(AlphaDropout)},{"../backend/tfjs_backend":276,"../engine/topology":284,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],308:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils=require("../utils/generic_utils"),math_utils=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils");function batchNormalization(x,mean,variance,beta,gamma,epsilon){var out;if(void 0===epsilon&&(epsilon=.001),2===x.rank)out=tfc.batchNorm2d(x,mean,variance,beta,gamma,epsilon);else if(3===x.rank)out=tfc.batchNorm3d(x,mean,variance,beta,gamma,epsilon);else{if(4!==x.rank)throw new errors_1.NotImplementedError("batchNormalization is not implemented for array of rank "+x.rank+" yet");out=tfc.batchNorm4d(x,mean,variance,beta,gamma,epsilon)}return out}function normalizeBatchInTraining(x,gamma,beta,reductionAxes,epsilon){return void 0===epsilon&&(epsilon=.001),tfjs_core_1.util.arraysEqual(reductionAxes.slice().sort(),math_utils.range(0,x.rank-1))?function(x,gamma,beta,reductionAxes,epsilon){return void 0===epsilon&&(epsilon=.001),tfjs_core_1.tidy(function(){var meanAndVariance=tfc.moments(x,reductionAxes),mean=meanAndVariance.mean,variance=meanAndVariance.variance;return[batchNormalization(x,mean,variance,beta,gamma,epsilon),mean,variance]})}(x,gamma,beta,reductionAxes,epsilon):function(x,gamma,beta,reductionAxes,epsilon){return void 0===epsilon&&(epsilon=.001),tfjs_core_1.tidy(function(){for(var meanAndVariance=tfc.moments(x,reductionAxes),mean=meanAndVariance.mean,variance=meanAndVariance.variance,targetShape=[],_i=0,_a=math_utils.range(0,x.rank);_i<_a.length;_i++){var axis=_a[_i];-1!==reductionAxes.indexOf(axis)?targetShape.push(1):targetShape.push(x.shape[axis])}var broadcastMean=mean.reshape(targetShape),broadcastVariance=variance.reshape(targetShape),broadcastGamma=null==gamma?null:gamma.reshape(targetShape),broadcastBeta=null==beta?null:beta.reshape(targetShape);return[batchNormalization(x,broadcastMean,broadcastVariance,broadcastBeta,broadcastGamma,epsilon),mean,variance]})}(x,gamma,beta,reductionAxes,epsilon)}exports.batchNormalization=batchNormalization,exports.normalizeBatchInTraining=normalizeBatchInTraining;var BatchNormalization=function(_super){function BatchNormalization(args){var _this=this;return null==args&&(args={}),(_this=_super.call(this,args)||this).supportsMasking=!0,_this.axis=null==args.axis?-1:args.axis,_this.momentum=null==args.momentum?.99:args.momentum,_this.epsilon=null==args.epsilon?.001:args.epsilon,_this.center=null==args.center||args.center,_this.scale=null==args.scale||args.scale,_this.betaInitializer=initializers_1.getInitializer(args.betaInitializer||"zeros"),_this.gammaInitializer=initializers_1.getInitializer(args.gammaInitializer||"ones"),_this.movingMeanInitializer=initializers_1.getInitializer(args.movingMeanInitializer||"zeros"),_this.movingVarianceInitializer=initializers_1.getInitializer(args.movingVarianceInitializer||"ones"),_this.betaConstraint=constraints_1.getConstraint(args.betaConstraint),_this.gammaConstraint=constraints_1.getConstraint(args.gammaConstraint),_this.betaRegularizer=regularizers_1.getRegularizer(args.betaRegularizer),_this.gammaRegularizer=regularizers_1.getRegularizer(args.gammaRegularizer),_this}return __extends(BatchNormalization,_super),BatchNormalization.prototype.build=function(inputShape){var _a;inputShape=types_utils_1.getExactlyOneShape(inputShape);var axis=0<=this.axis?this.axis:this.axis+inputShape.length,dim=inputShape[axis];if(null==dim)throw new errors_1.ValueError("Axis "+axis+" of input tensor should have a defined dimension but the layer received an input with shape "+JSON.stringify(inputShape)+".");this.inputSpec=[new topology_1.InputSpec({ndim:inputShape.length,axes:(_a={},_a[axis]=dim,_a)})];var shape=[dim];this.scale&&(this.gamma=this.addWeight("gamma",shape,null,this.gammaInitializer,this.gammaRegularizer,!0,this.gammaConstraint)),this.center&&(this.beta=this.addWeight("beta",shape,null,this.betaInitializer,this.betaRegularizer,!0,this.betaConstraint)),this.movingMean=this.addWeight("moving_mean",shape,null,this.movingMeanInitializer,null,!1),this.movingVariance=this.addWeight("moving_variance",shape,null,this.movingVarianceInitializer,null,!1),this.built=!0},BatchNormalization.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var training=null!=kwargs.training&&kwargs.training,input=types_utils_1.getExactlyOneTensor(inputs),inputShape=input.shape,ndim=inputShape.length,reductionAxes=math_utils.range(0,ndim),axis=0<=_this.axis?_this.axis:_this.axis+ndim;reductionAxes.splice(axis,1);var broadcastShape=generic_utils.pyListRepeat(1,ndim);broadcastShape[axis]=inputShape[axis];var sortedReductionAxes=reductionAxes.slice();sortedReductionAxes.sort();var needsBroadcasting=!tfjs_core_1.util.arraysEqual(sortedReductionAxes,math_utils.range(0,ndim).slice(0,ndim-1));if(!training)return function(){if(needsBroadcasting){var broadcastMovingMean=_this.movingMean.read().reshape(broadcastShape),broadcastMovingVariance=_this.movingVariance.read().reshape(broadcastShape),broadcastBeta=_this.center?_this.beta.read().reshape(broadcastShape):null,broadcastGamma=_this.scale?_this.gamma.read().reshape(broadcastShape):null;return batchNormalization(input,broadcastMovingMean,broadcastMovingVariance,broadcastBeta,broadcastGamma,_this.epsilon)}return batchNormalization(input,_this.movingMean.read(),_this.movingVariance.read(),null==_this.beta?null:_this.beta.read(),null==_this.gamma?null:_this.gamma.read(),_this.epsilon)}();function doMovingAverage(variable,value,momentum){tfc.tidy(function(){var decay=1-momentum,origValue=variable.read(),updateDelta=origValue.sub(value).mul(decay);variable.write(origValue.sub(updateDelta))})}var _a=normalizeBatchInTraining(input,_this.gamma.read(),_this.beta.read(),reductionAxes,_this.epsilon),normedTraining=_a[0],mean=_a[1],variance=_a[2];return doMovingAverage(_this.movingMean,mean,_this.momentum),doMovingAverage(_this.movingVariance,variance,_this.momentum),normedTraining})},BatchNormalization.prototype.getConfig=function(){var config={axis:this.axis,momentum:this.momentum,epsilon:this.epsilon,center:this.center,scale:this.scale,betaInitializer:initializers_1.serializeInitializer(this.betaInitializer),gammaInitializer:initializers_1.serializeInitializer(this.gammaInitializer),movingMeanInitializer:initializers_1.serializeInitializer(this.movingMeanInitializer),movingVarianceInitializer:initializers_1.serializeInitializer(this.movingVarianceInitializer),betaRegularizer:regularizers_1.serializeRegularizer(this.betaRegularizer),gammaRegularizer:regularizers_1.serializeRegularizer(this.gammaRegularizer),betaConstraint:constraints_1.serializeConstraint(this.betaConstraint),gammaConstraint:constraints_1.serializeConstraint(this.gammaConstraint)},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},BatchNormalization.className="BatchNormalization",BatchNormalization}(topology_1.Layer);exports.BatchNormalization=BatchNormalization,tfjs_core_1.serialization.registerClass(BatchNormalization)},{"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],309:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../backend/common"),topology_1=require("../engine/topology"),errors_1=require("../errors"),types_utils_1=require("../utils/types_utils");function spatial2dPadding(x,padding,dataFormat){return tfjs_core_1.tidy(function(){if(4!==x.rank)throw new errors_1.ValueError("temporalPadding expects input tensor to be 4-D, but received a "+x.rank+"-D tensor.");if(null==padding&&(padding=[[1,1],[1,1]]),2!==padding.length||2!==padding[0].length||2!==padding[1].length)throw new errors_1.ValueError("spatial2dPadding expects `padding` to be an Array of two Arrays, each of which is an Array of two integers.");if(null==dataFormat&&(dataFormat=common_1.imageDataFormat()),"channelsLast"!==dataFormat&&"channelsFirst"!==dataFormat)throw new errors_1.ValueError("Unknown data format: "+dataFormat+". Supported data formats are 'channelsLast' and 'channelsFirst.");var pattern;return pattern="channelsFirst"===dataFormat?[[0,0],[0,0],padding[0],padding[1]]:[[0,0],padding[0],padding[1],[0,0]],tfc.pad(x,pattern)})}exports.temporalPadding=function(x,padding){return tfjs_core_1.tidy(function(){if(3!==x.rank)throw new errors_1.ValueError("temporalPadding expects input tensor to be 3-D, but received a "+x.rank+"-D tensor.");if(null==padding&&(padding=[1,1]),2!==padding.length)throw new errors_1.ValueError("temporalPadding expects input padding pattern to be a length-2 array, but received a length-"+padding.length+" array.");var pattern=[[0,0],padding,[0,0]];return tfc.pad(x,pattern)})},exports.spatial2dPadding=spatial2dPadding;var ZeroPadding2D=function(_super){function ZeroPadding2D(args){var _this=this;if(null==args&&(args={}),(_this=_super.call(this,args)||this).dataFormat=null==args.dataFormat?common_1.imageDataFormat():args.dataFormat,null==args.padding)_this.padding=[[1,1],[1,1]];else if("number"==typeof args.padding)_this.padding=[[args.padding,args.padding],[args.padding,args.padding]];else{if(args.padding=args.padding,2!==args.padding.length)throw new errors_1.ValueError("ZeroPadding2D expects padding to be a length-2 array, but received a length-"+args.padding.length+" array.");var heightPadding=void 0,widthPadding=void 0;if("number"==typeof args.padding[0])heightPadding=[args.padding[0],args.padding[0]],widthPadding=[args.padding[1],args.padding[1]];else{if(args.padding=args.padding,2!==args.padding[0].length)throw new errors_1.ValueError("ZeroPadding2D expects height padding to be a length-2 array, but received a length-"+args.padding[0].length+" array.");if(heightPadding=args.padding[0],2!==args.padding[1].length)throw new errors_1.ValueError("ZeroPadding2D expects width padding to be a length-2 array, but received a length-"+args.padding[1].length+" array.");widthPadding=args.padding[1]}_this.padding=[heightPadding,widthPadding]}return _this.inputSpec=[new topology_1.InputSpec({ndim:4})],_this}return __extends(ZeroPadding2D,_super),ZeroPadding2D.prototype.computeOutputShape=function(inputShape){var rows,cols;return inputShape=types_utils_1.getExactlyOneShape(inputShape),"channelsFirst"===this.dataFormat?(rows=null!=inputShape[2]&&0<=inputShape[2]?inputShape[2]+this.padding[0][0]+this.padding[0][1]:null,cols=null!=inputShape[3]&&0<=inputShape[3]?inputShape[3]+this.padding[1][0]+this.padding[1][1]:null,[inputShape[0],inputShape[1],rows,cols]):(rows=null!=inputShape[1]&&0<=inputShape[1]?inputShape[1]+this.padding[0][0]+this.padding[0][1]:null,cols=null!=inputShape[2]&&0<=inputShape[2]?inputShape[2]+this.padding[1][0]+this.padding[1][1]:null,[inputShape[0],rows,cols,inputShape[3]])},ZeroPadding2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return spatial2dPadding(types_utils_1.getExactlyOneTensor(inputs),_this.padding,_this.dataFormat)})},ZeroPadding2D.prototype.getConfig=function(){var config={padding:this.padding,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},ZeroPadding2D.className="ZeroPadding2D",ZeroPadding2D}(topology_1.Layer);exports.ZeroPadding2D=ZeroPadding2D,tfjs_core_1.serialization.registerClass(ZeroPadding2D)},{"../backend/common":274,"../engine/topology":284,"../errors":289,"../utils/types_utils":326,"@tensorflow/tfjs-core":148}],310:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("../backend/common"),K=require("../backend/tfjs_backend"),common_2=require("../common"),topology_1=require("../engine/topology"),topology_2=require("../engine/topology"),errors_1=require("../errors"),conv_utils_1=require("../utils/conv_utils"),generic_utils_1=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils"),convolutional_1=require("./convolutional");function pool2d(x,poolSize,strides,padding,dataFormat,poolMode){return tfjs_core_1.tidy(function(){var y;common_2.checkDataFormat(dataFormat),common_2.checkPoolMode(poolMode),common_2.checkPaddingMode(padding),null==strides&&(strides=[1,1]),null==padding&&(padding="valid"),null==dataFormat&&(dataFormat=common_1.imageDataFormat()),null==poolMode&&(poolMode="max"),x=convolutional_1.preprocessConv2DInput(x,dataFormat);var paddingString="same"===padding?"same":"valid";return y="max"===poolMode?tfc.maxPool(x,poolSize,strides,paddingString):tfc.avgPool(x,poolSize,strides,paddingString),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,3,1,2])),y})}function pool3d(x,poolSize,strides,padding,dataFormat,poolMode){return tfjs_core_1.tidy(function(){var y;common_2.checkDataFormat(dataFormat),common_2.checkPoolMode(poolMode),common_2.checkPaddingMode(padding),null==strides&&(strides=[1,1,1]),null==padding&&(padding="valid"),null==dataFormat&&(dataFormat=common_1.imageDataFormat()),null==poolMode&&(poolMode="max"),x=convolutional_1.preprocessConv3DInput(x,dataFormat);var paddingString="same"===padding?"same":"valid";return y="max"===poolMode?tfc.maxPool3d(x,poolSize,strides,paddingString):tfc.avgPool3d(x,poolSize,strides,paddingString),"channelsFirst"===dataFormat&&(y=tfc.transpose(y,[0,4,1,2,3])),y})}exports.pool2d=pool2d,exports.pool3d=pool3d;var Pooling1D=function(_super){function Pooling1D(args){var _this=this;if(null==args.poolSize&&(args.poolSize=2),_this=_super.call(this,args)||this,"number"==typeof args.poolSize)_this.poolSize=[args.poolSize];else{if(!Array.isArray(args.poolSize)||1!==args.poolSize.length||"number"!=typeof args.poolSize[0])throw new errors_1.ValueError("poolSize for 1D convolutional layer must be a number or an Array of a single number, but received "+JSON.stringify(args.poolSize));_this.poolSize=args.poolSize}if(generic_utils_1.assertPositiveInteger(_this.poolSize,"poolSize"),null==args.strides)_this.strides=_this.poolSize;else if("number"==typeof args.strides)_this.strides=[args.strides];else{if(!Array.isArray(args.strides)||1!==args.strides.length||"number"!=typeof args.strides[0])throw new errors_1.ValueError("strides for 1D convolutional layer must be a number or an Array of a single number, but received "+JSON.stringify(args.strides));_this.strides=args.strides}return generic_utils_1.assertPositiveInteger(_this.strides,"strides"),_this.padding=null==args.padding?"valid":args.padding,common_2.checkPaddingMode(_this.padding),_this.inputSpec=[new topology_1.InputSpec({ndim:3})],_this}return __extends(Pooling1D,_super),Pooling1D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var length=conv_utils_1.convOutputLength(inputShape[1],this.poolSize[0],this.padding,this.strides[0]);return[inputShape[0],length,inputShape[2]]},Pooling1D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){_this.invokeCallHook(inputs,kwargs),inputs=K.expandDims(types_utils_1.getExactlyOneTensor(inputs),2);var output=_this.poolingFunction(types_utils_1.getExactlyOneTensor(inputs),[_this.poolSize[0],1],[_this.strides[0],1],_this.padding,"channelsLast");return tfc.squeeze(output,[2])})},Pooling1D.prototype.getConfig=function(){var config={poolSize:this.poolSize,padding:this.padding,strides:this.strides},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Pooling1D}(topology_2.Layer),MaxPooling1D=function(_super){function MaxPooling1D(args){return _super.call(this,args)||this}return __extends(MaxPooling1D,_super),MaxPooling1D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"max")},MaxPooling1D.className="MaxPooling1D",MaxPooling1D}(exports.Pooling1D=Pooling1D);exports.MaxPooling1D=MaxPooling1D,tfjs_core_1.serialization.registerClass(MaxPooling1D);var AveragePooling1D=function(_super){function AveragePooling1D(args){return _super.call(this,args)||this}return __extends(AveragePooling1D,_super),AveragePooling1D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"avg")},AveragePooling1D.className="AveragePooling1D",AveragePooling1D}(Pooling1D);exports.AveragePooling1D=AveragePooling1D,tfjs_core_1.serialization.registerClass(AveragePooling1D);var Pooling2D=function(_super){function Pooling2D(args){var _this=this;if(null==args.poolSize&&(args.poolSize=[2,2]),(_this=_super.call(this,args)||this).poolSize=Array.isArray(args.poolSize)?args.poolSize:[args.poolSize,args.poolSize],null==args.strides)_this.strides=_this.poolSize;else if(Array.isArray(args.strides)){if(2!==args.strides.length)throw new errors_1.ValueError("If the strides property of a 2D pooling layer is an Array, it is expected to have a length of 2, but received length "+args.strides.length+".");_this.strides=args.strides}else _this.strides=[args.strides,args.strides];return generic_utils_1.assertPositiveInteger(_this.poolSize,"poolSize"),generic_utils_1.assertPositiveInteger(_this.strides,"strides"),_this.padding=null==args.padding?"valid":args.padding,_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),common_2.checkPaddingMode(_this.padding),_this.inputSpec=[new topology_1.InputSpec({ndim:4})],_this}return __extends(Pooling2D,_super),Pooling2D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var rows="channelsFirst"===this.dataFormat?inputShape[2]:inputShape[1],cols="channelsFirst"===this.dataFormat?inputShape[3]:inputShape[2];return rows=conv_utils_1.convOutputLength(rows,this.poolSize[0],this.padding,this.strides[0]),cols=conv_utils_1.convOutputLength(cols,this.poolSize[1],this.padding,this.strides[1]),"channelsFirst"===this.dataFormat?[inputShape[0],inputShape[1],rows,cols]:[inputShape[0],rows,cols,inputShape[3]]},Pooling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return _this.invokeCallHook(inputs,kwargs),_this.poolingFunction(types_utils_1.getExactlyOneTensor(inputs),_this.poolSize,_this.strides,_this.padding,_this.dataFormat)})},Pooling2D.prototype.getConfig=function(){var config={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Pooling2D}(topology_2.Layer),MaxPooling2D=function(_super){function MaxPooling2D(args){return _super.call(this,args)||this}return __extends(MaxPooling2D,_super),MaxPooling2D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"max")},MaxPooling2D.className="MaxPooling2D",MaxPooling2D}(exports.Pooling2D=Pooling2D);exports.MaxPooling2D=MaxPooling2D,tfjs_core_1.serialization.registerClass(MaxPooling2D);var AveragePooling2D=function(_super){function AveragePooling2D(args){return _super.call(this,args)||this}return __extends(AveragePooling2D,_super),AveragePooling2D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool2d(inputs,poolSize,strides,padding,dataFormat,"avg")},AveragePooling2D.className="AveragePooling2D",AveragePooling2D}(Pooling2D);exports.AveragePooling2D=AveragePooling2D,tfjs_core_1.serialization.registerClass(AveragePooling2D);var Pooling3D=function(_super){function Pooling3D(args){var _this=this;if(null==args.poolSize&&(args.poolSize=[2,2,2]),(_this=_super.call(this,args)||this).poolSize=Array.isArray(args.poolSize)?args.poolSize:[args.poolSize,args.poolSize,args.poolSize],null==args.strides)_this.strides=_this.poolSize;else if(Array.isArray(args.strides)){if(3!==args.strides.length)throw new errors_1.ValueError("If the strides property of a 3D pooling layer is an Array, it is expected to have a length of 3, but received length "+args.strides.length+".");_this.strides=args.strides}else _this.strides=[args.strides,args.strides,args.strides];return generic_utils_1.assertPositiveInteger(_this.poolSize,"poolSize"),generic_utils_1.assertPositiveInteger(_this.strides,"strides"),_this.padding=null==args.padding?"valid":args.padding,_this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),common_2.checkPaddingMode(_this.padding),_this.inputSpec=[new topology_1.InputSpec({ndim:5})],_this}return __extends(Pooling3D,_super),Pooling3D.prototype.computeOutputShape=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape);var depths="channelsFirst"===this.dataFormat?inputShape[2]:inputShape[1],rows="channelsFirst"===this.dataFormat?inputShape[3]:inputShape[2],cols="channelsFirst"===this.dataFormat?inputShape[4]:inputShape[3];return depths=conv_utils_1.convOutputLength(depths,this.poolSize[0],this.padding,this.strides[0]),rows=conv_utils_1.convOutputLength(rows,this.poolSize[1],this.padding,this.strides[1]),cols=conv_utils_1.convOutputLength(cols,this.poolSize[2],this.padding,this.strides[2]),"channelsFirst"===this.dataFormat?[inputShape[0],inputShape[1],depths,rows,cols]:[inputShape[0],depths,rows,cols,inputShape[4]]},Pooling3D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){return _this.invokeCallHook(inputs,kwargs),_this.poolingFunction(types_utils_1.getExactlyOneTensor(inputs),_this.poolSize,_this.strides,_this.padding,_this.dataFormat)})},Pooling3D.prototype.getConfig=function(){var config={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Pooling3D}(topology_2.Layer),MaxPooling3D=function(_super){function MaxPooling3D(args){return _super.call(this,args)||this}return __extends(MaxPooling3D,_super),MaxPooling3D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool3d(inputs,poolSize,strides,padding,dataFormat,"max")},MaxPooling3D.className="MaxPooling3D",MaxPooling3D}(exports.Pooling3D=Pooling3D);exports.MaxPooling3D=MaxPooling3D,tfjs_core_1.serialization.registerClass(MaxPooling3D);var AveragePooling3D=function(_super){function AveragePooling3D(args){return _super.call(this,args)||this}return __extends(AveragePooling3D,_super),AveragePooling3D.prototype.poolingFunction=function(inputs,poolSize,strides,padding,dataFormat){return common_2.checkDataFormat(dataFormat),common_2.checkPaddingMode(padding),pool3d(inputs,poolSize,strides,padding,dataFormat,"avg")},AveragePooling3D.className="AveragePooling3D",AveragePooling3D}(Pooling3D);exports.AveragePooling3D=AveragePooling3D,tfjs_core_1.serialization.registerClass(AveragePooling3D);var GlobalPooling1D=function(_super){function GlobalPooling1D(args){var _this=_super.call(this,args)||this;return _this.inputSpec=[new topology_1.InputSpec({ndim:3})],_this}return __extends(GlobalPooling1D,_super),GlobalPooling1D.prototype.computeOutputShape=function(inputShape){return[inputShape[0],inputShape[2]]},GlobalPooling1D.prototype.call=function(inputs,kwargs){throw new errors_1.NotImplementedError},GlobalPooling1D}(topology_2.Layer),GlobalAveragePooling1D=function(_super){function GlobalAveragePooling1D(args){return _super.call(this,args||{})||this}return __extends(GlobalAveragePooling1D,_super),GlobalAveragePooling1D.prototype.call=function(inputs,kwargs){return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return tfc.mean(input,1)})},GlobalAveragePooling1D.className="GlobalAveragePooling1D",GlobalAveragePooling1D}(exports.GlobalPooling1D=GlobalPooling1D);exports.GlobalAveragePooling1D=GlobalAveragePooling1D,tfjs_core_1.serialization.registerClass(GlobalAveragePooling1D);var GlobalMaxPooling1D=function(_super){function GlobalMaxPooling1D(args){return _super.call(this,args||{})||this}return __extends(GlobalMaxPooling1D,_super),GlobalMaxPooling1D.prototype.call=function(inputs,kwargs){return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return tfc.max(input,1)})},GlobalMaxPooling1D.className="GlobalMaxPooling1D",GlobalMaxPooling1D}(GlobalPooling1D);exports.GlobalMaxPooling1D=GlobalMaxPooling1D,tfjs_core_1.serialization.registerClass(GlobalMaxPooling1D);var GlobalPooling2D=function(_super){function GlobalPooling2D(args){var _this=_super.call(this,args)||this;return _this.dataFormat=null==args.dataFormat?"channelsLast":args.dataFormat,common_2.checkDataFormat(_this.dataFormat),_this.inputSpec=[new topology_1.InputSpec({ndim:4})],_this}return __extends(GlobalPooling2D,_super),GlobalPooling2D.prototype.computeOutputShape=function(inputShape){return inputShape=inputShape,"channelsLast"===this.dataFormat?[inputShape[0],inputShape[3]]:[inputShape[0],inputShape[1]]},GlobalPooling2D.prototype.call=function(inputs,kwargs){throw new errors_1.NotImplementedError},GlobalPooling2D.prototype.getConfig=function(){var config={dataFormat:this.dataFormat},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},GlobalPooling2D}(topology_2.Layer),GlobalAveragePooling2D=function(_super){function GlobalAveragePooling2D(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(GlobalAveragePooling2D,_super),GlobalAveragePooling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return"channelsLast"===_this.dataFormat?tfc.mean(input,[1,2]):tfc.mean(input,[2,3])})},GlobalAveragePooling2D.className="GlobalAveragePooling2D",GlobalAveragePooling2D}(exports.GlobalPooling2D=GlobalPooling2D);exports.GlobalAveragePooling2D=GlobalAveragePooling2D,tfjs_core_1.serialization.registerClass(GlobalAveragePooling2D);var GlobalMaxPooling2D=function(_super){function GlobalMaxPooling2D(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(GlobalMaxPooling2D,_super),GlobalMaxPooling2D.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var input=types_utils_1.getExactlyOneTensor(inputs);return"channelsLast"===_this.dataFormat?tfc.max(input,[1,2]):tfc.max(input,[2,3])})},GlobalMaxPooling2D.className="GlobalMaxPooling2D",GlobalMaxPooling2D}(GlobalPooling2D);exports.GlobalMaxPooling2D=GlobalMaxPooling2D,tfjs_core_1.serialization.registerClass(GlobalMaxPooling2D)},{"../backend/common":274,"../backend/tfjs_backend":276,"../common":279,"../engine/topology":284,"../errors":289,"../utils/conv_utils":321,"../utils/generic_utils":322,"../utils/types_utils":326,"./convolutional":302,"@tensorflow/tfjs-core":148}],311:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),activations_1=require("../activations"),K=require("../backend/tfjs_backend"),constraints_1=require("../constraints"),topology_1=require("../engine/topology"),topology_2=require("../engine/topology"),errors_1=require("../errors"),initializers_1=require("../initializers"),regularizers_1=require("../regularizers"),generic_utils_1=require("../utils/generic_utils"),math_utils=require("../utils/math_utils"),types_utils_1=require("../utils/types_utils"),variables_1=require("../variables"),serialization_1=require("./serialization");function standardizeArgs(inputs,initialState,constants,numConstants){if(Array.isArray(inputs)){if(null!=initialState||null!=constants)throw new errors_1.ValueError("When inputs is an array, neither initialState or constants should be provided");null!=numConstants&&(constants=inputs.slice(inputs.length-numConstants,inputs.length),inputs=inputs.slice(0,inputs.length-numConstants)),1<inputs.length&&(initialState=inputs.slice(1,inputs.length)),inputs=inputs[0]}function toListOrNull(x){return null==x||Array.isArray(x)?x:[x]}return{inputs:inputs,initialState:initialState=toListOrNull(initialState),constants:constants=toListOrNull(constants)}}function rnn(stepFunction,inputs,initialStates,goBackwards,mask,constants,unroll,needPerStepOutputs){return void 0===goBackwards&&(goBackwards=!1),void 0===unroll&&(unroll=!1),void 0===needPerStepOutputs&&(needPerStepOutputs=!1),tfc.tidy(function(){var ndim=inputs.shape.length;if(ndim<3)throw new errors_1.ValueError("Input should be at least 3D, but is "+ndim+"D.");var axes=[1,0].concat(math_utils.range(2,ndim));if(inputs=tfc.transpose(inputs,axes),null!=constants)throw new errors_1.NotImplementedError("The rnn() functoin of the deeplearn.js backend does not support constants yet.");unroll&&console.warn("Backend rnn(): the unroll = true option is not applicable to the imperative deeplearn.js backend."),null!=mask&&((mask=mask.asType("bool").asType("float32")).rank===ndim-1&&(mask=tfc.expandDims(mask,-1)),mask=tfc.transpose(mask,axes)),goBackwards&&(inputs=tfc.reverse(inputs,0),null!=mask&&(mask=tfc.reverse(mask,0)));var lastOutput,perStepMasks,perStepOutputs=[],states=initialStates,timeSteps=inputs.shape[0],perStepInputs=tfc.unstack(inputs);null!=mask&&(perStepMasks=tfc.unstack(mask));for(var outputs,_loop_1=function(t){var currentInput=perStepInputs[t],stepOutputs=tfc.tidy(function(){return stepFunction(currentInput,states)});if(null==mask)lastOutput=stepOutputs[0],states=stepOutputs[1];else{var maskedOutputs=tfc.tidy(function(){var stepMask=perStepMasks[t],negStepMask=tfc.onesLike(stepMask).sub(stepMask);return{output:stepOutputs[0].mul(stepMask).addStrict(states[0].mul(negStepMask)),newStates:states.map(function(state,i){return stepOutputs[1][i].mul(stepMask).addStrict(state.mul(negStepMask))})}});lastOutput=maskedOutputs.output,states=maskedOutputs.newStates}needPerStepOutputs&&perStepOutputs.push(lastOutput)},t=0;t<timeSteps;++t)_loop_1(t);if(needPerStepOutputs){outputs=tfc.stack(perStepOutputs,1)}return[lastOutput,outputs,states]})}exports.standardizeArgs=standardizeArgs,exports.rnn=rnn;var RNN=function(_super){function RNN(args){var cell,_this=_super.call(this,args)||this;if(null==args.cell)throw new errors_1.ValueError("cell property is missing for the constructor of RNN.");if(null==(cell=Array.isArray(args.cell)?new StackedRNNCells({cells:args.cell}):args.cell).stateSize)throw new errors_1.ValueError("The RNN cell should have an attribute `stateSize` (tuple of integers, one integer per RNN state).");return _this.cell=cell,_this.returnSequences=null!=args.returnSequences&&args.returnSequences,_this.returnState=null!=args.returnState&&args.returnState,_this.goBackwards=null!=args.goBackwards&&args.goBackwards,_this._stateful=null!=args.stateful&&args.stateful,_this.unroll=null!=args.unroll&&args.unroll,_this.supportsMasking=!0,_this.inputSpec=[new topology_1.InputSpec({ndim:3})],_this.stateSpec=null,_this.states_=null,_this.numConstants=null,_this.keptStates=[],_this}return __extends(RNN,_super),RNN.prototype.getStates=function(){if(null!=this.states_)return this.states_;var numStates=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1;return math_utils.range(0,numStates).map(function(x){return null})},RNN.prototype.setStates=function(states){this.states_=states},RNN.prototype.computeOutputShape=function(inputShape){types_utils_1.isArrayOfShapes(inputShape)&&(inputShape=inputShape[0]),inputShape=inputShape;var stateSize=this.cell.stateSize;Array.isArray(stateSize)||(stateSize=[stateSize]);var outputShape,outputDim=stateSize[0];if(outputShape=this.returnSequences?[inputShape[0],inputShape[1],outputDim]:[inputShape[0],outputDim],this.returnState){for(var stateShape=[],_i=0,stateSize_1=stateSize;_i<stateSize_1.length;_i++){var dim=stateSize_1[_i];stateShape.push([inputShape[0],dim])}return[outputShape].concat(stateShape)}return outputShape},RNN.prototype.computeMask=function(inputs,mask){var _this=this;return tfc.tidy(function(){Array.isArray(mask)&&(mask=mask[0]);var outputMask=_this.returnSequences?mask:null;if(_this.returnState){var stateMask=_this.states.map(function(s){return null});return[outputMask].concat(stateMask)}return outputMask})},Object.defineProperty(RNN.prototype,"states",{get:function(){if(null!=this.states_)return this.states_;for(var numStates=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1,output=[],i=0;i<numStates;++i)output.push(null);return output},set:function(s){this.states_=s},enumerable:!0,configurable:!0}),RNN.prototype.build=function(inputShape){if(null!=this.numConstants)throw new errors_1.NotImplementedError("Constants support is not implemented in RNN yet.");types_utils_1.isArrayOfShapes(inputShape)&&(inputShape=inputShape[0]),inputShape=inputShape;var batchSize=this.stateful?inputShape[0]:null,inputDim=inputShape[inputShape.length-1];this.inputSpec[0]=new topology_1.InputSpec({shape:[batchSize,null,inputDim]});var stateSize,stepInputShape=[inputShape[0]].concat(inputShape.slice(2));if(this.cell.build(stepInputShape),stateSize=Array.isArray(this.cell.stateSize)?this.cell.stateSize:[this.cell.stateSize],null!=this.stateSpec){if(!tfjs_core_1.util.arraysEqual(this.stateSpec.map(function(spec){return spec.shape[spec.shape.length-1]}),stateSize))throw new errors_1.ValueError("An initialState was passed that is not compatible with cell.stateSize. Received stateSpec="+this.stateSpec+"; However cell.stateSize is "+this.cell.stateSize)}else this.stateSpec=stateSize.map(function(dim){return new topology_1.InputSpec({shape:[null,dim]})});this.stateful&&this.resetStates()},RNN.prototype.resetStates=function(states,training){var _this=this;void 0===training&&(training=!1),tfjs_core_1.tidy(function(){if(!_this.stateful)throw new errors_1.AttributeError("Cannot call resetStates() on an RNN Layer that is not stateful.");var batchSize=_this.inputSpec[0].shape[0];if(null==batchSize)throw new errors_1.ValueError("If an RNN is stateful, it needs to know its batch size. Specify the batch size of your input tensors: \n- If using a Sequential model, specify the batch size by passing a `batchInputShape` option to your first layer.\n- If using the functional API, specify the batch size by passing a `batchShape` option to your Input layer.");if(null==_this.states_)Array.isArray(_this.cell.stateSize)?_this.states_=_this.cell.stateSize.map(function(dim){return tfc.zeros([batchSize,dim])}):_this.states_=[tfc.zeros([batchSize,_this.cell.stateSize])];else if(null==states)tfc.dispose(_this.states_),null!=_this.keptStates&&(tfc.dispose(_this.keptStates),_this.keptStates=[]),Array.isArray(_this.cell.stateSize)?_this.states_=_this.cell.stateSize.map(function(dim){return tfc.zeros([batchSize,dim])}):_this.states_[0]=tfc.zeros([batchSize,_this.cell.stateSize]);else{if(Array.isArray(states)||(states=[states]),states.length!==_this.states_.length)throw new errors_1.ValueError("Layer "+_this.name+" expects "+_this.states_.length+" state(s), but it received "+states.length+" state value(s). Input received: "+states);!0===training?_this.keptStates.push(_this.states_.slice()):tfc.dispose(_this.states_);for(var index=0;index<_this.states_.length;++index){var value=states[index],dim=Array.isArray(_this.cell.stateSize)?_this.cell.stateSize[index]:_this.cell.stateSize,expectedShape=[batchSize,dim];if(!tfjs_core_1.util.arraysEqual(value.shape,expectedShape))throw new errors_1.ValueError("State "+index+" is incompatible with layer "+_this.name+": expected shape="+expectedShape+", received shape="+value.shape);_this.states_[index]=value}}_this.states_=_this.states_.map(function(state){return tfc.keep(state.clone())})})},RNN.prototype.apply=function(inputs,kwargs){var initialState=null==kwargs?null:kwargs.initialState,constants=null==kwargs?null:kwargs.constants;null==kwargs&&(kwargs={});var standardized=standardizeArgs(inputs,initialState,constants,this.numConstants);inputs=standardized.inputs,initialState=standardized.initialState,constants=standardized.constants;var additionalInputs=[],additionalSpecs=[];if(null!=initialState){kwargs.initialState=initialState,additionalInputs=additionalInputs.concat(initialState),this.stateSpec=[];for(var _i=0,initialState_1=initialState;_i<initialState_1.length;_i++){var state=initialState_1[_i];this.stateSpec.push(new topology_1.InputSpec({shape:state.shape}))}additionalSpecs=additionalSpecs.concat(this.stateSpec)}if(null!=constants&&(kwargs.constants=constants,additionalInputs=additionalInputs.concat(constants),this.numConstants=constants.length),additionalInputs[0]instanceof topology_1.SymbolicTensor){var fullInput=[inputs].concat(additionalInputs),fullInputSpec=this.inputSpec.concat(additionalSpecs),originalInputSpec=this.inputSpec;this.inputSpec=fullInputSpec;var output=_super.prototype.apply.call(this,fullInput,kwargs);return this.inputSpec=originalInputSpec,output}return _super.prototype.apply.call(this,inputs,kwargs)},RNN.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;inputs=types_utils_1.getExactlyOneTensor(inputs),null==initialState&&(initialState=_this.stateful?_this.states_:_this.getInitialState(inputs));var numStates=Array.isArray(_this.cell.stateSize)?_this.cell.stateSize.length:1;if(initialState.length!==numStates)throw new errors_1.ValueError("RNN Layer has "+numStates+" state(s) but was passed "+initialState.length+" initial state(s).");_this.unroll&&console.warn("Ignoring unroll = true for RNN layer, due to imperative backend.");var cellCallKwargs={training:training},rnnOutputs=rnn(function(inputs,states){var outputs=_this.cell.call([inputs].concat(states),cellCallKwargs);return[outputs[0],outputs.slice(1)]},inputs,initialState,_this.goBackwards,mask,null,_this.unroll,_this.returnSequences),lastOutput=rnnOutputs[0],outputs=rnnOutputs[1],states=rnnOutputs[2];_this.stateful&&_this.resetStates(states,training);var output=_this.returnSequences?outputs:lastOutput;return _this.returnState?[output].concat(states):output})},RNN.prototype.getInitialState=function(inputs){var _this=this;return tfjs_core_1.tidy(function(){var initialState=tfc.zeros(inputs.shape);return initialState=tfc.sum(initialState,[1,2]),initialState=K.expandDims(initialState),Array.isArray(_this.cell.stateSize)?_this.cell.stateSize.map(function(dim){return 1<dim?K.tile(initialState,[1,dim]):initialState}):1<_this.cell.stateSize?[K.tile(initialState,[1,_this.cell.stateSize])]:[initialState]})},Object.defineProperty(RNN.prototype,"trainableWeights",{get:function(){return this.trainable?this.cell.trainableWeights:[]},enumerable:!0,configurable:!0}),Object.defineProperty(RNN.prototype,"nonTrainableWeights",{get:function(){return this.trainable?this.cell.nonTrainableWeights:this.cell.weights},enumerable:!0,configurable:!0}),RNN.prototype.setFastWeightInitDuringBuild=function(value){_super.prototype.setFastWeightInitDuringBuild.call(this,value),null!=this.cell&&this.cell.setFastWeightInitDuringBuild(value)},RNN.prototype.getConfig=function(){var config={returnSequences:this.returnSequences,returnState:this.returnState,goBackwards:this.goBackwards,stateful:this.stateful,unroll:this.unroll};null!=this.numConstants&&(config.numConstants=this.numConstants);var cellConfig=this.cell.getConfig();config.cell={className:this.cell.getClassName(),config:cellConfig};var baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},RNN.fromConfig=function(cls,config,customObjects){void 0===customObjects&&(customObjects={});var cellConfig=config.cell,cell=serialization_1.deserialize(cellConfig,customObjects);return new cls(Object.assign(config,{cell:cell}))},RNN.className="RNN",RNN}(topology_2.Layer);exports.RNN=RNN,tfjs_core_1.serialization.registerClass(RNN);var RNNCell=function(_super){function RNNCell(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(RNNCell,_super),RNNCell}(topology_2.Layer),SimpleRNNCell=function(_super){function SimpleRNNCell(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_ACTIVATION="tanh",_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",_this.DEFAULT_BIAS_INITIALIZER="zeros",_this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(null==args.activation?_this.DEFAULT_ACTIVATION:args.activation),_this.useBias=null==args.useBias||args.useBias,_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.recurrentInitializer=initializers_1.getInitializer(args.recurrentInitializer||_this.DEFAULT_RECURRENT_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.recurrentRegularizer=regularizers_1.getRegularizer(args.recurrentRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.recurrentConstraint=constraints_1.getConstraint(args.recurrentConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.dropout=math_utils.min([1,math_utils.max([0,null==args.dropout?0:args.dropout])]),_this.recurrentDropout=math_utils.min([1,math_utils.max([0,null==args.recurrentDropout?0:args.recurrentDropout])]),_this.stateSize=_this.units,_this.dropoutMask=null,_this.recurrentDropoutMask=null,_this}return __extends(SimpleRNNCell,_super),SimpleRNNCell.prototype.build=function(inputShape){inputShape=types_utils_1.getExactlyOneShape(inputShape),this.kernel=this.addWeight("kernel",[inputShape[inputShape.length-1],this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},SimpleRNNCell.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(2!==(inputs=inputs).length)throw new errors_1.ValueError("SimpleRNNCell expects 2 input Tensors, got "+inputs.length+".");var prevOutput=inputs[1];inputs=inputs[0];var h,training=null!=kwargs.training&&kwargs.training;0<_this.dropout&&_this.dropout<1&&null==_this.dropoutMask&&(_this.dropoutMask=generateDropoutMask(function(){return tfc.onesLike(inputs)},_this.dropout,training)),0<_this.recurrentDropout&&_this.recurrentDropout<1&&null==_this.recurrentDropoutMask&&(_this.recurrentDropoutMask=generateDropoutMask(function(){return tfc.onesLike(prevOutput)},_this.recurrentDropout,training));var dpMask=_this.dropoutMask,recDpMask=_this.recurrentDropoutMask;h=null!=dpMask?K.dot(tfc.mul(inputs,dpMask),_this.kernel.read()):K.dot(inputs,_this.kernel.read()),null!=_this.bias&&(h=K.biasAdd(h,_this.bias.read())),null!=recDpMask&&(prevOutput=tfc.mul(prevOutput,recDpMask));var output=tfc.add(h,K.dot(prevOutput,_this.recurrentKernel.read()));return null!=_this.activation&&(output=_this.activation.apply(output)),[output,output]})},SimpleRNNCell.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},SimpleRNNCell.className="SimpleRNNCell",SimpleRNNCell}(exports.RNNCell=RNNCell);exports.SimpleRNNCell=SimpleRNNCell,tfjs_core_1.serialization.registerClass(SimpleRNNCell);var SimpleRNN=function(_super){function SimpleRNN(args){return args.cell=new SimpleRNNCell(args),_super.call(this,args)||this}return __extends(SimpleRNN,_super),SimpleRNN.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){null!=_this.cell.dropoutMask&&(tfc.dispose(_this.cell.dropoutMask),_this.cell.dropoutMask=null),null!=_this.cell.recurrentDropoutMask&&(tfc.dispose(_this.cell.recurrentDropoutMask),_this.cell.recurrentDropoutMask=null);var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;return _super.prototype.call.call(_this,inputs,{mask:mask,training:training,initialState:initialState})})},Object.defineProperty(SimpleRNN.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(SimpleRNN.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),SimpleRNN.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout},baseConfig=_super.prototype.getConfig.call(this);return delete baseConfig.cell,Object.assign(config,baseConfig),config},SimpleRNN.fromConfig=function(cls,config){return new cls(config)},SimpleRNN.className="SimpleRNN",SimpleRNN}(RNN);exports.SimpleRNN=SimpleRNN,tfjs_core_1.serialization.registerClass(SimpleRNN);var GRUCell=function(_super){function GRUCell(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_ACTIVATION="tanh",_this.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",_this.DEFAULT_BIAS_INITIALIZER="zeros",_this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(void 0===args.activation?_this.DEFAULT_ACTIVATION:args.activation),_this.recurrentActivation=activations_1.getActivation(void 0===args.recurrentActivation?_this.DEFAULT_RECURRENT_ACTIVATION:args.recurrentActivation),_this.useBias=null==args.useBias||args.useBias,_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.recurrentInitializer=initializers_1.getInitializer(args.recurrentInitializer||_this.DEFAULT_RECURRENT_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.recurrentRegularizer=regularizers_1.getRegularizer(args.recurrentRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.recurrentConstraint=constraints_1.getConstraint(args.recurrentConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.dropout=math_utils.min([1,math_utils.max([0,null==args.dropout?0:args.dropout])]),_this.recurrentDropout=math_utils.min([1,math_utils.max([0,null==args.recurrentDropout?0:args.recurrentDropout])]),_this.implementation=args.implementation,_this.stateSize=_this.units,_this.dropoutMask=null,_this.recurrentDropoutMask=null,_this}return __extends(GRUCell,_super),GRUCell.prototype.build=function(inputShape){var inputDim=(inputShape=types_utils_1.getExactlyOneShape(inputShape))[inputShape.length-1];this.kernel=this.addWeight("kernel",[inputDim,3*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,3*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[3*this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0},GRUCell.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(2!==(inputs=inputs).length)throw new errors_1.ValueError("GRUCell expects 2 input Tensors (inputs, h, c), got "+inputs.length+".");var training=null!=kwargs.training&&kwargs.training,hTMinus1=inputs[1];inputs=inputs[0],0<_this.dropout&&_this.dropout<1&&null==_this.dropoutMask&&(_this.dropoutMask=generateDropoutMask(function(){return tfc.onesLike(inputs)},_this.dropout,training,3)),0<_this.recurrentDropout&&_this.recurrentDropout<1&&null==_this.recurrentDropoutMask&&(_this.recurrentDropoutMask=generateDropoutMask(function(){return tfc.onesLike(hTMinus1)},_this.recurrentDropout,training,3));var z,r,hh,dpMask=_this.dropoutMask,recDpMask=_this.recurrentDropoutMask;0<_this.dropout&&_this.dropout<1&&(inputs=tfc.mul(inputs,dpMask[0]));var matrixX=K.dot(inputs,_this.kernel.read());_this.useBias&&(matrixX=K.biasAdd(matrixX,_this.bias.read())),0<_this.recurrentDropout&&_this.recurrentDropout<1&&(hTMinus1=tfc.mul(hTMinus1,recDpMask[0]));var recurrentKernelValue=_this.recurrentKernel.read(),_a=tfc.split(recurrentKernelValue,[2*_this.units,_this.units],recurrentKernelValue.rank-1),rk1=_a[0],rk2=_a[1],matrixInner=K.dot(hTMinus1,rk1),_b=tfc.split(matrixX,3,matrixX.rank-1),xZ=_b[0],xR=_b[1],xH=_b[2],_c=tfc.split(matrixInner,2,matrixInner.rank-1),recurrentZ=_c[0],recurrentR=_c[1];z=_this.recurrentActivation.apply(tfc.add(xZ,recurrentZ)),r=_this.recurrentActivation.apply(tfc.add(xR,recurrentR));var recurrentH=K.dot(tfc.mul(r,hTMinus1),rk2);hh=_this.activation.apply(tfc.add(xH,recurrentH));var h=tfc.add(tfc.mul(z,hTMinus1),tfc.mul(tfc.add(1,tfc.neg(z)),hh));return[h,h]})},GRUCell.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},GRUCell.className="GRUCell",GRUCell}(RNNCell);exports.GRUCell=GRUCell,tfjs_core_1.serialization.registerClass(GRUCell);var GRU=function(_super){function GRU(args){return 0===args.implementation&&console.warn("`implementation=0` has been deprecated, and now defaults to `implementation=1`. Please update your layer call."),args.cell=new GRUCell(args),_super.call(this,args)||this}return __extends(GRU,_super),GRU.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){null!=_this.cell.dropoutMask&&(tfc.dispose(_this.cell.dropoutMask),_this.cell.dropoutMask=null),null!=_this.cell.recurrentDropoutMask&&(tfc.dispose(_this.cell.recurrentDropoutMask),_this.cell.recurrentDropoutMask=null);var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;return _super.prototype.call.call(_this,inputs,{mask:mask,training:training,initialState:initialState})})},Object.defineProperty(GRU.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentActivation",{get:function(){return this.cell.recurrentActivation},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),Object.defineProperty(GRU.prototype,"implementation",{get:function(){return this.cell.implementation},enumerable:!0,configurable:!0}),GRU.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return delete baseConfig.cell,Object.assign(config,baseConfig),config},GRU.fromConfig=function(cls,config){return 0===config.implmentation&&(config.implementation=1),new cls(config)},GRU.className="GRU",GRU}(RNN);exports.GRU=GRU,tfjs_core_1.serialization.registerClass(GRU);var LSTMCell=function(_super){function LSTMCell(args){var _this=_super.call(this,args)||this;return _this.DEFAULT_ACTIVATION="tanh",_this.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",_this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",_this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",_this.DEFAULT_BIAS_INITIALIZER="zeros",_this.units=args.units,generic_utils_1.assertPositiveInteger(_this.units,"units"),_this.activation=activations_1.getActivation(void 0===args.activation?_this.DEFAULT_ACTIVATION:args.activation),_this.recurrentActivation=activations_1.getActivation(void 0===args.recurrentActivation?_this.DEFAULT_RECURRENT_ACTIVATION:args.recurrentActivation),_this.useBias=null==args.useBias||args.useBias,_this.kernelInitializer=initializers_1.getInitializer(args.kernelInitializer||_this.DEFAULT_KERNEL_INITIALIZER),_this.recurrentInitializer=initializers_1.getInitializer(args.recurrentInitializer||_this.DEFAULT_RECURRENT_INITIALIZER),_this.biasInitializer=initializers_1.getInitializer(args.biasInitializer||_this.DEFAULT_BIAS_INITIALIZER),_this.unitForgetBias=args.unitForgetBias,_this.kernelRegularizer=regularizers_1.getRegularizer(args.kernelRegularizer),_this.recurrentRegularizer=regularizers_1.getRegularizer(args.recurrentRegularizer),_this.biasRegularizer=regularizers_1.getRegularizer(args.biasRegularizer),_this.kernelConstraint=constraints_1.getConstraint(args.kernelConstraint),_this.recurrentConstraint=constraints_1.getConstraint(args.recurrentConstraint),_this.biasConstraint=constraints_1.getConstraint(args.biasConstraint),_this.dropout=math_utils.min([1,math_utils.max([0,null==args.dropout?0:args.dropout])]),_this.recurrentDropout=math_utils.min([1,math_utils.max([0,null==args.recurrentDropout?0:args.recurrentDropout])]),_this.implementation=args.implementation,_this.stateSize=[_this.units,_this.units],_this.dropoutMask=null,_this.recurrentDropoutMask=null,_this}return __extends(LSTMCell,_super),LSTMCell.prototype.build=function(inputShape){var _a,biasInitializer,_super,inputDim=(inputShape=types_utils_1.getExactlyOneShape(inputShape))[inputShape.length-1];if(this.kernel=this.addWeight("kernel",[inputDim,4*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,4*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias){if(this.unitForgetBias){var capturedBiasInit_1=this.biasInitializer,capturedUnits_1=this.units;_super=initializers_1.Initializer,__extends(CustomInit,_super),CustomInit.prototype.apply=function(shape,dtype){var bI=capturedBiasInit_1.apply([capturedUnits_1]),bF=(new initializers_1.Ones).apply([capturedUnits_1]),bCAndH=capturedBiasInit_1.apply([2*capturedUnits_1]);return K.concatAlongFirstAxis(K.concatAlongFirstAxis(bI,bF),bCAndH)},(_a=CustomInit).className="CustomInit",biasInitializer=new _a}else biasInitializer=this.biasInitializer;this.bias=this.addWeight("bias",[4*this.units],null,biasInitializer,this.biasRegularizer,!0,this.biasConstraint)}else this.bias=null;function CustomInit(){return null!==_super&&_super.apply(this,arguments)||this}this.built=!0},LSTMCell.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){var training=null!=kwargs.training&&kwargs.training;if(3!==(inputs=inputs).length)throw new errors_1.ValueError("LSTMCell expects 3 input Tensors (inputs, h, c), got "+inputs.length+".");var hTMinus1=inputs[1],cTMinus1=inputs[2];inputs=inputs[0],0<_this.dropout&&_this.dropout<1&&null==_this.dropoutMask&&(_this.dropoutMask=generateDropoutMask(function(){return tfc.onesLike(inputs)},_this.dropout,training,4)),0<_this.recurrentDropout&&_this.recurrentDropout<1&&null==_this.recurrentDropoutMask&&(_this.recurrentDropoutMask=generateDropoutMask(function(){return tfc.onesLike(hTMinus1)},_this.recurrentDropout,training,4));var i,f,c,o,dpMask=_this.dropoutMask,recDpMask=_this.recurrentDropoutMask;0<_this.dropout&&_this.dropout<1&&(inputs=tfc.mul(inputs,dpMask[0]));var z=K.dot(inputs,_this.kernel.read());0<_this.recurrentDropout&&_this.recurrentDropout<1&&(hTMinus1=tfc.mul(hTMinus1,recDpMask[0])),z=tfc.add(z,K.dot(hTMinus1,_this.recurrentKernel.read())),_this.useBias&&(z=K.biasAdd(z,_this.bias.read()));var _a=tfc.split(z,4,z.rank-1),z0=_a[0],z1=_a[1],z2=_a[2],z3=_a[3];i=_this.recurrentActivation.apply(z0),f=_this.recurrentActivation.apply(z1),c=tfc.add(tfc.mul(f,cTMinus1),tfc.mul(i,_this.activation.apply(z2))),o=_this.recurrentActivation.apply(z3);var h=tfc.mul(o,_this.activation.apply(c));return[h,h,c]})},LSTMCell.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},LSTMCell.className="LSTMCell",LSTMCell}(RNNCell);exports.LSTMCell=LSTMCell,tfjs_core_1.serialization.registerClass(LSTMCell);var LSTM=function(_super){function LSTM(args){return 0===args.implementation&&console.warn("`implementation=0` has been deprecated, and now defaults to `implementation=1`. Please update your layer call."),args.cell=new LSTMCell(args),_super.call(this,args)||this}return __extends(LSTM,_super),LSTM.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){null!=_this.cell.dropoutMask&&(tfc.dispose(_this.cell.dropoutMask),_this.cell.dropoutMask=null),null!=_this.cell.recurrentDropoutMask&&(tfc.dispose(_this.cell.recurrentDropoutMask),_this.cell.recurrentDropoutMask=null);var mask=null==kwargs?null:kwargs.mask,training=null==kwargs?null:kwargs.training,initialState=null==kwargs?null:kwargs.initialState;return _super.prototype.call.call(_this,inputs,{mask:mask,training:training,initialState:initialState})})},Object.defineProperty(LSTM.prototype,"units",{get:function(){return this.cell.units},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"activation",{get:function(){return this.cell.activation},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentActivation",{get:function(){return this.cell.recurrentActivation},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"useBias",{get:function(){return this.cell.useBias},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"kernelInitializer",{get:function(){return this.cell.kernelInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentInitializer",{get:function(){return this.cell.recurrentInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"biasInitializer",{get:function(){return this.cell.biasInitializer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"unitForgetBias",{get:function(){return this.cell.unitForgetBias},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"kernelRegularizer",{get:function(){return this.cell.kernelRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentRegularizer",{get:function(){return this.cell.recurrentRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"biasRegularizer",{get:function(){return this.cell.biasRegularizer},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"kernelConstraint",{get:function(){return this.cell.kernelConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentConstraint",{get:function(){return this.cell.recurrentConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"biasConstraint",{get:function(){return this.cell.biasConstraint},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"dropout",{get:function(){return this.cell.dropout},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"recurrentDropout",{get:function(){return this.cell.recurrentDropout},enumerable:!0,configurable:!0}),Object.defineProperty(LSTM.prototype,"implementation",{get:function(){return this.cell.implementation},enumerable:!0,configurable:!0}),LSTM.prototype.getConfig=function(){var config={units:this.units,activation:activations_1.serializeActivation(this.activation),recurrentActivation:activations_1.serializeActivation(this.recurrentActivation),useBias:this.useBias,kernelInitializer:initializers_1.serializeInitializer(this.kernelInitializer),recurrentInitializer:initializers_1.serializeInitializer(this.recurrentInitializer),biasInitializer:initializers_1.serializeInitializer(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:regularizers_1.serializeRegularizer(this.kernelRegularizer),recurrentRegularizer:regularizers_1.serializeRegularizer(this.recurrentRegularizer),biasRegularizer:regularizers_1.serializeRegularizer(this.biasRegularizer),activityRegularizer:regularizers_1.serializeRegularizer(this.activityRegularizer),kernelConstraint:constraints_1.serializeConstraint(this.kernelConstraint),recurrentConstraint:constraints_1.serializeConstraint(this.recurrentConstraint),biasConstraint:constraints_1.serializeConstraint(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation},baseConfig=_super.prototype.getConfig.call(this);return delete baseConfig.cell,Object.assign(config,baseConfig),config},LSTM.fromConfig=function(cls,config){return 0===config.implmentation&&(config.implementation=1),new cls(config)},LSTM.className="LSTM",LSTM}(RNN);exports.LSTM=LSTM,tfjs_core_1.serialization.registerClass(LSTM);var StackedRNNCells=function(_super){function StackedRNNCells(args){var _this=_super.call(this,args)||this;return _this.cells=args.cells,_this}return __extends(StackedRNNCells,_super),Object.defineProperty(StackedRNNCells.prototype,"stateSize",{get:function(){for(var stateSize=[],_i=0,_a=this.cells.slice().reverse();_i<_a.length;_i++){var cell=_a[_i];Array.isArray(cell.stateSize)?stateSize.push.apply(stateSize,cell.stateSize):stateSize.push(cell.stateSize)}return stateSize},enumerable:!0,configurable:!0}),StackedRNNCells.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){for(var states=(inputs=inputs).slice(1),nestedStates=[],_i=0,_a=_this.cells.slice().reverse();_i<_a.length;_i++){var cell=_a[_i];Array.isArray(cell.stateSize)?nestedStates.push(states.splice(0,cell.stateSize.length)):nestedStates.push(states.splice(0,1))}nestedStates.reverse();for(var callInputs,newNestedStates=[],i=0;i<_this.cells.length;++i){cell=_this.cells[i];states=nestedStates[i],callInputs=0===i?[inputs[0]].concat(states):[callInputs[0]].concat(states),callInputs=cell.call(callInputs,kwargs),newNestedStates.push(callInputs.slice(1))}states=[];for(var _b=0,_c=newNestedStates.slice().reverse();_b<_c.length;_b++){var cellStates=_c[_b];states.push.apply(states,cellStates)}return[callInputs[0]].concat(states)})},StackedRNNCells.prototype.build=function(inputShape){var outputDim;types_utils_1.isArrayOfShapes(inputShape)&&(inputShape=inputShape[0]),inputShape=inputShape;for(var _i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];cell.build(inputShape),outputDim=Array.isArray(cell.stateSize)?cell.stateSize[0]:cell.stateSize,inputShape=[inputShape[0],outputDim]}this.built=!0},StackedRNNCells.prototype.getConfig=function(){for(var cellConfigs=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];cellConfigs.push({className:cell.getClassName(),config:cell.getConfig()})}var config={cells:cellConfigs},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},StackedRNNCells.fromConfig=function(cls,config,customObjects){void 0===customObjects&&(customObjects={});for(var cells=[],_i=0,_a=config.cells;_i<_a.length;_i++){var cellConfig=_a[_i];cells.push(serialization_1.deserialize(cellConfig,customObjects))}return new cls({cells:cells})},Object.defineProperty(StackedRNNCells.prototype,"trainableWeights",{get:function(){if(!this.trainable)return[];for(var weights=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];weights.push.apply(weights,cell.trainableWeights)}return weights},enumerable:!0,configurable:!0}),Object.defineProperty(StackedRNNCells.prototype,"nonTrainableWeights",{get:function(){for(var weights=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];weights.push.apply(weights,cell.nonTrainableWeights)}if(this.trainable)return weights;for(var trainableWeights=[],_b=0,_c=this.cells;_b<_c.length;_b++){cell=_c[_b];trainableWeights.push.apply(trainableWeights,cell.trainableWeights)}return trainableWeights.concat(weights)},enumerable:!0,configurable:!0}),StackedRNNCells.prototype.getWeights=function(){for(var weights=[],_i=0,_a=this.cells;_i<_a.length;_i++){var cell=_a[_i];weights.push.apply(weights,cell.weights)}return variables_1.batchGetValue(weights)},StackedRNNCells.prototype.setWeights=function(weights){for(var tuples=[],_i=0,_a=this.cells;_i<_a.length;_i++)for(var cell=_a[_i],numParams=cell.weights.length,inputWeights=weights.splice(numParams),i=0;i<cell.weights.length;++i)tuples.push([cell.weights[i],inputWeights[i]]);variables_1.batchSetValue(tuples)},StackedRNNCells.className="StackedRNNCells",StackedRNNCells}(RNNCell);function generateDropoutMask(ones,rate,training,count){function droppedInputs(){return K.dropout(ones(),rate)}if(void 0===training&&(training=null),void 0===count&&(count=1),1<count){for(var mask=[],i=0;i<count;i++)mask.push(K.inTrainPhase(droppedInputs,ones,training));return mask.map(function(m){return tfc.keep(m.clone())})}return tfc.keep(K.inTrainPhase(droppedInputs,ones,training).clone())}exports.StackedRNNCells=StackedRNNCells,tfjs_core_1.serialization.registerClass(StackedRNNCells)},{"../activations":273,"../backend/tfjs_backend":276,"../constraints":280,"../engine/topology":284,"../errors":289,"../initializers":298,"../regularizers":319,"../utils/generic_utils":322,"../utils/math_utils":324,"../utils/types_utils":326,"../variables":328,"./serialization":312,"@tensorflow/tfjs-core":148}],312:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),generic_utils_1=require("../utils/generic_utils");exports.deserialize=function(config,customObjects,fastWeightInit){return void 0===customObjects&&(customObjects={}),void 0===fastWeightInit&&(fastWeightInit=!1),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"layer",fastWeightInit)}},{"../utils/generic_utils":322,"@tensorflow/tfjs-core":148}],313:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("../backend/tfjs_backend"),common_1=require("../common"),topology_1=require("../engine/topology"),errors_1=require("../errors"),common_2=require("../keras_format/common"),generic_utils=require("../utils/generic_utils"),types_utils_1=require("../utils/types_utils"),recurrent_1=require("./recurrent"),serialization_1=require("./serialization"),Wrapper=function(_super){function Wrapper(args){var _this=_super.call(this,args)||this;return _this.layer=args.layer,_this}return __extends(Wrapper,_super),Wrapper.prototype.build=function(inputShape){this.built=!0},Object.defineProperty(Wrapper.prototype,"trainable",{get:function(){return null!=this.layer&&this.layer.trainable},set:function(value){null!=this.layer&&(this.layer.trainable=value)},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"trainableWeights",{get:function(){return this.layer.trainableWeights},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"nonTrainableWeights",{get:function(){return this.layer.nonTrainableWeights},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"updates",{get:function(){return this.layer._updates},enumerable:!0,configurable:!0}),Object.defineProperty(Wrapper.prototype,"losses",{get:function(){return this.layer.losses},enumerable:!0,configurable:!0}),Wrapper.prototype.getWeights=function(){return this.layer.getWeights()},Wrapper.prototype.setWeights=function(weights){this.layer.setWeights(weights)},Wrapper.prototype.getConfig=function(){var config={layer:{className:this.layer.getClassName(),config:this.layer.getConfig()}},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Wrapper.prototype.setFastWeightInitDuringBuild=function(value){_super.prototype.setFastWeightInitDuringBuild.call(this,value),null!=this.layer&&this.layer.setFastWeightInitDuringBuild(value)},Wrapper.fromConfig=function(cls,config,customObjects){void 0===customObjects&&(customObjects={});var layerConfig=config.layer,layer=serialization_1.deserialize(layerConfig,customObjects);delete config.layer;var newConfig={layer:layer};return Object.assign(newConfig,config),new cls(newConfig)},Wrapper}(topology_1.Layer),TimeDistributed=function(_super){function TimeDistributed(args){var _this=_super.call(this,args)||this;return _this.supportsMasking=!0,_this}return __extends(TimeDistributed,_super),TimeDistributed.prototype.build=function(inputShape){if((inputShape=types_utils_1.getExactlyOneShape(inputShape)).length<3)throw new errors_1.ValueError("TimeDistributed layer expects an input shape >= 3D, but received input shape "+JSON.stringify(inputShape));this.inputSpec=[{shape:inputShape}];var childInputShape=[inputShape[0]].concat(inputShape.slice(2));this.layer.built||(this.layer.build(childInputShape),this.layer.built=!0),_super.prototype.build.call(this,inputShape)},TimeDistributed.prototype.computeOutputShape=function(inputShape){var childInputShape=[(inputShape=types_utils_1.getExactlyOneShape(inputShape))[0]].concat(inputShape.slice(2)),childOutputShape=this.layer.computeOutputShape(childInputShape),timesteps=inputShape[1];return[childOutputShape[0],timesteps].concat(childOutputShape.slice(1))},TimeDistributed.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){inputs=types_utils_1.getExactlyOneTensor(inputs);return recurrent_1.rnn(function(inputs,states){return[types_utils_1.getExactlyOneTensor(_this.layer.call(inputs,kwargs)),[]]},inputs,[],!1,null,null,!1,!0)[1]})},TimeDistributed.className="TimeDistributed",TimeDistributed}(exports.Wrapper=Wrapper);function checkBidirectionalMergeMode(value){generic_utils.checkStringTypeUnionValue(common_2.VALID_BIDIRECTIONAL_MERGE_MODES,"BidirectionalMergeMode",value)}exports.TimeDistributed=TimeDistributed,tfjs_core_1.serialization.registerClass(TimeDistributed),exports.checkBidirectionalMergeMode=checkBidirectionalMergeMode;var Bidirectional=function(_super){function Bidirectional(args){var _this=_super.call(this,args)||this,layerConfig=args.layer.getConfig(),forwDict={};forwDict.className=args.layer.getClassName(),forwDict.config=layerConfig,_this.forwardLayer=serialization_1.deserialize(forwDict),layerConfig.goBackwards=!0!==layerConfig.goBackwards;var backDict={};if(backDict.className=args.layer.getClassName(),backDict.config=layerConfig,_this.backwardLayer=serialization_1.deserialize(backDict),_this.forwardLayer.name="forward_"+_this.forwardLayer.name,_this.backwardLayer.name="backward_"+_this.backwardLayer.name,_this.mergeMode=void 0===args.mergeMode?"concat":args.mergeMode,checkBidirectionalMergeMode(_this.mergeMode),args.weights)throw new errors_1.NotImplementedError("weights support is not implemented for Bidirectional layer yet.");return _this._stateful=args.layer.stateful,_this.returnSequences=args.layer.returnSequences,_this.returnState=args.layer.returnState,_this.supportsMasking=!0,_this._trainable=!0,_this.inputSpec=args.layer.inputSpec,_this.numConstants=null,_this}return __extends(Bidirectional,_super),Object.defineProperty(Bidirectional.prototype,"trainable",{get:function(){return this._trainable},set:function(value){this._trainable=value,null!=this.forwardLayer&&(this.forwardLayer.trainable=value),null!=this.backwardLayer&&(this.backwardLayer.trainable=value)},enumerable:!0,configurable:!0}),Bidirectional.prototype.getWeights=function(){return this.forwardLayer.getWeights().concat(this.backwardLayer.getWeights())},Bidirectional.prototype.setWeights=function(weights){var numWeights=weights.length,numeightsOver2=Math.floor(numWeights/2);this.forwardLayer.setWeights(weights.slice(0,numeightsOver2)),this.backwardLayer.setWeights(weights.slice(numeightsOver2))},Bidirectional.prototype.computeOutputShape=function(inputShape){var outputShape,outputShapes,stateShape,layerShapes=this.forwardLayer.computeOutputShape(inputShape);return Array.isArray(layerShapes)&&Array.isArray(layerShapes[0])||(layerShapes=[layerShapes]),layerShapes=layerShapes,outputShape=outputShape=(this.returnState&&(stateShape=layerShapes.slice(1)),layerShapes[0]),outputShapes="concat"===this.mergeMode?(outputShape[outputShape.length-1]*=2,[outputShape]):null==this.mergeMode?[outputShape,outputShape.slice()]:[outputShape],this.returnState?null==this.mergeMode?outputShapes.concat(stateShape).concat(stateShape.slice()):[outputShape].concat(stateShape).concat(stateShape.slice()):generic_utils.singletonOrArray(outputShapes)},Bidirectional.prototype.apply=function(inputs,kwargs){var initialState=null==kwargs?null:kwargs.initialState,constants=null==kwargs?null:kwargs.constants;null==kwargs&&(kwargs={});var standardized=recurrent_1.standardizeArgs(inputs,initialState,constants,this.numConstants);if(inputs=standardized.inputs,initialState=standardized.initialState,constants=standardized.constants,Array.isArray(inputs)&&(initialState=inputs.slice(1),inputs=inputs[0]),(null==initialState||0===initialState.length)&&null==constants)return _super.prototype.apply.call(this,inputs,kwargs);var additionalInputs=[],additionalSpecs=[];if(null!=initialState){var numStates=initialState.length;if(0<numStates%2)throw new errors_1.ValueError("When passing `initialState` to a Bidrectional RNN, the state should be an Array containing the states of the underlying RNNs.");kwargs.initialState=initialState,additionalInputs.push.apply(additionalInputs,initialState);var stateSpecs=initialState.map(function(state){return new topology_1.InputSpec({shape:state.shape})});this.forwardLayer.stateSpec=stateSpecs.slice(0,numStates/2),this.backwardLayer.stateSpec=stateSpecs.slice(numStates/2),additionalSpecs.push.apply(additionalSpecs,stateSpecs)}if(null!=constants)throw new errors_1.NotImplementedError("Support for constants in Bidirectional layers is not implemented yet.");for(var isSymbolicTensor=additionalInputs[0]instanceof topology_1.SymbolicTensor,_i=0,additionalInputs_1=additionalInputs;_i<additionalInputs_1.length;_i++){if(additionalInputs_1[_i]instanceof topology_1.SymbolicTensor!=isSymbolicTensor)throw new errors_1.ValueError("The initial state of a Bidirectional layer cannot be specified as a mix of symbolic and non-symbolic tensors")}if(isSymbolicTensor){var fullInput=[inputs].concat(additionalInputs),fullInputSpec=this.inputSpec.concat(additionalSpecs),originalInputSpec=this.inputSpec;this.inputSpec=fullInputSpec;var output=_super.prototype.apply.call(this,fullInput,kwargs);return this.inputSpec=originalInputSpec,output}return _super.prototype.apply.call(this,inputs,kwargs)},Bidirectional.prototype.call=function(inputs,kwargs){var _this=this;return tfjs_core_1.tidy(function(){if(null!=kwargs.mask)throw new errors_1.NotImplementedError("The support for masking is not implemented for Bidirectional layers yet.");var y,yRev,states,output,initialState=kwargs.initialState;if(null==initialState)y=_this.forwardLayer.call(inputs,kwargs),yRev=_this.backwardLayer.call(inputs,kwargs);else{var forwardState=initialState.slice(0,initialState.length/2),backwardState=initialState.slice(initialState.length/2);y=_this.forwardLayer.call(inputs,Object.assign(kwargs,{initialState:forwardState})),yRev=_this.backwardLayer.call(inputs,Object.assign(kwargs,{initialState:backwardState}))}return _this.returnState&&(Array.isArray(y)&&(states=y.slice(1).concat(yRev.slice(1))),y=y[0],yRev=yRev[0]),_this.returnSequences&&(yRev=tfc.reverse(yRev,1)),"concat"===_this.mergeMode?output=K.concatenate([y,yRev]):"sum"===_this.mergeMode?output=tfc.add(y,yRev):"ave"===_this.mergeMode?output=tfc.mul(.5,tfc.add(y,yRev)):"mul"===_this.mergeMode?output=tfc.mul(y,yRev):null==_this.mergeMode&&(output=[y,yRev]),_this.returnState?null==_this.mergeMode?output.concat(states):[output].concat(states):output})},Bidirectional.prototype.resetStates=function(states){this.forwardLayer.resetStates(),this.backwardLayer.resetStates()},Bidirectional.prototype.build=function(inputShape){var _this=this;common_1.nameScope(this.forwardLayer.name,function(){_this.forwardLayer.build(inputShape)}),common_1.nameScope(this.backwardLayer.name,function(){_this.backwardLayer.build(inputShape)}),this.built=!0},Object.defineProperty(Bidirectional.prototype,"trainableWeights",{get:function(){return this.forwardLayer.trainableWeights.concat(this.backwardLayer.trainableWeights)},enumerable:!0,configurable:!0}),Object.defineProperty(Bidirectional.prototype,"nonTrainableWeights",{get:function(){return this.forwardLayer.nonTrainableWeights.concat(this.backwardLayer.nonTrainableWeights)},enumerable:!0,configurable:!0}),Bidirectional.prototype.setFastWeightInitDuringBuild=function(value){_super.prototype.setFastWeightInitDuringBuild.call(this,value),null!=this.forwardLayer&&this.forwardLayer.setFastWeightInitDuringBuild(value),null!=this.backwardLayer&&this.backwardLayer.setFastWeightInitDuringBuild(value)},Bidirectional.prototype.getConfig=function(){var config={mergeMode:this.mergeMode},baseConfig=_super.prototype.getConfig.call(this);return Object.assign(config,baseConfig),config},Bidirectional.fromConfig=function(cls,config){var rnnLayer=serialization_1.deserialize(config.layer);if(delete config.layer,null!=config.numConstants)throw new errors_1.NotImplementedError("Deserialization of a Bidirectional layer with numConstants present is not supported yet.");var newConfig=config;return newConfig.layer=rnnLayer,new cls(newConfig)},Bidirectional.className="Bidirectional",Bidirectional}(Wrapper);exports.Bidirectional=Bidirectional,tfjs_core_1.serialization.registerClass(Bidirectional)},{"../backend/tfjs_backend":276,"../common":279,"../engine/topology":284,"../errors":289,"../keras_format/common":299,"../utils/generic_utils":322,"../utils/types_utils":326,"./recurrent":311,"./serialization":312,"@tensorflow/tfjs-core":148}],314:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core");exports.resolveScalarsInLogs=function(logs){return __awaiter(this,void 0,void 0,function(){var promises,keys,scalarsToDispose,key,value,valueScalar,values,i;return __generator(this,function(_a){switch(_a.label){case 0:if(null==logs)return[2];for(key in promises=[],keys=[],scalarsToDispose=[],logs)"number"!=typeof(value=logs[key])&&(valueScalar=value,promises.push(valueScalar.data()),keys.push(key),scalarsToDispose.push(valueScalar));return 0<promises.length?[4,Promise.all(promises)]:[3,2];case 1:for(values=_a.sent(),i=0;i<values.length;++i)logs[keys[i]]=values[i][0];tfjs_core_1.dispose(scalarsToDispose),_a.label=2;case 2:return[2]}})})},exports.disposeTensorsInLogs=function(logs){if(null!=logs)for(var key in logs){var value=logs[key];"number"!=typeof value&&value.dispose()}}},{"@tensorflow/tfjs-core":148}],315:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("./backend/common"),K=require("./backend/tfjs_backend"),errors_1=require("./errors");function l2Normalize(x,axis){return tfjs_core_1.tidy(function(){"float32"!==x.dtype&&(x=x.asType("float32"));var squareSum=tfc.sum(K.square(x),axis,!0),epsilonTensor=tfc.fill(squareSum.shape,common_1.epsilon()),norm=tfc.sqrt(tfc.maximum(squareSum,epsilonTensor));return tfc.div(x,norm)})}function meanSquaredError(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.mean(K.square(tfc.sub(yPred,yTrue)),-1)})}function meanAbsoluteError(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.mean(tfc.abs(tfc.sub(yPred,yTrue)),-1)})}function meanAbsolutePercentageError(yTrue,yPred){return tfjs_core_1.tidy(function(){var diff=tfc.sub(yTrue,yPred),clippedTrue=tfc.clipByValue(tfc.abs(yTrue),common_1.epsilon(),Number.MAX_VALUE),absResult=tfc.abs(tfc.div(diff,clippedTrue));return tfc.mul(100,tfc.mean(absResult,-1))})}function meanSquaredLogarithmicError(yTrue,yPred){return tfjs_core_1.tidy(function(){var clippedPred=tfc.clipByValue(yPred,common_1.epsilon(),Number.MAX_VALUE),firstLog=tfc.log(tfc.add(1,clippedPred)),clippedTrue=tfc.clipByValue(yTrue,common_1.epsilon(),Number.MAX_VALUE),secondLog=tfc.log(tfc.add(1,clippedTrue));return tfc.mean(K.square(tfc.sub(firstLog,secondLog)),-1)})}function squaredHinge(yTrue,yPred){return tfjs_core_1.tidy(function(){var maxResult=tfc.maximum(0,tfc.sub(1,tfc.mul(yTrue,yPred)));return tfc.mean(K.square(maxResult),-1)})}function hinge(yTrue,yPred){return tfjs_core_1.tidy(function(){var maxResult=tfc.maximum(0,tfc.sub(1,tfc.mul(yTrue,yPred)));return tfc.mean(maxResult,-1)})}function categoricalHinge(yTrue,yPred){return tfjs_core_1.tidy(function(){var pos=tfc.sum(tfc.mul(yTrue,yPred),-1),neg=tfc.max(tfc.mul(tfc.sub(1,yTrue),yPred),-1);return tfc.maximum(0,tfc.add(1,tfc.sub(neg,pos)))})}function logcosh(yTrue,yPred){return tfjs_core_1.tidy(function(){var log2=Math.log(2),predictionDiff=tfc.sub(yPred,yTrue),logcoshResult=tfc.sub(tfc.add(predictionDiff,tfc.softplus(tfc.mul(-2,predictionDiff))),log2);return tfc.mean(logcoshResult,-1)})}function categoricalCrossentropy(target,output,fromLogits){return void 0===fromLogits&&(fromLogits=!1),tfjs_core_1.tidy(function(){if(fromLogits)output=tfc.softmax(output);else{var outputSum=tfc.sum(output,output.shape.length-1,!0);output=tfc.div(output,outputSum)}return output=tfc.clipByValue(output,common_1.epsilon(),1-common_1.epsilon()),tfc.neg(tfc.sum(tfc.mul(target.toFloat(),tfc.log(output)),output.shape.length-1))})}function sparseCategoricalCrossentropy(target,output){return tfjs_core_1.tidy(function(){var flatTarget=tfc.floor(K.flatten(target)).toInt(),outputShape=(output=tfc.clipByValue(output,common_1.epsilon(),1-common_1.epsilon())).shape;return categoricalCrossentropy(tfc.oneHot(flatTarget,outputShape[outputShape.length-1]).reshape(outputShape),output,!1)})}function sigmoidCrossEntropyWithLogits(labels,logits){if(!tfjs_core_1.util.arraysEqual(labels.shape,logits.shape))throw new errors_1.ValueError("logits and labels must have the same shape, but got shapes "+JSON.stringify(labels.shape)+" and "+JSON.stringify(logits.shape));return tfjs_core_1.tidy(function(){var reluLogits=logits.relu(),negAbsLogits=logits.abs().neg();return reluLogits.sub(logits.mul(labels)).add(negAbsLogits.exp().log1p())})}function binaryCrossentropy(yTrue,yPred){return tfjs_core_1.tidy(function(){var y;return y=tfc.clipByValue(yPred,common_1.epsilon(),1-common_1.epsilon()),y=tfc.log(tfc.div(y,tfc.sub(1,y))),tfc.mean(sigmoidCrossEntropyWithLogits(yTrue,y),-1)})}function kullbackLeiblerDivergence(yTrue,yPred){return tfjs_core_1.tidy(function(){var clippedTrue=tfc.clipByValue(yTrue,common_1.epsilon(),1),clippedPred=tfc.clipByValue(yPred,common_1.epsilon(),1);return tfc.sum(tfc.mul(yTrue,tfc.log(tfc.div(clippedTrue,clippedPred))),-1)})}function poisson(yTrue,yPred){return tfjs_core_1.tidy(function(){var logPred=tfc.log(tfc.add(common_1.epsilon(),yPred));return tfc.mean(tfc.sub(yPred,tfc.mul(yTrue,logPred)),-1)})}function cosineProximity(yTrue,yPred){return tfjs_core_1.tidy(function(){var trueNormalized=l2Normalize(yTrue,-1),predNormalized=l2Normalize(yPred,-1),trueXPred=tfc.mul(trueNormalized,predNormalized);return tfc.neg(tfc.sum(trueXPred,-1))})}exports.l2Normalize=l2Normalize,exports.meanSquaredError=meanSquaredError,exports.meanAbsoluteError=meanAbsoluteError,exports.meanAbsolutePercentageError=meanAbsolutePercentageError,exports.meanSquaredLogarithmicError=meanSquaredLogarithmicError,exports.squaredHinge=squaredHinge,exports.hinge=hinge,exports.categoricalHinge=categoricalHinge,exports.logcosh=logcosh,exports.categoricalCrossentropy=categoricalCrossentropy,exports.sparseCategoricalCrossentropy=sparseCategoricalCrossentropy,exports.sigmoidCrossEntropyWithLogits=sigmoidCrossEntropyWithLogits,exports.binaryCrossentropy=binaryCrossentropy,exports.kullbackLeiblerDivergence=kullbackLeiblerDivergence,exports.poisson=poisson,exports.cosineProximity=cosineProximity,exports.mse=meanSquaredError,exports.MSE=meanSquaredError,exports.mae=meanAbsoluteError,exports.MAE=meanAbsoluteError,exports.mape=meanAbsolutePercentageError,exports.MAPE=meanAbsolutePercentageError,exports.msle=meanSquaredLogarithmicError,exports.MSLE=meanSquaredLogarithmicError,exports.kld=kullbackLeiblerDivergence,exports.KLD=kullbackLeiblerDivergence,exports.cosine=cosineProximity,exports.lossesMap={meanSquaredError:meanSquaredError,meanAbsoluteError:meanAbsoluteError,meanAbsolutePercentageError:meanAbsolutePercentageError,meanSquaredLogarithmicError:meanSquaredLogarithmicError,squaredHinge:squaredHinge,hinge:hinge,categoricalHinge:categoricalHinge,logcosh:logcosh,categoricalCrossentropy:categoricalCrossentropy,sparseCategoricalCrossentropy:sparseCategoricalCrossentropy,binaryCrossentropy:binaryCrossentropy,kullbackLeiblerDivergence:kullbackLeiblerDivergence,poisson:poisson,cosineProximity:cosineProximity},exports.get=function(identifierOrFn){if("string"!=typeof identifierOrFn)return identifierOrFn;if(identifierOrFn in exports.lossesMap)return exports.lossesMap[identifierOrFn];var errMsg="Unknown loss "+identifierOrFn;throw identifierOrFn.toLowerCase().includes("softmaxcrossentropy")&&(errMsg="Unknown loss "+identifierOrFn+'. Use "categoricalCrossentropy" as the string name for tf.losses.softmaxCrossEntropy'),new errors_1.ValueError(errMsg)}},{"./backend/common":274,"./backend/tfjs_backend":276,"./errors":289,"@tensorflow/tfjs-core":148}],316:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),errors_1=require("./errors"),losses_1=require("./losses"),losses_2=require("./losses"),losses_3=require("./losses"),util=require("./utils/generic_utils");function binaryAccuracy(yTrue,yPred){return tfjs_core_1.tidy(function(){var threshold=tfc.mul(.5,tfc.onesLike(yPred)),yPredThresholded=K.cast(tfc.greater(yPred,threshold),yTrue.dtype);return tfc.mean(tfc.equal(yTrue,yPredThresholded),-1)})}function categoricalAccuracy(yTrue,yPred){return tfjs_core_1.tidy(function(){return K.cast(tfc.equal(tfc.argMax(yTrue,-1),tfc.argMax(yPred,-1)),"float32")})}function truePositives(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.logicalAnd(yTrue.equal(1),yPred.equal(1)).sum().cast("float32")})}function precision(yTrue,yPred){return tfjs_core_1.tidy(function(){var tp=truePositives(yTrue,yPred),fp=function(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.logicalAnd(yTrue.equal(0),yPred.equal(1)).sum().cast("float32")})}(yTrue,yPred),denominator=tp.add(fp);return tfc.where(tfc.greater(denominator,0),tp.div(denominator),0).cast("float32")})}exports.binaryAccuracy=binaryAccuracy,exports.categoricalAccuracy=categoricalAccuracy,exports.precision=precision,exports.recall=function(yTrue,yPred){return tfjs_core_1.tidy(function(){var tp=truePositives(yTrue,yPred),fn=function(yTrue,yPred){return tfjs_core_1.tidy(function(){return tfc.logicalAnd(yTrue.equal(1),yPred.equal(0)).sum().cast("float32")})}(yTrue,yPred),denominator=tp.add(fn);return tfc.where(tfc.greater(denominator,0),tp.div(denominator),0).cast("float32")})},exports.binaryCrossentropy=function(yTrue,yPred){return losses_2.binaryCrossentropy(yTrue,yPred)},exports.sparseCategoricalAccuracy=function(yTrue,yPred){return yTrue.rank===yPred.rank&&(yTrue=yTrue.squeeze([yTrue.rank-1])),(yPred=yPred.argMax(-1)).dtype!==yTrue.dtype&&(yPred=yPred.asType(yTrue.dtype)),tfc.equal(yTrue,yPred).asType("float32")},exports.topKCategoricalAccuracy=function(yTrue,yPred){throw new errors_1.NotImplementedError},exports.sparseTopKCategoricalAccuracy=function(yTrue,yPred){throw new errors_1.NotImplementedError},exports.mse=losses_1.meanSquaredError,exports.MSE=losses_1.meanSquaredError,exports.mae=losses_1.meanAbsoluteError,exports.MAE=losses_1.meanAbsoluteError,exports.mape=losses_1.meanAbsolutePercentageError,exports.MAPE=losses_1.meanAbsolutePercentageError,exports.categoricalCrossentropy=losses_1.categoricalCrossentropy,exports.cosine=losses_1.cosineProximity,exports.sparseCategoricalCrossentropy=losses_1.sparseCategoricalCrossentropy,exports.metricsMap={binaryAccuracy:binaryAccuracy,categoricalAccuracy:categoricalAccuracy,precision:precision,categoricalCrossentropy:exports.categoricalCrossentropy,sparseCategoricalCrossentropy:exports.sparseCategoricalCrossentropy,mse:exports.mse,MSE:exports.MSE,mae:exports.mae,MAE:exports.MAE,mape:exports.mape,MAPE:exports.MAPE,cosine:exports.cosine},exports.get=function(identifier){if("string"==typeof identifier&&identifier in exports.metricsMap)return exports.metricsMap[identifier];if("string"!=typeof identifier&&null!=identifier)return identifier;throw new errors_1.ValueError("Unknown metric "+identifier)},exports.getLossOrMetricName=function(fn){if(util.assert(null!==fn,"Unknown LossOrMetricFn "+fn),"string"==typeof fn)return fn;for(var fnName=void 0,_i=0,_a=Object.keys(losses_3.lossesMap);_i<_a.length;_i++){var key=_a[_i];if(losses_3.lossesMap[key]===fn){fnName=key;break}}if(void 0!==fnName)return fnName;for(var _b=0,_c=Object.keys(exports.metricsMap);_b<_c.length;_b++){key=_c[_b];if(exports.metricsMap[key]===fn){fnName=key;break}}return void 0!==fnName?fnName:fn.name}},{"./backend/tfjs_backend":276,"./errors":289,"./losses":315,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],317:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P=P||Promise)(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=0<(t=_.trys).length&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("./backend/state"),input_layer_1=require("./engine/input_layer"),topology_1=require("./engine/topology"),training_1=require("./engine/training"),errors_1=require("./errors"),serialization_1=require("./layers/serialization"),generic_utils=require("./utils/generic_utils"),serialization_utils_1=require("./utils/serialization_utils"),types_utils_1=require("./utils/types_utils");function loadLayersModelFromIOHandler(handler,customObjects,options){return __awaiter(this,void 0,void 0,function(){var artifacts,modelTopology,strict,fastWeightInit,model,trainingConfig,_a,modelWeights,optimizerWeights;return __generator(this,function(_b){switch(_b.label){case 0:if(null==options&&(options={}),null==handler.load)throw new errors_1.ValueError("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");return[4,handler.load()];case 1:if(artifacts=_b.sent(),null!=(modelTopology=artifacts.modelTopology).model_config&&(modelTopology=modelTopology.model_config),strict=null==options.strict||options.strict,fastWeightInit=null!=artifacts.weightData&&null!=artifacts.weightSpecs&&strict,model=serialization_1.deserialize(serialization_utils_1.convertPythonicToTs(modelTopology),customObjects,fastWeightInit),null!=(trainingConfig=artifacts.trainingConfig)&&model.loadTrainingConfig(trainingConfig),null!=artifacts.userDefinedMetadata&&model.setUserDefinedMetadata(artifacts.userDefinedMetadata),null==artifacts.weightData)return[3,4];if(null==artifacts.weightSpecs)throw new errors_1.ValueError("LayersModel artifacts contains weight data, but not weight specs. Therefore loading of weights cannot proceed.");return modelWeights=(_a=function(buffer,specs){var name2Tensor=tfjs_core_1.io.decodeWeights(buffer,specs),modelWeights={},optimizerWeights=[];return specs.forEach(function(spec){"optimizer"===spec.group?optimizerWeights.push({name:spec.name,tensor:name2Tensor[spec.name]}):modelWeights[spec.name]=name2Tensor[spec.name]}),{modelWeights:modelWeights,optimizerWeights:optimizerWeights}}(artifacts.weightData,artifacts.weightSpecs)).modelWeights,optimizerWeights=_a.optimizerWeights,model.loadWeights(modelWeights,strict),null!=model.optimizer&&0<optimizerWeights.length?[4,model.optimizer.setWeights(optimizerWeights)]:[3,3];case 2:_b.sent(),_b.label=3;case 3:tfjs_core_1.dispose(modelWeights),tfjs_core_1.dispose(optimizerWeights.map(function(w){return w.tensor})),_b.label=4;case 4:return[2,model]}})})}exports.modelFromJSON=function(modelAndWeightsConfig,customObjects){return __awaiter(this,void 0,void 0,function(){var modelTopology,tsConfig,model,weightValues,uniqueWeightValues,_i,_a,weight;return __generator(this,function(_b){switch(_b.label){case 0:return"modelTopology"in modelAndWeightsConfig||(modelAndWeightsConfig={modelTopology:modelAndWeightsConfig}),null!=(modelTopology=(modelAndWeightsConfig=modelAndWeightsConfig).modelTopology).model_config&&(modelTopology=modelTopology.model_config),tsConfig=serialization_utils_1.convertPythonicToTs(modelTopology),model=serialization_1.deserialize(tsConfig,customObjects),null==modelAndWeightsConfig.weightsManifest?[3,2]:[4,tfjs_core_1.io.loadWeights(modelAndWeightsConfig.weightsManifest,modelAndWeightsConfig.pathPrefix,model.weights.map(function(weight){return weight.originalName}))];case 1:for(weightValues=_b.sent(),uniqueWeightValues={},_i=0,_a=model.weights;_i<_a.length;_i++)weight=_a[_i],uniqueWeightValues[weight.originalName]=weightValues[weight.originalName];model.loadWeights(uniqueWeightValues),tfjs_core_1.dispose(weightValues),_b.label=2;case 2:return[2,model]}})})},exports.loadLayersModelInternal=function(pathOrIOHandler,options){return __awaiter(this,void 0,void 0,function(){var handlers;return __generator(this,function(_a){if(null==options&&(options={}),"string"==typeof pathOrIOHandler){if(0===(handlers=tfjs_core_1.io.getLoadHandlers(pathOrIOHandler,options.onProgress)).length)handlers.push(tfjs_core_1.io.browserHTTPRequest(pathOrIOHandler,options));else if(1<handlers.length)throw new errors_1.ValueError("Found more than one ("+handlers.length+") load handlers for URL '"+pathOrIOHandler+"'");pathOrIOHandler=handlers[0]}return[2,loadLayersModelFromIOHandler(pathOrIOHandler,void 0,options)]})})},exports.loadLayersModelFromIOHandler=loadLayersModelFromIOHandler;var Sequential=function(_super){function Sequential(args){var _this=_super.call(this,{inputs:[],outputs:[]})||this;if(args=args||{},_this.trainable=!0,_this.built=!1,_this.name=null!=args.name?args.name:state_1.getUid("sequential_"),null!=args.layers)for(var _i=0,_a=args.layers;_i<_a.length;_i++){var layer=_a[_i];_this.add(layer)}return _this}return __extends(Sequential,_super),Sequential.prototype.checkShape=function(layer){if(layer.inboundNodes[0].outputTensors[0].shape.some(function(x){return x<0}))throw new errors_1.ValueError("Negative dimension size caused by adding layer "+layer.name+" with input shape ["+layer.inboundNodes[0].inputTensors[0].shape+"]")},Sequential.prototype.add=function(layer){var modelLayer,isLayerModelInstance=layer instanceof Sequential||layer instanceof training_1.LayersModel;if(isLayerModelInstance){if(1!==(modelLayer=layer).outputs.length)throw new errors_1.ValueError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");if(1!==modelLayer.inputs.length)throw new errors_1.ValueError("All layers in a Sequential model should have a single input tensor. For multi-input layers, use the functional API.")}if(0===this.outputs.length){if(0===layer.inboundNodes.length){if(null==layer.batchInputShape)throw new errors_1.ValueError("The first layer in a Sequential model must get an `inputShape` or `batchInputShape` argument.");var x=input_layer_1.Input({batchShape:layer.batchInputShape,dtype:layer.dtype,name:layer.name+"_input"});layer.apply(x)}if(isLayerModelInstance)this.outputs=modelLayer.outputs,this.inputs=modelLayer.inputs;else{if(1!==layer.inboundNodes.length)throw new errors_1.ValueError("A layer added to a Sequential model must not already be connected somewhere else. LayersModel received layer "+layer.name+" which has "+layer.inboundNodes.length+" pre-existing inbound connections.");if(1!==layer.inboundNodes[0].outputTensors.length)throw new errors_1.ValueError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(layer),this.outputs=[layer.inboundNodes[0].outputTensors[0]],this.inputs=topology_1.getSourceInputs(this.outputs[0])}this.inboundNodes=[],new topology_1.Node({outboundLayer:this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:this.inputs,outputTensors:this.outputs,inputMasks:generic_utils.pyListRepeat(null,this.inputs.length),outputMasks:[null],inputShapes:this.inputs.map(function(x){return x.shape}),outputShapes:this.outputs[0].shape})}else{var outputTensor=layer.apply(this.outputs[0]);if(Array.isArray(outputTensor))throw new TypeError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(layer),this.outputs=[outputTensor],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}this.layers.push(layer),this.built=!1},Sequential.prototype.pop=function(){if(0===this.layers.length)throw new TypeError("There are no layers in the model.");if(this.layers.pop(),0===this.layers.length)this.outputs=[],this.inboundNodes=[],this.outboundNodes=[];else{var lastLayerIndex=this.layers.length-1;this.layers[lastLayerIndex].outboundNodes=[],this.outputs=[this.layers[lastLayerIndex].output],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}},Sequential.prototype.call=function(inputs,kwargs){return null==this.model&&this.build(),this.model.call(inputs,kwargs)},Sequential.prototype.build=function(inputShape){if(types_utils_1.getExactlyOneShape(inputShape),0===this.inputs.length||0===this.outputs.length)throw new TypeError("Sequential model cannot be built: model is empty. Add some layers first.");this.model=new training_1.LayersModel({inputs:this.inputs,outputs:this.outputs[0],name:this.name+"_model"}),this.model.trainable=this.trainable,this.supportsMasking=this.model.supportsMasking,this.inputLayers=this.model.inputLayers,this.inputLayersNodeIndices=this.model.inputLayersNodeIndices,this.inputLayersTensorIndices=this.model.inputLayersTensorIndices,this.outputLayers=this.model.outputLayers,this.outputLayersNodeIndices=this.model.outputLayersNodeIndices,this.outputLayersTensorIndices=this.model.outputLayersTensorIndices,this.nodesByDepth=this.model.nodesByDepth,this.containerNodes=this.model.containerNodes,this.outputNames=this.model.outputNames,this.inputNames=this.model.inputNames,this.built=!0},Sequential.prototype.countParams=function(){return this.built||this.build(),_super.prototype.countParams.call(this)},Sequential.prototype.summary=function(lineLength,positions,printFn){void 0===printFn&&(printFn=console.log),this.built||this.build(),_super.prototype.summary.call(this,lineLength,positions,printFn)},Sequential.prototype.setWeights=function(weights){null==this.model&&this.build(),this.model.setWeights(weights)},Sequential.prototype.evaluate=function(x,y,args){if(void 0===args&&(args={}),!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return this.model.evaluate(x,y,args)},Sequential.prototype.evaluateDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return[2,this.model.evaluateDataset(dataset,args)]})})},Sequential.prototype.predict=function(x,args){return void 0===args&&(args={}),null==this.model&&this.build(),this.model.predict(x,args)},Sequential.prototype.predictOnBatch=function(x){return null==this.model&&this.build(),this.model.predictOnBatch(x)},Sequential.prototype.compile=function(args){this.build(),this.model.compile(args),this.optimizer_=this.model.optimizer,this.isOptimizerOwned=this.model.isOptimizerOwned,this.loss=this.model.loss,this.metrics=this.model.metrics,this.metricsTensors=this.model.metricsTensors,this.metricsNames=this.model.metricsNames},Object.defineProperty(Sequential.prototype,"optimizer",{get:function(){return null==this.model?void 0:this.model.optimizer},set:function(optimizer){this.model.optimizer=optimizer},enumerable:!0,configurable:!0}),Sequential.prototype.fit=function(x,y,args){return void 0===args&&(args={}),__awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return[2,this.model.fit(x,y,args)]})})},Sequential.prototype.fitDataset=function(dataset,args){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){if(!this.built)throw new errors_1.RuntimeError("The model needs to be compiled before being used.");return[2,this.model.fitDataset(dataset,args)]})})},Sequential.prototype.trainOnBatch=function(x,y){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,this.model.trainOnBatch(x,y)]})})},Sequential.fromConfig=function(cls,config,customObjects,fastWeightInit){var configArray;void 0===customObjects&&(customObjects={}),void 0===fastWeightInit&&(fastWeightInit=!1);var extraModelConfig={};if(config instanceof Array){if(null==config[0].className||"Merge"===config[0].className)throw new errors_1.ValueError("Legacy serialization format not supported yet.");configArray=config}else tfjs_core_1.util.assert(null!=config.layers,function(){return"When the config data for a Sequential model is not an Array, it must be an Object that contains the 'layers' field."}),configArray=config.layers,delete config.layers,extraModelConfig=config;var model=new cls(extraModelConfig);if(!(model instanceof Sequential))throw new errors_1.NotImplementedError("Sequential.fromConfig called on non-Sequential input: "+model);for(var _i=0,configArray_1=configArray;_i<configArray_1.length;_i++){var conf=configArray_1[_i],layer=serialization_1.deserialize(conf,void 0,fastWeightInit);fastWeightInit&&layer.setFastWeightInitDuringBuild(!0),model.add(layer)}return model},Object.defineProperty(Sequential.prototype,"stopTraining",{get:function(){if(null==this.model)throw new errors_1.ValueError("Cannot get the stopTraining property of a sequential model before it is compiled.");return this.model.stopTraining},set:function(stop){if(null==this.model)throw new errors_1.ValueError("Cannot set the stopTraining property of a sequential model before it is compiled.");this.model.stopTraining=stop},enumerable:!0,configurable:!0}),Sequential.prototype.getConfig=function(){for(var config=[],_i=0,_a=this.layers;_i<_a.length;_i++){var layer=_a[_i],dict={};dict.className=layer.getClassName(),dict.config=layer.getConfig(),config.push(dict)}return config},Sequential.className="Sequential",Sequential}(training_1.LayersModel);exports.Sequential=Sequential,tfjs_core_1.serialization.registerClass(Sequential)},{"./backend/state":275,"./engine/input_layer":283,"./engine/topology":284,"./engine/training":285,"./errors":289,"./layers/serialization":312,"./utils/generic_utils":322,"./utils/serialization_utils":325,"./utils/types_utils":326,"@tensorflow/tfjs-core":148}],318:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),common_1=require("./backend/common"),errors_1=require("./errors");exports.getOptimizer=function(identifier){var optimizerMap={Adagrad:function(){return tfjs_core_1.train.adagrad(.01)},Adadelta:function(){return tfjs_core_1.train.adadelta(1,.95,common_1.epsilon())},Adam:function(){return tfjs_core_1.train.adam(.001,.9,.999,common_1.epsilon())},Adamax:function(){return tfjs_core_1.train.adamax(.002,.9,.999,common_1.epsilon(),0)},RMSProp:function(){return tfjs_core_1.train.rmsprop(.001,.9,0,common_1.epsilon())},SGD:function(){return tfjs_core_1.train.sgd(.01)}};if(optimizerMap.adagrad=optimizerMap.Adagrad,optimizerMap.adadelta=optimizerMap.Adadelta,optimizerMap.adam=optimizerMap.Adam,optimizerMap.adamax=optimizerMap.Adamax,optimizerMap.rmsprop=optimizerMap.RMSProp,optimizerMap.sgd=optimizerMap.SGD,identifier in optimizerMap)return optimizerMap[identifier]();throw new errors_1.ValueError("Unknown Optimizer "+identifier)}},{"./backend/common":274,"./errors":289,"@tensorflow/tfjs-core":148}],319:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),K=require("./backend/tfjs_backend"),generic_utils_1=require("./utils/generic_utils");function assertObjectArgs(args){if(null!=args&&"object"!=typeof args)throw new Error("Argument to L1L2 regularizer's constructor is expected to be an object, but received: "+args)}var Regularizer=function(_super){function Regularizer(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(Regularizer,_super),Regularizer}(tfjs_core_1.serialization.Serializable),L1L2=function(_super){function L1L2(args){var _this=_super.call(this)||this;return assertObjectArgs(args),_this.l1=null==args||null==args.l1?.01:args.l1,_this.l2=null==args||null==args.l2?.01:args.l2,_this.hasL1=0!==_this.l1,_this.hasL2=0!==_this.l2,_this}return __extends(L1L2,_super),L1L2.prototype.apply=function(x){var _this=this;return tfjs_core_1.tidy(function(){var regularization=tfjs_core_1.zeros([1]);return _this.hasL1&&(regularization=tfjs_core_1.add(regularization,tfjs_core_1.sum(tfc.mul(_this.l1,tfjs_core_1.abs(x))))),_this.hasL2&&(regularization=tfjs_core_1.add(regularization,tfjs_core_1.sum(tfc.mul(_this.l2,K.square(x))))),regularization.asScalar()})},L1L2.prototype.getConfig=function(){return{l1:this.l1,l2:this.l2}},L1L2.fromConfig=function(cls,config){return new cls({l1:config.l1,l2:config.l2})},L1L2.className="L1L2",L1L2}(exports.Regularizer=Regularizer);function deserializeRegularizer(config,customObjects){return void 0===customObjects&&(customObjects={}),generic_utils_1.deserializeKerasObject(config,tfjs_core_1.serialization.SerializationMap.getMap().classNameMap,customObjects,"regularizer")}exports.L1L2=L1L2,tfjs_core_1.serialization.registerClass(L1L2),exports.l1=function(args){return assertObjectArgs(args),new L1L2({l1:null!=args?args.l1:null,l2:0})},exports.l2=function(args){return assertObjectArgs(args),new L1L2({l2:null!=args?args.l2:null,l1:0})},exports.REGULARIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP={l1l2:"L1L2"},exports.serializeRegularizer=function(constraint){return generic_utils_1.serializeKerasObject(constraint)},exports.deserializeRegularizer=deserializeRegularizer,exports.getRegularizer=function(identifier){return null==identifier?null:"string"!=typeof identifier?identifier instanceof Regularizer?identifier:deserializeRegularizer(identifier):deserializeRegularizer({className:identifier in exports.REGULARIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP?exports.REGULARIZER_IDENTIFIER_REGISTRY_SYMBOL_MAP[identifier]:identifier,config:{}})}},{"./backend/tfjs_backend":276,"./utils/generic_utils":322,"@tensorflow/tfjs-core":148}],320:[function(require,module,exports){"use strict";function plainObjectCheck(x){if(null===x)return!0;if("object"==typeof x){if(Object.getPrototypeOf(x)===Object.prototype){for(var _i=0,keys_1=Object.keys(x);_i<keys_1.length;_i++){var key=keys_1[_i];if("string"!=typeof key)return!1;if(!plainObjectCheck(x[key]))return!1}return!0}if(Array.isArray(x)){for(var _a=0,x_1=x;_a<x_1.length;_a++){if(!plainObjectCheck(x_1[_a]))return!1}return!0}return!1}var xType=typeof x;return"string"==xType||"number"==xType||"boolean"==xType}Object.defineProperty(exports,"__esModule",{value:!0}),exports.MAX_USER_DEFINED_METADATA_SERIALIZED_LENGTH=1048576,exports.checkUserDefinedMetadata=function(userDefinedMetadata,modelName,checkSize){if(void 0===checkSize&&(checkSize=!1),null==userDefinedMetadata||"object"!=typeof userDefinedMetadata||Object.getPrototypeOf(userDefinedMetadata)!==Object.prototype||!plainObjectCheck(userDefinedMetadata))throw new Error("User-defined metadata is expected to be a JSON object, but is not.");if(checkSize){var out=JSON.stringify(userDefinedMetadata);out.length>exports.MAX_USER_DEFINED_METADATA_SERIALIZED_LENGTH&&console.warn('User-defined metadata of model "'+modelName+'" is too large in size (length='+out.length+" when serialized). It is not recommended to store such large objects in user-defined metadata. Please make sure its serialized length is <= "+exports.MAX_USER_DEFINED_METADATA_SERIALIZED_LENGTH+".")}},exports.plainObjectCheck=plainObjectCheck},{}],321:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var errors_1=require("../errors"),generic_utils_1=require("./generic_utils"),math_utils_1=require("./math_utils");exports.normalizeArray=function(value,n,name){if("number"==typeof value)return generic_utils_1.pyListRepeat(value,n);if(value.length!==n)throw new errors_1.ValueError("The "+name+" argument must be an integer or tuple of "+n+" integers. Received: "+value.length+" elements.");for(var i=0;i<n;++i){var singleValue=value[i];if(!math_utils_1.isInteger(singleValue))throw new errors_1.ValueError("The "+name+" argument must be an integer or tuple of "+n+" integers. Received: "+JSON.stringify(value)+" including a non-integer number "+singleValue)}return value},exports.convOutputLength=function(inputLength,filterSize,padding,stride,dilation){return void 0===dilation&&(dilation=1),null==inputLength?inputLength:(outputLength="same"===padding?inputLength:inputLength-(filterSize+(filterSize-1)*(dilation-1))+1,Math.floor((outputLength+stride-1)/stride));var outputLength},exports.deconvLength=function(dimSize,strideSize,kernelSize,padding){if(null==dimSize)return null;if("valid"===padding)dimSize=dimSize*strideSize+math_utils_1.max([kernelSize-strideSize,0]);else{if("same"!==padding)throw new errors_1.ValueError("Unsupport padding mode: "+padding+".");dimSize*=strideSize}return dimSize}},{"../errors":289,"./generic_utils":322,"./math_utils":324}],322:[function(require,module,exports){"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("../errors");function assert(val,message){if(!val)throw new errors_1.AssertionError(message)}function toList(x){return Array.isArray(x)?x:[x]}exports.pyListRepeat=function(value,numValues){if(Array.isArray(value)){for(var newArray=[],i=0;i<numValues;i++)newArray=newArray.concat(value);return newArray}return(newArray=new Array(numValues)).fill(value),newArray},exports.assert=assert,exports.count=function(array,refernce){for(var counter=0,_i=0,array_1=array;_i<array_1.length;_i++){array_1[_i]===refernce&&counter++}return counter},exports.singletonOrArray=function(xs){return 1===xs.length?xs[0]:xs},exports.toList=toList,exports.objectListUid=function(objs){for(var retVal="",_i=0,objectList_1=toList(objs);_i<objectList_1.length;_i++){var obj=objectList_1[_i];if(null==obj.id)throw new errors_1.ValueError("Object "+obj+" passed to objectListUid without an id");""!==retVal&&(retVal+=", "),retVal+=Math.abs(obj.id)}return retVal},exports.toSnakeCase=function(name){var insecure=name.replace(/(.)([A-Z][a-z0-9]+)/g,"$1_$2").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase();return"_"!==insecure[0]?insecure:"private"+insecure},exports.toCamelCase=function(identifier){return identifier.length<=1?identifier:-1===identifier.indexOf("_")?identifier:identifier.replace(/[_]+(\w|$)/g,function(m,p1){return p1.toUpperCase()})};var _GLOBAL_CUSTOM_OBJECTS={};function numberCompare(a,b){return a<b?-1:b<a?1:0}function formatAsFriendlyString(value){return null===value?"null":Array.isArray(value)?"["+value.map(function(v){return formatAsFriendlyString(v)}).join(",")+"]":"string"==typeof value?'"'+value+'"':""+value}exports.serializeKerasObject=function(instance){if(null==instance)return null;var dict={};return dict.className=instance.getClassName(),dict.config=instance.getConfig(),dict},exports.deserializeKerasObject=function(identifier,moduleObjects,customObjects,printableModuleName,fastWeightInit){var _a,_b,_c;if(void 0===moduleObjects&&(moduleObjects={}),void 0===customObjects&&(customObjects={}),void 0===printableModuleName&&(printableModuleName="object"),void 0===fastWeightInit&&(fastWeightInit=!1),"string"==typeof identifier){var functionName=identifier,fn=void 0;if(functionName in customObjects)fn=customObjects[functionName];else if(functionName in _GLOBAL_CUSTOM_OBJECTS)fn=_GLOBAL_CUSTOM_OBJECTS[functionName];else if(null==(fn=moduleObjects[functionName]))throw new errors_1.ValueError("Unknown "+printableModuleName+": "+identifier+". This may be due to one of the following reasons:\n1. The "+printableModuleName+" is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom "+printableModuleName+" is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().");return fn}var config=identifier;if(null==config.className||null==config.config)throw new errors_1.ValueError(printableModuleName+": Improper config format: "+JSON.stringify(config)+".\n'className' and 'config' must set.");var className=config.className,cls=void 0,fromConfig=void 0;if(className in customObjects?(cls=(_a=customObjects[className])[0],fromConfig=_a[1]):className in _GLOBAL_CUSTOM_OBJECTS?(cls=(_b=_GLOBAL_CUSTOM_OBJECTS.className)[0],fromConfig=_b[1]):className in moduleObjects&&(cls=(_c=moduleObjects[className])[0],fromConfig=_c[1]),null==cls)throw new errors_1.ValueError("Unknown "+printableModuleName+": "+className+". This may be due to one of the following reasons:\n1. The "+printableModuleName+" is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom "+printableModuleName+" is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().");if(null!=fromConfig){for(var customObjectsCombined={},_i=0,_d=Object.keys(_GLOBAL_CUSTOM_OBJECTS);_i<_d.length;_i++){customObjectsCombined[key=_d[_i]]=_GLOBAL_CUSTOM_OBJECTS[key]}for(var _e=0,_f=Object.keys(customObjects);_e<_f.length;_e++){customObjectsCombined[key=_f[_e]]=customObjects[key]}config.config.customObjects=customObjectsCombined;for(var backupCustomObjects=__assign({},_GLOBAL_CUSTOM_OBJECTS),_g=0,_h=Object.keys(customObjects);_g<_h.length;_g++){var key=_h[_g];_GLOBAL_CUSTOM_OBJECTS[key]=customObjects[key]}!function convertNDArrayScalarsInConfig(config){if(null!=config&&"object"==typeof config)if(Array.isArray(config))config.forEach(function(configItem){return convertNDArrayScalarsInConfig(configItem)});else for(var _i=0,fields_1=Object.keys(config);_i<fields_1.length;_i++){var field=fields_1[_i],value=config[field];null!=value&&"object"==typeof value&&(Array.isArray(value)||"ndarray"!==value.type||"number"!=typeof value.value?convertNDArrayScalarsInConfig(value):config[field]=value.value)}}(config.config);var returnObj=fromConfig(cls,config.config,customObjects,fastWeightInit);return _GLOBAL_CUSTOM_OBJECTS=__assign({},backupCustomObjects),returnObj}backupCustomObjects=__assign({},_GLOBAL_CUSTOM_OBJECTS);for(var _j=0,_k=Object.keys(customObjects);_j<_k.length;_j++){key=_k[_j];_GLOBAL_CUSTOM_OBJECTS[key]=customObjects[key]}return returnObj=new cls(config.config),_GLOBAL_CUSTOM_OBJECTS=__assign({},backupCustomObjects),returnObj},exports.numberCompare=numberCompare,exports.reverseNumberCompare=function(a,b){return-1*numberCompare(a,b)},exports.stringToDType=function(dtype){switch(dtype){case"float32":return"float32";default:throw new errors_1.ValueError("Invalid dtype: "+dtype)}},exports.stringsEqual=function(xs,ys){if(null==xs||null==ys)return xs===ys;if(xs.length!==ys.length)return!1;for(var i=0;i<xs.length;++i)if(xs[i]!==ys[i])return!1;return!0},exports.unique=function(xs){if(null==xs)return xs;for(var out=[],_i=0,xs_1=xs;_i<xs_1.length;_i++){var x=xs_1[_i];-1===out.indexOf(x)&&out.push(x)}return out},exports.isObjectEmpty=function(obj){if(null==obj)throw new errors_1.ValueError("Invalid value in obj: "+JSON.stringify(obj));for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0},exports.checkStringTypeUnionValue=function(values,label,value){if(null!=value&&values.indexOf(value)<0)throw new errors_1.ValueError(value+" is not a valid "+label+".  Valid values are "+values+" or null/undefined.")},exports.checkArrayTypeAndLength=function(x,expectedType,minLength,maxLength){return void 0===minLength&&(minLength=0),void 0===maxLength&&(maxLength=1/0),assert(0<=minLength),assert(minLength<=maxLength),Array.isArray(x)&&x.length>=minLength&&x.length<=maxLength&&x.every(function(e){return typeof e===expectedType})},exports.assertPositiveInteger=function assertPositiveInteger(value,name){Array.isArray(value)?(tfjs_core_1.util.assert(0<value.length,function(){return name+" is unexpectedly an empty array."}),value.forEach(function(v,i){return assertPositiveInteger(v,"element "+(i+1)+" of "+name)})):tfjs_core_1.util.assert(Number.isInteger(value)&&0<value,function(){return"Expected "+name+" to be a positive integer, but got "+formatAsFriendlyString(value)+"."})},exports.formatAsFriendlyString=formatAsFriendlyString,exports.debounce=function(f,waitMs){var lastResult,lastTime=tfjs_core_1.util.now();return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var now=tfjs_core_1.util.now();return now-lastTime<waitMs?lastResult:(lastTime=now,lastResult=f.apply(void 0,args))}}},{"../errors":289,"@tensorflow/tfjs-core":148}],323:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var variable_utils_1=require("./variable_utils");function printRow(fields,positions,printFn){void 0===printFn&&(printFn=console.log);for(var line="",i=0;i<fields.length;++i)0<i&&(line=line.slice(0,line.length-1)+" "),line=(line+=fields[i]).slice(0,positions[i]),line+=" ".repeat(positions[i]-line.length);printFn(line)}function printLayerSummary(layer,positions,printFn){var outputShape;try{outputShape=JSON.stringify(layer.outputShape)}catch(err){outputShape="multiple"}printRow([layer.name+" ("+layer.getClassName()+")",outputShape,layer.countParams().toString()],positions,printFn)}function printLayerSummaryWithConnections(layer,positions,relevantNodes,printFn){var outputShape;try{outputShape=JSON.stringify(layer.outputShape)}catch(err){outputShape="multiple"}for(var connections=[],_i=0,_a=layer.inboundNodes;_i<_a.length;_i++){var node=_a[_i];if(!(null!=relevantNodes&&0<relevantNodes.length&&-1===relevantNodes.indexOf(node)))for(var i=0;i<node.inboundLayers.length;++i){var inboundLayer=node.inboundLayers[i].name,inboundLayerIndex=node.nodeIndices[i],inboundTensorIndex=node.tensorIndices[i];connections.push(inboundLayer+"["+inboundLayerIndex+"]["+inboundTensorIndex+"]")}}var name=layer.name,className=layer.getClassName(),firstConnection=0===connections.length?"":connections[0];printRow([name+" ("+className+")",outputShape,layer.countParams().toString(),firstConnection],positions,printFn);for(i=1;i<connections.length;++i)printRow(["","","",connections[i]],positions,printFn)}exports.printSummary=function(model,lineLength,positions,printFn){void 0===printFn&&(printFn=console.log);var relevantNodes,sequentialLike=function(model){var sequentialLike=!0,nodesByDepth=[],nodes=[];for(var depth in model.nodesByDepth)nodesByDepth.push(model.nodesByDepth[depth]);for(var _i=0,nodesByDepth_1=nodesByDepth;_i<nodesByDepth_1.length;_i++){var depthNodes=nodesByDepth_1[_i];if(1<depthNodes.length||1===depthNodes.length&&1<depthNodes[0].inboundLayers.length){sequentialLike=!1;break}nodes.push.apply(nodes,depthNodes)}if(sequentialLike)for(var _a=0,_b=model.layers;_a<_b.length;_a++){for(var layer=_b[_a],flag=!1,_c=0,_d=layer.inboundNodes;_c<_d.length;_c++){var node=_d[_c];if(-1!==nodes.indexOf(node)){if(flag){sequentialLike=!1;break}flag=!0}}if(!sequentialLike)break}return sequentialLike}(model),toDisplay=["Layer (type)","Output shape","Param #"];if((positions=sequentialLike?(lineLength=lineLength||65,positions||[.45,.85,1]):(lineLength=lineLength||98,positions||[.33,.55,.67,1]))[positions.length-1]<=1&&(positions=positions.map(function(p){return Math.floor(lineLength*p)})),!sequentialLike)for(var depth in toDisplay.push("Receives inputs"),relevantNodes=[],model.nodesByDepth)relevantNodes.push.apply(relevantNodes,model.nodesByDepth[depth]);printFn("_".repeat(lineLength)),printRow(toDisplay,positions,printFn),printFn("=".repeat(lineLength));for(var layers=model.layers,i=0;i<layers.length;++i)sequentialLike?printLayerSummary(layers[i],positions,printFn):printLayerSummaryWithConnections(layers[i],positions,relevantNodes,printFn),printFn((i===layers.length-1?"=":"_").repeat(lineLength));model.checkTrainableWeightsConsistency();var trainableCount=function(model){var trainableCount;trainableCount=null!=model.collectedTrainableWeights?variable_utils_1.countParamsInWeights(model.collectedTrainableWeights):variable_utils_1.countParamsInWeights(model.trainableWeights);return trainableCount}(model),nonTrainableCount=variable_utils_1.countParamsInWeights(model.nonTrainableWeights);printFn("Total params: "+(trainableCount+nonTrainableCount)),printFn("Trainable params: "+trainableCount),printFn("Non-trainable params: "+nonTrainableCount),printFn("_".repeat(lineLength))}},{"./variable_utils":327}],324:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),errors_1=require("../errors");function toArray1D(array){return array=Array.isArray(array)?new Float32Array(array):array,tfjs_core_1.tensor1d(array)}function sum(array){return tfc.sum(toArray1D(array)).dataSync()[0]}function mean(array){return sum(array)/array.length}exports.isInteger=function(x){return x===parseInt(x.toString(),10)},exports.arrayProd=function(array,begin,end){null==begin&&(begin=0),null==end&&(end=array.length);for(var prod=1,i=begin;i<end;++i)prod*=array[i];return prod},exports.min=function(array){return tfc.min(toArray1D(array)).dataSync()[0]},exports.max=function(array){return tfc.max(toArray1D(array)).dataSync()[0]},exports.sum=sum,exports.mean=mean,exports.variance=function(array){var demeaned=tfc.sub(toArray1D(array),tfjs_core_1.scalar(mean(array)));return tfc.sum(tfc.mulStrict(demeaned,demeaned)).dataSync()[0]/array.length},exports.median=function(array){var arraySorted=array.slice().sort(function(a,b){return a-b}),lowIdx=Math.floor((arraySorted.length-1)/2),highIdx=Math.ceil((arraySorted.length-1)/2);return lowIdx===highIdx?arraySorted[lowIdx]:(arraySorted[lowIdx]+arraySorted[highIdx])/2},exports.range=function(begin,end){if(end<begin)throw new errors_1.ValueError("end ("+end+") < begin ("+begin+") is forbidden.");for(var out=[],i=begin;i<end;++i)out.push(i);return out}},{"../errors":289,"@tensorflow/tfjs-core":148}],325:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var generic_utils=require("../utils/generic_utils");function isArrayItemInputOrOutputName(key,index,value){return("inboundNodes"===key||"outputLayers"===key||"inputLayers"===key)&&0===index&&"string"==typeof value}exports.convertPythonicToTs=function convertPythonicToTs(pythonicConfig,key){if(null===pythonicConfig)return null;if("string"==typeof pythonicConfig)return generic_utils.toCamelCase(pythonicConfig);if("number"==typeof pythonicConfig||"boolean"==typeof pythonicConfig)return pythonicConfig;if(pythonicConfig instanceof Array){for(var tsArray=[],arrayLength=pythonicConfig.length,i=0;i<arrayLength;++i){var item=pythonicConfig[i];isArrayItemInputOrOutputName(key,i,item)?tsArray.push(item):tsArray.push(convertPythonicToTs(item,key))}return tsArray}for(var tsDict={},_i=0,_a=Object.keys(pythonicConfig);_i<_a.length;_i++){var pythonicKey=_a[_i],pythonicValue=pythonicConfig[pythonicKey];if("name"===pythonicKey&&"string"==typeof pythonicValue)tsDict[pythonicKey]=pythonicValue;else{var tsKey=generic_utils.toCamelCase(pythonicKey);tsDict[tsKey]=convertPythonicToTs(pythonicValue,tsKey)}}return tsDict},exports.convertTsToPythonic=function convertTsToPythonic(tsConfig,key){if(null==tsConfig)return null;if("string"==typeof tsConfig)return generic_utils.toSnakeCase(tsConfig);if("number"==typeof tsConfig||"boolean"==typeof tsConfig)return tsConfig;if(tsConfig instanceof Array){for(var pyArray=[],arrayLength=tsConfig.length,i=0;i<arrayLength;++i){var item=tsConfig[i];isArrayItemInputOrOutputName(key,i,item)?pyArray.push(item):pyArray.push(convertTsToPythonic(item,key))}return pyArray}for(var pyDict={},_i=0,_a=Object.keys(tsConfig);_i<_a.length;_i++){var tsKey=_a[_i],tsValue=tsConfig[tsKey],pyKey=generic_utils.toSnakeCase(tsKey);pyDict[pyKey]="name"!==tsKey&&"className"!==tsKey||"string"!=typeof tsValue?convertTsToPythonic(tsValue,tsKey):tsValue}return pyDict}},{"../utils/generic_utils":322}],326:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var errors_1=require("../errors");exports.isArrayOfShapes=function(x){return Array.isArray(x)&&Array.isArray(x[0])},exports.normalizeShapeList=function(x){return 0===x.length?[]:Array.isArray(x[0])?x:[x]},exports.getExactlyOneTensor=function(xs){var x;if(Array.isArray(xs)){if(1!==xs.length)throw new errors_1.ValueError("Expected Tensor length to be 1; got "+xs.length);x=xs[0]}else x=xs;return x},exports.getExactlyOneShape=function(shapes){if(Array.isArray(shapes)&&Array.isArray(shapes[0])){if(1===shapes.length)return(shapes=shapes)[0];throw new errors_1.ValueError("Expected exactly 1 Shape; got "+shapes.length)}return shapes}},{"../errors":289}],327:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.countParamsInWeights=function(weights){for(var count=0,_i=0,weights_1=weights;_i<weights_1.length;_i++){var weight=weights_1[_i];0===weight.shape.length?count+=1:count+=weight.shape.reduce(function(a,b){return a*b})}return count}},{}],328:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tfc=require("@tensorflow/tfjs-core"),tfjs_core_1=require("@tensorflow/tfjs-core"),state_1=require("./backend/state"),common_1=require("./common"),errors_1=require("./errors"),LayerVariable=function(){function LayerVariable(val,dtype,name,trainable,constraint){void 0===dtype&&(dtype="float32"),void 0===name&&(name="Variable"),void 0===trainable&&(trainable=!0),void 0===constraint&&(constraint=null),this.dtype=null==dtype?"float32":dtype,this.shape=val.shape,this.id=state_1.getNextUniqueTensorId(),name=null==name?"Variable":name,this.originalName=common_1.getScopedTensorName(name),this.name=common_1.getUniqueTensorName(this.originalName),this.trainable_=trainable,this.constraint=constraint,this.val=tfc.variable(val,this.trainable_,this.name,this.dtype)}return LayerVariable.prototype.read=function(){return this.assertNotDisposed(),this.val},LayerVariable.prototype.write=function(newVal){return this.assertNotDisposed(),function(x,y){if(x.shape.toString()!==y.shape.toString())throw new Error("Shape mismatch: "+JSON.stringify(x.shape)+" vs. "+JSON.stringify(y.shape))}(this.val,newVal),this.val.id!==newVal.id&&(this.val.assign(newVal),null!=this.constraint&&this.val.assign(this.constraint.apply(this.val))),this},LayerVariable.prototype.dispose=function(){this.assertNotDisposed(),this.val.dispose()},LayerVariable.prototype.assertNotDisposed=function(){if(this.val.isDisposed)throw new Error("LayersVariable "+this.name+" is already disposed.")},Object.defineProperty(LayerVariable.prototype,"trainable",{get:function(){return this.trainable_},set:function(trainable){this.trainable_=trainable,this.val.trainable=trainable},enumerable:!0,configurable:!0}),LayerVariable}();exports.LayerVariable=LayerVariable,exports.variable=function(x,dtype,name,constraint){return new LayerVariable(x,dtype,name,!0,constraint)},exports.zerosVariable=function(shape,dtype,name){return new LayerVariable(tfc.zeros(shape),dtype,name)},exports.zerosLike=function(x,dtype,name){return new LayerVariable(tfc.zerosLike(x),dtype,name)},exports.onesVariable=function(shape,dtype,name){var allocated=tfc.ones(shape);return new LayerVariable(allocated,dtype,name)},exports.onesLike=function(x,dtype,name){var allocated=tfc.onesLike(x);return new LayerVariable(allocated,dtype,name)},exports.eyeVariable=function(size,dtype,name){return new LayerVariable(tfc.eye(size),dtype,name)},exports.randomUniformVariable=function(shape,minval,maxval,dtype,seed,name){return void 0===name&&(name="randomUniform"),new LayerVariable(tfc.randomUniform(shape,minval,maxval,dtype),dtype,name)},exports.truncatedNormalVariable=function(shape,mean,stddev,dtype,seed,name){if(void 0===mean&&(mean=0),void 0===stddev&&(stddev=1),void 0===name&&(name="truncatedNormal"),"float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("randomNormal does not support dType "+dtype+".");return new LayerVariable(tfc.truncatedNormal(shape,mean,stddev,dtype,seed),dtype,name)},exports.randomNormalVariable=function(shape,mean,stddev,dtype,seed,name){if(void 0===mean&&(mean=0),void 0===stddev&&(stddev=1),void 0===name&&(name="randomNormal"),"float32"!==(dtype=dtype||"float32")&&"int32"!==dtype)throw new errors_1.NotImplementedError("randomNormalVariable does not support dType "+dtype+".");return new LayerVariable(tfc.randomNormal(shape,mean,stddev,dtype,seed),dtype,name)},exports.update=function(x,xNew){return x.write(xNew)},exports.updateAdd=function(x,increment){return x.write(tfc.add(x.read(),increment))},exports.updateSub=function(x,decrement){return x.write(tfc.sub(x.read(),decrement))},exports.batchGetValue=function(xs){return xs.map(function(x){return x.read()})},exports.batchSetValue=function(variablesAndValues){variablesAndValues.forEach(function(variableAndValue){variableAndValue[0].write(variableAndValue[1])})},exports.gradients=function(lossFn,variables){var variableList=variables.map(function(variable){return variable.read()}),valudAndGrads=tfjs_core_1.variableGrads(lossFn,variableList);return variables.map(function(variable){return valudAndGrads.grads[variable.name]})}},{"./backend/state":275,"./common":279,"./errors":289,"@tensorflow/tfjs-core":148}],329:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],330:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("@tensorflow/tfjs-core")),__export(require("@tensorflow/tfjs-layers")),__export(require("@tensorflow/tfjs-converter"));var data=require("@tensorflow/tfjs-data");exports.data=data;var tfjs_core_1=require("@tensorflow/tfjs-core"),tfjs_data_1=require("@tensorflow/tfjs-data"),tfjs_layers_1=require("@tensorflow/tfjs-layers"),tfjs_converter_1=require("@tensorflow/tfjs-converter"),version_1=require("./version");exports.version={"tfjs-core":tfjs_core_1.version_core,"tfjs-data":tfjs_data_1.version_data,"tfjs-layers":tfjs_layers_1.version_layers,"tfjs-converter":tfjs_converter_1.version_converter,tfjs:version_1.version}},{"./version":331,"@tensorflow/tfjs-converter":11,"@tensorflow/tfjs-core":148,"@tensorflow/tfjs-data":256,"@tensorflow/tfjs-layers":297}],331:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{dup:49}],332:[function(require,module,exports){"use strict";exports.byteLength=function(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen},exports.toByteArray=function(b64){for(var tmp,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(function(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}(0,validLen,placeHoldersLen)),curByte=0,len=0<placeHoldersLen?validLen-4:validLen,i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp);1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp);return arr},exports.fromByteArray=function(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],i=0,len2=len-extraBytes;i<len2;i+=16383)parts.push(encodeChunk(uint8,i,len2<i+16383?len2:i+16383));1==extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2==extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"="));return parts.join("")};for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(b64){var len=b64.length;if(0<len%4)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");return-1===validLen&&(validLen=len),[validLen,validLen===len?0:4-validLen%4]}function encodeChunk(uint8,start,end){for(var tmp,num,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(lookup[(num=tmp)>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]);return output.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},{}],333:[function(require,module,exports){},{}],334:[function(require,module,exports){(function(Buffer){"use strict";var base64=require("base64-js"),ieee754=require("ieee754");exports.Buffer=Buffer,exports.SlowBuffer=function(length){+length!=length&&(length=0);return Buffer.alloc(+length)},exports.INSPECT_MAX_BYTES=50;var K_MAX_LENGTH=2147483647;function createBuffer(length){if(K_MAX_LENGTH<length)throw new RangeError('The value "'+length+'" is invalid for option "size"');var buf=new Uint8Array(length);return buf.__proto__=Buffer.prototype,buf}function Buffer(arg,encodingOrOffset,length){if("number"!=typeof arg)return from(arg,encodingOrOffset,length);if("string"==typeof encodingOrOffset)throw new TypeError('The "string" argument must be of type string. Received type number');return allocUnsafe(arg)}function from(value,encodingOrOffset,length){if("string"==typeof value)return function(string,encoding){"string"==typeof encoding&&""!==encoding||(encoding="utf8");if(!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);var length=0|byteLength(string,encoding),buf=createBuffer(length),actual=buf.write(string,encoding);actual!==length&&(buf=buf.slice(0,actual));return buf}(value,encodingOrOffset);if(ArrayBuffer.isView(value))return fromArrayLike(value);if(null==value)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof value);if(isInstance(value,ArrayBuffer)||value&&isInstance(value.buffer,ArrayBuffer))return function(array,byteOffset,length){if(byteOffset<0||array.byteLength<byteOffset)throw new RangeError('"offset" is outside of buffer bounds');if(array.byteLength<byteOffset+(length||0))throw new RangeError('"length" is outside of buffer bounds');var buf;buf=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length);return buf.__proto__=Buffer.prototype,buf}(value,encodingOrOffset,length);if("number"==typeof value)throw new TypeError('The "value" argument must not be of type number. Received type number');var valueOf=value.valueOf&&value.valueOf();if(null!=valueOf&&valueOf!==value)return Buffer.from(valueOf,encodingOrOffset,length);var b=function(obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length),buf=createBuffer(len);return 0===buf.length||obj.copy(buf,0,0,len),buf}if(void 0!==obj.length)return"number"!=typeof obj.length||numberIsNaN(obj.length)?createBuffer(0):fromArrayLike(obj);if("Buffer"===obj.type&&Array.isArray(obj.data))return fromArrayLike(obj.data)}(value);if(b)return b;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof value[Symbol.toPrimitive])return Buffer.from(value[Symbol.toPrimitive]("string"),encodingOrOffset,length);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be of type number');if(size<0)throw new RangeError('The value "'+size+'" is invalid for option "size"')}function allocUnsafe(size){return assertSize(size),createBuffer(size<0?0:0|checked(size))}function fromArrayLike(array){for(var length=array.length<0?0:0|checked(array.length),buf=createBuffer(length),i=0;i<length;i+=1)buf[i]=255&array[i];return buf}function checked(length){if(K_MAX_LENGTH<=length)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+K_MAX_LENGTH.toString(16)+" bytes");return 0|length}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if(ArrayBuffer.isView(string)||isInstance(string,ArrayBuffer))return string.byteLength;if("string"!=typeof string)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof string);var len=string.length,mustMatch=2<arguments.length&&!0===arguments[2];if(!mustMatch&&0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return mustMatch?-1:utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):2147483647<byteOffset?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),numberIsNaN(byteOffset=+byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val&=255,"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var i,indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&("ucs2"===(encoding=String(encoding).toLowerCase())||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;arrLength/=indexSize=2,valLength/=2,byteOffset/=2}function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1}else for(arrLength<byteOffset+valLength&&(byteOffset=arrLength-valLength),i=byteOffset;0<=i;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?remaining<(length=Number(length))&&(length=remaining):length=remaining;var strLen=string.length;strLen/2<length&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(numberIsNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(function(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(function(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=239<firstByte?4:223<firstByte?3:191<firstByte?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&127<(tempCodePoint=(31&firstByte)<<6|63&secondByte)&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&2047<(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)&&(tempCodePoint<55296||57343<tempCodePoint)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&65535<(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):65535<codePoint&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return function(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);var res="",i=0;for(;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}(res)}exports.kMaxLength=K_MAX_LENGTH,(Buffer.TYPED_ARRAY_SUPPORT=function(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()}catch(e){return!1}}())||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(Buffer.prototype,"parent",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.buffer}}),Object.defineProperty(Buffer.prototype,"offset",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),Buffer.poolSize=8192,Buffer.from=function(value,encodingOrOffset,length){return from(value,encodingOrOffset,length)},Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,Buffer.alloc=function(size,fill,encoding){return function(size,fill,encoding){return assertSize(size),size<=0?createBuffer(size):void 0!==fill?"string"==typeof encoding?createBuffer(size).fill(fill,encoding):createBuffer(size).fill(fill):createBuffer(size)}(size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(size)},Buffer.isBuffer=function(b){return null!=b&&!0===b._isBuffer&&b!==Buffer.prototype},Buffer.compare=function(a,b){if(isInstance(a,Uint8Array)&&(a=Buffer.from(a,a.offset,a.byteLength)),isInstance(b,Uint8Array)&&(b=Buffer.from(b,b.offset,b.byteLength)),!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!Array.isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(i=length=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(isInstance(buf,Uint8Array)&&(buf=Buffer.from(buf)),!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toLocaleString=Buffer.prototype.toString=function(){var length=this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):function(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if((end>>>=0)<=(start>>>=0))return"";for(encoding=encoding||"utf8";;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return str=this.toString("hex",0,max).replace(/(.{2})/g,"$1 ").trim(),this.length>max&&(str+=" ... "),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(isInstance(target,Uint8Array)&&(target=Buffer.from(target,target.offset,target.byteLength)),!Buffer.isBuffer(target))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof target);if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisEnd<=thisStart&&end<=start)return 0;if(thisEnd<=thisStart)return-1;if(end<=start)return 1;if(this===target)return 0;for(var x=(thisEnd>>>=0)-(thisStart>>>=0),y=(end>>>=0)-(start>>>=0),len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset>>>=0,isFinite(length)?(length>>>=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||remaining<length)&&(length=remaining),0<string.length&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding=encoding||"utf8";for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||len<end)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(length<offset+ext)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(max<value||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function checkIEEE754(buf,value,offset,ext){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,0,offset,4),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return value=+value,offset>>>=0,noAssert||checkIEEE754(buf,0,offset,8),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var len=this.length;(start=~~start)<0?(start+=len)<0&&(start=0):len<start&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):len<end&&(end=len),end<start&&(end=start);var newBuf=this.subarray(start,end);return newBuf.__proto__=Buffer.prototype,newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;0<byteLength&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return(mul*=128)<=val&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset>>>=0,byteLength>>>=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];0<i&&(mul*=256);)val+=this[offset+--i]*mul;return(mul*=128)<=val&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){offset>>>=0,noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return offset>>>=0,noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,byteLength>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){value=+value,offset>>>=0,byteLength>>>=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;0<=--i&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value,offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset>>>=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;0<=--i&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=255&value,this[offset+1]=value>>>8,offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),this[offset]=value>>>8,this[offset+1]=255&value,offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24,offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value,offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(!Buffer.isBuffer(target))throw new TypeError("argument should be a Buffer");if(start=start||0,end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart=targetStart||0,0<end&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("Index out of range");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var len=end-start;if(this===target&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(targetStart,start,end);else if(this===target&&start<targetStart&&targetStart<end)for(var i=len-1;0<=i;--i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,end),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding);if(1===val.length){var code=val.charCodeAt(0);("utf8"===encoding&&code<128||"latin1"===encoding)&&(val=code)}}else"number"==typeof val&&(val&=255);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;var i;if(start>>>=0,end=void 0===end?this.length:end>>>0,"number"==typeof(val=val||0))for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:Buffer.from(val,encoding),len=bytes.length;if(0===len)throw new TypeError('The value "'+val+'" is invalid for argument "value"');for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+/0-9A-Za-z-_]/g;function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if(55295<(codePoint=string.charCodeAt(i))&&codePoint<57344){if(!leadSurrogate){if(56319<codePoint){-1<(units-=3)&&bytes.push(239,191,189);continue}if(i+1===length){-1<(units-=3)&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){-1<(units-=3)&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&-1<(units-=3)&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function base64ToBytes(str){return base64.toByteArray(function(str){if((str=(str=str.split("=")[0]).trim().replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}function isInstance(obj,type){return obj instanceof type||null!=obj&&null!=obj.constructor&&null!=obj.constructor.name&&obj.constructor.name===type.name}function numberIsNaN(obj){return obj!=obj}}).call(this,require("buffer").Buffer)},{"base64-js":332,buffer:334,ieee754:335}],335:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;0<nBits;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;0<nBits;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),2<=(value+=1<=e+eBias?rt/c:rt*Math.pow(2,1-eBias))*c&&(e++,c/=2),eMax<=e+eBias?(m=0,e=eMax):1<=e+eBias?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));8<=mLen;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;0<eLen;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],336:[function(require,module,exports){var root,factory;root=this,factory=function(){function bitsToNum(ba){return ba.reduce(function(s,n){return 2*s+n},0)}function byteToBitArr(bite){for(var a=[],i=7;0<=i;i--)a.push(!!(bite&1<<i));return a}function Stream(data){this.data=data,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return data instanceof Uint8Array?data[this.pos++]:255&data.charCodeAt(this.pos++)},this.readBytes=function(n){for(var bytes=[],i=0;i<n;i++)bytes.push(this.readByte());return bytes},this.read=function(n){for(var s="",i=0;i<n;i++)s+=String.fromCharCode(this.readByte());return s},this.readUnsigned=function(){var a=this.readBytes(2);return(a[1]<<8)+a[0]}}function parseGIF(st,handler){function parseCT(entries){for(var ct=[],i=0;i<entries;i++)ct.push(st.readBytes(3));return ct}function readSubBlocks(){var size,data;for(data="";size=st.readByte(),data+=st.read(size),0!==size;);return data}function parseImg(img){img.leftPos=st.readUnsigned(),img.topPos=st.readUnsigned(),img.width=st.readUnsigned(),img.height=st.readUnsigned();var bits=byteToBitArr(st.readByte());img.lctFlag=bits.shift(),img.interlaced=bits.shift(),img.sorted=bits.shift(),img.reserved=bits.splice(0,2),img.lctSize=bitsToNum(bits.splice(0,3)),img.lctFlag&&(img.lct=parseCT(1<<img.lctSize+1)),img.lzwMinCodeSize=st.readByte();var lzwData=readSubBlocks();img.pixels=function(minCodeSize,data){function readCode(size){for(var code=0,i=0;i<size;i++)data.charCodeAt(pos>>3)&1<<(7&pos)&&(code|=1<<i),pos++;return code}function clear(){dict=[],codeSize=minCodeSize+1;for(var i=0;i<clearCode;i++)dict[i]=[i];dict[clearCode]=[],dict[eoiCode]=null}for(var code,last,pos=0,output=[],clearCode=1<<minCodeSize,eoiCode=1+clearCode,codeSize=minCodeSize+1,dict=[];;)if(last=code,(code=readCode(codeSize))!==clearCode){if(code===eoiCode)break;if(code<dict.length)last!==clearCode&&dict.push(dict[last].concat(dict[code][0]));else{if(code!==dict.length)throw new Error("Invalid LZW code.");dict.push(dict[last].concat(dict[last][0]))}output.push.apply(output,dict[code]),dict.length===1<<codeSize&&codeSize<12&&codeSize++}else clear();return output}(img.lzwMinCodeSize,lzwData),img.interlaced&&(img.pixels=function(pixels,width){function cpRow(toRow,fromRow){var fromPixels=pixels.slice(fromRow*width,(fromRow+1)*width);newPixels.splice.apply(newPixels,[toRow*width,width].concat(fromPixels))}for(var newPixels=new Array(pixels.length),rows=pixels.length/width,offsets=[0,4,2,1],steps=[8,8,4,2],fromRow=0,pass=0;pass<4;pass++)for(var toRow=offsets[pass];toRow<rows;toRow+=steps[pass])cpRow(toRow,fromRow),fromRow++;return newPixels}(img.pixels,img.width)),handler.img&&handler.img(img)}handler=handler||{};var parseBlock=function(){var block={};switch(block.sentinel=st.readByte(),String.fromCharCode(block.sentinel)){case"!":block.type="ext",function(block){switch(block.label=st.readByte(),block.label){case 249:block.extType="gce",function(block){st.readByte();var bits=byteToBitArr(st.readByte());block.reserved=bits.splice(0,3),block.disposalMethod=bitsToNum(bits.splice(0,3)),block.userInput=bits.shift(),block.transparencyGiven=bits.shift(),block.delayTime=st.readUnsigned(),block.transparencyIndex=st.readByte(),block.terminator=st.readByte(),handler.gce&&handler.gce(block)}(block);break;case 254:block.extType="com",function(block){block.comment=readSubBlocks(),handler.com&&handler.com(block)}(block);break;case 1:block.extType="pte",function(block){st.readByte();block.ptHeader=st.readBytes(12),block.ptData=readSubBlocks(),handler.pte&&handler.pte(block)}(block);break;case 255:block.extType="app",function(block){st.readByte();switch(block.identifier=st.read(8),block.authCode=st.read(3),block.identifier){case"NETSCAPE":!function(block){st.readByte();block.unknown=st.readByte(),block.iterations=st.readUnsigned(),block.terminator=st.readByte(),handler.app&&handler.app.NETSCAPE&&handler.app.NETSCAPE(block)}(block);break;default:!function(block){block.appData=readSubBlocks(),handler.app&&handler.app[block.identifier]&&handler.app[block.identifier](block)}(block)}}(block);break;default:block.extType="unknown",function(block){block.data=readSubBlocks(),handler.unknown&&handler.unknown(block)}(block)}}(block);break;case",":block.type="img",parseImg(block);break;case";":block.type="eof",handler.eof&&handler.eof(block);break;default:throw new Error("Unknown block: 0x"+block.sentinel.toString(16))}"eof"!==block.type&&setTimeout(parseBlock,0)};!function(){var hdr={};if(hdr.sig=st.read(3),hdr.ver=st.read(3),"GIF"!==hdr.sig)throw new Error("Not a GIF file.");hdr.width=st.readUnsigned(),hdr.height=st.readUnsigned();var bits=byteToBitArr(st.readByte());hdr.gctFlag=bits.shift(),hdr.colorRes=bitsToNum(bits.splice(0,3)),hdr.sorted=bits.shift(),hdr.gctSize=bitsToNum(bits.splice(0,3)),hdr.bgColor=st.readByte(),hdr.pixelAspectRatio=st.readByte(),hdr.gctFlag&&(hdr.gct=parseCT(1<<hdr.gctSize+1)),handler.hdr&&handler.hdr(hdr)}(),setTimeout(parseBlock,0)}return function(opts){var stream,hdr,options={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var i in opts)options[i]=opts[i];options.vp_w&&options.vp_h&&(options.is_vp=!0);var loadError=null,loading=!1,transparency=null,delay=null,disposalMethod=null,disposalRestoreFromIdx=null,lastDisposalMethod=null,frame=null,lastImg=null,playing=!0,ctx_scaled=!1,frames=[],frameOffsets=[],gif=options.gif;void 0===options.auto_play&&(options.auto_play=!gif.getAttribute("rel:auto_play")||"1"==gif.getAttribute("rel:auto_play"));function clear(){lastDisposalMethod=disposalMethod,frame=disposalMethod=delay=transparency=null}function doParse(){try{parseGIF(stream,handler)}catch(err){doLoadError("parse")}}function setSizes(w,h){canvas.width=w*get_canvas_scale(),canvas.height=h*get_canvas_scale(),toolbar.style.minWidth=w*get_canvas_scale()+"px",tmpCanvas.width=w,tmpCanvas.height=h,tmpCanvas.style.width=w+"px",tmpCanvas.style.height=h+"px",tmpCanvas.getContext("2d").setTransform(1,0,0,1,0,0)}function doShowProgress(pos,length,draw){if(draw&&showProgressBar){var mid,top,width,height=progressBarHeight;if(options.is_vp)width=ctx_scaled?(top=(options.vp_t+options.vp_h-height)/get_canvas_scale(),height/=get_canvas_scale(),mid=options.vp_l/get_canvas_scale()+pos/length*(options.vp_w/get_canvas_scale()),canvas.width/get_canvas_scale()):(top=options.vp_t+options.vp_h-height,height=height,mid=options.vp_l+pos/length*options.vp_w,canvas.width);else top=(canvas.height-height)/(ctx_scaled?get_canvas_scale():1),mid=pos/length*canvas.width/(ctx_scaled?get_canvas_scale():1),width=canvas.width/(ctx_scaled?get_canvas_scale():1),height/=ctx_scaled?get_canvas_scale():1;ctx.fillStyle=progressBarBackgroundColor,ctx.fillRect(mid,top,width-mid,height),ctx.fillStyle=progressBarForegroundColor,ctx.fillRect(0,top,mid,height)}}function doDecodeProgress(draw){doShowProgress(stream.pos,stream.data.length,draw)}function doNothing(){}function withProgress(fn,draw){return function(block){fn(block),doDecodeProgress(draw)}}function init(){var parent=gif.parentNode,div=document.createElement("div");canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),toolbar=document.createElement("div"),tmpCanvas=document.createElement("canvas"),div.width=canvas.width=gif.width,div.height=canvas.height=gif.height,toolbar.style.minWidth=gif.width+"px",div.className="jsgif",toolbar.className="jsgif_toolbar",div.appendChild(canvas),div.appendChild(toolbar),parent.insertBefore(div,gif),parent.removeChild(gif),options.c_w&&options.c_h&&setSizes(options.c_w,options.c_h),initialized=!0}function load_setup(callback){return!loading&&(load_callback=callback||!1,loading=!0,frames=[],clear(),!(lastImg=frame=lastDisposalMethod=disposalRestoreFromIdx=null))}var canvas,ctx,toolbar,tmpCanvas,onEndListener=options.hasOwnProperty("on_end")?options.on_end:null,loopDelay=options.hasOwnProperty("loop_delay")?options.loop_delay:0,overrideLoopMode=options.hasOwnProperty("loop_mode")?options.loop_mode:"auto",drawWhileLoading=!options.hasOwnProperty("draw_while_loading")||options.draw_while_loading,showProgressBar=!!drawWhileLoading&&(!options.hasOwnProperty("show_progress_bar")||options.show_progress_bar),progressBarHeight=options.hasOwnProperty("progressbar_height")?options.progressbar_height:25,progressBarBackgroundColor=options.hasOwnProperty("progressbar_background_color")?options.progressbar_background_color:"rgba(255,255,255,0.4)",progressBarForegroundColor=options.hasOwnProperty("progressbar_foreground_color")?options.progressbar_foreground_color:"rgba(255,0,22,.8)",doLoadError=function(originOfError){loadError=originOfError,hdr={width:gif.width,height:gif.height},frames=[],ctx.fillStyle="black",ctx.fillRect(0,0,options.c_w?options.c_w:hdr.width,options.c_h?options.c_h:hdr.height),ctx.strokeStyle="red",ctx.lineWidth=3,ctx.moveTo(0,0),ctx.lineTo(options.c_w?options.c_w:hdr.width,options.c_h?options.c_h:hdr.height),ctx.moveTo(0,options.c_h?options.c_h:hdr.height),ctx.lineTo(options.c_w?options.c_w:hdr.width,0),ctx.stroke()},pushFrame=function(){frame&&(frames.push({data:frame.getImageData(0,0,hdr.width,hdr.height),delay:delay}),frameOffsets.push({x:0,y:0}))},player=function(){function stepFrame(amount){i+=amount,putFrame()}var stepping,doStep,i=-1,iterationCount=0,step=(stepping=!1,doStep=function(){if(stepping=playing){stepFrame(1);var delay=10*frames[i].delay;delay=delay||100,0==(i+1+frames.length)%frames.length?(delay+=loopDelay,setTimeout(completeLoop,delay)):setTimeout(doStep,delay)}},function(){stepping||setTimeout(doStep,0)});function completeLoop(){null!==onEndListener&&onEndListener(gif),iterationCount++,!1!==overrideLoopMode||iterationCount<0?doStep():playing=stepping=!1}var putFrame=function(){var offset;(i=parseInt(i,10))>frames.length-1&&(i=0),i<0&&(i=0),offset=frameOffsets[i],tmpCanvas.getContext("2d").putImageData(frames[i].data,offset.x,offset.y),ctx.globalCompositeOperation="copy",ctx.drawImage(tmpCanvas,0,0)};return{init:function(){loadError||(options.c_w&&options.c_h||ctx.scale(get_canvas_scale(),get_canvas_scale()),options.auto_play?step():(i=0,putFrame()))},step:step,play:function(){playing=!0,step()},pause:function(){playing=!1},playing:playing,move_relative:stepFrame,current_frame:function(){return i},length:function(){return frames.length},move_to:function(frame_idx){i=frame_idx,putFrame()}}}(),handler={hdr:withProgress(function(_hdr){setSizes((hdr=_hdr).width,hdr.height)}),gce:withProgress(function(gce){pushFrame(),clear(),transparency=gce.transparencyGiven?gce.transparencyIndex:null,delay=gce.delayTime,disposalMethod=gce.disposalMethod}),com:withProgress(doNothing),app:{NETSCAPE:withProgress(doNothing)},img:withProgress(function(img){frame=frame||tmpCanvas.getContext("2d");var currIdx=frames.length,ct=img.lctFlag?img.lct:hdr.gct;0<currIdx&&(3===lastDisposalMethod?null!==disposalRestoreFromIdx?frame.putImageData(frames[disposalRestoreFromIdx].data,0,0):frame.clearRect(lastImg.leftPos,lastImg.topPos,lastImg.width,lastImg.height):disposalRestoreFromIdx=currIdx-1,2===lastDisposalMethod&&frame.clearRect(lastImg.leftPos,lastImg.topPos,lastImg.width,lastImg.height));var imgData=frame.getImageData(img.leftPos,img.topPos,img.width,img.height);img.pixels.forEach(function(pixel,i){pixel!==transparency&&(imgData.data[4*i+0]=ct[pixel][0],imgData.data[4*i+1]=ct[pixel][1],imgData.data[4*i+2]=ct[pixel][2],imgData.data[4*i+3]=255)}),frame.putImageData(imgData,img.leftPos,img.topPos),ctx_scaled||(ctx.scale(get_canvas_scale(),get_canvas_scale()),ctx_scaled=!0),drawWhileLoading&&(ctx.drawImage(tmpCanvas,0,0),drawWhileLoading=options.auto_play),lastImg=img},!0),eof:function(block){pushFrame(),doDecodeProgress(!1),options.c_w&&options.c_h||(canvas.width=hdr.width*get_canvas_scale(),canvas.height=hdr.height*get_canvas_scale()),player.init(),loading=!1,load_callback&&load_callback(gif)}},get_canvas_scale=function(){return options.max_width&&hdr&&hdr.width>options.max_width?options.max_width/hdr.width:1},initialized=!1,load_callback=!1;return{play:player.play,pause:player.pause,move_relative:player.move_relative,move_to:player.move_to,get_playing:function(){return playing},get_canvas:function(){return canvas},get_canvas_scale:function(){return get_canvas_scale()},get_loading:function(){return loading},get_auto_play:function(){return options.auto_play},get_length:function(){return player.length()},get_current_frame:function(){return player.current_frame()},load_url:function(src,callback){if(load_setup(callback)){var h=new XMLHttpRequest;h.open("GET",src,!0),"overrideMimeType"in h?h.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in h?h.responseType="arraybuffer":h.setRequestHeader("Accept-Charset","x-user-defined"),h.onloadstart=function(){initialized||init()},h.onload=function(e){200!=this.status&&doLoadError("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var data=this.response;0<data.toString().indexOf("ArrayBuffer")&&(data=new Uint8Array(data)),stream=new Stream(data),setTimeout(doParse,0)},h.onprogress=function(e){e.lengthComputable&&doShowProgress(e.loaded,e.total,!0)},h.onerror=function(){doLoadError("xhr")},h.send()}},load:function(callback){this.load_url(gif.getAttribute("rel:animated_src")||gif.src,callback)},load_raw:function(arr,callback){load_setup(callback)&&(initialized||init(),stream=new Stream(arr),setTimeout(doParse,0))},set_frame_offset:function(frame,offset){frameOffsets[frame]?(void 0!==offset.x&&(frameOffsets[frame].x=offset.x),void 0!==offset.y&&(frameOffsets[frame].y=offset.y)):frameOffsets[frame]=offset}}}},"object"==typeof exports?module.exports=factory():root.SuperGif=factory()},{}],337:[function(require,module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(1<arguments.length)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],338:[function(require,module,exports){arguments[4][244][0].apply(exports,arguments)},{"./lib/alea":339,"./lib/tychei":340,"./lib/xor128":341,"./lib/xor4096":342,"./lib/xorshift7":343,"./lib/xorwow":344,"./seedrandom":345,dup:244}],339:[function(require,module,exports){!function(global,module,define){function Alea(seed){var me=this,mash=function(){var n=4022871197;return function(data){data=String(data);for(var i=0;i<data.length;i++){var h=.02519603282416938*(n+=data.charCodeAt(i));h-=n=h>>>0,n=(h*=n)>>>0,n+=4294967296*(h-=n)}return 2.3283064365386963e-10*(n>>>0)}}();me.next=function(){var t=2091639*me.s0+2.3283064365386963e-10*me.c;return me.s0=me.s1,me.s1=me.s2,me.s2=t-(me.c=0|t)},me.c=1,me.s0=mash(" "),me.s1=mash(" "),me.s2=mash(" "),me.s0-=mash(seed),me.s0<0&&(me.s0+=1),me.s1-=mash(seed),me.s1<0&&(me.s1+=1),me.s2-=mash(seed),me.s2<0&&(me.s2+=1),mash=null}function copy(f,t){return t.c=f.c,t.s0=f.s0,t.s1=f.s1,t.s2=f.s2,t}function impl(seed,opts){var xg=new Alea(seed),state=opts&&opts.state,prng=xg.next;return prng.int32=function(){return 4294967296*xg.next()|0},prng.double=function(){return prng()+11102230246251565e-32*(2097152*prng()|0)},prng.quick=prng,state&&("object"==typeof state&&copy(state,xg),prng.state=function(){return copy(xg,{})}),prng}module&&module.exports?module.exports=impl:define&&define.amd?define(function(){return impl}):this.alea=impl}(0,"object"==typeof module&&module,!1)},{}],340:[function(require,module,exports){arguments[4][246][0].apply(exports,arguments)},{dup:246}],341:[function(require,module,exports){arguments[4][247][0].apply(exports,arguments)},{dup:247}],342:[function(require,module,exports){arguments[4][248][0].apply(exports,arguments)},{dup:248}],343:[function(require,module,exports){arguments[4][249][0].apply(exports,arguments)},{dup:249}],344:[function(require,module,exports){arguments[4][250][0].apply(exports,arguments)},{dup:250}],345:[function(require,module,exports){!function(pool,math){var nodecrypto,global=eval("this"),width=256,startdenom=math.pow(width,6),significance=math.pow(2,52),overflow=2*significance,mask=width-1;function seedrandom(seed,options,callback){function prng(){for(var n=arc4.g(6),d=startdenom,x=0;n<significance;)n=(n+x)*width,d*=width,x=arc4.g(1);for(;overflow<=n;)n/=2,d/=2,x>>>=1;return(n+x)/d}var key=[],shortseed=mixkey(function flatten(obj,depth){var prop,result=[],typ=typeof obj;if(depth&&"object"==typ)for(prop in obj)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:"string"==typ?obj:obj+"\0"}((options=1==options?{entropy:!0}:options||{}).entropy?[seed,tostring(pool)]:null==seed?function(){try{var out;return nodecrypto&&(out=nodecrypto.randomBytes)?out=out(width):(out=new Uint8Array(width),(global.crypto||global.msCrypto).getRandomValues(out)),tostring(out)}catch(e){var browser=global.navigator,plugins=browser&&browser.plugins;return[+new Date,global,plugins,global.screen,tostring(pool)]}}():seed,3),key),arc4=new ARC4(key);return prng.int32=function(){return 0|arc4.g(4)},prng.quick=function(){return arc4.g(4)/4294967296},prng.double=prng,mixkey(tostring(arc4.S),pool),(options.pass||callback||function(prng,seed,is_math_call,state){return state&&(state.S&&copy(state,arc4),prng.state=function(){return copy(arc4,{})}),is_math_call?(math.random=prng,seed):prng})(prng,shortseed,"global"in options?options.global:this==math,options.state)}function ARC4(key){var t,keylen=key.length,me=this,i=0,j=me.i=me.j=0,s=me.S=[];for(keylen||(key=[keylen++]);i<width;)s[i]=i++;for(i=0;i<width;i++)s[i]=s[j=mask&j+key[i%keylen]+(t=s[i])],s[j]=t;(me.g=function(count){for(var t,r=0,i=me.i,j=me.j,s=me.S;count--;)t=s[i=mask&i+1],r=r*width+s[mask&(s[i]=s[j=mask&j+t])+(s[j]=t)];return me.i=i,me.j=j,r})(width)}function copy(f,t){return t.i=f.i,t.j=f.j,t.S=f.S.slice(),t}function mixkey(seed,key){for(var smear,stringseed=seed+"",j=0;j<stringseed.length;)key[mask&j]=mask&(smear^=19*key[mask&j])+stringseed.charCodeAt(j++);return tostring(key)}function tostring(a){return String.fromCharCode.apply(0,a)}if(mixkey(math.random(),pool),"object"==typeof module&&module.exports){module.exports=seedrandom;try{nodecrypto=require("crypto")}catch(ex){}}else math.seedrandom=seedrandom}([],Math)},{crypto:333}],346:[function(require,module,exports){(function(setImmediate,clearImmediate){var nextTick=require("process/browser.js").nextTick,apply=Function.prototype.apply,slice=Array.prototype.slice,immediateIds={},nextImmediateId=0;function Timeout(id,clearFn){this._id=id,this._clearFn=clearFn}exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,window,arguments),clearTimeout)},exports.setInterval=function(){return new Timeout(apply.call(setInterval,window,arguments),clearInterval)},exports.clearTimeout=exports.clearInterval=function(timeout){timeout.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(window,this._id)},exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId),item._idleTimeout=msecs},exports.unenroll=function(item){clearTimeout(item._idleTimeoutId),item._idleTimeout=-1},exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;0<=msecs&&(item._idleTimeoutId=setTimeout(function(){item._onTimeout&&item._onTimeout()},msecs))},exports.setImmediate="function"==typeof setImmediate?setImmediate:function(fn){var id=nextImmediateId++,args=!(arguments.length<2)&&slice.call(arguments,1);return immediateIds[id]=!0,nextTick(function(){immediateIds[id]&&(args?fn.apply(null,args):fn.call(null),exports.clearImmediate(id))}),id},exports.clearImmediate="function"==typeof clearImmediate?clearImmediate:function(id){delete immediateIds[id]}}).call(this,require("timers").setImmediate,require("timers").clearImmediate)},{"process/browser.js":337,timers:346}]},{},[3])(3)});